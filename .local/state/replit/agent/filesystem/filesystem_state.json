{"file_contents":{"src/components/EmailVerification.js":{"content":"\"use client\";\n\nimport { useState, useEffect } from 'react';\nimport { useAuth } from '../hooks/useAuth';\n\nexport default function EmailVerification() {\n  const { user, sendVerificationEmail, checkEmailVerification, logout } = useAuth();\n  const [isResending, setIsResending] = useState(false);\n  const [message, setMessage] = useState('');\n\n  // Auto-check email verification status every 5 seconds\n  useEffect(() => {\n    const interval = setInterval(async () => {\n      if (user && !user.emailVerified) {\n        const result = await checkEmailVerification();\n        if (result.verified) {\n          // Page will refresh automatically when user is verified\n          window.location.reload();\n        }\n      }\n    }, 5000);\n\n    return () => clearInterval(interval);\n  }, [user, checkEmailVerification]);\n\n  const handleResendVerification = async () => {\n    setIsResending(true);\n    setMessage('');\n    \n    const result = await sendVerificationEmail();\n    if (result.success) {\n      setMessage('Verification email sent!');\n    } else {\n      setMessage(`Error: ${result.error}`);\n    }\n    \n    setIsResending(false);\n    \n    // Clear message after 3 seconds\n    setTimeout(() => setMessage(''), 3000);\n  };\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gradient-to-br from-yellow-50 to-emerald-50 p-4\">\n      <div className=\"bg-white rounded-2xl shadow-2xl w-full max-w-md mx-auto border-2 border-emerald-600\">\n        {/* Header */}\n        <div className=\"bg-yellow-400 rounded-t-xl p-6 text-center\">\n          <div className=\"w-16 h-16 bg-emerald-700 rounded-full flex items-center justify-center mx-auto mb-4\">\n            <svg className=\"w-8 h-8 text-white\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 002 2v10a2 2 0 002 2z\" />\n            </svg>\n          </div>\n          <h2 className=\"text-xl sm:text-2xl font-bold text-emerald-700\">Verify Your Email</h2>\n          <p className=\"text-sm sm:text-base text-gray-700 mt-2\">\n            Almost there! Check your email to complete registration.\n          </p>\n        </div>\n\n        {/* Content */}\n        <div className=\"p-6\">\n          {/* Main Text */}\n          <p className=\"text-lg text-gray-800 mb-4 text-center\">\n            We sent a verification email to <span className=\"font-medium text-emerald-700\">{user?.email}</span>, please verify yourself from there.\n          </p>\n\n          {/* Sub Text */}\n          <p className=\"text-sm text-gray-600 mb-6 text-center\">\n            If you don't receive it, check your spam folder or \n            <button\n              onClick={handleResendVerification}\n              disabled={isResending}\n              className=\"btn-base btn-link ml-1\"\n            >\n              {isResending ? 'sending...' : 'click to resend'}\n            </button>\n          </p>\n\n          {/* Message Display */}\n          {message && (\n            <div className={`text-sm text-center p-3 rounded-lg mb-4 ${\n              message.includes('Error') \n                ? 'bg-red-50 text-red-700' \n                : 'bg-emerald-50 text-emerald-700'\n            }`}>\n              {message}\n            </div>\n          )}\n\n          {/* Logout Option */}\n          <div className=\"pt-4 border-t border-gray-200\">\n            <p className=\"text-sm text-gray-500 text-center mb-3\">\n              Don't want to verify right now?\n            </p>\n            <p className=\"text-sm text-gray-600 text-center\">\n              <button\n                onClick={logout}\n                className=\"btn-base btn-link\"\n              >\n                Sign out\n              </button>\n              {\" \"}and continue without account\n            </p>\n          </div>\n\n        </div>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":3902,"size_tokens":null},"src/components/InteractiveClient.js":{"content":"'use client';\n\nimport { useState } from 'react';\nimport { useBodyScrollLock } from '../hooks/useBodyScrollLock';\nimport Header from './Header';\nimport Footer from './Footer';\nimport MobileMenu from './MobileMenu';\n\nexport default function InteractiveClient({ children }) {\n  const [isMenuOpen, setIsMenuOpen] = useState(false);\n\n  // Prevent body scrolling when sidebar is open\n  useBodyScrollLock(isMenuOpen);\n\n  return (\n    <div className=\"min-h-screen flex flex-col relative\">\n      {/* Main Content with blur effect */}\n      <div className={`min-h-screen flex flex-col transition-all duration-300 ${\n        isMenuOpen ? 'blur-sm' : ''\n      }`}>\n        <Header isMenuOpen={isMenuOpen} setIsMenuOpen={setIsMenuOpen} />\n        <main className=\"flex-1\">\n          {children}\n        </main>\n        <Footer />\n      </div>\n\n    {/* Mobile Menu Component */}\n    <MobileMenu \n      isMenuOpen={isMenuOpen}\n      setIsMenuOpen={setIsMenuOpen}\n    />\n    </div>\n  );\n}","path":null,"size_bytes":971,"size_tokens":null},"src/app/(chrome)/admin/users/page.js":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport UsersTable from \"@/components/admin/UsersTable\";\nimport UserDetailsModal from \"@/components/admin/UserDetailsModal\";\nimport ErrorBoundary from \"@/components/ErrorBoundary\";\n\nexport default function AdminUsersPage() {\n  return (\n    <ErrorBoundary>\n      <AdminUsersContent />\n    </ErrorBoundary>\n  );\n}\n\nfunction AdminUsersContent() {\n  const { user } = useAuth();\n  const [users, setUsers] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [loadingMore, setLoadingMore] = useState(false);\n  const [hasMore, setHasMore] = useState(true);\n  const [selectedUser, setSelectedUser] = useState(null);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [roleFilter, setRoleFilter] = useState('admin');\n  const [limit, setLimit] = useState(10);\n\n  const fetchUsers = async (isLoadMore = false) => {\n    if (!user) return;\n\n    if (isLoadMore) {\n      setLoadingMore(true);\n    } else {\n      setLoading(true);\n    }\n    \n    try {\n      const token = await user.getIdToken();\n      \n      const params = new URLSearchParams();\n      if (roleFilter !== 'all') params.append('role', roleFilter);\n      if (searchTerm) params.append('search', searchTerm);\n      params.append('limit', limit.toString());\n      \n      const response = await fetch(`/api/admin/users?${params.toString()}`, {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to fetch users');\n      }\n\n      const data = await response.json();\n      const newUsers = data.data || [];\n      setUsers(newUsers);\n      setHasMore(newUsers.length === limit);\n    } catch (error) {\n      console.error('Error fetching users:', error);\n    } finally {\n      setLoading(false);\n      setLoadingMore(false);\n    }\n  };\n\n  const handleLoadMore = () => {\n    setLimit(prev => prev + 10);\n    setTimeout(() => fetchUsers(true), 0);\n  };\n\n  const handleSelectUser = (selectedUser) => {\n    setSelectedUser(selectedUser);\n  };\n\n  const handleCloseModal = () => {\n    setSelectedUser(null);\n  };\n\n  const handleUserUpdate = () => {\n    setSelectedUser(null);\n    fetchUsers();\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <h2 className=\"text-lg font-semibold text-gray-900 mb-4\">Load Users</h2>\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <div>\n            <label htmlFor=\"search\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Search\n            </label>\n            <input\n              id=\"search\"\n              type=\"text\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              placeholder=\"Search by name, email, or username...\"\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n            />\n          </div>\n\n          <div>\n            <label htmlFor=\"role-filter\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Role\n            </label>\n            <select\n              id=\"role-filter\"\n              value={roleFilter}\n              onChange={(e) => setRoleFilter(e.target.value)}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n            >\n              <option value=\"all\" className=\"text-gray-900\">All Roles</option>\n              <option value=\"user\" className=\"text-gray-900\">Users</option>\n              <option value=\"admin\" className=\"text-gray-900\">Admins</option>\n            </select>\n          </div>\n\n          <div>\n            <label htmlFor=\"limit-input\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Number of Users\n            </label>\n            <input\n              id=\"limit-input\"\n              type=\"number\"\n              min=\"1\"\n              max=\"500\"\n              value={limit}\n              onChange={(e) => setLimit(parseInt(e.target.value) || 10)}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n              placeholder=\"10\"\n            />\n          </div>\n\n          <div className=\"flex items-end\">\n            <button\n              onClick={fetchUsers}\n              disabled={loading || !user}\n              className=\"w-full px-6 py-2 bg-emerald-600 text-white font-medium rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors\"\n            >\n              {loading ? (\n                <span className=\"flex items-center justify-center\">\n                  <svg className=\"animate-spin -ml-1 mr-2 h-4 w-4 text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                  </svg>\n                  Loading...\n                </span>\n              ) : (\n                'Load Users'\n              )}\n            </button>\n          </div>\n        </div>\n        {users.length > 0 && (\n          <div className=\"mt-4 text-sm text-gray-600\">\n            Showing <span className=\"font-semibold\">{users.length}</span> user{users.length !== 1 ? 's' : ''}\n          </div>\n        )}\n      </div>\n\n      <UsersTable\n        users={users}\n        loading={loading}\n        onSelectUser={handleSelectUser}\n        searchTerm={searchTerm}\n        onSearchChange={setSearchTerm}\n      />\n\n      {users.length > 0 && hasMore && !loading && (\n        <div className=\"bg-white rounded-lg shadow p-6 text-center\">\n          <button\n            onClick={handleLoadMore}\n            disabled={loadingMore}\n            className=\"px-8 py-3 bg-emerald-600 text-white font-medium rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors\"\n          >\n            {loadingMore ? (\n              <span className=\"flex items-center justify-center\">\n                <svg className=\"animate-spin -ml-1 mr-2 h-4 w-4 text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                  <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                </svg>\n                Loading More...\n              </span>\n            ) : (\n              'Load More (10 items)'\n            )}\n          </button>\n        </div>\n      )}\n\n      {selectedUser && (\n        <UserDetailsModal\n          user={selectedUser}\n          onClose={handleCloseModal}\n          onUpdate={handleUserUpdate}\n        />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":7301,"size_tokens":null},"src/components/ProfilePageWrapper.js":{"content":"'use client';\n\nimport { useAuth } from '../hooks/useAuth';\nimport { useRouter } from 'next/navigation';\nimport ProfilePage from './ProfilePage';\n\nfunction ProfilePageWrapper({ isOwnProfile = false }) {\n  const { user, loading } = useAuth();\n  const router = useRouter();\n  \n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto mb-4\"></div>\n          <p className=\"text-gray-600\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // If it's supposed to be own profile but user is not authenticated\n  if (isOwnProfile && !user) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\n        <div className=\"max-w-md mx-auto text-center px-6\">\n          <div className=\"mx-auto w-24 h-24 bg-emerald-100 rounded-full flex items-center justify-center mb-6\">\n            <svg className=\"w-12 h-12 text-emerald-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\" />\n            </svg>\n          </div>\n          <h3 className=\"text-2xl font-bold text-gray-900 mb-2\">You haven't created an account</h3>\n          <p className=\"text-gray-600 mb-6\">Create an account or sign in if you already have one to view and manage your profile.</p>\n          <div className=\"space-y-3\">\n            <button \n              onClick={() => router.push('/signup')}\n              className=\"btn-base btn-primary w-full px-6 py-3 font-medium\"\n            >\n              Create Account\n            </button>\n            <button \n              onClick={() => router.push('/signin')}\n              className=\"btn-base btn-secondary w-full px-6 py-3 font-medium\"\n            >\n              Sign In\n            </button>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // User is authenticated or viewing someone else's profile\n  return <ProfilePage isOwnProfile={isOwnProfile} />;\n}\n\nProfilePageWrapper.displayName = 'ProfilePageWrapper';\nexport default ProfilePageWrapper;","path":null,"size_bytes":2261,"size_tokens":null},"src/utils/admin/adminHelpers.js":{"content":"/**\n * Admin Helper Utilities\n * Reusable formatting and helper functions for admin dashboard\n */\n\n/**\n * Convert report reason to human-readable text\n * @param {string} reason - Report reason code\n * @returns {string} Human-readable reason\n */\nexport function formatReportReason(reason) {\n  switch (reason) {\n    case 'inappropriate':\n      return 'Inappropriate Content';\n    case 'spam':\n      return 'Spam';\n    case 'copyright':\n      return 'Copyright Violation';\n    case 'inappropriate_avatar':\n      return 'Inappropriate Profile Picture';\n    case 'offensive_username':\n      return 'Offensive Username';\n    case 'spam_bio':\n      return 'Spam in Bio';\n    case 'impersonation':\n      return 'Impersonation';\n    case 'other':\n      return 'Other';\n    default:\n      return reason;\n  }\n}\n\n/**\n * Get badge color class for moderation status\n * @param {string} status - Moderation status\n * @returns {string} Tailwind CSS classes\n */\nexport function getModerationStatusColor(status) {\n  switch (status) {\n    case 'active':\n      return 'bg-green-100 text-green-800';\n    case 'under-review':\n      return 'bg-yellow-100 text-yellow-800';\n    case 'under-review-hidden':\n      return 'bg-orange-100 text-orange-800';\n    case 'removed':\n    case 'removed-temporary':\n      return 'bg-red-100 text-red-800';\n    case 'removed-permanent':\n      return 'bg-red-200 text-red-900';\n    case 'banned-temporary':\n      return 'bg-red-100 text-red-800';\n    case 'banned-permanent':\n      return 'bg-red-200 text-red-900';\n    case 'deleted':\n      return 'bg-gray-200 text-gray-700';\n    default:\n      return 'bg-gray-100 text-gray-800';\n  }\n}\n\n/**\n * Get badge color class for report status\n * @param {string} status - Report status\n * @returns {string} Tailwind CSS classes\n */\nexport function getReportStatusColor(status) {\n  switch (status) {\n    case 'pending':\n      return 'bg-yellow-100 text-yellow-800';\n    case 'reviewed':\n      return 'bg-blue-100 text-blue-800';\n    case 'resolved':\n      return 'bg-green-100 text-green-800';\n    case 'dismissed':\n      return 'bg-gray-100 text-gray-800';\n    default:\n      return 'bg-gray-100 text-gray-800';\n  }\n}\n\n/**\n * Get badge color class for user role\n * @param {string} role - User role\n * @returns {string} Tailwind CSS classes\n */\nexport function getRoleBadgeColor(role) {\n  return role === 'admin' \n    ? 'bg-purple-100 text-purple-800' \n    : 'bg-gray-100 text-gray-800';\n}\n\n/**\n * Format timestamp to human-readable date\n * @param {string|Date} dateString - Date string or Date object\n * @param {boolean} includeTime - Whether to include time\n * @returns {string} Formatted date\n */\nexport function formatTimestamp(dateString, includeTime = false) {\n  if (!dateString) return '-';\n  \n  try {\n    const options = {\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric',\n    };\n    \n    if (includeTime) {\n      options.hour = '2-digit';\n      options.minute = '2-digit';\n    }\n    \n    return new Date(dateString).toLocaleDateString('en-US', options);\n  } catch {\n    return '-';\n  }\n}\n\n/**\n * Truncate text to specified length\n * @param {string} text - Text to truncate\n * @param {number} maxLength - Maximum length\n * @returns {string} Truncated text with ellipsis\n */\nexport function truncateText(text, maxLength = 50) {\n  if (!text) return '';\n  if (text.length <= maxLength) return text;\n  return text.substring(0, maxLength) + '...';\n}\n\n/**\n * Format number with thousands separator\n * @param {number} num - Number to format\n * @returns {string} Formatted number\n */\nexport function formatNumber(num) {\n  if (num === null || num === undefined) return '0';\n  return num.toLocaleString();\n}\n","path":null,"size_bytes":3674,"size_tokens":null},"src/app/(chrome)/creators/page.js":{"content":"\"use client\";\n\nimport { useState, useEffect, useCallback } from 'react';\nimport Link from 'next/link';\nimport { getTopCreators } from '../../../lib/firestore';\nimport { getProfileAvatar } from '../../../utils/imageTransform';\nimport LoadingSpinner from '../../../components/LoadingSpinner';\nimport FilterModal from '../../../components/FilterModal';\n\nexport default function CreatorsPage() {\n  const [creators, setCreators] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);\n  \n  const [filters, setFilters] = useState({\n    country: null,\n    timePeriod: 'all'\n  });\n\n  const loadCreators = useCallback(async () => {\n    setLoading(true);\n    try {\n      const result = await getTopCreators(filters);\n      setCreators(result);\n    } catch (error) {\n      console.error('Error loading creators:', error);\n    } finally {\n      setLoading(false);\n    }\n  }, [filters]);\n\n  useEffect(() => {\n    loadCreators();\n  }, [loadCreators]);\n\n  const handleApplyFilters = (newFilters) => {\n    setFilters(newFilters);\n  };\n\n  const filterFields = [\n    {\n      key: 'timePeriod',\n      label: 'Time Period',\n      options: [\n        { value: 'all', label: 'All Time' },\n        { value: '24h', label: 'Last 24 Hours' },\n        { value: '7d', label: 'Last 7 Days' },\n        { value: '30d', label: 'Last 30 Days' }\n      ]\n    }\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-white\">\n      <div className=\"min-h-screen flex\">\n        <div className=\"flex-1 w-full flex flex-col justify-center py-8 px-4 sm:px-6 lg:px-16 xl:px-20 pt-20\">\n          <div className=\"mx-auto w-full max-w-6xl\">\n            {/* Header */}\n            <div className=\"text-center mb-8 bg-yellow-400 px-6 py-6 rounded-t-xl\">\n              <h1 className=\"text-2xl sm:text-3xl font-bold text-emerald-700\">Top Creators</h1>\n              <p className=\"text-base sm:text-lg text-gray-700 mt-2\">Discover creators with the most supported campaigns</p>\n            </div>\n            \n            {/* Content Card with Shadow Border */}\n            <div className=\"bg-white rounded-b-xl border border-t-0 border-gray-200 px-6 py-8 shadow-sm\">\n              {/* Filter Button */}\n              <div className=\"mb-6 flex justify-between items-center\">\n                <div className=\"text-sm text-gray-600\">\n                  <span className=\"font-semibold text-emerald-600 text-lg\">{creators.length}</span>\n                  <span className=\"ml-1\">creators found</span>\n                </div>\n                <button\n                  onClick={() => setIsFilterModalOpen(true)}\n                  className=\"btn-base btn-secondary px-4 py-2 text-sm flex items-center gap-2\"\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z\" />\n                  </svg>\n                  Filters\n                </button>\n              </div>\n\n              {/* Creators List */}\n              {loading ? (\n                <div className=\"flex justify-center items-center py-20\">\n                  <LoadingSpinner size=\"lg\" />\n                </div>\n              ) : creators.length === 0 ? (\n                <div className=\"bg-gray-50 rounded-xl p-12 text-center border border-gray-200\">\n                  <svg\n                    className=\"mx-auto h-16 w-16 text-gray-400 mb-4\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    stroke=\"currentColor\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      strokeWidth={1.5}\n                      d=\"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z\"\n                    />\n                  </svg>\n                  <h3 className=\"text-xl font-semibold text-gray-900 mb-2\">No creators found</h3>\n                  <p className=\"text-gray-600 mb-6\">Try adjusting your filters or check back later</p>\n                  <Link\n                    href=\"/create\"\n                    className=\"btn-base btn-primary inline-block px-6 py-3 font-medium\"\n                  >\n                    Become a Creator\n                  </Link>\n                </div>\n              ) : (\n                <div className=\"bg-white rounded-xl border border-gray-200 overflow-hidden\">\n                  {/* Table Header */}\n                  <div className=\"bg-gradient-to-r from-emerald-500 to-emerald-600 px-4 sm:px-6 py-4\">\n                    <div className=\"grid grid-cols-12 gap-3 sm:gap-4 text-emerald-50 font-semibold text-sm\">\n                      <div className=\"col-span-2 sm:col-span-1\">Rank</div>\n                      <div className=\"col-span-6 sm:col-span-8\">Creator</div>\n                      <div className=\"col-span-4 sm:col-span-3 text-center\">Supports</div>\n                    </div>\n                  </div>\n\n                  {/* Creators List */}\n                  <div className=\"divide-y divide-gray-200\">\n                    {creators.map((creator, index) => (\n                      <Link\n                        key={creator.id}\n                        href={`/u/${creator.username}`}\n                        className=\"block px-4 sm:px-6 py-4 hover:bg-gray-50 transition-colors duration-150\"\n                      >\n                        <div className=\"grid grid-cols-12 gap-3 sm:gap-4 items-center\">\n                          {/* Rank */}\n                          <div className=\"col-span-2 sm:col-span-1\">\n                            <div className={`flex items-center justify-center w-7 h-7 rounded-full font-bold text-xs ${\n                              index === 0 ? 'bg-yellow-100 text-yellow-700' :\n                              index === 1 ? 'bg-gray-100 text-gray-700' :\n                              index === 2 ? 'bg-orange-100 text-orange-700' :\n                              'bg-emerald-50 text-emerald-700'\n                            }`}>\n                              {index + 1}\n                            </div>\n                          </div>\n\n                          {/* Creator Info */}\n                          <div className=\"col-span-6 sm:col-span-8 flex items-center gap-2 min-w-0\">\n                            {/* Profile Image */}\n                            <div className=\"w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center flex-shrink-0\">\n                              {creator.profileImage ? (\n                                <img\n                                  src={getProfileAvatar(creator.profileImage)}\n                                  alt={creator.displayName}\n                                  className=\"w-full h-full rounded-full object-cover\"\n                                />\n                              ) : (\n                                <span className=\"text-white text-base font-bold\">\n                                  {creator.displayName?.charAt(0)?.toUpperCase() || 'U'}\n                                </span>\n                              )}\n                            </div>\n                            \n                            {/* Name and Username */}\n                            <div className=\"min-w-0 flex-1\">\n                              <h3 className=\"font-semibold text-gray-900 truncate\">\n                                {creator.displayName}\n                              </h3>\n                              <p className=\"text-sm text-emerald-600 truncate\">\n                                @{creator.username}\n                              </p>\n                            </div>\n                          </div>\n\n                          {/* Total Supports */}\n                          <div className=\"col-span-4 sm:col-span-3 text-center\">\n                            <div className=\"font-bold text-emerald-600 text-lg\">\n                              {creator.totalSupports || 0}\n                            </div>\n                          </div>\n                        </div>\n                      </Link>\n                    ))}\n                  </div>\n                </div>\n              )}\n\n              {/* Info Card */}\n              <div className=\"mt-8 bg-emerald-50 border border-emerald-200 rounded-xl p-6\">\n                <div className=\"flex items-start gap-4\">\n                  <div className=\"flex-shrink-0\">\n                    <svg className=\"w-6 h-6 text-emerald-600\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                      <path fillRule=\"evenodd\" d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z\" clipRule=\"evenodd\" />\n                    </svg>\n                  </div>\n                  <div>\n                    <h3 className=\"font-semibold text-emerald-900 mb-1\">How are creators ranked?</h3>\n                    <p className=\"text-sm text-emerald-800 leading-relaxed\">\n                      Creators are ranked by their total supports (downloads) across all campaigns. The more people use your campaigns, the higher you'll rank. Create amazing frames and backgrounds to climb the leaderboard!\n                    </p>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Filter Modal */}\n      <FilterModal\n        isOpen={isFilterModalOpen}\n        onClose={() => setIsFilterModalOpen(false)}\n        onApply={handleApplyFilters}\n        initialFilters={filters}\n        filterFields={filterFields}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":10056,"size_tokens":null},"src/app/(chrome)/profile/edit/page.js":{"content":"\"use client\";\n\nimport { useState, useRef, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { countries } from '../../../../data/countries';\nimport { useAuth } from '../../../../hooks/useAuth';\nimport { getUserProfile, checkUsernameExists, updateUserProfile } from '../../../../lib/firestore';\nimport { useOptionalUserProfile } from '../../../../components/UserProfileProvider';\nimport ConfirmationModal from '../../../../components/ConfirmationModal';\nimport { uploadFile } from '../../../../lib/supabase';\nimport { getProfileAvatar, getProfileBanner } from '../../../../utils/imageTransform';\n\nexport default function ProfileEditPage() {\n  const router = useRouter();\n  const { user, loading: authLoading } = useAuth();\n  const profileContext = useOptionalUserProfile();\n  const [loading, setLoading] = useState(false);\n  const [errors, setErrors] = useState({});\n  const [usernameStatus, setUsernameStatus] = useState(null); // 'checking', 'available', 'taken', 'unchanged'\n  const [originalUsername, setOriginalUsername] = useState('');\n  const [userData, setUserData] = useState(null);\n  const [hasChanges, setHasChanges] = useState(false);\n  const [confirmModal, setConfirmModal] = useState({ isOpen: false, field: null, previewField: null, imageType: '' });\n  const [leaveConfirmModal, setLeaveConfirmModal] = useState({ isOpen: false, actionType: null, action: null });\n  const usernameCheckTimeoutRef = useRef(null);\n  const usernameRequestIdRef = useRef(0);\n  \n  // Form data state\n  const [formData, setFormData] = useState({\n    username: '',\n    displayName: '',\n    country: '',\n    profilePic: null,\n    profilePicPreview: '',\n    profileBanner: null,\n    profileBannerPreview: '',\n    bio: ''\n  });\n\n  const profilePicRef = useRef();\n  const profileBannerRef = useRef();\n  \n  // Refs for form validation scrolling\n  const usernameRef = useRef();\n  const displayNameRef = useRef();\n  const countryRef = useRef();\n\n  // Redirect if not authenticated\n  useEffect(() => {\n    if (!authLoading && !user) {\n      router.push('/signin');\n    }\n  }, [user, authLoading, router]);\n\n  // Cleanup timeout on unmount\n  useEffect(() => {\n    return () => {\n      if (usernameCheckTimeoutRef.current) {\n        clearTimeout(usernameCheckTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  // Track initial URL for proper back button handling\n  const [currentUrl, setCurrentUrl] = useState('');\n  \n  useEffect(() => {\n    setCurrentUrl(window.location.pathname);\n  }, []);\n\n  // Prevent navigation when there are unsaved changes\n  useEffect(() => {\n    const handleBeforeUnload = (e) => {\n      if (hasChanges) {\n        e.preventDefault();\n        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';\n        return 'You have unsaved changes. Are you sure you want to leave?';\n      }\n    };\n\n    const handlePopState = (e) => {\n      if (hasChanges) {\n        // Prevent the navigation temporarily\n        window.history.pushState(null, '', currentUrl);\n        // Show custom confirmation modal\n        setLeaveConfirmModal({\n          isOpen: true,\n          actionType: 'navigation',\n          action: () => {\n            // User confirmed they want to leave - allow navigation\n            setHasChanges(false);\n            window.history.back();\n          }\n        });\n      }\n    };\n\n    const handleLinkClick = (e) => {\n      if (hasChanges) {\n        // Check if it's a navigation link\n        const target = e.target.closest('a');\n        if (target && target.href && target.href !== window.location.href) {\n          e.preventDefault();\n          // Show custom confirmation modal\n          setLeaveConfirmModal({\n            isOpen: true,\n            actionType: 'link',\n            action: () => {\n              // User confirmed they want to leave - navigate to the link\n              setHasChanges(false);\n              window.location.href = target.href;\n            }\n          });\n        }\n      }\n    };\n\n    if (hasChanges) {\n      window.addEventListener('beforeunload', handleBeforeUnload);\n      window.addEventListener('popstate', handlePopState);\n      document.addEventListener('click', handleLinkClick, true);\n      \n      return () => {\n        window.removeEventListener('beforeunload', handleBeforeUnload);\n        window.removeEventListener('popstate', handlePopState);\n        document.removeEventListener('click', handleLinkClick, true);\n      };\n    }\n  }, [hasChanges, currentUrl]);\n\n  // Load user data when component mounts\n  useEffect(() => {\n    const loadUserData = async () => {\n      if (!user) return;\n      \n      try {\n        const userProfile = await getUserProfile(user.uid);\n        if (userProfile) {\n          setUserData(userProfile);\n          const initialData = {\n            username: userProfile.username || '',\n            displayName: userProfile.displayName || '',\n            country: userProfile.country || '',\n            profilePic: null,\n            profilePicPreview: userProfile.profileImage ? getProfileAvatar(userProfile.profileImage) : '',\n            profileBanner: null,\n            profileBannerPreview: userProfile.bannerImage ? getProfileBanner(userProfile.bannerImage) : '',\n            bio: userProfile.bio || ''\n          };\n          setFormData(initialData);\n          setInitialFormData(initialData); // Set baseline for change detection\n          setOriginalUsername(userProfile.username || '');\n          setUsernameStatus('unchanged');\n        }\n      } catch (error) {\n        if (process.env.NODE_ENV === 'development') {\n          console.error('Error loading user data:', error);\n        }\n        setErrors({ general: 'Failed to load profile data. Please try again.' });\n      }\n    };\n\n    loadUserData();\n  }, [user]);\n\n  // Function to check username availability with debouncing\n  const checkUsernameAvailability = async (username) => {\n    if (!username || username.length < 3) {\n      setUsernameStatus(null);\n      return;\n    }\n\n    // If username is unchanged from original, mark as unchanged\n    if (username === originalUsername) {\n      setUsernameStatus('unchanged');\n      return;\n    }\n\n    // Clear existing timeout\n    if (usernameCheckTimeoutRef.current) {\n      clearTimeout(usernameCheckTimeoutRef.current);\n    }\n\n    setUsernameStatus('checking');\n    \n    // Increment request ID to handle race conditions\n    const currentRequestId = ++usernameRequestIdRef.current;\n\n    // Set new timeout for debouncing\n    usernameCheckTimeoutRef.current = setTimeout(async () => {\n      try {\n        const exists = await checkUsernameExists(username);\n        \n        // Only update if this is still the latest request\n        if (currentRequestId === usernameRequestIdRef.current) {\n          const newStatus = exists ? 'taken' : 'available';\n          setUsernameStatus(newStatus);\n        }\n      } catch (error) {\n        if (process.env.NODE_ENV === 'development') {\n          console.error('Error checking username:', error);\n        }\n        if (currentRequestId === usernameRequestIdRef.current) {\n          setUsernameStatus(null); // Show neutral state on error\n        }\n      }\n    }, 500); // 500ms debounce\n  };\n\n  // Track if user has made any edits (not just has content)\n  const [userHasEdited, setUserHasEdited] = useState(false);\n  const [initialFormData, setInitialFormData] = useState(null);\n\n  // Check if form has changes compared to original data\n  const checkForChanges = (currentFormData) => {\n    if (!initialFormData) {\n      setHasChanges(false);\n      return;\n    }\n    \n    // Compare with initial form data\n    const hasChanged = currentFormData.username !== initialFormData.username ||\n                      currentFormData.displayName !== initialFormData.displayName ||\n                      currentFormData.country !== initialFormData.country ||\n                      currentFormData.profilePicPreview !== initialFormData.profilePicPreview ||\n                      currentFormData.profileBannerPreview !== initialFormData.profileBannerPreview ||\n                      currentFormData.bio !== initialFormData.bio;\n    \n    setHasChanges(hasChanged);\n  };\n\n  const handleInputChange = (field, value) => {\n    const newFormData = { ...formData, [field]: value };\n    setFormData(newFormData);\n    setUserHasEdited(true); // Mark that user has made edits\n    \n    if (errors[field]) {\n      setErrors(prev => ({ ...prev, [field]: '' }));\n    }\n    \n    // Check username availability in real-time\n    if (field === 'username') {\n      checkUsernameAvailability(value);\n    }\n    \n    // Check for changes\n    checkForChanges(newFormData);\n  };\n\n  const handleFileChange = (field, file, previewField) => {\n    if (!file) return;\n    \n    // Clear any previous file-related errors\n    const fileErrorKey = field === 'profilePic' ? 'profilePic' : 'profileBanner';\n    if (errors[fileErrorKey]) {\n      setErrors(prev => ({ ...prev, [fileErrorKey]: '' }));\n    }\n    \n    // File size validation (5MB limit)\n    const maxSize = 5 * 1024 * 1024; // 5MB in bytes\n    if (file.size > maxSize) {\n      const fileName = field === 'profilePic' ? 'Profile picture' : 'Banner image';\n      setErrors(prev => ({\n        ...prev,\n        [fileErrorKey]: `${fileName} must be smaller than 5MB. Current size: ${(file.size / (1024 * 1024)).toFixed(1)}MB`\n      }));\n      return;\n    }\n    \n    // File type validation\n    if (!file.type.startsWith('image/')) {\n      const fileName = field === 'profilePic' ? 'Profile picture' : 'Banner image';\n      setErrors(prev => ({\n        ...prev,\n        [fileErrorKey]: `${fileName} must be an image file (JPG, PNG, GIF, etc.)`\n      }));\n      return;\n    }\n    \n    // File is valid, proceed with reading\n    const reader = new FileReader();\n    reader.onload = (e) => {\n      const newFormData = {\n        ...formData,\n        [field]: file,\n        [previewField]: e.target.result\n      };\n      setFormData(newFormData);\n      setUserHasEdited(true); // Mark that user has made edits\n      // Check for changes\n      checkForChanges(newFormData);\n    };\n    reader.readAsDataURL(file);\n  };\n\n  const handleRemoveImage = (field, previewField) => {\n    const imageType = field === 'profilePic' ? 'profile photo' : 'banner';\n    setConfirmModal({\n      isOpen: true,\n      field,\n      previewField,\n      imageType\n    });\n  };\n\n  const confirmRemoveImage = () => {\n    const { field, previewField } = confirmModal;\n    \n    const newFormData = {\n      ...formData,\n      [field]: null,\n      [previewField]: ''\n    };\n    setFormData(newFormData);\n    setUserHasEdited(true); // Mark that user has made edits\n    \n    // Clear the file input value to allow re-uploading the same file\n    const inputRef = field === 'profilePic' ? profilePicRef : profileBannerRef;\n    if (inputRef.current) {\n      inputRef.current.value = '';\n    }\n    \n    // Clear any file-related errors\n    const fileErrorKey = field === 'profilePic' ? 'profilePic' : 'profileBanner';\n    if (errors[fileErrorKey]) {\n      setErrors(prev => ({ ...prev, [fileErrorKey]: '' }));\n    }\n    \n    // Check for changes\n    checkForChanges(newFormData);\n  };\n\n  const handleLeaveConfirm = () => {\n    if (leaveConfirmModal.action) {\n      leaveConfirmModal.action();\n    }\n    setLeaveConfirmModal({ isOpen: false, actionType: null, action: null });\n  };\n\n  const handleLeaveCancel = () => {\n    setLeaveConfirmModal({ isOpen: false, actionType: null, action: null });\n  };\n\n  const scrollToField = (fieldName) => {\n    const fieldRefs = {\n      username: usernameRef,\n      displayName: displayNameRef,\n      country: countryRef\n    };\n    \n    const fieldRef = fieldRefs[fieldName];\n    if (fieldRef?.current) {\n      fieldRef.current.scrollIntoView({\n        behavior: 'smooth',\n        block: 'center'\n      });\n      // Focus the field after scrolling\n      setTimeout(() => {\n        fieldRef.current.focus();\n      }, 300);\n    }\n  };\n\n  const validateForm = () => {\n    const newErrors = {};\n    let firstErrorField = null;\n\n    if (!formData.username.trim()) {\n      newErrors.username = 'Username is required';\n      if (!firstErrorField) firstErrorField = 'username';\n    } else if (formData.username.length < 3) {\n      newErrors.username = 'Username must be at least 3 characters';\n      if (!firstErrorField) firstErrorField = 'username';\n    } else if (!/^[a-z0-9]+$/.test(formData.username)) {\n      newErrors.username = 'Username can only contain lowercase letters and numbers';\n      if (!firstErrorField) firstErrorField = 'username';\n    } else if (usernameStatus === 'taken') {\n      newErrors.username = 'This username is already taken';\n      if (!firstErrorField) firstErrorField = 'username';\n    }\n\n    if (!formData.displayName.trim()) {\n      newErrors.displayName = 'Display name is required';\n      if (!firstErrorField) firstErrorField = 'displayName';\n    }\n\n    if (!formData.country) {\n      newErrors.country = 'Please select your country';\n      if (!firstErrorField) firstErrorField = 'country';\n    }\n\n    setErrors(newErrors);\n    \n    // If there are errors, scroll to the first error field\n    if (firstErrorField) {\n      setTimeout(() => scrollToField(firstErrorField), 100);\n    }\n    \n    return Object.keys(newErrors).length === 0;\n  };\n\n  const handleSave = async () => {\n    if (!validateForm()) return;\n\n    setLoading(true);\n    try {\n      // Prepare profile data\n      const profileData = {\n        username: formData.username,\n        displayName: formData.displayName,\n        country: formData.country,\n        bio: formData.bio,\n      };\n\n      // Handle profile image upload to Supabase\n      if (formData.profilePic) {\n        // User selected a new profile image - upload to Supabase\n        const uploadResult = await uploadFile(formData.profilePic, 'profile-images');\n        // Get public URL from Supabase\n        const publicUrl = `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/uploads/${uploadResult.path}`;\n        profileData.profileImage = publicUrl;\n      } else if (formData.profilePicPreview === '' && userData?.profileImage) {\n        // User removed the image\n        profileData.profileImage = null;\n      }\n\n      // Handle banner image upload to Supabase\n      if (formData.profileBanner) {\n        // User selected a new banner image - upload to Supabase\n        const uploadResult = await uploadFile(formData.profileBanner, 'profile-images');\n        // Get public URL from Supabase\n        const publicUrl = `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/uploads/${uploadResult.path}`;\n        profileData.bannerImage = publicUrl;\n      } else if (formData.profileBannerPreview === '' && userData?.bannerImage) {\n        // User removed the image\n        profileData.bannerImage = null;\n      }\n\n      const result = await updateUserProfile(userData.id, profileData);\n      \n      if (result.success) {\n        // Refresh the user profile context to update sidebar\n        if (profileContext?.refreshUserProfile) {\n          await profileContext.refreshUserProfile();\n        }\n        // Navigate back to profile page\n        router.push('/profile');\n      } else {\n        throw new Error(result.error || 'Failed to update profile');\n      }\n    } catch (error) {\n      console.error('Error updating profile:', error);\n      setErrors({ general: 'Failed to update profile. Please try again.' });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // Show loading state while auth is loading\n  if (authLoading) {\n    return (\n      <div className=\"min-h-screen bg-white flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-gray-600\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Don't render if user is not authenticated (redirect will handle this)\n  if (!user) {\n    return null;\n  }\n\n  return (\n    <div className=\"min-h-screen bg-white\">\n      \n      <div className=\"min-h-screen flex\">\n        {/* Main Content */}\n        <div className=\"flex-1 w-full flex flex-col justify-center py-8 px-4 sm:px-6 lg:px-16 xl:px-20 pt-20\">\n          <div className=\"mx-auto w-full max-w-4xl\">\n            {/* Header */}\n            <div className=\"text-center mb-8 bg-yellow-400 px-6 py-6 rounded-t-xl\">\n              <h1 className=\"text-2xl sm:text-3xl font-bold text-emerald-700\">Edit Profile</h1>\n              <p className=\"text-base sm:text-lg text-gray-700 mt-2\">Update your profile information</p>\n            </div>\n            \n            {/* Content Card with Shadow Border */}\n            <div className=\"bg-white rounded-b-xl border border-t-0 border-gray-200 px-6 py-8 shadow-sm\">\n              {errors.general && (\n                <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm\">\n                  {errors.general}\n                </div>\n              )}\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                {/* Profile Banner - moved to top */}\n                <div className=\"md:col-span-2\">\n                  <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                    Profile Banner\n                  </label>\n                  <div className=\"space-y-3\">\n                    <div className=\"w-full aspect-[4/1] rounded-lg overflow-hidden border-2 border-gray-200\">\n                      {formData.profileBannerPreview ? (\n                        <img\n                          src={formData.profileBannerPreview}\n                          alt=\"Banner preview\"\n                          className=\"w-full h-full object-cover\"\n                        />\n                      ) : (\n                        <div className=\"w-full h-full bg-gradient-to-r from-emerald-400 to-emerald-600 flex flex-col items-center justify-center\">\n                          <svg className=\"w-12 h-12 text-white/70 mb-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 002 2v12a2 2 0 002 2z\" />\n                          </svg>\n                          <p className=\"text-white/70 text-sm font-medium\">Recommended: 800x200px</p>\n                        </div>\n                      )}\n                    </div>\n                    <input\n                      type=\"file\"\n                      ref={profileBannerRef}\n                      onChange={(e) => handleFileChange('profileBanner', e.target.files[0], 'profileBannerPreview')}\n                      accept=\"image/*\"\n                      className=\"hidden\"\n                    />\n                    <div className=\"flex gap-3\">\n                      <button\n                        type=\"button\"\n                        onClick={() => profileBannerRef.current?.click()}\n                        className=\"btn-base btn-secondary px-2 py-1 text-sm\"\n                      >\n                        {formData.profileBannerPreview ? 'Change Banner Photo' : 'Choose Banner Photo'}\n                      </button>\n                      {formData.profileBannerPreview && (\n                        <button\n                          type=\"button\"\n                          onClick={() => handleRemoveImage('profileBanner', 'profileBannerPreview')}\n                          className=\"btn-base btn-danger px-2 py-1 text-sm\"\n                        >\n                          Remove Banner\n                        </button>\n                      )}\n                    </div>\n                    {errors.profileBanner && (\n                      <p className=\"text-red-600 text-sm mt-1\">{errors.profileBanner}</p>\n                    )}\n                  </div>\n                </div>\n\n                {/* Profile Picture */}\n                <div className=\"md:col-span-1\">\n                  <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                    Profile Picture\n                  </label>\n                  <div className=\"flex items-center space-x-4\">\n                    <div className=\"w-20 h-20 rounded-full overflow-hidden border-2 border-gray-200\">\n                      {formData.profilePicPreview ? (\n                        <img\n                          src={formData.profilePicPreview}\n                          alt=\"Profile preview\"\n                          className=\"w-full h-full object-cover\"\n                        />\n                      ) : (\n                        <div className=\"w-full h-full bg-gray-100 flex items-center justify-center\">\n                          <svg className=\"w-8 h-8 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\" />\n                          </svg>\n                        </div>\n                      )}\n                    </div>\n                    <div className=\"flex-1\">\n                      <input\n                        type=\"file\"\n                        ref={profilePicRef}\n                        onChange={(e) => handleFileChange('profilePic', e.target.files[0], 'profilePicPreview')}\n                        accept=\"image/*\"\n                        className=\"hidden\"\n                      />\n                      <div className=\"flex gap-2 flex-col\">\n                        <button\n                          type=\"button\"\n                          onClick={() => profilePicRef.current?.click()}\n                          className=\"btn-base btn-secondary px-2 py-1 text-sm\"\n                        >\n                          {formData.profilePicPreview ? 'Change Photo' : 'Choose Photo'}\n                        </button>\n                        {formData.profilePicPreview && (\n                          <button\n                            type=\"button\"\n                            onClick={() => handleRemoveImage('profilePic', 'profilePicPreview')}\n                            className=\"btn-base btn-danger px-2 py-1 text-sm\"\n                          >\n                            Remove Photo\n                          </button>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                  {errors.profilePic && (\n                    <p className=\"text-red-600 text-sm mt-1\">{errors.profilePic}</p>\n                  )}\n                </div>\n\n                {/* Display Name */}\n                <div className=\"md:col-span-1\">\n                  <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                    Display Name *\n                  </label>\n                  <input\n                    ref={displayNameRef}\n                    type=\"text\"\n                    value={formData.displayName}\n                    onChange={(e) => handleInputChange('displayName', e.target.value)}\n                    className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all text-gray-900 placeholder:text-gray-400 ${\n                      errors.displayName ? 'border-red-300 bg-red-50' : 'border-gray-300'\n                    }`}\n                    placeholder=\"Enter your name\"\n                  />\n                  <p className=\"text-sm text-gray-700 mt-1\">\n                    This appears as your profile name\n                  </p>\n                  {errors.displayName && <p className=\"text-red-600 text-sm mt-1\">{errors.displayName}</p>}\n                </div>\n\n                {/* Username */}\n                <div className=\"md:col-span-1\">\n                  <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                    Username *\n                  </label>\n                  <div className=\"relative\">\n                    <input\n                      ref={usernameRef}\n                      type=\"text\"\n                      value={formData.username}\n                      onChange={(e) => handleInputChange('username', e.target.value.toLowerCase().replace(/[^a-z0-9]/g, ''))}\n                      className={`w-full px-4 py-3 pr-12 border rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all text-gray-900 placeholder:text-gray-400 ${\n                        errors.username ? 'border-red-300 bg-red-50' : \n                        usernameStatus === 'taken' ? 'border-red-300 bg-red-50' :\n                        usernameStatus === 'available' ? 'border-emerald-300 bg-emerald-50' :\n                        'border-gray-300'\n                      }`}\n                      placeholder=\"username\"\n                    />\n                    {/* Username status indicator */}\n                    <div className=\"absolute right-3 top-1/2 transform -translate-y-1/2\">\n                      {usernameStatus === 'checking' && (\n                        <div className=\"w-5 h-5 border-2 border-gray-300 border-t-emerald-500 rounded-full animate-spin\"></div>\n                      )}\n                      {(usernameStatus === 'available' || usernameStatus === 'unchanged') && (\n                        <svg className=\"w-5 h-5 text-emerald-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                        </svg>\n                      )}\n                      {usernameStatus === 'taken' && (\n                        <svg className=\"w-5 h-5 text-red-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                        </svg>\n                      )}\n                    </div>\n                  </div>\n                  <p className=\"text-sm text-gray-700 mt-1\">\n                    Your profile URL: frame.com/u/{formData.username || 'username'}\n                  </p>\n                  {/* Username status message */}\n                  {usernameStatus === 'taken' && (\n                    <p className=\"text-red-600 text-sm mt-1\">This username is already taken</p>\n                  )}\n                  {usernameStatus === 'available' && formData.username.length >= 3 && (\n                    <p className=\"text-emerald-600 text-sm mt-1\">Username is available</p>\n                  )}\n                  {usernameStatus === 'unchanged' && (\n                    <p className=\"text-gray-600 text-sm mt-1\">Current username</p>\n                  )}\n                  {errors.username && <p className=\"text-red-600 text-sm mt-1\">{errors.username}</p>}\n                </div>\n\n                {/* Country */}\n                <div className=\"md:col-span-1\">\n                  <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                    Country *\n                  </label>\n                  <select\n                    ref={countryRef}\n                    value={formData.country}\n                    onChange={(e) => handleInputChange('country', e.target.value)}\n                    className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all text-gray-900 cursor-pointer ${\n                      errors.country ? 'border-red-300 bg-red-50' : 'border-gray-300'\n                    }`}\n                  >\n                    <option value=\"\">Select your country</option>\n                    {countries.map(country => (\n                      <option key={country.code} value={country.code}>\n                        {country.name}\n                      </option>\n                    ))}\n                  </select>\n                  {errors.country && <p className=\"text-red-600 text-sm mt-1\">{errors.country}</p>}\n                </div>\n\n                {/* Bio */}\n                <div className=\"md:col-span-2\">\n                  <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                    Bio\n                  </label>\n                  <textarea\n                    value={formData.bio}\n                    onChange={(e) => handleInputChange('bio', e.target.value)}\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all resize-none text-gray-900 placeholder:text-gray-400\"\n                    rows=\"4\"\n                    placeholder=\"Tell others about yourself...\"\n                    maxLength=\"500\"\n                  />\n                  <div className=\"flex justify-end mt-1\">\n                    <span className=\"text-sm text-gray-400\">{formData.bio.length}/500</span>\n                  </div>\n                </div>\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex justify-between mt-8 pt-6 border-t border-gray-200\">\n                <button\n                  type=\"button\"\n                  onClick={() => {\n                    if (hasChanges) {\n                      setLeaveConfirmModal({\n                        isOpen: true,\n                        actionType: 'cancel',\n                        action: () => {\n                          setHasChanges(false);\n                          router.push('/profile');\n                        }\n                      });\n                    } else {\n                      router.push('/profile');\n                    }\n                  }}\n                  className=\"text-gray-600 px-6 py-3 rounded-lg hover:bg-gray-100 transition-colors font-medium cursor-pointer\"\n                >\n                  Cancel\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={handleSave}\n                  disabled={loading || usernameStatus === 'checking' || !hasChanges}\n                  className={`btn-base px-8 py-3 ${\n                    !hasChanges \n                      ? 'bg-gray-300 text-gray-500 cursor-not-allowed' \n                      : loading || usernameStatus === 'checking'\n                        ? 'bg-emerald-600 text-white opacity-50 cursor-not-allowed'\n                        : 'btn-primary'\n                  }`}\n                >\n                  {loading ? 'Saving...' : usernameStatus === 'checking' ? 'Checking username...' : 'Save Changes'}\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      {/* Confirmation Modal */}\n      <ConfirmationModal\n        isOpen={confirmModal.isOpen}\n        onClose={() => setConfirmModal({ isOpen: false, field: null, previewField: null, imageType: '' })}\n        onConfirm={confirmRemoveImage}\n        title=\"Remove Image\"\n        message={`Are you sure you want to remove your ${confirmModal.imageType}?`}\n        confirmText=\"Remove\"\n        cancelText=\"Cancel\"\n        type=\"danger\"\n      />\n\n      {/* Leave Confirmation Modal */}\n      <ConfirmationModal\n        isOpen={leaveConfirmModal.isOpen}\n        onClose={handleLeaveCancel}\n        onConfirm={handleLeaveConfirm}\n        title=\"Unsaved Changes\"\n        message=\"You have unsaved changes. Do you want to save them before leaving?\"\n        confirmText=\"Leave Without Saving\"\n        cancelText=\"Stay & Keep Changes\"\n        type=\"warning\"\n      />\n    </div>\n  );\n}","path":null,"size_bytes":31612,"size_tokens":null},"src/components/MobileMenu.js":{"content":"\"use client\";\n\nimport { useOptionalAuth } from \"../hooks/useAuth\";\nimport { useOptionalUserProfile } from \"./UserProfileProvider\";\nimport { useRouter } from \"next/navigation\";\nimport { useState } from \"react\";\nimport { useBodyScrollLock } from \"../hooks/useBodyScrollLock\";\nimport CreateCampaignModal from \"./CreateCampaignModal\";\n\nexport default function MobileMenu({ \n  isMenuOpen, \n  setIsMenuOpen\n}) {\n  const authContext = useOptionalAuth();\n  const profileContext = useOptionalUserProfile();\n  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);\n\n  // Lock body scroll when mobile menu is open\n  useBodyScrollLock(isMenuOpen);\n  \n  const { user, loading, mounted, logout } = authContext || {\n    user: null,\n    loading: false,\n    mounted: true,\n    logout: async () => ({ success: false })\n  };\n\n  const { userProfile, loading: profileLoading } = profileContext || {\n    userProfile: null,\n    loading: false\n  };\n  const router = useRouter();\n\n  const handleCreateClick = (e) => {\n    e.preventDefault();\n    setIsCreateModalOpen(true);\n  };\n\n  const handleModalClose = (navigated) => {\n    setIsCreateModalOpen(false);\n    if (navigated) {\n      setIsMenuOpen(false);\n    }\n  };\n\n  return (\n    <>\n      {isMenuOpen && (\n        <div \n          className=\"fixed inset-0 z-30\"\n          onClick={() => setIsMenuOpen(false)}\n        />\n      )}\n\n      <div className={`fixed top-0 right-0 h-full w-80 max-w-[90vw] bg-white shadow-2xl transform transition-transform duration-300 ease-in-out z-40 flex flex-col ${\n        isMenuOpen ? 'translate-x-0' : 'translate-x-full'\n      }`}>\n        <div className=\"flex-shrink-0 flex justify-end p-4\">\n          <button\n            onClick={() => setIsMenuOpen(false)}\n            className=\"btn-base btn-secondary p-2 rounded-full\"\n          >\n            <svg \n              className=\"w-6 h-6 text-gray-600\" \n              fill=\"none\" \n              stroke=\"currentColor\" \n              viewBox=\"0 0 24 24\"\n            >\n              <path \n                strokeLinecap=\"round\" \n                strokeLinejoin=\"round\" \n                strokeWidth={2} \n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n          </button>\n        </div>\n        \n        <div className=\"flex-1 overflow-y-auto min-h-0\">\n          <div className=\"px-6 pb-6\">\n            {(!mounted || loading || profileLoading) ? (\n              <div className=\"mb-6 pb-4 border-b border-gray-100\">\n                <div className=\"h-7 bg-gray-200 rounded animate-pulse w-48\"></div>\n              </div>\n            ) : user ? (\n              <div className=\"mb-6 pb-4 border-b border-gray-100\">\n                <div className=\"text-lg font-medium text-gray-800\">\n                  Welcome {userProfile?.displayName || userProfile?.username || user.displayName || user.email}\n                </div>\n              </div>\n            ) : null}\n            <nav className=\"space-y-1\">\n              {(!mounted || loading) ? (\n                <div className=\"py-2 px-4\">\n                  <div className=\"inline-flex items-center gap-3 py-2 px-3 text-base font-normal rounded-lg\">\n                    <div className=\"w-5 h-5 bg-gray-200 rounded animate-pulse\"></div>\n                    <div className=\"h-5 bg-gray-200 rounded animate-pulse w-16\"></div>\n                  </div>\n                </div>\n              ) : user ? (\n                <>\n                  <div className=\"py-2 px-4\">\n                    <a \n                      href=\"/profile\"\n                      className=\"flex items-center gap-3 py-2 px-3 text-base font-normal text-gray-800 hover:bg-emerald-50 hover:text-emerald-700 rounded-lg transition-colors duration-200\"\n                    >\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\" />\n                      </svg>\n                      Profile\n                    </a>\n                  </div>\n                </>\n              ) : null}\n              \n              <div className=\"py-2 px-4\">\n                <a \n                  href=\"#\"\n                  onClick={handleCreateClick}\n                  className=\"flex items-center gap-3 py-2 px-3 text-base font-normal text-gray-800 hover:bg-emerald-50 hover:text-emerald-700 rounded-lg transition-colors duration-200\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4\" />\n                  </svg>\n                  Create Campaign\n                </a>\n              </div>\n              \n              <div className=\"py-2 px-4\">\n                <a \n                  href=\"/campaigns\" \n                  className=\"flex items-center gap-3 py-2 px-3 text-base font-normal text-gray-800 hover:bg-emerald-50 hover:text-emerald-700 rounded-lg transition-colors duration-200\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n                  </svg>\n                  Campaigns\n                </a>\n              </div>\n              \n              <div className=\"py-2 px-4\">\n                <a \n                  href=\"/creators\" \n                  className=\"flex items-center gap-3 py-2 px-3 text-base font-normal text-gray-800 hover:bg-emerald-50 hover:text-emerald-700 rounded-lg transition-colors duration-200\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z\" />\n                  </svg>\n                  Top Creators\n                </a>\n              </div>\n              \n              <div className=\"py-2 px-4\">\n                <a \n                  href=\"#\" \n                  className=\"flex items-center gap-3 py-2 px-3 text-base font-normal text-gray-800 hover:bg-emerald-50 hover:text-emerald-700 rounded-lg transition-colors duration-200\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L12 12m6.364 6.364L12 12m0 0L5.636 5.636M12 12l6.364 6.364M12 12L5.636 5.636\" />\n                  </svg>\n                  Remove Ads\n                </a>\n              </div>\n              \n              <div className=\"py-2 px-4\">\n                <a \n                  href=\"#\" \n                  className=\"flex items-center gap-3 py-2 px-3 text-base font-normal text-gray-800 hover:bg-emerald-50 hover:text-emerald-700 rounded-lg transition-colors duration-200\"\n                >\n                  <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                  </svg>\n                  Help Center\n                </a>\n              </div>\n            </nav>\n            \n            <div className=\"mt-8 mb-4\">\n              <div className=\"flex gap-3\">\n                {!mounted || loading ? (\n                  <div className=\"flex gap-3 w-full\">\n                    <div className=\"flex-1 py-2 px-4 text-sm text-center text-gray-400 border border-gray-300 rounded-full\">\n                      Sign In\n                    </div>\n                    <div className=\"flex-1 py-2 px-4 text-sm text-center text-white bg-gray-400 rounded-full\">\n                      Sign Up\n                    </div>\n                  </div>\n                ) : user ? (\n                  <>\n                    <button \n                      onClick={logout}\n                      className=\"w-full btn-base btn-secondary py-3 px-4 text-sm font-medium\"\n                    >\n                      Sign Out\n                    </button>\n                  </>\n                ) : (\n                  <>\n                    <button \n                      onClick={() => {\n                        router.push('/signin');\n                        setIsMenuOpen(false);\n                      }}\n                      className=\"flex-1 btn-base btn-secondary py-3 px-4 text-sm font-medium\"\n                    >\n                      Sign In\n                    </button>\n                    <button \n                      onClick={() => {\n                        router.push('/signup');\n                        setIsMenuOpen(false);\n                      }}\n                      className=\"flex-1 btn-base btn-primary py-3 px-4 text-sm font-medium\"\n                    >\n                      Sign Up\n                    </button>\n                  </>\n                )}\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <CreateCampaignModal \n        isOpen={isCreateModalOpen} \n        onClose={handleModalClose} \n      />\n    </>\n  );\n}\n","path":null,"size_bytes":9971,"size_tokens":null},"src/app/api/admin/campaigns/[campaignId]/delete/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\nimport { supabaseAdmin } from '@/lib/supabase-admin';\n\nexport async function DELETE(request, { params }) {\n  try {\n    const adminUser = await requireAdmin(request);\n    \n    const { campaignId } = params;\n    const body = await request.json();\n    const { confirmed, deleteReason } = body;\n    \n    if (!confirmed) {\n      return NextResponse.json(\n        { success: false, error: 'Deletion must be confirmed' },\n        { status: 400 }\n      );\n    }\n    \n    if (!campaignId) {\n      return NextResponse.json(\n        { success: false, error: 'Campaign ID is required' },\n        { status: 400 }\n      );\n    }\n    \n    const db = adminFirestore();\n    const campaignRef = db.collection('campaigns').doc(campaignId);\n    const campaignDoc = await campaignRef.get();\n    \n    if (!campaignDoc.exists) {\n      return NextResponse.json(\n        { success: false, error: 'Campaign not found' },\n        { status: 404 }\n      );\n    }\n    \n    const campaignData = campaignDoc.data();\n    \n    try {\n      if (campaignData.imageUrl) {\n        const imagePath = campaignData.imageUrl;\n        \n        const { error: storageError } = await supabaseAdmin.storage\n          .from('uploads')\n          .remove([imagePath]);\n        \n        if (storageError) {\n          console.error('Supabase storage deletion error:', storageError);\n        }\n      }\n    } catch (storageError) {\n      console.error('Error deleting campaign image from storage:', storageError);\n    }\n    \n    await campaignRef.delete();\n    \n    const deletionLog = {\n      campaignId: campaignId,\n      campaignTitle: campaignData.title,\n      campaignSlug: campaignData.slug,\n      creatorId: campaignData.creatorId,\n      deletedBy: adminUser.uid,\n      deletedAt: new Date().toISOString(),\n      deleteReason: deleteReason || 'No reason provided',\n      moderationStatus: campaignData.moderationStatus,\n      reportsCount: campaignData.reportsCount || 0,\n    };\n    \n    if (process.env.NODE_ENV === 'development') {\n      console.log('Campaign deleted by admin:', deletionLog);\n    }\n    \n    return NextResponse.json({\n      success: true,\n      message: 'Campaign permanently deleted',\n      data: deletionLog,\n    });\n  } catch (error) {\n    console.error('Error deleting campaign:', error);\n    \n    if (error.message.includes('Unauthorized') || error.message.includes('Admin access required')) {\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 403 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to delete campaign' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":2778,"size_tokens":null},"src/components/admin/UsersTable.js":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { getRoleBadgeColor, formatTimestamp } from \"@/utils/admin/adminHelpers\";\n\nexport default function UsersTable({ users, loading, onSelectUser, searchTerm, onSearchChange }) {\n  const [selectedUserId, setSelectedUserId] = useState(null);\n\n  const handleRowClick = (user) => {\n    setSelectedUserId(user.id);\n    onSelectUser(user);\n  };\n\n  if (loading) {\n    return (\n      <div className=\"bg-white rounded-lg shadow\">\n        <div className=\"p-8 text-center\">\n          <div className=\"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600\"></div>\n          <p className=\"mt-2 text-gray-600\">Loading users...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (users.length === 0) {\n    return (\n      <div className=\"bg-white rounded-lg shadow\">\n        <div className=\"p-8 text-center\">\n          <svg className=\"mx-auto h-12 w-12 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n          </svg>\n          <h3 className=\"mt-2 text-sm font-medium text-gray-900\">No users found</h3>\n          <p className=\"mt-1 text-sm text-gray-500\">\n            {searchTerm ? 'No users match your search criteria.' : 'No users in the system.'}\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow overflow-hidden\">\n      <div className=\"overflow-x-auto\">\n        <table className=\"min-w-full divide-y divide-gray-200\">\n          <thead className=\"bg-gray-50\">\n            <tr>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                User\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Email\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Role\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Campaigns\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Supports\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Joined\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Actions\n              </th>\n            </tr>\n          </thead>\n          <tbody className=\"bg-white divide-y divide-gray-200\">\n            {users.map((user) => (\n              <tr\n                key={user.id}\n                onClick={() => handleRowClick(user)}\n                className={`cursor-pointer transition-colors ${\n                  selectedUserId === user.id ? 'bg-emerald-50' : 'hover:bg-gray-50'\n                } ${user.accountStatus?.includes('banned') ? 'opacity-60' : ''}`}\n              >\n                <td className=\"px-6 py-4 whitespace-nowrap\">\n                  <div className=\"flex items-center\">\n                    <div className=\"h-10 w-10 flex-shrink-0\">\n                      {user.profileImage ? (\n                        <img\n                          className=\"h-10 w-10 rounded-full object-cover\"\n                          src={user.profileImage}\n                          alt={user.displayName || 'User'}\n                          loading=\"lazy\"\n                        />\n                      ) : (\n                        <div className=\"h-10 w-10 rounded-full bg-emerald-100 flex items-center justify-center\">\n                          <span className=\"text-emerald-700 font-medium text-sm\">\n                            {(user.displayName || user.email || '?')[0].toUpperCase()}\n                          </span>\n                        </div>\n                      )}\n                    </div>\n                    <div className=\"ml-4\">\n                      <div className=\"text-sm font-medium text-gray-900 flex items-center gap-2\">\n                        {user.displayName || 'Unnamed User'}\n                        {user.accountStatus?.includes('banned') && (\n                          <span className=\"inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800\">\n                            Banned\n                          </span>\n                        )}\n                      </div>\n                      <div className=\"text-sm text-gray-500\">\n                        @{user.username || 'no-username'}\n                      </div>\n                    </div>\n                  </div>\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap\">\n                  <div className=\"text-sm text-gray-900\">{user.email || '-'}</div>\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap\">\n                  <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getRoleBadgeColor(user.role)}`}>\n                    {user.role || 'user'}\n                  </span>\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\n                  {user.campaignsCount || 0}\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\n                  {user.totalSupports || 0}\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\n                  {formatTimestamp(user.createdAt)}\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium\">\n                  <button\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      handleRowClick(user);\n                    }}\n                    className=\"text-emerald-600 hover:text-emerald-900\"\n                  >\n                    View Details\n                  </button>\n                </td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6393,"size_tokens":null},"TASKS.md":{"content":"# Twibbonize - Pending Tasks & Development Roadmap\n\n**Last Updated:** December 12, 2025 (Homepage Featured Sections Update)  \n**Platform:** Next.js 15 + Firebase + Supabase + ImageKit.io  \n**Deployment:** Vercel (all testing/deployment happens there, Replit for code editing only)\n\n---\n\n##  Overview\n\nThis document tracks **unimplemented features only**. All completed features are documented in:\n- `replit.md` - Project overview and architecture\n- `CAMPAIGN_SYSTEM.md` - Campaign system documentation\n- `REPORT_SYSTEM.md` - Reporting and moderation system\n- `CODEBASE_STRUCTURE.md` - Complete codebase structure\n\n**Current Status:**\n-  Core campaign system (creation, usage, gallery)\n-  Admin moderation dashboard (reports, campaigns, users, analytics, appeals, logs)\n-  In-app notification system with Firestore (mandatory for all users)\n-  Notification inbox at `/profile/notifications` (read/unread, filter, delete)\n-  Email notifications for bans/unbans (MailerSend)\n-  Appeal system (user submission + admin review)\n-  Automated cron jobs (appeal cleanup, reminders)\n-  Homepage featured sections (Top Campaigns + Top Creators)\n-  Settings architecture (deferred - will be needed for account, privacy, preferences)\n-  Advanced analytics (deferred to future)\n\n---\n\n\n##  Phase 1: Settings Hub Architecture (DEFERRED)\n\n**Status:**  **DEFERRED (Future Enhancement)**  \n**Goal:** Create unified settings hub for account, privacy, and preferences management  \n**Estimated Time:** 1-2 weeks\n\n### Overview\n\n**Why Settings Hub is Needed:**\n- Future account management features (password change, email management, 2FA)\n- Privacy controls (profile visibility, data export, GDPR compliance)\n- User preferences (language, theme, accessibility)\n\n**Why Notification Preferences Are NOT Needed:**\n-  All notifications are moderation-related (warnings, removals, bans, appeals)\n-  Users must receive all notifications to stay informed of critical actions\n-  Notification inbox at `/profile/notifications` already provides full management (read/unread, filter, delete)\n- Optional notification preferences would create confusion and risk users missing important updates\n\n---\n\n### Planned Settings Pages (Future)\n\n#### `/settings` - Main Settings Hub (with Sidebar Layout)\n\n**Purpose:** Central hub for all user settings\n\n**Sidebar Items:**\n1.  **Account & Security** - Password, email, 2FA, sessions\n2.  **Privacy & Data** - Profile visibility, data export, privacy preferences\n3.  **Preferences** - Language, theme, accessibility\n4. ~~ **Notifications**~~ - **NOT NEEDED** (notifications are mandatory)\n\n**Default Behavior:** Opening `/settings` redirects to `/settings/account`\n\n---\n\n### Future Phase: Account & Security Settings\n\n**Page:** `/settings/account`\n\n**Features:**\n- Password change functionality\n- Email address management\n- Session management (view active sessions, logout all)\n- Two-factor authentication setup\n- Account deletion option\n- Account activity log\n\n---\n\n### Future Phase: Privacy & Data Settings\n\n**Page:** `/settings/privacy`\n\n**Features:**\n- Profile visibility controls (public/private)\n- Data export (GDPR compliance)\n- Download all user data\n- Privacy preferences\n- Block/mute users functionality\n- Search engine indexing preferences\n\n---\n\n### Future Phase: General Preferences\n\n**Page:** `/settings/preferences`\n\n**Features:**\n- Language selection (i18n)\n- Theme selection (light/dark mode)\n- Accessibility settings\n- Dashboard layout preferences\n- Time zone settings\n\n---\n\n**Note:** `/profile/edit` remains separate - it's dedicated to profile information only (avatar, banner, bio, username). Settings hub is for account/privacy/preferences.\n\n---\n\n##  Phase 2: Advanced Analytics & Insights (DEFERRED)\n\n**Status:**  **DEFERRED (Post-Launch)**  \n**Priority:** Low (Nice-to-have features)\n\n**Note:** Basic platform analytics dashboard is **FULLY IMPLEMENTED** at `/admin` with:\n- Campaign counts (total, active, removed, by type)\n- User counts (total, admins, banned)\n- Report statistics (total, pending, resolved, resolution rate)\n- Engagement metrics (total supports, average per campaign)\n- Top reported campaigns\n\nThe following are **advanced features** deferred to post-launch:\n\n### 2.1 Advanced Campaign Analytics\n\n-  **Real-time supporter count** - Live supporter tracking with WebSockets\n-  **Geographic distribution** - Map showing where supporters are from\n-  **Share count by platform** - Track Facebook, Twitter, WhatsApp shares separately\n-  **Peak usage times** - Identify when campaigns are most popular\n-  **Trend analysis** - Growth charts, momentum tracking\n\n### 2.2 Advanced User Analytics\n\n-  **Total reach metrics** - Supporters across all campaigns\n-  **Creator rankings** - Most popular creators leaderboard\n-  **Campaign performance comparison** - Compare multiple campaigns side-by-side\n-  **Creator dashboard** - Detailed analytics for campaign creators\n\n### 2.3 Advanced Platform Analytics\n\n-  **Time-series data** - Daily/Weekly/Monthly active users over time\n-  **Top creators leaderboard** - Advanced sorting and filtering\n-  **Most shared campaigns** - Social media share tracking\n-  **Moderation metrics over time** - Reports resolved trends, ban trends\n-  **Revenue analytics** - For future monetization features\n\n**Implementation Note:** These features require additional infrastructure:\n- Real-time database (Firebase Realtime Database or WebSockets)\n- Analytics pipeline (BigQuery or similar)\n- Data warehouse for time-series storage\n- Social media API integrations for share tracking\n\n---\n\n##  Phase 3: Future Feature Enhancements (DEFERRED)\n\n**Status:**  **DEFERRED (Post-Launch)**  \n**Priority:** Low (Future roadmap items)\n\n### 3.1 Platform Features\n\n**Multi-language Support (i18n):**\n-  Translation system for UI strings\n-  Language selector in user preferences\n-  Support for RTL languages (Arabic, Hebrew)\n-  Localized date/time formats\n\n**Campaign Templates Marketplace:**\n-  Pre-made campaign templates\n-  Template categories (holidays, events, causes)\n-  Featured templates section\n-  Template rating system\n\n**Collaboration Features:**\n-  Co-creator functionality (multiple users manage one campaign)\n-  Team accounts for organizations\n-  Permission levels (owner, editor, viewer)\n-  Activity log for team actions\n\n**Campaign Expiry Dates:**\n-  Time-limited campaigns (auto-archive after date)\n-  Countdown timers on campaign pages\n-  Scheduled campaign publishing\n-  Auto-renewal option\n\n**Watermark Removal:**\n-  Premium feature to remove Twibbonize watermark\n-  Custom branding for premium users\n-  White-label campaigns\n\n### 3.2 Monetization Features\n\n**Premium Creator Accounts:**\n-  Increased storage limits\n-  Priority support\n-  Advanced analytics access\n-  Custom profile URLs\n-  Verified badge\n\n**Sponsored Campaigns:**\n-  Brands can feature campaigns\n-  Promoted placement in gallery\n-  Sponsored badge\n-  Analytics for sponsors\n\n**Campaign Promotion Tools:**\n-  Boost visibility for a fee\n-  Homepage featured slots\n-  Newsletter inclusion\n-  Social media promotion\n\n### 3.3 Automation & Email Features\n\n**Moderation Automation:**\n-  AI-based image moderation (detect inappropriate content)\n-  Auto-flag campaigns based on ML model\n-  Human-in-the-loop review workflow\n-  Confidence scores for admin decisions\n\n**Email Notifications Expansion:**\n-  Weekly campaign performance digest (for creators)\n-  Moderation action updates via email (currently in-app only)\n-  Marketing emails (product updates, announcements)\n-  Email preferences management\n\n**Note:** Auto-deletion cron jobs and email notifications for bans/appeals are **already implemented**.\n\n### 3.4 User Experience Enhancements\n\n**Gallery Improvements:**\n-  Infinite scroll pagination\n-  Advanced search (keywords, tags)\n-  Saved/favorite campaigns\n-  Campaign collections/playlists\n\n**Mobile App:**\n-  Native iOS app\n-  Native Android app\n-  React Native for cross-platform\n\n**Social Features:**\n-  Follow creators\n-  Activity feed\n-  Campaign comments\n-  User profiles with social links\n\n---\n\n##  Implementation Notes\n\n### Current Deployment\n- **Platform:** Vercel (production)\n- **Environment:** Replit (code editing only, NOT for testing)\n- **Testing:** All testing happens on Vercel deployments\n\n### Technology Stack\n- **Frontend:** Next.js 15.5.7 (App Router) + React 19.1.0\n- **Styling:** Tailwind CSS 4\n- **Authentication:** Firebase Auth\n- **Database:** Firestore\n- **Storage:** Supabase\n- **CDN:** ImageKit.io\n- **Email:** MailerSend\n\n### Key Principles\n- **Visitor-first:** Browsing campaigns requires no authentication\n- **Delayed authentication:** Only require login at publish time\n- **Public analytics:** All campaign stats are transparent\n- **Mobile-first design:** Responsive on all devices\n\n---\n\n##  Related Documentation\n\n- **replit.md** - Project overview, architecture, user preferences\n- **CAMPAIGN_SYSTEM.md** - Complete campaign system documentation\n- **REPORT_SYSTEM.md** - Reporting and moderation system details\n- **CODEBASE_STRUCTURE.md** - Complete codebase file structure\n- **CODE_INCONSISTENCIES.md** - Known issues and fixes needed\n\n---\n\n**End of TASKS.md**\n","path":null,"size_bytes":9627,"size_tokens":null},"src/utils/transparencyDetector.js":{"content":"/**\n * Transparency Detection Utility for Frame Validation\n * \n * Uses Canvas API to analyze images for transparency.\n * Frames must have at least 5% transparent pixels to be valid.\n * \n * Based on algorithm from CAMPAIGN_SYSTEM.md\n */\n\n/**\n * Check if an image file has sufficient transparency for a frame\n * \n * @param {File} imageFile - Image file to analyze\n * @param {number} minTransparencyPercent - Minimum transparency required (default: 5%)\n * @returns {Promise<{hasTransparency: boolean, transparencyPercent: number, error?: string}>}\n * \n * @example\n * const result = await checkTransparency(file);\n * if (result.hasTransparency) {\n *   console.log(`Valid frame with ${result.transparencyPercent.toFixed(2)}% transparency`);\n * } else {\n *   console.error(result.error);\n * }\n */\nexport async function checkTransparency(imageFile, minTransparencyPercent = 5) {\n  if (!imageFile) {\n    return {\n      hasTransparency: false,\n      transparencyPercent: 0,\n      error: 'No image file provided'\n    };\n  }\n\n  // Check if file is an image\n  if (!imageFile.type.startsWith('image/')) {\n    return {\n      hasTransparency: false,\n      transparencyPercent: 0,\n      error: 'File is not an image'\n    };\n  }\n\n  // PNG is required for transparency (check file type)\n  if (!imageFile.type.includes('png')) {\n    return {\n      hasTransparency: false,\n      transparencyPercent: 0,\n      error: 'Frame must be a PNG image with transparency. Please use PNG format.'\n    };\n  }\n\n  try {\n    const result = await analyzeImageTransparency(imageFile);\n    \n    if (result.error) {\n      return {\n        hasTransparency: false,\n        transparencyPercent: 0,\n        error: result.error\n      };\n    }\n\n    const hasTransparency = result.transparencyPercent >= minTransparencyPercent;\n\n    if (!hasTransparency) {\n      return {\n        hasTransparency: false,\n        transparencyPercent: result.transparencyPercent,\n        error: `Frame must have at least ${minTransparencyPercent}% transparent area for photos. Current: ${result.transparencyPercent.toFixed(2)}%`\n      };\n    }\n\n    return {\n      hasTransparency: true,\n      transparencyPercent: result.transparencyPercent\n    };\n  } catch (error) {\n    return {\n      hasTransparency: false,\n      transparencyPercent: 0,\n      error: `Failed to analyze image: ${error.message}`\n    };\n  }\n}\n\n/**\n * Analyze image transparency using Canvas API\n * \n * @param {File} imageFile - Image file to analyze\n * @returns {Promise<{transparencyPercent: number, error?: string}>}\n */\nasync function analyzeImageTransparency(imageFile) {\n  return new Promise((resolve, reject) => {\n    const canvas = document.createElement('canvas');\n    const ctx = canvas.getContext('2d');\n    const img = new Image();\n\n    img.onload = () => {\n      try {\n        // Set canvas size to image size\n        canvas.width = img.width;\n        canvas.height = img.height;\n\n        // Draw image to canvas\n        ctx.drawImage(img, 0, 0);\n\n        // Get image data (RGBA pixel array)\n        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);\n        const pixels = imageData.data;\n\n        let transparentPixels = 0;\n        const totalPixels = canvas.width * canvas.height;\n\n        // Check alpha channel of each pixel\n        // pixels array format: [r, g, b, a, r, g, b, a, ...]\n        // Alpha channel is every 4th value (index 3, 7, 11, ...)\n        for (let i = 3; i < pixels.length; i += 4) {\n          // Alpha value < 255 means some transparency\n          if (pixels[i] < 255) {\n            transparentPixels++;\n          }\n        }\n\n        const transparencyPercent = (transparentPixels / totalPixels) * 100;\n\n        // Clean up\n        URL.revokeObjectURL(img.src);\n\n        resolve({\n          transparencyPercent,\n          totalPixels,\n          transparentPixels\n        });\n      } catch (error) {\n        reject(new Error(`Canvas analysis failed: ${error.message}`));\n      }\n    };\n\n    img.onerror = () => {\n      URL.revokeObjectURL(img.src);\n      reject(new Error('Failed to load image'));\n    };\n\n    // Create object URL for the image file\n    img.src = URL.createObjectURL(imageFile);\n  });\n}\n\n/**\n * Quick check if file type supports transparency\n * \n * @param {File} imageFile - Image file to check\n * @returns {boolean} True if file type supports transparency\n */\nexport function supportsTransparency(imageFile) {\n  if (!imageFile || !imageFile.type) {\n    return false;\n  }\n  \n  // PNG supports transparency, JPG/JPEG does not\n  return imageFile.type.includes('png');\n}\n\n/**\n * Get transparency info for display purposes\n * \n * @param {File} imageFile - Image file to analyze\n * @returns {Promise<{valid: boolean, message: string, percent?: number}>}\n */\nexport async function getTransparencyInfo(imageFile) {\n  const result = await checkTransparency(imageFile);\n  \n  if (result.hasTransparency) {\n    return {\n      valid: true,\n      message: `Valid frame with ${result.transparencyPercent.toFixed(1)}% transparency`,\n      percent: result.transparencyPercent\n    };\n  } else {\n    return {\n      valid: false,\n      message: result.error || 'Invalid transparency',\n      percent: result.transparencyPercent\n    };\n  }\n}\n","path":null,"size_bytes":5202,"size_tokens":null},"src/lib/firebaseAdmin.js":{"content":"// Firebase Admin SDK for server-side authentication and Firestore operations\nimport 'server-only'\nimport { initializeApp, getApps, cert } from 'firebase-admin/app'\nimport { getAuth } from 'firebase-admin/auth'\nimport { getFirestore } from 'firebase-admin/firestore'\nimport { validateFirebaseServiceKey } from '../utils/validateEnv'\n\n// Check if Firebase Admin is already initialized\nlet adminApp = null\n\nif (getApps().length === 0) {\n  const isProduction = process.env.NODE_ENV === 'production';\n  const isDevelopment = process.env.NODE_ENV === 'development';\n  \n  // Validate required environment variables\n  const projectId = process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID;\n  const serviceAccountKey = process.env.FIREBASE_SERVICE_ACCOUNT_KEY;\n\n  if (!projectId) {\n    const errorMessage = 'Missing NEXT_PUBLIC_FIREBASE_PROJECT_ID environment variable';\n    \n    if (isProduction) {\n      throw new Error(`[PRODUCTION] ${errorMessage}. Please add this variable in Vercel.`);\n    }\n    \n    if (isDevelopment) {\n      console.warn(`[DEV WARNING] ${errorMessage}`);\n      console.warn('[DEV WARNING] Firebase Admin will not be available.');\n    }\n    \n    throw new Error(errorMessage);\n  }\n\n  // Parse and validate service account key\n  let credential = null;\n  \n  if (!serviceAccountKey) {\n    const errorMessage = 'Missing FIREBASE_SERVICE_ACCOUNT_KEY environment variable';\n    \n    if (isProduction) {\n      throw new Error(`[PRODUCTION] ${errorMessage}. Please add this variable in Vercel.`);\n    }\n    \n    if (isDevelopment) {\n      console.warn(`[DEV WARNING] ${errorMessage}`);\n      console.warn('[DEV WARNING] Firebase Admin will run with limited functionality (no auth verification).');\n    }\n  } else {\n    // Validate the service account key format\n    validateFirebaseServiceKey(serviceAccountKey);\n    \n    try {\n      const parsedKey = JSON.parse(serviceAccountKey);\n      credential = cert(parsedKey);\n    } catch (error) {\n      const errorMessage = `Invalid FIREBASE_SERVICE_ACCOUNT_KEY format: ${error.message}`;\n      \n      if (isProduction) {\n        throw new Error(`[PRODUCTION] ${errorMessage}. Please check the JSON format in Vercel.`);\n      }\n      \n      if (isDevelopment) {\n        console.warn(`[DEV WARNING] ${errorMessage}`);\n        console.warn('[DEV WARNING] Firebase Admin will run with limited functionality.');\n      }\n    }\n  }\n\n  try {\n    const config = {\n      projectId,\n    };\n    \n    // Add credential if available\n    if (credential) {\n      config.credential = credential;\n    } else if (isProduction) {\n      // In production, credential is required for full functionality\n      throw new Error('[PRODUCTION] Firebase Admin credentials are required in production. Please add FIREBASE_SERVICE_ACCOUNT_KEY in Vercel.');\n    }\n    \n    adminApp = initializeApp(config);\n    \n    if (isDevelopment) {\n      console.log(`[DEV] Firebase Admin initialized ${credential ? 'with credentials' : 'without credentials (limited functionality)'}`);\n    }\n  } catch (error) {\n    if (isProduction) {\n      // Production: Fail fast\n      throw new Error(`[PRODUCTION] Firebase Admin initialization failed: ${error.message}`);\n    }\n    \n    // Development: Log error and attempt fallback\n    console.error('[DEV ERROR] Firebase Admin initialization error:', error.message);\n    console.warn('[DEV] Attempting fallback initialization without credentials...');\n    \n    try {\n      adminApp = initializeApp({ projectId });\n      console.log('[DEV] Fallback initialization successful (limited functionality - no auth verification)');\n    } catch (fallbackError) {\n      throw new Error(`Firebase Admin initialization completely failed: ${fallbackError.message}`);\n    }\n  }\n} else {\n  adminApp = getApps()[0]\n}\n\n// Get Auth instance\nexport const adminAuth = getAuth(adminApp)\n\n// Get Firestore instance\nexport const adminFirestore = () => getFirestore(adminApp)\n\n// Export adminDb for backward compatibility\nexport const adminDb = getFirestore(adminApp)\n\n// Helper function to verify ID tokens\nexport const verifyIdToken = async (idToken) => {\n  try {\n    const decodedToken = await adminAuth.verifyIdToken(idToken)\n    return decodedToken\n  } catch (error) {\n    // Only log in development\n    if (process.env.NODE_ENV === 'development') {\n      console.error('[DEV ERROR] Token verification error:', error.message)\n    }\n    throw new Error('Invalid authentication token')\n  }\n}\n\nexport default adminApp\n","path":null,"size_bytes":4439,"size_tokens":null},"src/components/ConfirmationModal.js":{"content":"\"use client\";\n\nimport { useEffect, useState } from 'react';\nimport { useBodyScrollLock } from '../hooks/useBodyScrollLock';\n\nexport default function ConfirmationModal({ \n  isOpen, \n  onClose, \n  onConfirm, \n  title = \"Confirm Action\", \n  message = \"Are you sure you want to proceed?\",\n  confirmText = \"Confirm\",\n  cancelText = \"Cancel\",\n  type = \"danger\", // \"danger\" or \"warning\"\n  requireTypedConfirmation = false // Require typing \"CONFIRM\" for dangerous actions\n}) {\n  const [confirmationText, setConfirmationText] = useState('');\n  \n  // Lock body scroll when modal is open\n  useBodyScrollLock(isOpen);\n\n  // Reset confirmation text when modal opens/closes\n  useEffect(() => {\n    if (isOpen) {\n      setConfirmationText('');\n    }\n  }, [isOpen]);\n\n  // Close modal on Escape key\n  useEffect(() => {\n    const handleEscape = (e) => {\n      if (e.key === 'Escape' && isOpen) {\n        onClose();\n      }\n    };\n\n    if (isOpen) {\n      document.addEventListener('keydown', handleEscape);\n    }\n\n    return () => {\n      document.removeEventListener('keydown', handleEscape);\n    };\n  }, [isOpen, onClose]);\n\n  if (!isOpen) return null;\n\n  const handleBackdropClick = (e) => {\n    if (e.target === e.currentTarget) {\n      onClose();\n    }\n  };\n\n  const handleConfirm = () => {\n    onConfirm();\n    onClose();\n  };\n\n  const isConfirmDisabled = requireTypedConfirmation && confirmationText !== 'CONFIRM';\n\n  return (\n    <div \n      className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\"\n      onClick={handleBackdropClick}\n    >\n      <div className=\"bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 transform transition-all\">\n        {/* Header */}\n        <div className=\"px-6 py-4 border-b border-gray-200\">\n          <div className=\"flex items-center gap-3\">\n            {type === \"danger\" ? (\n              <div className=\"w-10 h-10 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0\">\n                <svg className=\"w-5 h-5 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z\" />\n                </svg>\n              </div>\n            ) : (\n              <div className=\"w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center flex-shrink-0\">\n                <svg className=\"w-5 h-5 text-yellow-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z\" />\n                </svg>\n              </div>\n            )}\n            <h3 className=\"text-lg font-semibold text-gray-900\">{title}</h3>\n          </div>\n        </div>\n        \n        {/* Body */}\n        <div className=\"px-6 py-4\">\n          <p className=\"text-gray-700 text-sm leading-relaxed\">{message}</p>\n          \n          {requireTypedConfirmation && (\n            <div className=\"mt-4\">\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                Type <span className=\"font-bold text-red-600\">CONFIRM</span> to proceed:\n              </label>\n              <input\n                type=\"text\"\n                value={confirmationText}\n                onChange={(e) => setConfirmationText(e.target.value)}\n                placeholder=\"Type CONFIRM\"\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500 text-sm text-gray-900 bg-white\"\n                autoFocus\n              />\n              <p className=\"mt-2 text-xs text-gray-500\">\n                This action requires confirmation to prevent accidental clicks.\n              </p>\n            </div>\n          )}\n        </div>\n        \n        {/* Footer */}\n        <div className=\"px-6 py-4 bg-gray-50 rounded-b-xl flex gap-3 justify-end\">\n          <button\n            onClick={onClose}\n            className=\"btn-base btn-secondary px-4 py-2 text-sm\"\n          >\n            {cancelText}\n          </button>\n          <button\n            onClick={handleConfirm}\n            disabled={isConfirmDisabled}\n            className={`btn-base px-4 py-2 text-sm ${\n              type === \"danger\" \n                ? \"btn-danger\" \n                : \"btn-warning\"\n            } disabled:opacity-50 disabled:cursor-not-allowed`}\n          >\n            {confirmText}\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":4719,"size_tokens":null},"src/app/(chrome)/create/page.js":{"content":"\"use client\";\n\nimport { useEffect, useState } from 'react';\nimport { useRouter } from 'next/navigation';\nimport CreateCampaignModal from '../../../components/CreateCampaignModal';\n\nexport default function CreatePage() {\n  const router = useRouter();\n  const [isModalOpen, setIsModalOpen] = useState(false);\n\n  useEffect(() => {\n    // Open modal on page load\n    setIsModalOpen(true);\n  }, []);\n\n  const handleClose = (didNavigate) => {\n    setIsModalOpen(false);\n    // Only redirect to home if modal was dismissed (not if user selected an option)\n    if (!didNavigate) {\n      router.push('/');\n    }\n    // If didNavigate is true, the modal already handled navigation to /create/frame or /create/background\n  };\n\n  return (\n    <CreateCampaignModal \n      isOpen={isModalOpen} \n      onClose={handleClose} \n    />\n  );\n}\n","path":null,"size_bytes":824,"size_tokens":null},"src/utils/firebaseErrorHandler.js":{"content":"import { isLikelyNetworkError, getContextualErrorMessage } from './networkUtils';\n\n/**\n * Centralized Firebase Authentication Error Handler\n * Based on latest Firebase v9+ documentation and modern security practices\n */\n\n/**\n * Modern Firebase error codes mapping to simple, user-friendly messages\n * Updated for Firebase v9+ behavior where specific error codes are replaced with generic ones for security\n */\nconst ERROR_MESSAGES = {\n  // Authentication Errors (Core)\n  'auth/invalid-credential': 'Invalid email or password. Please check your credentials and try again.',\n  'auth/user-disabled': 'Your account has been disabled. Please contact support for assistance.',\n  'auth/invalid-email': 'Please enter a valid email address.',\n  'auth/operation-not-allowed': 'This sign-in method is not available. Please contact support.',\n  'auth/too-many-requests': 'Too many failed attempts. Please wait a few minutes before trying again.',\n  \n  // Legacy errors (may still occur in some Firebase configurations)\n  'auth/user-not-found': 'Invalid email or password. Please check your credentials and try again.',\n  'auth/wrong-password': 'Invalid email or password. Please check your credentials and try again.',\n  \n  // Account Creation Errors\n  'auth/email-already-in-use': 'An account with this email already exists. Try signing in instead.',\n  'auth/weak-password': 'Please choose a stronger password (at least 6 characters).',\n  \n  // Session & Token Errors\n  'auth/invalid-user-token': 'Your session has expired. Please sign in again.',\n  'auth/user-token-expired': 'Your session has expired. Please sign in again.',\n  'auth/requires-recent-login': 'For security, please sign in again to continue.',\n  \n  // Network & Connection Errors\n  'auth/network-request-failed': 'Connection failed. Please check your internet and try again.',\n  'auth/timeout': 'Request timed out. Please check your connection and try again.',\n  \n  // Email Verification Errors\n  'auth/invalid-verification-code': 'Invalid verification code. Please check and try again.',\n  'auth/invalid-verification-id': 'Verification failed. Please try again.',\n  'auth/code-expired': 'Verification code has expired. Please request a new one.',\n  'auth/missing-verification-code': 'Please enter the verification code.',\n  \n  // Password Reset Errors\n  'auth/invalid-action-code': 'This reset link is invalid or has expired. Please request a new one.',\n  'auth/expired-action-code': 'This reset link has expired. Please request a new one.',\n  \n  // Google Sign-in Errors\n  'auth/popup-closed-by-user': 'Sign-in was cancelled. Please try again.',\n  'auth/popup-blocked': 'Sign-in popup was blocked. Please allow popups and try again.',\n  'auth/account-exists-with-different-credential': 'An account with this email exists. Try signing in with a different method.',\n  \n  // Configuration & API Errors\n  'auth/invalid-api-key': 'Configuration error. Please contact support.',\n  'auth/app-not-authorized': 'App configuration error. Please contact support.',\n  'auth/invalid-continue-uri': 'Invalid redirect URL. Please contact support.',\n  'auth/unauthorized-continue-uri': 'Unauthorized redirect URL. Please contact support.',\n  \n  // Rate Limiting\n  'auth/quota-exceeded': 'Service temporarily unavailable. Please try again later.',\n  \n  // Multi-factor Authentication\n  'auth/multi-factor-auth-required': 'Additional verification required. Please follow the prompts.',\n  'auth/maximum-second-factor-count-exceeded': 'Too many verification methods. Please contact support.',\n  \n  // Generic fallback\n  'default': 'Something went wrong. Please try again.'\n};\n\n/**\n * Security vs Verbose mode messages\n * In security mode, we provide generic messages to prevent user enumeration attacks\n */\nconst SECURITY_MODE_MESSAGES = {\n  // Generic authentication failure (prevents user enumeration)\n  'auth-failure': 'Invalid email or password. Please check your credentials and try again.',\n  'password-reset-sent': 'If this email is associated with an account, we\\'ve sent a password reset link.',\n  'verification-sent': 'If this email is associated with an account, we\\'ve sent a verification email.',\n};\n\n/**\n * Check if verbose error messages are enabled\n * Always returns false to use security mode for better maintainability\n */\nconst isVerboseModeEnabled = () => {\n  // Always use security mode for better maintainability and consistent behavior\n  return false;\n};\n\n/**\n * Get appropriate error message based on error code and context\n * @param {string} errorCode - Firebase error code\n * @param {string} context - Context of the error (signin, signup, password-reset, etc.)\n * @param {boolean} useVerboseMode - Whether to use verbose or security mode\n * @returns {string} User-friendly error message\n */\nconst getErrorMessage = (errorCode, context = 'default', useVerboseMode = null) => {\n  const verboseMode = useVerboseMode !== null ? useVerboseMode : isVerboseModeEnabled();\n  \n  // Handle security mode for sensitive operations\n  if (!verboseMode) {\n    switch (context) {\n      case 'signin':\n        // In security mode, always return generic message for auth failures\n        if (['auth/invalid-credential', 'auth/user-not-found', 'auth/wrong-password'].includes(errorCode)) {\n          return SECURITY_MODE_MESSAGES['auth-failure'];\n        }\n        break;\n      case 'password-reset':\n        // In security mode, always return success message for password reset\n        if (['auth/user-not-found'].includes(errorCode)) {\n          return SECURITY_MODE_MESSAGES['password-reset-sent'];\n        }\n        break;\n    }\n  }\n  \n  // Return specific error message or default\n  return ERROR_MESSAGES[errorCode] || ERROR_MESSAGES['default'];\n};\n\n/**\n * Main Firebase error handler\n * @param {Error|Object} error - Firebase error object\n * @param {string} context - Context of the operation (signin, signup, password-reset, etc.)\n * @param {Object} options - Additional options\n * @returns {Promise<Object>} Standardized error response\n */\nexport const handleFirebaseError = async (error, context = 'default', options = {}) => {\n  const { \n    useVerboseMode = null,\n    returnType = 'object', // 'object' or 'string'\n    includeType = false // Include type field for certain contexts\n  } = options;\n  \n  // Log error in development for debugging\n  if (process.env.NODE_ENV === 'development') {\n    console.log(`Firebase ${context} error:`, error.code || error.message);\n  }\n  \n  // Check for network connectivity issues first\n  if (await isLikelyNetworkError(error)) {\n    const networkMessage = await getContextualErrorMessage(\n      error, \n      'Connection failed. Please check your internet and try again.'\n    );\n    \n    return returnType === 'string' ? networkMessage : {\n      success: false,\n      error: networkMessage,\n      ...(includeType && { type: 'error' })\n    };\n  }\n  \n  // Get appropriate error message\n  const errorMessage = getErrorMessage(error.code, context, useVerboseMode);\n  \n  // Return formatted response\n  if (returnType === 'string') {\n    return errorMessage;\n  }\n  \n  return {\n    success: false,\n    error: errorMessage,\n    ...(includeType && { type: 'error' })\n  };\n};\n\n/**\n * Specialized handlers for different Firebase operations\n */\n\n/**\n * Handle sign-in errors with context-specific logic\n */\nexport const handleSignInError = async (error, options = {}) => {\n  return handleFirebaseError(error, 'signin', options);\n};\n\n/**\n * Handle sign-up errors with context-specific logic\n */\nexport const handleSignUpError = async (error, options = {}) => {\n  return handleFirebaseError(error, 'signup', options);\n};\n\n/**\n * Handle password reset errors with context-specific logic\n * In security mode, this may return success even for non-existent users\n */\nexport const handlePasswordResetError = async (error, options = {}) => {\n  const verboseMode = options.useVerboseMode !== null ? options.useVerboseMode : isVerboseModeEnabled();\n  \n  // In security mode, treat user-not-found as success to prevent enumeration\n  if (!verboseMode && error.code === 'auth/user-not-found') {\n    return {\n      success: true,\n      type: 'success',\n      message: SECURITY_MODE_MESSAGES['password-reset-sent']\n    };\n  }\n  \n  return handleFirebaseError(error, 'password-reset', { \n    ...options, \n    includeType: true \n  });\n};\n\n/**\n * Handle email verification errors\n */\nexport const handleEmailVerificationError = async (error, options = {}) => {\n  return handleFirebaseError(error, 'email-verification', options);\n};\n\n/**\n * Handle Google sign-in specific errors\n */\nexport const handleGoogleSignInError = async (error, options = {}) => {\n  return handleFirebaseError(error, 'google-signin', options);\n};\n\n/**\n * Handle password reset success (for consistency)\n */\nexport const getPasswordResetSuccessMessage = (verboseMode = null) => {\n  const verbose = verboseMode !== null ? verboseMode : isVerboseModeEnabled();\n  \n  if (verbose) {\n    return 'Password reset link sent! Check your email and spam folder.';\n  } else {\n    return SECURITY_MODE_MESSAGES['password-reset-sent'];\n  }\n};\n\n/**\n * Utility function to check if an error should be treated as success in security mode\n */\nexport const shouldTreatAsSuccessInSecurityMode = (error, context) => {\n  const verboseMode = isVerboseModeEnabled();\n  if (verboseMode) return false;\n  \n  // In security mode, treat certain errors as success to prevent enumeration\n  if (context === 'password-reset' && error.code === 'auth/user-not-found') {\n    return true;\n  }\n  \n  return false;\n};\n\n// Export constants for testing and consistency\nexport { ERROR_MESSAGES, SECURITY_MODE_MESSAGES, isVerboseModeEnabled };","path":null,"size_bytes":9635,"size_tokens":null},"src/hooks/useBodyScrollLock.js":{"content":"\"use client\";\n\nimport { useEffect } from 'react';\n\n/**\n * Custom hook to prevent body scrolling when components like modals or sidebars are open\n * @param {boolean} isLocked - Whether to lock body scroll\n */\nexport function useBodyScrollLock(isLocked) {\n  useEffect(() => {\n    if (!isLocked) return;\n\n    // Save the original overflow value\n    const originalOverflow = document.body.style.overflow;\n    const originalPaddingRight = document.body.style.paddingRight;\n\n    // Get the scrollbar width to prevent layout shift\n    const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;\n\n    // Apply scroll lock\n    document.body.style.overflow = 'hidden';\n    \n    // Add padding to compensate for scrollbar removal (prevents layout shift)\n    if (scrollbarWidth > 0) {\n      document.body.style.paddingRight = `${scrollbarWidth}px`;\n    }\n\n    // Cleanup function\n    return () => {\n      document.body.style.overflow = originalOverflow;\n      document.body.style.paddingRight = originalPaddingRight;\n    };\n  }, [isLocked]);\n}","path":null,"size_bytes":1052,"size_tokens":null},"src/app/(chrome)/page.js":{"content":"import Hero from \"../../components/Hero\";\nimport FeaturedCampaigns from \"../../components/FeaturedCampaigns\";\nimport FeaturedCreators from \"../../components/FeaturedCreators\";\n\nexport default function Home() {\n  return (\n    <>\n      <Hero />\n      <FeaturedCampaigns />\n      <FeaturedCreators />\n    </>\n  );\n}\n","path":null,"size_bytes":313,"size_tokens":null},"src/app/(chrome)/profile/page.js":{"content":"// Profile page for the authenticated user\nimport ProfilePageWrapper from \"../../../components/ProfilePageWrapper\";\n\nexport const metadata = {\n  title: \"Profile - Frame Your Voice\",\n  description: \"Manage your profile and view your campaigns\",\n};\n\nexport default function Profile() {\n  return <ProfilePageWrapper isOwnProfile={true} />;\n}","path":null,"size_bytes":338,"size_tokens":null},"src/components/FilterModal.js":{"content":"\"use client\";\n\nimport { useEffect, useState } from 'react';\nimport { useBodyScrollLock } from '../hooks/useBodyScrollLock';\n\nexport default function FilterModal({ \n  isOpen, \n  onClose, \n  onApply,\n  initialFilters,\n  filterFields\n}) {\n  const [tempFilters, setTempFilters] = useState(initialFilters);\n  const [hasChanges, setHasChanges] = useState(false);\n\n  // Lock body scroll when modal is open\n  useBodyScrollLock(isOpen);\n\n  useEffect(() => {\n    if (isOpen) {\n      setTempFilters(initialFilters);\n      setHasChanges(false);\n    }\n  }, [isOpen, initialFilters]);\n\n  useEffect(() => {\n    const handleEscape = (e) => {\n      if (e.key === 'Escape' && isOpen) {\n        onClose();\n      }\n    };\n\n    if (isOpen) {\n      document.addEventListener('keydown', handleEscape);\n    }\n\n    return () => {\n      document.removeEventListener('keydown', handleEscape);\n    };\n  }, [isOpen, onClose]);\n\n  useEffect(() => {\n    const changed = JSON.stringify(tempFilters) !== JSON.stringify(initialFilters);\n    setHasChanges(changed);\n  }, [tempFilters, initialFilters]);\n\n  if (!isOpen) return null;\n\n  const handleBackdropClick = (e) => {\n    if (e.target === e.currentTarget) {\n      onClose();\n    }\n  };\n\n  const handleFilterChange = (key, value) => {\n    setTempFilters(prev => ({ ...prev, [key]: value }));\n  };\n\n  const handleApply = () => {\n    onApply(tempFilters);\n    onClose();\n  };\n\n  const handleCancel = () => {\n    setTempFilters(initialFilters);\n    onClose();\n  };\n\n  return (\n    <div \n      className=\"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4\"\n      onClick={handleBackdropClick}\n    >\n      <div className=\"bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 transform transition-all\">\n        {/* Header - Yellow background */}\n        <div className=\"bg-yellow-400 px-6 py-6 relative rounded-t-xl\">\n          <div className=\"text-center\">\n            <h2 className=\"text-2xl font-bold text-emerald-700\">\n              Filter Options\n            </h2>\n            <p className=\"text-base text-gray-700 mt-1\">\n              Customize your search criteria\n            </p>\n          </div>\n          <button\n            onClick={handleCancel}\n            className=\"absolute top-4 right-4 btn-base p-2 hover:bg-yellow-500 rounded-full transition-colors\"\n          >\n            <svg className=\"w-5 h-5 text-gray-700\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n            </svg>\n          </button>\n        </div>\n\n        {/* Body - Filter Fields */}\n        <div className=\"bg-white border-t-0 border-gray-200 px-6 py-8 rounded-b-xl\">\n          <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-6\">\n            {filterFields.map((field) => (\n              <div key={field.key}>\n                <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                  {field.label}\n                </label>\n                <select\n                  value={tempFilters[field.key] || ''}\n                  onChange={(e) => handleFilterChange(field.key, e.target.value)}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all duration-300 text-gray-900 text-sm\"\n                >\n                  {field.options.map((option) => (\n                    <option key={option.value} value={option.value}>\n                      {option.label}\n                    </option>\n                  ))}\n                </select>\n              </div>\n            ))}\n          </div>\n\n          {/* Footer - Action Buttons */}\n          <div className=\"mt-8 flex gap-3 justify-end\">\n            <button\n              onClick={handleCancel}\n              className=\"btn-base btn-secondary px-6 py-2 text-sm\"\n            >\n              Cancel\n            </button>\n            <button\n              onClick={handleApply}\n              disabled={!hasChanges}\n              className={`btn-base px-6 py-2 text-sm ${\n                hasChanges \n                  ? 'btn-primary' \n                  : 'bg-gray-300 text-gray-500 cursor-not-allowed'\n              }`}\n            >\n              Apply Filters\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":4363,"size_tokens":null},"src/lib/firebase-optimized.js":{"content":"\"use client\";\n\n// Optimized Firebase configuration with static imports for better performance\nimport { initializeApp, getApps, getApp } from \"firebase/app\";\nimport { getAuth } from \"firebase/auth\";\nimport { getFirestore } from \"firebase/firestore\";\nimport { useState, useEffect } from \"react\";\n\n// Module-level Firebase instances (initialized immediately on client)\nlet firebaseApp = null;\nlet firebaseAuth = null;\nlet firebaseDb = null;\nlet isInitialized = false;\nlet isConfigured = false;\n\n// Initialize Firebase immediately at module load (client-side only)\nconst initializeFirebaseModule = () => {\n  // Only run on client\n  if (typeof window === \"undefined\") {\n    return;\n  }\n\n  // Only initialize once\n  if (isInitialized) {\n    return;\n  }\n\n  try {\n    const isProduction = process.env.NODE_ENV === \"production\";\n    const isDevelopment = process.env.NODE_ENV === \"development\";\n\n    // Check environment variables\n    const apiKey = process.env.NEXT_PUBLIC_FIREBASE_API_KEY;\n    const projectId = process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID;\n    const appId = process.env.NEXT_PUBLIC_FIREBASE_APP_ID;\n    const messagingSenderId =\n      process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID;\n\n    // Validate required environment variables\n    const missingVars = [];\n    if (!apiKey) missingVars.push(\"NEXT_PUBLIC_FIREBASE_API_KEY\");\n    if (!projectId) missingVars.push(\"NEXT_PUBLIC_FIREBASE_PROJECT_ID\");\n    if (!appId) missingVars.push(\"NEXT_PUBLIC_FIREBASE_APP_ID\");\n\n    if (missingVars.length > 0) {\n      const errorMessage = `Missing required Firebase configuration: ${missingVars.join(\", \")}`;\n\n      if (isProduction) {\n        // Production: Fail fast\n        throw new Error(`[PRODUCTION] ${errorMessage}. Please add these environment variables in Vercel.`);\n      }\n\n      if (isDevelopment) {\n        // Development: Warn clearly\n        console.warn(`[DEV WARNING] ${errorMessage}`);\n        console.warn(\"[DEV WARNING] Firebase will not be available. Add these variables in Vercel for production.\");\n      }\n\n      isInitialized = true;\n      isConfigured = false;\n      return;\n    }\n\n    const firebaseConfig = {\n      apiKey,\n      authDomain: `${projectId}.firebaseapp.com`,\n      projectId,\n      storageBucket: `${projectId}.appspot.com`,\n      messagingSenderId,\n      appId,\n    };\n\n    // Initialize Firebase - prevent duplicate initialization\n    firebaseApp = getApps().length ? getApp() : initializeApp(firebaseConfig);\n    firebaseAuth = getAuth(firebaseApp);\n    firebaseDb = getFirestore(firebaseApp);\n\n    // using in-app notifications only\n\n    isInitialized = true;\n    isConfigured = true;\n\n    if (isDevelopment) {\n      console.log(\"[DEV] Firebase client initialized successfully\");\n    }\n  } catch (error) {\n    const isProduction = process.env.NODE_ENV === \"production\";\n\n    if (isProduction) {\n      // Production: Re-throw errors\n      throw error;\n    }\n\n    // Development: Log error and continue\n    console.error(\"[DEV ERROR] Firebase initialization failed:\", error.message);\n    isInitialized = true;\n    isConfigured = false;\n  }\n};\n\n// Initialize Firebase immediately when module loads (client-side only)\ninitializeFirebaseModule();\n\n// Hook to access Firebase instances in React components\nexport const useFirebaseOptimized = () => {\n  const [firebase, setFirebase] = useState({\n    app: firebaseApp,\n    auth: firebaseAuth,\n    db: firebaseDb,\n    isLoading: false,\n    isConfigured: isConfigured,\n  });\n\n  useEffect(() => {\n    // Update state with already-initialized instances from module load\n    setFirebase({\n      app: firebaseApp,\n      auth: firebaseAuth,\n      db: firebaseDb,\n      isLoading: false,\n      isConfigured: isConfigured,\n    });\n  }, []);\n\n  return firebase;\n};\n\n// Export Firebase services (now available immediately at module load)\nexport { firebaseAuth as auth, firebaseDb as db };\nexport default firebaseApp;\n","path":null,"size_bytes":3897,"size_tokens":null},"src/app/api/storage/signed-url/route.js":{"content":"import { NextResponse } from 'next/server'\nimport { verifyIdToken } from '../../../../lib/firebaseAdmin'\nimport { supabaseAdmin } from '../../../../lib/supabase-admin'\nimport { headers } from 'next/headers'\n\n// Force Node.js runtime for server-side operations\nexport const runtime = 'nodejs'\n\nexport async function POST(request) {\n  try {\n    // Get the authorization header\n    const headersList = headers()\n    const authorization = headersList.get('authorization')\n    \n    if (!authorization || !authorization.startsWith('Bearer ')) {\n      return NextResponse.json({ success: false, error: 'No authorization token provided' }, { status: 401 })\n    }\n\n    const token = authorization.replace('Bearer ', '')\n    \n    // Verify Firebase ID token\n    let decodedToken\n    try {\n      decodedToken = await verifyIdToken(token)\n    } catch (error) {\n      return NextResponse.json({ success: false, error: 'Invalid token' }, { status: 401 })\n    }\n\n    const { path, expiresIn = 3600 } = await request.json()\n    \n    if (!path) {\n      return NextResponse.json({ success: false, error: 'path is required' }, { status: 400 })\n    }\n\n    // Verify user owns this file - handle different folder structures\n    const allowedPrefixes = [\n      `uploads/${decodedToken.uid}/`,\n      `profile-images/${decodedToken.uid}/`,\n      `documents/${decodedToken.uid}/`,\n      `temp/${decodedToken.uid}/`,\n      `campaigns/${decodedToken.uid}/`\n    ]\n    \n    const hasValidPrefix = allowedPrefixes.some(prefix => path.startsWith(prefix))\n    if (!hasValidPrefix) {\n      return NextResponse.json({ success: false, error: 'Access denied' }, { status: 403 })\n    }\n\n    // Generate signed download URL\n    const { data, error } = await supabaseAdmin.storage\n      .from('uploads')\n      .createSignedUrl(path, expiresIn)\n\n    if (error) {\n      console.error('Supabase error:', error)\n      return NextResponse.json({ success: false, error: 'Failed to create signed URL' }, { status: 500 })\n    }\n\n    return NextResponse.json({\n      success: true,\n      signedUrl: data.signedUrl\n    })\n\n  } catch (error) {\n    console.error('Signed URL generation error:', error)\n    return NextResponse.json({ success: false, error: 'Internal server error' }, { status: 500 })\n  }\n}","path":null,"size_bytes":2254,"size_tokens":null},"src/app/loading.js":{"content":"import PageLoader from \"../components/PageLoader\";\n\nexport default function Loading() {\n  return <PageLoader message=\"Loading...\" />;\n}","path":null,"size_bytes":135,"size_tokens":null},"src/middleware.js":{"content":"import { NextResponse } from 'next/server';\n\nexport function middleware(request) {\n  // Handle CORS for all routes\n  const origin = request.headers.get('origin');\n  const isDevEnvironment = process.env.NODE_ENV === 'development';\n  \n  // Define allowed origins\n  const allowedOrigins = [\n    // Development origins\n    ...(isDevEnvironment ? [\n      'https://*.replit.dev',\n      'https://*.repl.co',\n      'http://localhost:5000',\n      'http://127.0.0.1:5000',\n      'http://localhost',\n      'http://127.0.0.1'\n    ] : []),\n    // Production origins can be added here via environment variable\n    ...(process.env.ALLOWED_ORIGINS ? process.env.ALLOWED_ORIGINS.split(',') : [])\n  ];\n\n  // Check if origin is allowed\n  const isAllowed = allowedOrigins.some(allowedOrigin => {\n    if (allowedOrigin.includes('*')) {\n      // Handle wildcard patterns like https://*.replit.dev safely\n      try {\n        const allowedUrl = new URL(allowedOrigin.replace('*', 'placeholder'));\n        const originUrl = new URL(origin);\n        \n        // Protocol must match\n        if (allowedUrl.protocol !== originUrl.protocol) {\n          return false;\n        }\n        \n        // For wildcard subdomains, check if host ends with the domain\n        const wildcardDomain = allowedUrl.hostname.replace('placeholder', '');\n        if (wildcardDomain.startsWith('.')) {\n          // Pattern like https://*.replit.dev - require actual subdomain\n          const domain = wildcardDomain.substring(1); // Remove leading dot\n          return originUrl.hostname.endsWith('.' + domain);\n        }\n        \n        return false;\n      } catch (e) {\n        // Invalid URL format, no match\n        return false;\n      }\n    }\n    return origin === allowedOrigin;\n  });\n\n  // Handle preflight requests\n  if (request.method === 'OPTIONS') {\n    const response = new NextResponse(null, { status: 200 });\n    \n    if (isAllowed && origin) {\n      response.headers.set('Access-Control-Allow-Origin', origin);\n    }\n    \n    // Echo requested method or use defaults\n    const requestedMethod = request.headers.get('access-control-request-method');\n    response.headers.set('Access-Control-Allow-Methods', \n      requestedMethod || 'GET, POST, PUT, DELETE, OPTIONS');\n    \n    // Echo requested headers or use defaults\n    const requestedHeaders = request.headers.get('access-control-request-headers');\n    response.headers.set('Access-Control-Allow-Headers', \n      requestedHeaders || 'Content-Type, Authorization, X-Requested-With');\n    \n    response.headers.set('Access-Control-Max-Age', '86400');\n    response.headers.set('Vary', 'Origin, Access-Control-Request-Headers');\n    \n    return response;\n  }\n\n  // Handle actual requests\n  const response = NextResponse.next();\n  \n  if (isAllowed && origin) {\n    response.headers.set('Access-Control-Allow-Origin', origin);\n    response.headers.set('Access-Control-Allow-Credentials', 'true');\n  }\n  \n  response.headers.set('Vary', 'Origin');\n\n  // Add cache control for non-static routes in development\n  if (isDevEnvironment && !request.nextUrl.pathname.startsWith('/_next/static')) {\n    response.headers.set('Cache-Control', 'no-cache, no-store, must-revalidate');\n  }\n\n  return response;\n}\n\nexport const config = {\n  matcher: [\n    /*\n     * Match all request paths except for the ones starting with:\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico (favicon file)\n     * Include API routes for proper CORS handling\n     */\n    '/((?!_next/static|_next/image|favicon.ico).*)',\n  ],\n};","path":null,"size_bytes":3564,"size_tokens":null},"src/app/api/admin/users/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\n\nexport async function GET(request) {\n  try {\n    await requireAdmin(request);\n    \n    const { searchParams } = new URL(request.url);\n    const search = searchParams.get('search') || '';\n    const role = searchParams.get('role');\n    const limitParam = searchParams.get('limit') || '100';\n    const limitValue = parseInt(limitParam, 10);\n    \n    const db = adminFirestore();\n    const users = [];\n    \n    if (search) {\n      let query = db.collection('users');\n      if (role && role !== 'all') {\n        query = query.where('role', '==', role);\n      }\n      query = query.orderBy('createdAt', 'desc');\n      \n      let hasMore = true;\n      let lastDoc = null;\n      const batchSize = 100;\n      const searchLower = search.toLowerCase();\n      \n      while (hasMore && users.length < limitValue) {\n        let batchQuery = lastDoc ? query.startAfter(lastDoc).limit(batchSize) : query.limit(batchSize);\n        const snapshot = await batchQuery.get();\n        \n        if (snapshot.empty) {\n          break;\n        }\n        \n        for (const doc of snapshot.docs) {\n          if (users.length >= limitValue) {\n            hasMore = false;\n            break;\n          }\n          \n          const userData = { id: doc.id, ...doc.data() };\n          \n          const matchesSearch = \n            (userData.displayName && userData.displayName.toLowerCase().includes(searchLower)) ||\n            (userData.email && userData.email.toLowerCase().includes(searchLower)) ||\n            (userData.username && userData.username.toLowerCase().includes(searchLower));\n          \n          if (matchesSearch) {\n            if (userData.createdAt && userData.createdAt.toDate) {\n              userData.createdAt = userData.createdAt.toDate().toISOString();\n            }\n            if (userData.updatedAt && userData.updatedAt.toDate) {\n              userData.updatedAt = userData.updatedAt.toDate().toISOString();\n            }\n            if (userData.bannedAt && userData.bannedAt.toDate) {\n              userData.bannedAt = userData.bannedAt.toDate().toISOString();\n            }\n            \n            users.push(userData);\n          }\n        }\n        \n        lastDoc = snapshot.docs[snapshot.docs.length - 1];\n        \n        if (snapshot.docs.length < batchSize) {\n          hasMore = false;\n        }\n      }\n      \n      const userIds = users.map(u => u.id);\n      \n      if (userIds.length > 0) {\n        const campaignsByCreator = {};\n        \n        const chunkSize = 10;\n        for (let i = 0; i < userIds.length; i += chunkSize) {\n          const chunk = userIds.slice(i, i + chunkSize);\n          const campaignsSnapshot = await db.collection('campaigns')\n            .where('creatorId', 'in', chunk)\n            .where('moderationStatus', '==', 'active')\n            .get();\n          \n          campaignsSnapshot.docs.forEach(campaignDoc => {\n            const campaignData = campaignDoc.data();\n            const creatorId = campaignData.creatorId;\n            \n            if (!campaignsByCreator[creatorId]) {\n              campaignsByCreator[creatorId] = {\n                count: 0,\n                totalSupports: 0\n              };\n            }\n            \n            campaignsByCreator[creatorId].count++;\n            campaignsByCreator[creatorId].totalSupports += campaignData.supportersCount || 0;\n          });\n        }\n        \n        users.forEach(user => {\n          const stats = campaignsByCreator[user.id] || { count: 0, totalSupports: 0 };\n          user.campaignsCount = stats.count;\n          user.totalSupports = stats.totalSupports;\n        });\n      } else {\n        users.forEach(user => {\n          user.campaignsCount = 0;\n          user.totalSupports = 0;\n        });\n      }\n    } else {\n      let query = db.collection('users');\n      if (role && role !== 'all') {\n        query = query.where('role', '==', role);\n      }\n      query = query.orderBy('createdAt', 'desc').limit(limitValue);\n      \n      const snapshot = await query.get();\n      \n      snapshot.docs.forEach(doc => {\n        const userData = { id: doc.id, ...doc.data() };\n        \n        if (userData.createdAt && userData.createdAt.toDate) {\n          userData.createdAt = userData.createdAt.toDate().toISOString();\n        }\n        if (userData.updatedAt && userData.updatedAt.toDate) {\n          userData.updatedAt = userData.updatedAt.toDate().toISOString();\n        }\n        if (userData.bannedAt && userData.bannedAt.toDate) {\n          userData.bannedAt = userData.bannedAt.toDate().toISOString();\n        }\n        \n        users.push(userData);\n      });\n      \n      const userIds = users.map(u => u.id);\n      \n      if (userIds.length > 0) {\n        const campaignsByCreator = {};\n        \n        const chunkSize = 10;\n        for (let i = 0; i < userIds.length; i += chunkSize) {\n          const chunk = userIds.slice(i, i + chunkSize);\n          const campaignsSnapshot = await db.collection('campaigns')\n            .where('creatorId', 'in', chunk)\n            .where('moderationStatus', '==', 'active')\n            .get();\n          \n          campaignsSnapshot.docs.forEach(campaignDoc => {\n            const campaignData = campaignDoc.data();\n            const creatorId = campaignData.creatorId;\n            \n            if (!campaignsByCreator[creatorId]) {\n              campaignsByCreator[creatorId] = {\n                count: 0,\n                totalSupports: 0\n              };\n            }\n            \n            campaignsByCreator[creatorId].count++;\n            campaignsByCreator[creatorId].totalSupports += campaignData.supportersCount || 0;\n          });\n        }\n        \n        users.forEach(user => {\n          const stats = campaignsByCreator[user.id] || { count: 0, totalSupports: 0 };\n          user.campaignsCount = stats.count;\n          user.totalSupports = stats.totalSupports;\n        });\n      } else {\n        users.forEach(user => {\n          user.campaignsCount = 0;\n          user.totalSupports = 0;\n        });\n      }\n    }\n    \n    return NextResponse.json({\n      success: true,\n      data: users,\n      total: users.length,\n    });\n  } catch (error) {\n    console.error('Error fetching users:', error);\n    \n    if (error.message.includes('Unauthorized') || error.message.includes('Admin access required')) {\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 403 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to fetch users' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":6691,"size_tokens":null},"CODEBASE_STRUCTURE.md":{"content":"# Codebase Structure Documentation\n\n**Last Updated:** October 26, 2025  \n**Project:** Twibbonize - Campaign Photo Frame & Background Platform\n\nThis document provides a complete overview of the codebase structure with descriptions of each file and folder's purpose.\n\n---\n\n##  Root Directory\n\n```\n.\n attached_assets/          # Uploaded assets and screenshots (temporary files)\n public/                   # Static assets served directly\n src/                      # Source code directory (main application)\n *.md                      # Documentation files\n Config files              # Project configuration\n```\n\n### Documentation Files\n\n- **`README.md`** - Standard Next.js project documentation\n- **`replit.md`** - Project overview, strict policies, architecture, and user preferences\n- **`TASKS.md`** - Campaign system task tracker with implementation status\n- **`CAMPAIGN_SYSTEM.md`** - Complete campaign system implementation guide\n- **`REPORT_SYSTEM.md`** - Comprehensive reporting and moderation system documentation\n- **`CODE_INCONSISTENCIES.md`** - Tracks code/documentation inconsistencies and fixes\n- **`CODEBASE_STRUCTURE.md`** - This file - complete codebase structure documentation\n\n### Configuration Files\n\n- **`package.json`** - Node.js dependencies and scripts\n- **`package-lock.json`** - Locked dependency versions\n- **`next.config.mjs`** - Next.js framework configuration\n- **`postcss.config.mjs`** - PostCSS configuration for Tailwind CSS\n- **`eslint.config.mjs`** - ESLint linting rules\n- **`jsconfig.json`** - JavaScript/TypeScript configuration and path aliases\n- **`firestore.rules`** - Firestore database security rules\n- **`firestore.indexes.json`** - Firestore composite index definitions\n- **`vercel.json`** - Vercel deployment configuration including 2 cron jobs for automated moderation\n\n---\n\n##  `/public` - Static Assets\n\n```\npublic/\n file.svg              # File icon\n globe.svg             # Globe icon\n next.svg              # Next.js logo\n vercel.svg            # Vercel logo\n window.svg            # Window icon\n```\n\n**Purpose:** Contains static assets that are served directly without processing. These files are accessible at the root URL (e.g., `/file.svg`).\n\n---\n\n##  `/src` - Source Code\n\nMain application source code organized by Next.js App Router conventions.\n\n---\n\n##  `/src/app` - Application Routes & Pages\n\nNext.js 15 App Router directory structure. Each folder represents a route.\n\n### Root Level Files\n\n- **`layout.js`** - Root layout wrapper for entire app with NotificationProvider\n- **`globals.css`** - Global styles and Tailwind CSS imports\n- **`loading.js`** - Global loading UI component\n- **`not-found.js`** - 404 error page\n- **`analytics.js`** - Analytics tracking setup\n- **`favicon.ico`** - Site favicon\n\n---\n\n###  `/src/app/(chrome)` - Main App Layout Group\n\nRoutes that use the main app layout (header + footer).\n\n#### **`layout.js`** - Chrome layout with Header/Footer navigation\n\n#### **`page.js`** - Homepage with hero and CTA\n\n---\n\n###  `/src/app/(chrome)/admin` - Admin Dashboard\n\nAdmin-only routes for platform moderation and management.\n\n#### **`layout.js`** - Admin layout with sidebar navigation and auth protection\n#### **`page.js`** - Admin analytics dashboard (default admin page)\n\n####  **`/reports`** - Reports Management\n- **`page.js`** - Reports table with filters and moderation actions (uses aggregated reportSummary)\n\n####  **`/campaigns`** - Campaign Moderation\n- **`page.js`** - Campaign grid with moderation status and actions\n\n####  **`/users`** - User Management\n- **`page.js`** - User table with role assignment and ban actions\n\n####  **`/logs`** - Admin Action Logs\n- **`page.js`** - Admin activity audit log with filters (action type, target type, admin, date range)\n\n####  **`/appeals`** - Appeals Review\n- **`page.js`** - Admin dashboard for reviewing user appeals with approve/reject actions and typed confirmation\n\n---\n\n###  `/src/app/(chrome)/campaign/[slug]` - 3-Page Campaign Flow\n\nVisitor experience for using campaigns (frames/backgrounds).\n\n#### **`page.js`** - Page 1: Upload photo and view campaign details\n####  **`/adjust`**\n- **`page.js`** - Page 2: Adjust photo with zoom/position/rotate controls\n####  **`/result`**\n- **`page.js`** - Page 3: Download result and share options\n\n**Flow:** Upload  Adjust  Result (with session persistence and route guards)\n\n---\n\n###  `/src/app/(chrome)/campaigns` - Campaign Gallery\n\n#### **`page.js`** - Browse all campaigns with filters (type, time, sort)\n\n---\n\n###  `/src/app/(chrome)/create` - Campaign Creation\n\nCreator workflow for uploading new campaigns.\n\n#### **`page.js`** - Opens CreateCampaignModal (for direct URL access)\n\n####  **`/frame`**\n- **`page.js`** - Upload frame with transparency detection (5% required)\n\n####  **`/background`**\n- **`page.js`** - Upload background (any format, no transparency required)\n\n**Flow:** Choose type  Upload image  Fill metadata  Publish\n\n---\n\n###  `/src/app/(chrome)/creators` - Top Creators\n\n#### **`page.js`** - Leaderboard ranked by total campaign supports\n\n---\n\n###  `/src/app/(chrome)/profile` - User Profile\n\n#### **`page.js`** - User's own profile page with campaigns grid\n\n####  **`/edit`**\n- **`page.js`** - Edit profile (avatar, banner, bio, username)\n\n####  **`/notifications`**\n- **`page.js`** - Notification inbox with read/unread status and history\n\n####  **`/appeals`**\n- **`page.js`** - User appeals submission page for removed campaigns and banned accounts\n\n**Note:** The `/settings` directory does NOT exist yet but is planned for future implementation. It will include settings pages for account management (`/settings/account`), privacy controls (`/settings/privacy`), and user preferences (`/settings/preferences`). Notification preferences will NOT be included since all notifications are moderation-related and mandatory. Users manage notifications via the inbox at `/profile/notifications`. Profile editing remains at `/profile/edit`.\n\n---\n\n###  `/src/app/(chrome)/u/[username]` - Public Profiles\n\n#### **`page.js`** - Public user profile pages (accessible via username)\n\n---\n\n###  `/src/app/(chrome)/privacy` - Legal Pages\n\n#### **`page.js`** - Privacy policy page\n\n---\n\n###  `/src/app/(chrome)/terms` - Legal Pages\n\n#### **`page.js`** - Terms of service page\n\n---\n\n###  `/src/app/api` - API Routes (Server-Side)\n\nBackend API endpoints for data operations.\n\n---\n\n###  `/src/app/api/admin` - Admin API Routes\n\nServer-side admin operations (protected by admin middleware).\n\n####  **`/analytics`**\n- **`route.js`** - GET: Fetch platform analytics (total users, campaigns, reports, bans)\n\n####  **`/campaigns`**\n- **`route.js`** - GET: Fetch all campaigns with creator info (admin view)\n- **`/[campaignId]/route.js`** - PATCH: Update campaign moderation status\n- **`/[campaignId]/delete/route.js`** - DELETE: Permanently delete campaign + image\n\n####  **`/logs`**\n- **`route.js`** - GET: Fetch admin action logs with filters (action type, target type, admin, limit)\n\n####  **`/reports`**\n- **`route.js`** - GET: Fetch all reports (legacy endpoint, still functional)\n- **`/grouped/route.js`** - GET: Fetch aggregated report summaries with batch-optimized queries (96% faster)\n- **`/summary/[summaryId]/route.js`** - PATCH: Take moderation action on aggregated report summary (dismiss/warn/remove)\n\n####  **`/users`**\n- **`route.js`** - GET: Fetch all users with search/filters\n- **`/[userId]/role/route.js`** - PATCH: Assign/revoke admin role\n- **`/[userId]/ban/route.js`** - PATCH: Ban/unban user (sends email notification to user)\n\n####  **`/appeals`**\n- **`route.js`** - GET: Fetch appeals for admin review with filtering (status, type, limit)\n- **`/[appealId]/route.js`** - PATCH: Approve or reject appeals with status transition validation\n\n---\n\n###  `/src/app/api/campaigns` - Campaign Operations\n\n####  **`/[campaignId]`**\n- **`route.js`** - DELETE: Delete campaign and auto-dismiss all related reports (owner only)\n\n####  **`/track-download`**\n- **`route.js`** - POST: Increment campaign supportersCount on download\n\n---\n\n###  `/src/app/api/notifications` - Notification System\n\n**Hybrid notification system** combining in-app and email:\n\n####  **`/[notificationId]`**\n- **`route.js`** - PATCH: Mark notification as read/unread, DELETE: Delete notification\n\n**In-App Notifications (Firestore-based):**\n- No browser permissions required\n- Delivered instantly via Firestore real-time listeners\n- Used for: warnings, campaign removals, auto-hides, content restorations\n- Works on all devices without setup\n\n**Email Notifications (MailerSend):**\n- Used exclusively for: user bans and unbans\n- Critical for banned users who cannot access their account\n- Professional HTML templates with ban reasons and appeal deadlines\n- See `src/utils/notifications/emailTemplates.js` and `sendEmail.js`\n\n---\n\n###  `/src/app/api/appeals` - Appeal System\n\n####  **`/eligible`**\n- **`route.js`** - GET: Fetch campaigns/accounts eligible for appeal (removed-temporary or banned-temporary with active appeal window)\n\n####  **`/submit`**\n- **`route.js`** - POST: Submit appeal for removed campaign or banned account with validation (min 20 chars, one appeal per item)\n\n---\n\n###  `/src/app/api/cron` - Vercel Cron Jobs\n\n**Two automated moderation cron jobs (runs in production only):**\n\n####  **`/cleanup-expired-appeals`**\n- **`route.js`** - GET: Daily cron job (2:00 AM UTC) to upgrade expired temporary removals/bans to permanent status\n- Secured with `CRON_SECRET` environment variable\n- Sends in-app notifications for campaigns, email notifications for user bans\n- Logs all actions to `adminLogs` collection\n\n####  **`/send-appeal-reminders`**\n- **`route.js`** - GET: Daily cron job (10:00 AM UTC) to send appeal deadline reminders (7, 3, 1 day before expiry)\n- Sends both in-app and email notifications\n- Includes countdown timer and direct appeal link\n\n---\n\n###  `/src/app/api/reports` - Report Submission\n\n####  **`/submit`**\n- **`route.js`** - POST: Submit campaign report with IP-based rate limiting (5/hour) and duplicate prevention\n\n####  **`/user`**\n- **`route.js`** - POST: Submit user/profile report with IP-based rate limiting (5/hour) and duplicate prevention\n\n**Rate Limiting:**\n- Maximum 5 reports per hour per IP address\n- Duplicate prevention: same IP/user cannot report same target twice\n- Authenticated users tracked by userId to prevent network-switching bypass\n- IP addresses hashed (SHA-256) for privacy\n- Auto-cleanup after 24 hours via Firestore TTL\n\n---\n\n###  `/src/app/api/storage` - Supabase Storage Operations\n\n####  **`/campaign-upload-url`**\n- **`route.js`** - POST: Generate signed upload URL for campaigns\n\n####  **`/upload-url`**\n- **`route.js`** - POST: Generate signed upload URL for profile images\n\n####  **`/delete`**\n- **`route.js`** - POST: Delete file from Supabase storage\n\n####  **`/signed-url`**\n- **`route.js`** - POST: Generate temporary download URL\n\n####  **`/list`**\n- **`route.js`** - POST: List files in storage bucket\n\n---\n\n###  `/src/app` - Auth & Special Pages (No Chrome Layout)\n\nAuthentication pages and special pages without header/footer.\n\n#### **`/signin/page.js`** - Sign in page with email/password\n#### **`/signup/page.js`** - Sign up page with email/password\n#### **`/forgot-password/page.js`** - Password reset page\n#### **`/verify-email/page.js`** - Email verification page\n#### **`/onboarding/page.js`** - New user onboarding (username, bio, avatar)\n#### **`/banned/page.js`** - Banned account notice with appeal option\n\n---\n\n\n---\n\n##  `/src/components` - React Components\n\nReusable UI components organized by feature.\n\n### Layout Components\n\n- **`Header.js`** - Main navigation header with auth buttons and notification bell\n- **`Footer.js`** - Site footer with links\n- **`MobileMenu.js`** - Mobile hamburger menu\n- **`Hero.js`** - Homepage hero section with CTA\n- **`ConditionalLayout.js`** - Conditionally render header/footer\n- **`AuthenticatedLayout.js`** - Layout wrapper for authenticated users\n\n### Auth Components\n\n- **`AuthGate.js`** - Protected route wrapper (requires authentication)\n- **`ClientAuthProvider.js`** - Firebase auth context provider\n- **`EmailVerification.js`** - Email verification prompt\n- **`UserOnboardingWrapper.js`** - Onboarding flow wrapper\n- **`UserProfileProvider.js`** - User profile data provider\n\n### Campaign Components\n\n- **`CampaignGallery.js`** - Grid layout with modals for share/report/delete (uses CampaignCard)\n- **`CampaignCard.js`** - Individual campaign card with image, title, creator info, and stats\n- **`CampaignCardMenu.js`** - 3-dot menu dropdown with share/delete/report options\n- **`CampaignStepIndicator.js`** - Step indicator for 3-page flow (Upload  Adjust  Result)\n- **`CreateCampaignModal.js`** - Modal for choosing Frame or Background type\n- **`FilterModal.js`** - Filter modal for campaigns/creators pages\n\n### Profile Components\n\n- **`ProfilePage.js`** - User profile display component\n- **`ProfilePageWrapper.js`** - Profile page wrapper with loading state\n\n### Modal Components\n\n- **`ConfirmationModal.js`** - Reusable confirmation dialog\n- **`ReportModal.js`** - Universal report modal for both campaigns and user profiles\n- **`ShareModal.js`** - Universal share modal for campaigns and profiles\n- **`CreateCampaignModal.js`** - Campaign type selection modal\n\n### Admin Components\n\nLocated in `/src/components/admin/`:\n\n- **`AdminSidebar.js`** - Admin dashboard sidebar navigation with Logs link\n- **`AdminHeader.js`** - Admin dashboard header with breadcrumbs\n- **`AdminActionButton.js`** - Reusable action button with loading/confirm dialog\n- **`ReportsTable.js`** - LEGACY: Individual reports data table (still functional but unused)\n- **`GroupedReportsTable.js`** - NEW: Aggregated report summaries table with batch-optimized queries\n- **`ReportDetailsPanel.js`** - Report details slide-out panel with typed confirmation for dangerous actions\n- **`CampaignModerationCard.js`** - Campaign card with moderation actions (uses adminHelpers)\n- **`UsersTable.js`** - Users data table with search (uses adminHelpers)\n- **`UserDetailsModal.js`** - User details modal with admin actions and typed confirmation for bans\n- **`AdminLogsTable.js`** - Admin action audit log table with filters (includes cron job actions)\n\n### Notification Components\n\nLocated in `/src/components/notifications/`:\n\n- **`NotificationProvider.js`** - Global notification provider with Firestore real-time listeners\n- **`NotificationBell.js`** - Notification bell icon with unread count badge\n- **`NotificationToast.js`** - Toast notifications with animations (displays latest unread notification)\n\n### Utility Components\n\n- **`ConfirmationModal.js`** - Reusable confirmation dialog with typed confirmation feature (requires typing \"CONFIRM\" for dangerous actions)\n- **`LoadingSpinner.js`** - Loading spinner component\n- **`PageLoader.js`** - Full-page loading indicator\n- **`ErrorBoundary.js`** - Error boundary wrapper\n- **`InteractiveClient.js`** - Client-side interactive wrapper\n- **`FirestoreProvider.js`** - Firestore context provider\n- **`LayoutVisibilityContext.js`** - Control header/footer visibility\n- **`TimeoutWrapper.js`** - Timeout handling wrapper\n\n---\n\n##  `/src/contexts` - React Context Providers\n\nGlobal state management using React Context.\n\n- **`CampaignSessionContext.js`** - Campaign flow session state (photo, adjustments, campaign data)\n  - Persists to sessionStorage with 24h expiry\n  - Used across 3-page campaign flow\n\n---\n\n##  `/src/data` - Static Data\n\n- **`countries.js`** - List of countries with codes and names for filters\n\n---\n\n##  `/src/hooks` - Custom React Hooks\n\nReusable logic hooks.\n\n- **`useAuth.js`** - Firebase authentication hook (user state, login, logout)\n- **`useBodyScrollLock.js`** - Lock body scroll when modal is open\n- **`useNotifications.js`** - In-app notification hook with Firestore real-time listeners\n  - Provides: notifications list, unread count, latest notification, mark read/delete functions\n  - No browser permissions required\n- **`useFocusTrap.js`** - Trap keyboard focus within modal\n- **`useSecureStorage.js`** - Secure localStorage/sessionStorage wrapper with encryption\n\n---\n\n##  `/src/lib` - Core Libraries & Integrations\n\nExternal service integrations and core utilities.\n\n### Firebase\n\n- **`firebase-optimized.js`** - Firebase client SDK initialization (auth + firestore only)\n- **`firebaseAdmin.js`** - Firebase Admin SDK for server-side operations\n- **`firestore.js`** - Firestore database functions (CRUD operations)\n  - User profiles, campaigns, reports, creators, notifications, etc.\n\n### Supabase\n\n- **`supabase.js`** - Supabase client SDK (storage operations)\n- **`supabase-admin.js`** - Supabase Admin SDK for server-side storage\n\n---\n\n##  `/src/middleware` - API Middleware\n\nServer-side middleware for API routes.\n\n- **`adminAuth.js`** - Admin authentication middleware\n  - `requireAdmin()` - Verify user has admin role\n  - Used in all `/api/admin/*` routes\n\n---\n\n##  `/src/utils` - Utility Functions\n\nHelper functions and algorithms.\n\n### Campaign Utilities\n\n- **`slugGenerator.js`** - Generate unique URL slugs from titles (50 chars + 4-char random)\n- **`transparencyDetector.js`** - Detect PNG transparency (5% threshold for frames)\n- **`campaignStorage.js`** - Storage path utilities (`campaigns/{userId}/{campaignId}.png`)\n- **`campaignRouteGuards.js`** - Route guards for 3-page campaign flow\n  - `requirePhotoUpload()` - Redirect if no photo\n  - `requireDownloadComplete()` - Redirect if not downloaded\n\n### Image Utilities\n\n- **`imageComposition.js`** - Canvas-based image composition\n  - Frame: photo under frame\n  - Background: photo on top\n  - Zoom, position, rotate adjustments\n- **`imageTransform.js`** - ImageKit.io CDN transformations\n  - Thumbnail, preview, avatar, banner presets via ImageKit.io\n  - WebP conversion and quality optimization\n  - Supabase used only for full-size canvas operations (no transforms)\n\n### Admin Utilities\n\nLocated in `/src/utils/admin/`:\n\n- **`adminHelpers.js`** - Admin dashboard formatting utilities\n  - `formatReportReason()` - Human-readable report reasons\n  - `getModerationStatusColor()` - Badge colors for moderation status\n  - `getReportStatusColor()` - Badge colors for report status\n  - `getRoleBadgeColor()` - Badge colors for user roles\n  - `formatTimestamp()` - Date formatting with optional time\n  - `truncateText()` - Text truncation with ellipsis\n  - `formatNumber()` - Number formatting with thousands separator\n\n- **`adminValidation.js`** - Admin input validation\n  - `validateReportStatus()` - Validate report status values\n  - `validateModerationStatus()` - Validate moderation status values\n  - `validateUserRole()` - Validate user role values\n  - `validateBanReason()` - Validate ban reason is provided\n  - `validateReportAction()` - Validate report action types\n  - `getValidationError()` - Get validation error message\n\n### Notification Utilities\n\nLocated in `/src/utils/notifications/`:\n\n- **`notificationTemplates.js`** - In-app notification templates for moderation actions\n  - Campaign under review, removed, restored\n  - Warning issued\n  - Profile under review, restored\n  - Account banned (NOTE: Now replaced with email for actual bans)\n  - Appeal deadline reminders\n  - All templates use object destructuring to prevent parameter order issues\n  - All templates include type field for categorization\n\n- **`sendInAppNotification.js`** - Server-side in-app notification sender\n  - Saves notifications to Firestore (`users/{userId}/notifications`)\n  - Instant delivery via Firestore real-time listeners\n  - Supports metadata for rich notifications\n\n- **`emailTemplates.js`** - Email notification templates (MailerSend)\n  - Account banned (temporary/permanent with appeal deadline)\n  - Account unbanned (restoration notification)\n  - Appeal deadline reminders (7, 3, 1 day countdowns)\n  - Campaign/account permanently removed notifications\n  - Professional HTML design with inline CSS\n  - Mobile-responsive with call-to-action buttons\n\n- **`sendEmail.js`** - Email sending utility (MailerSend API)\n  - Server-side email delivery\n  - Used for ban/unban notifications and appeal reminders\n  - Returns success/error status for logging\n  - Supports custom sender domain\n\n### General Utilities\n\n- **`validation.js`** - Input validation functions\n- **`schemas.js`** - Data schemas and validators\n- **`firebaseErrorHandler.js`** - Firebase error messages formatter\n- **`networkUtils.js`** - Network request utilities\n- **`logAdminAction.js`** - Admin action logging utility\n  - Logs all admin moderation actions to `adminLogs` collection\n  - Tracks: admin ID/email/name, action type, target, reason, timestamp\n  - Used for audit trail and accountability\n  - Also used by cron jobs (admin: \"system\") for automatic permanent upgrades\n- **`reportRateLimit.js`** - IP-based report rate limiting\n  - Maximum 5 reports per hour per IP address\n  - Duplicate prevention by IP and userId\n  - SHA-256 IP hashing for privacy\n  - Auto-cleanup after 24 hours via Firestore TTL\n  - Prevents report spam and network-switching bypass\n\n---\n\n##  `/src` - Root Level Files\n\n- **`middleware.js`** - Next.js middleware (route protection, redirects)\n- **`polyfills.js`** - Browser polyfills for older browsers\n\n---\n\n## Key File Relationships\n\n### Campaign Creation Flow\n1. User clicks \"Create Campaign\"  `CreateCampaignModal.js`\n2. Choose Frame  `/create/frame/page.js`  `transparencyDetector.js`\n3. Upload  `campaignStorage.js`  `supabase.js`\n4. Publish  `firestore.js` (createCampaign)\n\n### Campaign Usage Flow (3-Page)\n1. Visit `/campaign/[slug]`  Upload photo  `CampaignSessionContext.js`\n2. Navigate `/adjust`  `imageComposition.js`  Canvas controls\n3. Download  `/api/campaigns/track-download`  Increment supportersCount\n4. Navigate `/result`  Share options via `ShareModal.js`\n\n### Admin Moderation Flow\n1. Admin visits `/admin`  `adminAuth.js` middleware checks role\n2. View reports  `/api/admin/reports/grouped`  Batch-optimized queries (96% faster)\n3. Take moderation action  `/api/admin/reports/summary/[summaryId]`  Atomic transaction\n4. Action logged  `logAdminAction.js`  `adminLogs` collection\n5. Notification sent:\n   - **For bans:** Email notification  `sendEmail.js`  MailerSend  User's inbox\n   - **For warnings/removals:** In-app notification  `sendInAppNotification.js`  Firestore\n6. User receives notification via email or in-app depending on action type\n\n### In-App Notification Flow\n1. Server action triggers notification  `sendInAppNotification.js`\n2. Notification saved to `users/{userId}/notifications`  Firestore\n3. Real-time listener detects new notification  `useNotifications.js`\n4. NotificationToast displays latest unread  Auto-dismisses after 5s\n5. User views full inbox at `/profile/notifications`\n\n### Email Notification Flow (for Bans/Unbans)\n1. Admin bans/unbans user  `/api/admin/users/[userId]/ban` or `/api/admin/reports/summary/[summaryId]`\n2. Email template generated  `emailTemplates.js`  accountBanned or accountUnbanned\n3. Email sent  `sendEmail.js`  MailerSend API  User's email inbox\n4. User receives email with ban reason, appeal deadline, and action buttons\n5. Banned users can read email even when locked out of account\n\n---\n\n## External Dependencies\n\n### Core Framework\n- **Next.js 15.5.7** - React framework with App Router\n- **React 19.1.0** - UI library\n- **Tailwind CSS 4** - Utility-first CSS\n\n### Backend Services\n- **Firebase** - Authentication and Firestore database\n- **Supabase** - Object storage for images (no CDN transforms)\n- **MailerSend** - Email delivery service for ban/unban notifications\n- **ImageKit.io** - Active CDN for image optimization and transformations (WebP, resizing, quality)\n\n### Key Libraries\n- **@supabase/supabase-js** - Supabase client\n- **firebase** - Firebase client SDK (auth + firestore only)\n- **firebase-admin** - Firebase server SDK\n- **mailersend** - MailerSend email API client\n- **zod** - Schema validation\n- **server-only** - Ensure server-side only code\n- **date-fns** - Date formatting and manipulation\n\n---\n\n## Environment Variables\n\n**Configured on Vercel (NOT in Replit):**\n\n### Firebase\n- `NEXT_PUBLIC_FIREBASE_API_KEY`\n- `NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN`\n- `NEXT_PUBLIC_FIREBASE_PROJECT_ID`\n- `NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET`\n- `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID`\n- `NEXT_PUBLIC_FIREBASE_APP_ID`\n- `FIREBASE_SERVICE_ACCOUNT_KEY` (JSON string)\n\n### Supabase\n- `NEXT_PUBLIC_SUPABASE_URL`\n- `NEXT_PUBLIC_SUPABASE_ANON_KEY`\n- `SUPABASE_SERVICE_ROLE_KEY`\n\n### MailerSend (Email Service)\n- `MAILERSEND_API_KEY`\n- `NEXT_PUBLIC_BASE_URL` (for email links)\n\n### ImageKit.io (Active - Required)\n- `NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT` (required for all image transformations)\n\n---\n\n## Development Workflow\n\n1. **Code editing** - Done in Replit editor\n2. **Testing** - All testing on Vercel deployment (NOT locally)\n3. **Dependencies** - User installs manually (`npm install`)\n4. **Server** - User manages server execution (NOT agent)\n5. **Environment** - All env vars configured on Vercel\n\n**Important:** Replit is used ONLY for code editing, not for running/testing the application.\n\n---\n\n## Implementation Status Summary\n\n###  Fully Implemented Features\n\n**Core Campaign System:**\n- Campaign creation (frame + background)\n- 3-page visitor flow (upload  adjust  result)\n- Image composition with Canvas API\n- Campaign gallery and discovery\n- Top creators leaderboard\n\n**Admin Dashboard:**\n- Reports management with aggregated summaries and batch-optimized queries (96% faster)\n- Campaign moderation with status updates\n- User management with role assignment and bans\n- Platform analytics dashboard\n- Admin action audit logs with comprehensive tracking\n\n**Moderation System:**\n- Report submission (campaigns + profiles) with IP-based rate limiting\n- Auto-hide rules (3+ reports for campaigns, 10+ for profiles)\n- Admin actions: Dismiss, Warn, Remove/Ban (with typed confirmation for dangerous actions)\n- Warnings collection and tracking\n- Admin action logging for accountability and audit trail\n\n**Hybrid Notification System:**\n-  **In-App Notifications** (Firestore-based, no browser permissions required)\n  - Real-time delivery via Firestore listeners\n  - Notification templates for warnings, campaign removals, auto-hides\n  - In-app notification inbox at `/profile/notifications` (read/unread, filter, delete)\n  - Notification history saved to Firestore (`users/{userId}/notifications`)\n  - Foreground notification toasts (`NotificationToast.js`)\n  - NotificationBell with unread count\n  - NotificationProvider integrated in app layout\n  - useNotifications hook for real-time listeners\n\n-  **Email Notifications** (MailerSend-based)\n  - Used exclusively for ban/unban notifications\n  - Professional HTML templates with ban reasons and appeal deadlines\n  - Critical for banned users who cannot access their account\n  - Templates: accountBanned (temp/permanent), accountUnbanned\n  - Sent via `sendEmail.js` utility\n\n###  Deferred Features\n\n- Appeals system (user appeals for removed content/banned accounts)\n  - **Note:** Appeal deadlines are mentioned in notifications but no submission form exists yet\n- Admin warning history view in user details\n- Auto-deletion cron jobs (30-day appeal deadline enforcement)\n- Appeal deadline email reminders (7 days, 3 days, 1 day before deadline)\n\n---\n\n## Notes\n\n- All routes under `/admin` require admin role verification\n- All API routes under `/api/admin` protected by `requireAdmin()` middleware\n- Campaign images stored in Supabase at `campaigns/{userId}/{campaignId}.png`\n- Profile images stored in Supabase at `profiles/{userId}/{type}.{ext}`\n- Session data persists in sessionStorage with 24h expiry\n- Supabase CDN used for all image transformations (WebP, resizing)\n- Download tracking uses Firestore transactions to prevent race conditions\n- Username reservation uses dedicated collection for atomicity\n- In-app notifications saved to Firestore: `users/{userId}/notifications/{notificationId}`\n- Email notifications sent via MailerSend for ban/unban only\n- Admin action logs saved to Firestore: `adminLogs` collection\n- Report rate limits tracked in Firestore: `reportRateLimits` collection with 24h TTL\n- Report system uses aggregated `reportSummary` collection (not individual `reports` documents)\n- `ReportModal.js` handles both campaign and user/profile reports (universal component)\n- `ShareModal.js` handles both campaign and profile sharing (universal component)\n- `ConfirmationModal.js` supports typed confirmation (requires typing \"CONFIRM\") for dangerous actions\n\n---\n\n**End of Documentation**\n","path":null,"size_bytes":29079,"size_tokens":null},"src/data/countries.js":{"content":"// List of countries for dropdown selection\nexport const countries = [\n  { code: 'AF', name: 'Afghanistan' },\n  { code: 'AL', name: 'Albania' },\n  { code: 'DZ', name: 'Algeria' },\n  { code: 'AS', name: 'American Samoa' },\n  { code: 'AD', name: 'Andorra' },\n  { code: 'AO', name: 'Angola' },\n  { code: 'AI', name: 'Anguilla' },\n  { code: 'AQ', name: 'Antarctica' },\n  { code: 'AG', name: 'Antigua and Barbuda' },\n  { code: 'AR', name: 'Argentina' },\n  { code: 'AM', name: 'Armenia' },\n  { code: 'AW', name: 'Aruba' },\n  { code: 'AU', name: 'Australia' },\n  { code: 'AT', name: 'Austria' },\n  { code: 'AZ', name: 'Azerbaijan' },\n  { code: 'BS', name: 'Bahamas' },\n  { code: 'BH', name: 'Bahrain' },\n  { code: 'BD', name: 'Bangladesh' },\n  { code: 'BB', name: 'Barbados' },\n  { code: 'BY', name: 'Belarus' },\n  { code: 'BE', name: 'Belgium' },\n  { code: 'BZ', name: 'Belize' },\n  { code: 'BJ', name: 'Benin' },\n  { code: 'BM', name: 'Bermuda' },\n  { code: 'BT', name: 'Bhutan' },\n  { code: 'BO', name: 'Bolivia' },\n  { code: 'BA', name: 'Bosnia and Herzegovina' },\n  { code: 'BW', name: 'Botswana' },\n  { code: 'BV', name: 'Bouvet Island' },\n  { code: 'BR', name: 'Brazil' },\n  { code: 'IO', name: 'British Indian Ocean Territory' },\n  { code: 'BN', name: 'Brunei Darussalam' },\n  { code: 'BG', name: 'Bulgaria' },\n  { code: 'BF', name: 'Burkina Faso' },\n  { code: 'BI', name: 'Burundi' },\n  { code: 'KH', name: 'Cambodia' },\n  { code: 'CM', name: 'Cameroon' },\n  { code: 'CA', name: 'Canada' },\n  { code: 'CV', name: 'Cape Verde' },\n  { code: 'KY', name: 'Cayman Islands' },\n  { code: 'CF', name: 'Central African Republic' },\n  { code: 'TD', name: 'Chad' },\n  { code: 'CL', name: 'Chile' },\n  { code: 'CN', name: 'China' },\n  { code: 'CX', name: 'Christmas Island' },\n  { code: 'CC', name: 'Cocos (Keeling) Islands' },\n  { code: 'CO', name: 'Colombia' },\n  { code: 'KM', name: 'Comoros' },\n  { code: 'CG', name: 'Congo' },\n  { code: 'CD', name: 'Congo, Democratic Republic' },\n  { code: 'CK', name: 'Cook Islands' },\n  { code: 'CR', name: 'Costa Rica' },\n  { code: 'CI', name: 'Cote D\\'Ivoire' },\n  { code: 'HR', name: 'Croatia' },\n  { code: 'CU', name: 'Cuba' },\n  { code: 'CY', name: 'Cyprus' },\n  { code: 'CZ', name: 'Czech Republic' },\n  { code: 'DK', name: 'Denmark' },\n  { code: 'DJ', name: 'Djibouti' },\n  { code: 'DM', name: 'Dominica' },\n  { code: 'DO', name: 'Dominican Republic' },\n  { code: 'EC', name: 'Ecuador' },\n  { code: 'EG', name: 'Egypt' },\n  { code: 'SV', name: 'El Salvador' },\n  { code: 'GQ', name: 'Equatorial Guinea' },\n  { code: 'ER', name: 'Eritrea' },\n  { code: 'EE', name: 'Estonia' },\n  { code: 'ET', name: 'Ethiopia' },\n  { code: 'FK', name: 'Falkland Islands (Malvinas)' },\n  { code: 'FO', name: 'Faroe Islands' },\n  { code: 'FJ', name: 'Fiji' },\n  { code: 'FI', name: 'Finland' },\n  { code: 'FR', name: 'France' },\n  { code: 'GF', name: 'French Guiana' },\n  { code: 'PF', name: 'French Polynesia' },\n  { code: 'TF', name: 'French Southern Territories' },\n  { code: 'GA', name: 'Gabon' },\n  { code: 'GM', name: 'Gambia' },\n  { code: 'GE', name: 'Georgia' },\n  { code: 'DE', name: 'Germany' },\n  { code: 'GH', name: 'Ghana' },\n  { code: 'GI', name: 'Gibraltar' },\n  { code: 'GR', name: 'Greece' },\n  { code: 'GL', name: 'Greenland' },\n  { code: 'GD', name: 'Grenada' },\n  { code: 'GP', name: 'Guadeloupe' },\n  { code: 'GU', name: 'Guam' },\n  { code: 'GT', name: 'Guatemala' },\n  { code: 'GG', name: 'Guernsey' },\n  { code: 'GN', name: 'Guinea' },\n  { code: 'GW', name: 'Guinea-Bissau' },\n  { code: 'GY', name: 'Guyana' },\n  { code: 'HT', name: 'Haiti' },\n  { code: 'HM', name: 'Heard Island and Mcdonald Islands' },\n  { code: 'VA', name: 'Holy See (Vatican City State)' },\n  { code: 'HN', name: 'Honduras' },\n  { code: 'HK', name: 'Hong Kong' },\n  { code: 'HU', name: 'Hungary' },\n  { code: 'IS', name: 'Iceland' },\n  { code: 'IN', name: 'India' },\n  { code: 'ID', name: 'Indonesia' },\n  { code: 'IR', name: 'Iran, Islamic Republic Of' },\n  { code: 'IQ', name: 'Iraq' },\n  { code: 'IE', name: 'Ireland' },\n  { code: 'IM', name: 'Isle of Man' },\n  { code: 'IL', name: 'Israel' },\n  { code: 'IT', name: 'Italy' },\n  { code: 'JM', name: 'Jamaica' },\n  { code: 'JP', name: 'Japan' },\n  { code: 'JE', name: 'Jersey' },\n  { code: 'JO', name: 'Jordan' },\n  { code: 'KZ', name: 'Kazakhstan' },\n  { code: 'KE', name: 'Kenya' },\n  { code: 'KI', name: 'Kiribati' },\n  { code: 'KP', name: 'Korea, Democratic People\\'s Republic of' },\n  { code: 'KR', name: 'Korea, Republic of' },\n  { code: 'KW', name: 'Kuwait' },\n  { code: 'KG', name: 'Kyrgyzstan' },\n  { code: 'LA', name: 'Lao People\\'s Democratic Republic' },\n  { code: 'LV', name: 'Latvia' },\n  { code: 'LB', name: 'Lebanon' },\n  { code: 'LS', name: 'Lesotho' },\n  { code: 'LR', name: 'Liberia' },\n  { code: 'LY', name: 'Libyan Arab Jamahiriya' },\n  { code: 'LI', name: 'Liechtenstein' },\n  { code: 'LT', name: 'Lithuania' },\n  { code: 'LU', name: 'Luxembourg' },\n  { code: 'MO', name: 'Macao' },\n  { code: 'MK', name: 'Macedonia, The Former Yugoslav Republic of' },\n  { code: 'MG', name: 'Madagascar' },\n  { code: 'MW', name: 'Malawi' },\n  { code: 'MY', name: 'Malaysia' },\n  { code: 'MV', name: 'Maldives' },\n  { code: 'ML', name: 'Mali' },\n  { code: 'MT', name: 'Malta' },\n  { code: 'MH', name: 'Marshall Islands' },\n  { code: 'MQ', name: 'Martinique' },\n  { code: 'MR', name: 'Mauritania' },\n  { code: 'MU', name: 'Mauritius' },\n  { code: 'YT', name: 'Mayotte' },\n  { code: 'MX', name: 'Mexico' },\n  { code: 'FM', name: 'Micronesia, Federated States of' },\n  { code: 'MD', name: 'Moldova, Republic of' },\n  { code: 'MC', name: 'Monaco' },\n  { code: 'MN', name: 'Mongolia' },\n  { code: 'ME', name: 'Montenegro' },\n  { code: 'MS', name: 'Montserrat' },\n  { code: 'MA', name: 'Morocco' },\n  { code: 'MZ', name: 'Mozambique' },\n  { code: 'MM', name: 'Myanmar' },\n  { code: 'NA', name: 'Namibia' },\n  { code: 'NR', name: 'Nauru' },\n  { code: 'NP', name: 'Nepal' },\n  { code: 'NL', name: 'Netherlands' },\n  { code: 'AN', name: 'Netherlands Antilles' },\n  { code: 'NC', name: 'New Caledonia' },\n  { code: 'NZ', name: 'New Zealand' },\n  { code: 'NI', name: 'Nicaragua' },\n  { code: 'NE', name: 'Niger' },\n  { code: 'NG', name: 'Nigeria' },\n  { code: 'NU', name: 'Niue' },\n  { code: 'NF', name: 'Norfolk Island' },\n  { code: 'MP', name: 'Northern Mariana Islands' },\n  { code: 'NO', name: 'Norway' },\n  { code: 'OM', name: 'Oman' },\n  { code: 'PK', name: 'Pakistan' },\n  { code: 'PW', name: 'Palau' },\n  { code: 'PS', name: 'Palestinian Territory, Occupied' },\n  { code: 'PA', name: 'Panama' },\n  { code: 'PG', name: 'Papua New Guinea' },\n  { code: 'PY', name: 'Paraguay' },\n  { code: 'PE', name: 'Peru' },\n  { code: 'PH', name: 'Philippines' },\n  { code: 'PN', name: 'Pitcairn' },\n  { code: 'PL', name: 'Poland' },\n  { code: 'PT', name: 'Portugal' },\n  { code: 'PR', name: 'Puerto Rico' },\n  { code: 'QA', name: 'Qatar' },\n  { code: 'RE', name: 'Reunion' },\n  { code: 'RO', name: 'Romania' },\n  { code: 'RU', name: 'Russian Federation' },\n  { code: 'RW', name: 'Rwanda' },\n  { code: 'BL', name: 'Saint Barthelemy' },\n  { code: 'SH', name: 'Saint Helena' },\n  { code: 'KN', name: 'Saint Kitts and Nevis' },\n  { code: 'LC', name: 'Saint Lucia' },\n  { code: 'MF', name: 'Saint Martin' },\n  { code: 'PM', name: 'Saint Pierre and Miquelon' },\n  { code: 'VC', name: 'Saint Vincent and the Grenadines' },\n  { code: 'WS', name: 'Samoa' },\n  { code: 'SM', name: 'San Marino' },\n  { code: 'ST', name: 'Sao Tome and Principe' },\n  { code: 'SA', name: 'Saudi Arabia' },\n  { code: 'SN', name: 'Senegal' },\n  { code: 'RS', name: 'Serbia' },\n  { code: 'SC', name: 'Seychelles' },\n  { code: 'SL', name: 'Sierra Leone' },\n  { code: 'SG', name: 'Singapore' },\n  { code: 'SK', name: 'Slovakia' },\n  { code: 'SI', name: 'Slovenia' },\n  { code: 'SB', name: 'Solomon Islands' },\n  { code: 'SO', name: 'Somalia' },\n  { code: 'ZA', name: 'South Africa' },\n  { code: 'GS', name: 'South Georgia and the South Sandwich Islands' },\n  { code: 'ES', name: 'Spain' },\n  { code: 'LK', name: 'Sri Lanka' },\n  { code: 'SD', name: 'Sudan' },\n  { code: 'SR', name: 'Suriname' },\n  { code: 'SJ', name: 'Svalbard and Jan Mayen' },\n  { code: 'SZ', name: 'Swaziland' },\n  { code: 'SE', name: 'Sweden' },\n  { code: 'CH', name: 'Switzerland' },\n  { code: 'SY', name: 'Syrian Arab Republic' },\n  { code: 'TW', name: 'Taiwan' },\n  { code: 'TJ', name: 'Tajikistan' },\n  { code: 'TZ', name: 'Tanzania, United Republic of' },\n  { code: 'TH', name: 'Thailand' },\n  { code: 'TL', name: 'Timor-Leste' },\n  { code: 'TG', name: 'Togo' },\n  { code: 'TK', name: 'Tokelau' },\n  { code: 'TO', name: 'Tonga' },\n  { code: 'TT', name: 'Trinidad and Tobago' },\n  { code: 'TN', name: 'Tunisia' },\n  { code: 'TR', name: 'Turkey' },\n  { code: 'TM', name: 'Turkmenistan' },\n  { code: 'TC', name: 'Turks and Caicos Islands' },\n  { code: 'TV', name: 'Tuvalu' },\n  { code: 'UG', name: 'Uganda' },\n  { code: 'UA', name: 'Ukraine' },\n  { code: 'AE', name: 'United Arab Emirates' },\n  { code: 'GB', name: 'United Kingdom' },\n  { code: 'US', name: 'United States' },\n  { code: 'UM', name: 'United States Minor Outlying Islands' },\n  { code: 'UY', name: 'Uruguay' },\n  { code: 'UZ', name: 'Uzbekistan' },\n  { code: 'VU', name: 'Vanuatu' },\n  { code: 'VE', name: 'Venezuela' },\n  { code: 'VN', name: 'Viet Nam' },\n  { code: 'VG', name: 'Virgin Islands, British' },\n  { code: 'VI', name: 'Virgin Islands, U.S.' },\n  { code: 'WF', name: 'Wallis and Futuna' },\n  { code: 'EH', name: 'Western Sahara' },\n  { code: 'YE', name: 'Yemen' },\n  { code: 'ZM', name: 'Zambia' },\n  { code: 'ZW', name: 'Zimbabwe' }\n];","path":null,"size_bytes":9599,"size_tokens":null},"src/app/api/admin/campaigns/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\n\nexport async function GET(request) {\n  try {\n    await requireAdmin(request);\n    \n    const { searchParams } = new URL(request.url);\n    const moderationStatus = searchParams.get('moderationStatus');\n    const sortBy = searchParams.get('sortBy') || 'createdAt';\n    const limitParam = searchParams.get('limit') || '50';\n    const limitValue = parseInt(limitParam, 10);\n    \n    const db = adminFirestore();\n    let campaignsQuery = db.collection('campaigns');\n    \n    if (moderationStatus && moderationStatus !== 'all') {\n      campaignsQuery = campaignsQuery.where('moderationStatus', '==', moderationStatus);\n    }\n    \n    switch (sortBy) {\n      case 'reports':\n        campaignsQuery = campaignsQuery.orderBy('reportsCount', 'desc');\n        break;\n      case 'supporters':\n        campaignsQuery = campaignsQuery.orderBy('supportersCount', 'desc');\n        break;\n      case 'createdAt':\n      default:\n        campaignsQuery = campaignsQuery.orderBy('createdAt', 'desc');\n        break;\n    }\n    \n    campaignsQuery = campaignsQuery.limit(limitValue);\n    \n    const campaignsSnapshot = await campaignsQuery.get();\n    \n    const campaigns = [];\n    \n    for (const doc of campaignsSnapshot.docs) {\n      const campaignData = { id: doc.id, ...doc.data() };\n      \n      if (campaignData.creatorId) {\n        const creatorDoc = await db.collection('users').doc(campaignData.creatorId).get();\n        if (creatorDoc.exists) {\n          const creatorData = creatorDoc.data();\n          campaignData.creator = {\n            uid: creatorDoc.id,\n            displayName: creatorData.displayName,\n            username: creatorData.username,\n            profileImage: creatorData.profileImage,\n          };\n        } else {\n          campaignData.creator = {\n            uid: campaignData.creatorId,\n            displayName: '[Deleted User]',\n            username: null,\n            profileImage: null,\n          };\n        }\n      }\n      \n      if (campaignData.createdAt && campaignData.createdAt.toDate) {\n        campaignData.createdAt = campaignData.createdAt.toDate().toISOString();\n      }\n      if (campaignData.updatedAt && campaignData.updatedAt.toDate) {\n        campaignData.updatedAt = campaignData.updatedAt.toDate().toISOString();\n      }\n      if (campaignData.firstUsedAt && campaignData.firstUsedAt.toDate) {\n        campaignData.firstUsedAt = campaignData.firstUsedAt.toDate().toISOString();\n      }\n      \n      campaigns.push(campaignData);\n    }\n    \n    return NextResponse.json({\n      success: true,\n      data: campaigns,\n      count: campaigns.length,\n    });\n  } catch (error) {\n    console.error('Error fetching campaigns:', error);\n    \n    if (error.message.includes('Unauthorized') || error.message.includes('Admin access required')) {\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 403 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to fetch campaigns' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":3178,"size_tokens":null},"src/app/analytics.js":{"content":"'use client';\n\nimport { usePathname, useSearchParams } from 'next/navigation';\nimport { useEffect } from 'react';\n\nexport default function Analytics() {\n  const pathname = usePathname();\n  const searchParams = useSearchParams();\n\n  useEffect(() => {\n    const gaId = process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID;\n    \n    if (!gaId) {\n      return;\n    }\n\n    const url = pathname + (searchParams.toString() ? `?${searchParams.toString()}` : '');\n    \n    if (window.gtag) {\n      window.gtag('config', gaId, {\n        page_path: url,\n      });\n    }\n  }, [pathname, searchParams]);\n\n  return null;\n}\n","path":null,"size_bytes":598,"size_tokens":null},"src/components/PageLoader.js":{"content":"'use client';\n\nimport LoadingSpinner from './LoadingSpinner';\n\nexport default function PageLoader({ message = 'Loading...', className = '' }) {\n  return (\n    <div className={`min-h-screen bg-white flex items-center justify-center ${className}`}>\n      <div className=\"text-center\">\n        <LoadingSpinner size=\"lg\" className=\"mx-auto mb-4\" />\n        <p className=\"text-gray-600 text-lg\">{message}</p>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":434,"size_tokens":null},"src/components/ConditionalLayout.js":{"content":"\"use client\";\n\nimport { usePathname } from 'next/navigation';\nimport { useState } from 'react';\nimport Header from './Header';\nimport Footer from './Footer';\nimport MobileMenu from './MobileMenu';\nimport { useLayoutVisibility } from './LayoutVisibilityContext';\n\n// Pages where header/footer should NOT be shown\nconst EXCLUDED_PAGES = [\n  '/signin',\n  '/signup',\n  '/forgot-password',\n  '/onboarding',\n  '/verify-email'\n];\n\nexport default function ConditionalLayout({ children }) {\n  const pathname = usePathname();\n  const [isMenuOpen, setIsMenuOpen] = useState(false);\n  const { hideChrome } = useLayoutVisibility();\n  \n  // Check if current page should exclude header/footer\n  const shouldExcludeLayout = hideChrome || \n    EXCLUDED_PAGES.includes(pathname) || \n    pathname.startsWith('/admin');\n  \n  // If layout should be excluded, just return children\n  if (shouldExcludeLayout) {\n    return children;\n  }\n  \n  // Show header/footer for all other pages\n  return (\n    <div className=\"min-h-screen flex flex-col relative\">\n      {/* Main Content with blur effect */}\n      <div className={`min-h-screen flex flex-col transition-all duration-300 ${\n        isMenuOpen ? 'blur-sm' : ''\n      }`}>\n        <Header isMenuOpen={isMenuOpen} setIsMenuOpen={setIsMenuOpen} />\n        <main className=\"flex-1\">\n          {children}\n        </main>\n        <Footer />\n      </div>\n\n      {/* Mobile Menu Component */}\n      <MobileMenu \n        isMenuOpen={isMenuOpen}\n        setIsMenuOpen={setIsMenuOpen}\n      />\n    </div>\n  );\n}","path":null,"size_bytes":1529,"size_tokens":null},"src/app/api/campaigns/track-download/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { adminFirestore } from '../../../../lib/firebaseAdmin';\nimport { FieldValue } from 'firebase-admin/firestore';\n\nexport async function POST(request) {\n  try {\n    const body = await request.json();\n    const { campaignId } = body;\n    \n    // Validate required field\n    if (!campaignId) {\n      return NextResponse.json(\n        { success: false, error: 'Campaign ID is required' },\n        { status: 400 }\n      );\n    }\n    \n    // Get Firestore instance\n    const db = adminFirestore();\n    \n    // Run transaction to update campaign supports count\n    const result = await db.runTransaction(async (transaction) => {\n      // Get campaign document\n      const campaignRef = db.collection('campaigns').doc(campaignId);\n      const campaignDoc = await transaction.get(campaignRef);\n      \n      if (!campaignDoc.exists) {\n        throw new Error('Campaign not found');\n      }\n      \n      const campaignData = campaignDoc.data();\n      \n      // Create a download record in subcollection with timestamp\n      const downloadRef = db.collection('campaigns').doc(campaignId).collection('downloads').doc();\n      transaction.set(downloadRef, {\n        downloadedAt: FieldValue.serverTimestamp(),\n        createdAt: FieldValue.serverTimestamp()\n      });\n      \n      // Update campaign supportersCount (tracks total downloads/supports)\n      transaction.update(campaignRef, {\n        supportersCount: FieldValue.increment(1),\n        updatedAt: FieldValue.serverTimestamp(),\n        // Set firstUsedAt on first download\n        ...(campaignData.supportersCount === 0 ? { firstUsedAt: FieldValue.serverTimestamp() } : {})\n      });\n      \n      return {\n        success: true\n      };\n    });\n    \n    return NextResponse.json(result);\n  } catch (error) {\n    console.error('Error tracking download:', error);\n    \n    // Return appropriate error message\n    if (error.message === 'Campaign not found') {\n      return NextResponse.json(\n        { success: false, error: 'Campaign not found' },\n        { status: 404 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to track download' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":2213,"size_tokens":null},"src/app/api/admin/reports/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\n\nexport async function GET(request) {\n  try {\n    await requireAdmin(request);\n    \n    const { searchParams } = new URL(request.url);\n    const status = searchParams.get('status');\n    const targetType = searchParams.get('type');\n    const campaignId = searchParams.get('campaignId');\n    const limitParam = searchParams.get('limit') || '50';\n    const limitValue = parseInt(limitParam, 10);\n    \n    const db = adminFirestore();\n    let summariesQuery = db.collection('reportSummary');\n    \n    if (status && status !== 'all') {\n      summariesQuery = summariesQuery.where('status', '==', status);\n    }\n    \n    if (targetType && targetType !== 'all') {\n      summariesQuery = summariesQuery.where('targetType', '==', targetType);\n    }\n    \n    if (campaignId) {\n      const summaryId = `campaign-${campaignId}`;\n      summariesQuery = summariesQuery.where('__name__', '==', summaryId);\n    }\n    \n    summariesQuery = summariesQuery.orderBy('lastReportedAt', 'desc').limit(limitValue);\n    \n    const summariesSnapshot = await summariesQuery.get();\n    \n    const summaries = [];\n    \n    for (const doc of summariesSnapshot.docs) {\n      const summaryData = { id: doc.id, ...doc.data() };\n      \n      if (summaryData.targetId) {\n        const targetCollection = summaryData.targetType === 'campaign' ? 'campaigns' : 'users';\n        const targetDoc = await db.collection(targetCollection).doc(summaryData.targetId).get();\n        \n        if (targetDoc.exists) {\n          const targetData = targetDoc.data();\n          \n          if (summaryData.targetType === 'campaign') {\n            summaryData.moderationStatus = targetData.moderationStatus || 'active';\n            summaryData.campaignTitle = targetData.title || summaryData.campaignTitle;\n            summaryData.campaignImage = targetData.imageUrl || summaryData.campaignImage;\n            summaryData.campaignSlug = targetData.slug || summaryData.campaignSlug;\n            \n            if (summaryData.creatorId) {\n              const creatorDoc = await db.collection('users').doc(summaryData.creatorId).get();\n              if (creatorDoc.exists) {\n                const creatorData = creatorDoc.data();\n                summaryData.creator = {\n                  uid: creatorDoc.id,\n                  displayName: creatorData.displayName,\n                  username: creatorData.username,\n                  profileImage: creatorData.profileImage,\n                };\n              }\n            }\n          } else {\n            summaryData.accountStatus = targetData.accountStatus || 'active';\n            summaryData.displayName = targetData.displayName || summaryData.displayName;\n            summaryData.username = targetData.username || summaryData.username;\n            summaryData.profileImage = targetData.profileImage || summaryData.profileImage;\n          }\n        } else {\n          summaryData.targetDeleted = true;\n          if (summaryData.targetType === 'campaign') {\n            summaryData.moderationStatus = 'deleted';\n          } else {\n            summaryData.accountStatus = 'deleted';\n          }\n        }\n      }\n      \n      if (summaryData.firstReportedAt && summaryData.firstReportedAt.toDate) {\n        summaryData.firstReportedAt = summaryData.firstReportedAt.toDate().toISOString();\n      }\n      if (summaryData.lastReportedAt && summaryData.lastReportedAt.toDate) {\n        summaryData.lastReportedAt = summaryData.lastReportedAt.toDate().toISOString();\n      }\n      if (summaryData.createdAt && summaryData.createdAt.toDate) {\n        summaryData.createdAt = summaryData.createdAt.toDate().toISOString();\n      }\n      if (summaryData.updatedAt && summaryData.updatedAt.toDate) {\n        summaryData.updatedAt = summaryData.updatedAt.toDate().toISOString();\n      }\n      \n      summaries.push(summaryData);\n    }\n    \n    return NextResponse.json({\n      success: true,\n      data: summaries,\n      count: summaries.length,\n    });\n  } catch (error) {\n    console.error('Error fetching report summaries:', error);\n    \n    if (error.message.includes('Unauthorized') || error.message.includes('Admin access required')) {\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 403 }\n      );\n    }\n    \n    // Handle Firestore index errors (FAILED_PRECONDITION)\n    if (error.code === 9 || error.message.includes('index') || error.message.includes('FAILED_PRECONDITION')) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Firestore indexes are still building. Please wait a few minutes and try again. If the issue persists, check Firebase Console for index status.',\n          indexError: true\n        },\n        { status: 503 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to fetch report summaries' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":5020,"size_tokens":null},"src/app/(chrome)/u/[username]/page.js":{"content":"// User profile route with /u/ prefix to avoid conflicts\nimport ProfilePage from \"../../../../components/ProfilePage\";\n\nexport async function generateMetadata({ params }) {\n  const { username } = await params;\n  return {\n    title: `@${username} - Frame Your Voice`,\n    description: `View ${username}'s profile and campaigns`,\n  };\n}\n\nexport default async function UserProfile({ params }) {\n  const { username } = await params;\n  \n  return (\n    <ProfilePage isOwnProfile={false} username={username} />\n  );\n}","path":null,"size_bytes":510,"size_tokens":null},"src/components/CreateCampaignModal.js":{"content":"\"use client\";\n\nimport { useRouter } from 'next/navigation';\nimport { useEffect } from 'react';\nimport { useBodyScrollLock } from '../hooks/useBodyScrollLock';\n\nexport default function CreateCampaignModal({ isOpen, onClose }) {\n  const router = useRouter();\n\n  // Lock body scroll when modal is open\n  useBodyScrollLock(isOpen);\n\n  // Close modal on escape key\n  useEffect(() => {\n    const handleEscape = (e) => {\n      if (e.key === 'Escape') onClose(false);\n    };\n    if (isOpen) {\n      document.addEventListener('keydown', handleEscape);\n    }\n    return () => {\n      document.removeEventListener('keydown', handleEscape);\n    };\n  }, [isOpen, onClose]);\n\n  if (!isOpen) return null;\n\n  const handleCreateFrame = () => {\n    onClose(true);\n    router.push('/create/frame');\n  };\n\n  const handleCreateBackground = () => {\n    onClose(true);\n    router.push('/create/background');\n  };\n\n  const handleDismiss = () => {\n    onClose(false);\n  };\n\n  return (\n    <>\n      {/* Backdrop */}\n      <div \n        className=\"fixed inset-0 bg-black/50 z-50 transition-opacity\"\n        onClick={handleDismiss}\n      />\n      \n      {/* Modal */}\n      <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\n        <div \n          className=\"bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-hidden shadow-lg\"\n          onClick={(e) => e.stopPropagation()}\n        >\n          {/* Header - Yellow background like onboarding/profile pages */}\n          <div className=\"bg-yellow-400 px-6 py-6 relative rounded-t-xl\">\n            <div className=\"text-center\">\n              <h2 className=\"text-2xl sm:text-3xl font-bold text-emerald-700\">\n                Create Campaign\n              </h2>\n              <p className=\"text-base sm:text-lg text-gray-700 mt-1\">\n                Choose the type of campaign you want to create\n              </p>\n            </div>\n            <button\n              onClick={handleDismiss}\n              className=\"absolute top-4 right-4 btn-base p-2 hover:bg-yellow-500 rounded-full transition-colors\"\n            >\n              <svg className=\"w-5 h-5 text-gray-700\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n              </svg>\n            </button>\n          </div>\n\n          {/* Content - White background with border */}\n          <div className=\"bg-white border-t-0 border-gray-200 px-6 py-8 rounded-b-xl overflow-y-auto max-h-[calc(90vh-120px)]\">\n            \n            {/* Options Grid */}\n            <div className=\"grid sm:grid-cols-2 gap-4\">\n              \n              {/* Frame Option */}\n              <button\n                onClick={handleCreateFrame}\n                className=\"text-left bg-white border-2 border-gray-200 hover:border-emerald-500 rounded-xl p-5 transition-all hover:shadow-md group\"\n              >\n                <div className=\"flex items-start gap-3 mb-3\">\n                  <div className=\"w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center flex-shrink-0 group-hover:bg-emerald-500 transition-colors\">\n                    <svg className=\"w-5 h-5 text-emerald-600 group-hover:text-white transition-colors\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n                    </svg>\n                  </div>\n                  <div className=\"flex-1\">\n                    <h3 className=\"text-lg font-semibold text-gray-900 mb-1\">Frame</h3>\n                    <p className=\"text-sm text-gray-600 mb-3\">\n                      Photo overlay with transparent areas\n                    </p>\n                  </div>\n                </div>\n                \n                <ul className=\"space-y-1.5\">\n                  <li className=\"flex items-center text-xs text-gray-600\">\n                    <svg className=\"w-4 h-4 text-emerald-600 mr-2 flex-shrink-0\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                      <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clipRule=\"evenodd\" />\n                    </svg>\n                    PNG with transparency\n                  </li>\n                  <li className=\"flex items-center text-xs text-gray-600\">\n                    <svg className=\"w-4 h-4 text-emerald-600 mr-2 flex-shrink-0\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                      <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clipRule=\"evenodd\" />\n                    </svg>\n                    Photo behind frame\n                  </li>\n                </ul>\n              </button>\n\n              {/* Background Option */}\n              <button\n                onClick={handleCreateBackground}\n                className=\"text-left bg-white border-2 border-gray-200 hover:border-emerald-500 rounded-xl p-5 transition-all hover:shadow-md group\"\n              >\n                <div className=\"flex items-start gap-3 mb-3\">\n                  <div className=\"w-10 h-10 bg-emerald-100 rounded-lg flex items-center justify-center flex-shrink-0 group-hover:bg-emerald-500 transition-colors\">\n                    <svg className=\"w-5 h-5 text-emerald-600 group-hover:text-white transition-colors\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01\" />\n                    </svg>\n                  </div>\n                  <div className=\"flex-1\">\n                    <h3 className=\"text-lg font-semibold text-gray-900 mb-1\">Background</h3>\n                    <p className=\"text-sm text-gray-600 mb-3\">\n                      Solid image behind photo\n                    </p>\n                  </div>\n                </div>\n                \n                <ul className=\"space-y-1.5\">\n                  <li className=\"flex items-center text-xs text-gray-600\">\n                    <svg className=\"w-4 h-4 text-emerald-600 mr-2 flex-shrink-0\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                      <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clipRule=\"evenodd\" />\n                    </svg>\n                    PNG, JPG, or WEBP\n                  </li>\n                  <li className=\"flex items-center text-xs text-gray-600\">\n                    <svg className=\"w-4 h-4 text-emerald-600 mr-2 flex-shrink-0\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                      <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clipRule=\"evenodd\" />\n                    </svg>\n                    Photo on top\n                  </li>\n                </ul>\n              </button>\n\n            </div>\n\n            {/* Help Text */}\n            <p className=\"text-xs text-gray-500 text-center mt-6\">\n              Frames have transparent areas for photos  Backgrounds go behind photos\n            </p>\n          </div>\n        </div>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":7719,"size_tokens":null},"src/app/api/admin/users/[userId]/ban/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\nimport { FieldValue } from 'firebase-admin/firestore';\nimport { validateAccountTransition } from '@/utils/admin/statusTransitionValidator';\n\nexport async function PATCH(request, { params }) {\n  try {\n    const adminUser = await requireAdmin(request);\n    \n    const { userId } = params;\n    const body = await request.json();\n    const { accountStatus, banReason } = body;\n    \n    const validStatuses = ['active', 'under-review', 'under-review-hidden', 'banned-temporary', 'banned-permanent'];\n    if (!accountStatus || !validStatuses.includes(accountStatus)) {\n      return NextResponse.json(\n        { success: false, error: 'Account status must be: active, under-review, under-review-hidden, banned-temporary, or banned-permanent' },\n        { status: 400 }\n      );\n    }\n    \n    if ((accountStatus === 'banned-temporary' || accountStatus === 'banned-permanent') && !banReason) {\n      return NextResponse.json(\n        { success: false, error: 'Ban reason is required when banning a user' },\n        { status: 400 }\n      );\n    }\n    \n    if (!userId) {\n      return NextResponse.json(\n        { success: false, error: 'User ID is required' },\n        { status: 400 }\n      );\n    }\n    \n    const db = adminFirestore();\n    const userRef = db.collection('users').doc(userId);\n    const userDoc = await userRef.get();\n    \n    if (!userDoc.exists) {\n      return NextResponse.json(\n        { success: false, error: 'User not found' },\n        { status: 404 }\n      );\n    }\n    \n    const userData = userDoc.data();\n    const currentStatus = userData.accountStatus || 'active';\n    \n    // Validate status transition if accountStatus is being changed\n    if (accountStatus) {\n      const validation = validateAccountTransition(currentStatus, accountStatus);\n      if (!validation.valid) {\n        return NextResponse.json(\n          { success: false, error: validation.error },\n          { status: 400 }\n        );\n      }\n    }\n    \n    const updateData = {\n      accountStatus: accountStatus,\n      updatedAt: FieldValue.serverTimestamp(),\n    };\n    \n    if (accountStatus === 'banned-temporary' || accountStatus === 'banned-permanent') {\n      updateData.banReason = banReason;\n      updateData.bannedBy = adminUser.uid;\n      updateData.bannedAt = FieldValue.serverTimestamp();\n      \n      if (accountStatus === 'banned-temporary') {\n        const appealDeadline = new Date();\n        appealDeadline.setDate(appealDeadline.getDate() + 30);\n        updateData.appealDeadline = appealDeadline;\n      } else if (accountStatus === 'banned-permanent') {\n        // Clear temporary-only fields when setting to permanent\n        updateData.appealDeadline = FieldValue.delete();\n      }\n    } else {\n      updateData.banReason = FieldValue.delete();\n      updateData.bannedBy = FieldValue.delete();\n      updateData.bannedAt = FieldValue.delete();\n      updateData.appealDeadline = FieldValue.delete();\n    }\n    \n    await userRef.update(updateData);\n    \n    const updatedDoc = await userRef.get();\n    const updatedData = { id: updatedDoc.id, ...updatedDoc.data() };\n    \n    // Send email notification for ban/unban actions\n    try {\n      const userData = userDoc.data();\n      \n      if (userData?.email) {\n        const { sendEmail } = await import('@/utils/notifications/sendEmail');\n        const { getEmailTemplate } = await import('@/utils/notifications/emailTemplates');\n        \n        if (accountStatus === 'banned-temporary' || accountStatus === 'banned-permanent') {\n          // User is being banned - send ban email\n          const isPermanent = accountStatus === 'banned-permanent';\n          const appealDeadline = isPermanent ? null : new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);\n          const formattedDeadline = isPermanent ? null : appealDeadline.toLocaleDateString('en-US', { \n            year: 'numeric', \n            month: 'long', \n            day: 'numeric' \n          });\n          \n          const emailTemplate = getEmailTemplate('accountBanned', {\n            userEmail: userData.email,\n            username: userData.displayName || userData.username || userData.email,\n            banReason: banReason,\n            appealDeadline: formattedDeadline,\n            isPermanent: isPermanent,\n          });\n          \n          await sendEmail({\n            to: userData.email,\n            subject: emailTemplate.subject,\n            html: emailTemplate.html,\n          });\n          \n          if (process.env.NODE_ENV === 'development') {\n            console.log('[BAN] Ban email sent to:', userData.email);\n          }\n        } else if (accountStatus === 'active' && (userDoc.data().accountStatus === 'banned-temporary' || userDoc.data().accountStatus === 'banned-permanent')) {\n          // User is being unbanned - send unban email\n          const emailTemplate = getEmailTemplate('accountUnbanned', {\n            userEmail: userData.email,\n            username: userData.displayName || userData.username || userData.email,\n          });\n          \n          await sendEmail({\n            to: userData.email,\n            subject: emailTemplate.subject,\n            html: emailTemplate.html,\n          });\n          \n          if (process.env.NODE_ENV === 'development') {\n            console.log('[UNBAN] Unban email sent to:', userData.email);\n          }\n        }\n      }\n    } catch (emailError) {\n      // Don't fail the entire request if email fails - just log it\n      console.error('[EMAIL] Failed to send ban/unban email:', emailError);\n    }\n    \n    if (updatedData.createdAt && updatedData.createdAt.toDate) {\n      updatedData.createdAt = updatedData.createdAt.toDate().toISOString();\n    }\n    if (updatedData.updatedAt && updatedData.updatedAt.toDate) {\n      updatedData.updatedAt = updatedData.updatedAt.toDate().toISOString();\n    }\n    if (updatedData.bannedAt && updatedData.bannedAt.toDate) {\n      updatedData.bannedAt = updatedData.bannedAt.toDate().toISOString();\n    }\n    \n    return NextResponse.json({\n      success: true,\n      message: accountStatus === 'active' ? 'User unbanned successfully' : `User ${accountStatus.replace('-', ' ')} successfully`,\n      data: updatedData,\n    });\n  } catch (error) {\n    console.error('Error updating user ban status:', error);\n    \n    if (error.message.includes('Unauthorized') || error.message.includes('Admin access required')) {\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 403 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to update user ban status' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":6763,"size_tokens":null},"src/app/verify-email/page.js":{"content":"'use client';\n\nimport { useEffect, useRef } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { useAuth } from '../../hooks/useAuth';\nimport EmailVerification from '../../components/EmailVerification';\nimport PageLoader from '../../components/PageLoader';\n\nexport default function VerifyEmailPage() {\n  const router = useRouter();\n  const { user, loading, pendingSignupUserId, logoutInProgress } = useAuth();\n  const safetyTimeoutRef = useRef(null);\n\n  useEffect(() => {\n    // Redirect to homepage if user is verified\n    if (user && !loading && user.emailVerified) {\n      router.replace('/');\n      return;\n    }\n    \n    // Clear any existing safety timeout\n    if (safetyTimeoutRef.current) {\n      clearTimeout(safetyTimeoutRef.current);\n      safetyTimeoutRef.current = null;\n    }\n    \n    // Only redirect to signin if auth is done loading, there's no user, no pending signup,\n    // AND logout is not in progress (prevents redirect override on intentional logout)\n    if (!loading && !user && !pendingSignupUserId && !logoutInProgress) {\n      // Add safety fallback with debounce to avoid stuck loader state\n      safetyTimeoutRef.current = setTimeout(() => {\n        router.replace('/signin');\n      }, 500);\n    }\n  }, [user, loading, pendingSignupUserId, logoutInProgress, router]);\n\n  // Cleanup timeout on unmount\n  useEffect(() => {\n    return () => {\n      if (safetyTimeoutRef.current) {\n        clearTimeout(safetyTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  // Show loader while auth is loading\n  if (loading) {\n    return <PageLoader message=\"Loading...\" />;\n  }\n\n  // Show loader while pending signup (waiting for auth state to update)\n  if (pendingSignupUserId) {\n    return <PageLoader message=\"Setting up your account...\" />;\n  }\n\n  // Show loader while redirecting if no user\n  if (!user) {\n    return <PageLoader message=\"Redirecting...\" />;\n  }\n\n  // Show email verification if user exists but is not verified\n  if (user && !user.emailVerified) {\n    return <EmailVerification />;\n  }\n\n  // Fallback - shouldn't reach here but just in case\n  return <PageLoader message=\"Redirecting...\" />;\n}","path":null,"size_bytes":2140,"size_tokens":null},"src/components/ProfilePage.js":{"content":"\"use client\";\n\nimport { useState, useEffect, useCallback } from \"react\";\nimport { useAuth } from \"../hooks/useAuth\";\nimport { useRouter } from \"next/navigation\";\nimport {\n  getUserProfile,\n  getUserProfileByUsername,\n  getUserStats,\n  getUserCampaigns,\n} from \"../lib/firestore\";\nimport { getProfileAvatar, getProfileBanner } from \"../utils/imageTransform\";\nimport { abbreviateNumber } from \"../utils/validation\";\nimport CampaignGallery from \"./CampaignGallery\";\nimport ReportModal from \"./ReportModal\";\nimport CreateCampaignModal from \"./CreateCampaignModal\";\nimport ShareModal from \"./ShareModal\";\nimport Pagination from \"./Pagination\";\n\nexport default function ProfilePage({ isOwnProfile = false, username = null }) {\n  const { user, loading } = useAuth();\n  const router = useRouter();\n  const [profileLoading, setProfileLoading] = useState(true);\n  const [campaignsLoading, setCampaignsLoading] = useState(false);\n  const [userData, setUserData] = useState(null);\n  const [userStats, setUserStats] = useState({\n    supportsCount: 0,\n    campaignsCount: 0,\n  });\n  const [campaigns, setCampaigns] = useState([]);\n  const [currentPage, setCurrentPage] = useState(1);\n  const [totalPages, setTotalPages] = useState(0);\n  const [totalCampaigns, setTotalCampaigns] = useState(0);\n  const [error, setError] = useState(null);\n  const [showReportModal, setShowReportModal] = useState(false);\n  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);\n  const [showMenu, setShowMenu] = useState(false);\n  const [showShareModal, setShowShareModal] = useState(false);\n\n  const loadCampaigns = useCallback(async (userId, page = 1) => {\n    setCampaignsLoading(true);\n    try {\n      const result = await getUserCampaigns(userId, { page, pageSize: 10 });\n      setCampaigns(result.campaigns);\n      setCurrentPage(result.currentPage);\n      setTotalPages(result.totalPages);\n      setTotalCampaigns(result.totalCount);\n      \n      const totalSupports = result.campaigns.reduce((sum, campaign) => {\n        const count = Number(campaign.supportersCount) || 0;\n        return sum + count;\n      }, 0);\n      \n      return { totalSupports, totalCount: result.totalCount };\n    } catch (error) {\n      console.error('Error loading campaigns:', error);\n      setCampaigns([]);\n      return { totalSupports: 0, totalCount: 0 };\n    } finally {\n      setCampaignsLoading(false);\n    }\n  }, []);\n\n  useEffect(() => {\n    if (isOwnProfile && !loading && !user) {\n      router.push(\"/\");\n      return;\n    }\n\n    const loadProfileData = async () => {\n      setProfileLoading(true);\n      setError(null);\n\n      try {\n        let profileUser = null;\n\n        if (isOwnProfile && user) {\n          profileUser = await getUserProfile(user.uid);\n          if (!profileUser) {\n            profileUser = {\n              id: user.uid,\n              displayName: user.displayName || user.email || \"User\",\n              username: user.email?.split(\"@\")[0] || \"user\",\n              email: user.email,\n              photoURL: user.photoURL,\n              bio: \"\",\n              profileImage:\n                user.photoURL ||\n                \"https://via.placeholder.com/120x120/059669/FFFFFF?text=U\",\n              bannerImage:\n                \"https://via.placeholder.com/1200x300/10B981/FFFFFF?text=Banner\",\n              supportersCount: 0,\n              campaignsCount: 0,\n              createdAt: new Date(),\n            };\n          }\n        } else if (username) {\n          profileUser = await getUserProfileByUsername(username);\n          if (!profileUser) {\n            setError(\"User not found\");\n            setProfileLoading(false);\n            return;\n          }\n        }\n\n        if (profileUser) {\n          setUserData(profileUser);\n\n          try {\n            const { totalSupports, totalCount } = await loadCampaigns(profileUser.id, 1);\n\n            try {\n              const stats = await getUserStats(profileUser.id);\n\n              setUserStats({\n                supportsCount: totalSupports,\n                campaignsCount: stats?.campaignsCount || totalCount,\n              });\n            } catch (statError) {\n              setUserStats({\n                supportsCount: totalSupports,\n                campaignsCount: totalCount,\n              });\n            }\n          } catch (campaignError) {\n            setCampaigns([]);\n            setUserStats({ supportsCount: 0, campaignsCount: 0 });\n          }\n        }\n      } catch (error) {\n        setError(\"Failed to load profile data\");\n      } finally {\n        setProfileLoading(false);\n      }\n    };\n\n    if (!loading) {\n      loadProfileData();\n    }\n  }, [user, loading, isOwnProfile, username, router, loadCampaigns]);\n\n  const handlePageChange = (page) => {\n    if (userData) {\n      loadCampaigns(userData.id, page);\n      const campaignsSection = document.getElementById('campaigns-section');\n      if (campaignsSection) {\n        campaignsSection.scrollIntoView({ behavior: 'smooth' });\n      }\n    }\n  };\n\n  if (loading || profileLoading) {\n    return <ProfileSkeleton />;\n  }\n\n  if (isOwnProfile && !user) {\n    return null;\n  }\n\n  if (error) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"mx-auto w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mb-6\">\n            <svg\n              className=\"w-12 h-12 text-red-500\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              viewBox=\"0 0 24 24\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z\"\n              />\n            </svg>\n          </div>\n          <h3 className=\"text-2xl font-bold text-gray-900 mb-2\">{error}</h3>\n          <p className=\"text-gray-600 mb-6\">\n            The profile you're looking for could not be found.\n          </p>\n          <button\n            onClick={() => router.push(\"/\")}\n            className=\"btn-base btn-primary px-6 py-3 font-medium\"\n          >\n            Go Back Home\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  if (!userData) {\n    return <ProfileSkeleton />;\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <div className=\"relative w-full aspect-[4/1] bg-gradient-to-r from-emerald-500 to-emerald-600\">\n        {userData.bannerImage && userData.bannerImage.trim() ? (\n          <img\n            src={getProfileBanner(userData.bannerImage)}\n            alt=\"Profile Banner\"\n            className=\"w-full h-full object-cover\"\n            loading=\"lazy\"\n          />\n        ) : (\n          <div className=\"w-full h-full bg-gradient-to-r from-emerald-500 to-emerald-600\"></div>\n        )}\n        <div className=\"absolute inset-0 bg-gradient-to-t from-black/20 to-transparent\"></div>\n      </div>\n\n      <div className=\"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4\">\n        <div className=\"flex items-center gap-4 mb-4\">\n          <div className=\"flex-shrink-0\">\n            {userData.profileImage && userData.profileImage.trim() ? (\n              <img\n                src={getProfileAvatar(userData.profileImage)}\n                alt={userData.displayName}\n                className=\"w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-white shadow-xl object-cover bg-white\"\n                loading=\"lazy\"\n              />\n            ) : (\n              <div className=\"w-20 h-20 sm:w-24 sm:h-24 rounded-full border-4 border-white shadow-xl bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center\">\n                <span className=\"text-white text-2xl sm:text-3xl font-bold\">\n                  {userData.displayName?.charAt(0)?.toUpperCase() || \"U\"}\n                </span>\n              </div>\n            )}\n          </div>\n\n          <div className=\"flex-1 min-w-0\">\n            <h1\n              className={`font-bold text-gray-900 ${\n                userData.displayName?.length <= 15\n                  ? \"text-2xl sm:text-3xl\"\n                  : userData.displayName?.length <= 25\n                    ? \"text-xl sm:text-2xl\"\n                    : userData.displayName?.length <= 35\n                      ? \"text-lg sm:text-xl\"\n                      : \"text-base sm:text-lg\"\n              } break-words leading-tight`}\n              title={userData.displayName}\n            >\n              {userData.displayName}\n            </h1>\n            <p\n              className={`text-gray-500 font-medium ${\n                userData.username?.length <= 20\n                  ? \"text-sm sm:text-base\"\n                  : \"text-xs sm:text-sm\"\n              } break-words mt-1`}\n            >\n              @{userData.username}\n            </p>\n          </div>\n\n          <div className=\"relative flex-shrink-0\">\n            <button\n              onClick={() => setShowMenu(!showMenu)}\n              className=\"p-2 rounded-full hover:bg-gray-100 transition-colors cursor-pointer\"\n              aria-label=\"Profile options\"\n            >\n              <svg\n                className=\"w-6 h-6 text-gray-600\"\n                fill=\"currentColor\"\n                viewBox=\"0 0 20 20\"\n              >\n                <path d=\"M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z\" />\n              </svg>\n            </button>\n\n            {showMenu && (\n              <>\n                <div\n                  className=\"fixed inset-0 z-10\"\n                  onClick={() => setShowMenu(false)}\n                />\n\n                <div className=\"absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-20\">\n                  <button\n                    onClick={() => {\n                      setShowMenu(false);\n                      setShowShareModal(true);\n                    }}\n                    className=\"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-150 flex items-center gap-2 cursor-pointer\"\n                  >\n                    <svg\n                      className=\"w-4 h-4\"\n                      fill=\"none\"\n                      stroke=\"currentColor\"\n                      viewBox=\"0 0 24 24\"\n                    >\n                      <path\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        strokeWidth={2}\n                        d=\"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z\"\n                      />\n                    </svg>\n                    Share Profile\n                  </button>\n\n                  {isOwnProfile ? (\n                    <>\n                      <button\n                        onClick={() => {\n                          setShowMenu(false);\n                          router.push(`/u/${userData.username}`);\n                        }}\n                        className=\"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-150 flex items-center gap-2 cursor-pointer\"\n                      >\n                        <svg\n                          className=\"w-4 h-4\"\n                          fill=\"none\"\n                          stroke=\"currentColor\"\n                          viewBox=\"0 0 24 24\"\n                        >\n                          <path\n                            strokeLinecap=\"round\"\n                            strokeLinejoin=\"round\"\n                            strokeWidth={2}\n                            d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\"\n                          />\n                          <path\n                            strokeLinecap=\"round\"\n                            strokeLinejoin=\"round\"\n                            strokeWidth={2}\n                            d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\"\n                          />\n                        </svg>\n                        View as Public\n                      </button>\n\n                      <button\n                        onClick={() => {\n                          setShowMenu(false);\n                          router.push(\"/profile/edit\");\n                        }}\n                        className=\"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-150 flex items-center gap-2 cursor-pointer\"\n                      >\n                        <svg\n                          className=\"w-4 h-4\"\n                          fill=\"none\"\n                          stroke=\"currentColor\"\n                          viewBox=\"0 0 24 24\"\n                        >\n                          <path\n                            strokeLinecap=\"round\"\n                            strokeLinejoin=\"round\"\n                            strokeWidth={2}\n                            d=\"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z\"\n                          />\n                        </svg>\n                        Edit Profile\n                      </button>\n                    </>\n                  ) : (\n                    <button\n                      onClick={() => {\n                        setShowMenu(false);\n                        setShowReportModal(true);\n                      }}\n                      className=\"w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors duration-150 flex items-center gap-2 cursor-pointer\"\n                    >\n                      <svg\n                        className=\"w-4 h-4\"\n                        fill=\"none\"\n                        stroke=\"currentColor\"\n                        viewBox=\"0 0 24 24\"\n                      >\n                        <path\n                          strokeLinecap=\"round\"\n                          strokeLinejoin=\"round\"\n                          strokeWidth={2}\n                          d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z\"\n                        />\n                      </svg>\n                      Report User\n                    </button>\n                  )}\n                </div>\n              </>\n            )}\n          </div>\n        </div>\n\n        {userData.bio && (\n          <p className=\"text-gray-600 text-sm sm:text-base leading-relaxed whitespace-pre-wrap mb-6 max-w-2xl\">\n            {userData.bio}\n          </p>\n        )}\n\n        <div className=\"flex flex-row gap-3 mb-8\">\n          <div className=\"bg-white rounded-xl shadow-lg p-3 sm:p-6 flex-1 text-center\">\n            <div className=\"text-lg sm:text-3xl font-bold text-emerald-600\">\n              {abbreviateNumber(userStats.supportsCount)}\n            </div>\n            <div className=\"text-[10px] sm:text-sm text-gray-600 font-medium mt-0.5 sm:mt-2\">\n              Supports\n            </div>\n          </div>\n\n          <div className=\"bg-white rounded-xl shadow-lg p-3 sm:p-6 flex-1 text-center\">\n            <div className=\"text-lg sm:text-3xl font-bold text-emerald-600\">\n              {abbreviateNumber(userStats.campaignsCount)}\n            </div>\n            <div className=\"text-[10px] sm:text-sm text-gray-600 font-medium mt-0.5 sm:mt-2\">\n              Campaigns\n            </div>\n          </div>\n\n          <div className=\"bg-white rounded-xl shadow-lg p-3 sm:p-6 flex-1 text-center\">\n            <div className=\"text-sm sm:text-3xl font-bold text-emerald-600 leading-tight\">\n              {userData.createdAt\n                ? new Date(\n                    userData.createdAt.seconds\n                      ? userData.createdAt.seconds * 1000\n                      : userData.createdAt,\n                  ).toLocaleDateString(\"en-US\", {\n                    month: \"short\",\n                    day: \"numeric\",\n                    year: \"numeric\",\n                  })\n                : \"Recently\"}\n            </div>\n            <div className=\"text-[10px] sm:text-sm text-gray-600 font-medium mt-0.5 sm:mt-2\">\n              Joined Since\n            </div>\n          </div>\n        </div>\n\n        <div id=\"campaigns-section\" className=\"bg-white rounded-2xl shadow-lg p-6\">\n          <div className=\"flex items-center justify-between mb-6\">\n            <div>\n              <h2 className=\"text-xl font-bold text-gray-900\">Campaigns</h2>\n              {totalPages > 1 && (\n                <p className=\"text-sm text-gray-500 mt-1\">\n                  Page {currentPage} of {totalPages}\n                </p>\n              )}\n            </div>\n            {isOwnProfile && (\n              <button\n                onClick={() => setIsCreateModalOpen(true)}\n                className=\"btn-base btn-primary px-4 py-2 text-sm font-medium\"\n              >\n                Create Campaign\n              </button>\n            )}\n          </div>\n\n          {campaignsLoading ? (\n            <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n              {[...Array(8)].map((_, i) => (\n                <div key={i} className=\"aspect-square bg-gray-200 rounded-lg animate-pulse\" />\n              ))}\n            </div>\n          ) : (\n            <>\n              <CampaignGallery\n                campaigns={campaigns}\n                loading={false}\n                isOwnProfile={isOwnProfile}\n                showReportOption={!isOwnProfile}\n                onCampaignDeleted={(campaignId) => {\n                  setCampaigns(campaigns.filter(c => c.id !== campaignId));\n                  setUserStats(prev => ({ ...prev, campaignsCount: Math.max(0, prev.campaignsCount - 1) }));\n                  setTotalCampaigns(prev => Math.max(0, prev - 1));\n                }}\n              />\n              \n              <Pagination\n                currentPage={currentPage}\n                totalPages={totalPages}\n                onPageChange={handlePageChange}\n              />\n            </>\n          )}\n        </div>\n      </div>\n\n      {!isOwnProfile && (\n        <ReportModal\n          isOpen={showReportModal}\n          onClose={() => setShowReportModal(false)}\n          type=\"user\"\n          reportedUserId={userData?.id}\n          reportedUsername={userData?.username}\n        />\n      )}\n\n      <CreateCampaignModal\n        isOpen={isCreateModalOpen}\n        onClose={() => setIsCreateModalOpen(false)}\n      />\n\n      <ShareModal\n        isOpen={showShareModal}\n        onClose={() => setShowShareModal(false)}\n        profileUrl={`${typeof window !== \"undefined\" ? window.location.origin : \"\"}/u/${userData?.username || \"\"}`}\n        displayName={userData?.displayName || \"User\"}\n        username={userData?.username || \"user\"}\n        profileImage={userData?.profileImage || null}\n      />\n    </div>\n  );\n}\n\nfunction ProfileSkeleton() {\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <div className=\"relative w-full aspect-[4/1] bg-gray-300 animate-pulse\"></div>\n\n      <div className=\"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-4\">\n        <div className=\"flex items-center gap-4 mb-4\">\n          <div className=\"w-20 h-20 sm:w-24 sm:h-24 bg-gray-400 rounded-full animate-pulse flex-shrink-0\"></div>\n\n          <div className=\"flex-1 min-w-0 space-y-3\">\n            <div className=\"h-7 sm:h-8 bg-gray-300 rounded w-40 sm:w-48 animate-pulse\"></div>\n            <div className=\"h-4 sm:h-5 bg-gray-300 rounded w-24 sm:w-32 animate-pulse\"></div>\n          </div>\n        </div>\n\n        <div className=\"mb-6 space-y-2\">\n          <div className=\"h-4 bg-gray-300 rounded w-full max-w-2xl animate-pulse\"></div>\n          <div className=\"h-4 bg-gray-300 rounded w-3/4 max-w-2xl animate-pulse\"></div>\n        </div>\n\n        <div className=\"flex flex-row gap-3 mb-8\">\n          {[...Array(3)].map((_, i) => (\n            <div\n              key={i}\n              className=\"bg-white rounded-xl shadow-lg p-3 sm:p-6 flex-1 text-center\"\n            >\n              <div className=\"h-6 sm:h-9 bg-gray-300 rounded w-12 sm:w-16 mx-auto animate-pulse mb-1\"></div>\n              <div className=\"h-2.5 sm:h-4 bg-gray-300 rounded w-14 sm:w-16 mx-auto animate-pulse\"></div>\n            </div>\n          ))}\n        </div>\n\n        <div className=\"bg-white rounded-2xl shadow-lg p-6\">\n          <div className=\"h-8 bg-gray-300 rounded w-32 animate-pulse mb-6\"></div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {[...Array(6)].map((_, i) => (\n              <div\n                key={i}\n                className=\"h-48 bg-gray-300 rounded-xl animate-pulse\"\n              ></div>\n            ))}\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":21023,"size_tokens":null},"src/app/(chrome)/terms/page.js":{"content":"import { Caveat } from \"next/font/google\";\n\nconst caveat = Caveat({ subsets: [\"latin\"], weight: [\"700\"] });\n\nexport const metadata = {\n  title: \"Terms & Conditions - Frame\",\n  description: \"Terms & Conditions for Frame - Twibbonize App\",\n};\n\nexport default function TermsPage() {\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <div className=\"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12\">\n        <div className=\"bg-white rounded-lg shadow-sm p-8\">\n          <h1 className={`${caveat.className} text-4xl font-bold text-emerald-700 mb-8`}>\n            Terms & Conditions\n          </h1>\n          \n          <div className=\"prose max-w-none\">\n            <p className=\"text-gray-600 mb-6\">\n              <strong>Last updated:</strong> {new Date().toLocaleDateString()}\n            </p>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Agreement to Terms</h2>\n              <p className=\"text-gray-700 leading-relaxed mb-4\">\n                By accessing and using Frame (\"the Service\"), you accept and agree to be bound by the terms and provision of this agreement. If you do not agree to abide by the above, please do not use this service.\n              </p>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Use License</h2>\n              <p className=\"text-gray-700 mb-4\">\n                Permission is granted to temporarily use Frame for personal, non-commercial transitory viewing only. This is the grant of a license, not a transfer of title, and under this license you may not:\n              </p>\n              <ul className=\"list-disc list-inside text-gray-700 space-y-2\">\n                <li>Use the service for any commercial purpose without written consent</li>\n                <li>Attempt to reverse engineer or hack the service</li>\n                <li>Upload harmful, offensive, or illegal content</li>\n                <li>Violate any applicable local, state, national or international law</li>\n                <li>Impersonate other users or provide false identity information</li>\n              </ul>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">User Accounts</h2>\n              <p className=\"text-gray-700 mb-4\">\n                Frame operates on an accessibility-first model:\n              </p>\n              <ul className=\"list-disc list-inside text-gray-700 space-y-2\">\n                <li><strong>Visitors:</strong> Can browse, use frames, and download results without creating an account</li>\n                <li><strong>Creators:</strong> Must create an account only to upload custom frames</li>\n                <li>You are responsible for maintaining the confidentiality of your account information</li>\n                <li>You agree to accept responsibility for all activities under your account</li>\n              </ul>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Content and Intellectual Property</h2>\n              \n              <h3 className=\"text-xl font-medium text-gray-900 mb-3\">Your Content</h3>\n              <ul className=\"list-disc list-inside text-gray-700 mb-4 space-y-2\">\n                <li>You retain ownership of content you upload</li>\n                <li>By uploading frames, you grant us a license to display and distribute them publicly</li>\n                <li>You must have rights to all content you upload</li>\n                <li>You are responsible for ensuring your content doesn't infringe on others' rights</li>\n              </ul>\n\n              <h3 className=\"text-xl font-medium text-gray-900 mb-3\">Public Analytics</h3>\n              <p className=\"text-gray-700 mb-4\">\n                All frame usage statistics, popularity metrics, and creator rankings are made publicly available as part of our transparency commitment. By using the service, you consent to this public analytics approach.\n              </p>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Prohibited Uses</h2>\n              <p className=\"text-gray-700 mb-4\">You may not use Frame:</p>\n              <ul className=\"list-disc list-inside text-gray-700 space-y-2\">\n                <li>For any unlawful purpose or to solicit others to perform unlawful acts</li>\n                <li>To violate any international, federal, provincial, or state regulations, rules, laws, or local ordinances</li>\n                <li>To infringe upon or violate our intellectual property rights or the intellectual property rights of others</li>\n                <li>To harass, abuse, insult, harm, defame, slander, disparage, intimidate, or discriminate</li>\n                <li>To submit false or misleading information</li>\n                <li>To upload or transmit viruses or any other type of malicious code</li>\n                <li>To spam, phish, pharm, pretext, spider, crawl, or scrape</li>\n              </ul>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Service Availability</h2>\n              <p className=\"text-gray-700 mb-4\">\n                We strive to maintain service availability but cannot guarantee uninterrupted access. We reserve the right to:\n              </p>\n              <ul className=\"list-disc list-inside text-gray-700 space-y-2\">\n                <li>Modify or discontinue the service with reasonable notice</li>\n                <li>Remove content that violates these terms</li>\n                <li>Suspend or terminate accounts for violations</li>\n                <li>Update these terms as needed</li>\n              </ul>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Privacy and Data</h2>\n              <p className=\"text-gray-700 mb-4\">\n                Your privacy is important to us. Please review our Privacy Policy, which also governs your use of the Service, to understand our practices.\n              </p>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Disclaimer</h2>\n              <p className=\"text-gray-700 mb-4\">\n                The information on this service is provided on an \"as is\" basis. To the fullest extent permitted by law, this Company:\n              </p>\n              <ul className=\"list-disc list-inside text-gray-700 space-y-2\">\n                <li>Excludes all representations and warranties relating to this service and its contents</li>\n                <li>Does not guarantee the accuracy, completeness, or reliability of user-generated content</li>\n                <li>Will not be liable for any loss or damage arising from use of the service</li>\n              </ul>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Limitations</h2>\n              <p className=\"text-gray-700 mb-4\">\n                In no event shall Frame or its suppliers be liable for any damages (including, without limitation, damages for loss of data or profit, or due to business interruption) arising out of the use or inability to use Frame, even if Frame or an authorized representative has been notified orally or in writing of the possibility of such damage.\n              </p>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Governing Law</h2>\n              <p className=\"text-gray-700 mb-4\">\n                These terms and conditions are governed by and construed in accordance with applicable law and you irrevocably submit to the exclusive jurisdiction of the courts in that location.\n              </p>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Changes to Terms</h2>\n              <p className=\"text-gray-700 mb-4\">\n                We reserve the right to update these Terms & Conditions at any time. Changes will be effective immediately upon posting. Your continued use of Frame after any changes constitutes acceptance of those changes.\n              </p>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Contact Information</h2>\n              <p className=\"text-gray-700 mb-4\">\n                If you have any questions about these Terms & Conditions, please contact us through our support channels within the application.\n              </p>\n            </section>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":8933,"size_tokens":null},"src/utils/imageTransform.js":{"content":"/**\n * Image Transformation Utilities\n * \n * Uses ImageKit.io CDN for optimized image delivery with transformations.\n * ImageKit was chosen over Supabase transforms for better performance,\n * cost efficiency, and no Pro plan requirement.\n * \n * ImageKit Documentation:\n * https://docs.imagekit.io/features/image-transformations\n */\n\n/**\n * Extract storage path from a full Supabase URL or return path as-is\n * \n * @param {string} imageUrlOrPath - Full URL or storage path\n * @returns {string} Storage path (e.g., \"campaigns/user123/campaign456.png\")\n */\nfunction extractStoragePath(imageUrlOrPath) {\n  if (!imageUrlOrPath) return '';\n  \n  if (imageUrlOrPath.includes('/storage/v1/object/public/uploads/')) {\n    const parts = imageUrlOrPath.split('/storage/v1/object/public/uploads/');\n    return parts[1] || '';\n  }\n  \n  if (imageUrlOrPath.includes('/storage/v1/render/image/public/uploads/')) {\n    const parts = imageUrlOrPath.split('/storage/v1/render/image/public/uploads/');\n    const pathWithParams = parts[1] || '';\n    return pathWithParams.split('?')[0];\n  }\n  \n  return imageUrlOrPath;\n}\n\n/**\n * Generate ImageKit transformation URL\n * \n * @param {string} imageUrlOrPath - Original image URL or path\n * @param {Object} options - Transformation options\n * @param {number} options.width - Target width in pixels\n * @param {number} options.height - Target height in pixels (optional, maintains aspect ratio if omitted)\n * @param {string} options.format - Output format: 'webp', 'png', 'jpeg' (default: 'webp')\n * @param {number} options.quality - Image quality 1-100 (default: 80)\n * @returns {string} Transformed image URL\n * \n * @example\n * const url = getTransformedImageUrl('campaigns/user123/campaign456.png', {\n *   width: 300,\n *   format: 'webp',\n *   quality: 75\n * });\n */\nexport function getTransformedImageUrl(imageUrlOrPath, options = {}) {\n  const { width, height, format = 'webp', quality = 80 } = options;\n  \n  if (!imageUrlOrPath) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('[DEV ERROR] Image path is required for transformation');\n    }\n    return '';\n  }\n  \n  const imagePath = extractStoragePath(imageUrlOrPath);\n  \n  if (!imagePath) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('[DEV ERROR] Could not extract storage path from:', imageUrlOrPath);\n    }\n    return imageUrlOrPath;\n  }\n  \n  const imagekitUrl = process.env.NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT;\n  \n  if (!imagekitUrl) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('[DEV ERROR] NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT is not configured');\n    }\n    return '';\n  }\n  \n  // Build ImageKit transformation parameters\n  const transformParams = [];\n  \n  if (width) transformParams.push(`w-${width}`);\n  if (height) transformParams.push(`h-${height}`);\n  if (format) transformParams.push(`f-${format}`);\n  if (quality) transformParams.push(`q-${quality}`);\n  \n  const queryString = transformParams.length > 0 ? `?tr=${transformParams.join(',')}` : '';\n  \n  return `${imagekitUrl}/${imagePath}${queryString}`;\n}\n\n/**\n * Get campaign preview (800px width WebP, quality 80)\n * Used in: Gallery grids, campaign view pages, campaign cards\n * \n * @param {string} imageUrlOrPath - Campaign image URL or path\n * @returns {string} Preview URL (~400 KB)\n */\nexport function getCampaignPreview(imageUrlOrPath) {\n  return getTransformedImageUrl(imageUrlOrPath, { \n    width: 800, \n    format: 'webp', \n    quality: 80 \n  });\n}\n\n/**\n * Get full-size campaign image (no transformation)\n * Used in: Canvas operations (adjust page), downloads\n * \n * @param {string} imageUrlOrPath - Campaign image URL or path\n * @returns {string} Original image URL (~800 KB - 2.5 MB)\n */\nexport function getCampaignCanvas(imageUrlOrPath) {\n  if (!imageUrlOrPath) {\n    return '';\n  }\n  \n  const imagePath = extractStoragePath(imageUrlOrPath);\n  \n  if (!imagePath) {\n    return imageUrlOrPath;\n  }\n  \n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  \n  if (!supabaseUrl) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('[DEV ERROR] NEXT_PUBLIC_SUPABASE_URL is not configured');\n    }\n    return '';\n  }\n  \n  // Canvas operations need full-size original from Supabase (no CDN transformation)\n  return `${supabaseUrl}/storage/v1/object/public/uploads/${imagePath}`;\n}\n\n/**\n * Get profile avatar (150x150 WebP, quality 80)\n * Used in: User avatars, creator cards, comments\n * \n * @param {string} imageUrlOrPath - Profile image URL, path, or Firebase photoURL\n * @returns {string} Avatar URL (~100 KB)\n */\nexport function getProfileAvatar(imageUrlOrPath) {\n  if (!imageUrlOrPath) {\n    return '';\n  }\n  \n  // Firebase/Google photos - use as-is (already optimized)\n  if (imageUrlOrPath.includes('firebasestorage') || \n      imageUrlOrPath.includes('googleusercontent')) {\n    return imageUrlOrPath;\n  }\n  \n  return getTransformedImageUrl(imageUrlOrPath, { \n    width: 150, \n    height: 150, \n    format: 'webp', \n    quality: 80 \n  });\n}\n\n/**\n * Get profile banner (800x200 WebP, quality 85)\n * Used in: Profile page headers\n * \n * @param {string} imagePath - Banner image path\n * @returns {string} Banner URL (~150 KB)\n */\nexport function getProfileBanner(imagePath) {\n  return getTransformedImageUrl(imagePath, { \n    width: 800, \n    height: 200, \n    format: 'webp', \n    quality: 85 \n  });\n}\n\n/**\n * Get optimized image for any use case\n * \n * @param {string} imagePath - Image path\n * @param {string} size - Preset size: 'thumbnail', 'preview', 'avatar', 'banner', 'full'\n * @returns {string} Optimized image URL\n */\nexport function getOptimizedImage(imagePath, size = 'preview') {\n  switch (size) {\n    case 'thumbnail':\n    case 'preview':\n      return getCampaignPreview(imagePath);\n    case 'avatar':\n      return getProfileAvatar(imagePath);\n    case 'banner':\n      return getProfileBanner(imagePath);\n    case 'full':\n      return getCampaignCanvas(imagePath);\n    default:\n      return getCampaignPreview(imagePath);\n  }\n}\n","path":null,"size_bytes":5995,"size_tokens":null},"src/lib/supabase.js":{"content":"\"use client\";\n\n// Secure client-side storage utilities using server-side API\nimport { auth } from './firebase-optimized'\n\n// Helper function to get Firebase ID token\nconst getAuthToken = async () => {\n  if (!auth?.currentUser) {\n    throw new Error('User not authenticated')\n  }\n  return await auth.currentUser.getIdToken()\n}\n\n// Helper function to make authenticated API requests\nconst apiRequest = async (endpoint, options = {}) => {\n  const token = await getAuthToken()\n  \n  const response = await fetch(endpoint, {\n    ...options,\n    headers: {\n      'Authorization': `Bearer ${token}`,\n      'Content-Type': 'application/json',\n      ...options.headers\n    }\n  })\n\n  if (!response.ok) {\n    const error = await response.json()\n    throw new Error(error.error || 'Request failed')\n  }\n\n  return response.json()\n}\n\n// Secure file upload using signed URLs\nexport const uploadFile = async (file, folder = 'uploads') => {\n  try {\n    // Step 1: Get signed upload URL from server\n    const { uploadUrl, path, token } = await apiRequest('/api/storage/upload-url', {\n      method: 'POST',\n      body: JSON.stringify({\n        fileName: file.name,\n        fileType: file.type,\n        fileSize: file.size,\n        folder\n      })\n    })\n\n    // Step 2: Upload file directly to Supabase using signed URL and token\n    const uploadResponse = await fetch(uploadUrl, {\n      method: 'PUT',\n      body: file,\n      headers: {\n        'Content-Type': file.type,\n        'x-upsert': 'false'\n      }\n    })\n\n    if (!uploadResponse.ok) {\n      throw new Error(`Failed to upload file: ${uploadResponse.status} ${uploadResponse.statusText}`)\n    }\n\n    return {\n      path,\n      fullPath: path,\n      name: file.name,\n      size: file.size,\n      type: file.type\n    }\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error uploading file:', error);\n    }\n    throw error\n  }\n}\n\n// Get signed URL for private file access\nexport const getSignedUrl = async (path, expiresIn = 3600) => {\n  try {\n    const { signedUrl } = await apiRequest('/api/storage/signed-url', {\n      method: 'POST',\n      body: JSON.stringify({ path, expiresIn })\n    })\n\n    return signedUrl\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error getting signed URL:', error);\n    }\n    throw error\n  }\n}\n\n// Delete file securely\nexport const deleteFile = async (path) => {\n  try {\n    await apiRequest('/api/storage/delete', {\n      method: 'DELETE',\n      body: JSON.stringify({ path })\n    })\n\n    return true\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error deleting file:', error);\n    }\n    throw error\n  }\n}\n\n// List user's files\nexport const listFiles = async (folder = 'uploads', limit = 100, offset = 0) => {\n  try {\n    const params = new URLSearchParams({ folder, limit: limit.toString(), offset: offset.toString() })\n    const { files } = await apiRequest(`/api/storage/list?${params}`, {\n      method: 'GET'\n    })\n\n    return files\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error listing files:', error);\n    }\n    throw error\n  }\n}\n\n// Utility function for handling file uploads with progress\nexport const uploadFileWithProgress = async (file, folder = 'uploads', onProgress) => {\n  try {\n    // Get signed upload URL\n    const { uploadUrl, path } = await apiRequest('/api/storage/upload-url', {\n      method: 'POST',\n      body: JSON.stringify({\n        fileName: file.name,\n        fileType: file.type,\n        fileSize: file.size,\n        folder\n      })\n    })\n\n    // Upload with progress tracking\n    return new Promise((resolve, reject) => {\n      const xhr = new XMLHttpRequest()\n\n      xhr.upload.addEventListener('progress', (event) => {\n        if (event.lengthComputable && onProgress) {\n          const progress = (event.loaded / event.total) * 100\n          onProgress(progress)\n        }\n      })\n\n      xhr.addEventListener('load', () => {\n        if (xhr.status === 200) {\n          resolve({\n            path,\n            fullPath: path,\n            name: file.name,\n            size: file.size,\n            type: file.type\n          })\n        } else {\n          reject(new Error('Upload failed'))\n        }\n      })\n\n      xhr.addEventListener('error', () => {\n        reject(new Error('Upload failed'))\n      })\n\n      xhr.open('PUT', uploadUrl)\n      xhr.setRequestHeader('Content-Type', file.type)\n      xhr.setRequestHeader('x-upsert', 'false')\n      xhr.send(file)\n    })\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error uploading file with progress:', error);\n    }\n    throw error\n  }\n}\n\n// Note: No direct client export for security - use API endpoints instead","path":null,"size_bytes":4793,"size_tokens":null},"src/app/(chrome)/campaign/[slug]/result/page.js":{"content":"\"use client\";\n\nimport { useState, useRef, useEffect } from 'react';\nimport Image from 'next/image';\nimport { useParams, useRouter } from 'next/navigation';\nimport { useCampaignSession } from '../../../../../contexts/CampaignSessionContext';\nimport { requireDownloadComplete } from '../../../../../utils/campaignRouteGuards';\nimport { composeImages } from '../../../../../utils/imageComposition';\nimport { getProfileAvatar, getCampaignPreview } from '../../../../../utils/imageTransform';\nimport LoadingSpinner from '../../../../../components/LoadingSpinner';\nimport CampaignStepIndicator from '../../../../../components/CampaignStepIndicator';\n\nexport default function CampaignResultPage() {\n  const params = useParams();\n  const router = useRouter();\n  const slug = params.slug;\n  const campaignSession = useCampaignSession();\n\n  // State\n  const [session, setSession] = useState(null);\n  const [campaign, setCampaign] = useState(null);\n  const [creator, setCreator] = useState(null);\n  const [userPhoto, setUserPhoto] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [composedImageUrl, setComposedImageUrl] = useState('');\n  const [redownloading, setRedownloading] = useState(false);\n\n  const canvasRef = useRef(null);\n  const composedImageUrlRef = useRef(null);\n\n  // Load session and check route guard\n  useEffect(() => {\n    const loadSession = async () => {\n      const currentSession = campaignSession.getSession(slug);\n      \n      // Route guard: check if downloaded\n      if (!requireDownloadComplete(currentSession, router, slug)) {\n        return; // Will redirect\n      }\n      \n      setSession(currentSession);\n      setCampaign(currentSession.campaignData);\n      setCreator(currentSession.creatorData);\n      \n      // Recreate File object from stored data\n      if (currentSession.userPhotoPreview) {\n        try {\n          const response = await fetch(currentSession.userPhotoPreview);\n          const blob = await response.blob();\n          const file = new File([blob], currentSession.userPhoto?.name || 'photo.jpg', {\n            type: currentSession.userPhoto?.type || 'image/jpeg'\n          });\n          setUserPhoto(file);\n          \n          // Compose image for display\n          const { blob: composedBlob } = await composeImages(\n            file,\n            getCampaignPreview(currentSession.campaignData.imageUrl),\n            currentSession.adjustments || { scale: 1.0, x: 0, y: 0 },\n            currentSession.campaignData.type\n          );\n          \n          const url = URL.createObjectURL(composedBlob);\n          composedImageUrlRef.current = url;\n          setComposedImageUrl(url);\n        } catch (error) {\n          console.error('Error loading result:', error);\n        }\n      }\n      \n      setLoading(false);\n    };\n    \n    loadSession();\n    \n    // Cleanup composed image URL on unmount\n    return () => {\n      if (composedImageUrlRef.current) {\n        URL.revokeObjectURL(composedImageUrlRef.current);\n      }\n    };\n  }, [slug, router, campaignSession]);\n\n  // Start Over - clear session and go to page 1\n  const handleStartOver = () => {\n    campaignSession.clearSession(slug);\n    router.push(`/campaign/${slug}`);\n  };\n\n  // Re-download\n  const handleRedownload = async () => {\n    if (!userPhoto || !campaign || !session) return;\n    \n    setRedownloading(true);\n    \n    try {\n      const { blob } = await composeImages(\n        userPhoto,\n        getCampaignPreview(campaign.imageUrl),\n        session.adjustments || { scale: 1.0, x: 0, y: 0 },\n        campaign.type\n      );\n      \n      const url = URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `${campaign.slug}-${Date.now()}.png`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      URL.revokeObjectURL(url);\n    } catch (error) {\n      console.error('Error re-downloading:', error);\n    } finally {\n      setRedownloading(false);\n    }\n  };\n\n  // Share functionality\n  const handleShare = async (platform) => {\n    const url = window.location.origin + `/campaign/${slug}`;\n    const text = campaign ? `Check out ${campaign.title} on Frame Your Voice!` : 'Check out this campaign!';\n    \n    switch (platform) {\n      case 'twitter':\n        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');\n        break;\n      case 'facebook':\n        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');\n        break;\n      case 'whatsapp':\n        window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`, '_blank');\n        break;\n      default:\n        break;\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-white flex items-center justify-center\">\n        <LoadingSpinner />\n      </div>\n    );\n  }\n\n  if (!session || !campaign) {\n    return (\n      <div className=\"min-h-screen bg-white flex items-center justify-center\">\n        <LoadingSpinner />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-white\">\n      <div className=\"min-h-screen flex\">\n        <div className=\"flex-1 w-full flex flex-col py-8 px-4 sm:px-6 lg:px-8 pt-20\">\n          <div className=\"mx-auto w-full max-w-5xl\">\n            \n            <div className=\"text-center mb-6 bg-yellow-400 px-6 py-5 rounded-t-xl\">\n              <CampaignStepIndicator currentStep={3} />\n              <h1 className=\"text-2xl sm:text-3xl font-bold text-gray-900 mb-1\">\n                Your {campaign.type === 'frame' ? 'Frame' : 'Background'} is Ready!\n              </h1>\n              <p className=\"text-sm text-gray-800\">\n                Download complete! Share your creation with the world.\n              </p>\n            </div>\n            \n            <div className=\"bg-white rounded-b-xl border border-t-0 border-gray-200 shadow-sm\">\n              \n              <div className=\"grid grid-cols-1 lg:grid-cols-[minmax(0,1.1fr)_minmax(320px,0.9fr)] gap-6 p-4 sm:p-6\">\n                \n                <div className=\"space-y-3\">\n                  <h2 className=\"text-lg font-bold text-gray-900\">Your Final Image</h2>\n                  {composedImageUrl && (\n                    <div className=\"relative\">\n                      <img\n                        src={composedImageUrl}\n                        alt=\"Your final result\"\n                        className=\"w-full h-auto rounded-lg border-2 border-gray-300\"\n                        style={{ maxHeight: '500px', objectFit: 'contain' }}\n                      />\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"space-y-5\">\n                  \n                  <div>\n                    <h2 className=\"text-lg font-bold text-gray-900 mb-3\">Actions</h2>\n                    <button\n                      onClick={handleRedownload}\n                      disabled={redownloading}\n                      className={`btn-base btn-secondary w-full py-3 font-medium ${\n                        redownloading ? 'opacity-70 cursor-wait' : ''\n                      }`}\n                    >\n                      {redownloading ? 'Downloading...' : 'Download Again'}\n                    </button>\n                  </div>\n\n                  <div>\n                    <h3 className=\"text-lg font-bold text-gray-900 mb-3\">Share Your Creation</h3>\n                    <div className=\"grid grid-cols-3 gap-3\">\n                      <button\n                        onClick={() => handleShare('twitter')}\n                        className=\"btn-base btn-twitter py-3 text-sm\"\n                      >\n                        Twitter\n                      </button>\n                      <button\n                        onClick={() => handleShare('facebook')}\n                        className=\"btn-base btn-facebook py-3 text-sm\"\n                      >\n                        Facebook\n                      </button>\n                      <button\n                        onClick={() => handleShare('whatsapp')}\n                        className=\"btn-base btn-whatsapp py-3 text-sm\"\n                      >\n                        WhatsApp\n                      </button>\n                    </div>\n                  </div>\n\n                  {creator && (\n                    <div className=\"p-4 bg-gray-50 rounded-lg border border-gray-200\">\n                      <p className=\"text-sm text-gray-600 text-center mb-2\">Campaign by</p>\n                      <div className=\"flex items-center justify-center gap-3\">\n                        {creator.profileImage && (\n                          <div className=\"relative w-10 h-10 rounded-full border-2 border-gray-300 overflow-hidden flex-shrink-0\">\n                            <Image\n                              src={getProfileAvatar(creator.profileImage)}\n                              alt={creator.displayName}\n                              fill\n                              className=\"object-cover\"\n                              unoptimized\n                            />\n                          </div>\n                        )}\n                        <div className=\"text-left\">\n                          <button\n                            onClick={() => router.push(`/u/${creator.username}`)}\n                            className=\"font-semibold text-gray-900 hover:underline text-sm\"\n                          >\n                            {creator.displayName || creator.username}\n                          </button>\n                          <p className=\"text-xs text-gray-600\">\n                            {campaign.supportersCount || 0} {campaign.supportersCount === 1 ? 'support' : 'supports'}\n                          </p>\n                        </div>\n                      </div>\n                    </div>\n                  )}\n\n                  <div className=\"pt-3 border-t border-gray-200\">\n                    <button\n                      onClick={handleStartOver}\n                      className=\"btn-base bg-gray-600 hover:bg-gray-700 text-white w-full py-3 font-medium\"\n                    >\n                      Create Another One\n                    </button>\n                    <p className=\"text-xs text-gray-500 mt-2 text-center\">\n                      Start over with a new photo\n                    </p>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10545,"size_tokens":null},"src/utils/admin/adminValidation.js":{"content":"/**\n * Admin Validation Utilities\n * Input validation for admin actions\n */\n\n/**\n * Valid report status values\n */\nconst VALID_REPORT_STATUSES = ['pending', 'reviewed', 'resolved', 'dismissed'];\n\n/**\n * Valid moderation status values\n */\nconst VALID_MODERATION_STATUSES = ['active', 'under-review', 'under-review-hidden', 'removed-temporary', 'removed-permanent'];\n\n/**\n * Valid user role values\n */\nconst VALID_USER_ROLES = ['admin', 'user'];\n\n/**\n * Validate report status\n * @param {string} status - Status to validate\n * @returns {boolean} Whether status is valid\n */\nexport function validateReportStatus(status) {\n  return VALID_REPORT_STATUSES.includes(status);\n}\n\n/**\n * Validate moderation status\n * @param {string} status - Status to validate\n * @returns {boolean} Whether status is valid\n */\nexport function validateModerationStatus(status) {\n  return VALID_MODERATION_STATUSES.includes(status);\n}\n\n/**\n * Validate user role\n * @param {string} role - Role to validate\n * @returns {boolean} Whether role is valid\n */\nexport function validateUserRole(role) {\n  return VALID_USER_ROLES.includes(role);\n}\n\n/**\n * Validate ban reason is provided\n * @param {string} reason - Ban reason\n * @returns {boolean} Whether reason is valid (not empty)\n */\nexport function validateBanReason(reason) {\n  return typeof reason === 'string' && reason.trim().length > 0;\n}\n\n/**\n * Validate report action\n * @param {string} action - Action to validate\n * @returns {boolean} Whether action is valid\n */\nexport function validateReportAction(action) {\n  const validActions = ['removed', 'warned', 'no-action'];\n  return validActions.includes(action);\n}\n\n/**\n * Get validation error message\n * @param {string} field - Field name\n * @param {string} value - Field value\n * @returns {string|null} Error message or null if valid\n */\nexport function getValidationError(field, value) {\n  switch (field) {\n    case 'reportStatus':\n      return validateReportStatus(value) ? null : 'Invalid report status';\n    case 'moderationStatus':\n      return validateModerationStatus(value) ? null : 'Invalid moderation status';\n    case 'userRole':\n      return validateUserRole(value) ? null : 'Invalid user role';\n    case 'banReason':\n      return validateBanReason(value) ? null : 'Ban reason is required';\n    default:\n      return null;\n  }\n}\n","path":null,"size_bytes":2317,"size_tokens":null},"src/app/api/admin/campaigns/[campaignId]/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\nimport { FieldValue } from 'firebase-admin/firestore';\nimport { validateCampaignTransition } from '@/utils/admin/statusTransitionValidator';\n\nexport async function PATCH(request, { params }) {\n  try {\n    const adminUser = await requireAdmin(request);\n    \n    const { campaignId } = params;\n    const body = await request.json();\n    const { moderationStatus, removeReason } = body;\n    \n    const validStatuses = ['active', 'under-review', 'under-review-hidden', 'removed-temporary', 'removed-permanent'];\n    if (moderationStatus && !validStatuses.includes(moderationStatus)) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid moderation status. Must be: active, under-review, under-review-hidden, removed-temporary, or removed-permanent' },\n        { status: 400 }\n      );\n    }\n    \n    if (!campaignId) {\n      return NextResponse.json(\n        { success: false, error: 'Campaign ID is required' },\n        { status: 400 }\n      );\n    }\n    \n    const db = adminFirestore();\n    const campaignRef = db.collection('campaigns').doc(campaignId);\n    const campaignDoc = await campaignRef.get();\n    \n    if (!campaignDoc.exists) {\n      return NextResponse.json(\n        { success: false, error: 'Campaign not found' },\n        { status: 404 }\n      );\n    }\n    \n    const campaignData = campaignDoc.data();\n    const currentStatus = campaignData.moderationStatus || 'active';\n    \n    // Validate status transition if moderationStatus is being changed\n    if (moderationStatus) {\n      const validation = validateCampaignTransition(currentStatus, moderationStatus);\n      if (!validation.valid) {\n        return NextResponse.json(\n          { success: false, error: validation.error },\n          { status: 400 }\n        );\n      }\n    }\n    \n    const updateData = {\n      updatedAt: FieldValue.serverTimestamp(),\n    };\n    \n    if (moderationStatus) {\n      updateData.moderationStatus = moderationStatus;\n      \n      if (moderationStatus === 'removed-temporary' || moderationStatus === 'removed-permanent') {\n        updateData.removedBy = adminUser.uid;\n        updateData.removedAt = FieldValue.serverTimestamp();\n        \n        if (removeReason) {\n          updateData.removalReason = removeReason;\n        }\n        \n        if (moderationStatus === 'removed-temporary') {\n          const appealDeadline = new Date();\n          appealDeadline.setDate(appealDeadline.getDate() + 30);\n          updateData.appealDeadline = appealDeadline;\n          updateData.appealCount = 0;\n        } else if (moderationStatus === 'removed-permanent') {\n          // Clear temporary-only fields when setting to permanent\n          updateData.appealDeadline = FieldValue.delete();\n          updateData.appealCount = FieldValue.delete();\n        }\n      }\n      \n      if (moderationStatus === 'active') {\n        updateData.hiddenAt = FieldValue.delete();\n        updateData.removedAt = FieldValue.delete();\n        updateData.removalReason = FieldValue.delete();\n        updateData.appealDeadline = FieldValue.delete();\n        updateData.appealCount = FieldValue.delete();\n        updateData.removedBy = FieldValue.delete();\n      }\n    }\n    \n    await campaignRef.update(updateData);\n    \n    const updatedDoc = await campaignRef.get();\n    const updatedData = { id: updatedDoc.id, ...updatedDoc.data() };\n    \n    if (updatedData.createdAt && updatedData.createdAt.toDate) {\n      updatedData.createdAt = updatedData.createdAt.toDate().toISOString();\n    }\n    if (updatedData.updatedAt && updatedData.updatedAt.toDate) {\n      updatedData.updatedAt = updatedData.updatedAt.toDate().toISOString();\n    }\n    if (updatedData.removedAt && updatedData.removedAt.toDate) {\n      updatedData.removedAt = updatedData.removedAt.toDate().toISOString();\n    }\n    \n    return NextResponse.json({\n      success: true,\n      message: 'Campaign moderation status updated successfully',\n      data: updatedData,\n    });\n  } catch (error) {\n    console.error('Error updating campaign moderation status:', error);\n    \n    if (error.message.includes('Unauthorized') || error.message.includes('Admin access required')) {\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 403 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to update campaign moderation status' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":4559,"size_tokens":null},"src/components/admin/UserDetailsModal.js":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useBodyScrollLock } from \"@/hooks/useBodyScrollLock\";\nimport ConfirmationModal from \"@/components/ConfirmationModal\";\nimport { getRoleBadgeColor, formatTimestamp } from \"@/utils/admin/adminHelpers\";\n\nexport default function UserDetailsModal({ user, onClose, onUpdate }) {\n  const { user: currentUser } = useAuth();\n  const [isUpdating, setIsUpdating] = useState(false);\n  const [updateError, setUpdateError] = useState(null);\n  const [showBanModal, setShowBanModal] = useState(false);\n  const [showBanConfirmation, setShowBanConfirmation] = useState(false);\n  const [banReason, setBanReason] = useState('');\n  const [banType, setBanType] = useState('temporary');\n\n  // Lock body scroll when modal is open\n  useBodyScrollLock(true);\n\n  const handleRoleChange = async (newRole) => {\n    if (!currentUser) return;\n\n    setIsUpdating(true);\n    setUpdateError(null);\n\n    try {\n      const token = await currentUser.getIdToken();\n      \n      const response = await fetch(`/api/admin/users/${user.id}/role`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({ role: newRole }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || 'Failed to update role');\n      }\n\n      if (onUpdate) {\n        onUpdate();\n      }\n    } catch (error) {\n      console.error('Error updating role:', error);\n      setUpdateError(error.message);\n    } finally {\n      setIsUpdating(false);\n    }\n  };\n\n  const handleBanModalContinue = () => {\n    const isBanned = user.accountStatus?.includes('banned');\n    \n    if (!isBanned && !banReason.trim()) {\n      setUpdateError('Please provide a reason for banning this user');\n      return;\n    }\n\n    // Close the ban details modal and open confirmation modal\n    setShowBanModal(false);\n    setShowBanConfirmation(true);\n  };\n\n  const handleBanToggle = async () => {\n    if (!currentUser) return;\n\n    const isBanned = user.accountStatus?.includes('banned');\n\n    setIsUpdating(true);\n    setUpdateError(null);\n    setShowBanConfirmation(false);\n\n    try {\n      const token = await currentUser.getIdToken();\n      \n      const newAccountStatus = isBanned \n        ? 'active' \n        : (banType === 'permanent' ? 'banned-permanent' : 'banned-temporary');\n      \n      const response = await fetch(`/api/admin/users/${user.id}/ban`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({ \n          accountStatus: newAccountStatus,\n          banReason: banReason || undefined,\n        }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || 'Failed to update ban status');\n      }\n\n      setBanReason('');\n      setBanType('temporary');\n      \n      if (onUpdate) {\n        onUpdate();\n      }\n    } catch (error) {\n      console.error('Error updating ban status:', error);\n      setUpdateError(error.message);\n    } finally {\n      setIsUpdating(false);\n    }\n  };\n\n  if (!user) return null;\n\n  return (\n    <>\n      <div className=\"fixed inset-0 z-50 overflow-hidden\">\n        <div className=\"absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity\" onClick={onClose}></div>\n        \n        <div className=\"fixed inset-y-0 right-0 max-w-full flex\">\n          <div className=\"w-screen max-w-md\">\n            <div className=\"h-full flex flex-col bg-white shadow-xl overflow-y-scroll\">\n              <div className=\"px-6 py-4 bg-emerald-700\">\n                <div className=\"flex items-center justify-between\">\n                  <h2 className=\"text-lg font-medium text-white\">User Details</h2>\n                  <button\n                    onClick={onClose}\n                    className=\"text-white hover:text-gray-200 transition-colors\"\n                  >\n                    <svg className=\"h-6 w-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                    </svg>\n                  </button>\n                </div>\n              </div>\n\n              <div className=\"flex-1 px-6 py-6 space-y-6\">\n                {updateError && (\n                  <div className=\"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded\">\n                    {updateError}\n                  </div>\n                )}\n\n                <div className=\"flex items-center space-x-4\">\n                  <div className=\"h-20 w-20 flex-shrink-0\">\n                    {user.profileImage ? (\n                      <img\n                        className=\"h-20 w-20 rounded-full object-cover\"\n                        src={user.profileImage}\n                        alt={user.displayName || 'User'}\n                        loading=\"lazy\"\n                      />\n                    ) : (\n                      <div className=\"h-20 w-20 rounded-full bg-emerald-100 flex items-center justify-center\">\n                        <span className=\"text-emerald-700 font-medium text-2xl\">\n                          {(user.displayName || user.email || '?')[0].toUpperCase()}\n                        </span>\n                      </div>\n                    )}\n                  </div>\n                  <div>\n                    <h3 className=\"text-lg font-medium text-gray-900\">{user.displayName || 'Unnamed User'}</h3>\n                    <p className=\"text-sm text-gray-500\">@{user.username || 'no-username'}</p>\n                    <span className={`mt-2 inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getRoleBadgeColor(user.role)}`}>\n                      {user.role || 'user'}\n                    </span>\n                  </div>\n                </div>\n\n                {(user.accountStatus?.includes('banned')) && (\n                  <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n                    <div className=\"flex items-center\">\n                      <svg className=\"h-5 w-5 text-red-400 mr-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                      </svg>\n                      <h4 className=\"text-sm font-medium text-red-800\">\n                        User is {user.accountStatus === 'banned-permanent' ? 'Permanently Banned' : 'Temporarily Banned'}\n                      </h4>\n                    </div>\n                    {user.banReason && (\n                      <p className=\"mt-2 text-sm text-red-700\">Reason: {user.banReason}</p>\n                    )}\n                    {user.bannedAt && (\n                      <p className=\"mt-1 text-xs text-red-600\">Banned on: {formatTimestamp(user.bannedAt, true)}</p>\n                    )}\n                    {user.accountStatus === 'banned-temporary' && user.appealDeadline && (\n                      <p className=\"mt-1 text-xs text-red-600\">Appeal deadline: {formatTimestamp(user.appealDeadline, true)}</p>\n                    )}\n                  </div>\n                )}\n\n                <div>\n                  <h3 className=\"text-sm font-medium text-gray-500 mb-2\">Profile Information</h3>\n                  <dl className=\"space-y-2\">\n                    <div>\n                      <dt className=\"text-xs text-gray-500\">Email</dt>\n                      <dd className=\"text-sm text-gray-900\">{user.email || '-'}</dd>\n                    </div>\n                    <div>\n                      <dt className=\"text-xs text-gray-500\">Bio</dt>\n                      <dd className=\"text-sm text-gray-900\">{user.bio || 'No bio'}</dd>\n                    </div>\n                    <div>\n                      <dt className=\"text-xs text-gray-500\">Location</dt>\n                      <dd className=\"text-sm text-gray-900\">{user.location || 'Not specified'}</dd>\n                    </div>\n                    <div>\n                      <dt className=\"text-xs text-gray-500\">Joined</dt>\n                      <dd className=\"text-sm text-gray-900\">{formatTimestamp(user.createdAt, true)}</dd>\n                    </div>\n                  </dl>\n                </div>\n\n                <div>\n                  <h3 className=\"text-sm font-medium text-gray-500 mb-2\">Statistics</h3>\n                  <dl className=\"grid grid-cols-2 gap-4\">\n                    <div className=\"bg-gray-50 rounded-lg p-3\">\n                      <dt className=\"text-xs text-gray-500\">Campaigns Created</dt>\n                      <dd className=\"text-2xl font-semibold text-gray-900\">{user.campaignsCount || 0}</dd>\n                    </div>\n                    <div className=\"bg-gray-50 rounded-lg p-3\">\n                      <dt className=\"text-xs text-gray-500\">Total Supports</dt>\n                      <dd className=\"text-2xl font-semibold text-gray-900\">{user.totalSupports || 0}</dd>\n                    </div>\n                  </dl>\n                </div>\n\n                <div>\n                  <h3 className=\"text-sm font-medium text-gray-500 mb-3\">Admin Actions</h3>\n                  <div className=\"space-y-2\">\n                    {user.role !== 'admin' ? (\n                      <button\n                        onClick={() => handleRoleChange('admin')}\n                        disabled={isUpdating}\n                        className=\"w-full btn-base bg-purple-600 text-white hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed\"\n                      >\n                        {isUpdating ? 'Processing...' : 'Make Admin'}\n                      </button>\n                    ) : (\n                      <button\n                        onClick={() => handleRoleChange('user')}\n                        disabled={isUpdating}\n                        className=\"w-full btn-base bg-gray-600 text-white hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed\"\n                      >\n                        {isUpdating ? 'Processing...' : 'Revoke Admin'}\n                      </button>\n                    )}\n                    \n                    <button\n                      onClick={() => setShowBanModal(true)}\n                      disabled={isUpdating}\n                      className={`w-full btn-base ${(user.accountStatus?.includes('banned')) ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} text-white disabled:opacity-50 disabled:cursor-not-allowed`}\n                    >\n                      {isUpdating ? 'Processing...' : (user.accountStatus?.includes('banned')) ? 'Unban User' : 'Ban User'}\n                    </button>\n\n                    {user.username && (\n                      <a\n                        href={`/u/${user.username}`}\n                        target=\"_blank\"\n                        rel=\"noopener noreferrer\"\n                        className=\"w-full btn-base bg-emerald-600 text-white hover:bg-emerald-700 text-center block\"\n                      >\n                        View Public Profile\n                      </a>\n                    )}\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {showBanModal && (\n        <div className=\"fixed inset-0 z-[60] overflow-y-auto\">\n          <div className=\"flex items-center justify-center min-h-screen px-4\">\n            <div className=\"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity\" onClick={() => setShowBanModal(false)}></div>\n            \n            <div className=\"relative bg-white rounded-lg max-w-md w-full p-6 z-[70]\">\n              <h3 className=\"text-lg font-medium text-gray-900 mb-4\">\n                {(user.accountStatus?.includes('banned')) ? 'Unban User' : 'Ban User'}\n              </h3>\n              \n              {!(user.accountStatus?.includes('banned')) && (\n                <>\n                  <div className=\"mb-4\">\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                      Ban Type\n                    </label>\n                    <div className=\"space-y-2\">\n                      <label className=\"flex items-center\">\n                        <input\n                          type=\"radio\"\n                          value=\"temporary\"\n                          checked={banType === 'temporary'}\n                          onChange={(e) => setBanType(e.target.value)}\n                          className=\"mr-2\"\n                        />\n                        <span className=\"text-sm text-gray-900\">Temporary (30-day appeal window)</span>\n                      </label>\n                      <label className=\"flex items-center\">\n                        <input\n                          type=\"radio\"\n                          value=\"permanent\"\n                          checked={banType === 'permanent'}\n                          onChange={(e) => setBanType(e.target.value)}\n                          className=\"mr-2\"\n                        />\n                        <span className=\"text-sm text-gray-900\">Permanent (no appeal)</span>\n                      </label>\n                    </div>\n                  </div>\n                  \n                  <div className=\"mb-4\">\n                    <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                      Reason for ban\n                    </label>\n                    <textarea\n                      value={banReason}\n                      onChange={(e) => setBanReason(e.target.value)}\n                      rows={3}\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n                      placeholder=\"Enter reason for banning this user...\"\n                    />\n                  </div>\n                </>\n              )}\n              \n              <p className=\"text-sm text-gray-600 mb-4\">\n                {(user.accountStatus?.includes('banned'))\n                  ? 'This will unban the user and restore their access.' \n                  : 'This will prevent the user from accessing the platform.'}\n              </p>\n              \n              <div className=\"flex gap-3\">\n                <button\n                  onClick={() => {\n                    setShowBanModal(false);\n                    setBanReason('');\n                    setBanType('temporary');\n                  }}\n                  className=\"flex-1 btn-base bg-gray-200 text-gray-800 hover:bg-gray-300\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={(user.accountStatus?.includes('banned')) ? handleBanToggle : handleBanModalContinue}\n                  disabled={!(user.accountStatus?.includes('banned')) && !banReason.trim()}\n                  className={`flex-1 btn-base ${(user.accountStatus?.includes('banned')) ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} text-white disabled:opacity-50 disabled:cursor-not-allowed`}\n                >\n                  {(user.accountStatus?.includes('banned')) ? 'Confirm Unban' : 'Continue'}\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Typed Confirmation Modal for Banning */}\n      <ConfirmationModal\n        isOpen={showBanConfirmation}\n        onClose={() => {\n          setShowBanConfirmation(false);\n          // Reopen the ban modal so they can edit their inputs\n          setShowBanModal(true);\n        }}\n        onConfirm={handleBanToggle}\n        title={`Ban User - ${user.username || user.displayName}`}\n        message={`You are about to ${banType === 'permanent' ? 'permanently ban' : 'temporarily ban (30-day appeal window)'} this user for: \"${banReason}\". This action will prevent them from accessing the platform. Type CONFIRM to proceed.`}\n        confirmText=\"Ban User\"\n        cancelText=\"Go Back\"\n        type=\"danger\"\n        requireTypedConfirmation={true}\n      />\n    </>\n  );\n}\n","path":null,"size_bytes":16361,"size_tokens":null},"src/components/LayoutVisibilityContext.js":{"content":"\"use client\";\n\nimport React, { createContext, useContext } from 'react';\n\nconst LayoutVisibilityContext = createContext({ hideChrome: false });\n\nexport const useLayoutVisibility = () => {\n  const context = useContext(LayoutVisibilityContext);\n  // Return default values if context is not available\n  return context || { hideChrome: false };\n};\n\nexport const LayoutVisibilityProvider = ({ children, hideChrome = false }) => {\n  return (\n    <LayoutVisibilityContext.Provider value={{ hideChrome }}>\n      {children}\n    </LayoutVisibilityContext.Provider>\n  );\n};","path":null,"size_bytes":562,"size_tokens":null},"src/components/TimeoutWrapper.js":{"content":"'use client';\n\nimport { useState, useEffect } from 'react';\n\nexport default function TimeoutWrapper({ children, timeout = 10000 }) {\n  const [isTimedOut, setIsTimedOut] = useState(false);\n  const [isLoaded, setIsLoaded] = useState(false);\n\n  useEffect(() => {\n    // Set loaded state after a short delay to ensure components have rendered\n    const loadTimer = setTimeout(() => {\n      setIsLoaded(true);\n    }, 100);\n\n    // Set timeout to prevent infinite loading\n    const timeoutTimer = setTimeout(() => {\n      if (!isLoaded) {\n        setIsTimedOut(true);\n      }\n    }, timeout);\n\n    return () => {\n      clearTimeout(loadTimer);\n      clearTimeout(timeoutTimer);\n    };\n  }, [timeout, isLoaded]);\n\n  // Mark as loaded when component mounts\n  useEffect(() => {\n    setIsLoaded(true);\n  }, []);\n\n  if (isTimedOut) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n        <div className=\"max-w-md w-full bg-white rounded-lg shadow-lg p-6 text-center\">\n          <div className=\"text-yellow-500 text-6xl mb-4\"></div>\n          <h1 className=\"text-2xl font-bold text-gray-900 mb-2\">Loading timeout</h1>\n          <p className=\"text-gray-600 mb-4\">\n            The page is taking longer than expected to load. This might be due to a slow connection.\n          </p>\n          <button\n            onClick={() => window.location.reload()}\n            className=\"btn-base btn-info py-2 px-4\"\n          >\n            Try Again\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return children;\n}","path":null,"size_bytes":1558,"size_tokens":null},"src/polyfills.js":{"content":"// Polyfills for browser compatibility and to prevent hanging\n// Only run in browser environment\n\nif (typeof window !== 'undefined') {\n  // Add timeout to fetch requests to prevent hanging\n  const originalFetch = window.fetch;\n  window.fetch = function(url, options = {}) {\n    const timeout = options.timeout || 10000; // 10 second default timeout\n    \n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), timeout);\n    \n    return originalFetch(url, {\n      ...options,\n      signal: controller.signal\n    }).finally(() => {\n      clearTimeout(timeoutId);\n    });\n  };\n\n  // Add error handling for unhandled promise rejections\n  window.addEventListener('unhandledrejection', function(event) {\n    console.warn('Unhandled promise rejection:', event.reason);\n    // Only prevent default in production to avoid masking dev errors\n    if (process.env.NODE_ENV === 'production') {\n      event.preventDefault();\n    }\n  });\n}","path":null,"size_bytes":973,"size_tokens":null},"src/utils/schemas.js":{"content":"// Zod validation schemas for authentication forms\n\nimport { z } from 'zod';\n\n// Common email schema with normalization\nexport const emailSchema = z\n  .string()\n  .min(1, 'Email is required')\n  .email('Please enter a valid email address')\n  .transform((email) => email.toLowerCase().trim());\n\n// Simple password schema for sign-up - just require 8 characters minimum\nexport const passwordSchema = z\n  .string()\n  .min(1, 'Password is required')\n  .min(8, 'Password must be at least 8 characters');\n\n// Simplified password schema for sign-in (just check if not empty)\nexport const signInPasswordSchema = z\n  .string()\n  .min(1, 'Password is required');\n\n// Name schema\nexport const nameSchema = z\n  .string()\n  .min(1, 'Name is required')\n  .min(2, 'Name must be at least 2 characters long')\n  .max(50, 'Name must be less than 50 characters')\n  .regex(/^[a-zA-Z\\s'-]+$/, 'Name can only contain letters, spaces, hyphens, and apostrophes')\n  .transform((name) => name.trim());\n\n// Sign In Form Schema\nexport const signInSchema = z.object({\n  email: emailSchema,\n  password: signInPasswordSchema,\n});\n\n// Sign Up Form Schema\nexport const signUpSchema = z.object({\n  name: nameSchema,\n  email: emailSchema,\n  password: passwordSchema,\n});\n\n// Forgot Password Form Schema\nexport const forgotPasswordSchema = z.object({\n  email: emailSchema,\n});\n\n// Helper function to extract first validation error message\nexport const getValidationError = (result) => {\n  if (result.success) return null;\n  \n  // Zod uses 'issues' not 'errors'\n  const firstIssue = result.error?.issues?.[0];\n  return firstIssue?.message || 'Validation failed';\n};","path":null,"size_bytes":1626,"size_tokens":null},"src/hooks/useFocusTrap.js":{"content":"// Custom hook for managing focus trap in modals\n\nimport { useEffect, useRef } from 'react';\n\nexport const useFocusTrap = (isOpen) => {\n  const modalRef = useRef(null);\n  const previousActiveElementRef = useRef(null);\n\n  useEffect(() => {\n    if (!isOpen) return;\n\n    // Store the currently focused element\n    previousActiveElementRef.current = document.activeElement;\n\n    // Find all focusable elements in the modal\n    const getFocusableElements = () => {\n      if (!modalRef.current) return [];\n      \n      const focusableSelectors = [\n        'button:not([disabled])',\n        'input:not([disabled])',\n        'textarea:not([disabled])',\n        'select:not([disabled])',\n        'a[href]',\n        '[tabindex]:not([tabindex=\"-1\"])'\n      ].join(', ');\n      \n      return Array.from(modalRef.current.querySelectorAll(focusableSelectors));\n    };\n\n    // Focus the first focusable element\n    const focusFirstElement = () => {\n      const focusableElements = getFocusableElements();\n      if (focusableElements.length > 0) {\n        focusableElements[0].focus();\n      }\n    };\n\n    // Handle tab key navigation\n    const handleKeyDown = (event) => {\n      if (event.key === 'Tab') {\n        const focusableElements = getFocusableElements();\n        if (focusableElements.length === 0) return;\n\n        const firstElement = focusableElements[0];\n        const lastElement = focusableElements[focusableElements.length - 1];\n\n        if (event.shiftKey) {\n          // Shift + Tab: move focus to last element if currently on first\n          if (document.activeElement === firstElement) {\n            event.preventDefault();\n            lastElement.focus();\n          }\n        } else {\n          // Tab: move focus to first element if currently on last\n          if (document.activeElement === lastElement) {\n            event.preventDefault();\n            firstElement.focus();\n          }\n        }\n      }\n    };\n\n    // Set initial focus after a brief delay to ensure DOM is ready\n    const timeoutId = setTimeout(focusFirstElement, 100);\n\n    // Add event listener for tab navigation\n    document.addEventListener('keydown', handleKeyDown);\n\n    // Disable body scroll\n    document.body.style.overflow = 'hidden';\n\n    // Cleanup function\n    return () => {\n      clearTimeout(timeoutId);\n      document.removeEventListener('keydown', handleKeyDown);\n      \n      // Restore body scroll\n      document.body.style.overflow = '';\n      \n      // Restore focus to previous element\n      if (previousActiveElementRef.current && typeof previousActiveElementRef.current.focus === 'function') {\n        previousActiveElementRef.current.focus();\n      }\n    };\n  }, [isOpen]);\n\n  // Handle Escape key\n  useEffect(() => {\n    if (!isOpen) return;\n\n    const handleEscapeKey = (event) => {\n      if (event.key === 'Escape') {\n        // This should be handled by the parent component\n        // We'll dispatch a custom event that the modal can listen to\n        const escapeEvent = new CustomEvent('modal-escape');\n        document.dispatchEvent(escapeEvent);\n      }\n    };\n\n    document.addEventListener('keydown', handleEscapeKey);\n\n    return () => {\n      document.removeEventListener('keydown', handleEscapeKey);\n    };\n  }, [isOpen]);\n\n  return modalRef;\n};","path":null,"size_bytes":3265,"size_tokens":null},"src/app/forgot-password/page.js":{"content":"\"use client\";\n\nimport { useEffect, useRef, useState } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { validateEmail, validateForm } from '../../utils/validation';\nimport { useAuth } from '../../hooks/useAuth';\nimport { Caveat } from \"next/font/google\";\nimport Link from \"next/link\";\n\nconst caveat = Caveat({ subsets: [\"latin\"], weight: [\"700\"] });\n\nexport default function ForgotPasswordPage() {\n  const router = useRouter();\n  const { user, loading: authLoading, forgotPassword } = useAuth();\n  \n  const [validationErrors, setValidationErrors] = useState({});\n  const [fieldValidation, setFieldValidation] = useState({});\n  const [error, setError] = useState('');\n  const [loading, setLoading] = useState(false);\n  const [success, setSuccess] = useState(false);\n  \n  // Refs for form validation scrolling\n  const emailRef = useRef();\n\n  // Redirect if already signed in\n  useEffect(() => {\n    if (user && !authLoading) {\n      router.push('/');\n    }\n  }, [user, authLoading, router]);\n\n  const scrollToField = (fieldName) => {\n    const fieldRefs = {\n      email: emailRef\n    };\n    \n    const fieldRef = fieldRefs[fieldName];\n    if (fieldRef?.current) {\n      fieldRef.current.scrollIntoView({\n        behavior: 'smooth',\n        block: 'center'\n      });\n      // Focus the field after scrolling\n      setTimeout(() => {\n        fieldRef.current.focus();\n      }, 300);\n    }\n  };\n\n  const validateFormFields = (formData) => {\n    const validation = validateForm(formData, 'forgot-password');\n    \n    setValidationErrors(validation.errors);\n    \n    // If there are errors, scroll to the first error field\n    if (validation.firstErrorField) {\n      setTimeout(() => scrollToField(validation.firstErrorField), 100);\n    }\n    \n    return validation.isValid;\n  };\n\n  const handleInputChange = (field, value) => {\n    // Clear form validation errors when user starts typing\n    if (validationErrors[field]) {\n      setValidationErrors(prev => ({ ...prev, [field]: '' }));\n    }\n    \n    // Perform real-time validation\n    let validationError = null;\n    let isValid = false;\n    \n    if (field === 'email' && value.trim()) {\n      validationError = validateEmail(value);\n      isValid = !validationError;\n    }\n    \n    // Update field validation status\n    setFieldValidation(prev => ({\n      ...prev,\n      [field]: {\n        isValid,\n        error: validationError,\n        hasValue: value.trim().length > 0\n      }\n    }));\n  };\n\n  const handleForgotPassword = async (e) => {\n    e.preventDefault();\n    const formData = new FormData(e.target);\n    \n    if (!validateFormFields(formData)) {\n      return;\n    }\n\n    setLoading(true);\n    setError('');\n\n    try {\n      const result = await forgotPassword(formData.get('email'));\n      if (result.success) {\n        setSuccess(true);\n      } else {\n        setError(result.error || 'Failed to send reset email');\n      }\n    } catch (err) {\n      setError('Failed to send reset email');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  // Don't show loading overlay during auth actions - keep form visible\n\n  // Show success message\n  if (success) {\n    return (\n      <div className=\"min-h-screen bg-white\">\n        {/* Frame Logo */}\n        <div className=\"absolute top-6 left-6 z-50 mb-8\">\n          <Link \n            href=\"/\" \n            className={`${caveat.className} text-2xl md:text-3xl font-bold text-emerald-700 hover:text-emerald-800 transition-all duration-300 hover:scale-110`}\n          >\n            Frame\n          </Link>\n        </div>\n        \n        <div className=\"min-h-screen flex\">\n          {/* Left Side - Success Message */}\n          <div className=\"flex-1 w-full flex flex-col justify-center py-8 px-4 sm:px-6 lg:px-16 xl:px-20 pt-20\">\n            <div className=\"mx-auto w-full max-w-sm lg:max-w-md\">\n              {/* Header with Yellow Background */}\n              <div className=\"text-center mb-6 bg-yellow-400 px-4 py-3 rounded-t-lg\">\n                <div className=\"mx-auto w-12 h-12 bg-emerald-100 rounded-full flex items-center justify-center mb-3\">\n                  <svg className=\"w-6 h-6 text-emerald-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                  </svg>\n                </div>\n                <h2 className=\"text-2xl font-bold text-emerald-700\">Check Your Email</h2>\n                <p className=\"mt-1 text-black text-sm\">Reset link sent successfully</p>\n              </div>\n              \n              {/* Content Card */}\n              <div className=\"bg-white rounded-b-lg border border-t-0 border-gray-200 px-6 py-6 shadow-sm\">\n                <p className=\"text-gray-600 text-sm mb-4 text-center\">\n                  We've sent a password reset link to your email address. Click the link to reset your password.\n                </p>\n                \n                <div className=\"text-xs text-gray-500 space-y-1 mb-6 bg-gray-50 p-3 rounded-lg\">\n                  <p> Check your spam/promotions folder if you don't see it</p>\n                  <p> The reset link will expire in 1 hour</p>\n                  <p> If you don't receive an email, you may not have an account yet</p>\n                </div>\n\n                <div className=\"space-y-4\">\n                  <button \n                    onClick={() => router.push('/signin')}\n                    className=\"btn-base btn-primary w-full py-3 px-4 font-medium text-sm\"\n                  >\n                    Back to Sign In\n                  </button>\n                  \n                  <div className=\"text-center\">\n                    <p className=\"text-sm text-gray-500\">\n                      Didn't receive the email? \n                      <button \n                        onClick={() => setSuccess(false)}\n                        className=\"btn-base btn-link font-medium ml-1\"\n                      >\n                        Send another reset link\n                      </button>\n                    </p>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-white flex\">\n      {/* Frame Logo - Top Left */}\n      <div className=\"absolute top-6 left-6 z-10\">\n        <Link \n          href=\"/\" \n          className={`${caveat.className} text-2xl md:text-3xl font-bold text-emerald-700 hover:text-emerald-800 transition-all duration-300 hover:scale-110`}\n        >\n          Frame\n        </Link>\n      </div>\n\n      {/* Left Side - Form */}\n      <div className=\"flex-1 flex items-center justify-center px-4 sm:px-6 lg:px-8 py-12\">\n        <div className=\"max-w-sm w-full space-y-6\">\n          {/* Header */}\n          <div className=\"text-center bg-yellow-400 px-4 py-3 rounded-t-lg\">\n            <h2 className=\"text-2xl font-bold text-emerald-700\">Reset Password</h2>\n            <p className=\"mt-1 text-black text-sm\">We'll send you a reset link</p>\n          </div>\n\n          {/* Content Card with Shadow Border */}\n          <div className=\"bg-white rounded-b-lg border border-t-0 border-gray-200 px-6 py-6 shadow-sm\">\n            {/* Forgot Password Form */}\n            <form className=\"space-y-4 mb-4\" onSubmit={handleForgotPassword} noValidate>\n              {error && (\n                <div \n                  className=\"text-sm p-3 rounded-lg border text-red-800 bg-red-50 border-red-200\"\n                  role=\"alert\"\n                >\n                  {error}\n                </div>\n              )}\n              <div>\n                <label htmlFor=\"forgot-password-email\" className=\"block text-sm font-medium text-gray-800 mb-1\">\n                  Email Address\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={emailRef}\n                    id=\"forgot-password-email\"\n                    type=\"email\"\n                    name=\"email\"\n                    required\n                    placeholder=\"Enter your email address\"\n                    onChange={(e) => handleInputChange('email', e.target.value)}\n                    className={`w-full px-3 py-2 pr-10 border rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all duration-300 text-gray-900 placeholder-gray-500 text-sm ${\n                      validationErrors.email ? 'border-red-300 bg-red-50' : \n                      fieldValidation.email?.isValid ? 'border-emerald-300 bg-emerald-50' :\n                      fieldValidation.email?.hasValue ? 'border-red-300 bg-red-50' :\n                      'border-gray-300'\n                    }`}\n                  />\n                  {/* Validation Icon */}\n                  {(validationErrors.email || (fieldValidation.email?.hasValue && !fieldValidation.email?.isValid)) && (\n                    <div className=\"absolute right-3 top-1/2 transform -translate-y-1/2\">\n                      {fieldValidation.email?.isValid && !validationErrors.email ? (\n                        <svg className=\"w-5 h-5 text-emerald-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                        </svg>\n                      ) : (\n                        <svg \n                          className=\"w-5 h-5 text-red-500\" \n                          fill=\"none\" \n                          stroke=\"currentColor\" \n                          viewBox=\"0 0 24 24\"\n                        >\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                        </svg>\n                      )}\n                    </div>\n                  )}\n                </div>\n                {validationErrors.email && (\n                  <p className=\"text-red-600 text-sm mt-1\">{validationErrors.email}</p>\n                )}\n                <div className=\"text-xs text-gray-500 mt-2\">\n                  <p>We'll send a secure password reset link to this email address.</p>\n                </div>\n              </div>\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full btn-base btn-primary py-2 px-4 text-sm\"\n              >\n                {loading ? 'Sending...' : 'Send Reset Link'}\n              </button>\n            </form>\n\n            <div className=\"text-center\">\n              <p className=\"text-sm text-gray-500\">\n                Remember your password? \n                <button \n                  onClick={() => router.push('/signin')}\n                  className=\"btn-base btn-link font-medium ml-1\"\n                >\n                  Sign In\n                </button>\n              </p>\n            </div>\n          </div>\n        </div>\n      </div>\n\n    </div>\n  );\n}","path":null,"size_bytes":10952,"size_tokens":null},"src/components/Header.js":{"content":"\"use client\";\n\nimport { Caveat } from \"next/font/google\";\nimport { useState } from \"react\";\nimport Link from \"next/link\";\nimport NotificationBell from \"./notifications/NotificationBell\";\n\nconst caveat = Caveat({ subsets: [\"latin\"], weight: [\"700\"] });\n\nexport default function Header({ isMenuOpen, setIsMenuOpen }) {\n  const handleSearch = () => {\n    // Search functionality can be implemented here\n  };\n\n  return (\n    <header className=\"bg-yellow-400 text-black py-4 sm:py-5 md:py-6 border-0 shadow-none relative z-40\">\n      <div className=\"mx-auto w-full max-w-screen-xl px-3 sm:px-4 md:px-6 flex items-center justify-between\">\n        <Link \n          href=\"/\" \n          className={`${caveat.className} text-2xl sm:text-3xl md:text-4xl font-bold text-emerald-700 hover:text-emerald-800 transition-colors duration-200`}\n        >\n          Frame\n        </Link>\n        <div className=\"w-48 sm:w-64 md:w-80 lg:w-96 mx-4 relative\">\n          <input\n            type=\"text\"\n            placeholder=\"Search\"\n            className=\"w-full px-3 py-3 pr-8 rounded-full bg-white text-black placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-emerald-700 text-sm min-h-[44px]\"\n          />\n          <button \n            onClick={handleSearch}\n            className=\"btn-base absolute right-2 top-1/2 transform -translate-y-1/2 p-1 rounded hover:text-emerald-700\"\n          >\n            <svg \n              className=\"w-4 h-4 text-gray-500\" \n              fill=\"none\" \n              stroke=\"currentColor\" \n              viewBox=\"0 0 24 24\"\n            >\n              <path \n                strokeLinecap=\"round\" \n                strokeLinejoin=\"round\" \n                strokeWidth={2} \n                d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\" \n              />\n            </svg>\n          </button>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <NotificationBell />\n          <button\n            onClick={() => setIsMenuOpen(!isMenuOpen)}\n            className=\"btn-base btn-secondary p-2 rounded-full relative z-50\"\n          >\n            <svg \n              className=\"w-6 h-6 text-black\" \n              fill=\"none\" \n              stroke=\"currentColor\" \n              viewBox=\"0 0 24 24\"\n            >\n              <path \n                strokeLinecap=\"round\" \n                strokeLinejoin=\"round\" \n                strokeWidth={2} \n                d={isMenuOpen ? \"M6 18L18 6M6 6l12 12\" : \"M4 6h16M4 12h16M4 18h16\"}\n              />\n            </svg>\n          </button>\n        </div>\n      </div>\n    </header>\n  );\n}","path":null,"size_bytes":2575,"size_tokens":null},"src/components/LoadingSpinner.js":{"content":"'use client';\n\nexport default function LoadingSpinner({ size = 'md', className = '' }) {\n  const sizeClasses = {\n    sm: 'w-4 h-4',\n    md: 'w-8 h-8', \n    lg: 'w-12 h-12',\n    xl: 'w-16 h-16'\n  };\n\n  return (\n    <div className={`border-2 border-emerald-500 border-t-transparent rounded-full animate-spin ${sizeClasses[size]} ${className}`}></div>\n  );\n}","path":null,"size_bytes":355,"size_tokens":null},"src/components/Hero.js":{"content":"\"use client\";\n\nimport { Caveat } from \"next/font/google\";\nimport { useState } from \"react\";\nimport CreateCampaignModal from \"./CreateCampaignModal\";\n\nconst caveat = Caveat({ subsets: [\"latin\"], weight: [\"700\"] });\n\nexport default function Hero() {\n  const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);\n\n  const handleModalClose = (navigated) => {\n    setIsCreateModalOpen(false);\n  };\n\n  return (\n    <>\n      <section className=\"bg-yellow-400 text-black py-12 sm:py-16 md:py-24 border-0 shadow-none -mt-px\">\n        <div className=\"mx-auto w-full max-w-screen-xl px-3 sm:px-4 md:px-6 text-center\">\n          <h1 className={`${caveat.className} text-5xl sm:text-7xl md:text-8xl font-bold text-emerald-700 whitespace-nowrap`}>\n            Frame Your Voice\n          </h1>\n          <p className=\"mt-3 sm:mt-4 md:mt-6 text-sm sm:text-base md:text-lg opacity-90\">\n            Create and share frames that amplify your message, celebrate your cause, and inspire others to join in.\n          </p>\n          <div className=\"mt-6 sm:mt-8 flex flex-row items-center justify-center gap-3 sm:gap-5 flex-nowrap\">\n            <button\n              onClick={() => setIsCreateModalOpen(true)}\n              className=\"btn-base btn-primary px-4 py-2.5 sm:px-7 sm:py-4 text-sm sm:text-base md:text-lg font-semibold whitespace-nowrap\"\n            >\n              Create Campaign\n            </button>\n            <a\n              href=\"/campaigns\"\n              className=\"btn-base btn-secondary border-2 border-emerald-700 px-4 py-2.5 sm:px-7 sm:py-4 text-emerald-800 text-sm sm:text-base md:text-lg font-semibold whitespace-nowrap\"\n            >\n              Browse Campaigns\n            </a>\n          </div>\n        </div>\n      </section>\n\n      <CreateCampaignModal \n        isOpen={isCreateModalOpen} \n        onClose={handleModalClose} \n      />\n    </>\n  );\n}\n","path":null,"size_bytes":1868,"size_tokens":null},"src/app/layout.js":{"content":"import { Geist, Geist_Mono } from \"next/font/google\";\nimport Script from \"next/script\";\nimport { Suspense } from \"react\";\nimport \"./globals.css\";\nimport ClientAuthProvider from \"../components/ClientAuthProvider\";\nimport ErrorBoundary from \"../components/ErrorBoundary\";\nimport TimeoutWrapper from \"../components/TimeoutWrapper\";\nimport AuthenticatedLayout from \"../components/AuthenticatedLayout\";\nimport AuthGate from \"../components/AuthGate\";\nimport { CampaignSessionProvider } from \"../contexts/CampaignSessionContext\";\nimport NotificationProvider from \"../components/notifications/NotificationProvider\";\nimport Analytics from \"./analytics\";\n\nconst geistSans = Geist({\n  variable: \"--font-geist-sans\",\n  subsets: [\"latin\"],\n});\n\nconst geistMono = Geist_Mono({\n  variable: \"--font-geist-mono\",\n  subsets: [\"latin\"],\n});\n\nexport const metadata = {\n  title: \"Frame Your Voice - Twibbonize App\",\n  description: \"Create and share frames that amplify your message, celebrate your cause, and inspire others to join in.\",\n};\n\nexport default function RootLayout({ children }) {\n  const gaId = process.env.NEXT_PUBLIC_GA_MEASUREMENT_ID;\n\n  return (\n    <html lang=\"en\" suppressHydrationWarning={true}>\n      <body\n        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\n        suppressHydrationWarning={true}\n      >\n        {gaId && (\n          <>\n            <Script\n              src={`https://www.googletagmanager.com/gtag/js?id=${gaId}`}\n              strategy=\"afterInteractive\"\n            />\n            <Script id=\"google-analytics\" strategy=\"afterInteractive\">\n              {`\n                window.dataLayer = window.dataLayer || [];\n                function gtag(){dataLayer.push(arguments);}\n                gtag('js', new Date());\n                gtag('config', '${gaId}', {\n                  page_path: window.location.pathname,\n                });\n              `}\n            </Script>\n          </>\n        )}\n        <ErrorBoundary>\n          <TimeoutWrapper timeout={15000}>\n            <ClientAuthProvider>\n              <NotificationProvider>\n                <CampaignSessionProvider>\n                  <AuthenticatedLayout>\n                    <AuthGate>\n                      {children}\n                    </AuthGate>\n                  </AuthenticatedLayout>\n                </CampaignSessionProvider>\n              </NotificationProvider>\n            </ClientAuthProvider>\n          </TimeoutWrapper>\n        </ErrorBoundary>\n        {gaId && (\n          <Suspense fallback={null}>\n            <Analytics />\n          </Suspense>\n        )}\n      </body>\n    </html>\n  );\n}\n","path":null,"size_bytes":2618,"size_tokens":null},"src/app/(chrome)/campaign/[slug]/page.js":{"content":"\"use client\";\n\nimport { useState, useRef, useEffect } from 'react';\nimport Image from 'next/image';\nimport { useParams, useRouter } from 'next/navigation';\nimport { getCampaignBySlug } from '../../../../lib/firestore';\nimport { useCampaignSession } from '../../../../contexts/CampaignSessionContext';\nimport { useAuth } from '../../../../hooks/useAuth';\nimport { getCampaignPreview, getProfileAvatar } from '../../../../utils/imageTransform';\nimport { abbreviateNumber } from '../../../../utils/validation';\nimport LoadingSpinner from '../../../../components/LoadingSpinner';\nimport CampaignStepIndicator from '../../../../components/CampaignStepIndicator';\nimport ReportModal from '../../../../components/ReportModal';\nimport ErrorBoundary from '../../../../components/ErrorBoundary';\n\nexport default function CampaignUploadPage() {\n  return (\n    <ErrorBoundary>\n      <CampaignUploadContent />\n    </ErrorBoundary>\n  );\n}\n\nfunction CampaignUploadContent() {\n  const params = useParams();\n  const router = useRouter();\n  const { user } = useAuth();\n  const slug = params.slug;\n  const campaignSession = useCampaignSession();\n\n  // State\n  const [campaign, setCampaign] = useState(null);\n  const [creator, setCreator] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [notFound, setNotFound] = useState(false);\n  const [uploading, setUploading] = useState(false);\n  const [error, setError] = useState('');\n  \n  // Report modal state\n  const [showReportModal, setShowReportModal] = useState(false);\n\n  const fileInputRef = useRef();\n\n  // Fetch campaign data - only run when slug changes\n  useEffect(() => {\n    const fetchCampaign = async () => {\n      if (!slug) return;\n      \n      setLoading(true);\n      try {\n        const result = await getCampaignBySlug(slug);\n        \n        if (!result) {\n          setNotFound(true);\n          setLoading(false);\n          return;\n        }\n        \n        setCampaign(result.campaign);\n        setCreator(result.creator);\n        \n        // Store campaign and creator data in session\n        campaignSession.setCampaignData(slug, result.campaign);\n        campaignSession.setCreatorData(slug, result.creator);\n        \n        setLoading(false);\n      } catch (error) {\n        console.error('Error fetching campaign:', error);\n        setNotFound(true);\n        setLoading(false);\n      }\n    };\n    \n    fetchCampaign();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [slug]);\n\n  // Handle photo selection\n  const handlePhotoSelect = async (e) => {\n    const file = e.target.files[0];\n    if (!file) return;\n    \n    setError('');\n    setUploading(true);\n    \n    // File size validation (10MB limit)\n    const maxSize = 10 * 1024 * 1024;\n    if (file.size > maxSize) {\n      setError(`Photo must be smaller than 10MB. Current size: ${(file.size / (1024 * 1024)).toFixed(1)}MB`);\n      setUploading(false);\n      return;\n    }\n    \n    // File type validation\n    const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp'];\n    if (!validTypes.includes(file.type)) {\n      setError('Please upload a PNG, JPG, or WEBP image');\n      setUploading(false);\n      return;\n    }\n    \n    // Create preview\n    const reader = new FileReader();\n    reader.onload = async (event) => {\n      // Store in session\n      campaignSession.setUserPhoto(slug, file, event.target.result);\n      \n      // Initialize adjustments\n      campaignSession.setAdjustments(slug, { scale: 1.0, x: 0, y: 0 });\n      \n      // Redirect to adjust page\n      router.push(`/campaign/${slug}/adjust`);\n    };\n    \n    reader.onerror = () => {\n      setError('Failed to read image file');\n      setUploading(false);\n    };\n    \n    reader.readAsDataURL(file);\n  };\n\n  // Share functionality\n  const handleShare = async (platform) => {\n    const url = window.location.href;\n    const text = campaign.title + (campaign.description ? ` - ${campaign.description}` : '');\n    \n    switch (platform) {\n      case 'twitter':\n        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');\n        break;\n      case 'facebook':\n        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');\n        break;\n      case 'whatsapp':\n        window.open(`https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`, '_blank');\n        break;\n      default:\n        break;\n    }\n  };\n\n  // Loading state\n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-white flex items-center justify-center\">\n        <LoadingSpinner />\n      </div>\n    );\n  }\n\n  // Not found state\n  if (notFound || !campaign) {\n    return (\n      <div className=\"min-h-screen bg-white flex items-center justify-center px-4\">\n        <div className=\"text-center\">\n          <h1 className=\"text-4xl font-bold text-gray-900 mb-4\">Campaign Not Found</h1>\n          <p className=\"text-gray-600 mb-8\">This campaign doesn't exist or has been removed.</p>\n          <button\n            onClick={() => router.push('/')}\n            className=\"btn-base btn-primary px-6 py-3 font-medium\"\n          >\n            Go Home\n          </button>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-white\">\n      <div className=\"min-h-screen flex\">\n        {/* Main Content */}\n        <div className=\"flex-1 w-full flex flex-col py-8 px-4 sm:px-6 lg:px-8 pt-20\">\n          <div className=\"mx-auto w-full max-w-5xl\">\n            \n            {/* Header */}\n            <div className=\"text-center mb-6 bg-yellow-400 px-6 py-5 rounded-t-xl\">\n              <CampaignStepIndicator currentStep={1} />\n              <h1 className=\"text-2xl sm:text-3xl font-bold text-gray-900 mb-1\">{campaign.title}</h1>\n              {campaign.description && (\n                <p className=\"text-sm text-gray-800 mt-1\">{campaign.description}</p>\n              )}\n            </div>\n            \n            {/* Content Card */}\n            <div className=\"bg-white rounded-b-xl border border-t-0 border-gray-200 shadow-sm\">\n              \n              {error && (\n                <div className=\"mx-4 mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm text-center\">\n                  {error}\n                </div>\n              )}\n\n              <div className=\"grid grid-cols-1 lg:grid-cols-[minmax(0,1.1fr)_minmax(320px,0.9fr)] gap-6 p-4 sm:p-6\">\n                \n                {/* Left: Campaign Preview */}\n                <div className=\"space-y-3\">\n                  <h2 className=\"text-lg font-bold text-gray-900\">Campaign Preview</h2>\n                  \n                  <div className=\"relative w-full rounded-lg border-2 border-gray-300 overflow-hidden\" style={{ maxHeight: '500px' }}>\n                    <div className=\"relative w-full\" style={{ paddingBottom: '100%' }}>\n                      <Image\n                        src={getCampaignPreview(campaign.imageUrl)}\n                        alt={campaign.title}\n                        fill\n                        className=\"object-contain\"\n                        unoptimized\n                      />\n                    </div>\n                    <div className=\"absolute top-4 right-4 bg-emerald-500 text-white px-3 py-1 rounded-full text-xs font-semibold uppercase\">\n                      {campaign.type === 'frame' ? 'Frame' : 'Background'}\n                    </div>\n                  </div>\n\n                  {creator && (\n                    <div className=\"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200\">\n                      {creator.profileImage && (\n                        <div className=\"relative w-10 h-10 rounded-full border-2 border-gray-300 overflow-hidden flex-shrink-0\">\n                          <Image\n                            src={getProfileAvatar(creator.profileImage)}\n                            alt={creator.displayName}\n                            fill\n                            className=\"object-cover\"\n                            unoptimized\n                          />\n                        </div>\n                      )}\n                      <div className=\"flex-1\">\n                        <p className=\"text-sm text-gray-600\">Created by</p>\n                        <button\n                          onClick={() => router.push(`/u/${creator.username}`)}\n                          className=\"font-semibold text-gray-900 hover:underline text-sm\"\n                        >\n                          {creator.displayName || creator.username}\n                        </button>\n                        <p className=\"text-xs text-gray-600\">\n                          {abbreviateNumber(campaign.supportersCount || 0)} {campaign.supportersCount === 1 ? 'support' : 'supports'}\n                        </p>\n                      </div>\n                    </div>\n                  )}\n                </div>\n\n                {/* Right: Upload & Actions */}\n                <div className=\"space-y-5\">\n                  \n                  {/* Upload Section */}\n                  <div>\n                    <h2 className=\"text-lg font-bold text-gray-900 mb-3\">Add Your Photo</h2>\n                    <p className=\"text-sm text-gray-600 mb-4\">\n                      Upload your photo to create your personalized {campaign.type === 'frame' ? 'frame' : 'background'}\n                    </p>\n                    \n                    <input\n                      ref={fileInputRef}\n                      type=\"file\"\n                      accept=\"image/png,image/jpeg,image/jpg,image/webp\"\n                      onChange={handlePhotoSelect}\n                      disabled={uploading}\n                      className=\"hidden\"\n                      id=\"user-photo-input\"\n                    />\n                    \n                    <label\n                      htmlFor=\"user-photo-input\"\n                      className={`btn-base btn-primary w-full text-center py-4 cursor-pointer font-bold text-lg ${\n                        uploading ? 'opacity-70 cursor-wait' : ''\n                      }`}\n                    >\n                      {uploading ? 'Loading...' : 'Choose Your Photo'}\n                    </label>\n                    \n                    <p className=\"text-xs text-gray-600 mt-2 text-center\">\n                      PNG, JPG, or WEBP (max 10MB)\n                    </p>\n                  </div>\n\n                  {/* Share Campaign */}\n                  <div className=\"pt-3 border-t border-gray-200\">\n                    <h3 className=\"text-lg font-bold text-gray-900 mb-3\">Share Campaign</h3>\n                    <div className=\"grid grid-cols-3 gap-3\">\n                      <button\n                        onClick={() => handleShare('twitter')}\n                        className=\"btn-base btn-twitter py-3 text-sm\"\n                      >\n                        Twitter\n                      </button>\n                      <button\n                        onClick={() => handleShare('facebook')}\n                        className=\"btn-base btn-facebook py-3 text-sm\"\n                      >\n                        Facebook\n                      </button>\n                      <button\n                        onClick={() => handleShare('whatsapp')}\n                        className=\"btn-base btn-whatsapp py-3 text-sm\"\n                      >\n                        WhatsApp\n                      </button>\n                    </div>\n                  </div>\n\n                  {/* Report Button */}\n                  <button\n                    onClick={() => setShowReportModal(true)}\n                    className=\"btn-base bg-red-100 hover:bg-red-200 text-red-700 w-full py-2 text-sm font-medium\"\n                  >\n                    Report Campaign\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Report Modal */}\n      <ReportModal\n        isOpen={showReportModal}\n        onClose={() => setShowReportModal(false)}\n        type=\"campaign\"\n        campaignId={campaign?.id}\n        campaignSlug={campaign?.slug}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":12179,"size_tokens":null},"src/components/admin/AdminActionButton.js":{"content":"\"use client\";\n\nimport { useState } from \"react\";\n\n/**\n * Reusable action button with loading state and optional confirmation\n * \n * @param {Object} props\n * @param {Function} props.onClick - Click handler (can be async)\n * @param {string} props.children - Button text\n * @param {string} props.variant - Button style: 'primary', 'danger', 'warning', 'success'\n * @param {boolean} props.requireConfirm - Show confirmation dialog\n * @param {string} props.confirmTitle - Confirmation dialog title\n * @param {string} props.confirmMessage - Confirmation dialog message\n * @param {string} props.confirmButtonText - Confirm button text\n * @param {string} props.loadingText - Text to show when loading\n * @param {string} props.icon - Optional icon element\n * @param {boolean} props.disabled - Disabled state\n * @param {string} props.size - Button size: 'sm', 'md', 'lg'\n * @param {string} props.className - Additional CSS classes\n */\nexport default function AdminActionButton({\n  onClick,\n  children,\n  variant = 'primary',\n  requireConfirm = false,\n  confirmTitle = 'Confirm Action',\n  confirmMessage = 'Are you sure you want to proceed?',\n  confirmButtonText = 'Confirm',\n  loadingText = 'Processing...',\n  icon = null,\n  disabled = false,\n  size = 'md',\n  className = '',\n}) {\n  const [isLoading, setIsLoading] = useState(false);\n  const [showConfirm, setShowConfirm] = useState(false);\n  const [error, setError] = useState(null);\n\n  const getVariantClasses = () => {\n    const baseClasses = 'btn-base transition-colors disabled:opacity-50 disabled:cursor-not-allowed';\n    \n    const sizeClasses = {\n      sm: 'text-sm py-1 px-3',\n      md: 'text-base py-2 px-4',\n      lg: 'text-lg py-3 px-6',\n    };\n    \n    const variantClasses = {\n      primary: 'bg-emerald-600 text-white hover:bg-emerald-700',\n      danger: 'bg-red-600 text-white hover:bg-red-700',\n      warning: 'bg-yellow-600 text-white hover:bg-yellow-700',\n      success: 'bg-green-600 text-white hover:bg-green-700',\n      secondary: 'bg-gray-600 text-white hover:bg-gray-700',\n    };\n    \n    return `${baseClasses} ${sizeClasses[size]} ${variantClasses[variant]} ${className}`;\n  };\n\n  const handleClick = async () => {\n    if (requireConfirm) {\n      setShowConfirm(true);\n      return;\n    }\n    \n    await executeAction();\n  };\n\n  const executeAction = async () => {\n    setIsLoading(true);\n    setError(null);\n    \n    try {\n      await onClick();\n      setShowConfirm(false);\n    } catch (err) {\n      console.error('Action error:', err);\n      setError(err.message || 'An error occurred');\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleConfirm = async () => {\n    await executeAction();\n  };\n\n  const handleCancel = () => {\n    setShowConfirm(false);\n    setError(null);\n  };\n\n  return (\n    <>\n      <button\n        onClick={handleClick}\n        disabled={disabled || isLoading}\n        className={getVariantClasses()}\n      >\n        {isLoading ? (\n          <span className=\"flex items-center gap-2\">\n            <svg className=\"animate-spin h-4 w-4\" fill=\"none\" viewBox=\"0 0 24 24\">\n              <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\" />\n              <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\" />\n            </svg>\n            {loadingText}\n          </span>\n        ) : (\n          <span className=\"flex items-center gap-2\">\n            {icon}\n            {children}\n          </span>\n        )}\n      </button>\n\n      {error && (\n        <div className=\"mt-2 text-sm text-red-600 bg-red-50 p-2 rounded\">\n          {error}\n        </div>\n      )}\n\n      {showConfirm && (\n        <div className=\"fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 p-4\">\n          <div className=\"bg-white rounded-lg p-6 max-w-md w-full\">\n            <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">\n              {confirmTitle}\n            </h3>\n            <p className=\"text-sm text-gray-600 mb-6\">\n              {confirmMessage}\n            </p>\n            \n            {error && (\n              <div className=\"mb-4 text-sm text-red-600 bg-red-50 p-2 rounded\">\n                {error}\n              </div>\n            )}\n\n            <div className=\"flex gap-3\">\n              <button\n                onClick={handleCancel}\n                disabled={isLoading}\n                className=\"flex-1 btn-base bg-gray-600 text-white hover:bg-gray-700 disabled:opacity-50\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={handleConfirm}\n                disabled={isLoading}\n                className={`flex-1 btn-base ${\n                  variant === 'danger' \n                    ? 'bg-red-600 hover:bg-red-700' \n                    : 'bg-emerald-600 hover:bg-emerald-700'\n                } text-white disabled:opacity-50`}\n              >\n                {isLoading ? loadingText : confirmButtonText}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </>\n  );\n}\n","path":null,"size_bytes":5153,"size_tokens":null},"src/components/UserProfileProvider.js":{"content":"\"use client\";\n\nimport { createContext, useContext, useState, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { useOptionalAuth } from '../hooks/useAuth';\nimport { getUserProfile } from '../lib/firestore';\n\n// Create User Profile Context\nconst UserProfileContext = createContext(null);\n\nexport function UserProfileProvider({ children }) {\n  const { user, loading: authLoading, logout } = useOptionalAuth() || { user: null, loading: false, logout: async () => {} };\n  const [userProfile, setUserProfile] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const router = useRouter();\n\n  // Fetch user profile data from Firestore when user changes\n  useEffect(() => {\n    const fetchUserProfile = async () => {\n      if (!user) {\n        setUserProfile(null);\n        setLoading(false);\n        return;\n      }\n\n      try {\n        setLoading(true);\n        const profile = await getUserProfile(user.uid);\n        \n        // CHECK FOR BAN STATUS - Enforce ban immediately\n        if (profile?.accountStatus?.includes('banned')) {\n          if (process.env.NODE_ENV === 'development') {\n            console.log('User is banned, logging out...');\n          }\n          \n          // Store ban info in sessionStorage for ban page to display\n          if (typeof window !== 'undefined') {\n            sessionStorage.setItem('banInfo', JSON.stringify({\n              reason: profile.banReason || 'Your account has been suspended.',\n              bannedAt: profile.bannedAt || new Date().toISOString()\n            }));\n          }\n          \n          // Logout and redirect to banned page\n          await logout();\n          router.replace('/banned');\n          return;\n        }\n        \n        setUserProfile(profile);\n      } catch (error) {\n        if (process.env.NODE_ENV === 'development') {\n          console.error('Error fetching user profile:', error);\n        }\n        setUserProfile(null);\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    if (!authLoading) {\n      fetchUserProfile();\n    }\n  }, [user, authLoading, logout, router]);\n\n  // Function to update the user profile in context (called after profile updates)\n  const updateUserProfile = (updatedProfile) => {\n    setUserProfile(updatedProfile);\n  };\n\n  // Function to refresh user profile from Firestore\n  const refreshUserProfile = async () => {\n    if (!user) return;\n    \n    try {\n      const profile = await getUserProfile(user.uid);\n      setUserProfile(profile);\n    } catch (error) {\n      if (process.env.NODE_ENV === 'development') {\n        console.error('Error refreshing user profile:', error);\n      }\n    }\n  };\n\n  const value = {\n    userProfile,\n    loading: authLoading || loading,\n    updateUserProfile,\n    refreshUserProfile\n  };\n\n  return (\n    <UserProfileContext.Provider value={value}>\n      {children}\n    </UserProfileContext.Provider>\n  );\n}\n\nexport const useUserProfile = () => {\n  const context = useContext(UserProfileContext);\n  if (!context) {\n    throw new Error('useUserProfile must be used within a UserProfileProvider');\n  }\n  return context;\n};\n\n// Optional hook that doesn't crash if no provider\nexport const useOptionalUserProfile = () => {\n  const context = useContext(UserProfileContext);\n  return context;\n};","path":null,"size_bytes":3279,"size_tokens":null},"src/components/ClientAuthProvider.js":{"content":"'use client';\n\nimport { AuthProvider } from '../hooks/useAuth';\n\nexport default function ClientAuthProvider({ children }) {\n  return (\n    <AuthProvider>\n      {children}\n    </AuthProvider>\n  );\n}","path":null,"size_bytes":197,"size_tokens":null},"src/components/Footer.js":{"content":"\"use client\";\n\nimport { Caveat } from \"next/font/google\";\nimport { useState, useRef, useEffect } from \"react\";\nimport Link from \"next/link\";\n\nconst caveat = Caveat({ subsets: [\"latin\"], weight: [\"700\"] });\n\nconst countries = [\n  \"Afghanistan\", \"Albania\", \"Algeria\", \"Argentina\", \"Armenia\", \"Australia\", \"Austria\", \"Azerbaijan\",\n  \"Bahrain\", \"Bangladesh\", \"Belarus\", \"Belgium\", \"Bolivia\", \"Bosnia and Herzegovina\", \"Brazil\", \"Bulgaria\",\n  \"Cambodia\", \"Canada\", \"Chile\", \"China\", \"Colombia\", \"Croatia\", \"Czech Republic\",\n  \"Denmark\", \"Ecuador\", \"Egypt\", \"Estonia\", \"Ethiopia\",\n  \"Finland\", \"France\", \"Georgia\", \"Germany\", \"Ghana\", \"Greece\",\n  \"Hungary\", \"Iceland\", \"India\", \"Indonesia\", \"Iran\", \"Iraq\", \"Ireland\", \"Israel\", \"Italy\",\n  \"Japan\", \"Jordan\", \"Kazakhstan\", \"Kenya\", \"Kuwait\",\n  \"Latvia\", \"Lebanon\", \"Lithuania\", \"Malaysia\", \"Mexico\", \"Morocco\",\n  \"Netherlands\", \"New Zealand\", \"Nigeria\", \"Norway\",\n  \"Pakistan\", \"Peru\", \"Philippines\", \"Poland\", \"Portugal\", \"Qatar\",\n  \"Romania\", \"Russia\", \"Saudi Arabia\", \"Serbia\", \"Singapore\", \"Slovakia\", \"Slovenia\", \n  \"South Africa\", \"South Korea\", \"Spain\", \"Sri Lanka\", \"Sweden\", \"Switzerland\",\n  \"Thailand\", \"Turkey\", \"Ukraine\", \"United Arab Emirates\", \"United Kingdom\", \"United States\",\n  \"Uruguay\", \"Venezuela\", \"Vietnam\"\n];\n\nexport default function Footer() {\n  const [selectedCountry, setSelectedCountry] = useState(\"United States\");\n  const [isDropdownOpen, setIsDropdownOpen] = useState(false);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const dropdownRef = useRef(null);\n\n  const filteredCountries = countries.filter(country => \n    country.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  // Move selected country to top of filtered list\n  const sortedCountries = [\n    ...filteredCountries.filter(country => country === selectedCountry),\n    ...filteredCountries.filter(country => country !== selectedCountry)\n  ];\n\n  useEffect(() => {\n    const handleClickOutside = (event) => {\n      if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {\n        setIsDropdownOpen(false);\n        setSearchTerm(\"\");\n      }\n    };\n    document.addEventListener(\"mousedown\", handleClickOutside);\n    return () => document.removeEventListener(\"mousedown\", handleClickOutside);\n  }, []);\n\n  const handleCountrySelect = (country) => {\n    setSelectedCountry(country);\n    setIsDropdownOpen(false);\n    setSearchTerm(\"\");\n  };\n\n  return (\n    <footer className=\"bg-white text-black border-t border-gray-100 shadow-sm\">\n      {/* Main Footer Section */}\n      <div className=\"mx-auto w-full max-w-screen-xl px-3 sm:px-4 md:px-6 py-12\">\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-8\">\n          \n          {/* Brand and App Downloads */}\n          <div className=\"lg:col-span-2\">\n            <Link \n              href=\"/\" \n              className={`${caveat.className} text-3xl font-bold text-emerald-700 hover:text-emerald-800 transition-colors duration-200 mb-6 inline-block`}\n            >\n              Frame\n            </Link>\n            \n            {/* App Download Buttons */}\n            <div className=\"mb-6\">\n              <p className=\"text-gray-600 mb-3\">Download our app:</p>\n              <div className=\"flex flex-row gap-2\">\n                <button className=\"btn-base bg-black text-white hover:bg-gray-800 py-2 px-3 flex-1 gap-1.5\">\n                  <svg className=\"w-4 h-4 flex-shrink-0\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                    <path d=\"M3,20.5V3.5C3,2.91 3.34,2.39 3.84,2.15L13.69,12L3.84,21.85C3.34,21.61 3,21.09 3,20.5M16.81,15.12L6.05,21.34L14.54,12.85L16.81,15.12M20.16,10.81C20.5,11.08 20.75,11.5 20.75,12C20.75,12.5 20.53,12.9 20.18,13.18L17.89,14.5L15.39,12L17.89,9.5L20.16,10.81M6.05,2.66L16.81,8.88L14.54,11.15L6.05,2.66Z\"/>\n                  </svg>\n                  <div className=\"text-left min-w-0\">\n                    <div className=\"text-xs text-gray-300\">GET IT ON</div>\n                    <div className=\"text-xs font-semibold truncate\">Google Play</div>\n                  </div>\n                </button>\n                \n                <button className=\"btn-base bg-black text-white hover:bg-gray-800 py-2 px-3 flex-1 gap-1.5\">\n                  <svg className=\"w-4 h-4 flex-shrink-0\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                    <path d=\"M18.71,19.5C17.88,20.74 17,21.95 15.66,21.97C14.32,22 13.89,21.18 12.37,21.18C10.84,21.18 10.37,21.95 9.1,22C7.79,22.05 6.8,20.68 5.96,19.47C4.25,17 2.94,12.45 4.7,9.39C5.57,7.87 7.13,6.91 8.82,6.88C10.1,6.86 11.32,7.75 12.11,7.75C12.89,7.75 14.37,6.68 15.92,6.84C16.57,6.87 18.39,7.1 19.56,8.82C19.47,8.88 17.39,10.1 17.41,12.63C17.44,15.65 20.06,16.66 20.09,16.67C20.06,16.74 19.67,18.11 18.71,19.5M13,3.5C13.73,2.67 14.94,2.04 15.94,2C16.07,3.17 15.6,4.35 14.9,5.19C14.21,6.04 13.07,6.7 11.95,6.61C11.8,5.46 12.36,4.26 13,3.5Z\"/>\n                  </svg>\n                  <div className=\"text-left min-w-0\">\n                    <div className=\"text-xs text-gray-300\">Download on the</div>\n                    <div className=\"text-xs font-semibold truncate\">App Store</div>\n                  </div>\n                </button>\n              </div>\n            </div>\n\n            {/* Custom Country Dropdown */}\n            <div className=\"w-full sm:w-auto relative\" ref={dropdownRef}>\n              <button\n                onClick={() => setIsDropdownOpen(!isDropdownOpen)}\n                className=\"btn-base btn-secondary w-full sm:w-64 px-3 py-2 text-sm text-left\"\n              >\n                <span className=\"truncate\">\n                  {selectedCountry || \"Choose country (or region)\"}\n                </span>\n                <svg \n                  className={`w-4 h-4 transition-transform duration-200 ${isDropdownOpen ? 'rotate-180' : ''}`} \n                  fill=\"none\" \n                  stroke=\"currentColor\" \n                  viewBox=\"0 0 24 24\"\n                >\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M19 9l-7 7-7-7\" />\n                </svg>\n              </button>\n\n              {isDropdownOpen && (\n                <div className=\"absolute top-full left-0 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 max-h-64 overflow-hidden\">\n                  {/* Search Input */}\n                  <div className=\"p-2 border-b border-gray-200\">\n                    <input\n                      type=\"text\"\n                      placeholder=\"Search countries...\"\n                      value={searchTerm}\n                      onChange={(e) => setSearchTerm(e.target.value)}\n                      className=\"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-black focus:border-black\"\n                    />\n                  </div>\n                  \n                  {/* Country List */}\n                  <div className=\"max-h-48 overflow-y-auto\">\n                    {sortedCountries.length === 0 ? (\n                      <div className=\"px-3 py-2 text-sm text-gray-500\">No countries found</div>\n                    ) : (\n                      sortedCountries.map((country) => (\n                        <button\n                          key={country}\n                          onClick={() => handleCountrySelect(country)}\n                          className={`btn-base w-full px-3 py-2 text-left text-sm hover:bg-gray-50 ${\n                            country === selectedCountry \n                              ? 'bg-yellow-400 text-black font-medium' \n                              : 'text-gray-700'\n                          }`}\n                        >\n                          {country}\n                        </button>\n                      ))\n                    )}\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n\n          {/* Discover Column - Removed \"Explore\" */}\n          <div>\n            <h4 className=\"font-semibold text-gray-900 mb-4\">Discover</h4>\n            <ul className=\"space-y-2\">\n              <li><a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">Campaigns</a></li>\n              <li><a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">Leaderboard</a></li>\n              <li><a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">Pricing</a></li>\n              <li><a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">Help Center</a></li>\n            </ul>\n          </div>\n\n          {/* Resources Column */}\n          <div>\n            <h4 className=\"font-semibold text-gray-900 mb-4\">Resources</h4>\n            <ul className=\"space-y-2\">\n              <li><a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">For Creators</a></li>\n              <li><a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">What is a Twibbon?</a></li>\n              <li><a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">Use Cases</a></li>\n              <li><a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">Testimonials</a></li>\n            </ul>\n          </div>\n\n          {/* Company Column */}\n          <div>\n            <h4 className=\"font-semibold text-gray-900 mb-4\">Company</h4>\n            <ul className=\"space-y-2 mb-6\">\n              <li><a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">About</a></li>\n              <li><a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">Blog</a></li>\n              <li><a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">Media Assets</a></li>\n              <li><a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">Contact Us</a></li>\n            </ul>\n\n            {/* Join Us - Social Media */}\n            <div>\n              <h4 className=\"font-semibold text-gray-900 mb-4\">Join Us</h4>\n              <div className=\"flex gap-3\">\n                <a href=\"#\" className=\"w-8 h-8 bg-gray-100 hover:bg-emerald-100 rounded-full flex items-center justify-center transition-colors duration-200\">\n                  <svg className=\"w-4 h-4 text-gray-600 hover:text-emerald-700\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path d=\"M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z\"/>\n                  </svg>\n                </a>\n                <a href=\"#\" className=\"w-8 h-8 bg-gray-100 hover:bg-emerald-100 rounded-full flex items-center justify-center transition-colors duration-200\">\n                  <svg className=\"w-4 h-4 text-gray-600 hover:text-emerald-700\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path d=\"M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z\"/>\n                  </svg>\n                </a>\n                <a href=\"#\" className=\"w-8 h-8 bg-gray-100 hover:bg-emerald-100 rounded-full flex items-center justify-center transition-colors duration-200\">\n                  <svg className=\"w-4 h-4 text-gray-600 hover:text-emerald-700\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path d=\"M12.017 0C5.396 0 .029 5.367.029 11.987c0 5.079 3.158 9.417 7.618 11.174-.105-.949-.199-2.403.041-3.439.219-.937 1.406-5.957 1.406-5.957s-.359-.72-.359-1.781c0-1.663.967-2.911 2.168-2.911 1.024 0 1.518.769 1.518 1.688 0 1.029-.653 2.567-.992 3.992-.285 1.193.6 2.165 1.775 2.165 2.128 0 3.768-2.245 3.768-5.487 0-2.861-2.063-4.869-5.008-4.869-3.41 0-5.409 2.562-5.409 5.199 0 1.033.394 2.143.889 2.741.097.118.112.22.083.402-.09.353-.293 1.178-.334 1.345-.053.225-.172.271-.402.165-1.495-.69-2.433-2.878-2.433-4.646 0-3.776 2.748-7.252 7.92-7.252 4.158 0 7.392 2.967 7.392 6.923 0 4.135-2.607 7.462-6.233 7.462-1.214 0-2.357-.629-2.75-1.378l-.748 2.853c-.271 1.043-1.002 2.35-1.492 3.146C9.57 23.812 10.763 24.009 12.017 24.009c6.624 0 11.99-5.367 11.99-11.988C24.007 5.367 18.641.001 12.017.001z\"/>\n                  </svg>\n                </a>\n                <a href=\"#\" className=\"w-8 h-8 bg-gray-100 hover:bg-emerald-100 rounded-full flex items-center justify-center transition-colors duration-200\">\n                  <svg className=\"w-4 h-4 text-gray-600 hover:text-emerald-700\" fill=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path d=\"M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z\"/>\n                  </svg>\n                </a>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Trademark/Legal Section */}\n      <div className=\"border-t border-gray-200\">\n        <div className=\"mx-auto w-full max-w-screen-xl px-3 sm:px-4 md:px-6 py-6\">\n          <div className=\"flex flex-col md:flex-row justify-between items-center\">\n            <div className=\"text-sm text-gray-600 mb-4 md:mb-0\">\n               2024 Frame. All rights reserved.\n            </div>\n            <div className=\"flex flex-wrap gap-6 text-sm\">\n              <a href=\"/privacy\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">Privacy Policy</a>\n              <a href=\"/terms\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">Terms & Conditions</a>\n              <a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">Cookie Policy</a>\n              <a href=\"#\" className=\"text-gray-600 hover:text-emerald-700 transition-colors duration-200\">Site Map</a>\n            </div>\n          </div>\n        </div>\n      </div>\n    </footer>\n  );\n}\n","path":null,"size_bytes":14675,"size_tokens":null},"src/utils/imageComposition.js":{"content":"/**\n * Canvas-based image composition utility for Twibbonize\n * Handles overlaying user photos with frames and backgrounds\n */\n\n/**\n * Load an image from a File object or URL\n * @param {File|string} source - Image file or URL\n * @returns {Promise<HTMLImageElement>} Loaded image element\n */\nexport const loadImage = (source) => {\n  return new Promise((resolve, reject) => {\n    const img = new Image();\n    img.crossOrigin = 'anonymous'; // Enable CORS for external images\n    \n    img.onload = () => {\n      resolve(img);\n    };\n    \n    img.onerror = (error) => {\n      reject(new Error('Failed to load image'));\n    };\n    \n    // Handle File object vs URL string\n    if (source instanceof File || source instanceof Blob) {\n      const objectUrl = URL.createObjectURL(source);\n      img.src = objectUrl;\n      // Store URL for cleanup\n      img.dataset.objectUrl = objectUrl;\n    } else {\n      img.src = source;\n    }\n  });\n};\n\n/**\n * Compose user photo with campaign image\n * @param {File} userPhotoFile - User's uploaded photo\n * @param {string} campaignImageUrl - URL of campaign image (frame or background)\n * @param {object} adjustments - Photo adjustments {scale: 1.0, x: 0, y: 0, rotation: 0}\n * @param {string} campaignType - 'frame' or 'background'\n * @returns {Promise<{canvas: HTMLCanvasElement, blob: Blob}>} Composed canvas and blob for download\n */\nexport const composeImages = async (userPhotoFile, campaignImageUrl, adjustments = {}, campaignType = 'frame') => {\n  // Default adjustments\n  const { scale = 1.0, x = 0, y = 0, rotation = 0 } = adjustments;\n  \n  try {\n    // Load both images\n    const [userPhoto, campaignImage] = await Promise.all([\n      loadImage(userPhotoFile),\n      loadImage(campaignImageUrl)\n    ]);\n    \n    // Create canvas matching campaign image dimensions\n    const canvas = document.createElement('canvas');\n    canvas.width = campaignImage.width;\n    canvas.height = campaignImage.height;\n    \n    const ctx = canvas.getContext('2d', { alpha: true });\n    \n    if (!ctx) {\n      throw new Error('Failed to get canvas context');\n    }\n    \n    // Compose based on campaign type\n    if (campaignType === 'frame') {\n      // Frame: User photo UNDER frame (frame overlays on top)\n      drawUserPhotoWithAdjustments(ctx, userPhoto, canvas.width, canvas.height, scale, x, y, rotation);\n      ctx.drawImage(campaignImage, 0, 0, canvas.width, canvas.height);\n    } else {\n      // Background: User photo ON TOP of background\n      ctx.drawImage(campaignImage, 0, 0, canvas.width, canvas.height);\n      drawUserPhotoWithAdjustments(ctx, userPhoto, canvas.width, canvas.height, scale, x, y, rotation);\n    }\n    \n    // Convert to blob for download\n    const blob = await canvasToBlob(canvas, 'image/png');\n    \n    // Cleanup object URLs\n    cleanupImage(userPhoto);\n    cleanupImage(campaignImage);\n    \n    return { canvas, blob };\n  } catch (error) {\n    console.error('Image composition error:', error);\n    throw error;\n  }\n};\n\n/**\n * Draw user photo with scale, position, and rotation adjustments\n * @param {CanvasRenderingContext2D} ctx - Canvas context\n * @param {HTMLImageElement} img - User photo image\n * @param {number} canvasWidth - Canvas width\n * @param {number} canvasHeight - Canvas height\n * @param {number} scale - Zoom level (0.1 - 10.0)\n * @param {number} x - Horizontal offset\n * @param {number} y - Vertical offset\n * @param {number} rotation - Rotation angle in degrees (0 - 360)\n */\nconst drawUserPhotoWithAdjustments = (ctx, img, canvasWidth, canvasHeight, scale, x, y, rotation = 0) => {\n  // Save the current context state\n  ctx.save();\n  \n  // Calculate center point for rotation\n  const centerX = canvasWidth / 2;\n  const centerY = canvasHeight / 2;\n  \n  // Move to center, apply rotation, then move back\n  ctx.translate(centerX + x, centerY + y);\n  ctx.rotate((rotation * Math.PI) / 180);\n  \n  // Calculate scaled dimensions\n  const scaledWidth = img.width * scale;\n  const scaledHeight = img.height * scale;\n  \n  // Draw the image centered at the rotation point\n  ctx.drawImage(img, -scaledWidth / 2, -scaledHeight / 2, scaledWidth, scaledHeight);\n  \n  // Restore the context state\n  ctx.restore();\n};\n\n/**\n * Apply adjustments to canvas and return preview\n * Used for real-time preview without full composition\n * @param {HTMLCanvasElement} canvas - Target canvas\n * @param {File} userPhotoFile - User photo file\n * @param {string} campaignImageUrl - Campaign image URL\n * @param {object} adjustments - Adjustments object\n * @param {string} campaignType - Campaign type\n * @returns {Promise<HTMLCanvasElement>} Updated canvas\n */\nexport const updatePreview = async (canvas, userPhotoFile, campaignImageUrl, adjustments, campaignType) => {\n  const ctx = canvas.getContext('2d', { alpha: true });\n  \n  if (!ctx) {\n    throw new Error('Failed to get canvas context');\n  }\n  \n  // Clear canvas\n  ctx.clearRect(0, 0, canvas.width, canvas.height);\n  \n  // Load and compose images\n  const [userPhoto, campaignImage] = await Promise.all([\n    loadImage(userPhotoFile),\n    loadImage(campaignImageUrl)\n  ]);\n  \n  // Ensure canvas matches campaign dimensions\n  canvas.width = campaignImage.width;\n  canvas.height = campaignImage.height;\n  \n  const { scale = 1.0, x = 0, y = 0, rotation = 0 } = adjustments;\n  \n  // Compose based on type\n  if (campaignType === 'frame') {\n    drawUserPhotoWithAdjustments(ctx, userPhoto, canvas.width, canvas.height, scale, x, y, rotation);\n    ctx.drawImage(campaignImage, 0, 0, canvas.width, canvas.height);\n  } else {\n    ctx.drawImage(campaignImage, 0, 0, canvas.width, canvas.height);\n    drawUserPhotoWithAdjustments(ctx, userPhoto, canvas.width, canvas.height, scale, x, y, rotation);\n  }\n  \n  // Cleanup\n  cleanupImage(userPhoto);\n  cleanupImage(campaignImage);\n  \n  return canvas;\n};\n\n/**\n * Calculate optimal fit for user photo within canvas\n * @param {File} userPhotoFile - User photo file\n * @param {number} canvasWidth - Canvas width\n * @param {number} canvasHeight - Canvas height\n * @returns {Promise<{scale: number, x: number, y: number}>} Optimal adjustments\n */\nexport const calculateFitAdjustments = async (userPhotoFile, canvasWidth, canvasHeight) => {\n  const img = await loadImage(userPhotoFile);\n  \n  // Calculate scale to fit image within canvas (contain mode)\n  const scaleX = canvasWidth / img.width;\n  const scaleY = canvasHeight / img.height;\n  const scale = Math.min(scaleX, scaleY);\n  \n  // Center the image\n  const x = 0;\n  const y = 0;\n  \n  cleanupImage(img);\n  \n  return { scale, x, y };\n};\n\n/**\n * Calculate scale to fill canvas (cover mode)\n * @param {File} userPhotoFile - User photo file\n * @param {number} canvasWidth - Canvas width\n * @param {number} canvasHeight - Canvas height\n * @returns {Promise<{scale: number, x: number, y: number}>} Optimal adjustments\n */\nexport const calculateCoverAdjustments = async (userPhotoFile, canvasWidth, canvasHeight) => {\n  const img = await loadImage(userPhotoFile);\n  \n  // Calculate scale to cover canvas (may crop image)\n  const scaleX = canvasWidth / img.width;\n  const scaleY = canvasHeight / img.height;\n  const scale = Math.max(scaleX, scaleY);\n  \n  // Center the image\n  const x = 0;\n  const y = 0;\n  \n  cleanupImage(img);\n  \n  return { scale, x, y };\n};\n\n/**\n * Convert canvas to blob for download\n * @param {HTMLCanvasElement} canvas - Canvas element\n * @param {string} format - Image format ('image/png' or 'image/jpeg')\n * @param {number} quality - Image quality (0-1) for JPEG\n * @returns {Promise<Blob>} Image blob\n */\nexport const canvasToBlob = (canvas, format = 'image/png', quality = 0.95) => {\n  return new Promise((resolve, reject) => {\n    canvas.toBlob(\n      (blob) => {\n        if (blob) {\n          resolve(blob);\n        } else {\n          reject(new Error('Failed to create blob from canvas'));\n        }\n      },\n      format,\n      quality\n    );\n  });\n};\n\n/**\n * Export canvas as downloadable file\n * @param {HTMLCanvasElement} canvas - Canvas to export\n * @param {string} filename - Download filename\n * @param {string} format - Image format ('png' or 'jpeg')\n */\nexport const downloadCanvas = async (canvas, filename = 'campaign-image', format = 'png') => {\n  const mimeType = format === 'jpeg' ? 'image/jpeg' : 'image/png';\n  const blob = await canvasToBlob(canvas, mimeType);\n  \n  // Create download link\n  const url = URL.createObjectURL(blob);\n  const link = document.createElement('a');\n  link.href = url;\n  link.download = `${filename}.${format}`;\n  \n  // Trigger download\n  document.body.appendChild(link);\n  link.click();\n  document.body.removeChild(link);\n  \n  // Cleanup\n  URL.revokeObjectURL(url);\n};\n\n/**\n * Cleanup object URL from image element\n * @param {HTMLImageElement} img - Image element\n */\nconst cleanupImage = (img) => {\n  if (img.dataset.objectUrl) {\n    URL.revokeObjectURL(img.dataset.objectUrl);\n    delete img.dataset.objectUrl;\n  }\n};\n\n/**\n * Get image dimensions from file\n * @param {File} imageFile - Image file\n * @returns {Promise<{width: number, height: number}>} Image dimensions\n */\nexport const getImageDimensions = async (imageFile) => {\n  const img = await loadImage(imageFile);\n  const dimensions = {\n    width: img.width,\n    height: img.height\n  };\n  cleanupImage(img);\n  return dimensions;\n};\n\n/**\n * Validate image aspect ratio\n * @param {File} imageFile - Image file\n * @param {number} minRatio - Minimum aspect ratio\n * @param {number} maxRatio - Maximum aspect ratio\n * @returns {Promise<boolean>} True if aspect ratio is valid\n */\nexport const validateAspectRatio = async (imageFile, minRatio = 0.5, maxRatio = 2.0) => {\n  const { width, height } = await getImageDimensions(imageFile);\n  const ratio = width / height;\n  return ratio >= minRatio && ratio <= maxRatio;\n};\n","path":null,"size_bytes":9723,"size_tokens":null},"src/app/globals.css":{"content":"@import \"tailwindcss\";\n\n/* Fix Tailwind v4 hover variants - restore v3 behavior */\n/* v4 wraps hover in @media (hover: hover) which breaks on touch devices */\n/* This custom variant removes that wrapper and makes hover work everywhere */\n@custom-variant hover (&:hover);\n\n:root {\n  --background: #ffffff;\n  --foreground: #171717;\n}\n\n/* Fix Tailwind v4 group-hover not working - force higher specificity */\n.group:hover .group-hover\\:opacity-100 {\n  opacity: 1 !important;\n}\n\n@theme inline {\n  --color-background: var(--background);\n  --color-foreground: var(--foreground);\n  --font-sans: var(--font-geist-sans);\n  --font-mono: var(--font-geist-mono);\n}\n\n/* Global Button Standardization - Consistent styling for all buttons */\n\n/* Base button class - Applied to ALL buttons for consistency */\n.btn-base {\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  border-radius: 0.5rem; /* rounded-lg - 8px */\n  font-weight: 500;\n  cursor: pointer;\n  transition: all 0.2s ease-in-out;\n  transform: scale(1);\n  outline: none;\n}\n\n.btn-base:hover {\n  transform: scale(1.03);\n}\n\n.btn-base:focus {\n  outline: 2px solid #3b82f6; /* blue-500 for universal focus visibility */\n  outline-offset: 2px;\n}\n\n/* Primary button styling */\n.btn-primary {\n  background: linear-gradient(to right, #059669, #047857); /* emerald-600 to emerald-700 */\n  color: white;\n  box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);\n}\n\n.btn-primary:hover {\n  background: linear-gradient(to right, #047857, #065f46); /* emerald-700 to emerald-800 */\n  box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);\n}\n\n.btn-primary:focus {\n  outline: 2px solid #10b981; /* emerald-500 focus ring for primary buttons */\n  outline-offset: 2px;\n}\n\n/* Secondary button styling */\n.btn-secondary {\n  background: white;\n  border: 1px solid #d1d5db; /* gray-300 */\n  color: #374151; /* gray-700 */\n}\n\n.btn-secondary:hover {\n  background: #f9fafb; /* gray-50 */\n  border-color: #9ca3af; /* gray-400 */\n}\n\n.btn-secondary:focus {\n  outline: 2px solid #6b7280; /* gray-500 focus ring for secondary buttons */\n  outline-offset: 2px;\n}\n\n/* Danger button styling */\n.btn-danger {\n  background: #dc2626; /* red-600 */\n  color: white;\n}\n\n.btn-danger:hover {\n  background: #b91c1c; /* red-700 */\n}\n\n.btn-danger:focus {\n  outline: 2px solid #ef4444; /* red-500 focus ring for danger buttons */\n  outline-offset: 2px;\n}\n\n/* Warning button styling */\n.btn-warning {\n  background: #eab308; /* yellow-500 */\n  color: white;\n}\n\n.btn-warning:hover {\n  background: #ca8a04; /* yellow-600 */\n}\n\n.btn-warning:focus {\n  outline: 2px solid #facc15; /* yellow-400 focus ring for warning buttons */\n  outline-offset: 2px;\n}\n\n/* Google/Social button styling */\n.btn-google {\n  background: white;\n  border: 1px solid #d1d5db; /* gray-300 */\n  color: #374151; /* gray-700 */\n  box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);\n}\n\n.btn-google:hover {\n  background: #fef3c7; /* yellow-50 */\n  box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);\n}\n\n/* Link button styling (text buttons) */\n.btn-link {\n  background: transparent;\n  color: #059669; /* emerald-600 */\n  text-decoration: none;\n  border: none;\n  padding: 0;\n}\n\n.btn-link:hover {\n  color: #047857; /* emerald-700 */\n  text-decoration: underline;\n  transform: scale(1.02); /* Subtle zoom for text buttons */\n}\n\n/* Info button styling (for refresh, reload, etc.) */\n.btn-info {\n  background: #3b82f6; /* blue-500 */\n  color: white;\n}\n\n.btn-info:hover {\n  background: #2563eb; /* blue-600 */\n}\n\n.btn-info:focus {\n  outline: 2px solid #60a5fa; /* blue-400 focus ring */\n  outline-offset: 2px;\n}\n\n/* Neutral/utility button styling (for cancel, change, etc.) */\n.btn-neutral {\n  background: #e5e7eb; /* gray-200 */\n  color: #374151; /* gray-700 */\n}\n\n.btn-neutral:hover {\n  background: #d1d5db; /* gray-300 */\n}\n\n.btn-neutral:focus {\n  outline: 2px solid #9ca3af; /* gray-400 focus ring */\n  outline-offset: 2px;\n}\n\n/* Social media button variants */\n.btn-twitter {\n  background: #60a5fa; /* blue-400 - Twitter brand color */\n  color: white;\n}\n\n.btn-twitter:hover {\n  background: #3b82f6; /* blue-500 */\n}\n\n.btn-twitter:focus {\n  outline: 2px solid #93c5fd; /* blue-300 focus ring */\n  outline-offset: 2px;\n}\n\n.btn-facebook {\n  background: #2563eb; /* blue-600 - Facebook brand color */\n  color: white;\n}\n\n.btn-facebook:hover {\n  background: #1d4ed8; /* blue-700 */\n}\n\n.btn-facebook:focus {\n  outline: 2px solid #60a5fa; /* blue-400 focus ring */\n  outline-offset: 2px;\n}\n\n.btn-whatsapp {\n  background: #22c55e; /* green-500 - WhatsApp brand color */\n  color: white;\n}\n\n.btn-whatsapp:hover {\n  background: #16a34a; /* green-600 */\n}\n\n.btn-whatsapp:focus {\n  outline: 2px solid #4ade80; /* green-400 focus ring */\n  outline-offset: 2px;\n}\n\n/* Disabled state for all buttons */\n.btn-base:disabled {\n  opacity: 0.5;\n  cursor: not-allowed;\n  transform: scale(1);\n}\n\n.btn-base:disabled:hover {\n  transform: scale(1);\n}\n\n/* Legacy hover-zoom class - kept for backward compatibility but enhanced */\n.hover-zoom {\n  transform: scale(1);\n  transition: transform 0.2s ease-in-out;\n  cursor: pointer;\n}\n\n.hover-zoom:hover {\n  transform: scale(1.03);\n}\n\n@media (prefers-color-scheme: dark) {\n  :root {\n    --background: #0a0a0a;\n    --foreground: #ededed;\n  }\n}\n\nbody {\n  background: var(--background);\n  color: var(--foreground);\n  font-family: Arial, Helvetica, sans-serif;\n}\n\n@keyframes toast-progress {\n  0% {\n    width: 100%;\n  }\n  100% {\n    width: 0%;\n  }\n}\n\n.animate-toast-progress {\n  animation: toast-progress 10s linear forwards;\n}\n\n/* Hide scrollbar for horizontal scrolling on mobile tabs */\n.scrollbar-hide {\n  -ms-overflow-style: none;\n  scrollbar-width: none;\n}\n\n.scrollbar-hide::-webkit-scrollbar {\n  display: none;\n}\n\n/* Tailwind custom breakpoint for extra small screens */\n@media (min-width: 475px) {\n  .xs\\:inline {\n    display: inline;\n  }\n  .xs\\:hidden {\n    display: none;\n  }\n}\n","path":null,"size_bytes":5859,"size_tokens":null},"src/app/(chrome)/admin/page.js":{"content":"\"use client\";\n\nimport { useState, useEffect } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport ErrorBoundary from \"@/components/ErrorBoundary\";\n\nexport default function AdminDashboard() {\n  return (\n    <ErrorBoundary>\n      <AdminDashboardContent />\n    </ErrorBoundary>\n  );\n}\n\nfunction AdminDashboardContent() {\n  const { user } = useAuth();\n  const [stats, setStats] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n\n  useEffect(() => {\n    const fetchAnalytics = async () => {\n      if (!user) return;\n\n      setLoading(true);\n      setError(null);\n\n      try {\n        const token = await user.getIdToken();\n        \n        const response = await fetch('/api/admin/analytics', {\n          headers: {\n            'Authorization': `Bearer ${token}`,\n          },\n        });\n\n        if (!response.ok) {\n          throw new Error('Failed to fetch analytics');\n        }\n\n        const data = await response.json();\n        setStats(data.data);\n      } catch (error) {\n        console.error('Error fetching analytics:', error);\n        setError(error.message);\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    fetchAnalytics();\n  }, [user]);\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center h-64\">\n        <div className=\"text-center\">\n          <div className=\"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600\"></div>\n          <p className=\"mt-2 text-gray-600\">Loading analytics...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded\">\n        Error loading analytics: {error}\n      </div>\n    );\n  }\n\n  if (!stats) {\n    return null;\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n        <div className=\"bg-white rounded-lg shadow p-6\">\n          <div className=\"flex items-center\">\n            <div className=\"flex-shrink-0\">\n              <div className=\"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center\">\n                <svg className=\"w-6 h-6 text-blue-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n                </svg>\n              </div>\n            </div>\n            <div className=\"ml-5 w-0 flex-1\">\n              <dl>\n                <dt className=\"text-sm font-medium text-gray-500 truncate\">Total Campaigns</dt>\n                <dd className=\"text-2xl font-semibold text-gray-900\">{stats.campaigns.total}</dd>\n                <dd className=\"text-xs text-gray-500 mt-1\">\n                  {stats.campaigns.active} active, {stats.campaigns.removed} removed\n                </dd>\n              </dl>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"bg-white rounded-lg shadow p-6\">\n          <div className=\"flex items-center\">\n            <div className=\"flex-shrink-0\">\n              <div className=\"w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center\">\n                <svg className=\"w-6 h-6 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n                </svg>\n              </div>\n            </div>\n            <div className=\"ml-5 w-0 flex-1\">\n              <dl>\n                <dt className=\"text-sm font-medium text-gray-500 truncate\">Total Users</dt>\n                <dd className=\"text-2xl font-semibold text-gray-900\">{stats.users.total}</dd>\n                <dd className=\"text-xs text-gray-500 mt-1\">\n                  {stats.users.admins} admins, {stats.users.banned} banned\n                </dd>\n              </dl>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"bg-white rounded-lg shadow p-6\">\n          <div className=\"flex items-center\">\n            <div className=\"flex-shrink-0\">\n              <div className=\"w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center\">\n                <svg className=\"w-6 h-6 text-yellow-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n                </svg>\n              </div>\n            </div>\n            <div className=\"ml-5 w-0 flex-1\">\n              <dl>\n                <dt className=\"text-sm font-medium text-gray-500 truncate\">Pending Reports</dt>\n                <dd className=\"text-2xl font-semibold text-gray-900\">{stats.reports.pending}</dd>\n                <dd className=\"text-xs text-gray-500 mt-1\">\n                  {stats.reports.total} total, {stats.reports.resolutionRate}% resolved\n                </dd>\n              </dl>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"bg-white rounded-lg shadow p-6\">\n          <div className=\"flex items-center\">\n            <div className=\"flex-shrink-0\">\n              <div className=\"w-12 h-12 bg-emerald-100 rounded-lg flex items-center justify-center\">\n                <svg className=\"w-6 h-6 text-emerald-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                </svg>\n              </div>\n            </div>\n            <div className=\"ml-5 w-0 flex-1\">\n              <dl>\n                <dt className=\"text-sm font-medium text-gray-500 truncate\">Active Campaigns</dt>\n                <dd className=\"text-2xl font-semibold text-gray-900\">{stats.campaigns.active}</dd>\n                <dd className=\"text-xs text-gray-500 mt-1\">\n                  {stats.campaigns.underReview} under review\n                </dd>\n              </dl>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <div className=\"bg-white rounded-lg shadow p-6\">\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Campaign Breakdown</h3>\n          <div className=\"space-y-4\">\n            <div>\n              <div className=\"flex justify-between mb-1\">\n                <span className=\"text-sm font-medium text-gray-700\">Frames</span>\n                <span className=\"text-sm text-gray-600\">{stats.campaigns.frames}</span>\n              </div>\n              <div className=\"w-full bg-gray-200 rounded-full h-2\">\n                <div \n                  className=\"bg-blue-600 h-2 rounded-full\" \n                  style={{ width: `${stats.campaigns.total > 0 ? (stats.campaigns.frames / stats.campaigns.total * 100) : 0}%` }}\n                ></div>\n              </div>\n            </div>\n            <div>\n              <div className=\"flex justify-between mb-1\">\n                <span className=\"text-sm font-medium text-gray-700\">Backgrounds</span>\n                <span className=\"text-sm text-gray-600\">{stats.campaigns.backgrounds}</span>\n              </div>\n              <div className=\"w-full bg-gray-200 rounded-full h-2\">\n                <div \n                  className=\"bg-purple-600 h-2 rounded-full\" \n                  style={{ width: `${stats.campaigns.total > 0 ? (stats.campaigns.backgrounds / stats.campaigns.total * 100) : 0}%` }}\n                ></div>\n              </div>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"bg-white rounded-lg shadow p-6\">\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Engagement Metrics</h3>\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div className=\"bg-emerald-50 rounded-lg p-4\">\n              <dt className=\"text-xs text-emerald-700 font-medium\">Total Supports</dt>\n              <dd className=\"text-2xl font-semibold text-emerald-900 mt-1\">{stats.engagement.totalSupports.toLocaleString()}</dd>\n            </div>\n            <div className=\"bg-blue-50 rounded-lg p-4\">\n              <dt className=\"text-xs text-blue-700 font-medium\">Avg per Campaign</dt>\n              <dd className=\"text-2xl font-semibold text-blue-900 mt-1\">{stats.engagement.avgSupportsPerCampaign}</dd>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":8748,"size_tokens":null},"src/components/admin/AdminSidebar.js":{"content":"\"use client\";\n\nimport Link from \"next/link\";\nimport { usePathname } from \"next/navigation\";\nimport { useState, useEffect } from \"react\";\n\nexport default function AdminSidebar({ user, onSignOut }) {\n  const pathname = usePathname();\n  const [isCollapsed, setIsCollapsed] = useState(true);\n\n  useEffect(() => {\n    const handleResize = () => {\n      if (window.innerWidth >= 1024) {\n        setIsCollapsed(false);\n      } else {\n        setIsCollapsed(true);\n      }\n    };\n\n    handleResize();\n    window.addEventListener('resize', handleResize);\n    return () => window.removeEventListener('resize', handleResize);\n  }, []);\n\n  const navItems = [\n    {\n      name: \"Analytics\",\n      href: \"/admin\",\n      icon: (\n        <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z\" />\n        </svg>\n      ),\n    },\n    {\n      name: \"Reports\",\n      href: \"/admin/reports\",\n      icon: (\n        <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n        </svg>\n      ),\n    },\n    {\n      name: \"Campaigns\",\n      href: \"/admin/campaigns\",\n      icon: (\n        <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n        </svg>\n      ),\n    },\n    {\n      name: \"Users\",\n      href: \"/admin/users\",\n      icon: (\n        <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z\" />\n        </svg>\n      ),\n    },\n    {\n      name: \"Appeals\",\n      href: \"/admin/appeals\",\n      icon: (\n        <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6\" />\n        </svg>\n      ),\n    },\n    {\n      name: \"Logs\",\n      href: \"/admin/logs\",\n      icon: (\n        <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n        </svg>\n      ),\n    },\n  ];\n\n  return (\n    <>\n      {!isCollapsed && (\n        <div\n          onClick={() => setIsCollapsed(true)}\n          className=\"lg:hidden fixed inset-0 bg-black/50 z-30 transition-opacity\"\n        />\n      )}\n\n      <button\n        onClick={() => setIsCollapsed(!isCollapsed)}\n        className={`lg:hidden fixed top-4 z-50 p-2 bg-emerald-700 text-white rounded-md shadow-lg transition-all ${\n          isCollapsed ? \"left-4\" : \"left-[272px]\"\n        }`}\n      >\n        <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d={!isCollapsed ? \"M6 18L18 6M6 6l12 12\" : \"M4 6h16M4 12h16M4 18h16\"} />\n        </svg>\n      </button>\n\n      <aside\n        className={`fixed left-0 top-0 h-full bg-gray-900 text-white transition-all duration-300 z-40 shadow-2xl ${\n          isCollapsed ? \"-translate-x-full lg:translate-x-0 lg:w-20\" : \"w-64 translate-x-0\"\n        }`}\n      >\n        <div className=\"flex flex-col h-full\">\n          <div className=\"p-6 border-b border-gray-800\">\n            <Link href=\"/\" className=\"flex items-center space-x-3\">\n              <div className=\"w-10 h-10 bg-emerald-600 rounded-lg flex items-center justify-center\">\n                <span className=\"text-xl font-bold\">A</span>\n              </div>\n              {!isCollapsed && <span className=\"text-xl font-bold\">Admin Panel</span>}\n            </Link>\n          </div>\n\n          <nav className=\"flex-1 p-4 space-y-2\">\n            {navItems.map((item) => {\n              const isActive = pathname === item.href;\n              return (\n                <Link\n                  key={item.href}\n                  href={item.href}\n                  className={`flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${\n                    isActive\n                      ? \"bg-emerald-600 text-white\"\n                      : \"text-gray-300 hover:bg-gray-800 hover:text-white\"\n                  }`}\n                >\n                  {item.icon}\n                  {!isCollapsed && <span className=\"font-medium\">{item.name}</span>}\n                </Link>\n              );\n            })}\n          </nav>\n\n          <div className=\"p-4 border-t border-gray-800\">\n            <div className={`flex items-center ${isCollapsed ? \"justify-center\" : \"space-x-3\"} mb-3`}>\n              <div className=\"w-10 h-10 bg-emerald-600 rounded-full flex items-center justify-center text-sm font-bold\">\n                {user?.displayName?.charAt(0) || user?.email?.charAt(0) || \"A\"}\n              </div>\n              {!isCollapsed && (\n                <div className=\"flex-1 min-w-0\">\n                  <p className=\"text-sm font-medium truncate\">{user?.displayName || \"Admin\"}</p>\n                  <p className=\"text-xs text-gray-400 truncate\">{user?.email}</p>\n                </div>\n              )}\n            </div>\n            <button\n              onClick={onSignOut}\n              className={`w-full flex items-center ${\n                isCollapsed ? \"justify-center\" : \"space-x-3\"\n              } px-4 py-2 text-gray-300 hover:bg-gray-800 rounded-lg transition-colors`}\n            >\n              <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1\" />\n              </svg>\n              {!isCollapsed && <span>Sign Out</span>}\n            </button>\n          </div>\n        </div>\n      </aside>\n    </>\n  );\n}\n","path":null,"size_bytes":6648,"size_tokens":null},"src/middleware/adminAuth.js":{"content":"import 'server-only';\nimport { adminAuth, adminFirestore } from '@/lib/firebaseAdmin';\n\nexport async function requireAdmin(request) {\n  try {\n    const authHeader = request.headers.get('authorization');\n    \n    if (!authHeader || !authHeader.startsWith('Bearer ')) {\n      throw new Error('No authorization token provided');\n    }\n    \n    const idToken = authHeader.split('Bearer ')[1];\n    \n    if (!idToken) {\n      throw new Error('Invalid authorization token format');\n    }\n    \n    const decodedToken = await adminAuth.verifyIdToken(idToken);\n    \n    if (!decodedToken || !decodedToken.uid) {\n      throw new Error('Invalid token');\n    }\n    \n    const db = adminFirestore();\n    const userDoc = await db.collection('users').doc(decodedToken.uid).get();\n    \n    if (!userDoc.exists) {\n      throw new Error('User not found');\n    }\n    \n    const userData = userDoc.data();\n    \n    if (userData.role !== 'admin') {\n      throw new Error('Unauthorized: Admin access required');\n    }\n    \n    return {\n      uid: decodedToken.uid,\n      email: decodedToken.email,\n      role: userData.role,\n      ...userData\n    };\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Admin auth error:', error);\n    }\n    throw new Error(error.message || 'Unauthorized');\n  }\n}\n\nexport async function getAdminUser(userId) {\n  try {\n    const db = adminFirestore();\n    const userDoc = await db.collection('users').doc(userId).get();\n    \n    if (!userDoc.exists) {\n      return null;\n    }\n    \n    const userData = userDoc.data();\n    \n    if (userData.role !== 'admin') {\n      return null;\n    }\n    \n    return {\n      uid: userId,\n      ...userData\n    };\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error getting admin user:', error);\n    }\n    return null;\n  }\n}\n","path":null,"size_bytes":1851,"size_tokens":null},"src/utils/campaignRouteGuards.js":{"content":"/**\n * Route guard utilities for 3-page campaign flow\n * Ensures users follow the proper flow: Upload  Adjust  Result\n */\n\nconst TWENTY_FOUR_HOURS = 24 * 60 * 60 * 1000;\n\n/**\n * Check if session has expired (24 hours)\n * @param {number} timestamp - Session creation timestamp\n * @returns {boolean} - True if expired\n */\nexport function isSessionExpired(timestamp) {\n  if (!timestamp) return true;\n  return Date.now() - timestamp > TWENTY_FOUR_HOURS;\n}\n\n/**\n * Check if photo is uploaded, redirect to upload page if not\n * Used for: Adjust page, Result page\n * @param {Object} session - Current campaign session\n * @param {Object} router - Next.js router\n * @param {string} slug - Campaign slug\n * @returns {boolean} - True if photo exists, false if redirected\n */\nexport function requirePhotoUpload(session, router, slug) {\n  // No session or no photo data\n  if (!session || !session.userPhotoPreview) {\n    router.push(`/campaign/${slug}`);\n    return false;\n  }\n  \n  // Session expired\n  if (isSessionExpired(session.timestamp)) {\n    router.push(`/campaign/${slug}`);\n    return false;\n  }\n  \n  return true;\n}\n\n/**\n * Check if image is downloaded, redirect appropriately if not\n * Used for: Result page\n * @param {Object} session - Current campaign session\n * @param {Object} router - Next.js router\n * @param {string} slug - Campaign slug\n * @returns {boolean} - True if downloaded, false if redirected\n */\nexport function requireDownloadComplete(session, router, slug) {\n  // No session\n  if (!session) {\n    router.push(`/campaign/${slug}`);\n    return false;\n  }\n  \n  // Session expired\n  if (isSessionExpired(session.timestamp)) {\n    router.push(`/campaign/${slug}`);\n    return false;\n  }\n  \n  // No photo uploaded - go to upload page\n  if (!session.userPhotoPreview) {\n    router.push(`/campaign/${slug}`);\n    return false;\n  }\n  \n  // Photo uploaded but not downloaded - go to adjust page\n  if (!session.downloaded) {\n    router.push(`/campaign/${slug}/adjust`);\n    return false;\n  }\n  \n  return true;\n}\n\n/**\n * Get the appropriate redirect destination based on session state\n * @param {Object} session - Current campaign session\n * @param {string} slug - Campaign slug\n * @returns {string} - Redirect path\n */\nexport function getRedirectPath(session, slug) {\n  if (!session || !session.userPhotoPreview || isSessionExpired(session.timestamp)) {\n    return `/campaign/${slug}`;\n  }\n  \n  if (!session.downloaded) {\n    return `/campaign/${slug}/adjust`;\n  }\n  \n  return `/campaign/${slug}/result`;\n}\n","path":null,"size_bytes":2519,"size_tokens":null},"src/components/CampaignGallery.js":{"content":"\"use client\";\n\nimport { useState } from 'react';\nimport Link from 'next/link';\nimport { useAuth } from '@/hooks/useAuth';\nimport CampaignCard from './CampaignCard';\nimport ShareModal from './ShareModal';\nimport ReportModal from './ReportModal';\nimport ConfirmationModal from './ConfirmationModal';\n\nexport default function CampaignGallery({ \n  campaigns, \n  loading = false, \n  isOwnProfile = false, \n  showReportOption = false,\n  showCreatorInfo = false,\n  onCampaignDeleted\n}) {\n  const { user } = useAuth();\n  const [shareModalData, setShareModalData] = useState(null);\n  const [reportModalData, setReportModalData] = useState(null);\n  const [deleteConfirmation, setDeleteConfirmation] = useState(null);\n  const [isDeleting, setIsDeleting] = useState(false);\n  const [deleteSuccess, setDeleteSuccess] = useState(false);\n\n  if (process.env.NODE_ENV === 'development') {\n    console.log(' [CampaignGallery] Render:', {\n      campaignsCount: campaigns?.length || 0,\n      loading,\n      isOwnProfile,\n      showCreatorInfo,\n    });\n  }\n\n  if (loading) {\n    return (\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n        {[...Array(8)].map((_, i) => (\n          <div key={i} className=\"aspect-square bg-gray-200 rounded-lg animate-pulse\" />\n        ))}\n      </div>\n    );\n  }\n\n  if (!campaigns || campaigns.length === 0) {\n    return (\n      <div className=\"text-center py-12 px-4\">\n        <div className=\"max-w-md mx-auto\">\n          <svg\n            className=\"mx-auto h-16 w-16 text-gray-400 mb-4\"\n            fill=\"none\"\n            viewBox=\"0 0 24 24\"\n            stroke=\"currentColor\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              strokeWidth={1.5}\n              d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\"\n            />\n          </svg>\n          <h3 className=\"text-base font-semibold text-gray-900 mb-1.5\">\n            {isOwnProfile ? \"You haven't created any campaigns yet\" : \"No campaigns yet\"}\n          </h3>\n          <p className=\"text-sm text-gray-600 mb-4\">\n            {isOwnProfile \n              ? \"Start creating your first frame or background campaign to share with the world!\"\n              : \"This user hasn't published any campaigns yet.\"}\n          </p>\n          {isOwnProfile && (\n            <Link\n              href=\"/create\"\n              className=\"btn-base btn-primary inline-block px-4 py-2 text-sm font-medium\"\n            >\n              Create Campaign\n            </Link>\n          )}\n        </div>\n      </div>\n    );\n  }\n\n  const handleShare = (campaign) => {\n    const campaignUrl = `${window.location.origin}/campaign/${campaign.slug}`;\n    setShareModalData({\n      type: 'campaign',\n      url: campaignUrl,\n      title: campaign.title,\n      subtitle: campaign.type === 'frame' ? 'Frame' : 'Background',\n      image: campaign.imageUrl,\n    });\n  };\n\n  const handleReport = (campaign) => {\n    setReportModalData({\n      campaignId: campaign.id,\n      campaignSlug: campaign.slug,\n    });\n  };\n\n  const handleDelete = (campaign) => {\n    setDeleteConfirmation(campaign);\n  };\n\n  const handleConfirmDelete = async () => {\n    if (!deleteConfirmation || !user) return;\n\n    setIsDeleting(true);\n\n    try {\n      const token = await user.getIdToken();\n      const response = await fetch(`/api/campaigns/${deleteConfirmation.id}`, {\n        method: 'DELETE',\n        headers: {\n          'Authorization': `Bearer ${token}`,\n          'Content-Type': 'application/json',\n        },\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || 'Failed to delete campaign');\n      }\n\n      setDeleteSuccess(true);\n\n      if (onCampaignDeleted) {\n        onCampaignDeleted(deleteConfirmation.id);\n      }\n    } catch (error) {\n      console.error('Error deleting campaign:', error);\n      alert(` Error: ${error.message}`);\n    } finally {\n      setIsDeleting(false);\n    }\n  };\n\n  const handleSuccessClose = () => {\n    setDeleteSuccess(false);\n    setDeleteConfirmation(null);\n  };\n\n  return (\n    <>\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4\">\n        {campaigns.map((campaign) => (\n          <CampaignCard\n            key={campaign.id}\n            campaign={campaign}\n            isOwnProfile={isOwnProfile}\n            showReportOption={showReportOption}\n            showCreatorInfo={showCreatorInfo}\n            onShare={handleShare}\n            onReport={handleReport}\n            onDelete={handleDelete}\n          />\n        ))}\n      </div>\n\n      <ShareModal\n        isOpen={!!shareModalData}\n        onClose={() => setShareModalData(null)}\n        type={shareModalData?.type}\n        url={shareModalData?.url}\n        title={shareModalData?.title}\n        subtitle={shareModalData?.subtitle}\n        image={shareModalData?.image}\n      />\n\n      <ReportModal\n        isOpen={!!reportModalData}\n        onClose={() => setReportModalData(null)}\n        type=\"campaign\"\n        campaignId={reportModalData?.campaignId}\n        campaignSlug={reportModalData?.campaignSlug}\n      />\n\n      <ConfirmationModal\n        isOpen={!!deleteConfirmation && !deleteSuccess}\n        onClose={() => !isDeleting && setDeleteConfirmation(null)}\n        onConfirm={handleConfirmDelete}\n        title=\"Delete Campaign\"\n        message={`Are you sure you want to delete \"${deleteConfirmation?.title}\"? This action cannot be undone. All related images and data will be permanently removed.`}\n        confirmText={isDeleting ? \"Deleting...\" : \"Delete Campaign\"}\n        cancelText=\"Cancel\"\n        type=\"danger\"\n      />\n\n      {deleteSuccess && (\n        <>\n          <div \n            className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 transition-opacity\"\n            onClick={handleSuccessClose}\n          />\n          \n          <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none\">\n            <div \n              className=\"bg-white rounded-lg max-w-md w-full p-6 pointer-events-auto\"\n              onClick={(e) => e.stopPropagation()}\n            >\n              <div className=\"text-center py-4\">\n                <div className=\"mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4\">\n                  <svg className=\"h-8 w-8 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                  </svg>\n                </div>\n                <h3 className=\"text-xl font-bold text-gray-900 mb-2\">Campaign Deleted</h3>\n                <p className=\"text-gray-600 mb-6\">\n                  Your campaign has been successfully deleted.\n                </p>\n                <button\n                  onClick={handleSuccessClose}\n                  className=\"btn-base btn-primary px-8 py-2 font-medium\"\n                >\n                  OK\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n    </>\n  );\n}\n","path":null,"size_bytes":7237,"size_tokens":null},"src/app/api/admin/analytics/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\n\nexport async function GET(request) {\n  try {\n    await requireAdmin(request);\n    \n    const db = adminFirestore();\n    \n    // Use parallel queries with count aggregation for efficiency\n    const [\n      totalCampaignsSnap,\n      activeCampaignsSnap,\n      underReviewCampaignsSnap,\n      removedTempCampaignsSnap,\n      removedPermCampaignsSnap,\n      frameCampaignsSnap,\n      backgroundCampaignsSnap,\n      totalUsersSnap,\n      adminUsersSnap,\n      bannedTempUsersSnap,\n      bannedPermUsersSnap,\n      totalReportsSnap,\n      pendingReportsSnap,\n      resolvedReportsSnap,\n      dismissedReportsSnap,\n    ] = await Promise.all([\n      // Campaign counts by status\n      db.collection('campaigns').count().get(),\n      db.collection('campaigns').where('moderationStatus', '==', 'active').count().get(),\n      db.collection('campaigns').where('moderationStatus', '==', 'under-review-hidden').count().get(),\n      db.collection('campaigns').where('moderationStatus', '==', 'removed-temporary').count().get(),\n      db.collection('campaigns').where('moderationStatus', '==', 'removed-permanent').count().get(),\n      \n      // Campaign counts by type\n      db.collection('campaigns').where('type', '==', 'frame').count().get(),\n      db.collection('campaigns').where('type', '==', 'background').count().get(),\n      \n      // User counts\n      db.collection('users').count().get(),\n      db.collection('users').where('role', '==', 'admin').count().get(),\n      db.collection('users').where('accountStatus', '==', 'banned-temporary').count().get(),\n      db.collection('users').where('accountStatus', '==', 'banned-permanent').count().get(),\n      \n      // Report counts by status (using reportSummary collection)\n      db.collection('reportSummary').count().get(),\n      db.collection('reportSummary').where('status', '==', 'pending').count().get(),\n      db.collection('reportSummary').where('status', '==', 'resolved').count().get(),\n      db.collection('reportSummary').where('status', '==', 'dismissed').count().get(),\n    ]);\n    \n    // Extract counts from aggregation results\n    const totalCampaigns = totalCampaignsSnap.data().count;\n    const activeCampaigns = activeCampaignsSnap.data().count;\n    const underReviewCampaigns = underReviewCampaignsSnap.data().count;\n    const removedCampaigns = removedTempCampaignsSnap.data().count + removedPermCampaignsSnap.data().count;\n    const frameCampaigns = frameCampaignsSnap.data().count;\n    const backgroundCampaigns = backgroundCampaignsSnap.data().count;\n    \n    const totalUsers = totalUsersSnap.data().count;\n    const adminUsers = adminUsersSnap.data().count;\n    const bannedUsers = bannedTempUsersSnap.data().count + bannedPermUsersSnap.data().count;\n    const regularUsers = totalUsers - adminUsers;\n    \n    const totalReports = totalReportsSnap.data().count;\n    const pendingReports = pendingReportsSnap.data().count;\n    const resolvedReports = resolvedReportsSnap.data().count;\n    const dismissedReports = dismissedReportsSnap.data().count;\n    \n    // Calculate resolution rate\n    const resolvedOrDismissed = resolvedReports + dismissedReports;\n    const resolutionRate = totalReports > 0 ? Math.round((resolvedOrDismissed / totalReports) * 100) : 0;\n    \n    // For engagement metrics, we need to fetch active campaigns with supports\n    // Using select() to only fetch the field we need\n    const campaignsWithSupportsSnap = await db.collection('campaigns')\n      .where('moderationStatus', '==', 'active')\n      .select('supportersCount')\n      .get();\n    \n    let totalSupports = 0;\n    campaignsWithSupportsSnap.docs.forEach(doc => {\n      totalSupports += doc.data().supportersCount || 0;\n    });\n    \n    const avgSupportsPerCampaign = activeCampaigns > 0 ? Math.round(totalSupports / activeCampaigns) : 0;\n    \n    // Get top 5 reported campaigns using efficient query with orderBy and limit\n    const topReportedCampaignsSnap = await db.collection('campaigns')\n      .where('reportsCount', '>', 0)\n      .orderBy('reportsCount', 'desc')\n      .limit(5)\n      .select('title', 'reportsCount', 'moderationStatus')\n      .get();\n    \n    const topReportedCampaigns = topReportedCampaignsSnap.docs.map(doc => ({\n      id: doc.id,\n      title: doc.data().title,\n      reportsCount: doc.data().reportsCount || 0,\n      moderationStatus: doc.data().moderationStatus\n    }));\n    \n    const stats = {\n      campaigns: {\n        total: totalCampaigns,\n        active: activeCampaigns,\n        underReview: underReviewCampaigns,\n        removed: removedCampaigns,\n        frames: frameCampaigns,\n        backgrounds: backgroundCampaigns,\n      },\n      users: {\n        total: totalUsers,\n        admins: adminUsers,\n        regular: regularUsers,\n        banned: bannedUsers,\n      },\n      reports: {\n        total: totalReports,\n        pending: pendingReports,\n        resolved: resolvedReports,\n        dismissed: dismissedReports,\n        resolutionRate: resolutionRate,\n      },\n      engagement: {\n        totalSupports: totalSupports,\n        avgSupportsPerCampaign: avgSupportsPerCampaign,\n      },\n      insights: {\n        topReportedCampaigns: topReportedCampaigns,\n      },\n      timestamp: new Date().toISOString(),\n    };\n    \n    // Cache headers for 2 minutes to reduce repeated queries\n    return NextResponse.json(\n      { success: true, data: stats },\n      {\n        headers: {\n          'Cache-Control': 'private, max-age=120',\n        },\n      }\n    );\n  } catch (error) {\n    console.error('Error fetching analytics:', error);\n    \n    if (error.message.includes('Unauthorized') || error.message.includes('Admin access required')) {\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 403 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to fetch analytics' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":6044,"size_tokens":null},"CODE_INCONSISTENCIES.md":{"content":"# Code Inconsistencies & Issues - Twibbonize Platform","path":null,"size_bytes":53,"size_tokens":null},"src/app/(chrome)/admin/campaigns/page.js":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport CampaignModerationCard from \"@/components/admin/CampaignModerationCard\";\nimport ErrorBoundary from \"@/components/ErrorBoundary\";\n\nexport default function AdminCampaignsPage() {\n  return (\n    <ErrorBoundary>\n      <AdminCampaignsContent />\n    </ErrorBoundary>\n  );\n}\n\nfunction AdminCampaignsContent() {\n  const { user } = useAuth();\n  const [campaigns, setCampaigns] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [loadingMore, setLoadingMore] = useState(false);\n  const [hasMore, setHasMore] = useState(true);\n  const [filters, setFilters] = useState({\n    moderationStatus: 'all',\n    sortBy: 'createdAt',\n    limit: 10,\n  });\n\n  const fetchCampaigns = async (isLoadMore = false) => {\n    if (!user) return;\n\n    if (isLoadMore) {\n      setLoadingMore(true);\n    } else {\n      setLoading(true);\n    }\n    \n    try {\n      const token = await user.getIdToken();\n      \n      const params = new URLSearchParams();\n      if (filters.moderationStatus !== 'all') {\n        params.append('moderationStatus', filters.moderationStatus);\n      }\n      params.append('sortBy', filters.sortBy);\n      params.append('limit', filters.limit.toString());\n      \n      const response = await fetch(`/api/admin/campaigns?${params.toString()}`, {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to fetch campaigns');\n      }\n\n      const data = await response.json();\n      const newCampaigns = data.data || [];\n      setCampaigns(newCampaigns);\n      setHasMore(newCampaigns.length === filters.limit);\n    } catch (error) {\n      console.error('Error fetching campaigns:', error);\n    } finally {\n      setLoading(false);\n      setLoadingMore(false);\n    }\n  };\n\n  const handleLoadMore = () => {\n    setFilters(prev => ({ ...prev, limit: prev.limit + 10 }));\n    setTimeout(() => fetchCampaigns(true), 0);\n  };\n\n  const handleCampaignUpdate = (updatedCampaign, deleted = false) => {\n    if (deleted) {\n      setCampaigns(prevCampaigns =>\n        prevCampaigns.filter(campaign => campaign.id !== updatedCampaign?.id)\n      );\n      fetchCampaigns();\n    } else {\n      setCampaigns(prevCampaigns =>\n        prevCampaigns.map(campaign =>\n          campaign.id === updatedCampaign.id ? { ...campaign, ...updatedCampaign } : campaign\n        )\n      );\n      fetchCampaigns();\n    }\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <h2 className=\"text-lg font-semibold text-gray-900 mb-4\">Load Campaigns</h2>\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <div>\n            <label htmlFor=\"status-filter\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Moderation Status\n            </label>\n            <select\n              id=\"status-filter\"\n              value={filters.moderationStatus}\n              onChange={(e) => setFilters({ ...filters, moderationStatus: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n            >\n              <option value=\"all\" className=\"text-gray-900\">All Statuses</option>\n              <option value=\"active\" className=\"text-gray-900\">Active</option>\n              <option value=\"under-review-hidden\" className=\"text-gray-900\">Under Review (Hidden)</option>\n              <option value=\"removed-temporary\" className=\"text-gray-900\">Removed (Temporary)</option>\n              <option value=\"removed-permanent\" className=\"text-gray-900\">Removed (Permanent)</option>\n            </select>\n          </div>\n\n          <div>\n            <label htmlFor=\"sort-filter\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Sort By\n            </label>\n            <select\n              id=\"sort-filter\"\n              value={filters.sortBy}\n              onChange={(e) => setFilters({ ...filters, sortBy: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n            >\n              <option value=\"createdAt\" className=\"text-gray-900\">Most Recent</option>\n              <option value=\"reports\" className=\"text-gray-900\">Most Reports</option>\n              <option value=\"supporters\" className=\"text-gray-900\">Most Supports</option>\n            </select>\n          </div>\n\n          <div>\n            <label htmlFor=\"limit-input\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Number of Campaigns\n            </label>\n            <input\n              id=\"limit-input\"\n              type=\"number\"\n              min=\"1\"\n              max=\"500\"\n              value={filters.limit}\n              onChange={(e) => setFilters({ ...filters, limit: parseInt(e.target.value) || 10 })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n              placeholder=\"10\"\n            />\n          </div>\n\n          <div className=\"flex items-end\">\n            <button\n              onClick={fetchCampaigns}\n              disabled={loading || !user}\n              className=\"w-full px-6 py-2 bg-emerald-600 text-white font-medium rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors\"\n            >\n              {loading ? (\n                <span className=\"flex items-center justify-center\">\n                  <svg className=\"animate-spin -ml-1 mr-2 h-4 w-4 text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                  </svg>\n                  Loading...\n                </span>\n              ) : (\n                'Load Campaigns'\n              )}\n            </button>\n          </div>\n        </div>\n        {campaigns.length > 0 && (\n          <div className=\"mt-4 text-sm text-gray-600\">\n            Showing <span className=\"font-semibold\">{campaigns.length}</span> campaign{campaigns.length !== 1 ? 's' : ''}\n          </div>\n        )}\n      </div>\n\n      {loading ? (\n        <div className=\"bg-white rounded-lg shadow p-8 text-center\">\n          <div className=\"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600\"></div>\n          <p className=\"mt-2 text-gray-600\">Loading campaigns...</p>\n        </div>\n      ) : campaigns.length === 0 ? (\n        <div className=\"bg-white rounded-lg shadow p-8 text-center\">\n          <svg className=\"mx-auto h-12 w-12 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n          </svg>\n          <h3 className=\"mt-2 text-sm font-medium text-gray-900\">No campaigns found</h3>\n          <p className=\"mt-1 text-sm text-gray-500\">No campaigns match your current filters.</p>\n        </div>\n      ) : (\n        <>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {campaigns.map((campaign) => (\n              <CampaignModerationCard\n                key={campaign.id}\n                campaign={campaign}\n                onUpdate={handleCampaignUpdate}\n              />\n            ))}\n          </div>\n          \n          {hasMore && !loading && (\n            <div className=\"bg-white rounded-lg shadow p-6 text-center mt-6\">\n              <button\n                onClick={handleLoadMore}\n                disabled={loadingMore}\n                className=\"px-8 py-3 bg-emerald-600 text-white font-medium rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors\"\n              >\n                {loadingMore ? (\n                  <span className=\"flex items-center justify-center\">\n                    <svg className=\"animate-spin -ml-1 mr-2 h-4 w-4 text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\n                      <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                      <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                    </svg>\n                    Loading More...\n                  </span>\n                ) : (\n                  'Load More (10 items)'\n                )}\n              </button>\n            </div>\n          )}\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":9193,"size_tokens":null},"README.md":{"content":"This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://github.com/vercel/next.js/tree/canary/packages/create-next-app).\n\n## Getting Started\n\nFirst, run the development server:\n\n```bash\nnpm run dev\n# or\nyarn dev\n# or\npnpm dev\n# or\nbun dev\n```\n\nOpen [http://localhost:3000](http://localhost:3000) with your browser to see the result.\n\nYou can start editing the page by modifying `app/page.js`. The page auto-updates as you edit the file.\n\nThis project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.\n\n## Learn More\n\nTo learn more about Next.js, take a look at the following resources:\n\n- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.\n- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.\n\nYou can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!\n\n## Deploy on Vercel\n\nThe easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.\n\nCheck out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.\n","path":null,"size_bytes":1458,"size_tokens":null},"src/app/(chrome)/privacy/page.js":{"content":"import { Caveat } from \"next/font/google\";\n\nconst caveat = Caveat({ subsets: [\"latin\"], weight: [\"700\"] });\n\nexport const metadata = {\n  title: \"Privacy Policy - Frame\",\n  description: \"Privacy Policy for Frame - Twibbonize App\",\n};\n\nexport default function PrivacyPolicyPage() {\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <div className=\"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12\">\n        <div className=\"bg-white rounded-lg shadow-sm p-8\">\n          <h1 className={`${caveat.className} text-4xl font-bold text-emerald-700 mb-8`}>\n            Privacy Policy\n          </h1>\n          \n          <div className=\"prose max-w-none\">\n            <p className=\"text-gray-600 mb-6\">\n              <strong>Last updated:</strong> {new Date().toLocaleDateString()}\n            </p>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Introduction</h2>\n              <p className=\"text-gray-700 leading-relaxed mb-4\">\n                Welcome to Frame (\"we,\" \"our,\" or \"us\"). We are committed to protecting your personal information and your right to privacy. This Privacy Policy explains how we collect, use, disclose, and safeguard your information when you use our Frame application and services.\n              </p>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Information We Collect</h2>\n              \n              <h3 className=\"text-xl font-medium text-gray-900 mb-3\">Personal Information</h3>\n              <ul className=\"list-disc list-inside text-gray-700 mb-4 space-y-2\">\n                <li>Account information (email address, username, display name)</li>\n                <li>Profile information (bio, country, profile pictures)</li>\n                <li>Authentication data when using Google Sign-In</li>\n              </ul>\n\n              <h3 className=\"text-xl font-medium text-gray-900 mb-3\">Usage Information</h3>\n              <ul className=\"list-disc list-inside text-gray-700 mb-4 space-y-2\">\n                <li>Frame creation and usage analytics</li>\n                <li>App interaction data</li>\n                <li>Device and browser information</li>\n              </ul>\n\n              <h3 className=\"text-xl font-medium text-gray-900 mb-3\">Content</h3>\n              <ul className=\"list-disc list-inside text-gray-700 mb-4 space-y-2\">\n                <li>Images and frames you upload or create</li>\n                <li>Public frame data and analytics</li>\n              </ul>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">How We Use Your Information</h2>\n              <ul className=\"list-disc list-inside text-gray-700 space-y-2\">\n                <li>Provide and maintain our frame creation services</li>\n                <li>Process your account registration and authentication</li>\n                <li>Display public frame analytics and statistics</li>\n                <li>Improve our services and user experience</li>\n                <li>Communicate with you about service updates</li>\n                <li>Ensure platform security and prevent abuse</li>\n              </ul>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Information Sharing</h2>\n              <p className=\"text-gray-700 mb-4\">\n                We believe in transparency and making frame analytics publicly accessible. Here's what we share:\n              </p>\n              \n              <h3 className=\"text-xl font-medium text-gray-900 mb-3\">Public Information</h3>\n              <ul className=\"list-disc list-inside text-gray-700 mb-4 space-y-2\">\n                <li>Frame usage statistics and popularity metrics</li>\n                <li>Creator profiles and public frame galleries</li>\n                <li>Trending frames and top creator rankings</li>\n              </ul>\n\n              <h3 className=\"text-xl font-medium text-gray-900 mb-3\">Service Providers</h3>\n              <p className=\"text-gray-700 mb-4\">\n                We may share information with trusted service providers who help us operate our platform, including Firebase (Google) for authentication and database services, and Supabase for file storage.\n              </p>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Data Security</h2>\n              <p className=\"text-gray-700 mb-4\">\n                We implement appropriate technical and organizational security measures to protect your personal information against unauthorized access, alteration, disclosure, or destruction.\n              </p>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Your Rights</h2>\n              <ul className=\"list-disc list-inside text-gray-700 space-y-2\">\n                <li>Access and review your personal information</li>\n                <li>Update or correct your profile data</li>\n                <li>Delete your account and associated data</li>\n                <li>Opt out of certain communications</li>\n              </ul>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Children's Privacy</h2>\n              <p className=\"text-gray-700 mb-4\">\n                Our service is not intended for children under 13 years of age. We do not knowingly collect personal information from children under 13.\n              </p>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Changes to This Policy</h2>\n              <p className=\"text-gray-700 mb-4\">\n                We may update this Privacy Policy from time to time. We will notify you of any changes by posting the new Privacy Policy on this page and updating the \"Last updated\" date.\n              </p>\n            </section>\n\n            <section className=\"mb-8\">\n              <h2 className=\"text-2xl font-semibold text-gray-900 mb-4\">Contact Us</h2>\n              <p className=\"text-gray-700 mb-4\">\n                If you have any questions about this Privacy Policy, please contact us through our support channels within the application.\n              </p>\n            </section>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":6542,"size_tokens":null},"src/components/FirestoreProvider.js":{"content":"\"use client\";\n\n// Provider component to make Firebase context available to Firestore operations\nimport { createContext, useContext } from 'react';\nimport { useFirebaseOptimized as useFirebase } from '../lib/firebase-optimized';\n\nconst FirestoreContext = createContext(null);\n\nexport function FirestoreProvider({ children }) {\n  const firebase = useFirebase();\n  \n  return (\n    <FirestoreContext.Provider value={firebase}>\n      {children}\n    </FirestoreContext.Provider>\n  );\n}\n\nexport const useFirestore = () => {\n  const context = useContext(FirestoreContext);\n  if (!context) {\n    throw new Error('useFirestore must be used within a FirestoreProvider');\n  }\n  return context;\n};","path":null,"size_bytes":684,"size_tokens":null},"src/app/api/storage/upload-url/route.js":{"content":"import { NextResponse } from 'next/server'\nimport { verifyIdToken } from '../../../../lib/firebaseAdmin'\nimport { supabaseAdmin } from '../../../../lib/supabase-admin'\nimport { headers } from 'next/headers'\n\n// Force Node.js runtime for server-side operations\nexport const runtime = 'nodejs'\n\nexport async function POST(request) {\n  try {\n    // Get the authorization header\n    const headersList = headers()\n    const authorization = headersList.get('authorization')\n    \n    if (!authorization || !authorization.startsWith('Bearer ')) {\n      return NextResponse.json({ success: false, error: 'No authorization token provided' }, { status: 401 })\n    }\n\n    const token = authorization.replace('Bearer ', '')\n    \n    // Verify Firebase ID token\n    let decodedToken\n    try {\n      decodedToken = await verifyIdToken(token)\n    } catch (error) {\n      return NextResponse.json({ success: false, error: 'Invalid token' }, { status: 401 })\n    }\n\n    const { fileName, fileType, fileSize, folder = 'uploads' } = await request.json()\n    \n    // Validate folder (whitelist allowed folders)\n    const allowedFolders = ['uploads', 'profile-images', 'documents', 'temp', 'campaigns']\n    if (!allowedFolders.includes(folder)) {\n      return NextResponse.json({ success: false, error: 'Invalid folder' }, { status: 400 })\n    }\n    \n    // Validate required fields\n    if (!fileName) {\n      return NextResponse.json({ success: false, error: 'fileName is required' }, { status: 400 })\n    }\n\n    if (!Number.isFinite(fileSize) || fileSize <= 0) {\n      return NextResponse.json({ \n        success: false,\n        error: 'fileSize is required and must be a positive number' \n      }, { status: 400 })\n    }\n\n    if (!fileType || typeof fileType !== 'string' || fileType.trim() === '') {\n      return NextResponse.json({ \n        success: false,\n        error: 'fileType is required and must be a non-empty string' \n      }, { status: 400 })\n    }\n\n    // Validate file size (5MB max for campaigns and profile-images, 10MB max for others)\n    const maxFileSize = (folder === 'campaigns' || folder === 'profile-images') ? 5 * 1024 * 1024 : 10 * 1024 * 1024\n    if (fileSize > maxFileSize) {\n      const maxSizeMB = (folder === 'campaigns' || folder === 'profile-images') ? 5 : 10\n      return NextResponse.json({ \n        success: false,\n        error: `File size exceeds ${maxSizeMB}MB limit` \n      }, { status: 400 })\n    }\n\n    // Validate file type for campaigns\n    if (folder === 'campaigns') {\n      const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp']\n      if (!allowedTypes.includes(fileType.toLowerCase())) {\n        return NextResponse.json({ \n          success: false,\n          error: 'Invalid file type for campaigns. Only PNG, JPG, and WEBP are allowed.' \n        }, { status: 400 })\n      }\n    }\n\n    // Create user-specific path\n    const timestamp = Date.now()\n    const sanitizedFileName = fileName.replace(/[^a-zA-Z0-9.-]/g, '_')\n    const filePath = `${folder}/${decodedToken.uid}/${timestamp}-${sanitizedFileName}`\n\n    // Generate signed upload URL (valid for 1 hour)\n    const { data, error } = await supabaseAdmin.storage\n      .from('uploads')\n      .createSignedUploadUrl(filePath)\n\n    if (error) {\n      console.error('Supabase error:', error)\n      return NextResponse.json({ success: false, error: 'Failed to create upload URL' }, { status: 500 })\n    }\n\n    return NextResponse.json({\n      success: true,\n      uploadUrl: data.signedUrl,\n      path: filePath,\n      token: data.token\n    })\n\n  } catch (error) {\n    console.error('Upload URL generation error:', error)\n    return NextResponse.json({ success: false, error: 'Internal server error' }, { status: 500 })\n  }\n}","path":null,"size_bytes":3724,"size_tokens":null},"src/components/UserOnboardingWrapper.js":{"content":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { useAuth } from '../hooks/useAuth';\nimport { getUserProfile } from '../lib/firestore';\n\nexport default function UserOnboardingWrapper({ children }) {\n  const { user, loading } = useAuth();\n  const router = useRouter();\n  const [checkingProfile, setCheckingProfile] = useState(false);\n\n  useEffect(() => {\n    const checkProfileStatus = async () => {\n      if (!user || loading) return;\n\n      // For email/password users, check if email is verified first\n      if (user.providerData[0]?.providerId === 'password' && !user.emailVerified) {\n        return;\n      }\n\n      setCheckingProfile(true);\n      \n      // Add a small delay to ensure Firebase auth state has stabilized after verification\n      await new Promise(resolve => setTimeout(resolve, 1000));\n      \n      try {\n        let userProfile = await getUserProfile(user.uid);\n        \n        // If profile doesn't exist, wait a bit and try again (profile creation might be in progress)\n        if (!userProfile) {\n          await new Promise(resolve => setTimeout(resolve, 2000));\n          userProfile = await getUserProfile(user.uid);\n        }\n        \n        // If still no profile, this is unexpected\n        if (!userProfile) {\n          return;\n        }\n        \n        \n        // Navigate to onboarding page if user exists but hasn't completed profile setup\n        if (userProfile && !userProfile.profileCompleted) {\n          router.push('/onboarding');\n        }\n      } catch (error) {\n      } finally {\n        setCheckingProfile(false);\n      }\n    };\n\n    checkProfileStatus();\n  }, [user, loading, router]);\n\n\n  // Don't render welcome popup if still loading or checking\n  if (loading || checkingProfile) {\n    return children;\n  }\n\n  return children;\n}","path":null,"size_bytes":1845,"size_tokens":null},"src/lib/firestore.js":{"content":"\"use client\";\n\n// Firestore database operations for the Twibbonize app\nimport { db } from './firebase-optimized';\nimport { handleFirebaseError } from '../utils/firebaseErrorHandler';\nimport { \n  doc, \n  setDoc, \n  getDoc, \n  collection, \n  addDoc, \n  getDocs, \n  query, \n  where, \n  orderBy, \n  limit,\n  startAfter,\n  serverTimestamp,\n  updateDoc,\n  increment,\n  runTransaction,\n  writeBatch\n} from 'firebase/firestore';\n\n\n// Get database instance - simplified since we have direct db import\nconst getDatabase = () => {\n  return db;\n};\n\n// Generate unique username with max attempts to prevent infinite loops\nexport const generateUniqueUsername = async (baseUsername, maxAttempts = 100) => {\n  let username = baseUsername.toLowerCase().replace(/[^a-z0-9]/g, '');\n  \n  // Ensure username is at least 3 characters\n  if (username.length < 3) {\n    username = username + '123';\n  }\n  \n  // Check if username exists with attempt limit\n  let counter = 0;\n  let finalUsername = username;\n  let attempts = 0;\n  \n  while (await checkUsernameExists(finalUsername) && attempts < maxAttempts) {\n    counter++;\n    finalUsername = `${username}${counter}`;\n    attempts++;\n  }\n  \n  if (attempts >= maxAttempts) {\n    // Fallback: use timestamp-based unique identifier\n    finalUsername = `${username}${Date.now().toString().slice(-6)}`;\n\n  }\n  \n  return finalUsername;\n};\n\n// Check if username already exists - using usernames collection for atomicity\nexport const checkUsernameExists = async (username) => {\n  const normalizedUsername = username.toLowerCase().trim();\n  \n  // Check if database is initialized\n  if (!db) {\n    return true; // Assume exists on error to be safe\n  }\n  \n  try {\n    // Check usernames collection for atomicity (maintained for data integrity)\n    const usernameDocRef = doc(db, 'usernames', normalizedUsername);\n    const usernameDoc = await getDoc(usernameDocRef);\n    const exists = usernameDoc.exists();\n    \n    return exists;\n  } catch (error) {\n    return true; // Assume exists on error to be safe\n  }\n};\n\n// Atomic username reservation using usernames collection (maintained for data integrity)\nconst reserveUsernameAtomically = async (baseUsername, userUid, userProfile) => {\n  const maxAttempts = 100;\n  let username = baseUsername.toLowerCase().replace(/[^a-z0-9]/g, '');\n  \n  // Ensure username is at least 3 characters\n  if (username.length < 3) {\n    username = username + '123';\n  }\n\n  return await runTransaction(db, async (transaction) => {\n    let counter = 0;\n    let finalUsername = username;\n    let attempts = 0;\n    \n    // Try to find available username atomically using usernames collection\n    while (attempts < maxAttempts) {\n      const usernameDocRef = doc(db, 'usernames', finalUsername);\n      const usernameDoc = await transaction.get(usernameDocRef);\n      \n      if (!usernameDoc.exists()) {\n        // Username is available, reserve it atomically\n        transaction.set(usernameDocRef, {\n          userId: userUid,\n          createdAt: serverTimestamp(),\n        });\n        \n        const userDocRef = doc(db, 'users', userUid);\n        transaction.set(userDocRef, {\n          ...userProfile,\n          username: finalUsername,\n        });\n        return { success: true, username: finalUsername, docRef: userDocRef };\n      }\n      \n      // Username taken, try next variation\n      counter++;\n      finalUsername = `${username}${counter}`;\n      attempts++;\n    }\n    \n    // Fallback: use timestamp-based unique identifier\n    finalUsername = `${username}${Date.now().toString().slice(-6)}`;\n    \n    const usernameDocRef = doc(db, 'usernames', finalUsername);\n    transaction.set(usernameDocRef, {\n      userId: userUid,\n      createdAt: serverTimestamp(),\n    });\n    \n    const userDocRef = doc(db, 'users', userUid);\n    transaction.set(userDocRef, {\n      ...userProfile,\n      username: finalUsername,\n    });\n    return { success: true, username: finalUsername, docRef: userDocRef };\n  });\n};\n\n// User Profile operations with atomic username reservation\nexport const createUserProfile = async (user) => {\n  if (!user) return { success: false, error: 'No user provided' };\n  \n  const database = getDatabase();\n  // Check if Firebase is configured\n  if (!database) {\n\n    return { success: false, error: 'Database not available' };\n  }\n  \n  try {\n      const userDocRef = doc(database, 'users', user.uid);\n    const userDoc = await getDoc(userDocRef);\n    \n    if (!userDoc.exists()) {\n      const { displayName, email, photoURL } = user;\n      \n      // Prepare user profile data\n      const userProfile = {\n        displayName,\n        email,\n        photoURL,\n        bio: '',\n        country: '',\n        bannerImage: '',\n        profileImage: photoURL || '',\n        role: 'user', // Default role for new users (admin role assigned separately)\n        supportersCount: 0,\n        campaignsCount: 0,\n        createdAt: serverTimestamp(),\n        updatedAt: serverTimestamp(),\n        profileCompleted: false, // Track if user has completed welcome popup\n      };\n      \n      // Generate base username and reserve atomically\n      const baseUsername = displayName || email?.split('@')[0] || 'user';\n      const result = await reserveUsernameAtomically(baseUsername, user.uid, userProfile);\n      \n      if (result.success) {\n        return { success: true, docRef: result.docRef, username: result.username };\n      } else {\n        return { success: false, error: 'Failed to reserve username' };\n      }\n    }\n    \n    return { success: true, docRef: userDocRef, existing: true };\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error creating user profile:', error);\n    }\n    const errorResponse = await handleFirebaseError(error, 'firestore', { returnType: 'string' });\n    return { success: false, error: errorResponse || 'Failed to complete operation. Please try again.' };\n  }\n};\n\nexport const getUserProfile = async (userId) => {\n  if (!userId) {\n    return null;\n  }\n  \n  const database = getDatabase();\n  // Check if Firebase is configured\n  if (!database) {\n\n    return null;\n  }\n  \n  try {\n    const userDocRef = doc(database, 'users', userId);\n    const userDoc = await getDoc(userDocRef);\n    \n    if (userDoc.exists()) {\n      const userData = userDoc.data();\n      // Ensure required fields exist with fallbacks\n      return { \n        id: userDoc.id, \n        ...userData,\n        supportersCount: userData.supportersCount || 0,\n        campaignsCount: userData.campaignsCount || 0,\n        bio: userData.bio || '',\n        profileImage: userData.profileImage || '',\n        bannerImage: userData.bannerImage || ''\n      };\n    } else {\n      return null;\n    }\n  } catch (error) {\n    return null;\n  }\n};\n\n// Get user profile by username (for /[username] route) - using usernames collection for consistency\nexport const getUserProfileByUsername = async (username) => {\n  if (!username || typeof username !== 'string') {\n    return null;\n  }\n  \n  // Normalize username\n  const normalizedUsername = username.toLowerCase().trim();\n  if (!normalizedUsername) {\n    return null;\n  }\n  \n  try {\n    // Check if database is available\n    if (!db) {\n      return null;\n    }\n\n    // First, resolve username to userId using usernames collection\n    const usernameDocRef = doc(db, 'usernames', normalizedUsername);\n    const usernameDoc = await getDoc(usernameDocRef);\n    \n    if (!usernameDoc.exists()) {\n      return null;\n    }\n    \n    const { userId } = usernameDoc.data();\n    \n    // Then fetch user profile using the userId\n    const userDocRef = doc(db, 'users', userId);\n    const userDoc = await getDoc(userDocRef);\n    \n    if (!userDoc.exists()) {\n      return null;\n    }\n    \n    const userData = userDoc.data();\n    \n    // Ensure required fields exist with fallbacks\n    return { \n      id: userDoc.id, \n      ...userData,\n      supportersCount: userData.supportersCount || 0,\n      campaignsCount: userData.campaignsCount || 0,\n      bio: userData.bio || '',\n      profileImage: userData.profileImage || '',\n      bannerImage: userData.bannerImage || ''\n    };\n  } catch (error) {\n    return null;\n  }\n};\n\n// Update user profile with atomic username reservation\nexport const updateUserProfile = async (userId, updates) => {\n  if (!userId) return { success: false, error: 'No user ID provided' };\n  \n  // Check if Firebase is configured\n  if (!db) {\n\n    return { success: false, error: 'Database not available' };\n  }\n  \n  // Whitelist of safe fields that users can update\n  const allowedFields = ['bio', 'bannerImage', 'profileImage', 'displayName', 'country', 'username', 'profileCompleted'];\n  \n  // Filter updates to only include allowed fields\n  const filteredUpdates = {};\n  for (const field of allowedFields) {\n    if (updates.hasOwnProperty(field)) {\n      filteredUpdates[field] = updates[field];\n    }\n  }\n  \n  // If no valid fields to update, return early\n  if (Object.keys(filteredUpdates).length === 0) {\n    return { success: false, error: 'No valid fields to update' };\n  }\n\n  try {\n    return await runTransaction(db, async (transaction) => {\n      const userDocRef = doc(db, 'users', userId);\n      const userDoc = await transaction.get(userDocRef);\n      \n      if (!userDoc.exists()) {\n        throw new Error('User profile not found');\n      }\n\n      const currentData = userDoc.data();\n      \n      // If username is being changed, normalize and ensure it's unique atomically\n      if (filteredUpdates.username && filteredUpdates.username !== currentData.username) {\n        // Normalize username to ensure consistency\n        const normalizedUsername = filteredUpdates.username.toLowerCase().replace(/[^a-z0-9]/g, '');\n        \n        // Validate normalized username\n        if (normalizedUsername.length < 3) {\n          throw new Error('Username must be at least 3 characters long');\n        }\n        \n        // If normalization changed the username, reject to avoid confusion\n        if (normalizedUsername !== filteredUpdates.username) {\n          throw new Error('Username can only contain lowercase letters and numbers');\n        }\n        \n        // Reserve the new username atomically using usernames collection\n        const usernameDocRef = doc(db, 'usernames', normalizedUsername);\n        const usernameDoc = await transaction.get(usernameDocRef);\n        \n        if (usernameDoc.exists()) {\n          throw new Error('Username already taken');\n        }\n        \n        // Reserve the new username\n        transaction.set(usernameDocRef, {\n          userId: userId,\n          createdAt: serverTimestamp(),\n        });\n        \n        // Remove old username reservation if it exists\n        if (currentData.username) {\n          const oldUsernameDocRef = doc(db, 'usernames', currentData.username);\n          transaction.delete(oldUsernameDocRef);\n        }\n        \n        // Update the filtered updates with normalized username\n        filteredUpdates.username = normalizedUsername;\n      }\n\n      // Update the user profile\n      transaction.update(userDocRef, {\n        ...filteredUpdates,\n        updatedAt: serverTimestamp(),\n      });\n      \n      // Sync denormalized creator data to campaigns if displayName, username, or profileImage changed\n      const needsCampaignSync = \n        filteredUpdates.displayName !== undefined ||\n        filteredUpdates.username !== undefined ||\n        filteredUpdates.profileImage !== undefined;\n      \n      if (needsCampaignSync) {\n        // Note: We do campaign sync outside transaction to avoid timeout\n        // This is eventually consistent but prevents transaction failures\n      }\n      \n      return { \n        success: true, \n        username: filteredUpdates.username || currentData.username,\n        needsCampaignSync: needsCampaignSync,\n        syncData: needsCampaignSync ? {\n          creatorName: filteredUpdates.displayName ?? currentData.displayName,\n          creatorUsername: filteredUpdates.username ?? currentData.username,\n          creatorAvatar: filteredUpdates.profileImage ?? currentData.profileImage,\n        } : null\n      };\n    });\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error updating user profile:', error);\n    }\n    const errorResponse = await handleFirebaseError(error, 'firestore', { returnType: 'string' });\n    return { success: false, error: errorResponse || 'Failed to complete operation. Please try again.' };\n  }\n};\n\n// Sync denormalized creator data to all user's campaigns (call after profile update)\nexport const syncCreatorDataToCampaigns = async (userId, syncData) => {\n  if (!userId || !syncData || !db) return { success: false, error: 'Missing required data' };\n  \n  try {\n    // Find all campaigns by this user\n    const campaignsQuery = query(\n      collection(db, 'campaigns'),\n      where('creatorId', '==', userId)\n    );\n    \n    const snapshot = await getDocs(campaignsQuery);\n    \n    if (snapshot.empty) {\n      return { success: true, updatedCount: 0 };\n    }\n    \n    // Update each campaign with new creator data\n    const batch = writeBatch(db);\n    let count = 0;\n    \n    snapshot.forEach((docSnapshot) => {\n      batch.update(docSnapshot.ref, {\n        creatorName: syncData.creatorName,\n        creatorUsername: syncData.creatorUsername,\n        creatorAvatar: syncData.creatorAvatar,\n        updatedAt: serverTimestamp(),\n      });\n      count++;\n    });\n    \n    await batch.commit();\n    \n    return { success: true, updatedCount: count };\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error syncing creator data to campaigns:', error);\n    }\n    return { success: false, error: 'Failed to sync creator data' };\n  }\n};\n\n// Get user statistics (returns stored counters for consistency and performance)\nexport const getUserStats = async (userId) => {\n  if (!userId) return { supportersCount: 0, campaignsCount: 0 };\n  \n  try {\n    // Get stored counters from user profile for consistency\n    const userProfile = await getUserProfile(userId);\n    if (userProfile) {\n      return {\n        supportersCount: userProfile.supportersCount || 0,\n        campaignsCount: userProfile.campaignsCount || 0,\n      };\n    } else {\n      return { supportersCount: 0, campaignsCount: 0 };\n    }\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error getting user stats:', error);\n    }\n    return { supportersCount: 0, campaignsCount: 0 };\n  }\n};\n\n// Campaign operations with comprehensive error handling\nexport const createCampaign = async (campaignData, userId) => {\n  if (!userId) {\n    return { success: false, error: 'User ID is required' };\n  }\n  \n  if (!campaignData || typeof campaignData !== 'object') {\n    return { success: false, error: 'Campaign data is required' };\n  }\n  \n  // Validate required fields\n  const requiredFields = ['type', 'title', 'slug', 'imageUrl'];\n  const missingFields = requiredFields.filter(field => !campaignData[field]);\n  if (missingFields.length > 0) {\n    return { success: false, error: `Missing required fields: ${missingFields.join(', ')}` };\n  }\n  \n  // Validate type is either 'frame' or 'background'\n  if (!['frame', 'background'].includes(campaignData.type)) {\n    return { success: false, error: 'Type must be either \"frame\" or \"background\"' };\n  }\n  \n  try {\n    return await runTransaction(db, async (transaction) => {\n      // Fetch user data for denormalization (reduces N+1 queries when fetching campaigns)\n      const userDocRef = doc(db, 'users', userId);\n      const userDoc = await transaction.get(userDocRef);\n      \n      let creatorName = 'Anonymous';\n      let creatorUsername = null;\n      let creatorAvatar = null;\n      \n      if (userDoc.exists()) {\n        const userData = userDoc.data();\n        creatorName = userData.displayName || 'Anonymous';\n        creatorUsername = userData.username || null;\n        creatorAvatar = userData.profileImage || null;\n      }\n      \n      // Create the campaign with explicit schema (no spread operator)\n      const campaignRef = doc(collection(db, 'campaigns'));\n      const campaignDoc = {\n        // Required fields from CAMPAIGN_SYSTEM.md\n        type: campaignData.type,                    // \"frame\" or \"background\"\n        title: campaignData.title,                  // Campaign title\n        slug: campaignData.slug,                    // URL-friendly slug\n        imageUrl: campaignData.imageUrl,            // Supabase storage URL\n        storagePath: campaignData.storagePath,      // Storage path for deletion operations\n        creatorId: userId,                          // Renamed from createdBy\n        \n        // Denormalized creator data (avoids N+1 queries)\n        creatorName: creatorName,                   // Creator's display name\n        creatorUsername: creatorUsername,           // Creator's username for profile links\n        creatorAvatar: creatorAvatar,               // Creator's profile image URL\n        \n        // Optional metadata fields\n        description: campaignData.description || '',\n        captionTemplate: campaignData.captionTemplate || '',\n        \n        // Counter fields (optimized: removed supporters object to reduce document size)\n        supportersCount: 0,                         // Total downloads count\n        reportsCount: 0,                            // Number of reports received\n        \n        // Status fields\n        moderationStatus: 'active',                 // \"active\" | \"under-review\" | \"removed\"\n        isPublic: campaignData.isPublic ?? true,    // Current feature (not in docs)\n        \n        // Timestamps\n        createdAt: serverTimestamp(),               // When campaign was published\n        updatedAt: serverTimestamp(),               // Last modification time\n        // firstUsedAt - added later when first supporter downloads\n      };\n      \n      transaction.set(campaignRef, campaignDoc);\n      \n      // Update user's campaign counters atomically (optimized: removed duplicate campaignsCreated field)\n      transaction.update(userDocRef, {\n        campaignsCount: increment(1),\n        updatedAt: serverTimestamp(),\n      });\n      \n      return { success: true, campaignId: campaignRef.id };\n    });\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error creating campaign:', error, { userId, campaignData: { ...campaignData, imageData: '[redacted]' } });\n    }\n    const errorResponse = await handleFirebaseError(error, 'firestore', { returnType: 'string' });\n    return { success: false, error: errorResponse || 'Failed to create campaign. Please try again.' };\n  }\n};\n\nexport const getPublicCampaigns = async (limitCount = 10) => {\n  try {\n    const q = query(\n      collection(db, 'campaigns'),\n      where('isPublic', '==', true),\n      orderBy('createdAt', 'desc'),\n      limit(limitCount)\n    );\n    \n    const querySnapshot = await getDocs(q);\n    const campaigns = [];\n    \n    querySnapshot.forEach((doc) => {\n      campaigns.push({ id: doc.id, ...doc.data() });\n    });\n    \n    return campaigns;\n  } catch (error) {\n    return [];\n  }\n};\n\n/**\n * Get user campaigns with pagination support\n * @param {string} userId - User ID\n * @param {object} options - Query options\n * @param {string} options.orderByField - Field to order by (default: 'createdAt')\n * @param {string} options.orderDirection - Order direction (default: 'desc')\n * @param {number} options.page - Page number (1-indexed, default: 1)\n * @param {number} options.pageSize - Number of campaigns per page (default: 10)\n * @returns {Promise<{campaigns: Array, totalCount: number, totalPages: number, currentPage: number}>} Paginated campaigns\n */\nexport const getUserCampaigns = async (userId, options = {}) => {\n  if (process.env.NODE_ENV === 'development') {\n    console.log(' [getUserCampaigns] Starting - userId:', userId);\n  }\n  \n  if (!userId) {\n    if (process.env.NODE_ENV === 'development') {\n      console.warn(' [getUserCampaigns] No userId provided');\n    }\n    return { campaigns: [], totalCount: 0, totalPages: 0, currentPage: 1 };\n  }\n  \n  // Check if database is initialized\n  if (!db) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error(' [getUserCampaigns] Database not initialized (Firebase disabled)');\n    }\n    return { campaigns: [], totalCount: 0, totalPages: 0, currentPage: 1 };\n  }\n  \n  const {\n    orderByField = 'createdAt',\n    orderDirection = 'desc',\n    page = 1,\n    pageSize = 10\n  } = options;\n  \n  if (process.env.NODE_ENV === 'development') {\n    console.log(' [getUserCampaigns] Query params:', {\n      orderByField,\n      orderDirection,\n      page,\n      pageSize,\n      collection: 'campaigns',\n      field: 'creatorId',\n      value: userId\n    });\n  }\n  \n  try {\n    // Query all user campaigns for count and pagination\n    const q = query(\n      collection(db, 'campaigns'),\n      where('creatorId', '==', userId),\n      where('moderationStatus', 'in', ['active', 'under-review']),\n      orderBy(orderByField, orderDirection)\n    );\n    \n    const querySnapshot = await getDocs(q);\n    const allCampaigns = [];\n    \n    if (process.env.NODE_ENV === 'development') {\n      console.log(' [getUserCampaigns] Query result - docs count:', querySnapshot.size);\n    }\n    \n    querySnapshot.forEach((doc) => {\n      const data = doc.data();\n      if (process.env.NODE_ENV === 'development') {\n        console.log(' [getUserCampaigns] Document:', {\n          id: doc.id,\n          creatorId: data.creatorId,\n          title: data.title,\n          slug: data.slug,\n          imageUrl: data.imageUrl\n        });\n      }\n      \n      allCampaigns.push({ \n        id: doc.id,\n        slug: data.slug,\n        title: data.title,\n        type: data.type,\n        imageUrl: data.imageUrl,\n        supportersCount: data.supportersCount || 0,\n        createdAt: data.createdAt,\n        description: data.description || '',\n        moderationStatus: data.moderationStatus || 'active'\n      });\n    });\n    \n    // Calculate pagination\n    const totalCount = allCampaigns.length;\n    const totalPages = Math.ceil(totalCount / pageSize);\n    const currentPage = Math.max(1, Math.min(page, totalPages || 1));\n    const startIndex = (currentPage - 1) * pageSize;\n    const endIndex = startIndex + pageSize;\n    \n    // Get paginated slice\n    const paginatedCampaigns = allCampaigns.slice(startIndex, endIndex);\n    \n    if (process.env.NODE_ENV === 'development') {\n      console.log(' [getUserCampaigns] Returning campaigns:', paginatedCampaigns.length, 'of', totalCount);\n    }\n    \n    return {\n      campaigns: paginatedCampaigns,\n      totalCount,\n      totalPages,\n      currentPage\n    };\n  } catch (error) {\n    console.error(' [getUserCampaigns] Error:', {\n      message: error.message,\n      code: error.code,\n      name: error.name,\n      stack: error.stack\n    });\n    return { campaigns: [], totalCount: 0, totalPages: 0, currentPage: 1 };\n  }\n};\n\n/**\n * Get campaign by slug\n * @param {string} slug - Campaign slug from URL\n * @returns {Promise<{campaign: object, creator: object}|null>} Campaign with creator info or null if not found\n */\nexport const getCampaignBySlug = async (slug) => {\n  if (!slug) return null;\n  \n  // Check if database is initialized\n  if (!db) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Database not initialized - cannot get campaign by slug');\n    }\n    return null;\n  }\n  \n  try {\n    // Query campaigns collection by slug\n    const q = query(\n      collection(db, 'campaigns'),\n      where('slug', '==', slug),\n      limit(1)\n    );\n    \n    const querySnapshot = await getDocs(q);\n    \n    if (querySnapshot.empty) {\n      return null;\n    }\n    \n    const campaignDoc = querySnapshot.docs[0];\n    const campaignData = { id: campaignDoc.id, ...campaignDoc.data() };\n    \n    // Don't show removed or hidden campaigns\n    if (campaignData.moderationStatus === 'removed-temporary' || \n        campaignData.moderationStatus === 'removed-permanent' ||\n        campaignData.moderationStatus === 'under-review-hidden') {\n      return null;\n    }\n    \n    // Fetch creator info\n    let creatorData = null;\n    if (campaignData.creatorId) {\n      try {\n        const creatorDocRef = doc(db, 'users', campaignData.creatorId);\n        const creatorDoc = await getDoc(creatorDocRef);\n        \n        if (creatorDoc.exists()) {\n          creatorData = { id: creatorDoc.id, ...creatorDoc.data() };\n        }\n      } catch (creatorError) {\n        // Continue without creator info if fetch fails\n        if (process.env.NODE_ENV === 'development') {\n          console.error('Failed to fetch creator info:', creatorError);\n        }\n      }\n    }\n    \n    return {\n      campaign: campaignData,\n      creator: creatorData\n    };\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error getting campaign by slug:', error);\n    }\n    return null;\n  }\n};\n\n// Complete user profile setup after welcome popup\nexport const completeUserProfile = async (userId, profileData) => {\n  if (!userId || !profileData) return { success: false, error: 'Missing required data' };\n\n  try {\n    return await runTransaction(db, async (transaction) => {\n      const userDocRef = doc(db, 'users', userId);\n      const userDoc = await transaction.get(userDocRef);\n      \n      if (!userDoc.exists()) {\n        throw new Error('User profile not found');\n      }\n\n      const currentData = userDoc.data();\n      \n      // Check if username is being changed and ensure it's unique atomically\n      if (profileData.username && profileData.username !== currentData.username) {\n        // Normalize username to ensure consistency  \n        const normalizedUsername = profileData.username.toLowerCase().replace(/[^a-z0-9]/g, '');\n        \n        // Validate normalized username\n        if (normalizedUsername.length < 3) {\n          throw new Error('Username must be at least 3 characters long');\n        }\n        \n        // If normalization changed the username, reject to avoid confusion\n        if (normalizedUsername !== profileData.username) {\n          throw new Error('Username can only contain lowercase letters and numbers');\n        }\n        \n        // Reserve username atomically using usernames collection\n        const usernameDocRef = doc(db, 'usernames', normalizedUsername);\n        const usernameDoc = await transaction.get(usernameDocRef);\n        \n        if (usernameDoc.exists()) {\n          throw new Error('Username already taken');\n        }\n        \n        // Reserve the new username\n        transaction.set(usernameDocRef, {\n          userId: userId,\n          createdAt: serverTimestamp(),\n        });\n        \n        // Remove old username reservation if it exists\n        if (currentData.username) {\n          const oldUsernameDocRef = doc(db, 'usernames', currentData.username);\n          transaction.delete(oldUsernameDocRef);\n        }\n        \n        // Update profileData with normalized username\n        profileData.username = normalizedUsername;\n      }\n\n      // Prepare update data\n      const updateData = {\n        displayName: profileData.displayName || currentData.displayName,\n        username: profileData.username || currentData.username,\n        country: profileData.country || currentData.country,\n        profileCompleted: true,\n        updatedAt: serverTimestamp(),\n      };\n\n      // Handle bio - include empty string values to support clearing\n      if (profileData.hasOwnProperty('bio')) {\n        updateData.bio = profileData.bio;\n      } else {\n        updateData.bio = currentData.bio || '';\n      }\n\n      // Handle profile image - include null values to support removals\n      if (profileData.hasOwnProperty('profileImage')) {\n        updateData.profileImage = profileData.profileImage;\n      }\n\n      // Handle banner image - include null values to support removals\n      if (profileData.hasOwnProperty('bannerImage')) {\n        updateData.bannerImage = profileData.bannerImage;\n      }\n\n      transaction.update(userDocRef, updateData);\n      \n      return { success: true, username: updateData.username };\n    });\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error completing user profile:', error);\n    }\n    const errorResponse = await handleFirebaseError(error, 'firestore', { returnType: 'string' });\n    return { success: false, error: errorResponse || 'Failed to complete operation. Please try again.' };\n  }\n};\n\n// Report operations for campaign moderation\nexport const createReport = async (reportData) => {\n  if (!reportData || typeof reportData !== 'object') {\n    return { success: false, error: 'Report data is required' };\n  }\n  \n  // Validate required fields\n  const requiredFields = ['campaignId', 'reason'];\n  const missingFields = requiredFields.filter(field => !reportData[field]);\n  if (missingFields.length > 0) {\n    return { success: false, error: `Missing required fields: ${missingFields.join(', ')}` };\n  }\n  \n  // Validate reason is one of the allowed values\n  const validReasons = ['inappropriate', 'spam', 'copyright', 'other'];\n  if (!validReasons.includes(reportData.reason)) {\n    return { success: false, error: 'Invalid report reason' };\n  }\n  \n  try {\n    return await runTransaction(db, async (transaction) => {\n      // Create the report document\n      const reportRef = doc(collection(db, 'reports'));\n      const reportDoc = {\n        campaignId: reportData.campaignId,\n        campaignSlug: reportData.campaignSlug || '',\n        reportedBy: reportData.reportedBy || 'anonymous',\n        reason: reportData.reason,\n        details: reportData.details || '',\n        status: 'pending',\n        createdAt: serverTimestamp(),\n        reviewedAt: null,\n        reviewedBy: null,\n        action: null,\n      };\n      \n      transaction.set(reportRef, reportDoc);\n      \n      // Increment the campaign's reportsCount\n      const campaignRef = doc(db, 'campaigns', reportData.campaignId);\n      const campaignDoc = await transaction.get(campaignRef);\n      \n      if (!campaignDoc.exists()) {\n        throw new Error('Campaign not found');\n      }\n      \n      const currentReportsCount = campaignDoc.data().reportsCount || 0;\n      const newReportsCount = currentReportsCount + 1;\n      \n      const campaignUpdates = {\n        reportsCount: increment(1),\n        updatedAt: serverTimestamp(),\n      };\n      \n      // Auto-flag for review if threshold reached (3+ reports)\n      if (newReportsCount >= 3 && campaignDoc.data().moderationStatus === 'active') {\n        campaignUpdates.moderationStatus = 'under-review';\n      }\n      \n      transaction.update(campaignRef, campaignUpdates);\n      \n      return { success: true, reportId: reportRef.id };\n    });\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error creating report:', error);\n    }\n    const errorResponse = await handleFirebaseError(error, 'firestore', { returnType: 'string' });\n    return { success: false, error: errorResponse || 'Failed to submit report. Please try again.' };\n  }\n};\n\n// Get all reports (admin only - enforce in component)\nexport const getReports = async (filterOptions = {}) => {\n  if (!db) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Database not initialized - cannot get reports');\n    }\n    return [];\n  }\n  \n  try {\n    let q = collection(db, 'reports');\n    const constraints = [];\n    \n    // Add filters\n    if (filterOptions.status) {\n      constraints.push(where('status', '==', filterOptions.status));\n    }\n    \n    if (filterOptions.campaignId) {\n      constraints.push(where('campaignId', '==', filterOptions.campaignId));\n    }\n    \n    // Always order by creation date (newest first)\n    constraints.push(orderBy('createdAt', 'desc'));\n    \n    // Add limit if specified\n    if (filterOptions.limit) {\n      constraints.push(limit(filterOptions.limit));\n    }\n    \n    if (constraints.length > 0) {\n      q = query(q, ...constraints);\n    }\n    \n    const querySnapshot = await getDocs(q);\n    const reports = [];\n    \n    querySnapshot.forEach((doc) => {\n      reports.push({ id: doc.id, ...doc.data() });\n    });\n    \n    return reports;\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error getting reports:', error);\n    }\n    return [];\n  }\n};\n\n// Get reports for a specific campaign\nexport const getCampaignReports = async (campaignId, limitCount = 50) => {\n  return getReports({ campaignId, limit: limitCount });\n};\n\n// Update report status (admin only - enforce in component)\nexport const updateReportStatus = async (reportId, statusData) => {\n  if (!reportId || !statusData) {\n    return { success: false, error: 'Report ID and status data are required' };\n  }\n  \n  // Validate status\n  const validStatuses = ['pending', 'reviewed', 'resolved', 'dismissed'];\n  if (statusData.status && !validStatuses.includes(statusData.status)) {\n    return { success: false, error: 'Invalid status' };\n  }\n  \n  // Validate action if provided\n  const validActions = ['removed', 'warned', 'no-action'];\n  if (statusData.action && !validActions.includes(statusData.action)) {\n    return { success: false, error: 'Invalid action' };\n  }\n  \n  try {\n    const reportRef = doc(db, 'reports', reportId);\n    const reportDoc = await getDoc(reportRef);\n    \n    if (!reportDoc.exists()) {\n      return { success: false, error: 'Report not found' };\n    }\n    \n    const updateData = {\n      updatedAt: serverTimestamp(),\n    };\n    \n    if (statusData.status) {\n      updateData.status = statusData.status;\n      updateData.reviewedAt = serverTimestamp();\n    }\n    \n    if (statusData.reviewedBy) {\n      updateData.reviewedBy = statusData.reviewedBy;\n    }\n    \n    if (statusData.action) {\n      updateData.action = statusData.action;\n    }\n    \n    await updateDoc(reportRef, updateData);\n    \n    return { success: true };\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error updating report status:', error);\n    }\n    const errorResponse = await handleFirebaseError(error, 'firestore', { returnType: 'string' });\n    return { success: false, error: errorResponse || 'Failed to update report. Please try again.' };\n  }\n};\n\n// ============================================================================\n// REPORT SUMMARY FUNCTIONS (for grouped reporting)\n// ============================================================================\n\n/**\n * Create or update report summary for grouped reporting\n * This aggregates reports by campaign or user for efficient admin display\n * @param {object} summaryData - Summary data\n * @returns {Promise<object>} Success response\n */\nexport const upsertReportSummary = async (summaryData) => {\n  if (!db) {\n    return { success: false, error: 'Database not initialized' };\n  }\n  \n  try {\n    const { targetId, targetType, reportData } = summaryData;\n    \n    if (!targetId || !targetType) {\n      return { success: false, error: 'Target ID and type are required' };\n    }\n    \n    const summaryId = `${targetType}-${targetId}`;\n    const summaryRef = doc(db, 'reportSummary', summaryId);\n    \n    await runTransaction(db, async (transaction) => {\n      const summaryDoc = await transaction.get(summaryRef);\n      const now = new Date();\n      \n      if (summaryDoc.exists()) {\n        // Update existing summary\n        const currentData = summaryDoc.data();\n        const updates = {\n          lastReportedAt: now,\n          updatedAt: now,\n        };\n        \n        // If previously resolved/dismissed, reset counter to start fresh\n        if (currentData.status === 'resolved' || currentData.status === 'dismissed') {\n          updates.status = 'pending';\n          updates.reportsCount = 1;\n          updates.firstReportedAt = now;\n        } else {\n          // Still pending, increment counter\n          updates.reportsCount = (currentData.reportsCount || 0) + 1;\n        }\n        \n        transaction.update(summaryRef, updates);\n      } else {\n        // Create new summary\n        const newSummary = {\n          targetId,\n          targetType,\n          reportsCount: 1,\n          firstReportedAt: now,\n          lastReportedAt: now,\n          status: 'pending',\n          createdAt: now,\n          updatedAt: now,\n          // Include display data for quick access\n          ...reportData,\n        };\n        \n        transaction.set(summaryRef, newSummary);\n      }\n    });\n    \n    return { success: true };\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error upserting report summary:', error);\n    }\n    const errorResponse = await handleFirebaseError(error, 'firestore', { returnType: 'string' });\n    return { success: false, error: errorResponse || 'Failed to update report summary' };\n  }\n};\n\n/**\n * Get grouped report summaries with filters and sorting\n * @param {object} options - Query options\n * @returns {Promise<Array>} Array of report summaries\n */\nexport const getReportSummaries = async (options = {}) => {\n  if (!db) {\n    return [];\n  }\n  \n  const {\n    targetType = 'all',\n    status = 'pending',\n    sortBy = 'lastReportedAt',\n    sortOrder = 'desc',\n    limitCount = 10,\n  } = options;\n  \n  try {\n    let q = collection(db, 'reportSummary');\n    const constraints = [];\n    \n    // Filter by target type\n    if (targetType !== 'all') {\n      constraints.push(where('targetType', '==', targetType));\n    }\n    \n    // Filter by status\n    if (status !== 'all') {\n      constraints.push(where('status', '==', status));\n    }\n    \n    // Add sorting\n    constraints.push(orderBy(sortBy, sortOrder));\n    constraints.push(limit(limitCount));\n    \n    if (constraints.length > 0) {\n      q = query(q, ...constraints);\n    }\n    \n    const querySnapshot = await getDocs(q);\n    const summaries = [];\n    \n    querySnapshot.forEach((doc) => {\n      summaries.push({ id: doc.id, ...doc.data() });\n    });\n    \n    return summaries;\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error getting report summaries:', error);\n    }\n    return [];\n  }\n};\n\n/**\n * Update report summary status (when admin takes action)\n * @param {string} summaryId - Summary document ID\n * @param {string} newStatus - New status ('resolved', 'dismissed')\n * @returns {Promise<object>} Success response\n */\nexport const updateReportSummaryStatus = async (summaryId, newStatus) => {\n  if (!db) {\n    return { success: false, error: 'Database not initialized' };\n  }\n  \n  try {\n    const summaryRef = doc(db, 'reportSummary', summaryId);\n    const summaryDoc = await getDoc(summaryRef);\n    \n    if (!summaryDoc.exists()) {\n      return { success: false, error: 'Report summary not found' };\n    }\n    \n    await updateDoc(summaryRef, {\n      status: newStatus,\n      resolvedAt: newStatus === 'resolved' || newStatus === 'dismissed' ? new Date() : null,\n      reportsCount: 0,\n      updatedAt: new Date(),\n    });\n    \n    return { success: true };\n  } catch (error) {\n    if (process.env.NODE_ENV === 'development') {\n      console.error('Error updating report summary status:', error);\n    }\n    const errorResponse = await handleFirebaseError(error, 'firestore', { returnType: 'string' });\n    return { success: false, error: errorResponse || 'Failed to update report summary status' };\n  }\n};\n\n/**\n * Get all campaigns with optional filters and pagination\n * @param {object} filters - Filter options\n * @param {string} filters.type - Campaign type ('frame', 'background', or 'all')\n * @param {string} filters.country - Filter by creator's country\n * @param {string} filters.timePeriod - Time period ('24h', '7d', '30d', or 'all')\n * @param {string} filters.sortBy - Sort field ('supportersCount' or 'createdAt')\n * @param {number} filters.page - Page number (1-indexed)\n * @param {number} filters.pageSize - Number of campaigns per page (default: 10)\n * @returns {Promise<{campaigns: Array, totalCount: number, totalPages: number, currentPage: number}>} Paginated campaigns with creator info\n */\nexport const getAllCampaigns = async (filters = {}) => {\n  const {\n    type = 'all',\n    country = null,\n    timePeriod = 'all',\n    sortBy = 'createdAt',\n    page = 1,\n    pageSize = 10\n  } = filters;\n  \n  // Check if database is initialized\n  if (!db) {\n    console.error('Database not initialized - cannot get campaigns');\n    return { campaigns: [], totalCount: 0, totalPages: 0, currentPage: 1 };\n  }\n  \n  try {\n    // Calculate time cutoff for filtering\n    let timeCutoff = null;\n    if (timePeriod !== 'all') {\n      const now = new Date();\n      switch (timePeriod) {\n        case '24h':\n          timeCutoff = new Date(now.getTime() - 24 * 60 * 60 * 1000);\n          break;\n        case '7d':\n          timeCutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n          break;\n        case '30d':\n          timeCutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n          break;\n      }\n    }\n    \n    // Build query - Only show active campaigns (exclude removed and hidden)\n    let constraints = [\n      where('moderationStatus', 'in', ['active', 'under-review'])\n    ];\n    \n    // Add type filter\n    if (type !== 'all') {\n      constraints.push(where('type', '==', type));\n    }\n    \n    // Add time filter\n    if (timeCutoff) {\n      constraints.push(where('createdAt', '>=', timeCutoff));\n    }\n    \n    // Add sorting\n    constraints.push(orderBy(sortBy, 'desc'));\n    \n    // First, get total count for pagination (fetch all matching docs)\n    const countQuery = query(collection(db, 'campaigns'), ...constraints);\n    const countSnapshot = await getDocs(countQuery);\n    const allCampaigns = [];\n    \n    // Collect campaigns - use denormalized creator data when available\n    const campaignsNeedingCreator = [];\n    countSnapshot.forEach((docSnapshot) => {\n      const data = docSnapshot.data();\n      const campaign = {\n        id: docSnapshot.id,\n        ...data\n      };\n      \n      // Build creator object from denormalized fields (for new campaigns)\n      // or mark for fetching (for old campaigns without denormalized data)\n      if (data.creatorName || data.creatorUsername || data.creatorAvatar) {\n        campaign.creator = {\n          id: data.creatorId,\n          displayName: data.creatorName || 'Anonymous',\n          username: data.creatorUsername || null,\n          profileImage: data.creatorAvatar || null,\n        };\n      } else if (data.creatorId) {\n        campaignsNeedingCreator.push(campaign);\n      }\n      \n      allCampaigns.push(campaign);\n    });\n    \n    // Fetch creators only for old campaigns that don't have denormalized data\n    if (campaignsNeedingCreator.length > 0) {\n      const creatorIds = [...new Set(campaignsNeedingCreator.map(c => c.creatorId))];\n      const creatorsMap = new Map();\n      \n      const creatorPromises = creatorIds.map(async (creatorId) => {\n        try {\n          const creatorDocRef = doc(db, 'users', creatorId);\n          const creatorDoc = await getDoc(creatorDocRef);\n          if (creatorDoc.exists()) {\n            return { id: creatorDoc.id, ...creatorDoc.data() };\n          }\n        } catch (error) {\n          console.error('Error fetching creator:', error);\n        }\n        return null;\n      });\n      \n      const creators = await Promise.all(creatorPromises);\n      creators.forEach((creator) => {\n        if (creator) {\n          creatorsMap.set(creator.id, creator);\n        }\n      });\n      \n      // Attach creator data to old campaigns\n      campaignsNeedingCreator.forEach((campaign) => {\n        campaign.creator = creatorsMap.get(campaign.creatorId) || null;\n      });\n    }\n    \n    // Filter by country if specified (country filtering requires full creator data)\n    let filteredCampaigns = allCampaigns;\n    if (country) {\n      filteredCampaigns = allCampaigns.filter((campaign) => {\n        return campaign.creator && campaign.creator.country === country;\n      });\n    }\n    \n    // Calculate pagination\n    const totalCount = filteredCampaigns.length;\n    const totalPages = Math.ceil(totalCount / pageSize);\n    const currentPage = Math.max(1, Math.min(page, totalPages || 1));\n    const startIndex = (currentPage - 1) * pageSize;\n    const endIndex = startIndex + pageSize;\n    \n    // Get paginated slice\n    const paginatedCampaigns = filteredCampaigns.slice(startIndex, endIndex);\n    \n    return {\n      campaigns: paginatedCampaigns,\n      totalCount,\n      totalPages,\n      currentPage\n    };\n  } catch (error) {\n    console.error('Error getting campaigns:', error);\n    return { campaigns: [], totalCount: 0, totalPages: 0, currentPage: 1 };\n  }\n};\n\n/**\n * Get top creators with aggregated stats\n * @param {object} filters - Filter options\n * @param {string} filters.country - Filter by country\n * @param {string} filters.timePeriod - Time period ('24h', '7d', '30d', or 'all')\n * @param {number} filters.limit - Number of creators to return\n * @returns {Promise<Array>} Array of creators with stats\n */\nexport const getTopCreators = async (filters = {}) => {\n  const {\n    country = null,\n    timePeriod = 'all',\n    limit: limitCount = 20\n  } = filters;\n  \n  // Check if database is initialized\n  if (!db) {\n    console.error('Database not initialized - cannot get top creators');\n    return [];\n  }\n  \n  try {\n    // Calculate time cutoff for filtering\n    let timeCutoff = null;\n    if (timePeriod !== 'all') {\n      const now = new Date();\n      switch (timePeriod) {\n        case '24h':\n          timeCutoff = new Date(now.getTime() - 24 * 60 * 60 * 1000);\n          break;\n        case '7d':\n          timeCutoff = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);\n          break;\n        case '30d':\n          timeCutoff = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n          break;\n      }\n    }\n    \n    // Build query for campaigns (active campaigns only)\n    const campaignsQuery = query(\n      collection(db, 'campaigns'),\n      where('moderationStatus', '!=', 'removed')\n    );\n    const campaignsSnapshot = await getDocs(campaignsQuery);\n    \n    // Aggregate stats by creator\n    const creatorStatsMap = new Map();\n    \n    // Process each campaign\n    for (const campaignDoc of campaignsSnapshot.docs) {\n      const campaignData = campaignDoc.data();\n      const creatorId = campaignData.creatorId;\n      \n      // Initialize creator stats if not exists\n      if (!creatorStatsMap.has(creatorId)) {\n        creatorStatsMap.set(creatorId, {\n          campaignsCount: 0,\n          totalSupports: 0\n        });\n      }\n      \n      const stats = creatorStatsMap.get(creatorId);\n      \n      // Count campaigns created in time period (if time filter applied)\n      if (!timeCutoff || (campaignData.createdAt && campaignData.createdAt.toDate() >= timeCutoff)) {\n        stats.campaignsCount++;\n      }\n      \n      // Count supports received in time period\n      if (timeCutoff) {\n        // Query downloads subcollection for this campaign within time period\n        const downloadsQuery = query(\n          collection(db, 'campaigns', campaignDoc.id, 'downloads'),\n          where('downloadedAt', '>=', timeCutoff)\n        );\n        const downloadsSnapshot = await getDocs(downloadsQuery);\n        stats.totalSupports += downloadsSnapshot.size;\n      } else {\n        // For 'all time', use the main supportersCount\n        stats.totalSupports += campaignData.supportersCount || 0;\n      }\n    }\n    \n    // Fetch creator profiles\n    const creatorIds = Array.from(creatorStatsMap.keys());\n    const creatorPromises = creatorIds.map(async (creatorId) => {\n      try {\n        const creatorDocRef = doc(db, 'users', creatorId);\n        const creatorDoc = await getDoc(creatorDocRef);\n        \n        if (creatorDoc.exists()) {\n          const creatorData = { id: creatorDoc.id, ...creatorDoc.data() };\n          const stats = creatorStatsMap.get(creatorId);\n          \n          return {\n            ...creatorData,\n            campaignsCount: stats.campaignsCount,\n            totalSupports: stats.totalSupports\n          };\n        }\n      } catch (error) {\n        console.error('Error fetching creator profile:', error);\n      }\n      return null;\n    });\n    \n    let creators = await Promise.all(creatorPromises);\n    creators = creators.filter(creator => creator !== null);\n    \n    // Filter by country if specified\n    if (country) {\n      creators = creators.filter(creator => creator.country === country);\n    }\n    \n    // Sort by total supports (descending)\n    creators.sort((a, b) => b.totalSupports - a.totalSupports);\n    \n    // Limit results\n    return creators.slice(0, limitCount);\n  } catch (error) {\n    console.error('Error getting top creators:', error);\n    return [];\n  }\n};\n\n// ==================== ADMIN FUNCTIONS ====================\n// Note: Admin role management is handled server-side via API routes\n// See: /api/admin/users/[userId]/role for setUserRole implementation\n// This ensures admin operations use Firebase Admin SDK and bypass client-side security rules\n\n// ==================== APPEAL FUNCTIONS ====================\n\nexport const createAppeal = async (appealData) => {\n  try {\n    const appealsRef = collection(db, 'appeals');\n    const appealDoc = await addDoc(appealsRef, {\n      ...appealData,\n      status: 'pending',\n      submittedAt: serverTimestamp(),\n      createdAt: serverTimestamp(),\n    });\n    \n    return { success: true, appealId: appealDoc.id };\n  } catch (error) {\n    console.error('Error creating appeal:', error);\n    throw handleFirebaseError(error);\n  }\n};\n\nexport const getAppealsByUser = async (userId) => {\n  try {\n    const appealsRef = collection(db, 'appeals');\n    const q = query(\n      appealsRef,\n      where('userId', '==', userId),\n      orderBy('submittedAt', 'desc')\n    );\n    \n    const snapshot = await getDocs(q);\n    const appeals = [];\n    \n    snapshot.forEach((doc) => {\n      appeals.push({ id: doc.id, ...doc.data() });\n    });\n    \n    return appeals;\n  } catch (error) {\n    console.error('Error getting user appeals:', error);\n    return [];\n  }\n};\n\nexport const getAppealById = async (appealId) => {\n  try {\n    const appealRef = doc(db, 'appeals', appealId);\n    const appealDoc = await getDoc(appealRef);\n    \n    if (!appealDoc.exists()) {\n      return null;\n    }\n    \n    return { id: appealDoc.id, ...appealDoc.data() };\n  } catch (error) {\n    console.error('Error getting appeal:', error);\n    return null;\n  }\n};","path":null,"size_bytes":50486,"size_tokens":null},"src/app/api/storage/list/route.js":{"content":"import { NextResponse } from 'next/server'\nimport { verifyIdToken } from '../../../../lib/firebaseAdmin'\nimport { supabaseAdmin } from '../../../../lib/supabase-admin'\nimport { headers } from 'next/headers'\n\n// Force Node.js runtime for server-side operations\nexport const runtime = 'nodejs'\n\nexport async function GET(request) {\n  try {\n    // Get the authorization header\n    const headersList = headers()\n    const authorization = headersList.get('authorization')\n    \n    if (!authorization || !authorization.startsWith('Bearer ')) {\n      return NextResponse.json({ success: false, error: 'No authorization token provided' }, { status: 401 })\n    }\n\n    const token = authorization.replace('Bearer ', '')\n    \n    // Verify Firebase ID token\n    let decodedToken\n    try {\n      decodedToken = await verifyIdToken(token)\n    } catch (error) {\n      return NextResponse.json({ success: false, error: 'Invalid token' }, { status: 401 })\n    }\n\n    const { searchParams } = new URL(request.url)\n    const folder = searchParams.get('folder') || 'uploads'\n    const limit = Math.min(parseInt(searchParams.get('limit')) || 100, 1000) // Cap at 1000\n    const offset = Math.max(parseInt(searchParams.get('offset')) || 0, 0) // Ensure non-negative\n    \n    // Validate folder\n    const allowedFolders = ['uploads', 'profile-images', 'documents', 'temp', 'campaigns']\n    if (!allowedFolders.includes(folder)) {\n      return NextResponse.json({ success: false, error: 'Invalid folder' }, { status: 400 })\n    }\n\n    // List files in user's folder only\n    const userFolder = `${folder}/${decodedToken.uid}`\n    \n    const { data, error } = await supabaseAdmin.storage\n      .from('uploads')\n      .list(userFolder, {\n        limit,\n        offset,\n        sortBy: { column: 'name', order: 'desc' }\n      })\n\n    if (error) {\n      console.error('Supabase error:', error)\n      return NextResponse.json({ success: false, error: 'Failed to list files' }, { status: 500 })\n    }\n\n    // Add full paths to the response\n    const filesWithPaths = data.map(file => ({\n      ...file,\n      fullPath: `${userFolder}/${file.name}`\n    }))\n\n    return NextResponse.json({ \n      success: true,\n      files: filesWithPaths\n    })\n\n  } catch (error) {\n    console.error('File listing error:', error)\n    return NextResponse.json({ success: false, error: 'Internal server error' }, { status: 500 })\n  }\n}","path":null,"size_bytes":2387,"size_tokens":null},"src/components/admin/ReportDetailsPanel.js":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport ConfirmationModal from \"@/components/ConfirmationModal\";\n\nexport default function ReportDetailsPanel({ report, onClose, onUpdate, isGrouped = false }) {\n  const { user } = useAuth();\n  const [isUpdating, setIsUpdating] = useState(false);\n  const [updateError, setUpdateError] = useState(null);\n  const [confirmAction, setConfirmAction] = useState(null);\n  const [selectedReason, setSelectedReason] = useState('');\n  const [showReasonDropdown, setShowReasonDropdown] = useState(false);\n  const [pendingAction, setPendingAction] = useState(null);\n\n  const actionReasons = [\n    { value: 'inappropriate_content', label: 'Inappropriate content' },\n    { value: 'spam', label: 'Spam' },\n    { value: 'harassment', label: 'Harassment' },\n    { value: 'misinformation', label: 'Misinformation' },\n    { value: 'copyright_violation', label: 'Copyright violation' },\n    { value: 'other', label: 'Other' },\n  ];\n\n  const getStatusColor = (status) => {\n    switch (status) {\n      case 'pending':\n        return 'bg-yellow-100 text-yellow-800';\n      case 'reviewed':\n        return 'bg-blue-100 text-blue-800';\n      case 'resolved':\n        return 'bg-green-100 text-green-800';\n      case 'dismissed':\n        return 'bg-gray-100 text-gray-800';\n      default:\n        return 'bg-gray-100 text-gray-800';\n    }\n  };\n\n  const getReasonText = (reason) => {\n    switch (reason) {\n      case 'inappropriate':\n        return 'Inappropriate Content';\n      case 'spam':\n        return 'Spam';\n      case 'copyright':\n        return 'Copyright Violation';\n      case 'inappropriate_avatar':\n        return 'Inappropriate Profile Picture';\n      case 'offensive_username':\n        return 'Offensive Username';\n      case 'spam_bio':\n        return 'Spam in Bio';\n      case 'impersonation':\n        return 'Impersonation';\n      case 'other':\n        return 'Other';\n      default:\n        return reason;\n    }\n  };\n\n  const formatDate = (dateString) => {\n    if (!dateString) return '-';\n    try {\n      return new Date(dateString).toLocaleDateString('en-US', {\n        year: 'numeric',\n        month: 'long',\n        day: 'numeric',\n        hour: '2-digit',\n        minute: '2-digit',\n      });\n    } catch {\n      return '-';\n    }\n  };\n\n  const openConfirmation = (status, action, actionLabel) => {\n    if (action === 'warned' || action === 'removed') {\n      setPendingAction({ status, action, actionLabel });\n      setShowReasonDropdown(true);\n      setSelectedReason('');\n    } else {\n      setConfirmAction({ status, action, actionLabel });\n    }\n  };\n\n  const handleReasonSubmit = () => {\n    if (!selectedReason) {\n      alert('Please select a reason for this action.');\n      return;\n    }\n\n    setShowReasonDropdown(false);\n    setConfirmAction({ ...pendingAction, reason: selectedReason });\n    setPendingAction(null);\n  };\n\n  const handleConfirmedAction = async () => {\n    if (!user || !confirmAction) return;\n\n    const { status, action, reason } = confirmAction;\n\n    setIsUpdating(true);\n    setUpdateError(null);\n\n    try {\n      const token = await user.getIdToken();\n      \n      const endpoint = isGrouped \n        ? `/api/admin/reports/summary/${report.id}`\n        : `/api/admin/reports/${report.id}`;\n      \n      const requestBody = { status, action };\n      \n      if (reason) {\n        requestBody.reason = reason;\n      }\n      \n      const response = await fetch(endpoint, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify(requestBody),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || 'Failed to update report');\n      }\n\n      alert(` Action completed successfully! ${action === 'no-action' ? 'Report dismissed' : action === 'warned' ? 'Warning issued' : 'Content removed'}`);\n\n      if (onUpdate) {\n        onUpdate(data.data);\n      }\n    } catch (error) {\n      setUpdateError(error.message);\n      alert(` Error: ${error.message}`);\n    } finally {\n      setIsUpdating(false);\n    }\n  };\n\n  const getConfirmationMessage = (action) => {\n    const targetName = (isGrouped ? report.targetType === 'user' : report.type === 'profile')\n      ? (isGrouped ? report.displayName || report.username : report.reportedUser?.displayName)\n      : (isGrouped ? report.campaignTitle : report.campaign?.title);\n\n    switch (action) {\n      case 'no-action':\n        return `Are you sure you want to dismiss this report? The ${isGrouped ? report.targetType : (report.type === 'profile' ? 'user' : 'campaign')} will be restored to active status.`;\n      case 'warned':\n        return `Are you sure you want to issue a warning to this ${(isGrouped ? report.targetType === 'user' : report.type === 'profile') ? 'user' : 'creator'}? They will receive a notification with the selected reason.`;\n      case 'removed':\n        return `Are you sure you want to ${(isGrouped ? report.targetType === 'user' : report.type === 'profile') ? 'ban this user' : 'remove this campaign'}? This action will hide the content and notify the ${(isGrouped ? report.targetType === 'user' : report.type === 'profile') ? 'user' : 'creator'} with the selected reason and appeal deadline.`;\n      default:\n        return 'Are you sure you want to proceed with this action?';\n    }\n  };\n\n  if (!report) return null;\n\n  return (\n    <div className=\"fixed inset-0 z-50 overflow-hidden\">\n      <div className=\"absolute inset-0 bg-gray-500 bg-opacity-75 transition-opacity\" onClick={onClose}></div>\n      \n      <div className=\"fixed inset-y-0 right-0 max-w-full flex\">\n        <div className=\"w-screen max-w-2xl\">\n          <div className=\"h-full flex flex-col bg-white shadow-xl overflow-y-scroll\">\n            <div className=\"px-6 py-4 bg-emerald-700\">\n              <div className=\"flex items-center justify-between\">\n                <h2 className=\"text-lg font-medium text-white\">Report Details</h2>\n                <button\n                  onClick={onClose}\n                  className=\"text-white hover:text-gray-200 transition-colors\"\n                >\n                  <svg className=\"h-6 w-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                  </svg>\n                </button>\n              </div>\n            </div>\n\n            <div className=\"flex-1 px-6 py-6 space-y-6\">\n              {updateError && (\n                <div className=\"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded\">\n                  {updateError}\n                </div>\n              )}\n\n              <div>\n                <h3 className=\"text-sm font-medium text-gray-500 mb-2\">Status</h3>\n                <span className={`px-3 py-1 inline-flex text-sm leading-5 font-semibold rounded-full ${getStatusColor(report.status)}`}>\n                  {report.status}\n                </span>\n              </div>\n\n              {(isGrouped ? report.targetType === 'user' : report.type === 'profile') ? (\n                <div>\n                  <h3 className=\"text-sm font-medium text-gray-500 mb-2\">Reported User</h3>\n                  <div className=\"bg-gray-50 rounded-lg p-4\">\n                    {(isGrouped ? report.profileImage : report.reportedUser?.avatarUrl) && (\n                      <img\n                        src={isGrouped ? report.profileImage : report.reportedUser.avatarUrl}\n                        alt={isGrouped ? report.displayName : report.reportedUser.displayName}\n                        className=\"w-20 h-20 rounded-full mb-3 object-cover\"\n                        loading=\"lazy\"\n                      />\n                    )}\n                    <h4 className=\"font-medium text-gray-900\">\n                      {isGrouped \n                        ? (report.displayName || report.username || 'Unknown User')\n                        : (report.reportedUser?.displayName || report.reportedUsername || 'Unknown User')\n                      }\n                    </h4>\n                    {(isGrouped ? report.username : report.reportedUser?.username) && (\n                      <p className=\"text-sm text-gray-600 mt-1\">\n                        @{isGrouped ? report.username : report.reportedUser.username}\n                      </p>\n                    )}\n                    <p className=\"text-sm text-gray-600 mt-1\">\n                      Status: <span className=\"capitalize\">{isGrouped ? report.accountStatus : (report.reportedUser?.accountStatus || 'Unknown')}</span>\n                    </p>\n                    {isGrouped && (\n                      <p className=\"text-sm text-gray-600\">\n                        Reports: {report.reportsCount || 0}\n                      </p>\n                    )}\n                    {!isGrouped && report.reportedUser?.reportsCount > 0 && (\n                      <p className=\"text-sm text-gray-600\">\n                        Total Reports: {report.reportedUser.reportsCount}\n                      </p>\n                    )}\n                    {(isGrouped ? report.username : report.reportedUsername) && (\n                      <a\n                        href={`/u/${isGrouped ? report.username : report.reportedUsername}`}\n                        target=\"_blank\"\n                        rel=\"noopener noreferrer\"\n                        className=\"text-sm text-emerald-600 hover:text-emerald-700 mt-2 inline-block\"\n                      >\n                        View Profile \n                      </a>\n                    )}\n                  </div>\n                </div>\n              ) : (\n                <div>\n                  <h3 className=\"text-sm font-medium text-gray-500 mb-2\">Campaign</h3>\n                  <div className=\"bg-gray-50 rounded-lg p-4\">\n                    {(isGrouped ? report.campaignImage : report.campaign?.imageUrl) && (\n                      <img\n                        src={isGrouped ? report.campaignImage : report.campaign.imageUrl}\n                        alt={isGrouped ? report.campaignTitle : report.campaign.title}\n                        className=\"w-full h-48 object-cover rounded-lg mb-3\"\n                        loading=\"lazy\"\n                      />\n                    )}\n                    <h4 className=\"font-medium text-gray-900\">\n                      {isGrouped ? (report.campaignTitle || 'Unknown Campaign') : (report.campaign?.title || 'Unknown Campaign')}\n                    </h4>\n                    <p className=\"text-sm text-gray-600 mt-1\">\n                      Type: <span className=\"capitalize\">{isGrouped ? report.campaignType : (report.campaign?.type || 'Unknown')}</span>\n                    </p>\n                    <p className=\"text-sm text-gray-600\">\n                      Status: <span className=\"capitalize\">{isGrouped ? report.moderationStatus : (report.campaign?.moderationStatus || 'Unknown')}</span>\n                    </p>\n                    {isGrouped && (\n                      <p className=\"text-sm text-gray-600\">\n                        Reports: {report.reportsCount || 0}\n                      </p>\n                    )}\n                    {!isGrouped && report.campaign?.creator && (\n                      <p className=\"text-sm text-gray-600\">\n                        Creator: {report.campaign.creator.displayName}\n                      </p>\n                    )}\n                    {(isGrouped ? report.campaignSlug : report.campaign?.slug) && (\n                      <a\n                        href={`/campaign/${isGrouped ? report.campaignSlug : report.campaign.slug}`}\n                        target=\"_blank\"\n                        rel=\"noopener noreferrer\"\n                        className=\"text-sm text-emerald-600 hover:text-emerald-700 mt-2 inline-block\"\n                      >\n                        View Campaign \n                      </a>\n                    )}\n                  </div>\n                </div>\n              )}\n\n              <div>\n                <h3 className=\"text-sm font-medium text-gray-500 mb-2\">Report Details</h3>\n                <dl className=\"space-y-2\">\n                  {!isGrouped && (\n                    <>\n                      <div>\n                        <dt className=\"text-xs text-gray-500\">Reason</dt>\n                        <dd className=\"text-sm text-gray-900\">{getReasonText(report.reason)}</dd>\n                      </div>\n                      {report.details && (\n                        <div>\n                          <dt className=\"text-xs text-gray-500\">Additional Details</dt>\n                          <dd className=\"text-sm text-gray-900\">{report.details}</dd>\n                        </div>\n                      )}\n                      <div>\n                        <dt className=\"text-xs text-gray-500\">Reported By</dt>\n                        <dd className=\"text-sm text-gray-900\">\n                          {report.reporter?.displayName || 'Anonymous'}\n                          {report.reporter?.username && (\n                            <span className=\"text-gray-500\"> (@{report.reporter.username})</span>\n                          )}\n                        </dd>\n                      </div>\n                      <div>\n                        <dt className=\"text-xs text-gray-500\">Reported At</dt>\n                        <dd className=\"text-sm text-gray-900\">{formatDate(report.createdAt)}</dd>\n                      </div>\n                      {report.reviewedAt && (\n                        <div>\n                          <dt className=\"text-xs text-gray-500\">Reviewed At</dt>\n                          <dd className=\"text-sm text-gray-900\">{formatDate(report.reviewedAt)}</dd>\n                        </div>\n                      )}\n                      {report.action && (\n                        <div>\n                          <dt className=\"text-xs text-gray-500\">Action Taken</dt>\n                          <dd className=\"text-sm text-gray-900 capitalize\">{report.action.replace('-', ' ')}</dd>\n                        </div>\n                      )}\n                    </>\n                  )}\n                  {isGrouped && (\n                    <>\n                      <div>\n                        <dt className=\"text-xs text-gray-500\">Reports Count</dt>\n                        <dd className=\"text-sm text-gray-900\">{report.reportsCount || 0}</dd>\n                      </div>\n                      <div>\n                        <dt className=\"text-xs text-gray-500\">First Reported</dt>\n                        <dd className=\"text-sm text-gray-900\">{formatDate(report.firstReportedAt)}</dd>\n                      </div>\n                      <div>\n                        <dt className=\"text-xs text-gray-500\">Last Reported</dt>\n                        <dd className=\"text-sm text-gray-900\">{formatDate(report.lastReportedAt)}</dd>\n                      </div>\n                      <div>\n                        <dt className=\"text-xs text-gray-500\">Summary Status</dt>\n                        <dd className=\"text-sm text-gray-900 capitalize\">{report.status}</dd>\n                      </div>\n                    </>\n                  )}\n                </dl>\n              </div>\n\n              <div>\n                <h3 className=\"text-sm font-medium text-gray-500 mb-3\">Actions</h3>\n                <div className=\"space-y-3\">\n                  <button\n                    onClick={() => openConfirmation('dismissed', 'no-action', 'Dismiss Report')}\n                    disabled={isUpdating || report.status === 'dismissed'}\n                    className=\"w-full btn-base btn-secondary px-5 py-3 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed\"\n                  >\n                    {isUpdating ? 'Processing...' : 'Dismiss Report'}\n                  </button>\n                  \n                  <button\n                    onClick={() => openConfirmation('resolved', 'warned', (isGrouped ? report.targetType === 'user' : report.type === 'profile') ? 'Warn User' : 'Warn Creator')}\n                    disabled={isUpdating || report.status === 'resolved' || report.status === 'dismissed'}\n                    className=\"w-full btn-base btn-warning px-5 py-3 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed\"\n                  >\n                    {isUpdating ? 'Processing...' : ((isGrouped ? report.targetType === 'user' : report.type === 'profile') ? 'Warn User' : 'Warn Creator')}\n                  </button>\n                  \n                  <button\n                    onClick={() => openConfirmation('resolved', 'removed', (isGrouped ? report.targetType === 'user' : report.type === 'profile') ? 'Ban User' : 'Remove Campaign')}\n                    disabled={isUpdating || report.status === 'resolved' || report.status === 'dismissed'}\n                    className=\"w-full btn-base btn-danger px-5 py-3 text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed\"\n                  >\n                    {isUpdating ? 'Processing...' : ((isGrouped ? report.targetType === 'user' : report.type === 'profile') ? 'Ban User' : 'Remove Campaign')}\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Reason Selection Modal */}\n      {showReasonDropdown && (\n        <div className=\"fixed inset-0 z-[60] overflow-y-auto\">\n          <div className=\"flex min-h-screen items-center justify-center p-4\">\n            <div className=\"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity\" onClick={() => setShowReasonDropdown(false)}></div>\n            \n            <div className=\"relative bg-white rounded-lg shadow-xl max-w-md w-full p-6\">\n              <h3 className=\"text-lg font-medium text-gray-900 mb-4\">\n                Select Reason for {pendingAction?.action === 'warned' ? 'Warning' : 'Removal/Ban'}\n              </h3>\n              \n              <div className=\"mb-4\">\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  Reason <span className=\"text-red-500\">*</span>\n                </label>\n                <select\n                  value={selectedReason}\n                  onChange={(e) => setSelectedReason(e.target.value)}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500\"\n                >\n                  <option value=\"\">-- Select a reason --</option>\n                  {actionReasons.map((reason) => (\n                    <option key={reason.value} value={reason.value}>\n                      {reason.label}\n                    </option>\n                  ))}\n                </select>\n              </div>\n              \n              <div className=\"flex gap-3\">\n                <button\n                  onClick={() => {\n                    setShowReasonDropdown(false);\n                    setPendingAction(null);\n                    setSelectedReason('');\n                  }}\n                  className=\"flex-1 px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50\"\n                >\n                  Cancel\n                </button>\n                <button\n                  onClick={handleReasonSubmit}\n                  disabled={!selectedReason}\n                  className=\"flex-1 px-4 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed\"\n                >\n                  Continue\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Confirmation Modal */}\n      <ConfirmationModal\n        isOpen={confirmAction !== null}\n        onClose={() => setConfirmAction(null)}\n        onConfirm={handleConfirmedAction}\n        title={confirmAction?.actionLabel || 'Confirm Action'}\n        message={confirmAction ? getConfirmationMessage(confirmAction.action) : ''}\n        confirmText={confirmAction?.actionLabel || 'Confirm'}\n        cancelText=\"Cancel\"\n        type={confirmAction?.action === 'removed' ? 'danger' : confirmAction?.action === 'warned' ? 'warning' : 'danger'}\n        requireTypedConfirmation={confirmAction?.action === 'warned' || confirmAction?.action === 'removed'}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":20452,"size_tokens":null},"src/app/(chrome)/admin/reports/page.js":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport GroupedReportsTable from \"@/components/admin/GroupedReportsTable\";\nimport ReportDetailsPanel from \"@/components/admin/ReportDetailsPanel\";\nimport ErrorBoundary from \"@/components/ErrorBoundary\";\n\nexport default function AdminReportsPage() {\n  return (\n    <ErrorBoundary>\n      <AdminReportsContent />\n    </ErrorBoundary>\n  );\n}\n\nfunction AdminReportsContent() {\n  const { user } = useAuth();\n  const [summaries, setSummaries] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [loadingMore, setLoadingMore] = useState(false);\n  const [hasMore, setHasMore] = useState(true);\n  const [selectedSummary, setSelectedSummary] = useState(null);\n  const [filters, setFilters] = useState({\n    targetType: 'all',\n    status: 'pending',\n    sortBy: 'reportsCount',\n    limit: 10,\n  });\n\n  const fetchGroupedReports = async (isLoadMore = false) => {\n    if (!user) return;\n\n    if (isLoadMore) {\n      setLoadingMore(true);\n    } else {\n      setLoading(true);\n    }\n    \n    try {\n      const token = await user.getIdToken();\n      \n      const params = new URLSearchParams();\n      if (filters.targetType !== 'all') params.append('targetType', filters.targetType);\n      if (filters.status !== 'all') params.append('status', filters.status);\n      params.append('sortBy', filters.sortBy);\n      params.append('sortOrder', 'desc');\n      params.append('limit', filters.limit.toString());\n      \n      const response = await fetch(`/api/admin/reports/grouped?${params.toString()}`, {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to fetch grouped reports');\n      }\n\n      const data = await response.json();\n      const newSummaries = data.data || [];\n      setSummaries(newSummaries);\n      setHasMore(newSummaries.length === filters.limit);\n    } catch (error) {\n      console.error('Error fetching grouped reports:', error);\n    } finally {\n      setLoading(false);\n      setLoadingMore(false);\n    }\n  };\n\n  const handleLoadMore = () => {\n    setFilters(prev => ({ ...prev, limit: prev.limit + 10 }));\n    setTimeout(() => fetchGroupedReports(true), 0);\n  };\n\n  const handleSelectSummary = (summary) => {\n    setSelectedSummary(summary);\n  };\n\n  const handleClosePanel = () => {\n    setSelectedSummary(null);\n  };\n\n  const handleActionComplete = () => {\n    setSelectedSummary(null);\n    fetchGroupedReports(); // Refresh to show next batch\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <h2 className=\"text-lg font-semibold text-gray-900 mb-4\">Load Reports</h2>\n        <div className=\"grid grid-cols-1 md:grid-cols-5 gap-4\">\n          <div>\n            <label htmlFor=\"type-filter\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Report Type\n            </label>\n            <select\n              id=\"type-filter\"\n              value={filters.targetType}\n              onChange={(e) => setFilters({ ...filters, targetType: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n            >\n              <option value=\"all\" className=\"text-gray-900\">All Types</option>\n              <option value=\"campaign\" className=\"text-gray-900\">Campaigns</option>\n              <option value=\"user\" className=\"text-gray-900\">Users</option>\n            </select>\n          </div>\n\n          <div>\n            <label htmlFor=\"status-filter\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Status\n            </label>\n            <select\n              id=\"status-filter\"\n              value={filters.status}\n              onChange={(e) => setFilters({ ...filters, status: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n            >\n              <option value=\"all\" className=\"text-gray-900\">All</option>\n              <option value=\"pending\" className=\"text-gray-900\">Pending</option>\n              <option value=\"resolved\" className=\"text-gray-900\">Resolved</option>\n              <option value=\"dismissed\" className=\"text-gray-900\">Dismissed</option>\n            </select>\n          </div>\n\n          <div>\n            <label htmlFor=\"sort-filter\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Sort By\n            </label>\n            <select\n              id=\"sort-filter\"\n              value={filters.sortBy}\n              onChange={(e) => setFilters({ ...filters, sortBy: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n            >\n              <option value=\"lastReportedAt\" className=\"text-gray-900\">Most Recent</option>\n              <option value=\"reportsCount\" className=\"text-gray-900\">Top Reported</option>\n              <option value=\"firstReportedAt\" className=\"text-gray-900\">Oldest Pending</option>\n            </select>\n          </div>\n\n          <div>\n            <label htmlFor=\"limit-input\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Number of Reports\n            </label>\n            <input\n              id=\"limit-input\"\n              type=\"number\"\n              min=\"1\"\n              max=\"100\"\n              value={filters.limit}\n              onChange={(e) => setFilters({ ...filters, limit: parseInt(e.target.value) || 10 })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n              placeholder=\"10\"\n            />\n          </div>\n\n          <div className=\"flex items-end\">\n            <button\n              onClick={fetchGroupedReports}\n              disabled={loading || !user}\n              className=\"w-full px-6 py-2 bg-emerald-600 text-white font-medium rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors\"\n            >\n              {loading ? (\n                <span className=\"flex items-center justify-center\">\n                  <svg className=\"animate-spin -ml-1 mr-2 h-4 w-4 text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                  </svg>\n                  Loading...\n                </span>\n              ) : (\n                'Load Reports'\n              )}\n            </button>\n          </div>\n        </div>\n        {summaries.length > 0 && (\n          <div className=\"mt-4 text-sm text-gray-600\">\n            Showing <span className=\"font-semibold\">{summaries.length}</span> report{summaries.length !== 1 ? 's' : ''}\n          </div>\n        )}\n      </div>\n\n      <GroupedReportsTable\n        summaries={summaries}\n        loading={loading}\n        onSelectSummary={handleSelectSummary}\n        onRefresh={fetchGroupedReports}\n      />\n\n      {summaries.length > 0 && hasMore && !loading && (\n        <div className=\"bg-white rounded-lg shadow p-6 text-center\">\n          <button\n            onClick={handleLoadMore}\n            disabled={loadingMore}\n            className=\"px-8 py-3 bg-emerald-600 text-white font-medium rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors\"\n          >\n            {loadingMore ? (\n              <span className=\"flex items-center justify-center\">\n                <svg className=\"animate-spin -ml-1 mr-2 h-4 w-4 text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                  <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                </svg>\n                Loading More...\n              </span>\n            ) : (\n              'Load More (10 items)'\n            )}\n          </button>\n        </div>\n      )}\n\n      {selectedSummary && (\n        <ReportDetailsPanel\n          report={selectedSummary}\n          onClose={handleClosePanel}\n          onUpdate={handleActionComplete}\n          isGrouped={true}\n        />\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":8867,"size_tokens":null},"src/app/(chrome)/create/frame/page.js":{"content":"\"use client\";\n\nimport { useState, useRef, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { useAuth } from '../../../../hooks/useAuth';\nimport { checkTransparency } from '../../../../utils/transparencyDetector';\nimport { generateSlug } from '../../../../utils/slugGenerator';\nimport { getCampaignUploadUrl } from '../../../../utils/campaignStorage';\nimport { createCampaign } from '../../../../lib/firestore';\nimport CampaignStepIndicator from '../../../../components/CampaignStepIndicator';\n\nexport default function CreateFramePage() {\n  const router = useRouter();\n  const { user, loading: authLoading } = useAuth();\n  const [step, setStep] = useState(1); // 1 = upload image, 2 = fill details\n  const [loading, setLoading] = useState(false);\n  const [errors, setErrors] = useState({});\n  const [showAuthModal, setShowAuthModal] = useState(false);\n  \n  const imageInputRef = useRef();\n\n  // Form data state\n  const [formData, setFormData] = useState({\n    campaignImage: null,\n    campaignImagePreview: '',\n    title: '',\n    description: '',\n    captionTemplate: ''\n  });\n\n  const handleInputChange = (field, value) => {\n    setFormData(prev => ({ ...prev, [field]: value }));\n    if (errors[field]) {\n      setErrors(prev => ({ ...prev, [field]: '' }));\n    }\n  };\n\n  const handleImageSelect = async (file) => {\n    if (!file) return;\n\n    // Clear previous errors\n    setErrors({});\n\n    // File size validation (5MB limit)\n    const maxSize = 5 * 1024 * 1024;\n    if (file.size > maxSize) {\n      setErrors({ campaignImage: `Image must be smaller than 5MB. Current size: ${(file.size / (1024 * 1024)).toFixed(1)}MB` });\n      return;\n    }\n\n    // File type validation - must be PNG for frames\n    if (!file.type.includes('png')) {\n      setErrors({ campaignImage: 'Frame must be a PNG image with transparency' });\n      return;\n    }\n\n    // Check transparency\n    setLoading(true);\n    try {\n      const result = await checkTransparency(file, 5);\n      \n      if (!result.hasTransparency) {\n        setErrors({ campaignImage: result.error || 'Frame must have at least 5% transparent area for photos' });\n        setLoading(false);\n        return;\n      }\n\n      // Valid frame with transparency - show preview\n      const reader = new FileReader();\n      reader.onload = (e) => {\n        setFormData(prev => ({\n          ...prev,\n          campaignImage: file,\n          campaignImagePreview: e.target.result\n        }));\n        setLoading(false);\n        // Automatically move to step 2\n        setStep(2);\n      };\n      reader.readAsDataURL(file);\n    } catch (error) {\n      console.error('Error checking transparency:', error);\n      setErrors({ campaignImage: 'Failed to validate image. Please try again.' });\n      setLoading(false);\n    }\n  };\n\n  const handleRemoveImage = () => {\n    setFormData(prev => ({\n      ...prev,\n      campaignImage: null,\n      campaignImagePreview: ''\n    }));\n    if (imageInputRef.current) {\n      imageInputRef.current.value = '';\n    }\n    setStep(1);\n    setErrors({});\n  };\n\n  const validateStep2 = () => {\n    const newErrors = {};\n\n    if (!formData.title.trim()) {\n      newErrors.title = 'Title is required';\n    } else if (formData.title.length < 3) {\n      newErrors.title = 'Title must be at least 3 characters';\n    }\n\n    setErrors(newErrors);\n    return Object.keys(newErrors).length === 0;\n  };\n\n  const handlePublish = async () => {\n    // Check if user is authenticated\n    if (!user) {\n      setShowAuthModal(true);\n      return;\n    }\n\n    // Validate form\n    if (!validateStep2()) return;\n\n    setLoading(true);\n    try {\n      // Generate slug\n      const slug = generateSlug(formData.title);\n      const campaignId = slug; // Use slug as campaign ID\n\n      // Get auth token\n      const token = await user.getIdToken();\n\n      // Get upload URL from API\n      const { uploadUrl, path } = await getCampaignUploadUrl(campaignId, formData.campaignImage.size, formData.campaignImage.type, token);\n\n      // Upload image to Supabase\n      await fetch(uploadUrl, {\n        method: 'PUT',\n        body: formData.campaignImage,\n        headers: {\n          'Content-Type': 'image/png'\n        }\n      });\n\n      // Build image URL\n      const imageUrl = `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/uploads/${path}`;\n\n      // Create campaign in Firestore\n      const campaignData = {\n        type: 'frame',\n        title: formData.title.trim(),\n        description: formData.description.trim(),\n        slug: slug,\n        storagePath: path,\n        imageUrl: imageUrl,\n        captionTemplate: formData.captionTemplate.trim()\n      };\n\n      const result = await createCampaign(campaignData, user.uid);\n\n      if (result.success) {\n        router.push(`/campaign/${slug}`);\n      } else {\n        throw new Error(result.error || 'Failed to create campaign');\n      }\n    } catch (error) {\n      console.error('Error creating campaign:', error);\n      setErrors({ general: 'Failed to create campaign. Please try again.' });\n      setLoading(false);\n    }\n  };\n\n  const handleAuthModalClose = () => {\n    setShowAuthModal(false);\n  };\n\n  const handleSignIn = () => {\n    // Redirect to sign in page\n    router.push('/signin?redirect=/create/frame');\n  };\n\n  return (\n    <div className=\"min-h-screen bg-white\">\n      <div className=\"min-h-screen flex\">\n        {/* Main Content */}\n        <div className=\"flex-1 w-full flex flex-col justify-center py-8 px-4 sm:px-6 lg:px-16 xl:px-20 pt-20\">\n          <div className=\"mx-auto w-full max-w-4xl\">\n            {/* Header */}\n            <div className=\"text-center bg-yellow-400 px-6 py-6 rounded-t-xl\">\n              <h1 className=\"text-2xl sm:text-3xl font-bold text-emerald-700\">Create Frame Campaign</h1>\n              <p className=\"text-base sm:text-lg text-gray-700 mt-2\">\n                Upload a PNG frame with transparent areas for photos\n              </p>\n            </div>\n\n            {/* Progress Indicator */}\n            <div className=\"bg-yellow-400 px-6 pb-4\">\n              <CampaignStepIndicator\n                currentStep={step}\n                totalSteps={2}\n                labels={['Upload Image', 'Campaign Details']}\n              />\n            </div>\n\n            {/* Content Card */}\n            <div className=\"bg-white rounded-b-xl border border-t-0 border-gray-200 px-6 py-8 shadow-sm\">\n              {errors.general && (\n                <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm text-center\">\n                  {errors.general}\n                </div>\n              )}\n\n              {/* Step 1: Upload Image */}\n              {step === 1 && (\n                <div className=\"space-y-6\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                      Frame Image *\n                    </label>\n                    <div className=\"space-y-3\">\n                      {/* Upload Area */}\n                      <div \n                        onClick={() => imageInputRef.current?.click()}\n                        className=\"w-full h-80 max-w-md mx-auto rounded-lg overflow-hidden border-2 border-dashed border-gray-300 hover:border-emerald-500 cursor-pointer transition-colors\"\n                      >\n                        <div className=\"w-full h-full bg-gray-50 flex flex-col items-center justify-center p-6\">\n                          <svg className=\"w-16 h-16 text-gray-400 mb-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12\" />\n                          </svg>\n                          <p className=\"text-gray-600 font-medium mb-1\">Click to upload frame</p>\n                          <p className=\"text-gray-500 text-sm\">PNG with transparency required</p>\n                          <p className=\"text-gray-400 text-xs mt-2\">Max 5MB  Min 5% transparency</p>\n                        </div>\n                      </div>\n                      <input\n                        type=\"file\"\n                        ref={imageInputRef}\n                        onChange={(e) => handleImageSelect(e.target.files[0])}\n                        accept=\"image/png\"\n                        className=\"hidden\"\n                      />\n                      {errors.campaignImage && (\n                        <p className=\"text-red-600 text-sm text-center\">{errors.campaignImage}</p>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Info Box */}\n                  <div className=\"bg-emerald-50 border border-emerald-200 rounded-lg p-4\">\n                    <h3 className=\"font-semibold text-emerald-900 mb-2 flex items-center gap-2\">\n                      <svg className=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                        <path fillRule=\"evenodd\" d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z\" clipRule=\"evenodd\" />\n                      </svg>\n                      What is a frame?\n                    </h3>\n                    <ul className=\"space-y-1 text-sm text-emerald-800\">\n                      <li className=\"flex items-start gap-2\">\n                        <span className=\"text-emerald-600 mt-1\"></span>\n                        <span>PNG image with transparent areas where visitor photos will appear</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <span className=\"text-emerald-600 mt-1\"></span>\n                        <span>Visitor photo appears behind the frame</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <span className=\"text-emerald-600 mt-1\"></span>\n                        <span>Square images recommended but all sizes accepted (no cropping)</span>\n                      </li>\n                    </ul>\n                  </div>\n                </div>\n              )}\n\n              {/* Step 2: Fill Details */}\n              {step === 2 && (\n                <div className=\"space-y-6\">\n                  {/* Image Preview */}\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                      Frame Preview\n                    </label>\n                    <div className=\"w-full h-80 max-w-md mx-auto rounded-lg overflow-hidden border-2 border-gray-200 bg-gray-50 flex items-center justify-center\">\n                      {formData.campaignImagePreview && (\n                        <img\n                          src={formData.campaignImagePreview}\n                          alt=\"Frame preview\"\n                          className=\"max-w-full max-h-full object-contain\"\n                        />\n                      )}\n                    </div>\n                    <div className=\"flex justify-center mt-3\">\n                      <button\n                        type=\"button\"\n                        onClick={handleRemoveImage}\n                        className=\"btn-base btn-secondary px-3 py-1.5 text-sm\"\n                      >\n                        Change Image\n                      </button>\n                    </div>\n                  </div>\n\n                  {/* Title */}\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                      Campaign Title *\n                    </label>\n                    <input\n                      type=\"text\"\n                      value={formData.title}\n                      onChange={(e) => handleInputChange('title', e.target.value)}\n                      placeholder=\"e.g., Save Earth 2025\"\n                      className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all text-gray-900\"\n                    />\n                    {errors.title && (\n                      <p className=\"text-red-600 text-sm mt-1\">{errors.title}</p>\n                    )}\n                  </div>\n\n                  {/* Description */}\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                      Description (optional)\n                    </label>\n                    <textarea\n                      value={formData.description}\n                      onChange={(e) => handleInputChange('description', e.target.value)}\n                      placeholder=\"Describe your campaign...\"\n                      rows={3}\n                      className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all resize-none text-gray-900\"\n                    />\n                  </div>\n\n                  {/* Caption Template */}\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                      Share Caption Template (optional)\n                    </label>\n                    <textarea\n                      value={formData.captionTemplate}\n                      onChange={(e) => handleInputChange('captionTemplate', e.target.value)}\n                      placeholder=\"e.g., Join me in supporting Save Earth 2025! \"\n                      rows={2}\n                      className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all resize-none text-gray-900\"\n                    />\n                    <p className=\"text-gray-500 text-xs mt-1\">This text will be pre-filled when visitors share their photos</p>\n                  </div>\n\n                  {/* Action Buttons */}\n                  <div className=\"flex gap-3 pt-4\">\n                    <button\n                      type=\"button\"\n                      onClick={() => setStep(1)}\n                      className=\"btn-base btn-secondary flex-1 py-3\"\n                      disabled={loading}\n                    >\n                      Back\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handlePublish}\n                      className=\"btn-base btn-primary flex-1 py-3\"\n                      disabled={loading}\n                    >\n                      {loading ? 'Publishing...' : 'Publish Campaign'}\n                    </button>\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Auth Modal */}\n      {showAuthModal && (\n        <>\n          <div \n            className=\"fixed inset-0 bg-black/50 z-50\"\n            onClick={handleAuthModalClose}\n          />\n          <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\n            <div \n              className=\"bg-white rounded-xl max-w-md w-full p-6 shadow-lg\"\n              onClick={(e) => e.stopPropagation()}\n            >\n              <h3 className=\"text-xl font-bold text-gray-900 mb-2\">Sign in to publish</h3>\n              <p className=\"text-gray-600 mb-6\">\n                You need to sign in to publish your campaign. Your work will be saved.\n              </p>\n              <div className=\"flex gap-3\">\n                <button\n                  onClick={handleAuthModalClose}\n                  className=\"btn-base btn-secondary flex-1\"\n                >\n                  Go Back\n                </button>\n                <button\n                  onClick={handleSignIn}\n                  className=\"btn-base btn-primary flex-1\"\n                >\n                  Sign In\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":16010,"size_tokens":null},"CAMPAIGN_SYSTEM.md":{"content":"# Campaign System - Implementation Guide\n\n**Last Updated:** October 08, 2025  \n**Status:** Phase 1 Complete | Phase 2 Pending | Moderation System Updated\n\n---\n\n## Overview\n\nTwibbonize supports two campaign types:\n- **Frames** - Images with transparency where visitor photos go underneath\n- **Backgrounds** - Solid images where visitor photos go on top\n\n**Key Features:**\n- Two-step campaign creation (upload  metadata)\n- 3-page visitor flow (upload  adjust  result)\n- Canvas-based image composition with adjustments\n- Download tracking and public analytics\n- Delayed authentication (publish-time only)\n\n---\n\n## Data Schema\n\n### Campaign Collection (Firestore: `campaigns`)\n **Status: Implemented** |  **Updated: Moderation Fields (Oct 2025)**\n\n```javascript\n{\n  // Core fields (IMMUTABLE after publish)\n  id: \"auto-generated-id\",\n  type: \"frame\" | \"background\",\n  slug: \"unique-url-slug\",              // Generated from title + random suffix\n  imageUrl: \"campaigns/{userId}/{campaignId}.png\",\n  creatorId: \"firebase-user-id\",\n  \n  // Metadata (editable for 7 days OR until 10 supporters)\n  title: \"Campaign Title\",\n  description: \"Optional description\",\n  captionTemplate: \"Share text template\",\n  \n  // Counters\n  supportersCount: 0,                    // Total downloads (increments on each download)\n  reportsCount: 0,                       // Increments with each report\n  \n  // Moderation Status (UPDATED)\n  moderationStatus: \"active\" | \"under-review\" | \"under-review-hidden\" | \"removed-temporary\" | \"removed-permanent\",\n  hiddenAt: timestamp,                   // When auto-hidden (3+ reports)\n  removedAt: timestamp,                  // When admin removed temporarily\n  removalReason: string,                 // Admin's reason for removal\n  appealDeadline: timestamp,             // 30 days from removal\n  appealCount: number,                   // How many times appealed (max 1)\n  \n  // Timestamps\n  createdAt: timestamp,                  // Publish time\n  updatedAt: timestamp,                  // Last edit\n  firstUsedAt: timestamp                 // First download (optional)\n}\n```\n\n**Editing Policy:**\n- Editable fields: title, description, captionTemplate\n- Edit window: 7 days from publish AND less than 10 supporters\n- After limit: Campaign permanently locked\n\n**Moderation Policy (NEW):**\n- **3+ reports**  Auto-hide from public (`under-review-hidden`)\n- **Admin dismiss**  Restore to `active`, reset reportsCount to 0\n- **Admin remove**  `removed-temporary` for 30 days with appeal option\n- **After 30 days**  Auto-delete permanently if no appeal\n- **Second removal**  `removed-permanent` (no recovery)\n\n**Deletion Policy:**\n- Only creator can delete (for `active` campaigns)\n- Admin can remove (temporary or permanent)\n- Temporary removal allows 30-day appeal\n- Permanent deletion removes Firestore doc + Supabase image\n\n---\n\n### Report Summary Collection (Firestore: `reportSummary`)\n **Status: Implemented** |  **Updated: Reason Counts Optimization (Oct 14, 2025)**\n\n```javascript\n{\n  targetId: string,                      // campaignId or userId\n  targetType: \"campaign\" | \"user\",\n  reportsCount: number,                  // Total active reports\n  \n  // NEW: Reason breakdown with counts\n  reasonCounts: {\n    spam: 8,                             // Example: 8 spam reports\n    inappropriate: 5,                    // 5 inappropriate reports\n    copyright: 2,                        // 2 copyright reports\n    ...                                  // Other reasons with counts\n  },\n  \n  // Timestamps\n  firstReportedAt: timestamp,            // First report time\n  lastReportedAt: timestamp,             // Most recent report time\n  createdAt: timestamp,\n  updatedAt: timestamp,\n  resolvedAt: timestamp,                 // When admin took action\n  \n  // Status\n  status: \"pending\" | \"resolved\" | \"dismissed\",\n  \n  // Cached display data (for quick access)\n  // For campaigns:\n  campaignTitle?: string,\n  campaignImage?: string,\n  campaignSlug?: string,\n  campaignType?: string,\n  creatorId?: string,\n  moderationStatus?: string,\n  \n  // For users:\n  username?: string,\n  displayName?: string,\n  profileImage?: string,\n  accountStatus?: string,\n}\n```\n\n**Report Reasons by Type:**\n\n**Campaign Reports:**\n- `inappropriate` - Inappropriate Content\n- `spam` - Spam\n- `copyright` - Copyright Violation\n- `other` - Other\n\n**Profile Reports:**\n- `inappropriate_avatar` - Inappropriate Profile Picture\n- `offensive_username` - Offensive Username\n- `spam_bio` - Spam in Bio/Description\n- `impersonation` - Impersonation\n- `other` - Other\n\n**Key Features:**\n- No individual report documents - all tracked in aggregated summary\n- Reason counts show breakdown of why content was reported\n- Admin sees percentage distribution (e.g., \"80% spam, 20% inappropriate\")\n- Resets to 0 when admin takes action (dismiss/warn/remove)\n- 95% reduction in Firestore reads/writes for admin actions\n\n---\n\n### Warnings Collection (Firestore: `warnings`)\n **Status: Implemented** (October 09, 2025)\n\n```javascript\n{\n  userId: string,                        // User who received warning\n  targetType: \"campaign\" | \"profile\",\n  targetId: string,                      // campaignId or userId\n  reportId: string,                      // Related report\n  reason: string,\n  issuedBy: string,                      // adminId\n  issuedAt: timestamp,\n  acknowledged: boolean,                 // User read the warning\n}\n```\n\n**Purpose:**\n- Track warning history for admin review\n- Does NOT auto-ban users\n- Admin manually decides actions based on warning count\n- Visible in admin user details panel\n\n---\n\n### In-App Notifications System\n **Status: Fully Implemented** (October 2025)\n\n**Notification Document (Firestore: `users/{userId}/notifications/{notificationId}`):**\n```javascript\n{\n  id: string,                            // Auto-generated notification ID\n  type: \"warning\" | \"campaign_removed\" | \"campaign_under_review\" | \"profile_under_review\" | \"account_banned\" | \"appeal_deadline\",\n  title: string,                         // Notification title\n  message: string,                       // Notification message\n  actionUrl: string,                     // Deep link to take action\n  actionLabel: string,                   // \"Appeal Removal\", \"View Campaign\", etc.\n  \n  // Optional metadata\n  campaignId?: string,\n  reportId?: string,\n  appealDeadline?: timestamp,            // ISO timestamp\n  \n  // Status tracking\n  read: boolean,                         // User has read the notification\n  createdAt: timestamp,                  // When notification was sent\n}\n```\n\n**Purpose:**\n- In-app notifications delivered via Firestore real-time listeners\n- Notify users about moderation actions instantly\n- No browser permissions required\n- Notifications appear in NotificationBell and inbox at `/profile/notifications`\n- Users can mark as read, delete, and filter by type\n- Toast notifications show latest unread notification automatically\n\n---\n\n### Appeals Collection (Firestore: `appeals`)\n **Status: Fully Implemented** (October 24, 2025)\n\n```javascript\n{\n  userId: string,\n  type: \"campaign\" | \"account\",\n  targetId: string,                      // campaignId or userId\n  reason: string,                        // User's explanation\n  status: \"pending\" | \"approved\" | \"rejected\",\n  submittedAt: timestamp,\n  reviewedAt?: timestamp,\n  reviewedBy?: string,                   // adminId\n  adminNotes?: string,\n}\n```\n\n**Purpose:**\n- 30-day appeal window for removed content/banned accounts\n- User submission at `/profile/appeals`\n- Admin reviews at `/admin/appeals`\n- Approve  Restore content/account to `active` status\n- Reject  Upgrade to `removed-permanent` or `banned-permanent`\n\n---\n\n### User Schema Updates\n **Status: Implemented** (October 09, 2025)\n\n**NEW moderation fields:**\n```javascript\n{\n  // Existing fields...\n  \n  // Profile Moderation\n  moderationStatus: \"active\" | \"under-review\" | \"under-review-hidden\",\n  reportsCount: number,\n  hiddenAt?: timestamp,\n  \n  // Account Status\n  accountStatus: \"active\" | \"banned-temporary\" | \"banned-permanent\",\n  bannedAt?: timestamp,\n  banReason?: string,\n  appealDeadline?: timestamp,\n}\n```\n\n**Profile Moderation Rules:**\n- **10+ reports**  Auto-hide from public (`under-review-hidden`)\n- **Admin dismiss**  Restore to `active`, reset reportsCount to 0\n- **Admin ban**  `banned-temporary` for 30 days with appeal\n- **Permanent ban**  Delete all data (profile + campaigns)\n\n---\n\n## Moderation Workflows (NEW)\n\n### Campaign Moderation Workflow\n\n1. **Report Received**  `moderationStatus: \"under-review\"` (still public)\n2. **3+ Reports**  `moderationStatus: \"under-review-hidden\"` (auto-hide)\n   - Send notification to creator\n   - Campaign invisible to public\n3. **Admin Actions:**\n   - **Dismiss:** Reset reportsCount to 0, restore to `active`, unhide\n   - **Warn:** Create warning record, send notification\n   - **Remove:** `removed-temporary` + 30-day appeal deadline\n4. **Appeal Process:**\n   - Creator appeals within 30 days\n   - Admin reviews in `/admin/appeals`\n   - Approve  Restore campaign\n   - Reject  `removed-permanent` (delete all data)\n5. **No Appeal:** After 30 days  Auto-delete permanently\n\n### Profile Moderation Workflow\n\n1. **Report Received**  Track in reportsCount\n2. **10+ Reports**  `moderationStatus: \"under-review-hidden\"` (auto-hide)\n   - Send notification to user\n   - Profile invisible to public\n3. **Admin Actions:**\n   - **Dismiss:** Reset reportsCount to 0, restore to `active`, unhide\n   - **Warn:** Create warning record, send notification\n   - **Ban Account:** `banned-temporary` + 30-day appeal deadline\n4. **Ban Message:**\n   - User cannot login\n   - Shows ban reason + appeal deadline\n   - \"Appeal\" button available\n5. **Appeal Process:**\n   - User appeals within 30 days\n   - Admin reviews in `/admin/appeals`\n   - Approve  Restore account\n   - Reject  `banned-permanent` + delete all data (profile + campaigns)\n6. **No Appeal:** After 30 days  Permanent ban + delete data\n\n---\n\n## User Flows\n\n### Creator Flow - Campaign Creation\n **Status: Implemented**\n\n**Route:** `/create` (opens modal)  `/create/frame` or `/create/background`\n\n**Steps:**\n1. Click \"Create Campaign\"  Modal opens with type selection\n2. Select Frame or Background\n3. **Step 1:** Upload image\n   - Frame: PNG with 5% transparency (validated automatically)\n   - Background: PNG/JPG/WEBP (any format)\n   - Max 5MB file size\n4. **Step 2:** Fill metadata\n   - Title (required)\n   - Description (optional)\n   - Caption template (optional)\n5. Click \"Publish\"\n   - If not logged in  Auth modal appears\n   - Form data preserved during auth\n6. Save to Firestore + Upload to Supabase\n7. Redirect to `/campaign/[slug]`\n\n**Files:**\n- `CreateCampaignModal.js` - Type selection modal\n- `/create/frame/page.js` - Frame upload workflow\n- `/create/background/page.js` - Background upload workflow\n\n---\n\n### Visitor Flow - 3-Page Campaign Usage\n **Status: Implemented (October 4, 2025)**\n\n**Architecture:** Upload  Adjust  Result with session persistence\n\n#### Page 1: Upload (`/campaign/[slug]`)\n- View campaign preview and details\n- See creator info and supporter count\n- Upload photo (10MB max, image files only)\n- Auto-redirect to `/adjust` after upload\n\n**Features:**\n- Campaign details (title, description, creator)\n- \"Choose Your Photo\" button\n- Report campaign button\n- Ad placeholder slots\n\n#### Page 2: Adjust (`/campaign/[slug]/adjust`)\n- Canvas preview of composed image\n- Adjustment controls:\n  - Zoom slider (0.5x - 3.0x)\n  - Drag to reposition\n  - Rotate (-45 to +45)\n  - \"Fit to Frame\" and \"Reset\" buttons\n- Change/remove photo options\n- Download button\n- Auto-redirect to `/result` after download\n\n**Route Guard:** Requires photo uploaded (redirects to Page 1 if missing)\n\n#### Page 3: Result (`/campaign/[slug]/result`)\n- Display final composed image\n- Social sharing buttons (Twitter, Facebook, WhatsApp)\n- \"Re-Download\" option\n- \"Start Over\" clears session and returns to Page 1\n-  \"Post to Gallery\" (Phase 2 - deferred)\n\n**Route Guard:** Requires download complete (redirects appropriately if not)\n\n**Session Management:**\n- Context: `CampaignSessionContext`\n- Storage: sessionStorage (24h expiry)\n- Data: photo preview (base64), adjustments, campaign/creator data\n- Cleanup: Auto-expires or manual \"Start Over\"\n\n**Files:**\n- `CampaignSessionContext.js` - Session state management\n- `campaignRouteGuards.js` - Navigation guards\n- `/campaign/[slug]/page.js` - Page 1\n- `/campaign/[slug]/adjust/page.js` - Page 2\n- `/campaign/[slug]/result/page.js` - Page 3\n- `/api/campaigns/track-download/route.js` - Download tracking\n\n---\n\n### Campaign Gallery & Discovery\n **Status: Implemented**\n\n#### Unified Gallery (`/campaigns`)\nBrowse all campaigns with filters:\n- Type: All / Frames / Backgrounds\n- Time: 24h / 7d / 30d / All time\n- Sort: Most recent / Most popular\n- Grid layout with thumbnails\n\n#### Top Creators (`/creators`)\nLeaderboard ranked by total supports:\n- Filter by country and time period\n- Shows: Avatar, name, campaign count, total supports\n- Links to creator profiles\n\n**Files:**\n- `/campaigns/page.js` - Gallery page\n- `/creators/page.js` - Leaderboard page\n- `FilterModal.js` - Shared filter component\n\n---\n\n## Technical Implementation\n\n### Slug Generation\n **Status: Implemented (`slugGenerator.js`)**\n\n**Algorithm:**\n1. Lowercase and sanitize title\n2. Replace spaces with hyphens\n3. Remove special characters\n4. Limit to 50 characters\n5. Append 4-character random suffix (base36)\n\n```javascript\ngenerateSlug(\"Save Earth 2025\")  \"save-earth-2025-k8m3\"\n```\n\n**No uniqueness check needed** - Collision probability: ~1 in 1.7M\n\n---\n\n### Transparency Detection\n **Status: Implemented (`transparencyDetector.js`)**\n\n**Algorithm:**\n1. Validate PNG format (only format with alpha channel)\n2. Load image into Canvas\n3. Analyze RGBA pixel data\n4. Count pixels with alpha < 255\n5. Calculate transparency percentage\n6. Validate 5% threshold\n\n```javascript\nconst result = await checkTransparency(file);\nif (result.hasTransparency) {\n  // Valid frame - proceed\n} else {\n  // Show error: result.error\n}\n```\n\n---\n\n### Image Composition\n **Status: Implemented (`imageComposition.js`)**\n\n**Canvas API-based composition with real-time adjustments:**\n\n```javascript\n// Frame: User photo UNDER frame\ndrawUserPhoto(ctx, userPhoto, adjustments);\nctx.drawImage(frameImage, 0, 0);\n\n// Background: User photo ON TOP\nctx.drawImage(backgroundImage, 0, 0);\ndrawUserPhoto(ctx, userPhoto, adjustments);\n```\n\n**Features:**\n- Load images from File or URL\n- Apply scale, position, rotation\n- Real-time preview updates\n- Export to PNG/JPEG blob\n- Mobile touch support (pointer events)\n\n**Functions:**\n- `composeImages()` - Create final composition\n- `updatePreview()` - Real-time canvas updates\n- `calculateFitAdjustments()` - Auto-fit photo\n- `downloadCanvas()` - Export as file\n\n---\n\n### Image Optimization\n **Status: Implemented (October 05, 2025) - `imageTransform.js`**\n\n**ImageKit.io CDN integration for bandwidth reduction:**\n\nAutomatically serves optimized WebP images with appropriate sizes for different use cases through ImageKit.io CDN, reducing bandwidth costs by 89%. Supabase Storage is used only for full-size canvas operations where transparency must be preserved.\n\n**Transformation Presets:**\n\n```javascript\n// Campaign Preview (800px width WebP, quality 80) - ~400 KB\n// Aspect ratio preserved - works with any image size\ngetCampaignPreview(imagePath)    // Gallery grids, campaign view pages, campaign cards\n\n// Full-size (original PNG) - ~800 KB - 2.5 MB\ngetCampaignCanvas(imagePath)     // Canvas operations only\n\n// Avatars (150x150 WebP, quality 80) - ~100 KB\n// Square crop from center\ngetProfileAvatar(imagePath)      // User profile pictures\n\n// Banners (800x200 WebP, quality 85) - ~150 KB\n// Aspect ratio crop\ngetProfileBanner(imagePath)      // Profile page headers\n```\n\n**Implementation:**\n- ImageKit.io CDN handles transformations (WebP conversion, resizing, quality optimization)\n- Campaign images preserve aspect ratio (width-based scaling)\n- Profile avatars and banners use fixed dimensions (center crop)\n- Supabase Storage provides original images for canvas operations (transparency required)\n- Leverages ImageKit.io global CDN for edge caching and fast delivery\n- Compatible with Firebase photo URLs (pass-through, no transformation)\n\n**Cost Impact:**\n- Before: $520/month at 100k visitors\n- After: $56/month at 100k visitors\n- Savings: $464/month (89% reduction)\n\n---\n\n### Storage Structure\n **Status: Implemented**\n\n**Supabase Storage:**\n- Bucket: `uploads`\n- Path: `campaigns/{userId}/{campaignId}.png`\n\n**Benefits:**\n- Predictable paths for deletion\n- One image per campaign\n- Easy batch operations by user\n- Clear ownership structure\n\n**API Endpoints:**\n- `/api/storage/campaign-upload-url` - Get signed upload URL\n- `/api/storage/delete` - Delete campaign image\n- `/api/storage/signed-url` - Get temporary download URL\n\n**Files:**\n- `campaignStorage.js` - Path utilities\n- `campaign-upload-url/route.js` - Upload endpoint\n\n---\n\n### Download Tracking\n **Status: Implemented**\n\n**Server-side tracking (Firestore transaction):**\n1. Increment campaign `supportersCount`\n2. Set `firstUsedAt` on first download\n3. Create download record in subcollection (with timestamp)\n4. Update `updatedAt` timestamp\n\n**Cost-optimized approach:**\n- No user tracking in campaign document\n- Simple counter increment (prevents document bloat)\n- Scales to unlimited downloads\n\n---\n\n## Route Guards & Navigation\n\n **Status: Implemented (`campaignRouteGuards.js`)**\n\n**Guards:**\n```javascript\n// Adjust page: Requires photo uploaded\nrequirePhotoUpload(session, router, slug)\n\n// Result page: Requires download complete\nrequireDownloadComplete(session, router, slug)\n\n// Check session expiry (24h)\nisSessionExpired(timestamp)\n```\n\n**Flow Enforcement:**\n- Direct URL access to `/adjust`  Redirects to `/upload`\n- Direct URL access to `/result`  Redirects to appropriate page\n- Expired session  Clears data and redirects to `/upload`\n\n---\n\n## Firestore Functions\n\n### Campaign Functions\n **Status: Implemented (`firestore.js`)**\n\n- `createCampaign(campaignData, userId)` - Publish new campaign\n- `getCampaignBySlug(slug)` - Fetch campaign with creator info\n- `getUserCampaigns(userId, limit)` - Get user's campaigns\n- `getAllCampaigns(filters)` - Gallery with filters\n- `updateCampaign(campaignId, updates, userId)` - Edit metadata\n- `deleteCampaign(campaignId, userId)` - Delete campaign + image\n- `trackCampaignUsage(campaignId)` - Increment supporters (deprecated, use API)\n\n### Report Functions\n **Status: Implemented (`firestore.js`)**\n\n- `createReport(reportData)` - Submit report (anonymous allowed)\n- `getReports(filterOptions)` - Admin: fetch all reports\n- `getCampaignReports(campaignId)` - Get reports for campaign\n- `updateReportStatus(reportId, statusData)` - Admin: review report\n\n### Creator Functions\n **Status: Implemented (`firestore.js`)**\n\n- `getTopCreators(filters)` - Leaderboard by supports\n\n---\n\n## Security Rules\n\n### Campaign Creation\n```javascript\n// Firestore Rules\nmatch /campaigns/{campaignId} {\n  allow create: if request.auth != null\n    && request.resource.data.creatorId == request.auth.uid\n    && request.resource.data.type in ['frame', 'background']\n    && request.resource.data.slug is string\n    && request.resource.data.title is string;\n    \n  allow update: if request.auth.uid == resource.data.creatorId\n    && onlyUpdatingFields(['title', 'description', 'captionTemplate', 'updatedAt']);\n    \n  allow delete: if request.auth.uid == resource.data.creatorId;\n}\n```\n\n### Report Submission\n```javascript\nmatch /reports/{reportId} {\n  allow create: if request.resource.data.reason in ['inappropriate', 'spam', 'copyright', 'other']\n    && request.resource.data.campaignId is string;\n}\n```\n\n---\n\n## Mobile Optimization\n\n### Touch Interactions (Adjust Page)\n **Status: Implemented**\n\n**Problem:** Blue highlight overlay on mobile touch\n\n**Solution:**\n```css\n.canvas-container {\n  touch-action: none;\n  user-select: none;\n  -webkit-user-select: none;\n}\n```\n\n```javascript\n// Use pointer events (unified mouse/touch)\ncanvas.addEventListener('pointerdown', handleDragStart);\ncanvas.addEventListener('pointermove', handleDragMove);\ncanvas.addEventListener('pointerup', handleDragEnd);\n```\n\n---\n\n## Implementation Status\n\n###  Phase 1: Complete (October 4, 2025)\n\n**Core Campaign System:**\n- [x] CreateCampaignModal (type selection)\n- [x] Frame upload with transparency detection\n- [x] Background upload (multi-format)\n- [x] Slug generation\n- [x] Campaign storage (Supabase)\n- [x] Campaign metadata (Firestore)\n\n**3-Page Visitor Flow:**\n- [x] Page 1: Upload page\n- [x] Page 2: Adjust page (canvas + controls)\n- [x] Page 3: Result page (share + download)\n- [x] Session management (Context + sessionStorage)\n- [x] Route guards\n- [x] Download tracking API\n\n**Discovery:**\n- [x] Campaigns gallery with filters\n- [x] Top creators leaderboard\n- [x] Report system (backend ready)\n\n**Utilities:**\n- [x] Image composition (Canvas API)\n- [x] Transparency detector\n- [x] Slug generator\n- [x] Campaign storage helpers\n\n---\n\n###  Phase 2: Admin Dashboard Complete (October 8, 2025)\n\n**Admin Dashboard - COMPLETED:**\n- [x] Admin role field in user profiles\n- [x] Admin middleware protection (adminAuth.js)\n- [x] Report management UI (table + filters + details panel)\n- [x] Campaign moderation UI (grid + actions + status updates)\n- [x] User management UI (search + role assignment + ban/unban)\n- [x] Platform analytics dashboard (metrics + aggregation queries)\n- [x] Admin utilities (helpers + validation + action button component)\n\n**Enhanced Features - PENDING (Future):**\n- [ ] User-submitted gallery posts (\"Post to Twibbonize\")\n- [ ] Campaign edit UI (7-day / 10-supporter window)\n- [ ] Campaign deletion UI with confirmation\n- [ ] Privacy status toggle (public/private)\n- [ ] Background removal for visitors\n- [ ] Campaign external link field\n- [ ] In-app frame creator/editor\n\n**Analytics & Ads - PENDING (Future):**\n- [ ] Event tracking (upload, download, share)\n- [ ] Drop-off analysis\n- [ ] AdSense integration\n- [ ] A/B testing framework\n\n---\n\n## Admin Dashboard System (Phase 2)\n\n### Overview\n**Status:**  Completed (October 8, 2025)\n\nThe admin dashboard provides platform moderators with tools to manage reports, campaigns, users, and monitor platform health. Access is restricted to users with `role: \"admin\"` in their profile.\n\n**All features fully implemented and functional.**\n\n---\n\n### Features\n\n#### 1. Reports Management (`/admin/reports`)\n**Purpose:** Review and moderate user-submitted reports\n\n**Functionality:**\n- View all reports with filters (status, reason, date)\n- Quick campaign preview (thumbnail + metadata)\n- One-click actions: Dismiss, Remove campaign, Warn creator\n- Bulk operations for multiple reports\n- Filter by: pending, reviewed, resolved, dismissed\n- Search by campaign slug or reporter ID\n\n**Layout:**\n- Table view with pagination (20 per page)\n- Columns: Report ID, Campaign, Reason, Status, Created, Actions\n- Side panel: Full report details + campaign preview\n\n---\n\n#### 2. Campaign Moderation (`/admin/campaigns`)\n**Purpose:** Manage flagged and active campaigns\n\n**Functionality:**\n- View all campaigns with moderation status filter\n- Quick actions: Remove, Under Review, Restore\n- View campaign reports (inline)\n- Edit campaign metadata (admin override)\n- Delete campaigns (permanent + image cleanup)\n- Filter by: active, under-review, removed\n- Sort by: reports count, creation date, supporters\n\n**Layout:**\n- Grid view with status badges\n- Card: Thumbnail, title, creator, supporters, reports count\n- Modal: Full campaign details + all reports\n\n---\n\n#### 3. User Management (`/admin/users`)\n**Purpose:** Manage user accounts and roles\n\n**Functionality:**\n- View all users with search\n- Assign/revoke admin role\n- View user stats (campaigns created, reports filed)\n- Ban/unban users (prevents login)\n- View user's campaigns\n- Filter by: all, admins, banned\n\n**Layout:**\n- Table view with pagination\n- Columns: Avatar, Name, Email, Role, Campaigns, Supports, Actions\n- Modal: User details + activity history\n\n---\n\n#### 4. Platform Analytics (`/admin/analytics`)\n**Purpose:** Monitor platform metrics and health\n\n**Functionality:**\n- Total campaigns (active, removed, under-review)\n- Total users (creators, supporters)\n- Reports statistics (pending, resolved rate)\n- Daily/weekly/monthly trends\n- Top creators leaderboard\n- Most reported campaigns\n\n**Layout:**\n- Dashboard with metric cards\n- Charts: Line graphs for trends, bar charts for top items\n- Date range selector (7d, 30d, 90d, all time)\n\n---\n\n### Security & Access Control\n\n#### Admin Role Implementation\n\n**1. User Schema Update (`src/lib/firestore.js`):**\n```javascript\n// User profile schema\n{\n  uid: string,\n  email: string,\n  displayName: string,\n  username: string,\n  role: \"admin\" | \"user\",  // NEW FIELD (default: \"user\")\n  // ... other fields\n}\n```\n\n**2. Admin Assignment Function:**\n```javascript\n// firestore.js\nexport async function setUserRole(userId, role, adminId) {\n  // Verify adminId is admin\n  // Update user's role field\n  // Log action\n}\n```\n\n**3. Firestore Security Rules:**\n```javascript\n// firestore.rules\nmatch /users/{userId} {\n  allow update: if request.auth != null\n    && request.auth.uid == userId\n    && !request.resource.data.diff(resource.data).hasAny(['role']);\n    \n  // Only admins can update roles (enforced in app layer)\n}\n```\n\n#### Middleware Protection\n\n**Admin Middleware (`src/middleware/adminAuth.js`):**\n```javascript\nexport async function requireAdmin(req) {\n  const token = req.headers.authorization;\n  const decodedToken = await verifyIdToken(token);\n  const user = await getUserProfile(decodedToken.uid);\n  \n  if (user.role !== 'admin') {\n    throw new Error('Unauthorized: Admin access required');\n  }\n  \n  return user;\n}\n```\n\n**Usage in API Routes:**\n```javascript\n// /api/admin/*/route.js\nimport { requireAdmin } from '@/middleware/adminAuth';\n\nexport async function GET(request) {\n  await requireAdmin(request); // Throws if not admin\n  // ... admin-only logic\n}\n```\n\n---\n\n### File Structure\n\n```\nsrc/\n app/\n    (chrome)/\n       admin/\n           layout.js                    # Admin layout with sidebar\n           page.js                      # Analytics dashboard (default)\n           reports/\n              page.js                  # Reports table + filters\n              [reportId]/\n                  page.js              # Report details modal\n           campaigns/\n              page.js                  # Campaigns grid + filters\n              [campaignId]/\n                  page.js              # Campaign moderation view\n           users/\n               page.js                  # Users table + search\n               [userId]/\n                   page.js              # User details + actions\n    api/\n        admin/\n            reports/\n               route.js                 # GET all reports\n               [reportId]/\n                   route.js             # PATCH update report status\n            campaigns/\n               route.js                 # GET all campaigns (admin view)\n               [campaignId]/\n                   route.js             # PATCH moderate campaign\n                   delete/\n                       route.js         # DELETE remove campaign\n            users/\n               route.js                 # GET all users\n               [userId]/\n                   role/\n                      route.js         # PATCH set user role\n                   ban/\n                       route.js         # PATCH ban/unban user\n            analytics/\n                route.js                 # GET platform stats\n components/\n    admin/\n        AdminSidebar.js                  # Navigation sidebar\n        AdminHeader.js                   # Top header with user menu\n        ReportsTable.js                  # Reports data table\n        ReportDetailsPanel.js            # Report details side panel\n        CampaignModerationCard.js        # Campaign card with actions\n        UsersTable.js                    # Users data table\n        UserDetailsModal.js              # User info modal\n        AnalyticsCard.js                 # Metric display card\n        AnalyticsChart.js                # Chart component\n        AdminActionButton.js             # Reusable action button\n middleware/\n    adminAuth.js                         # Admin authentication middleware\n lib/\n    firebaseAdmin.js                     # Add Firestore admin export\n    firestore.js                         # Add admin-only functions\n utils/\n     admin/\n         adminHelpers.js                  # Admin utility functions\n         adminValidation.js               # Input validation for admin actions\n```\n\n---\n\n### API Endpoints\n\n#### Reports Management\n\n**GET `/api/admin/reports`**\n- Query params: `?status=pending&limit=20&offset=0`\n- Returns: Array of reports with campaign/reporter details\n- Auth: Admin only\n\n**PATCH `/api/admin/reports/[reportId]`**\n- Body: `{ status: \"resolved\", action: \"removed\", reviewedBy: adminId }`\n- Updates report status and records action\n- Auth: Admin only\n\n---\n\n#### Campaign Moderation\n\n**GET `/api/admin/campaigns`**\n- Query params: `?moderationStatus=under-review&limit=20`\n- Returns: Campaigns with extended metadata\n- Auth: Admin only\n\n**PATCH `/api/admin/campaigns/[campaignId]`**\n- Body: `{ moderationStatus: \"removed\", removedBy: adminId, removeReason: \"Inappropriate content\" }`\n- Updates campaign moderation status\n- Auth: Admin only\n\n**DELETE `/api/admin/campaigns/[campaignId]/delete`**\n- Permanently deletes campaign + Supabase image\n- Records deletion in audit log\n- Auth: Admin only\n\n---\n\n#### User Management\n\n**GET `/api/admin/users`**\n- Query params: `?search=john&role=admin&limit=50`\n- Returns: User list with stats\n- Auth: Admin only\n\n**PATCH `/api/admin/users/[userId]/role`**\n- Body: `{ role: \"admin\", updatedBy: adminId }`\n- Sets user role (admin/user)\n- Auth: Admin only\n\n**PATCH `/api/admin/users/[userId]/ban`**\n- Body: `{ banned: true, reason: \"Spam\", bannedBy: adminId }`\n- Bans or unbans user\n- Auth: Admin only\n\n---\n\n#### Analytics\n\n**GET `/api/admin/analytics`**\n- Query params: `?period=30d`\n- Returns: Platform metrics and trends\n- Auth: Admin only\n\n---\n\n### Firestore Functions (Admin-Only)\n\nAdd to `src/lib/firestore.js`:\n\n```javascript\n// Reports\nexport async function getAllReportsAdmin(filters) {\n  // Fetch reports with filters (admin access)\n}\n\nexport async function updateReportAdmin(reportId, updates, adminId) {\n  // Update report with admin user tracking\n}\n\n// Campaigns\nexport async function getAllCampaignsAdmin(filters) {\n  // Fetch campaigns with extended metadata\n}\n\nexport async function moderateCampaign(campaignId, moderationData, adminId) {\n  // Update campaign moderation status\n}\n\nexport async function deleteCampaignAdmin(campaignId, adminId) {\n  // Permanently delete campaign + image\n}\n\n// Users\nexport async function getAllUsersAdmin(filters) {\n  // Fetch all users with stats\n}\n\nexport async function setUserRole(userId, role, adminId) {\n  // Assign admin/user role\n}\n\nexport async function banUser(userId, banData, adminId) {\n  // Ban or unban user\n}\n\n// Analytics\nexport async function getPlatformStats(period) {\n  // Calculate platform metrics\n}\n```\n\n---\n\n### Firebase Admin Setup\n\nUpdate `src/lib/firebaseAdmin.js`:\n\n```javascript\nimport { getAuth } from 'firebase-admin/auth';\nimport { getFirestore } from 'firebase-admin/firestore'; // NEW\n\nconst adminApp = getAdminApp();\nexport const adminAuth = getAuth(adminApp);\nexport const adminFirestore = getFirestore(adminApp); // NEW\n```\n\n**Usage:**\n- Use `adminFirestore` for server-side queries in admin API routes\n- Bypasses security rules (full database access)\n- Required for aggregation queries and batch operations\n\n---\n\n### UI Components\n\n#### AdminSidebar\n- Links: Analytics, Reports, Campaigns, Users\n- Active state indication\n- Admin user info at bottom\n- Logout button\n\n#### ReportsTable\n- Columns: ID, Campaign (thumbnail + title), Reason, Reporter, Status, Date, Actions\n- Filters: Status dropdown, reason dropdown\n- Pagination controls\n- Click row  Opens ReportDetailsPanel\n\n#### CampaignModerationCard\n- Campaign thumbnail with type badge\n- Title, creator, supporters, reports count\n- Status badge (active/under-review/removed)\n- Quick actions: View Reports, Remove, Restore\n- Click  Opens campaign details modal\n\n#### UsersTable\n- Columns: Avatar, Display Name, Email, Role, Campaigns, Supports, Joined, Actions\n- Search bar (name/email)\n- Filter: All, Admins, Banned\n- Actions: Make Admin, Ban, View Campaigns\n\n---\n\n### Implementation Status\n\n** Phase 2A - COMPLETED (Critical):**\n1.  Admin role field + assignment function\n2.  Middleware authentication\n3.  Reports management UI + API\n4.  Campaign moderation UI + API\n\n** Phase 2B - COMPLETED (Important):**\n5.  User management UI + API\n6.  Platform analytics dashboard\n7.  Audit logging system (deferred)\n\n** Phase 2C - NOT IMPLEMENTED (Nice to Have):**\n8.  Bulk actions for reports/campaigns\n9.  Advanced analytics (charts, trends)\n10.  Export data (CSV reports)\n\n---\n\n## Best Practices & Recommendations\n\n### Performance Optimization\n **Recommended for Production**\n\n1. **Image Optimization**  (Completed)\n   - ImageKit.io CDN with WebP transformations\n   - Smart resizing with imageTransform.js utility\n   - Thumbnails for gallery, full resolution for canvas\n   - **Impact:** Significant bandwidth cost reduction through optimized delivery\n\n2. **Lazy Loading**\n   - Load images on scroll in gallery\n   - Defer ad scripts until page ready\n   - Code-split routes for faster initial load\n\n3. **Caching Strategy**\n   - Cache campaign metadata in browser (5min)\n   - CDN cache images (365 days with version param)\n   - Service worker for offline support\n\n### Security Hardening\n **Recommended for Production**\n\n1. **Rate Limiting**\n   - Campaign creation: 5 per hour per user\n   - Report submission: 10 per hour per IP\n   - Download tracking: 100 per hour per campaign\n\n2. **Content Validation**\n   - Server-side file type re-validation\n   - Image dimension limits (max 4000x4000)\n   - Malware scanning for uploads\n   - NSFW content detection\n\n3. **Auth Improvements**\n   - Email verification required for publishing\n   - reCAPTCHA on report submission\n   - Admin role verification middleware\n\n### Data Integrity\n **Recommended for Production**\n\n1. **Backup Strategy**\n   - Daily Firestore exports\n   - Weekly Supabase backup\n   - Deleted campaign archive (30-day retention)\n\n2. **Error Handling**\n   - Retry logic for Firestore writes\n   - Fallback for image load failures\n   - User-friendly error messages\n   - Error tracking (Sentry/LogRocket)\n\n3. **Data Validation**\n   - Schema validation on all writes\n   - Sanitize user input (title, description)\n   - XSS protection on rendered content\n\n### Monitoring & Analytics\n **Recommended for Production**\n\n1. **Core Metrics**\n   - Campaign creation rate\n   - Visitor completion rate (3-page flow)\n   - Average time per page\n   - Drop-off points\n   - Download success rate\n\n2. **Performance Metrics**\n   - Page load time (target: <2s)\n   - Canvas rendering time (target: <1s)\n   - API response time (target: <500ms)\n   - Error rate (target: <1%)\n\n3. **Business Metrics**\n   - Active campaigns\n   - Daily active users\n   - Top performing campaigns\n   - Creator retention\n   - Revenue per visit (with ads)\n\n### Scalability Considerations\n **Prepare for Growth**\n\n1. **Database Optimization**\n   - Add composite indexes for filtered queries\n   - Consider pagination for large galleries (>1000 campaigns)\n   - Archive inactive campaigns (>6 months, 0 downloads)\n\n2. **Storage Optimization**\n   - Image compression before upload (client-side)\n   - Delete old campaign images after deletion\n   - Monitor Supabase storage quota\n\n3. **Infrastructure**\n   - Implement CDN for static assets\n   - Database read replicas for heavy queries\n   - Horizontal scaling for API routes\n\n---\n\n## Testing Checklist\n\n### Creator Flow\n- [ ] Upload frame with transparency  Success\n- [ ] Upload frame without transparency  Error shown\n- [ ] Upload background (PNG/JPG/WEBP)  Success\n- [ ] File size >5MB  Error shown\n- [ ] Unauthenticated publish  Auth modal appears\n- [ ] Auth modal \"Go Back\"  Returns to form\n- [ ] Auth modal \"Sign In\"  Preserves form data\n- [ ] Publish success  Redirects to campaign page\n\n### Visitor Flow\n- [ ] Complete flow: Upload  Adjust  Result\n- [ ] Direct URL to `/adjust` without photo  Redirects to upload\n- [ ] Direct URL to `/result` without download  Redirects appropriately\n- [ ] Page reload on each page  Session persists\n- [ ] Session >24h old  Clears and redirects\n- [ ] \"Start Over\"  Clears session and returns to upload\n- [ ] Download button  Increments supportersCount\n- [ ] Canvas adjustments (zoom, drag, rotate)  Works smoothly\n- [ ] Mobile touch  No blue highlight, smooth interaction\n\n### Discovery\n- [ ] Gallery filters (type, time, sort)  Works correctly\n- [ ] Creators filter (country, time)  Works correctly\n- [ ] Campaign cards link to correct campaign\n- [ ] Empty state shows when no results\n\n### Reports\n- [ ] Submit report without auth  Success\n- [ ] Submit report with auth  Success\n- [ ] Duplicate report prevention  Works\n- [ ] Report increments reportsCount  Verified\n- [ ] 3+ reports sets moderationStatus  Verified\n\n---\n\n## File Structure\n\n```\nsrc/\n app/\n    (chrome)/\n       campaign/\n          [slug]/\n              page.js              # Page 1: Upload\n              adjust/\n                 page.js          # Page 2: Adjust\n              result/\n                  page.js          # Page 3: Result\n       campaigns/\n          page.js                  # Gallery\n       create/\n          page.js                  # Opens modal\n          frame/\n             page.js              # Frame upload\n          background/\n              page.js              # Background upload\n       creators/\n           page.js                  # Top creators\n    api/\n        campaigns/\n           track-download/\n               route.js             # Download tracking\n        storage/\n            campaign-upload-url/\n               route.js             # Campaign upload URL\n            delete/\n               route.js             # Delete image\n            signed-url/\n                route.js             # Temporary download URL\n components/\n    CampaignStepIndicator.js         # Progress indicator\n    CreateCampaignModal.js           # Type selection\n    FilterModal.js                   # Shared filter UI\n contexts/\n    CampaignSessionContext.js        # Session state management\n lib/\n    firestore.js                     # All Firestore functions\n    firebase-optimized.js            # Firebase client init\n    firebaseAdmin.js                 # Firebase admin (server)\n    supabase.js                      # Supabase client\n utils/\n     campaignRouteGuards.js           # Navigation guards\n     campaignStorage.js               # Storage path helpers\n     imageComposition.js              # Canvas composition\n     slugGenerator.js                 # Slug generation\n     transparencyDetector.js          # Transparency check\n```\n\n---\n\n**Last Updated:** October 05, 2025  \n**Contributors:** Campaign system fully implemented in Phase 1  \n**Next Steps:** See TASKS.md for Phase 2 roadmap\n","path":null,"size_bytes":41090,"size_tokens":null},"src/app/api/storage/delete/route.js":{"content":"import { NextResponse } from 'next/server'\nimport { verifyIdToken } from '../../../../lib/firebaseAdmin'\nimport { supabaseAdmin } from '../../../../lib/supabase-admin'\nimport { headers } from 'next/headers'\n\n// Force Node.js runtime for server-side operations\nexport const runtime = 'nodejs'\n\nexport async function DELETE(request) {\n  try {\n    // Get the authorization header\n    const headersList = headers()\n    const authorization = headersList.get('authorization')\n    \n    if (!authorization || !authorization.startsWith('Bearer ')) {\n      return NextResponse.json({ success: false, error: 'No authorization token provided' }, { status: 401 })\n    }\n\n    const token = authorization.replace('Bearer ', '')\n    \n    // Verify Firebase ID token\n    let decodedToken\n    try {\n      decodedToken = await verifyIdToken(token)\n    } catch (error) {\n      return NextResponse.json({ success: false, error: 'Invalid token' }, { status: 401 })\n    }\n\n    const { path } = await request.json()\n    \n    if (!path) {\n      return NextResponse.json({ success: false, error: 'path is required' }, { status: 400 })\n    }\n\n    // Verify user owns this file - handle different folder structures\n    const allowedPrefixes = [\n      `uploads/${decodedToken.uid}/`,\n      `profile-images/${decodedToken.uid}/`,\n      `documents/${decodedToken.uid}/`,\n      `temp/${decodedToken.uid}/`,\n      `campaigns/${decodedToken.uid}/`\n    ]\n    \n    const hasValidPrefix = allowedPrefixes.some(prefix => path.startsWith(prefix))\n    if (!hasValidPrefix) {\n      return NextResponse.json({ success: false, error: 'Access denied' }, { status: 403 })\n    }\n\n    // Delete the file\n    const { error } = await supabaseAdmin.storage\n      .from('uploads')\n      .remove([path])\n\n    if (error) {\n      console.error('Supabase error:', error)\n      return NextResponse.json({ success: false, error: 'Failed to delete file' }, { status: 500 })\n    }\n\n    return NextResponse.json({ success: true, message: 'File deleted successfully' })\n\n  } catch (error) {\n    console.error('File deletion error:', error)\n    return NextResponse.json({ success: false, error: 'Internal server error' }, { status: 500 })\n  }\n}","path":null,"size_bytes":2182,"size_tokens":null},"src/utils/campaignStorage.js":{"content":"/**\n * Campaign Storage Utilities\n * \n * Helper functions for working with campaign image storage paths.\n * Ensures consistent path structure: campaigns/{userId}/{campaignId}.png\n */\n\n/**\n * Build the storage path for a campaign image\n * \n * @param {string} userId - User ID (creator of the campaign)\n * @param {string} campaignId - Campaign ID\n * @returns {string} Storage path: campaigns/{userId}/{campaignId}.png\n * \n * @example\n * const path = buildCampaignImagePath('user123', 'campaign456');\n * // Returns: \"campaigns/user123/campaign456.png\"\n */\nexport function buildCampaignImagePath(userId, campaignId) {\n  if (!userId || !campaignId) {\n    throw new Error('userId and campaignId are required');\n  }\n  \n  return `campaigns/${userId}/${campaignId}.png`;\n}\n\n/**\n * Build the public URL for a campaign image\n * \n * @param {string} userId - User ID (creator of the campaign)\n * @param {string} campaignId - Campaign ID\n * @returns {string} Public URL to the campaign image\n * \n * @example\n * const url = buildCampaignImageUrl('user123', 'campaign456');\n * // Returns: \"https://{project}.supabase.co/storage/v1/object/public/uploads/campaigns/user123/campaign456.png\"\n */\nexport function buildCampaignImageUrl(userId, campaignId) {\n  const path = buildCampaignImagePath(userId, campaignId);\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;\n  \n  if (!supabaseUrl) {\n    throw new Error('NEXT_PUBLIC_SUPABASE_URL is not configured');\n  }\n  \n  return `${supabaseUrl}/storage/v1/object/public/uploads/${path}`;\n}\n\n/**\n * Extract userId and campaignId from a campaign image path\n * \n * @param {string} path - Storage path\n * @returns {{userId: string, campaignId: string} | null} Extracted IDs or null if invalid\n * \n * @example\n * const ids = parseCampaignImagePath('campaigns/user123/campaign456.png');\n * // Returns: { userId: 'user123', campaignId: 'campaign456' }\n */\nexport function parseCampaignImagePath(path) {\n  if (!path) return null;\n  \n  // Match pattern: campaigns/{userId}/{campaignId}.png\n  const match = path.match(/^campaigns\\/([^/]+)\\/([^/]+)\\.png$/);\n  \n  if (!match) return null;\n  \n  return {\n    userId: match[1],\n    campaignId: match[2]\n  };\n}\n\n/**\n * Validate if a path matches the campaign storage structure\n * \n * @param {string} path - Storage path to validate\n * @returns {boolean} True if path matches campaigns/{userId}/{campaignId}.png\n * \n * @example\n * isValidCampaignPath('campaigns/user123/campaign456.png'); // true\n * isValidCampaignPath('uploads/user123/file.png'); // false\n */\nexport function isValidCampaignPath(path) {\n  return parseCampaignImagePath(path) !== null;\n}\n\n/**\n * Get campaign upload URL from API\n * Client-side helper for uploading campaign images\n * \n * @param {string} campaignId - Campaign ID\n * @param {number} fileSize - File size in bytes\n * @param {string} fileType - MIME type of the file\n * @param {string} authToken - Firebase auth token\n * @returns {Promise<{uploadUrl: string, path: string, token: string}>}\n * \n * @example\n * const { uploadUrl, path } = await getCampaignUploadUrl(campaignId, file.size, file.type, token);\n * await fetch(uploadUrl, {\n *   method: 'PUT',\n *   body: imageFile,\n *   headers: { 'Content-Type': 'image/png' }\n * });\n */\nexport async function getCampaignUploadUrl(campaignId, fileSize, fileType, authToken) {\n  const response = await fetch('/api/storage/campaign-upload-url', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${authToken}`\n    },\n    body: JSON.stringify({ campaignId, fileSize, fileType })\n  });\n  \n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(error.error || 'Failed to get upload URL');\n  }\n  \n  return response.json();\n}\n\n/**\n * Delete a campaign image from storage\n * Client-side helper for deleting campaign images\n * \n * @param {string} path - Storage path to delete\n * @param {string} authToken - Firebase auth token\n * @returns {Promise<{success: boolean}>}\n * \n * @example\n * const path = buildCampaignImagePath(userId, campaignId);\n * await deleteCampaignImage(path, token);\n */\nexport async function deleteCampaignImage(path, authToken) {\n  const response = await fetch('/api/storage/delete', {\n    method: 'DELETE',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${authToken}`\n    },\n    body: JSON.stringify({ path })\n  });\n  \n  if (!response.ok) {\n    const error = await response.json();\n    throw new Error(error.error || 'Failed to delete image');\n  }\n  \n  return response.json();\n}\n","path":null,"size_bytes":4566,"size_tokens":null},"src/app/signin/page.js":{"content":"\"use client\";\n\nimport { useEffect, useRef, useState } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { validateEmail, validatePassword, validateForm } from '../../utils/validation';\nimport { useAuth } from '../../hooks/useAuth';\nimport { Caveat } from \"next/font/google\";\nimport Link from \"next/link\";\n\nconst caveat = Caveat({ subsets: [\"latin\"], weight: [\"700\"] });\n\nexport default function SignInPage() {\n  const router = useRouter();\n  const { user, loading: authLoading, signInWithGoogle, signInWithEmail } = useAuth();\n  \n  const [validationErrors, setValidationErrors] = useState({});\n  const [fieldValidation, setFieldValidation] = useState({});\n  const [error, setError] = useState('');\n  const [loading, setLoading] = useState(false);\n  const [showPassword, setShowPassword] = useState(false);\n  \n  // Refs for form validation scrolling\n  const emailRef = useRef();\n  const passwordRef = useRef();\n\n  // Redirect if already signed in\n  useEffect(() => {\n    if (user && !authLoading) {\n      router.replace(user.emailVerified ? '/' : '/verify-email');\n    }\n  }, [user, authLoading, router]);\n\n  const scrollToField = (fieldName) => {\n    const fieldRefs = {\n      email: emailRef,\n      password: passwordRef\n    };\n    \n    const fieldRef = fieldRefs[fieldName];\n    if (fieldRef?.current) {\n      fieldRef.current.scrollIntoView({\n        behavior: 'smooth',\n        block: 'center'\n      });\n      // Focus the field after scrolling\n      setTimeout(() => {\n        fieldRef.current.focus();\n      }, 300);\n    }\n  };\n\n  const validateFormFields = (formData) => {\n    const validation = validateForm(formData, 'signin');\n    \n    setValidationErrors(validation.errors);\n    \n    // If there are errors, scroll to the first error field\n    if (validation.firstErrorField) {\n      setTimeout(() => scrollToField(validation.firstErrorField), 100);\n    }\n    \n    return validation.isValid;\n  };\n\n  const handleEmailSignIn = async (e) => {\n    e.preventDefault();\n    const formData = new FormData(e.target);\n    \n    if (!validateFormFields(formData)) {\n      return;\n    }\n\n    setLoading(true);\n    setError('');\n\n    try {\n      const result = await signInWithEmail(formData.get('email'), formData.get('password'));\n      if (result.success) {\n        // Will be handled by useEffect redirect based on email verification status\n      } else if (result.banned) {\n        // User is banned - redirect to banned page\n        router.push('/banned');\n      } else {\n        setError(result.error || 'Failed to sign in');\n      }\n    } catch (err) {\n      setError('Failed to sign in');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleGoogleSignIn = async () => {\n    setLoading(true);\n    setError('');\n\n    try {\n      const result = await signInWithGoogle();\n      if (result.success) {\n        // Will be handled by useEffect redirect based on email verification status\n      } else if (result.banned) {\n        // User is banned - redirect to banned page\n        router.push('/banned');\n      } else {\n        setError(result.error || 'Failed to sign in with Google');\n      }\n    } catch (err) {\n      setError('Failed to sign in with Google');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleInputChange = (field, value) => {\n    // Clear form validation errors when user starts typing\n    if (validationErrors[field]) {\n      setValidationErrors(prev => ({ ...prev, [field]: '' }));\n    }\n    \n    // Perform real-time validation\n    let validationError = null;\n    let isValid = false;\n    \n    if (field === 'email' && value.trim()) {\n      validationError = validateEmail(value);\n      isValid = !validationError;\n    } else if (field === 'password' && value.trim()) {\n      validationError = validatePassword(value, true);\n      isValid = !validationError;\n    }\n    \n    // Update field validation status\n    setFieldValidation(prev => ({\n      ...prev,\n      [field]: {\n        isValid,\n        error: validationError,\n        hasValue: value.trim().length > 0\n      }\n    }));\n  };\n\n  // Don't show loading overlay during auth actions - keep form visible\n\n  return (\n    <div className=\"min-h-screen bg-white\">\n      {/* Frame Logo */}\n      <div className=\"absolute top-6 left-6 z-50 mb-8\">\n        <Link \n          href=\"/\" \n          className={`${caveat.className} text-2xl md:text-3xl font-bold text-emerald-700 hover:text-emerald-800 transition-all duration-300 hover:scale-110`}\n        >\n          Frame\n        </Link>\n      </div>\n      \n      <div className=\"min-h-screen flex\">\n        {/* Left Side - Form */}\n        <div className=\"flex-1 w-full flex flex-col justify-center py-8 px-4 sm:px-6 lg:px-16 xl:px-20 pt-20\">\n          <div className=\"mx-auto w-full max-w-sm lg:max-w-md\">\n            <div className=\"text-center mb-6 bg-yellow-400 px-4 py-3 rounded-t-lg\">\n              <h2 className=\"text-2xl font-bold text-emerald-700\">Sign in to your account</h2>\n              <p className=\"mt-1 text-black text-sm\">Welcome back! Please enter your details.</p>\n            </div>\n            \n            {/* Content Card with Shadow Border */}\n            <div className=\"bg-white rounded-b-lg border border-t-0 border-gray-200 px-6 py-6 shadow-sm\">\n            {/* Email Sign In Form */}\n            <form className=\"space-y-3 mb-4\" onSubmit={handleEmailSignIn} noValidate>\n              {error && (\n                <div className=\"text-red-600 text-sm text-center p-2 bg-red-50 rounded-lg\" role=\"alert\">\n                  <div>{error}</div>\n                  {error.toLowerCase().includes('invalid') && (error.toLowerCase().includes('email') || error.toLowerCase().includes('password')) && (\n                    <div className=\"mt-2 text-gray-600\">\n                      <span className=\"text-xs\">\n                        Forgot your password? Click on \"\n                        <button\n                          type=\"button\"\n                          onClick={() => router.push('/forgot-password')}\n                          className=\"btn-link font-medium\"\n                        >\n                          Forgot Password?\n                        </button>\n                        \" to reset it.\n                      </span>\n                    </div>\n                  )}\n                </div>\n              )}\n              <div>\n                <label htmlFor=\"signin-email\" className=\"block text-sm font-medium text-gray-800 mb-1\">\n                  Email\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={emailRef}\n                    id=\"signin-email\"\n                    type=\"email\"\n                    name=\"email\"\n                    required\n                    placeholder=\"Enter your email\"\n                    onChange={(e) => handleInputChange('email', e.target.value)}\n                    className={`w-full px-3 py-2 pr-10 border rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all duration-300 text-gray-900 placeholder-gray-500 text-sm ${\n                      validationErrors.email ? 'border-red-300 bg-red-50' : \n                      fieldValidation.email?.isValid ? 'border-emerald-300 bg-emerald-50' :\n                      fieldValidation.email?.hasValue ? 'border-red-300 bg-red-50' :\n                      'border-gray-300'\n                    }`}\n                  />\n                  {/* Validation Icon */}\n                  {(validationErrors.email || (fieldValidation.email?.hasValue && !fieldValidation.email?.isValid)) && (\n                    <div className=\"absolute right-3 top-1/2 transform -translate-y-1/2\">\n                      {fieldValidation.email?.isValid && !validationErrors.email ? (\n                        <svg className=\"w-5 h-5 text-emerald-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                        </svg>\n                      ) : (\n                        <svg \n                          className=\"w-5 h-5 text-red-500\" \n                          fill=\"none\" \n                          stroke=\"currentColor\" \n                          viewBox=\"0 0 24 24\"\n                        >\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                        </svg>\n                      )}\n                    </div>\n                  )}\n                </div>\n                {validationErrors.email && (\n                  <p className=\"text-red-600 text-sm mt-1\">{validationErrors.email}</p>\n                )}\n              </div>\n              <div>\n                <label htmlFor=\"signin-password\" className=\"block text-sm font-medium text-gray-800 mb-1\">\n                  Password\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={passwordRef}\n                    id=\"signin-password\"\n                    type={showPassword ? \"text\" : \"password\"}\n                    name=\"password\"\n                    required\n                    placeholder=\"Enter your password\"\n                    onChange={(e) => handleInputChange('password', e.target.value)}\n                    className={`w-full px-3 py-2 pr-10 border rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all duration-300 text-gray-900 placeholder-gray-500 text-sm ${\n                      validationErrors.password ? 'border-red-300 bg-red-50' : 'border-gray-300'\n                    }`}\n                  />\n                  {/* Password visibility toggle */}\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowPassword(!showPassword)}\n                    className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-50 rounded\"\n                    aria-label={showPassword ? \"Hide password\" : \"Show password\"}\n                    aria-pressed={showPassword}\n                    title={showPassword ? \"Hide password\" : \"Show password\"}\n                  >\n                    {showPassword ? (\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21\" />\n                      </svg>\n                    ) : (\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\" />\n                      </svg>\n                    )}\n                  </button>\n                </div>\n                {validationErrors.password && (\n                  <p className=\"text-red-600 text-sm mt-1\">{validationErrors.password}</p>\n                )}\n                <div className=\"text-right mt-2\">\n                  <a\n                    href=\"/forgot-password\"\n                    className=\"btn-link text-sm font-medium\"\n                  >\n                    Forgot Password?\n                  </a>\n                </div>\n              </div>\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full btn-base btn-primary py-2 px-4 text-sm\"\n              >\n                {loading ? 'Signing In...' : 'Sign In'}\n              </button>\n            </form>\n\n            {/* Divider */}\n            <div className=\"relative mb-4\">\n              <div className=\"absolute inset-0 flex items-center\">\n                <div className=\"w-full border-t border-gray-200\"></div>\n              </div>\n              <div className=\"relative flex justify-center text-sm\">\n                <span className=\"bg-white px-4 text-gray-500\">or</span>\n              </div>\n            </div>\n\n            {/* Google Sign In */}\n            <div className=\"text-center mb-4\">\n              <button\n                onClick={handleGoogleSignIn}\n                disabled={loading}\n                className=\"w-full btn-base btn-google py-2 px-4 gap-3 text-sm\"\n              >\n                <svg className=\"w-4 h-4 sm:w-5 sm:h-5\" viewBox=\"0 0 24 24\" aria-hidden=\"true\">\n                  <path fill=\"#4285F4\" d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\"/>\n                  <path fill=\"#34A853\" d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\"/>\n                  <path fill=\"#FBBC05\" d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z\"/>\n                  <path fill=\"#EA4335\" d=\"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\"/>\n                </svg>\n                {loading ? 'Signing In...' : 'Continue with Google'}\n              </button>\n            </div>\n\n            <div className=\"text-center\">\n              <p className=\"text-sm text-gray-500\">\n                Don't have an account? \n                <a \n                  href=\"/signup\"\n                  className=\"btn-link font-medium ml-1\"\n                >\n                  Sign Up\n                </a>\n              </p>\n            </div>\n            </div>\n          </div>\n        </div>\n\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":14073,"size_tokens":null},"src/components/admin/ReportsTable.js":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { \n  formatReportReason, \n  getReportStatusColor, \n  formatTimestamp \n} from \"@/utils/admin/adminHelpers\";\n\nexport default function ReportsTable({ reports, loading, onSelectReport, onStatusChange }) {\n  const [selectedReportId, setSelectedReportId] = useState(null);\n\n  const handleRowClick = (report) => {\n    setSelectedReportId(report.id);\n    onSelectReport(report);\n  };\n\n  if (loading) {\n    return (\n      <div className=\"bg-white rounded-lg shadow\">\n        <div className=\"p-8 text-center\">\n          <div className=\"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600\"></div>\n          <p className=\"mt-2 text-gray-600\">Loading reports...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (reports.length === 0) {\n    return (\n      <div className=\"bg-white rounded-lg shadow\">\n        <div className=\"p-8 text-center\">\n          <svg className=\"mx-auto h-12 w-12 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n          </svg>\n          <h3 className=\"mt-2 text-sm font-medium text-gray-900\">No reports found</h3>\n          <p className=\"mt-1 text-sm text-gray-500\">No reports match your current filters.</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow overflow-hidden\">\n      <div className=\"overflow-x-auto\">\n        <table className=\"min-w-full divide-y divide-gray-200\">\n          <thead className=\"bg-gray-50\">\n            <tr>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Reported Item\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Reason\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Reporter\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Status\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Date\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Actions\n              </th>\n            </tr>\n          </thead>\n          <tbody className=\"bg-white divide-y divide-gray-200\">\n            {reports.map((report) => (\n              <tr\n                key={report.id}\n                onClick={() => handleRowClick(report)}\n                className={`cursor-pointer transition-colors ${\n                  selectedReportId === report.id ? 'bg-emerald-50' : 'hover:bg-gray-50'\n                }`}\n              >\n                <td className=\"px-6 py-4 whitespace-nowrap\">\n                  <div className=\"flex items-center\">\n                    <div className=\"h-10 w-10 flex-shrink-0\">\n                      {report.type === 'profile' ? (\n                        report.reportedUser?.profileImage ? (\n                          <img\n                            className=\"h-10 w-10 rounded-full object-cover\"\n                            src={report.reportedUser.profileImage}\n                            alt={report.reportedUser.displayName || 'User'}\n                          />\n                        ) : (\n                          <div className=\"h-10 w-10 rounded-full bg-emerald-500 flex items-center justify-center\">\n                            <span className=\"text-white text-sm font-medium\">\n                              {report.reportedUser?.displayName?.charAt(0)?.toUpperCase() || 'U'}\n                            </span>\n                          </div>\n                        )\n                      ) : report.campaign?.imageUrl ? (\n                        <img\n                          className=\"h-10 w-10 rounded object-cover\"\n                          src={report.campaign.imageUrl}\n                          alt={report.campaign.title || 'Campaign'}\n                        />\n                      ) : (\n                        <div className=\"h-10 w-10 rounded bg-gray-200 flex items-center justify-center\">\n                          <svg className=\"h-6 w-6 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\" />\n                          </svg>\n                        </div>\n                      )}\n                    </div>\n                    <div className=\"ml-4\">\n                      {report.type === 'profile' ? (\n                        <>\n                          <div className=\"text-sm font-medium text-gray-900\">\n                            {report.reportedUser?.displayName || 'Unknown User'}\n                          </div>\n                          <div className=\"text-sm text-gray-500\">\n                            @{report.reportedUser?.username || report.reportedUsername || 'unknown'}\n                          </div>\n                        </>\n                      ) : (\n                        <>\n                          <div className=\"text-sm font-medium text-gray-900\">\n                            {report.campaign?.title || 'Unknown Campaign'}\n                          </div>\n                          <div className=\"text-sm text-gray-500\">\n                            by {report.campaign?.creator?.displayName || 'Unknown'}\n                          </div>\n                        </>\n                      )}\n                    </div>\n                  </div>\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap\">\n                  <div className=\"text-sm text-gray-900\">{formatReportReason(report.reason)}</div>\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap\">\n                  <div className=\"text-sm text-gray-900\">\n                    {report.reporter?.displayName || 'Anonymous'}\n                  </div>\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap\">\n                  <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getReportStatusColor(report.status)}`}>\n                    {report.status}\n                  </span>\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\n                  {formatTimestamp(report.createdAt, true)}\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium\">\n                  <button\n                    onClick={(e) => {\n                      e.stopPropagation();\n                      handleRowClick(report);\n                    }}\n                    className=\"text-emerald-600 hover:text-emerald-900\"\n                  >\n                    View Details\n                  </button>\n                </td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":7474,"size_tokens":null},"src/utils/validation.js":{"content":"// Validation utilities for authentication forms\n\nexport const validateEmail = (email) => {\n  if (!email) return 'Email is required';\n  const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n  if (!emailRegex.test(email)) return 'Please enter a valid email address';\n  return null;\n};\n\nexport const validatePassword = (password, isSignUp = false) => {\n  if (!password) return 'Password is required';\n  if (isSignUp && password.length < 8) return 'Password must be at least 8 characters';\n  return null;\n};\n\nexport const validateName = (name) => {\n  if (!name) return 'Name is required';\n  if (name.trim().length < 3) return 'Name must be at least 3 characters long';\n  if (name.length > 50) return 'Name must be less than 50 characters';\n  return null;\n};\n\nexport const normalizeEmail = (email) => {\n  return email ? email.toLowerCase().trim() : '';\n};\n\n// Shared form validation function for all authentication forms\nexport const validateForm = (formData, formType = 'signin') => {\n  const errors = {};\n  let firstErrorField = null;\n\n  // Name validation (signup only)\n  if (formType === 'signup') {\n    const name = formData.get('name')?.trim();\n    const nameError = validateName(name);\n    if (nameError) {\n      errors.name = nameError;\n      if (!firstErrorField) firstErrorField = 'name';\n    }\n  }\n\n  // Email validation (all forms)\n  const email = formData.get('email')?.trim();\n  const emailError = validateEmail(email);\n  if (emailError) {\n    errors.email = emailError;\n    if (!firstErrorField) firstErrorField = 'email';\n  }\n\n  // Password validation (signin and signup only)\n  if (formType !== 'forgot-password') {\n    const password = formData.get('password')?.trim();\n    const passwordError = validatePassword(password, formType === 'signup');\n    if (passwordError) {\n      errors.password = passwordError;\n      if (!firstErrorField) firstErrorField = 'password';\n    }\n  }\n\n  return {\n    isValid: Object.keys(errors).length === 0,\n    errors,\n    firstErrorField\n  };\n};\n\n// Check password strength and return feedback\nexport const getPasswordStrength = (password) => {\n  if (!password) return { strength: 'none', message: '' };\n  \n  let score = 0;\n  const feedback = [];\n  \n  // Length check\n  if (password.length >= 8) score++;\n  else feedback.push('Use at least 8 characters');\n  \n  // Lowercase check\n  if (/[a-z]/.test(password)) score++;\n  else feedback.push('Add lowercase letters');\n  \n  // Uppercase check\n  if (/[A-Z]/.test(password)) score++;\n  else feedback.push('Add uppercase letters');\n  \n  // Number check\n  if (/\\d/.test(password)) score++;\n  else feedback.push('Add numbers');\n  \n  // Special character check\n  if (/[^A-Za-z0-9]/.test(password)) score++;\n  else feedback.push('Add special characters');\n  \n  // Common patterns check\n  const commonPatterns = [\n    /(.)\\1{2,}/, // Repeated characters\n    /123456|654321|qwerty|password/i // Common sequences\n  ];\n  \n  const hasCommonPattern = commonPatterns.some(pattern => pattern.test(password));\n  if (hasCommonPattern) {\n    feedback.push('Avoid common patterns');\n    score = Math.max(0, score - 1);\n  }\n  \n  const strengthLevels = {\n    0: 'very-weak',\n    1: 'weak', \n    2: 'fair',\n    3: 'good',\n    4: 'strong',\n    5: 'very-strong'\n  };\n  \n  const strengthMessages = {\n    'very-weak': 'Very weak password',\n    'weak': 'Weak password',\n    'fair': 'Fair password',\n    'good': 'Good password',\n    'strong': 'Strong password',\n    'very-strong': 'Very strong password'\n  };\n  \n  const strength = strengthLevels[score];\n  \n  return {\n    strength,\n    score,\n    message: strengthMessages[strength],\n    feedback: feedback,\n    isStrong: score >= 3\n  };\n};\n\n/**\n * Abbreviate large numbers with K, M, B suffixes\n * @param {number} num - Number to abbreviate\n * @param {number} decimals - Number of decimal places (default: 1)\n * @returns {string} Abbreviated number (e.g., \"2.5k\", \"1.2M\")\n */\nexport const abbreviateNumber = (num, decimals = 1) => {\n  if (num === null || num === undefined) return '0';\n  \n  const number = Number(num);\n  \n  if (isNaN(number)) return '0';\n  if (number < 1000) return number.toString();\n  \n  const abbreviations = [\n    { value: 1e9, suffix: 'B' },\n    { value: 1e6, suffix: 'M' },\n    { value: 1e3, suffix: 'k' }\n  ];\n  \n  for (const { value, suffix } of abbreviations) {\n    if (number >= value) {\n      const abbreviated = number / value;\n      // Remove unnecessary decimals (e.g., 2.0k -> 2k)\n      const formatted = abbreviated % 1 === 0 \n        ? abbreviated.toFixed(0) \n        : abbreviated.toFixed(decimals);\n      return formatted + suffix;\n    }\n  }\n  \n  return number.toString();\n};","path":null,"size_bytes":4622,"size_tokens":null},"src/app/api/reports/submit/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\nimport { sendInAppNotification } from '@/utils/notifications/sendInAppNotification';\nimport { getNotificationTemplate } from '@/utils/notifications/notificationTemplates';\nimport { checkReportRateLimit } from '@/utils/reportRateLimit';\n\nexport async function POST(request) {\n  try {\n    const body = await request.json();\n    \n    const { campaignId, campaignSlug, reportedBy, reason } = body;\n    \n    // Validate required fields\n    if (!campaignId || !reason) {\n      return NextResponse.json(\n        { success: false, error: 'Campaign ID and reason are required' },\n        { status: 400 }\n      );\n    }\n    \n    // Validate reason is one of the allowed values\n    const validReasons = ['inappropriate', 'spam', 'copyright', 'other'];\n    if (!validReasons.includes(reason)) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid report reason' },\n        { status: 400 }\n      );\n    }\n    \n    // Check rate limit and duplicate reports (pass userId to prevent authenticated bypass)\n    const rateLimitCheck = await checkReportRateLimit(request, campaignId, 'campaign', reportedBy);\n    if (!rateLimitCheck.allowed) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: rateLimitCheck.message,\n          reason: rateLimitCheck.reason\n        },\n        { status: 429 }\n      );\n    }\n    \n    // Get Firestore instance\n    const db = adminFirestore();\n    \n    // Use Firestore transaction for atomic operations\n    const campaignRef = db.collection('campaigns').doc(campaignId);\n    const summaryId = `campaign-${campaignId}`;\n    const summaryRef = db.collection('reportSummary').doc(summaryId);\n    \n    let shouldNotify = false;\n    let notificationData = null;\n    \n    await db.runTransaction(async (transaction) => {\n      // ALL READS MUST COME FIRST (Firestore requirement)\n      const campaignDoc = await transaction.get(campaignRef);\n      const summaryDoc = await transaction.get(summaryRef);\n      \n      if (!campaignDoc.exists) {\n        throw new Error('Campaign not found');\n      }\n      \n      const campaignData = campaignDoc.data();\n      const currentReportsCount = campaignData.reportsCount || 0;\n      \n      // Update or create report summary with reason counts\n      const now = new Date();\n      \n      let newReportsCount;\n      let isResettingCounts = false;\n      \n      if (summaryDoc.exists) {\n        const currentSummary = summaryDoc.data();\n        \n        // If previously resolved/dismissed, reset BOTH counters to start fresh\n        if (currentSummary.status === 'resolved' || currentSummary.status === 'dismissed') {\n          newReportsCount = 1;\n          isResettingCounts = true;\n        } else {\n          // Still pending, increment counter\n          newReportsCount = currentReportsCount + 1;\n        }\n      } else {\n        // New summary, start at 1\n        newReportsCount = 1;\n      }\n      \n      // Update campaign\n      const campaignUpdates = {\n        reportsCount: newReportsCount,\n        updatedAt: new Date(),\n      };\n      \n      // Auto-flag for review based on report count thresholds\n      // 1-2 reports: under-review (visible but flagged)\n      // 3+ reports: under-review-hidden (hidden from public)\n      if (newReportsCount >= 1 && newReportsCount <= 2 && campaignData.moderationStatus === 'active') {\n        campaignUpdates.moderationStatus = 'under-review';\n        \n        // Flag for notification after transaction\n        shouldNotify = true;\n        notificationData = {\n          userId: campaignData.creatorId,\n          campaignTitle: campaignData.title || 'Your campaign',\n          campaignId,\n          reason,\n          notificationType: 'under-review'\n        };\n      } else if (newReportsCount >= 3 && (campaignData.moderationStatus === 'active' || campaignData.moderationStatus === 'under-review')) {\n        campaignUpdates.moderationStatus = 'under-review-hidden';\n        campaignUpdates.hiddenAt = new Date();\n        \n        // Flag for notification after transaction\n        shouldNotify = true;\n        notificationData = {\n          userId: campaignData.creatorId,\n          campaignTitle: campaignData.title || 'Your campaign',\n          campaignId,\n          reason,\n          notificationType: 'under-review-hidden'\n        };\n      }\n      \n      transaction.update(campaignRef, campaignUpdates);\n      \n      if (summaryDoc.exists) {\n        // Update existing summary\n        const currentSummary = summaryDoc.data();\n        const summaryUpdates = {\n          lastReportedAt: now,\n          updatedAt: now,\n        };\n        \n        // If previously resolved/dismissed, reset counter and status to start fresh\n        if (isResettingCounts) {\n          summaryUpdates.status = 'pending';\n          summaryUpdates.reportsCount = 1;\n          summaryUpdates.firstReportedAt = now;\n          summaryUpdates.reasonCounts = { [reason]: 1 };\n        } else {\n          // Still pending, increment counter and reason count\n          summaryUpdates.reportsCount = (currentSummary.reportsCount || 0) + 1;\n          \n          // Increment reason count\n          const currentReasonCounts = currentSummary.reasonCounts || {};\n          summaryUpdates.reasonCounts = {\n            ...currentReasonCounts,\n            [reason]: (currentReasonCounts[reason] || 0) + 1\n          };\n        }\n        \n        // Sync moderation status based on report count\n        if (newReportsCount >= 1 && newReportsCount <= 2 && campaignData.moderationStatus === 'active') {\n          summaryUpdates.moderationStatus = 'under-review';\n        } else if (newReportsCount >= 3 && (campaignData.moderationStatus === 'active' || campaignData.moderationStatus === 'under-review')) {\n          summaryUpdates.moderationStatus = 'under-review-hidden';\n          summaryUpdates.hiddenAt = now;\n        }\n        \n        // Always refresh cached display data\n        summaryUpdates.campaignTitle = campaignData.title || currentSummary.campaignTitle;\n        summaryUpdates.campaignImage = campaignData.imageUrl || currentSummary.campaignImage;\n        \n        transaction.update(summaryRef, summaryUpdates);\n      } else {\n        // Create new summary\n        transaction.set(summaryRef, {\n          targetId: campaignId,\n          targetType: 'campaign',\n          reportsCount: 1,\n          reasonCounts: { [reason]: 1 },\n          firstReportedAt: now,\n          lastReportedAt: now,\n          status: 'pending',\n          createdAt: now,\n          updatedAt: now,\n          // Display data for quick access\n          campaignTitle: campaignData.title || 'Untitled Campaign',\n          campaignImage: campaignData.imageUrl || '',\n          campaignSlug: campaignData.slug || '',\n          campaignType: campaignData.type || '',\n          creatorId: campaignData.creatorId || '',\n          moderationStatus: campaignData.moderationStatus || 'active',\n        });\n      }\n    });\n    \n    // Send notification AFTER transaction completes\n    if (shouldNotify && notificationData) {\n      // Choose notification template based on status\n      const templateType = notificationData.notificationType === 'under-review' \n        ? 'campaignUnderReview' \n        : 'campaignUnderReview'; // Using same template for now\n      \n      const notification = getNotificationTemplate(templateType, {\n        campaignTitle: notificationData.campaignTitle\n      });\n      \n      await sendInAppNotification({\n        userId: notificationData.userId,\n        title: notification.title,\n        body: notification.body,\n        actionUrl: notification.actionUrl,\n        icon: notification.icon,\n        type: notification.type || 'campaign-under-review',\n        metadata: {\n          campaignId: notificationData.campaignId,\n          reason: notificationData.reason,\n          notificationType: notificationData.notificationType\n        }\n      }).catch(err => console.error('Failed to send notification:', err));\n    }\n    \n    return NextResponse.json(\n      { success: true, message: 'Report submitted successfully' },\n      { status: 200 }\n    );\n    \n  } catch (error) {\n    console.error('Error creating report:', error);\n    \n    return NextResponse.json(\n      { \n        success: false, \n        error: error.message || 'Failed to submit report. Please try again.' \n      },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":8445,"size_tokens":null},"src/hooks/useSecureStorage.js":{"content":"// Custom hook for secure storage operations\nimport { useState, useCallback } from 'react'\nimport { uploadFile, uploadFileWithProgress, getSignedUrl, deleteFile, listFiles } from '../lib/supabase'\nimport { useAuth } from './useAuth'\n\nexport const useSecureStorage = () => {\n  const { user } = useAuth()\n  const [loading, setLoading] = useState(false)\n  const [error, setError] = useState(null)\n  const [progress, setProgress] = useState(0)\n\n  const handleError = useCallback((error) => {\n    console.error('Storage operation error:', error)\n    setError(error.message || 'An error occurred')\n    return null\n  }, [])\n\n  const upload = useCallback(async (file, folder = 'uploads', withProgress = false) => {\n    if (!user) {\n      throw new Error('User must be authenticated to upload files')\n    }\n\n    setLoading(true)\n    setError(null)\n    setProgress(0)\n\n    try {\n      let result\n      if (withProgress) {\n        result = await uploadFileWithProgress(file, folder, setProgress)\n      } else {\n        result = await uploadFile(file, folder)\n      }\n      \n      setProgress(100)\n      return result\n    } catch (error) {\n      return handleError(error)\n    } finally {\n      setLoading(false)\n    }\n  }, [user, handleError])\n\n  const getUrl = useCallback(async (path, expiresIn = 3600) => {\n    if (!user) {\n      throw new Error('User must be authenticated to access files')\n    }\n\n    setLoading(true)\n    setError(null)\n\n    try {\n      return await getSignedUrl(path, expiresIn)\n    } catch (error) {\n      return handleError(error)\n    } finally {\n      setLoading(false)\n    }\n  }, [user, handleError])\n\n  const remove = useCallback(async (path) => {\n    if (!user) {\n      throw new Error('User must be authenticated to delete files')\n    }\n\n    setLoading(true)\n    setError(null)\n\n    try {\n      return await deleteFile(path)\n    } catch (error) {\n      return handleError(error)\n    } finally {\n      setLoading(false)\n    }\n  }, [user, handleError])\n\n  const list = useCallback(async (folder = 'uploads', limit = 100, offset = 0) => {\n    if (!user) {\n      throw new Error('User must be authenticated to list files')\n    }\n\n    setLoading(true)\n    setError(null)\n\n    try {\n      return await listFiles(folder, limit, offset)\n    } catch (error) {\n      return handleError(error)\n    } finally {\n      setLoading(false)\n    }\n  }, [user, handleError])\n\n  const clearError = useCallback(() => {\n    setError(null)\n  }, [])\n\n  return {\n    // State\n    loading,\n    error,\n    progress,\n    \n    // Actions\n    upload,\n    getUrl,\n    remove,\n    list,\n    clearError,\n    \n    // Utils\n    isAuthenticated: !!user\n  }\n}\n\nexport default useSecureStorage","path":null,"size_bytes":2672,"size_tokens":null},"src/components/CampaignStepIndicator.js":{"content":"export default function CampaignStepIndicator({ \n  currentStep, \n  totalSteps = 3, \n  labels = null \n}) {\n  const steps = Array.from({ length: totalSteps }, (_, i) => i + 1);\n\n  return (\n    <div className=\"flex items-center justify-center mb-6\">\n      <div className=\"w-full max-w-md\">\n        {/* Step circles and connecting lines */}\n        <div className=\"flex items-center justify-center gap-2\">\n          {steps.map((step, index) => (\n            <div key={step} className=\"flex items-center\">\n              {/* Step Circle */}\n              <div\n                className={`flex items-center justify-center w-8 h-8 rounded-full font-semibold text-sm transition-colors ${\n                  step <= currentStep\n                    ? 'bg-emerald-600 text-white'\n                    : 'bg-gray-300 text-gray-600'\n                }`}\n              >\n                {step}\n              </div>\n\n              {/* Connecting Line (not shown after last step) */}\n              {index < steps.length - 1 && (\n                <div\n                  className={`h-1 w-12 transition-colors ${\n                    step < currentStep ? 'bg-emerald-600' : 'bg-gray-300'\n                  }`}\n                />\n              )}\n            </div>\n          ))}\n        </div>\n\n        {/* Step labels (optional) */}\n        {labels && labels.length === totalSteps && (\n          <div className=\"flex justify-between mt-2 text-xs sm:text-sm text-gray-700\">\n            {labels.map((label, index) => (\n              <span key={index} className=\"flex-1 text-center\">\n                {label}\n              </span>\n            ))}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":1679,"size_tokens":null},"src/app/onboarding/page.js":{"content":"\"use client\";\n\nimport { useState, useRef, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { countries } from '../../data/countries';\nimport { useAuth } from '../../hooks/useAuth';\nimport { getUserProfile, checkUsernameExists, completeUserProfile } from '../../lib/firestore';\nimport { useOptionalUserProfile } from '../../components/UserProfileProvider';\nimport ConfirmationModal from '../../components/ConfirmationModal';\nimport { uploadFile } from '../../lib/supabase';\nimport { getProfileAvatar, getProfileBanner } from '../../utils/imageTransform';\n\nexport default function OnboardingPage() {\n  const router = useRouter();\n  const { user, loading: authLoading } = useAuth();\n  const profileContext = useOptionalUserProfile();\n  const [loading, setLoading] = useState(false);\n  const [errors, setErrors] = useState({});\n  const [usernameStatus, setUsernameStatus] = useState(null); // 'checking', 'available', 'taken', 'unchanged'\n  const [originalUsername, setOriginalUsername] = useState('');\n  const [userData, setUserData] = useState(null);\n  const [hasChanges, setHasChanges] = useState(false);\n  const [confirmModal, setConfirmModal] = useState({ isOpen: false, field: null, previewField: null, imageType: '' });\n  const [leaveConfirmModal, setLeaveConfirmModal] = useState({ isOpen: false, actionType: null, action: null });\n  const usernameCheckTimeoutRef = useRef(null);\n  const usernameRequestIdRef = useRef(0);\n  \n  // Form data state\n  const [formData, setFormData] = useState({\n    username: '',\n    displayName: user?.displayName || '',\n    country: '',\n    profilePic: null,\n    profilePicPreview: user?.photoURL || '',\n    profileBanner: null,\n    profileBannerPreview: '',\n    bio: ''\n  });\n\n  const profilePicRef = useRef();\n  const profileBannerRef = useRef();\n  \n  // Refs for form validation scrolling\n  const usernameRef = useRef();\n  const displayNameRef = useRef();\n  const countryRef = useRef();\n\n  // Redirect if not authenticated\n  useEffect(() => {\n    if (!authLoading && !user) {\n      router.push('/signin');\n    }\n  }, [user, authLoading, router]);\n\n  // Cleanup timeout on unmount\n  useEffect(() => {\n    return () => {\n      if (usernameCheckTimeoutRef.current) {\n        clearTimeout(usernameCheckTimeoutRef.current);\n      }\n    };\n  }, []);\n\n  // Track initial URL for proper back button handling\n  const [currentUrl, setCurrentUrl] = useState('');\n  \n  useEffect(() => {\n    setCurrentUrl(window.location.pathname);\n  }, []);\n\n  // Prevent navigation when there are unsaved changes\n  useEffect(() => {\n    const handleBeforeUnload = (e) => {\n      if (hasChanges) {\n        e.preventDefault();\n        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';\n        return 'You have unsaved changes. Are you sure you want to leave?';\n      }\n    };\n\n    const handlePopState = (e) => {\n      if (hasChanges) {\n        // Prevent the navigation temporarily\n        window.history.pushState(null, '', currentUrl);\n        // Show custom confirmation modal\n        setLeaveConfirmModal({\n          isOpen: true,\n          actionType: 'navigation',\n          action: () => {\n            // User confirmed they want to leave - allow navigation\n            setHasChanges(false);\n            window.history.back();\n          }\n        });\n      }\n    };\n\n    const handleLinkClick = (e) => {\n      if (hasChanges) {\n        // Check if it's a navigation link\n        const target = e.target.closest('a');\n        if (target && target.href && target.href !== window.location.href) {\n          e.preventDefault();\n          // Show custom confirmation modal\n          setLeaveConfirmModal({\n            isOpen: true,\n            actionType: 'link',\n            action: () => {\n              // User confirmed they want to leave - navigate to the link\n              setHasChanges(false);\n              window.location.href = target.href;\n            }\n          });\n        }\n      }\n    };\n\n    if (hasChanges) {\n      window.addEventListener('beforeunload', handleBeforeUnload);\n      window.addEventListener('popstate', handlePopState);\n      document.addEventListener('click', handleLinkClick, true);\n      \n      return () => {\n        window.removeEventListener('beforeunload', handleBeforeUnload);\n        window.removeEventListener('popstate', handlePopState);\n        document.removeEventListener('click', handleLinkClick, true);\n      };\n    }\n  }, [hasChanges, currentUrl]);\n\n  // Function to check username availability with debouncing\n  const checkUsernameAvailability = useCallback(async (username) => {\n    if (!username || username.length < 3) {\n      setUsernameStatus(null);\n      return;\n    }\n\n    // If username is unchanged from original, mark as unchanged\n    if (username === originalUsername) {\n      setUsernameStatus('unchanged');\n      return;\n    }\n\n    // Clear existing timeout\n    if (usernameCheckTimeoutRef.current) {\n      clearTimeout(usernameCheckTimeoutRef.current);\n    }\n\n    setUsernameStatus('checking');\n    \n    // Increment request ID to handle race conditions\n    const currentRequestId = ++usernameRequestIdRef.current;\n\n    // Set new timeout for debouncing\n    usernameCheckTimeoutRef.current = setTimeout(async () => {\n      try {\n        const exists = await checkUsernameExists(username);\n        \n        // Only update if this is still the latest request\n        if (currentRequestId === usernameRequestIdRef.current) {\n          const newStatus = exists ? 'taken' : 'available';\n          setUsernameStatus(newStatus);\n        }\n      } catch (error) {\n        if (process.env.NODE_ENV === 'development') {\n          console.error('Error checking username:', error);\n        }\n        if (currentRequestId === usernameRequestIdRef.current) {\n          setUsernameStatus(null); // Show neutral state on error\n        }\n      }\n    }, 500); // 500ms debounce\n  }, [originalUsername]);\n\n  // Load user data when component mounts - same as profile/edit page\n  useEffect(() => {\n    const loadUserData = async () => {\n      if (!user) return;\n      \n      try {\n        const userProfile = await getUserProfile(user.uid);\n        if (userProfile) {\n          // User has existing profile data, prefill everything\n          setUserData(userProfile);\n          const initialData = {\n            username: userProfile.username || '',\n            displayName: userProfile.displayName || user?.displayName || '',\n            country: userProfile.country || '',\n            profilePic: null,\n            profilePicPreview: userProfile.profileImage ? getProfileAvatar(userProfile.profileImage) : (user?.photoURL || ''),\n            profileBanner: null,\n            profileBannerPreview: userProfile.bannerImage ? getProfileBanner(userProfile.bannerImage) : '',\n            bio: userProfile.bio || ''\n          };\n          setFormData(initialData);\n          setInitialFormData(initialData); // Set baseline for change detection\n          setOriginalUsername(userProfile.username || '');\n          setUsernameStatus('unchanged');\n        } else {\n          // No existing profile, use auth data as fallback\n          const initialUsername = user?.displayName?.toLowerCase().replace(/[^a-z0-9]/g, '') || \n                                user?.email?.split('@')[0]?.toLowerCase().replace(/[^a-z0-9]/g, '') || \n                                'user123';\n          const initialData = {\n            username: initialUsername,\n            displayName: user?.displayName || '',\n            country: '',\n            profilePic: null,\n            profilePicPreview: user?.photoURL || '',\n            profileBanner: null,\n            profileBannerPreview: '',\n            bio: ''\n          };\n          setFormData(initialData);\n          setInitialFormData(initialData); // Set baseline for change detection\n          // Check if this initial username is available\n          checkUsernameAvailability(initialUsername);\n        }\n      } catch (error) {\n        if (process.env.NODE_ENV === 'development') {\n          console.error('Error loading user data:', error);\n        }\n        // Fallback to auth data\n        const fallbackUsername = user?.displayName?.toLowerCase().replace(/[^a-z0-9]/g, '') || \n                                user?.email?.split('@')[0]?.toLowerCase().replace(/[^a-z0-9]/g, '') || \n                                'user123';\n        const fallbackData = {\n          username: fallbackUsername,\n          displayName: user?.displayName || '',\n          country: '',\n          profilePic: null,\n          profilePicPreview: user?.photoURL || '',\n          profileBanner: null,\n          profileBannerPreview: '',\n          bio: ''\n        };\n        setFormData(fallbackData);\n        setInitialFormData(fallbackData); // Set baseline for change detection\n        checkUsernameAvailability(fallbackUsername);\n      }\n    };\n\n    loadUserData();\n  }, [user, checkUsernameAvailability]);\n\n  // Track if user has made any edits (not just has content)\n  const [userHasEdited, setUserHasEdited] = useState(false);\n  const [initialFormData, setInitialFormData] = useState(null);\n\n  // Check if form has changes compared to original data\n  const checkForChanges = (currentFormData) => {\n    if (!initialFormData) {\n      setHasChanges(false);\n      return;\n    }\n    \n    // Compare with initial form data\n    const hasChanged = currentFormData.username !== initialFormData.username ||\n                      currentFormData.displayName !== initialFormData.displayName ||\n                      currentFormData.country !== initialFormData.country ||\n                      currentFormData.profilePicPreview !== initialFormData.profilePicPreview ||\n                      currentFormData.profileBannerPreview !== initialFormData.profileBannerPreview ||\n                      currentFormData.bio !== initialFormData.bio;\n    \n    setHasChanges(hasChanged);\n  };\n\n  const handleInputChange = (field, value) => {\n    const newFormData = { ...formData, [field]: value };\n    setFormData(newFormData);\n    setUserHasEdited(true); // Mark that user has made edits\n    \n    if (errors[field]) {\n      setErrors(prev => ({ ...prev, [field]: '' }));\n    }\n    \n    // Check username availability in real-time\n    if (field === 'username') {\n      checkUsernameAvailability(value);\n    }\n    \n    // Check for changes\n    checkForChanges(newFormData);\n  };\n\n  const handleFileChange = (field, file, previewField) => {\n    if (!file) return;\n    \n    // Clear any previous file-related errors\n    const fileErrorKey = field === 'profilePic' ? 'profilePic' : 'profileBanner';\n    if (errors[fileErrorKey]) {\n      setErrors(prev => ({ ...prev, [fileErrorKey]: '' }));\n    }\n    \n    // File size validation (5MB limit)\n    const maxSize = 5 * 1024 * 1024; // 5MB in bytes\n    if (file.size > maxSize) {\n      const fileName = field === 'profilePic' ? 'Profile picture' : 'Banner image';\n      setErrors(prev => ({\n        ...prev,\n        [fileErrorKey]: `${fileName} must be smaller than 5MB. Current size: ${(file.size / (1024 * 1024)).toFixed(1)}MB`\n      }));\n      return;\n    }\n    \n    // File type validation\n    if (!file.type.startsWith('image/')) {\n      const fileName = field === 'profilePic' ? 'Profile picture' : 'Banner image';\n      setErrors(prev => ({\n        ...prev,\n        [fileErrorKey]: `${fileName} must be an image file (JPG, PNG, GIF, etc.)`\n      }));\n      return;\n    }\n    \n    // File is valid, proceed with reading\n    const reader = new FileReader();\n    reader.onload = (e) => {\n      const newFormData = {\n        ...formData,\n        [field]: file,\n        [previewField]: e.target.result\n      };\n      setFormData(newFormData);\n      setUserHasEdited(true); // Mark that user has made edits\n      // Check for changes\n      checkForChanges(newFormData);\n    };\n    reader.readAsDataURL(file);\n  };\n\n  const handleRemoveImage = (field, previewField) => {\n    const imageType = field === 'profilePic' ? 'profile photo' : 'banner';\n    setConfirmModal({\n      isOpen: true,\n      field,\n      previewField,\n      imageType\n    });\n  };\n\n  const confirmRemoveImage = () => {\n    const { field, previewField } = confirmModal;\n    \n    const newFormData = {\n      ...formData,\n      [field]: null,\n      [previewField]: ''\n    };\n    setFormData(newFormData);\n    setUserHasEdited(true); // Mark that user has made edits\n    \n    // Clear the file input value to allow re-uploading the same file\n    const inputRef = field === 'profilePic' ? profilePicRef : profileBannerRef;\n    if (inputRef.current) {\n      inputRef.current.value = '';\n    }\n    \n    // Clear any file-related errors\n    const fileErrorKey = field === 'profilePic' ? 'profilePic' : 'profileBanner';\n    if (errors[fileErrorKey]) {\n      setErrors(prev => ({ ...prev, [fileErrorKey]: '' }));\n    }\n    \n    // Check for changes\n    checkForChanges(newFormData);\n  };\n\n  const handleLeaveConfirm = () => {\n    if (leaveConfirmModal.action) {\n      leaveConfirmModal.action();\n    }\n    setLeaveConfirmModal({ isOpen: false, actionType: null, action: null });\n  };\n\n  const handleLeaveCancel = () => {\n    setLeaveConfirmModal({ isOpen: false, actionType: null, action: null });\n  };\n\n  const scrollToField = (fieldName) => {\n    const fieldRefs = {\n      username: usernameRef,\n      displayName: displayNameRef,\n      country: countryRef\n    };\n    \n    const fieldRef = fieldRefs[fieldName];\n    if (fieldRef?.current) {\n      fieldRef.current.scrollIntoView({\n        behavior: 'smooth',\n        block: 'center'\n      });\n      // Focus the field after scrolling\n      setTimeout(() => {\n        fieldRef.current.focus();\n      }, 300);\n    }\n  };\n\n  const validateForm = () => {\n    const newErrors = {};\n    let firstErrorField = null;\n\n    if (!formData.username.trim()) {\n      newErrors.username = 'Username is required';\n      if (!firstErrorField) firstErrorField = 'username';\n    } else if (formData.username.length < 3) {\n      newErrors.username = 'Username must be at least 3 characters';\n      if (!firstErrorField) firstErrorField = 'username';\n    } else if (!/^[a-z0-9]+$/.test(formData.username)) {\n      newErrors.username = 'Username can only contain lowercase letters and numbers';\n      if (!firstErrorField) firstErrorField = 'username';\n    } else if (usernameStatus === 'taken') {\n      newErrors.username = 'This username is already taken';\n      if (!firstErrorField) firstErrorField = 'username';\n    }\n\n    if (!formData.displayName.trim()) {\n      newErrors.displayName = 'Display name is required';\n      if (!firstErrorField) firstErrorField = 'displayName';\n    }\n\n    if (!formData.country) {\n      newErrors.country = 'Please select your country';\n      if (!firstErrorField) firstErrorField = 'country';\n    }\n\n    setErrors(newErrors);\n    \n    // If there are errors, scroll to the first error field\n    if (firstErrorField) {\n      setTimeout(() => scrollToField(firstErrorField), 100);\n    }\n    \n    return Object.keys(newErrors).length === 0;\n  };\n\n  const handleComplete = async () => {\n    if (!validateForm()) return;\n\n    setLoading(true);\n    try {\n      // Prepare profile data\n      const profileData = {\n        username: formData.username,\n        displayName: formData.displayName,\n        country: formData.country,\n        bio: formData.bio,\n      };\n\n      // Handle profile image upload to Supabase\n      if (formData.profilePic) {\n        // User selected a new profile image - upload to Supabase\n        const uploadResult = await uploadFile(formData.profilePic, 'profile-images');\n        // Get public URL from Supabase\n        const publicUrl = `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/uploads/${uploadResult.path}`;\n        profileData.profileImage = publicUrl;\n      } else if (formData.profilePicPreview === '' && (userData?.profileImage || user?.photoURL)) {\n        // User removed the image\n        profileData.profileImage = null;\n      }\n\n      // Handle banner image upload to Supabase\n      if (formData.profileBanner) {\n        // User selected a new banner image - upload to Supabase\n        const uploadResult = await uploadFile(formData.profileBanner, 'profile-images');\n        // Get public URL from Supabase\n        const publicUrl = `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/uploads/${uploadResult.path}`;\n        profileData.bannerImage = publicUrl;\n      } else if (formData.profileBannerPreview === '' && userData?.bannerImage) {\n        // User removed the image\n        profileData.bannerImage = null;\n      }\n\n      const result = await completeUserProfile(user.uid, profileData);\n      \n      if (result.success) {\n        // Clear hasChanges before navigation to prevent warnings\n        setHasChanges(false);\n        setUserHasEdited(false);\n        \n        // Refresh the user profile context to update sidebar\n        if (profileContext?.refreshUserProfile) {\n          await profileContext.refreshUserProfile();\n        }\n        // Navigate to home page\n        router.push('/');\n      } else {\n        throw new Error(result.error || 'Failed to complete profile');\n      }\n    } catch (error) {\n      console.error('Error completing profile setup:', error);\n      setErrors({ general: 'Failed to update profile. Please try again.' });\n    } finally {\n      setLoading(false);\n    }\n  };\n\n\n  // Show loading state while auth is loading\n  if (authLoading) {\n    return (\n      <div className=\"min-h-screen bg-white flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-gray-600\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Don't render if user is not authenticated (redirect will handle this)\n  if (!user) {\n    return null;\n  }\n\n  return (\n    <div className=\"min-h-screen bg-white\">\n      \n      <div className=\"min-h-screen flex\">\n        {/* Main Content */}\n        <div className=\"flex-1 w-full flex flex-col justify-center py-8 px-4 sm:px-6 lg:px-16 xl:px-20 pt-20\">\n          <div className=\"mx-auto w-full max-w-4xl\">\n            {/* Header */}\n            <div className=\"text-center mb-8 bg-yellow-400 px-6 py-6 rounded-t-xl\">\n              <h1 className=\"text-2xl sm:text-3xl font-bold text-emerald-700\">Welcome to Frame!</h1>\n              <p className=\"text-base sm:text-lg text-gray-700 mt-2\">Let's set up your profile to get started</p>\n            </div>\n            \n            {/* Content Card with Shadow Border */}\n            <div className=\"bg-white rounded-b-xl border border-t-0 border-gray-200 px-6 py-8 shadow-sm\">\n              {errors.general && (\n                <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm\">\n                  {errors.general}\n                </div>\n              )}\n\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                {/* Profile Banner - moved to top */}\n                <div className=\"md:col-span-2\">\n                  <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                    Profile Banner\n                  </label>\n                  <div className=\"space-y-3\">\n                    <div className=\"w-full aspect-[4/1] rounded-lg overflow-hidden border-2 border-gray-200\">\n                      {formData.profileBannerPreview ? (\n                        <img\n                          src={formData.profileBannerPreview}\n                          alt=\"Banner preview\"\n                          className=\"w-full h-full object-cover\"\n                        />\n                      ) : (\n                        <div className=\"w-full h-full bg-gradient-to-r from-emerald-400 to-emerald-600 flex flex-col items-center justify-center\">\n                          <svg className=\"w-12 h-12 text-white/70 mb-2\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 002 2v12a2 2 0 002 2z\" />\n                          </svg>\n                          <p className=\"text-white/70 text-sm font-medium\">Recommended: 800x200px</p>\n                        </div>\n                      )}\n                    </div>\n                    <input\n                      type=\"file\"\n                      ref={profileBannerRef}\n                      onChange={(e) => handleFileChange('profileBanner', e.target.files[0], 'profileBannerPreview')}\n                      accept=\"image/*\"\n                      className=\"hidden\"\n                    />\n                    <div className=\"flex gap-3\">\n                      <button\n                        type=\"button\"\n                        onClick={() => profileBannerRef.current?.click()}\n                        className=\"btn-base btn-secondary px-2 py-1 text-sm\"\n                      >\n                        {formData.profileBannerPreview ? 'Change Banner Photo' : 'Choose Banner Photo'}\n                      </button>\n                      {formData.profileBannerPreview && (\n                        <button\n                          type=\"button\"\n                          onClick={() => handleRemoveImage('profileBanner', 'profileBannerPreview')}\n                          className=\"btn-base btn-danger px-2 py-1 text-sm\"\n                        >\n                          Remove Banner\n                        </button>\n                      )}\n                    </div>\n                    {errors.profileBanner && (\n                      <p className=\"text-red-600 text-sm mt-1\">{errors.profileBanner}</p>\n                    )}\n                  </div>\n                </div>\n\n                {/* Profile Picture */}\n                <div className=\"md:col-span-1\">\n                  <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                    Profile Picture\n                  </label>\n                  <div className=\"flex items-center space-x-4\">\n                    <div className=\"w-20 h-20 rounded-full overflow-hidden border-2 border-gray-200\">\n                      {formData.profilePicPreview ? (\n                        <img\n                          src={formData.profilePicPreview}\n                          alt=\"Profile preview\"\n                          className=\"w-full h-full object-cover\"\n                        />\n                      ) : (\n                        <div className=\"w-full h-full bg-gray-100 flex items-center justify-center\">\n                          <svg className=\"w-8 h-8 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\" />\n                          </svg>\n                        </div>\n                      )}\n                    </div>\n                    <div className=\"flex-1\">\n                      <input\n                        type=\"file\"\n                        ref={profilePicRef}\n                        onChange={(e) => handleFileChange('profilePic', e.target.files[0], 'profilePicPreview')}\n                        accept=\"image/*\"\n                        className=\"hidden\"\n                      />\n                      <div className=\"flex gap-2 flex-col\">\n                        <button\n                          type=\"button\"\n                          onClick={() => profilePicRef.current?.click()}\n                          className=\"btn-base btn-secondary px-2 py-1 text-sm\"\n                        >\n                          {formData.profilePicPreview ? 'Change Photo' : 'Choose Photo'}\n                        </button>\n                        {formData.profilePicPreview && (\n                          <button\n                            type=\"button\"\n                            onClick={() => handleRemoveImage('profilePic', 'profilePicPreview')}\n                            className=\"btn-base btn-danger px-2 py-1 text-sm\"\n                          >\n                            Remove Photo\n                          </button>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                  {errors.profilePic && (\n                    <p className=\"text-red-600 text-sm mt-1\">{errors.profilePic}</p>\n                  )}\n                </div>\n\n                {/* Display Name */}\n                <div className=\"md:col-span-1\">\n                  <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                    Display Name *\n                  </label>\n                  <input\n                    ref={displayNameRef}\n                    type=\"text\"\n                    value={formData.displayName}\n                    onChange={(e) => handleInputChange('displayName', e.target.value)}\n                    className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all text-gray-900 placeholder:text-gray-400 ${\n                      errors.displayName ? 'border-red-300 bg-red-50' : 'border-gray-300'\n                    }`}\n                    placeholder=\"Enter your name\"\n                  />\n                  <p className=\"text-sm text-gray-700 mt-1\">\n                    This appears as your profile name\n                  </p>\n                  {errors.displayName && <p className=\"text-red-600 text-sm mt-1\">{errors.displayName}</p>}\n                </div>\n\n                {/* Username */}\n                <div className=\"md:col-span-1\">\n                  <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                    Username *\n                  </label>\n                  <div className=\"relative\">\n                    <input\n                      ref={usernameRef}\n                      type=\"text\"\n                      value={formData.username}\n                      onChange={(e) => handleInputChange('username', e.target.value.toLowerCase().replace(/[^a-z0-9]/g, ''))}\n                      className={`w-full px-4 py-3 pr-12 border rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all text-gray-900 placeholder:text-gray-400 ${\n                        errors.username ? 'border-red-300 bg-red-50' : \n                        usernameStatus === 'taken' ? 'border-red-300 bg-red-50' :\n                        usernameStatus === 'available' ? 'border-emerald-300 bg-emerald-50' :\n                        'border-gray-300'\n                      }`}\n                      placeholder=\"username\"\n                    />\n                    {/* Username status indicator */}\n                    <div className=\"absolute right-3 top-1/2 transform -translate-y-1/2\">\n                      {usernameStatus === 'checking' && (\n                        <div className=\"w-5 h-5 border-2 border-gray-300 border-t-emerald-500 rounded-full animate-spin\"></div>\n                      )}\n                      {(usernameStatus === 'available' || usernameStatus === 'unchanged') && (\n                        <svg className=\"w-5 h-5 text-emerald-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                        </svg>\n                      )}\n                      {usernameStatus === 'taken' && (\n                        <svg className=\"w-5 h-5 text-red-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                        </svg>\n                      )}\n                    </div>\n                  </div>\n                  <p className=\"text-sm text-gray-700 mt-1\">\n                    Your profile URL: frame.com/u/{formData.username || 'username'}\n                  </p>\n                  {/* Username status message */}\n                  {usernameStatus === 'taken' && (\n                    <p className=\"text-red-600 text-sm mt-1\">This username is already taken</p>\n                  )}\n                  {usernameStatus === 'available' && formData.username.length >= 3 && (\n                    <p className=\"text-emerald-600 text-sm mt-1\">Username is available</p>\n                  )}\n                  {usernameStatus === 'unchanged' && (\n                    <p className=\"text-gray-600 text-sm mt-1\">Current username</p>\n                  )}\n                  {errors.username && <p className=\"text-red-600 text-sm mt-1\">{errors.username}</p>}\n                </div>\n\n                {/* Country */}\n                <div className=\"md:col-span-1\">\n                  <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                    Country *\n                  </label>\n                  <select\n                    ref={countryRef}\n                    value={formData.country}\n                    onChange={(e) => handleInputChange('country', e.target.value)}\n                    className={`w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all text-gray-900 cursor-pointer ${\n                      errors.country ? 'border-red-300 bg-red-50' : 'border-gray-300'\n                    }`}\n                  >\n                    <option value=\"\">Select your country</option>\n                    {countries.map(country => (\n                      <option key={country.code} value={country.code}>\n                        {country.name}\n                      </option>\n                    ))}\n                  </select>\n                  {errors.country && <p className=\"text-red-600 text-sm mt-1\">{errors.country}</p>}\n                </div>\n\n                {/* Bio */}\n                <div className=\"md:col-span-2\">\n                  <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                    Bio\n                  </label>\n                  <textarea\n                    value={formData.bio}\n                    onChange={(e) => handleInputChange('bio', e.target.value)}\n                    className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all resize-none text-gray-900 placeholder:text-gray-400\"\n                    rows=\"4\"\n                    placeholder=\"Tell others about yourself...\"\n                    maxLength=\"500\"\n                  />\n                  <div className=\"flex justify-end mt-1\">\n                    <span className=\"text-sm text-gray-400\">{formData.bio.length}/500</span>\n                  </div>\n                </div>\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex justify-end mt-8 pt-6 border-t border-gray-200\">\n                <button\n                  type=\"button\"\n                  onClick={handleComplete}\n                  disabled={loading || usernameStatus === 'checking' || !hasChanges}\n                  className={`btn-base px-8 py-3 ${\n                    !hasChanges \n                      ? 'bg-gray-300 text-gray-500 cursor-not-allowed' \n                      : loading || usernameStatus === 'checking'\n                        ? 'bg-emerald-600 text-white opacity-50 cursor-not-allowed'\n                        : 'btn-primary'\n                  }`}\n                >\n                  {loading ? 'Setting up...' : usernameStatus === 'checking' ? 'Checking username...' : 'Complete Setup'}\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      {/* Confirmation Modal */}\n      <ConfirmationModal\n        isOpen={confirmModal.isOpen}\n        onClose={() => setConfirmModal({ isOpen: false, field: null, previewField: null, imageType: '' })}\n        onConfirm={confirmRemoveImage}\n        title=\"Remove Image\"\n        message={`Are you sure you want to remove your ${confirmModal.imageType}?`}\n        confirmText=\"Remove\"\n        cancelText=\"Cancel\"\n        type=\"danger\"\n      />\n\n      {/* Leave Confirmation Modal */}\n      <ConfirmationModal\n        isOpen={leaveConfirmModal.isOpen}\n        onClose={handleLeaveCancel}\n        onConfirm={handleLeaveConfirm}\n        title=\"Unsaved Changes\"\n        message=\"You have unsaved changes. Do you want to save them before leaving?\"\n        confirmText=\"Leave Without Saving\"\n        cancelText=\"Stay & Keep Changes\"\n        type=\"warning\"\n      />\n    </div>\n  );\n}","path":null,"size_bytes":32772,"size_tokens":null},"src/components/AuthenticatedLayout.js":{"content":"'use client';\n\nimport { useFirebaseOptimized as useFirebase } from '../lib/firebase-optimized';\nimport { AuthProvider } from '../hooks/useAuth';\nimport UserOnboardingWrapper from './UserOnboardingWrapper';\nimport { UserProfileProvider } from './UserProfileProvider';\n\nexport default function AuthenticatedLayout({ children }) {\n  const mountTime = typeof window !== 'undefined' ? performance.now() : 0;\n  \n  \n  const { isLoading, isConfigured } = useFirebase();\n  \n\n  // Only show loading state when Firebase is configured and initializing\n  // If Firebase is not configured, render children immediately without blocking\n  if (!isConfigured || isLoading) {\n    return children;\n  }\n\n  // Firebase is configured - provide user profile context and onboarding wrapper\n  return (\n    <UserProfileProvider>\n      <UserOnboardingWrapper>\n        {children}\n      </UserOnboardingWrapper>\n    </UserProfileProvider>\n  );\n}","path":null,"size_bytes":915,"size_tokens":null},"src/app/signup/page.js":{"content":"\"use client\";\n\nimport { useEffect, useRef, useState } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { validateEmail, validatePassword, validateName, validateForm } from '../../utils/validation';\nimport { useAuth } from '../../hooks/useAuth';\nimport { Caveat } from \"next/font/google\";\nimport Link from \"next/link\";\n\nconst caveat = Caveat({ subsets: [\"latin\"], weight: [\"700\"] });\n\nexport default function SignUpPage() {\n  const router = useRouter();\n  const { user, loading: authLoading, signInWithGoogle, signUpWithEmail } = useAuth();\n  \n  const [validationErrors, setValidationErrors] = useState({});\n  const [fieldValidation, setFieldValidation] = useState({});\n  const [error, setError] = useState('');\n  const [loading, setLoading] = useState(false);\n  const [showPassword, setShowPassword] = useState(false);\n  \n  // Refs for form validation scrolling\n  const nameRef = useRef();\n  const emailRef = useRef();\n  const passwordRef = useRef();\n\n  // Redirect if already signed in\n  useEffect(() => {\n    if (user && !authLoading) {\n      router.replace(user.emailVerified ? '/' : '/verify-email');\n    }\n  }, [user, authLoading, router]);\n\n  const scrollToField = (fieldName) => {\n    const fieldRefs = {\n      name: nameRef,\n      email: emailRef,\n      password: passwordRef\n    };\n    \n    const fieldRef = fieldRefs[fieldName];\n    if (fieldRef?.current) {\n      fieldRef.current.scrollIntoView({\n        behavior: 'smooth',\n        block: 'center'\n      });\n      // Focus the field after scrolling\n      setTimeout(() => {\n        fieldRef.current.focus();\n      }, 300);\n    }\n  };\n\n  const validateFormFields = (formData) => {\n    const validation = validateForm(formData, 'signup');\n    \n    setValidationErrors(validation.errors);\n    \n    // If there are errors, scroll to the first error field\n    if (validation.firstErrorField) {\n      setTimeout(() => scrollToField(validation.firstErrorField), 100);\n    }\n    \n    return validation.isValid;\n  };\n\n  const handleEmailSignUp = async (e) => {\n    e.preventDefault();\n    const formData = new FormData(e.target);\n    \n    if (!validateFormFields(formData)) {\n      return;\n    }\n\n    setLoading(true);\n    setError('');\n\n    try {\n      const result = await signUpWithEmail(\n        formData.get('email'), \n        formData.get('password'), \n        formData.get('name')\n      );\n      if (result.success) {\n        router.replace('/verify-email');\n      } else {\n        setError(result.error || 'Failed to create account');\n      }\n    } catch (err) {\n      setError('Failed to create account');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleGoogleSignIn = async () => {\n    setLoading(true);\n    setError('');\n\n    try {\n      const result = await signInWithGoogle();\n      if (result.success) {\n        router.push('/');\n      } else {\n        setError(result.error || 'Failed to sign up with Google');\n      }\n    } catch (err) {\n      setError('Failed to sign up with Google');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleInputChange = (field, value) => {\n    // Clear form validation errors when user starts typing\n    if (validationErrors[field]) {\n      setValidationErrors(prev => ({ ...prev, [field]: '' }));\n    }\n    \n    // Perform real-time validation\n    let validationError = null;\n    let isValid = false;\n    \n    if (field === 'name' && value.trim()) {\n      validationError = validateName(value);\n      isValid = !validationError;\n    } else if (field === 'email' && value.trim()) {\n      validationError = validateEmail(value);\n      isValid = !validationError;\n    } else if (field === 'password' && value.trim()) {\n      validationError = validatePassword(value, true);\n      isValid = !validationError;\n    }\n    \n    // Update field validation status\n    setFieldValidation(prev => ({\n      ...prev,\n      [field]: {\n        isValid,\n        error: validationError,\n        hasValue: value.trim().length > 0\n      }\n    }));\n  };\n\n  // Don't show loading overlay during auth actions - keep form visible\n\n  return (\n    <div className=\"min-h-screen bg-white\">\n      {/* Frame Logo */}\n      <div className=\"absolute top-6 left-6 z-50 mb-8\">\n        <Link \n          href=\"/\" \n          className={`${caveat.className} text-2xl md:text-3xl font-bold text-emerald-700 hover:text-emerald-800 transition-all duration-300 hover:scale-110`}\n        >\n          Frame\n        </Link>\n      </div>\n      \n      <div className=\"min-h-screen flex\">\n        {/* Left Side - Form */}\n        <div className=\"flex-1 w-full flex flex-col justify-center py-8 px-4 sm:px-6 lg:px-16 xl:px-20 pt-20\">\n          <div className=\"mx-auto w-full max-w-sm lg:max-w-md\">\n            <div className=\"text-center mb-6 bg-yellow-400 px-4 py-3 rounded-t-lg\">\n              <h2 className=\"text-2xl font-bold text-emerald-700\">Create your account</h2>\n              <p className=\"mt-1 text-black text-sm\">Join the creative community and start building amazing frames.</p>\n            </div>\n            \n            {/* Content Card with Shadow Border */}\n            <div className=\"bg-white rounded-b-lg border border-t-0 border-gray-200 px-6 py-6 shadow-sm\">\n            {/* Email Sign Up Form */}\n            <form className=\"space-y-3 mb-4\" onSubmit={handleEmailSignUp} noValidate>\n              {error && (\n                <div className=\"text-red-600 text-sm text-center p-2 bg-red-50 rounded-lg\" role=\"alert\">\n                  {error}\n                </div>\n              )}\n              <div>\n                <label htmlFor=\"signup-name\" className=\"block text-sm font-medium text-gray-800 mb-1\">\n                  Name\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={nameRef}\n                    id=\"signup-name\"\n                    type=\"text\"\n                    name=\"name\"\n                    required\n                    placeholder=\"Enter your name\"\n                    onChange={(e) => handleInputChange('name', e.target.value)}\n                    className={`w-full px-3 py-2 pr-10 border rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all duration-300 text-gray-900 placeholder-gray-500 text-sm ${\n                      validationErrors.name ? 'border-red-300 bg-red-50' : \n                      fieldValidation.name?.isValid ? 'border-emerald-300 bg-emerald-50' :\n                      fieldValidation.name?.hasValue ? 'border-red-300 bg-red-50' :\n                      'border-gray-300'\n                    }`}\n                  />\n                  {/* Validation Icon */}\n                  {(validationErrors.name || (fieldValidation.name?.hasValue && !fieldValidation.name?.isValid)) && (\n                    <div className=\"absolute right-3 top-1/2 transform -translate-y-1/2\">\n                      {fieldValidation.name?.isValid && !validationErrors.name ? (\n                        <svg className=\"w-5 h-5 text-emerald-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                        </svg>\n                      ) : (\n                        <svg \n                          className=\"w-5 h-5 text-red-500\" \n                          fill=\"none\" \n                          stroke=\"currentColor\" \n                          viewBox=\"0 0 24 24\"\n                        >\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                        </svg>\n                      )}\n                    </div>\n                  )}\n                </div>\n                {validationErrors.name && (\n                  <p className=\"text-red-600 text-sm mt-1\">{validationErrors.name}</p>\n                )}\n              </div>\n              <div>\n                <label htmlFor=\"signup-email\" className=\"block text-sm font-medium text-gray-800 mb-1\">\n                  Email\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={emailRef}\n                    id=\"signup-email\"\n                    type=\"email\"\n                    name=\"email\"\n                    required\n                    placeholder=\"Enter your email\"\n                    onChange={(e) => handleInputChange('email', e.target.value)}\n                    className={`w-full px-3 py-2 pr-10 border rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all duration-300 text-gray-900 placeholder-gray-500 text-sm ${\n                      validationErrors.email ? 'border-red-300 bg-red-50' : \n                      fieldValidation.email?.isValid ? 'border-emerald-300 bg-emerald-50' :\n                      fieldValidation.email?.hasValue ? 'border-red-300 bg-red-50' :\n                      'border-gray-300'\n                    }`}\n                  />\n                  {/* Validation Icon */}\n                  {(validationErrors.email || (fieldValidation.email?.hasValue && !fieldValidation.email?.isValid)) && (\n                    <div className=\"absolute right-3 top-1/2 transform -translate-y-1/2\">\n                      {fieldValidation.email?.isValid && !validationErrors.email ? (\n                        <svg className=\"w-5 h-5 text-emerald-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                        </svg>\n                      ) : (\n                        <svg \n                          className=\"w-5 h-5 text-red-500\" \n                          fill=\"none\" \n                          stroke=\"currentColor\" \n                          viewBox=\"0 0 24 24\"\n                        >\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                        </svg>\n                      )}\n                    </div>\n                  )}\n                </div>\n                {validationErrors.email && (\n                  <p className=\"text-red-600 text-sm mt-1\">{validationErrors.email}</p>\n                )}\n              </div>\n              <div>\n                <label htmlFor=\"signup-password\" className=\"block text-sm font-medium text-gray-800 mb-1\">\n                  Password\n                </label>\n                <div className=\"relative\">\n                  <input\n                    ref={passwordRef}\n                    id=\"signup-password\"\n                    type={showPassword ? \"text\" : \"password\"}\n                    name=\"password\"\n                    required\n                    placeholder=\"Create a password (min 8 characters)\"\n                    minLength={8}\n                    onChange={(e) => handleInputChange('password', e.target.value)}\n                    className={`w-full px-3 py-2 pr-16 border rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all duration-300 text-gray-900 placeholder-gray-500 text-sm ${\n                      validationErrors.password ? 'border-red-300 bg-red-50' : \n                      fieldValidation.password?.isValid ? 'border-emerald-300 bg-emerald-50' :\n                      fieldValidation.password?.hasValue ? 'border-red-300 bg-red-50' :\n                      'border-gray-300'\n                    }`}\n                  />\n                  {/* Password visibility toggle */}\n                  <button\n                    type=\"button\"\n                    onClick={() => setShowPassword(!showPassword)}\n                    className=\"absolute right-8 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-50 rounded\"\n                    aria-label={showPassword ? \"Hide password\" : \"Show password\"}\n                    aria-pressed={showPassword}\n                    title={showPassword ? \"Hide password\" : \"Show password\"}\n                  >\n                    {showPassword ? (\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21\" />\n                      </svg>\n                    ) : (\n                      <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\" />\n                        <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\" />\n                      </svg>\n                    )}\n                  </button>\n                  {/* Validation Icon */}\n                  {(validationErrors.password || (fieldValidation.password?.hasValue && !fieldValidation.password?.isValid)) && (\n                    <div className=\"absolute right-3 top-1/2 transform -translate-y-1/2\">\n                      {fieldValidation.password?.isValid && !validationErrors.password ? (\n                        <svg className=\"w-5 h-5 text-emerald-500\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                        </svg>\n                      ) : (\n                        <svg \n                          className=\"w-5 h-5 text-red-500\" \n                          fill=\"none\" \n                          stroke=\"currentColor\" \n                          viewBox=\"0 0 24 24\"\n                        >\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M6 18L18 6M6 6l12 12\" />\n                        </svg>\n                      )}\n                    </div>\n                  )}\n                </div>\n                {validationErrors.password && (\n                  <p className=\"text-red-600 text-sm mt-1\">{validationErrors.password}</p>\n                )}\n              </div>\n              <button\n                type=\"submit\"\n                disabled={loading}\n                className=\"w-full btn-base btn-primary py-2 px-4 text-sm\"\n              >\n                {loading ? 'Creating Account...' : 'Create Account'}\n              </button>\n            </form>\n\n            {/* Divider */}\n            <div className=\"relative mb-4\">\n              <div className=\"absolute inset-0 flex items-center\">\n                <div className=\"w-full border-t border-gray-200\"></div>\n              </div>\n              <div className=\"relative flex justify-center text-sm\">\n                <span className=\"bg-white px-4 text-gray-500\">or</span>\n              </div>\n            </div>\n\n            {/* Google Sign Up */}\n            <div className=\"text-center mb-4\">\n              <button\n                onClick={handleGoogleSignIn}\n                disabled={loading}\n                className=\"w-full btn-base btn-google py-2 px-4 gap-3 text-sm\"\n              >\n                <svg className=\"w-4 h-4 sm:w-5 sm:h-5\" viewBox=\"0 0 24 24\" aria-hidden=\"true\">\n                  <path fill=\"#4285F4\" d=\"M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z\"/>\n                  <path fill=\"#34A853\" d=\"M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z\"/>\n                  <path fill=\"#FBBC05\" d=\"M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z\"/>\n                  <path fill=\"#EA4335\" d=\"M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z\"/>\n                </svg>\n                {loading ? 'Creating Account...' : 'Continue with Google'}\n              </button>\n            </div>\n\n            <div className=\"text-center mb-4\">\n              <p className=\"text-xs text-gray-500 leading-relaxed\">\n                By signing up, you agree to our{' '}\n                <a href=\"/terms\" className=\"btn-link\">\n                  Terms of Service\n                </a>{' '}\n                and{' '}\n                <a href=\"/privacy\" className=\"btn-link\">\n                  Privacy Policy\n                </a>\n              </p>\n            </div>\n\n            <div className=\"text-center\">\n              <p className=\"text-sm text-gray-500\">\n                Already have an account? \n                <a \n                  href=\"/signin\"\n                  className=\"btn-link font-medium ml-1\"\n                >\n                  Sign In\n                </a>\n              </p>\n            </div>\n            </div>\n          </div>\n        </div>\n\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":17235,"size_tokens":null},"src/utils/networkUtils.js":{"content":"// Network connectivity and error detection utilities\n\n/**\n * Check if the current error is likely due to network connectivity issues\n * @param {Error|Object} error - The error object from Firebase or other sources\n * @returns {boolean} - True if error appears to be network-related\n */\nexport const isNetworkError = (error) => {\n  if (!error) return false;\n  \n  // Check Firebase specific network error codes\n  const networkErrorCodes = [\n    'auth/network-request-failed',\n    'auth/timeout',\n    'auth/internal-error',\n    'auth/cors-unsupported'\n  ];\n  \n  if (error.code && networkErrorCodes.includes(error.code)) {\n    return true;\n  }\n  \n  // Check error message patterns that indicate network issues\n  const networkErrorPatterns = [\n    /network/i,\n    /connection/i,\n    /timeout/i,\n    /fetch/i,\n    /cors/i,\n    /offline/i,\n    /no internet/i,\n    /failed to fetch/i\n  ];\n  \n  const errorMessage = error.message || error.toString() || '';\n  return networkErrorPatterns.some(pattern => pattern.test(errorMessage));\n};\n\n/**\n * Check if the browser is currently online\n * @returns {boolean} - True if browser reports being online\n */\nexport const isOnline = () => {\n  return typeof navigator !== 'undefined' ? navigator.onLine : true;\n};\n\n/**\n * Test actual network connectivity by making a lightweight request\n * @returns {Promise<boolean>} - True if network is accessible\n */\nexport const testNetworkConnectivity = async () => {\n  if (!isOnline()) {\n    return false;\n  }\n  \n  try {\n    // Use a lightweight request to test connectivity\n    // We'll try to fetch a tiny resource from a reliable CDN\n    const response = await fetch('https://www.google.com/favicon.ico', {\n      method: 'HEAD',\n      mode: 'no-cors',\n      cache: 'no-cache',\n      signal: AbortSignal.timeout(5000) // 5 second timeout\n    });\n    return true;\n  } catch (error) {\n    // If the fetch fails, we're likely offline or have connectivity issues\n    return false;\n  }\n};\n\n/**\n * Get appropriate error message based on network connectivity and error type\n * @param {Error|Object} error - The original error\n * @param {string} fallbackMessage - Message to show if not a network error\n * @returns {Promise<string>} - Appropriate error message for the user\n */\nexport const getContextualErrorMessage = async (error, fallbackMessage) => {\n  // First check if it's obviously a network error\n  if (isNetworkError(error)) {\n    return 'Unable to connect to our services. Please check your internet connection and try again.';\n  }\n  \n  // Check if browser reports being offline\n  if (!isOnline()) {\n    return 'You appear to be offline. Please check your internet connection and try again.';\n  }\n  \n  // Test actual connectivity for ambiguous errors\n  try {\n    const hasConnectivity = await testNetworkConnectivity();\n    if (!hasConnectivity) {\n      return 'Unable to connect to our services. Please check your internet connection and try again.';\n    }\n  } catch (connectivityError) {\n    // If we can't test connectivity, assume it's a network issue\n    return 'Unable to connect to our services. Please check your internet connection and try again.';\n  }\n  \n  // If we reach here, it's likely not a network error\n  return fallbackMessage;\n};\n\n/**\n * Check if an authentication error should be treated as a network error\n * This is more conservative and used for authentication flows where security matters\n * @param {Error|Object} error - The error object\n * @returns {Promise<boolean>} - True if this should be treated as a network error\n */\nexport const isLikelyNetworkError = async (error) => {\n  // More strict checking for auth errors\n  if (isNetworkError(error) || !isOnline()) {\n    return true;\n  }\n  \n  // For authentication, only check connectivity for certain ambiguous error types\n  const ambiguousErrors = [\n    'auth/internal-error',\n    'auth/timeout',\n    'auth/invalid-credential' // This can sometimes be network-related\n  ];\n  \n  if (error.code && ambiguousErrors.includes(error.code)) {\n    try {\n      const hasConnectivity = await testNetworkConnectivity();\n      return !hasConnectivity;\n    } catch {\n      return true; // Assume network error if we can't test\n    }\n  }\n  \n  return false;\n};\n\n/**\n * Setup network status monitoring\n * @param {Function} onOnline - Callback when network comes online\n * @param {Function} onOffline - Callback when network goes offline\n * @returns {Function} - Cleanup function to remove listeners\n */\nexport const setupNetworkMonitoring = (onOnline, onOffline) => {\n  if (typeof window === 'undefined') {\n    // Return no-op cleanup function for server-side\n    return () => {};\n  }\n  \n  const handleOnline = () => onOnline && onOnline();\n  const handleOffline = () => onOffline && onOffline();\n  \n  window.addEventListener('online', handleOnline);\n  window.addEventListener('offline', handleOffline);\n  \n  // Return cleanup function\n  return () => {\n    window.removeEventListener('online', handleOnline);\n    window.removeEventListener('offline', handleOffline);\n  };\n};","path":null,"size_bytes":5012,"size_tokens":null},"src/components/admin/CampaignModerationCard.js":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { getModerationStatusColor } from \"@/utils/admin/adminHelpers\";\nimport { abbreviateNumber } from \"@/utils/validation\";\n\nexport default function CampaignModerationCard({ campaign, onUpdate }) {\n  const { user } = useAuth();\n  const [showActions, setShowActions] = useState(false);\n  const [isUpdating, setIsUpdating] = useState(false);\n  const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);\n  const [deleteReason, setDeleteReason] = useState('');\n  const [updateError, setUpdateError] = useState(null);\n\n  const handleModerationChange = async (newStatus, reason = '') => {\n    if (!user) return;\n\n    setIsUpdating(true);\n    setUpdateError(null);\n\n    try {\n      const token = await user.getIdToken();\n      \n      const response = await fetch(`/api/admin/campaigns/${campaign.id}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({ \n          moderationStatus: newStatus,\n          removeReason: reason \n        }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || 'Failed to update campaign');\n      }\n\n      if (onUpdate) {\n        onUpdate(data.data);\n      }\n      \n      setShowActions(false);\n    } catch (error) {\n      console.error('Error updating campaign:', error);\n      setUpdateError(error.message);\n    } finally {\n      setIsUpdating(false);\n    }\n  };\n\n  const handleDelete = async () => {\n    if (!user) return;\n\n    setIsUpdating(true);\n    setUpdateError(null);\n\n    try {\n      const token = await user.getIdToken();\n      \n      const response = await fetch(`/api/admin/campaigns/${campaign.id}/delete`, {\n        method: 'DELETE',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`,\n        },\n        body: JSON.stringify({ \n          confirmed: true,\n          deleteReason: deleteReason || 'Deleted by admin'\n        }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || 'Failed to delete campaign');\n      }\n\n      if (onUpdate) {\n        onUpdate(null, true);\n      }\n      \n      setShowDeleteConfirm(false);\n    } catch (error) {\n      console.error('Error deleting campaign:', error);\n      setUpdateError(error.message);\n    } finally {\n      setIsUpdating(false);\n    }\n  };\n\n  return (\n    <>\n      <div className=\"bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow\">\n        <div className=\"relative\">\n          <img\n            src={campaign.imageUrl}\n            alt={campaign.title}\n            className=\"w-full h-48 object-cover\"\n            loading=\"lazy\"\n          />\n          <div className=\"absolute top-2 right-2\">\n            <span className={`px-2 py-1 text-xs font-semibold rounded-full ${getModerationStatusColor(campaign.moderationStatus)}`}>\n              {campaign.moderationStatus}\n            </span>\n          </div>\n          <div className=\"absolute top-2 left-2\">\n            <span className=\"px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 capitalize\">\n              {campaign.type}\n            </span>\n          </div>\n        </div>\n\n        <div className=\"p-4\">\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-2 truncate\">\n            {campaign.title}\n          </h3>\n          \n          <div className=\"flex items-center text-sm text-gray-600 mb-3\">\n            <span>by {campaign.creator?.displayName || 'Unknown'}</span>\n          </div>\n\n          <div className=\"flex items-center justify-between text-sm text-gray-500 mb-4\">\n            <div className=\"flex items-center space-x-4\">\n              <span className=\"flex items-center\">\n                <svg className=\"w-4 h-4 mr-1\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                  <path d=\"M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z\" />\n                </svg>\n                {abbreviateNumber(campaign.supportersCount || 0)}\n              </span>\n              <span className=\"flex items-center\">\n                <svg className=\"w-4 h-4 mr-1\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                  <path fillRule=\"evenodd\" d=\"M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z\" clipRule=\"evenodd\" />\n                </svg>\n                {campaign.reportsCount || 0}\n              </span>\n            </div>\n          </div>\n\n          {updateError && (\n            <div className=\"mb-3 text-xs text-red-600 bg-red-50 p-2 rounded\">\n              {updateError}\n            </div>\n          )}\n\n          <div className=\"relative\">\n            <button\n              onClick={() => setShowActions(!showActions)}\n              disabled={isUpdating}\n              className=\"w-full btn-base bg-gray-600 text-white hover:bg-gray-700 disabled:opacity-50 text-sm py-2\"\n            >\n              {isUpdating ? 'Processing...' : 'Actions'}\n            </button>\n\n            {showActions && (\n              <div className=\"absolute bottom-full left-0 right-0 mb-2 bg-white border border-gray-200 rounded-lg shadow-lg z-10\">\n                <div className=\"py-1\">\n                  {campaign.reportsCount > 0 && (\n                    <a\n                      href={`/admin/reports?campaignId=${campaign.id}`}\n                      className=\"block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100\"\n                    >\n                      View Reports ({campaign.reportsCount})\n                    </a>\n                  )}\n                  \n                  {campaign.moderationStatus !== 'active' && (\n                    <button\n                      onClick={() => handleModerationChange('active')}\n                      className=\"w-full text-left px-4 py-2 text-sm text-green-700 hover:bg-green-50\"\n                    >\n                      Restore to Active\n                    </button>\n                  )}\n                  \n                  {campaign.moderationStatus !== 'under-review-hidden' && (\n                    <button\n                      onClick={() => handleModerationChange('under-review-hidden')}\n                      className=\"w-full text-left px-4 py-2 text-sm text-yellow-700 hover:bg-yellow-50\"\n                    >\n                      Mark Under Review (Hide)\n                    </button>\n                  )}\n                  \n                  {campaign.moderationStatus !== 'removed-temporary' && (\n                    <button\n                      onClick={() => handleModerationChange('removed-temporary', 'Removed by admin')}\n                      className=\"w-full text-left px-4 py-2 text-sm text-orange-700 hover:bg-orange-50\"\n                    >\n                      Remove Campaign (Temporary)\n                    </button>\n                  )}\n                  \n                  {campaign.moderationStatus !== 'removed-permanent' && (\n                    <button\n                      onClick={() => handleModerationChange('removed-permanent', 'Permanently removed by admin')}\n                      className=\"w-full text-left px-4 py-2 text-sm text-red-700 hover:bg-red-50\"\n                    >\n                      Remove Campaign (Permanent)\n                    </button>\n                  )}\n                  \n                  <button\n                    onClick={() => {\n                      setShowActions(false);\n                      setShowDeleteConfirm(true);\n                    }}\n                    className=\"w-full text-left px-4 py-2 text-sm text-red-700 hover:bg-red-50 border-t border-gray-200\"\n                  >\n                    Delete Permanently\n                  </button>\n                </div>\n              </div>\n            )}\n          </div>\n\n          <a\n            href={`/campaign/${campaign.slug}`}\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            className=\"block mt-2 text-sm text-emerald-600 hover:text-emerald-700\"\n          >\n            View Campaign \n          </a>\n        </div>\n      </div>\n\n      {showDeleteConfirm && (\n        <div className=\"fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 p-4\">\n          <div className=\"bg-white rounded-lg p-6 max-w-md w-full\">\n            <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Delete Campaign Permanently?</h3>\n            <p className=\"text-sm text-gray-600 mb-4\">\n              This action cannot be undone. The campaign and its image will be permanently deleted.\n            </p>\n            \n            <div className=\"mb-4\">\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                Reason for deletion (optional)\n              </label>\n              <textarea\n                value={deleteReason}\n                onChange={(e) => setDeleteReason(e.target.value)}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500\"\n                rows=\"3\"\n                placeholder=\"Enter reason...\"\n              />\n            </div>\n\n            <div className=\"flex space-x-3\">\n              <button\n                onClick={() => setShowDeleteConfirm(false)}\n                className=\"flex-1 btn-base bg-gray-600 text-white hover:bg-gray-700\"\n              >\n                Cancel\n              </button>\n              <button\n                onClick={handleDelete}\n                disabled={isUpdating}\n                className=\"flex-1 btn-base bg-red-600 text-white hover:bg-red-700 disabled:opacity-50\"\n              >\n                {isUpdating ? 'Deleting...' : 'Delete'}\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n    </>\n  );\n}\n","path":null,"size_bytes":10055,"size_tokens":null},"src/components/AuthGate.js":{"content":"'use client';\n\nimport { useEffect } from 'react';\nimport { useRouter, usePathname } from 'next/navigation';\nimport { useOptionalAuth } from '../hooks/useAuth';\nimport PageLoader from './PageLoader';\n\nexport default function AuthGate({ children }) {\n  const router = useRouter();\n  const pathname = usePathname();\n  const authContext = useOptionalAuth();\n  \n  // Extract auth data (safe to call even if authContext is null)\n  const user = authContext?.user;\n  const loading = authContext?.loading;\n  \n  // Redirect unverified users to /verify-email (except if already there)\n  // Must be called before any conditional returns\n  useEffect(() => {\n    if (authContext && user && !loading && !user.emailVerified && pathname !== '/verify-email') {\n      router.replace('/verify-email');\n    }\n  }, [authContext, user, loading, pathname, router]);\n  \n  // If no auth context, just render children\n  if (!authContext) {\n    return children;\n  }\n  \n  \n  // Show full-screen loader while auth is loading\n  if (loading) {\n    return <PageLoader message=\"Loading...\" />;\n  }\n\n  // Show loader while redirecting unverified users (except on verify-email page)\n  if (user && !user.emailVerified && pathname !== '/verify-email') {\n    return <PageLoader message=\"Redirecting to verification...\" />;\n  }\n\n  return children;\n}","path":null,"size_bytes":1309,"size_tokens":null},"src/app/(chrome)/campaigns/page.js":{"content":"\"use client\";\n\nimport { useState, useEffect, useCallback } from 'react';\nimport Link from 'next/link';\nimport { getAllCampaigns } from '../../../lib/firestore';\nimport LoadingSpinner from '../../../components/LoadingSpinner';\nimport FilterModal from '../../../components/FilterModal';\nimport CampaignGallery from '../../../components/CampaignGallery';\nimport Pagination from '../../../components/Pagination';\n\nexport default function CampaignsPage() {\n  const [campaigns, setCampaigns] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [isFilterModalOpen, setIsFilterModalOpen] = useState(false);\n  const [currentPage, setCurrentPage] = useState(1);\n  const [totalPages, setTotalPages] = useState(0);\n  const [totalCount, setTotalCount] = useState(0);\n  \n  const [filters, setFilters] = useState({\n    type: 'all',\n    country: null,\n    timePeriod: 'all',\n    sortBy: 'createdAt'\n  });\n\n  const loadCampaigns = useCallback(async (page = 1) => {\n    setLoading(true);\n    try {\n      const result = await getAllCampaigns({ ...filters, page, pageSize: 10 });\n      setCampaigns(result.campaigns);\n      setCurrentPage(result.currentPage);\n      setTotalPages(result.totalPages);\n      setTotalCount(result.totalCount);\n    } catch (error) {\n      console.error('Error loading campaigns:', error);\n    } finally {\n      setLoading(false);\n    }\n  }, [filters]);\n\n  useEffect(() => {\n    setCurrentPage(1);\n    loadCampaigns(1);\n  }, [filters]);\n\n  const handleApplyFilters = (newFilters) => {\n    setFilters(newFilters);\n  };\n\n  const handlePageChange = (page) => {\n    setCurrentPage(page);\n    loadCampaigns(page);\n    window.scrollTo({ top: 0, behavior: 'smooth' });\n  };\n\n  const filterFields = [\n    {\n      key: 'type',\n      label: 'Type',\n      options: [\n        { value: 'all', label: 'All Types' },\n        { value: 'frame', label: 'Frames Only' },\n        { value: 'background', label: 'Backgrounds Only' }\n      ]\n    },\n    {\n      key: 'timePeriod',\n      label: 'Time Period',\n      options: [\n        { value: 'all', label: 'All Time' },\n        { value: '24h', label: 'Last 24 Hours' },\n        { value: '7d', label: 'Last 7 Days' },\n        { value: '30d', label: 'Last 30 Days' }\n      ]\n    },\n    {\n      key: 'sortBy',\n      label: 'Sort By',\n      options: [\n        { value: 'createdAt', label: 'Most Recent' },\n        { value: 'supportersCount', label: 'Most Popular' }\n      ]\n    }\n  ];\n\n  return (\n    <div className=\"min-h-screen bg-white\">\n      <div className=\"min-h-screen flex\">\n        <div className=\"flex-1 w-full flex flex-col justify-center py-8 px-4 sm:px-6 lg:px-16 xl:px-20 pt-20\">\n          <div className=\"mx-auto w-full max-w-6xl\">\n            <div className=\"text-center mb-8 bg-yellow-400 px-6 py-6 rounded-t-xl\">\n              <h1 className=\"text-2xl sm:text-3xl font-bold text-emerald-700\">Discover Campaigns</h1>\n              <p className=\"text-base sm:text-lg text-gray-700 mt-2\">Browse and use thousands of frames and backgrounds created by the community</p>\n            </div>\n            \n            <div className=\"bg-white rounded-b-xl border border-t-0 border-gray-200 px-6 py-8 shadow-sm\">\n              <div className=\"mb-6 flex justify-between items-center\">\n                <div className=\"text-sm text-gray-600\">\n                  <span className=\"font-semibold text-emerald-600 text-lg\">{totalCount}</span>\n                  <span className=\"ml-1\">campaigns found</span>\n                  {totalPages > 1 && (\n                    <span className=\"ml-2 text-gray-400\">\n                      (Page {currentPage} of {totalPages})\n                    </span>\n                  )}\n                </div>\n                <button\n                  onClick={() => setIsFilterModalOpen(true)}\n                  className=\"btn-base btn-secondary px-4 py-2 text-sm flex items-center gap-2\"\n                >\n                  <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z\" />\n                  </svg>\n                  Filters\n                </button>\n              </div>\n\n              {loading ? (\n                <div className=\"flex justify-center items-center py-20\">\n                  <LoadingSpinner size=\"lg\" />\n                </div>\n              ) : campaigns.length === 0 ? (\n                <div className=\"bg-gray-50 rounded-xl p-12 text-center border border-gray-200\">\n                  <svg\n                    className=\"mx-auto h-16 w-16 text-gray-400 mb-4\"\n                    fill=\"none\"\n                    viewBox=\"0 0 24 24\"\n                    stroke=\"currentColor\"\n                  >\n                    <path\n                      strokeLinecap=\"round\"\n                      strokeLinejoin=\"round\"\n                      strokeWidth={1.5}\n                      d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\"\n                    />\n                  </svg>\n                  <h3 className=\"text-xl font-semibold text-gray-900 mb-2\">No campaigns found</h3>\n                  <p className=\"text-gray-600 mb-6\">Try adjusting your filters or check back later</p>\n                  <Link\n                    href=\"/create\"\n                    className=\"btn-base btn-primary inline-block px-6 py-3 font-medium\"\n                  >\n                    Create First Campaign\n                  </Link>\n                </div>\n              ) : (\n                <>\n                  <CampaignGallery\n                    campaigns={campaigns}\n                    loading={false}\n                    showCreatorInfo={true}\n                    showReportOption={true}\n                  />\n                  \n                  <Pagination\n                    currentPage={currentPage}\n                    totalPages={totalPages}\n                    onPageChange={handlePageChange}\n                  />\n                </>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <FilterModal\n        isOpen={isFilterModalOpen}\n        onClose={() => setIsFilterModalOpen(false)}\n        onApply={handleApplyFilters}\n        initialFilters={filters}\n        filterFields={filterFields}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":6519,"size_tokens":null},"src/app/api/admin/reports/[reportId]/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\nimport { FieldValue } from 'firebase-admin/firestore';\nimport { getNotificationTemplate } from '@/utils/notifications/notificationTemplates';\nimport { sendInAppNotification } from '@/utils/notifications/sendInAppNotification';\n\nexport async function PATCH(request, context) {\n  try {\n    console.log('[ADMIN REPORT UPDATE] Starting request...');\n    console.log('[ADMIN REPORT UPDATE] Context:', context);\n    \n    const params = await Promise.resolve(context.params);\n    console.log('[ADMIN REPORT UPDATE] Params:', params);\n    \n    const adminUser = await requireAdmin(request);\n    console.log('[ADMIN REPORT UPDATE] Admin user verified:', adminUser.uid);\n    \n    const { reportId } = params;\n    const body = await request.json();\n    const { status, action } = body;\n    console.log('[ADMIN REPORT UPDATE] Request body:', { status, action, reportId });\n    \n    const validStatuses = ['pending', 'reviewed', 'resolved', 'dismissed'];\n    if (status && !validStatuses.includes(status)) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid status. Must be: pending, reviewed, resolved, or dismissed' },\n        { status: 400 }\n      );\n    }\n    \n    const validActions = ['removed', 'warned', 'no-action'];\n    if (action && !validActions.includes(action)) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid action. Must be: removed, warned, or no-action' },\n        { status: 400 }\n      );\n    }\n    \n    if (!reportId) {\n      return NextResponse.json(\n        { success: false, error: 'Report ID is required' },\n        { status: 400 }\n      );\n    }\n    \n    console.log('[ADMIN REPORT UPDATE] Getting Firestore instance...');\n    const db = adminFirestore();\n    const reportRef = db.collection('reports').doc(reportId);\n    \n    console.log('[ADMIN REPORT UPDATE] Fetching report document...');\n    const reportDoc = await reportRef.get();\n    \n    if (!reportDoc.exists) {\n      console.log('[ADMIN REPORT UPDATE] Report not found:', reportId);\n      return NextResponse.json(\n        { success: false, error: 'Report not found' },\n        { status: 404 }\n      );\n    }\n    \n    const reportData = reportDoc.data();\n    const reportType = reportData.type || 'campaign';\n    console.log('[ADMIN REPORT UPDATE] Report data:', { \n      reportType, \n      campaignId: reportData.campaignId,\n      reportedUserId: reportData.reportedUserId,\n      currentStatus: reportData.status\n    });\n    \n    // Fetch related reports BEFORE transaction (for dismissals)\n    let relatedReportsSnapshot = null;\n    if (action === 'no-action' && status === 'dismissed') {\n      console.log('[ADMIN REPORT UPDATE] Fetching related reports for dismissal...');\n      if (reportType === 'campaign' && reportData.campaignId) {\n        relatedReportsSnapshot = await db.collection('reports')\n          .where('campaignId', '==', reportData.campaignId)\n          .where('status', 'in', ['pending', 'reviewed', 'resolved'])\n          .get();\n        console.log('[ADMIN REPORT UPDATE] Found', relatedReportsSnapshot.size, 'related campaign reports');\n      } else if (reportType === 'profile' && reportData.reportedUserId) {\n        relatedReportsSnapshot = await db.collection('reports')\n          .where('reportedUserId', '==', reportData.reportedUserId)\n          .where('status', 'in', ['pending', 'reviewed', 'resolved'])\n          .get();\n        console.log('[ADMIN REPORT UPDATE] Found', relatedReportsSnapshot.size, 'related profile reports');\n      }\n    }\n    \n    // Fetch campaign/user document BEFORE transaction (all reads must be before writes)\n    let targetDoc = null;\n    let targetData = null;\n    if (reportType === 'campaign' && reportData.campaignId) {\n      console.log('[ADMIN REPORT UPDATE] Fetching campaign document before transaction...');\n      targetDoc = await db.collection('campaigns').doc(reportData.campaignId).get();\n      if (targetDoc.exists) {\n        targetData = targetDoc.data();\n        console.log('[ADMIN REPORT UPDATE] Campaign data fetched:', { creatorId: targetData.creatorId, title: targetData.title });\n      }\n    } else if (reportType === 'profile' && reportData.reportedUserId) {\n      console.log('[ADMIN REPORT UPDATE] Fetching user document before transaction...');\n      targetDoc = await db.collection('users').doc(reportData.reportedUserId).get();\n      if (targetDoc.exists) {\n        targetData = targetDoc.data();\n        console.log('[ADMIN REPORT UPDATE] User data fetched');\n      }\n    }\n    \n    console.log('[ADMIN REPORT UPDATE] Starting transaction...');\n    await db.runTransaction(async (transaction) => {\n      console.log('[ADMIN REPORT UPDATE] Inside transaction - preparing report update...');\n      const reportUpdateData = {\n        updatedAt: new Date(),\n      };\n      \n      if (status) {\n        reportUpdateData.status = status;\n        reportUpdateData.reviewedAt = new Date();\n        reportUpdateData.reviewedBy = adminUser.uid;\n      }\n      \n      if (action) {\n        reportUpdateData.action = action;\n      }\n      \n      console.log('[ADMIN REPORT UPDATE] Updating report document with:', reportUpdateData);\n      transaction.update(reportRef, reportUpdateData);\n      console.log('[ADMIN REPORT UPDATE] Report update queued successfully');\n      \n      // Update reportSummary when action is taken\n      const summaryId = reportType === 'campaign' \n        ? `campaign-${reportData.campaignId}` \n        : `user-${reportData.reportedUserId}`;\n      \n      if (summaryId && (action === 'no-action' || action === 'warned' || action === 'removed')) {\n        console.log('[ADMIN REPORT UPDATE] Updating report summary:', summaryId);\n        const summaryRef = db.collection('reportSummary').doc(summaryId);\n        const summaryStatus = action === 'no-action' && status === 'dismissed' ? 'dismissed' : 'resolved';\n        \n        transaction.update(summaryRef, {\n          status: summaryStatus,\n          resolvedAt: new Date(),\n          reportCount: 0,\n          updatedAt: new Date(),\n        });\n        console.log('[ADMIN REPORT UPDATE] Report summary update queued');\n      }\n      \n      // Process campaign report (using pre-fetched data)\n      if (reportType === 'campaign' && reportData.campaignId && targetDoc && targetDoc.exists) {\n        console.log('[ADMIN REPORT UPDATE] Processing campaign report...');\n        const campaignRef = db.collection('campaigns').doc(reportData.campaignId);\n        const campaignData = targetData;\n        const campaignUpdates = {};\n          \n          if (action === 'no-action' && status === 'dismissed') {\n            console.log('[ADMIN REPORT UPDATE] Dismissing campaign report - resetting counts...');\n            campaignUpdates.reportsCount = 0;\n            campaignUpdates.moderationStatus = 'active';\n            if (campaignData.hiddenAt) {\n              campaignUpdates.hiddenAt = FieldValue.delete();\n            }\n            \n            if (relatedReportsSnapshot && !relatedReportsSnapshot.empty) {\n              console.log('[ADMIN REPORT UPDATE] Dismissing', relatedReportsSnapshot.size, 'related reports');\n              relatedReportsSnapshot.forEach(doc => {\n                transaction.update(doc.ref, { \n                  status: 'dismissed', \n                  action: 'no-action',\n                  reviewedAt: new Date(),\n                  reviewedBy: adminUser.uid\n                });\n              });\n            }\n          }\n          \n          else if (action === 'warned') {\n            console.log('[ADMIN REPORT UPDATE] Creating warning for campaign creator...');\n            const warningRef = db.collection('warnings').doc();\n            const warningData = {\n              userId: campaignData.creatorId,\n              targetType: 'campaign',\n              targetId: reportData.campaignId,\n              reportId: reportId,\n              reason: reportData.reason,\n              details: reportData.details || '',\n              issuedBy: adminUser.uid,\n              issuedAt: new Date(),\n              acknowledged: false,\n            };\n            transaction.set(warningRef, warningData);\n            console.log('[ADMIN REPORT UPDATE] Warning queued successfully');\n          }\n          \n          else if (action === 'removed') {\n            console.log('[ADMIN REPORT UPDATE] Removing campaign temporarily...');\n            const appealDeadline = new Date();\n            appealDeadline.setDate(appealDeadline.getDate() + 30);\n            \n            campaignUpdates.moderationStatus = 'removed-temporary';\n            campaignUpdates.removedAt = new Date();\n            campaignUpdates.removalReason = reportData.reason;\n            campaignUpdates.appealDeadline = appealDeadline;\n            campaignUpdates.appealCount = campaignData.appealCount || 0;\n          }\n          \n        if (Object.keys(campaignUpdates).length > 0) {\n          console.log('[ADMIN REPORT UPDATE] Updating campaign with:', campaignUpdates);\n          campaignUpdates.updatedAt = new Date();\n          transaction.update(campaignRef, campaignUpdates);\n          console.log('[ADMIN REPORT UPDATE] Campaign update queued successfully');\n        }\n      }\n      \n      // Process profile report (using pre-fetched data)\n      else if (reportType === 'profile' && reportData.reportedUserId && targetDoc && targetDoc.exists) {\n        console.log('[ADMIN REPORT UPDATE] Processing profile report...');\n        const userRef = db.collection('users').doc(reportData.reportedUserId);\n        const userData = targetData;\n        const userUpdates = {};\n          \n          if (action === 'no-action' && status === 'dismissed') {\n            console.log('[ADMIN REPORT UPDATE] Dismissing profile report - resetting counts...');\n            userUpdates.reportsCount = 0;\n            userUpdates.moderationStatus = 'active';\n            if (userData.hiddenAt) {\n              userUpdates.hiddenAt = FieldValue.delete();\n            }\n            \n            if (relatedReportsSnapshot && !relatedReportsSnapshot.empty) {\n              console.log('[ADMIN REPORT UPDATE] Dismissing', relatedReportsSnapshot.size, 'related reports');\n              relatedReportsSnapshot.forEach(doc => {\n                transaction.update(doc.ref, { \n                  status: 'dismissed', \n                  action: 'no-action',\n                  reviewedAt: new Date(),\n                  reviewedBy: adminUser.uid\n                });\n              });\n            }\n          }\n          \n          else if (action === 'warned') {\n            console.log('[ADMIN REPORT UPDATE] Creating warning for user...');\n            const warningRef = db.collection('warnings').doc();\n            const warningData = {\n              userId: reportData.reportedUserId,\n              targetType: 'profile',\n              targetId: reportData.reportedUserId,\n              reportId: reportId,\n              reason: reportData.reason,\n              details: reportData.details || '',\n              issuedBy: adminUser.uid,\n              issuedAt: new Date(),\n              acknowledged: false,\n            };\n            transaction.set(warningRef, warningData);\n            console.log('[ADMIN REPORT UPDATE] Warning queued successfully');\n          }\n          \n          else if (action === 'removed') {\n            console.log('[ADMIN REPORT UPDATE] Banning user temporarily...');\n            const appealDeadline = new Date();\n            appealDeadline.setDate(appealDeadline.getDate() + 30);\n            \n            userUpdates.banned = true;\n            userUpdates.bannedAt = new Date();\n            userUpdates.bannedBy = adminUser.uid;\n            userUpdates.banReason = reportData.reason;\n            userUpdates.appealDeadline = appealDeadline;\n          }\n          \n        if (Object.keys(userUpdates).length > 0) {\n          console.log('[ADMIN REPORT UPDATE] Updating user with:', userUpdates);\n          userUpdates.updatedAt = new Date();\n          transaction.update(userRef, userUpdates);\n          console.log('[ADMIN REPORT UPDATE] User update queued successfully');\n        }\n      }\n    });\n    \n    console.log('[ADMIN REPORT UPDATE] Transaction completed successfully');\n    \n    console.log('[ADMIN REPORT UPDATE] Fetching updated report document...');\n    const updatedDoc = await reportRef.get();\n    const updatedReportData = updatedDoc.data();\n    const updatedData = { id: updatedDoc.id, ...updatedReportData };\n    \n    let targetUserId = null;\n    let campaignTitle = null;\n    let notificationData = null;\n    \n    console.log('[ADMIN REPORT UPDATE] Preparing notification...');\n    if (reportType === 'campaign' && reportData.campaignId) {\n      console.log('[ADMIN REPORT UPDATE] Fetching campaign for notification...');\n      const campaignDoc = await db.collection('campaigns').doc(reportData.campaignId).get();\n      if (campaignDoc.exists) {\n        const campaignData = campaignDoc.data();\n        targetUserId = campaignData.creatorId;\n        campaignTitle = campaignData.title;\n        console.log('[ADMIN REPORT UPDATE] Target user:', targetUserId, 'Campaign:', campaignTitle);\n        \n        if (action === 'no-action' && status === 'dismissed') {\n          console.log('[ADMIN REPORT UPDATE] Creating campaignRestored notification');\n          notificationData = getNotificationTemplate('campaignRestored', { campaignTitle });\n        } else if (action === 'warned') {\n          console.log('[ADMIN REPORT UPDATE] Creating warningIssued notification');\n          const reasonText = reportData.reason?.replace(/_/g, ' ') || 'policy violation';\n          notificationData = getNotificationTemplate('warningIssued', { reason: reasonText });\n        } else if (action === 'removed') {\n          console.log('[ADMIN REPORT UPDATE] Creating campaignRemoved notification');\n          const appealDeadline = new Date();\n          appealDeadline.setDate(appealDeadline.getDate() + 30);\n          notificationData = getNotificationTemplate('campaignRemoved', {\n            campaignTitle,\n            appealDeadline: appealDeadline.toLocaleDateString()\n          });\n        }\n      }\n    }\n    \n    else if (reportType === 'profile' && reportData.reportedUserId) {\n      console.log('[ADMIN REPORT UPDATE] Profile report - target user:', reportData.reportedUserId);\n      targetUserId = reportData.reportedUserId;\n      \n      if (action === 'no-action' && status === 'dismissed') {\n        console.log('[ADMIN REPORT UPDATE] Creating profileRestored notification');\n        notificationData = getNotificationTemplate('profileRestored');\n      } else if (action === 'warned') {\n        console.log('[ADMIN REPORT UPDATE] Creating warningIssued notification');\n        const reasonText = reportData.reason?.replace(/_/g, ' ') || 'policy violation';\n        notificationData = getNotificationTemplate('warningIssued', { reason: reasonText });\n      } else if (action === 'removed') {\n        console.log('[ADMIN REPORT UPDATE] Creating accountBanned notification');\n        const appealDeadline = new Date();\n        appealDeadline.setDate(appealDeadline.getDate() + 30);\n        const banReasonText = reportData.reason?.replace(/_/g, ' ') || 'policy violation';\n        notificationData = getNotificationTemplate('accountBanned', {\n          banReason: banReasonText,\n          appealDeadline: appealDeadline.toLocaleDateString()\n        });\n      }\n    }\n    \n    if (targetUserId && notificationData) {\n      console.log('[ADMIN REPORT UPDATE] Sending in-app notification to user:', targetUserId);\n      try {\n        await sendInAppNotification({\n          userId: targetUserId,\n          title: notificationData.title,\n          body: notificationData.body,\n          actionUrl: notificationData.actionUrl,\n          icon: notificationData.icon,\n          type: notificationData.type || 'general',\n          metadata: {\n            reportId: reportId,\n            campaignId: reportData.campaignId,\n            action,\n            status,\n          }\n        });\n        console.log('[ADMIN REPORT UPDATE] In-app notification sent successfully');\n      } catch (notificationError) {\n        console.error('[ADMIN REPORT UPDATE] Failed to send in-app notification:', notificationError);\n      }\n    } else {\n      console.log('[ADMIN REPORT UPDATE] No notification to send (targetUserId:', targetUserId, ', notificationData:', !!notificationData, ')');\n    }\n    \n    console.log('[ADMIN REPORT UPDATE] Converting timestamps...');\n    if (updatedData.createdAt && updatedData.createdAt.toDate) {\n      updatedData.createdAt = updatedData.createdAt.toDate().toISOString();\n    }\n    if (updatedData.reviewedAt && updatedData.reviewedAt.toDate) {\n      updatedData.reviewedAt = updatedData.reviewedAt.toDate().toISOString();\n    }\n    if (updatedData.updatedAt && updatedData.updatedAt.toDate) {\n      updatedData.updatedAt = updatedData.updatedAt.toDate().toISOString();\n    }\n    \n    console.log('[ADMIN REPORT UPDATE] Success! Returning response');\n    return NextResponse.json({\n      success: true,\n      message: 'Report updated successfully',\n      data: updatedData,\n    });\n  } catch (error) {\n    console.error('Error updating report:', error);\n    console.error('Error stack:', error.stack);\n    console.error('Error details:', {\n      message: error.message,\n      code: error.code,\n      name: error.name,\n    });\n    \n    if (error.message.includes('Unauthorized') || error.message.includes('Admin access required')) {\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 403 }\n      );\n    }\n    \n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Failed to update report',\n        details: error.message,\n        errorCode: error.code\n      },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":17937,"size_tokens":null},"src/contexts/CampaignSessionContext.js":{"content":"\"use client\";\n\nimport { createContext, useContext, useState, useEffect, useCallback } from 'react';\n\nconst CampaignSessionContext = createContext(null);\n\nconst TWENTY_FOUR_HOURS = 24 * 60 * 60 * 1000;\n\nexport function CampaignSessionProvider({ children }) {\n  const [sessions, setSessions] = useState({});\n\n  // Load sessions from sessionStorage on mount\n  useEffect(() => {\n    if (typeof window === 'undefined') return;\n    \n    const loadedSessions = {};\n    for (let i = 0; i < sessionStorage.length; i++) {\n      const key = sessionStorage.key(i);\n      if (key && key.startsWith('campaign_session_')) {\n        try {\n          const data = sessionStorage.getItem(key);\n          const session = JSON.parse(data);\n          \n          // Check if session is expired\n          if (Date.now() - session.timestamp <= TWENTY_FOUR_HOURS) {\n            const slug = key.replace('campaign_session_', '');\n            loadedSessions[slug] = session;\n          } else {\n            // Remove expired session\n            sessionStorage.removeItem(key);\n          }\n        } catch (error) {\n          console.error('Error loading session:', error);\n          sessionStorage.removeItem(key);\n        }\n      }\n    }\n    \n    setSessions(loadedSessions);\n  }, []);\n\n  // Get session for specific campaign\n  // Falls back to sessionStorage to handle race conditions during navigation\n  const getSession = useCallback((slug) => {\n    if (!slug) return null;\n    \n    // First check React state\n    if (sessions[slug]) {\n      return sessions[slug];\n    }\n    \n    // Fall back to sessionStorage for most up-to-date data\n    // This handles race conditions when state hasn't updated yet\n    if (typeof window !== 'undefined') {\n      try {\n        const key = `campaign_session_${slug}`;\n        const data = sessionStorage.getItem(key);\n        if (data) {\n          const session = JSON.parse(data);\n          // Check if session is not expired\n          if (Date.now() - session.timestamp <= TWENTY_FOUR_HOURS) {\n            return session;\n          }\n        }\n      } catch (error) {\n        console.error('Error reading session from storage:', error);\n      }\n    }\n    \n    return null;\n  }, [sessions]);\n\n  // Update session for specific campaign\n  const updateSession = useCallback((slug, updates) => {\n    if (!slug) return;\n    \n    setSessions(prev => {\n      const currentSession = prev[slug] || {\n        sessionId: Math.random().toString(36).substring(2, 15),\n        campaignSlug: slug,\n        timestamp: Date.now()\n      };\n      \n      const newSession = {\n        ...currentSession,\n        ...updates,\n        timestamp: currentSession.timestamp // Keep original timestamp\n      };\n      \n      // Save to sessionStorage\n      try {\n        const key = `campaign_session_${slug}`;\n        sessionStorage.setItem(key, JSON.stringify(newSession));\n      } catch (error) {\n        console.error('Error saving session:', error);\n      }\n      \n      return {\n        ...prev,\n        [slug]: newSession\n      };\n    });\n  }, []);\n\n  // Clear session for specific campaign\n  const clearSession = useCallback((slug) => {\n    if (!slug) return;\n    \n    setSessions(prev => {\n      const { [slug]: removed, ...rest } = prev;\n      \n      // Remove from sessionStorage\n      try {\n        const key = `campaign_session_${slug}`;\n        sessionStorage.removeItem(key);\n      } catch (error) {\n        console.error('Error clearing session:', error);\n      }\n      \n      return rest;\n    });\n  }, []);\n\n  // Check if session is expired\n  const isSessionExpired = useCallback((slug) => {\n    const session = getSession(slug);\n    if (!session) return true;\n    \n    return Date.now() - session.timestamp > TWENTY_FOUR_HOURS;\n  }, [getSession]);\n\n  // Set user photo\n  const setUserPhoto = useCallback((slug, file, preview) => {\n    updateSession(slug, {\n      userPhoto: file ? { name: file.name, size: file.size, type: file.type } : null,\n      userPhotoPreview: preview\n    });\n  }, [updateSession]);\n\n  // Set adjustments\n  const setAdjustments = useCallback((slug, adjustments) => {\n    updateSession(slug, { adjustments });\n  }, [updateSession]);\n\n  // Mark as downloaded\n  const markDownloaded = useCallback((slug) => {\n    updateSession(slug, { downloaded: true, downloadedAt: Date.now() });\n  }, [updateSession]);\n\n  // Set campaign data\n  const setCampaignData = useCallback((slug, campaignData) => {\n    updateSession(slug, { campaignData });\n  }, [updateSession]);\n\n  // Set creator data\n  const setCreatorData = useCallback((slug, creatorData) => {\n    updateSession(slug, { creatorData });\n  }, [updateSession]);\n\n  const value = {\n    getSession,\n    updateSession,\n    clearSession,\n    isSessionExpired,\n    setUserPhoto,\n    setAdjustments,\n    markDownloaded,\n    setCampaignData,\n    setCreatorData\n  };\n\n  return (\n    <CampaignSessionContext.Provider value={value}>\n      {children}\n    </CampaignSessionContext.Provider>\n  );\n}\n\nexport function useCampaignSession() {\n  const context = useContext(CampaignSessionContext);\n  if (!context) {\n    throw new Error('useCampaignSession must be used within CampaignSessionProvider');\n  }\n  return context;\n}\n","path":null,"size_bytes":5176,"size_tokens":null},"src/lib/supabase-admin.js":{"content":"// Server-side Supabase client with service role key\nimport 'server-only'\nimport { createClient } from '@supabase/supabase-js'\n\nconst isProduction = process.env.NODE_ENV === 'production';\nconst isDevelopment = process.env.NODE_ENV === 'development';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n// Validate required environment variables\nconst missingVars = [];\nif (!supabaseUrl) missingVars.push('NEXT_PUBLIC_SUPABASE_URL');\nif (!supabaseServiceKey) missingVars.push('SUPABASE_SERVICE_ROLE_KEY');\n\nlet supabaseAdmin\n\nif (missingVars.length > 0) {\n  const errorMessage = `Missing required Supabase configuration: ${missingVars.join(', ')}`;\n  \n  if (isProduction) {\n    // Production: Fail fast\n    throw new Error(`[PRODUCTION] ${errorMessage}. Please add these environment variables in Vercel.`);\n  }\n  \n  if (isDevelopment) {\n    // Development: Warn clearly\n    console.warn(`[DEV WARNING] ${errorMessage}`);\n    console.warn('[DEV WARNING] Supabase storage will not be available. Add these variables in Vercel for production.');\n  }\n  \n  // Create a mock client that fails at runtime with clear errors\n  supabaseAdmin = {\n    storage: {\n      from: () => ({\n        list: () => Promise.reject(new Error('Supabase not configured - missing environment variables')),\n        remove: () => Promise.reject(new Error('Supabase not configured - missing environment variables')),\n        createSignedUrl: () => Promise.reject(new Error('Supabase not configured - missing environment variables')),\n        getPublicUrl: () => ({ data: { publicUrl: '' } })\n      })\n    }\n  }\n} else {\n  // Validate Supabase URL format\n  try {\n    const url = new URL(supabaseUrl);\n    \n    if (isProduction && !supabaseUrl.includes('supabase.co')) {\n      throw new Error('[PRODUCTION] NEXT_PUBLIC_SUPABASE_URL must be a valid Supabase URL (*.supabase.co)');\n    }\n  } catch (error) {\n    const errorMessage = `Invalid NEXT_PUBLIC_SUPABASE_URL format: ${error.message}`;\n    \n    if (isProduction) {\n      throw new Error(`[PRODUCTION] ${errorMessage}. Please check the URL in Vercel.`);\n    }\n    \n    if (isDevelopment) {\n      console.warn(`[DEV WARNING] ${errorMessage}`);\n    }\n    \n    throw error;\n  }\n  \n  // Create admin client with service role key (server-side only)\n  supabaseAdmin = createClient(supabaseUrl, supabaseServiceKey, {\n    auth: {\n      autoRefreshToken: false,\n      persistSession: false\n    }\n  })\n  \n  if (isDevelopment) {\n    console.log('[DEV] Supabase Admin client initialized successfully');\n  }\n}\n\nexport { supabaseAdmin }\nexport default supabaseAdmin\n","path":null,"size_bytes":2644,"size_tokens":null},"src/app/(chrome)/layout.js":{"content":"import ConditionalLayout from \"../../components/ConditionalLayout\";\n\nexport default function ChromeLayout({ children }) {\n  return (\n    <ConditionalLayout>\n      {children}\n    </ConditionalLayout>\n  );\n}","path":null,"size_bytes":205,"size_tokens":null},"src/app/api/storage/campaign-upload-url/route.js":{"content":"import { NextResponse } from 'next/server'\nimport { verifyIdToken } from '../../../../lib/firebaseAdmin'\nimport { supabaseAdmin } from '../../../../lib/supabase-admin'\nimport { headers } from 'next/headers'\n\n/**\n * Campaign Upload URL Generation Endpoint\n * \n * Creates signed upload URLs for campaign images with the correct path structure:\n * campaigns/{userId}/{campaignId}.png\n * \n * This ensures:\n * - Predictable file paths (easy deletion)\n * - One image per campaign (no duplicates)\n * - Clear ownership structure\n * - PNG format enforcement (required for transparency)\n */\n\n// Force Node.js runtime for server-side operations\nexport const runtime = 'nodejs'\n\nexport async function POST(request) {\n  try {\n    // Get the authorization header\n    const headersList = headers()\n    const authorization = headersList.get('authorization')\n    \n    if (!authorization || !authorization.startsWith('Bearer ')) {\n      return NextResponse.json({ success: false, error: 'No authorization token provided' }, { status: 401 })\n    }\n\n    const token = authorization.replace('Bearer ', '')\n    \n    // Verify Firebase ID token\n    let decodedToken\n    try {\n      decodedToken = await verifyIdToken(token)\n    } catch (error) {\n      return NextResponse.json({ success: false, error: 'Invalid token' }, { status: 401 })\n    }\n\n    const { campaignId, fileSize, fileType } = await request.json()\n    \n    // Validate required fields\n    if (!campaignId) {\n      return NextResponse.json({ success: false, error: 'campaignId is required' }, { status: 400 })\n    }\n\n    if (!Number.isFinite(fileSize) || fileSize <= 0) {\n      return NextResponse.json({ \n        success: false,\n        error: 'fileSize is required and must be a positive number' \n      }, { status: 400 })\n    }\n\n    if (!fileType || typeof fileType !== 'string' || fileType.trim() === '') {\n      return NextResponse.json({ \n        success: false,\n        error: 'fileType is required and must be a non-empty string' \n      }, { status: 400 })\n    }\n\n    // Validate campaignId format (alphanumeric, hyphens, underscores only)\n    const campaignIdRegex = /^[a-zA-Z0-9_-]+$/\n    if (!campaignIdRegex.test(campaignId)) {\n      return NextResponse.json({ \n        success: false,\n        error: 'Invalid campaignId format. Use only letters, numbers, hyphens, and underscores.' \n      }, { status: 400 })\n    }\n\n    // Validate file size (5MB max for campaigns as per CAMPAIGN_SYSTEM.md)\n    const MAX_FILE_SIZE = 5 * 1024 * 1024 // 5MB in bytes\n    if (fileSize > MAX_FILE_SIZE) {\n      return NextResponse.json({ \n        success: false,\n        error: 'File size exceeds 5MB limit for campaigns' \n      }, { status: 400 })\n    }\n\n    // Validate file type (only image formats allowed)\n    const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp']\n    if (!allowedTypes.includes(fileType.toLowerCase())) {\n      return NextResponse.json({ \n        success: false,\n        error: 'Invalid file type. Only PNG, JPG, and WEBP images are allowed for campaigns.' \n      }, { status: 400 })\n    }\n\n    // Create campaign-specific path as documented: campaigns/{userId}/{campaignId}.png\n    const filePath = `campaigns/${decodedToken.uid}/${campaignId}.png`\n\n    // Generate signed upload URL (valid for 1 hour)\n    const { data, error } = await supabaseAdmin.storage\n      .from('uploads')\n      .createSignedUploadUrl(filePath, {\n        upsert: true  // Allow overwriting if user re-uploads campaign image\n      })\n\n    if (error) {\n      console.error('Supabase error:', error)\n      return NextResponse.json({ success: false, error: 'Failed to create upload URL' }, { status: 500 })\n    }\n\n    return NextResponse.json({\n      success: true,\n      uploadUrl: data.signedUrl,\n      path: filePath,\n      token: data.token\n    })\n\n  } catch (error) {\n    console.error('Campaign upload URL generation error:', error)\n    return NextResponse.json({ success: false, error: 'Internal server error' }, { status: 500 })\n  }\n}\n","path":null,"size_bytes":3995,"size_tokens":null},"src/app/(chrome)/admin/layout.js":{"content":"\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useUserProfile } from \"@/components/UserProfileProvider\";\nimport AdminSidebar from \"@/components/admin/AdminSidebar\";\nimport AdminHeader from \"@/components/admin/AdminHeader\";\nimport PageLoader from \"@/components/PageLoader\";\n\nexport default function AdminLayout({ children }) {\n  const router = useRouter();\n  const { user, loading: authLoading, logout } = useAuth();\n  const { userProfile, loading: profileLoading } = useUserProfile();\n  const [isAuthorized, setIsAuthorized] = useState(false);\n\n  useEffect(() => {\n    if (authLoading || profileLoading) return;\n\n    if (!user) {\n      router.replace(\"/signin\");\n      return;\n    }\n\n    if (!userProfile || userProfile.role !== \"admin\") {\n      router.replace(\"/\");\n      return;\n    }\n\n    setIsAuthorized(true);\n  }, [user, userProfile, authLoading, profileLoading, router]);\n\n  const handleSignOut = async () => {\n    await logout();\n    router.replace(\"/\");\n  };\n\n  if (authLoading || profileLoading) {\n    return <PageLoader message=\"Loading admin panel...\" />;\n  }\n\n  if (!user) {\n    return <PageLoader message=\"Redirecting to sign in...\" />;\n  }\n\n  if (!isAuthorized) {\n    if (!userProfile) {\n      return <PageLoader message=\"Loading profile...\" />;\n    }\n\n    if (userProfile.role !== \"admin\") {\n      return (\n        <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\n          <div className=\"max-w-md mx-auto text-center px-6\">\n            <div className=\"mx-auto w-24 h-24 bg-red-100 rounded-full flex items-center justify-center mb-6\">\n              <svg className=\"w-12 h-12 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n              </svg>\n            </div>\n            <h3 className=\"text-2xl font-bold text-gray-900 mb-2\">Unauthorized Access</h3>\n            <p className=\"text-gray-600 mb-6\">You don't have permission to access the admin panel.</p>\n            <button\n              onClick={() => router.replace(\"/\")}\n              className=\"btn-base btn-primary px-6 py-3 font-medium\"\n            >\n              Go to Home\n            </button>\n          </div>\n        </div>\n      );\n    }\n\n    return <PageLoader message=\"Verifying admin access...\" />;\n  }\n\n  return (\n    <div className=\"flex h-screen bg-gray-100 overflow-hidden\">\n      <AdminSidebar user={{ ...user, ...userProfile }} onSignOut={handleSignOut} />\n      \n      <div className=\"flex-1 flex flex-col lg:ml-64 overflow-hidden relative\">\n        <AdminHeader user={{ ...user, ...userProfile }} />\n        \n        <main className=\"flex-1 overflow-y-auto p-6 bg-gray-50\">\n          {children}\n        </main>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":3016,"size_tokens":null},"src/app/api/admin/users/[userId]/role/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\n\nexport async function PATCH(request, { params }) {\n  try {\n    const adminUser = await requireAdmin(request);\n    \n    const { userId } = params;\n    const body = await request.json();\n    const { role } = body;\n    \n    if (!role || !['admin', 'user'].includes(role)) {\n      return NextResponse.json(\n        { success: false, error: 'Role must be either \"admin\" or \"user\"' },\n        { status: 400 }\n      );\n    }\n    \n    if (!userId) {\n      return NextResponse.json(\n        { success: false, error: 'User ID is required' },\n        { status: 400 }\n      );\n    }\n    \n    const db = adminFirestore();\n    const userRef = db.collection('users').doc(userId);\n    const userDoc = await userRef.get();\n    \n    if (!userDoc.exists) {\n      return NextResponse.json(\n        { success: false, error: 'User not found' },\n        { status: 404 }\n      );\n    }\n    \n    await userRef.update({\n      role: role,\n      updatedAt: new Date(),\n    });\n    \n    return NextResponse.json({\n      success: true,\n      message: `User role updated to ${role}`,\n      data: {\n        userId,\n        role,\n        updatedBy: adminUser.uid,\n      }\n    });\n  } catch (error) {\n    console.error('Error updating user role:', error);\n    \n    if (error.message.includes('Unauthorized') || error.message.includes('Admin access required')) {\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 403 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to update user role' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":1736,"size_tokens":null},"src/hooks/useAuth.js":{"content":"\"use client\";\n\nimport { useState, useEffect, createContext, useContext } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { \n  onAuthStateChanged, \n  signInWithPopup, \n  GoogleAuthProvider,\n  createUserWithEmailAndPassword,\n  updateProfile,\n  sendEmailVerification,\n  signInWithEmailAndPassword,\n  signOut,\n  reload,\n  sendPasswordResetEmail\n} from 'firebase/auth';\nimport { useFirebaseOptimized as useFirebase } from '../lib/firebase-optimized';\nimport { createUserProfile } from '../lib/firestore';\nimport { \n  handleSignInError, \n  handleSignUpError, \n  handlePasswordResetError, \n  handleEmailVerificationError,\n  handleGoogleSignInError,\n  getPasswordResetSuccessMessage \n} from '../utils/firebaseErrorHandler';\n\n// Create Auth Context\nconst AuthContext = createContext(null);\n\nexport function AuthProvider({ children }) {\n  const [user, setUser] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [pendingSignupUserId, setPendingSignupUserId] = useState(null);\n  const [logoutInProgress, setLogoutInProgress] = useState(false);\n  const firebase = useFirebase();\n  const router = useRouter();\n\n  useEffect(() => {\n    // Don't set up auth listener until Firebase is loaded\n    if (firebase.isLoading) return;\n    \n    // If Firebase is not configured, set loading to false and return\n    if (!firebase.isConfigured || !firebase.auth) {\n      setLoading(false);\n      return;\n    }\n    \n    // Set up auth listener with proper cleanup\n    let unsubscribe = null;\n    \n    const setupAuthListener = async () => {\n      try {\n        // Listen for authentication state changes\n        unsubscribe = onAuthStateChanged(firebase.auth, async (user) => {\n          if (user) {\n            // Create user profile in Firestore if it doesn't exist\n            try {\n              await createUserProfile(user);\n            } catch (error) {\n              if (process.env.NODE_ENV === 'development') {\n                console.error('Error creating user profile:', error);\n              }\n            }\n            \n            // Clear pending signup flag if this user was pending (using functional update to always see latest value)\n            setPendingSignupUserId(current => current === user.uid ? null : current);\n          }\n          \n          // Clear logout in progress flag on any auth state change\n          setLogoutInProgress(false);\n          setUser(user);\n          setLoading(false);\n        });\n      } catch (error) {\n        if (process.env.NODE_ENV === 'development') {\n          console.error('Failed to set up auth listener:', error);\n        }\n        setLoading(false);\n      }\n    };\n\n    setupAuthListener();\n\n    // Return cleanup function\n    return () => {\n      if (unsubscribe) {\n        unsubscribe();\n      }\n    };\n  }, [firebase.isLoading, firebase.isConfigured, firebase.auth]);\n\n  // Show loading state while Firebase is initializing only\n  if (firebase.isLoading) {\n    const noopAsync = async () => ({ success: false });\n    const noop = () => {};\n    \n    return (\n      <AuthContext.Provider value={{ \n        user: null, \n        loading: true, \n        mounted: true,\n        logoutInProgress: false,\n        signInWithGoogle: noopAsync, \n        signUpWithEmail: noopAsync, \n        signInWithEmail: noopAsync, \n        sendVerificationEmail: noopAsync,\n        checkEmailVerification: async () => ({ verified: false }),\n        forgotPassword: noopAsync,\n        logout: noop\n      }}>\n        {children}\n      </AuthContext.Provider>\n    );\n  }\n\n  const signInWithGoogle = async () => {\n    if (!firebase.isConfigured || !firebase.auth) {\n      return { success: false, error: 'Authentication is not properly configured.' };\n    }\n    \n    try {\n      const googleProvider = new GoogleAuthProvider();\n      const result = await signInWithPopup(firebase.auth, googleProvider);\n      \n      // Check if user is banned by fetching their profile\n      const { getUserProfile } = await import('../lib/firestore');\n      const profile = await getUserProfile(result.user.uid);\n      \n      if (profile?.accountStatus?.includes('banned')) {\n        // User is banned - sign them out immediately\n        await signOut(firebase.auth);\n        \n        // Store ban info for the banned page\n        if (typeof window !== 'undefined') {\n          sessionStorage.setItem('banInfo', JSON.stringify({\n            reason: profile.banReason || 'Your account has been suspended.',\n            bannedAt: profile.bannedAt || new Date().toISOString()\n          }));\n        }\n        \n        return { \n          success: false, \n          error: 'Your account has been suspended. Please contact support for more information.',\n          banned: true \n        };\n      }\n      \n      // User state will be automatically updated via onAuthStateChanged\n      return { success: true };\n    } catch (error) {\n      // Use centralized error handling for Google sign-in\n      return await handleGoogleSignInError(error);\n    }\n  };\n\n  const signUpWithEmail = async (email, password, name) => {\n    if (!firebase.isConfigured || !firebase.auth) {\n      return { success: false, error: 'Authentication is not properly configured.' };\n    }\n    \n    try {\n      const result = await createUserWithEmailAndPassword(firebase.auth, email, password);\n      \n      // Set pending signup flag to prevent race condition in verify-email page\n      setPendingSignupUserId(result.user.uid);\n      \n      // Update user profile with name\n      if (name) {\n        await updateProfile(result.user, {\n          displayName: name\n        });\n      }\n      \n      // Send email verification\n      await sendEmailVerification(result.user);\n\n      return { success: true, requiresVerification: true };\n    } catch (error) {\n      // Clear pending signup flag on error\n      setPendingSignupUserId(null);\n      // Use centralized error handling for sign-up\n      return await handleSignUpError(error);\n    }\n  };\n\n  const signInWithEmail = async (email, password) => {\n    if (!firebase.isConfigured || !firebase.auth) {\n      return { success: false, error: 'Authentication is not properly configured.' };\n    }\n    \n    try {\n      const result = await signInWithEmailAndPassword(firebase.auth, email, password);\n      \n      // Check if user is banned by fetching their profile\n      const { getUserProfile } = await import('../lib/firestore');\n      const profile = await getUserProfile(result.user.uid);\n      \n      if (profile?.accountStatus?.includes('banned')) {\n        // User is banned - sign them out immediately\n        await signOut(firebase.auth);\n        \n        // Store ban info for the banned page\n        if (typeof window !== 'undefined') {\n          sessionStorage.setItem('banInfo', JSON.stringify({\n            reason: profile.banReason || 'Your account has been suspended.',\n            bannedAt: profile.bannedAt || new Date().toISOString()\n          }));\n        }\n        \n        return { \n          success: false, \n          error: 'Your account has been suspended. Please contact support for more information.',\n          banned: true \n        };\n      }\n      \n      return { success: true };\n    } catch (error) {\n      // Use centralized error handling for sign-in\n      return await handleSignInError(error);\n    }\n  };\n\n  const logout = async () => {\n    try {\n      // Set logout in progress flag to prevent redirects\n      setLogoutInProgress(true);\n      // Clear any pending signup state before signing out\n      setPendingSignupUserId(null);\n      await signOut(firebase.auth);\n      // Use replace instead of push to prevent back button issues\n      router.replace('/');\n    } catch (error) {\n      console.error('Sign-out error:', error);\n      // Clear logout flag on error\n      setLogoutInProgress(false);\n    }\n  };\n\n  // Send email verification\n  const sendVerificationEmail = async () => {\n    try {\n      if (firebase.auth?.currentUser) {\n        await sendEmailVerification(firebase.auth.currentUser);\n        return { success: true };\n      }\n      return { success: false, error: 'No user signed in' };\n    } catch (error) {\n      console.error('Error sending verification email:', error);\n      \n      // Use centralized error handling for email verification\n      return await handleEmailVerificationError(error);\n    }\n  };\n\n  // Check email verification status (reload user)\n  const checkEmailVerification = async () => {\n    try {\n      if (firebase.auth?.currentUser) {\n        await reload(firebase.auth.currentUser);\n        // Update the user state so components re-render with new verification status\n        setUser(firebase.auth.currentUser);\n        return { verified: firebase.auth.currentUser.emailVerified };\n      }\n      return { verified: false };\n    } catch (error) {\n      console.error('Error checking verification status:', error);\n      return { verified: false };\n    }\n  };\n\n  const forgotPassword = async (email) => {\n    if (!firebase.isConfigured || !firebase.auth) {\n      return { success: false, error: 'Authentication is not properly configured.' };\n    }\n    \n    try {\n      await sendPasswordResetEmail(firebase.auth, email);\n      \n      // Return success with appropriate message\n      return { \n        success: true, \n        type: 'success',\n        message: getPasswordResetSuccessMessage()\n      };\n      \n    } catch (error) {\n      // Use centralized error handling for password reset\n      const result = await handlePasswordResetError(error);\n      \n      // If centralized handler treats this as success (security mode), return it\n      if (result.success) {\n        return result;\n      }\n      \n      // Otherwise return the error\n      return result;\n    }\n  };\n\n  // Note: Using centralized Firebase error handling from utils/firebaseErrorHandler.js\n\n  const value = {\n    user,\n    loading,\n    pendingSignupUserId,\n    logoutInProgress,\n    mounted: true,\n    signInWithGoogle,\n    signUpWithEmail,\n    signInWithEmail,\n    sendVerificationEmail,\n    checkEmailVerification,\n    forgotPassword,\n    logout\n  };\n\n  return (\n    <AuthContext.Provider value={value}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport const useAuth = () => {\n  const context = useContext(AuthContext);\n  if (!context) {\n    throw new Error('useAuth must be used within an AuthProvider');\n  }\n  return context;\n};\n\n// Optional auth hook that doesn't crash if no provider\nexport const useOptionalAuth = () => {\n  const context = useContext(AuthContext);\n  return context;\n};","path":null,"size_bytes":10507,"size_tokens":null},"replit.md":{"content":"# Twibbonize App\n\n## Overview\nTwibbonize is a Next.js 15 application designed for creating and sharing \"Campaigns\" consisting of photo frames and backgrounds. It allows visitors to discover, customize, and download photos with these elements, while creators can upload and manage their campaigns with public analytics. The project aims to provide a visitor-first, frictionless experience with minimal authentication requirements, emphasizing public discovery and transparency.\n\n## User Preferences\n- Prefer stability over experimental features\n- Focus on clean, maintainable code structure\n- Make code changes ONLY when explicitly requested\n- Never perform automatic setup, testing, or debugging\n\n## System Architecture\nThe application is built with Next.js 15.5.7 (App Router), React 19.1.0, and Tailwind CSS 4. It leverages Firebase for authentication and Supabase for database and storage.\n\n**Core Features:**\n- **Campaign System:** Users can upload and manage campaigns, categorized as Frames (requiring transparency detection) or Backgrounds.\n- **Public Gallery:** A unified `/campaigns` page for browsing campaigns with filtering capabilities.\n- **Image Composition:** Utilizes Canvas API for overlaying user photos with frames/backgrounds, including adjustment tools (zoom, move, fit).\n- **Top Creators:** A leaderboard feature showcasing creators by country and time period.\n- **Public Analytics:** Transparent usage statistics for all campaigns.\n- **Three-Page Campaign Flow:** A guided user experience for photo upload, adjustment, and result download/sharing.\n- **Admin Dashboard:** A comprehensive panel for moderation, including reports management, campaign moderation, user management, and analytics.\n- **In-App Notification System:** Real-time Firestore-based notifications for user updates and moderation events, with notification inbox and toast alerts.\n\n**Design Principles:**\n- **Visitor-first experience:** Browsing and using campaigns do not require authentication.\n- **Minimal account requirements:** Authentication is only required for campaign creation.\n- **Public-first design:** Emphasizes discovery and transparent analytics.\n- **Frictionless workflow:** Achieved through delayed authentication and intuitive user flows.\n\n**Technical Implementations:**\n- **Transparency Detection:** Canvas API is used to validate transparency for frame uploads.\n- **Slug Generation:** Unique, URL-friendly identifiers are generated from campaign titles.\n- **Delayed Authentication:** Users can complete forms unauthenticated, with a prompt only at the point of publishing.\n- **Optimized Database Structure:** Firebase/Firestore is optimized to reduce storage costs and prevent document bloat, especially for viral campaigns, by simplifying download tracking and using counters.\n- **Image Optimization:** ImageKit.io CDN is integrated for image transformation (WebP, resizing, quality optimization) across all application images.\n- **In-App Notifications Only:** Notifications are delivered through Firestore real-time listeners - no browser permissions or service workers needed.\n- **Notification History/Inbox System:** All notifications are saved to Firestore (`users/{userId}/notifications`) for an in-app inbox with real-time updates and authenticated APIs for managing read/delete status.\n\n## External Dependencies\n- **Firebase:** Authentication and Firestore database.\n- **Supabase:** Image storage (campaigns, profiles).\n- **ImageKit.io:** Active CDN for image optimization and transformations (WebP, resizing).\n- **MailerSend:** Email notifications for critical actions (bans, unbans).\n- **Next.js:** Web framework (v15.5.7).\n- **React:** UI library (v19.1.0).\n- **Tailwind CSS:** Styling (v4).\n\n## Recent Updates (October 31, 2025)\n\n### Documentation Cleanup - Settings Architecture Clarification\nUpdated documentation to clarify the settings architecture plan:\n\n**Key Clarifications:**\n-  `/settings` hub is PLANNED for future implementation (account, privacy, preferences)\n-  `/settings/notifications` will NOT be implemented (notifications are mandatory)\n- All notifications are moderation-related and users must receive them\n- Notification inbox at `/profile/notifications` provides full notification management\n\n**Settings Hub Will Include (Future):**\n- `/settings/account` - Password, email, 2FA, sessions, account deletion\n- `/settings/privacy` - Profile visibility, data export, GDPR compliance\n- `/settings/preferences` - Language, theme, accessibility\n\n**Files Updated:**\n- `TASKS.md` - Restructured Phase 1 to focus on settings hub (excluding notification preferences)\n- `replit.md` - Clarified that settings hub is deferred, not cancelled\n- `CODEBASE_STRUCTURE.md` - Updated to reflect planned settings architecture\n\n---\n\n## Recent Updates (October 13, 2025)\n\n### Documentation Audit & Corrections\nConducted comprehensive documentation audit comparing actual codebase against all documentation files:\n\n**Files Analyzed:**\n- CODEBASE_STRUCTURE.md (647 lines)\n- CODE_INCONSISTENCIES.md\n- TASKS.md (2427 lines)\n- README.md\n- CAMPAIGN_SYSTEM.md\n- replit.md\n\n**Key Findings & Fixes:**\n1. **Component Discrepancies Resolved:**\n   -  Removed non-existent `ReportUserModal.js` from docs\n   -  Added missing `ShareModal.js` to docs (universal modal for campaigns and profiles)\n   -  Clarified `ReportModal.js` handles both campaign and user reports\n\n2. **In-App Notification System:**\n   - Firestore-based real-time notification system\n   - No browser permissions required\n   - System features:\n     -  Real-time Firestore listeners for instant notifications\n     -  NotificationBell, NotificationToast, NotificationProvider components\n     -  Notification inbox at `/profile/notifications` (read/unread, filter, delete)\n     -  Server-side sendInAppNotification utility for sending notifications\n\n3. **Settings Architecture Clarification:**\n   -  `/settings` hub is planned for future (account, privacy, preferences pages)\n   -  `/settings/notifications` will NOT be implemented (notifications are mandatory moderation updates)\n   -  Notification inbox at `/profile/notifications` is fully functional\n   - Users can view, filter, and delete notifications without needing preferences\n   - All notifications are critical moderation actions that must be delivered\n\n4. **Documentation Updates:**\n   - Updated TASKS.md with notification system documentation\n   - Documented in-app notification architecture and components\n   - Added notification system integration with moderation features\n\n**Current Implementation Status:**\n-  Core campaign system fully functional\n-  Admin dashboard with full moderation tools\n-  In-app notification system with Firestore real-time listeners\n-  Notification inbox at `/profile/notifications` with read/unread/delete functionality\n-  Optimized grouped reporting system\n-  Complete appeal system (user submission + admin review)\n-  Auto-deletion cron jobs (fully implemented)\n-  Appeal deadline reminder notifications (fully implemented)\n-  Settings hub (`/settings`) - Deferred for future (account, privacy, preferences pages)\n-  Admin warning history view (deferred - future enhancement)\n\n## Recent Updates (October 24, 2025)\n\n### Complete Appeal System Implementation\nImplemented a full-featured appeal system for removed campaigns and banned accounts:\n\n**User Features:**\n- Appeal submission page at `/profile/appeals` showing all eligible items\n- 30-day appeal window from removal/ban date\n- One appeal per item with minimum 20-character reason requirement\n- Real-time notifications for appeal submission, approval, and rejection\n\n**Admin Features:**\n- Appeals review dashboard at `/admin/appeals` with filtering (status, type, limit)\n- Approve/reject actions with typed confirmation (\"CONFIRM\" requirement)\n- Admin notes field for documentation\n- Complete integration with moderation workflow\n\n**Technical Implementation:**\n- User API endpoint: `/api/appeals/eligible` (fetches user's removed items)\n- User API endpoint: `/api/appeals/submit` (submits appeal)\n- Admin API endpoint: `/api/admin/appeals` (lists appeals)\n- Admin API endpoint: `/api/admin/appeals/[appealId]` (approve/reject)\n- Appeals Firestore helper functions in `firestore.js`\n- Notification templates: appealSubmitted, appealApproved, appealRejected\n- AdminSidebar updated with Appeals navigation link\n\n**Integration:**\n- Appeals restore content on approval (moderationStatus  active, accountStatus  active)\n- Appeals set permanent status on rejection (removed-permanent, banned-permanent)\n- Full audit trail through admin action logging\n- Notification system integration for all appeal events\n\n**Completed Items (October 26, 2025):**\n-  Appeal deadline reminder notifications (implemented via Vercel cron job)\n-  Auto-deletion after 30 days if no appeal (implemented via Vercel cron job)\n\n---\n\n## Recent Updates (October 14, 2025)\n\n### Reporting System with Reason Counts Optimization\nImplemented an optimized reporting system using reason counts instead of individual report documents, reducing Firestore operations by ~95%.\n\n**Implementation Details:**\n1. **reportSummary with Reason Counts:**\n   - Single aggregated collection that tracks reports by target (campaign or user)\n   - Schema includes: `targetId`, `targetType`, `reportsCount`, `reasonCounts`, `status`, `firstReportedAt`, `lastReportedAt`\n   - `reasonCounts` object stores breakdown (e.g., `{spam: 8, inappropriate: 5, copyright: 2}`)\n   - Display data cached in summary for quick access (title, image, creator info)\n   - All counts reset to 0 when admin takes action (dismiss/warn/remove)\n\n2. **No Individual Reports:**\n   - Removed individual report documents entirely\n   - Report submission only increments reason counts in reportSummary\n   - Atomic transactions ensure consistency\n   - Status automatically resets to 'pending' when new reports filed against resolved entities\n\n3. **Report Submission:**\n   - User selects reason from dropdown (required field)\n   - No details/text field - just reason selection\n   - Backend increments specific reason count in reportSummary\n   - 2 writes per report instead of 3 (33% reduction)\n\n4. **Admin API Endpoints:**\n   - `/api/admin/reports/grouped`: Fetches paginated summaries (max 10) with filters\n   - `/api/admin/reports/summary/[summaryId]`: Admin actions (dismiss/warn/remove)\n   - Removed: `/api/admin/reports/details` (no longer needed)\n   - Removed: `/api/admin/reports/[reportId]` (no individual reports)\n\n5. **GroupedReportsTable Component:**\n   - Displays aggregated report summaries with reason breakdown\n   - Expand shows percentage distribution (e.g., \"Spam: 8 (53%)\")\n   - Visual progress bars for each reason\n   - Shows first/last report timestamps\n   - No individual report fetching needed\n\n6. **Admin Action Performance:**\n   - Before: 50 reads + 53 writes for 50 reports\n   - After: 2 reads + 3 writes regardless of report count\n   - 96% reduction in reads, 94% reduction in writes\n   - Instant admin actions with no query overhead\n\n7. **Frontend Updates:**\n   - ReportModal simplified - removed details textarea\n   - Admin sees reason breakdown instead of individual reports\n   - Better insight into why content was reported\n\n**Performance Impact:**\n- Report submission: 3 writes  2 writes (33% reduction)\n- Admin dismiss (100 reports): 102 reads + 103 writes  2 reads + 3 writes (98% reduction)\n- Better admin UX with instant reason distribution visibility\n- Significant cost savings on Firestore usage for high-volume scenarios\n\n","path":null,"size_bytes":11585,"size_tokens":null},"src/components/ErrorBoundary.js":{"content":"'use client';\n\nimport React from 'react';\n\nclass ErrorBoundary extends React.Component {\n  constructor(props) {\n    super(props);\n    this.state = { hasError: false, error: null };\n  }\n\n  static getDerivedStateFromError(error) {\n    return { hasError: true, error };\n  }\n\n  componentDidCatch(error, errorInfo) {\n    console.error('ErrorBoundary caught an error:', error, errorInfo);\n  }\n\n  render() {\n    if (this.state.hasError) {\n      return (\n        <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n          <div className=\"max-w-md w-full bg-white rounded-lg shadow-lg p-6 text-center\">\n            <div className=\"text-red-500 text-6xl mb-4\"></div>\n            <h1 className=\"text-2xl font-bold text-gray-900 mb-2\">Something went wrong</h1>\n            <p className=\"text-gray-600 mb-4\">\n              The application encountered an error. Please try refreshing the page.\n            </p>\n            <button\n              onClick={() => window.location.reload()}\n              className=\"btn-base btn-info py-2 px-4\"\n            >\n              Refresh Page\n            </button>\n          </div>\n        </div>\n      );\n    }\n\n    return this.props.children;\n  }\n}\n\nexport default ErrorBoundary;","path":null,"size_bytes":1237,"size_tokens":null},"src/components/admin/AdminHeader.js":{"content":"\"use client\";\n\nimport { usePathname } from \"next/navigation\";\nimport Link from \"next/link\";\n\nexport default function AdminHeader({ user }) {\n  const pathname = usePathname();\n\n  const getBreadcrumbs = () => {\n    const paths = pathname.split('/').filter(Boolean);\n    \n    const breadcrumbs = [{ name: 'Admin', href: '/admin' }];\n    \n    if (paths.length > 1) {\n      const section = paths[1];\n      const sectionName = section.charAt(0).toUpperCase() + section.slice(1);\n      breadcrumbs.push({ name: sectionName, href: `/admin/${section}` });\n    }\n    \n    return breadcrumbs;\n  };\n\n  const getPageTitle = () => {\n    const paths = pathname.split('/').filter(Boolean);\n    \n    if (pathname === '/admin') return 'Analytics Dashboard';\n    if (paths[1]) {\n      const section = paths[1];\n      return section.charAt(0).toUpperCase() + section.slice(1);\n    }\n    return 'Admin';\n  };\n\n  const breadcrumbs = getBreadcrumbs();\n  const pageTitle = getPageTitle();\n\n  return (\n    <header className=\"sticky top-0 z-10 bg-white border-b border-gray-200 px-6 py-4 shadow-sm\">\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <nav className=\"flex items-center space-x-2 text-sm text-gray-500 mb-2\">\n            {breadcrumbs.map((crumb, index) => (\n              <div key={crumb.href} className=\"flex items-center\">\n                {index > 0 && (\n                  <svg className=\"w-4 h-4 mx-2\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                    <path fillRule=\"evenodd\" d=\"M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z\" clipRule=\"evenodd\" />\n                  </svg>\n                )}\n                <Link\n                  href={crumb.href}\n                  className=\"hover:text-emerald-600 transition-colors\"\n                >\n                  {crumb.name}\n                </Link>\n              </div>\n            ))}\n          </nav>\n          <h1 className=\"text-2xl font-bold text-gray-900\">{pageTitle}</h1>\n        </div>\n\n        <div className=\"flex items-center space-x-4\">\n          <button className=\"p-2 text-gray-400 hover:text-gray-600 rounded-lg hover:bg-gray-100 transition-colors\">\n            <svg className=\"w-6 h-6\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9\" />\n            </svg>\n          </button>\n\n          <Link\n            href=\"/\"\n            className=\"text-sm text-gray-600 hover:text-emerald-600 transition-colors font-medium\"\n          >\n            View Site\n          </Link>\n\n          <div className=\"w-10 h-10 bg-emerald-600 rounded-full flex items-center justify-center text-white text-sm font-bold\">\n            {user?.displayName?.charAt(0) || user?.email?.charAt(0) || \"A\"}\n          </div>\n        </div>\n      </div>\n    </header>\n  );\n}\n","path":null,"size_bytes":3083,"size_tokens":null},"src/app/(chrome)/create/background/page.js":{"content":"\"use client\";\n\nimport { useState, useRef, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { useAuth } from '../../../../hooks/useAuth';\nimport { generateSlug } from '../../../../utils/slugGenerator';\nimport { getCampaignUploadUrl } from '../../../../utils/campaignStorage';\nimport { createCampaign } from '../../../../lib/firestore';\nimport CampaignStepIndicator from '../../../../components/CampaignStepIndicator';\n\nexport default function CreateBackgroundPage() {\n  const router = useRouter();\n  const { user, loading: authLoading } = useAuth();\n  const [step, setStep] = useState(1); // 1 = upload image, 2 = fill details\n  const [loading, setLoading] = useState(false);\n  const [errors, setErrors] = useState({});\n  const [showAuthModal, setShowAuthModal] = useState(false);\n  \n  const imageInputRef = useRef();\n\n  // Form data state\n  const [formData, setFormData] = useState({\n    campaignImage: null,\n    campaignImagePreview: '',\n    title: '',\n    description: '',\n    captionTemplate: ''\n  });\n\n  const handleInputChange = (field, value) => {\n    setFormData(prev => ({ ...prev, [field]: value }));\n    if (errors[field]) {\n      setErrors(prev => ({ ...prev, [field]: '' }));\n    }\n  };\n\n  const handleImageSelect = (file) => {\n    if (!file) return;\n\n    // Clear previous errors\n    setErrors({});\n\n    // File size validation (5MB limit)\n    const maxSize = 5 * 1024 * 1024;\n    if (file.size > maxSize) {\n      setErrors({ campaignImage: `Image must be smaller than 5MB. Current size: ${(file.size / (1024 * 1024)).toFixed(1)}MB` });\n      return;\n    }\n\n    // File type validation\n    if (!file.type.startsWith('image/')) {\n      setErrors({ campaignImage: 'Please select a valid image file (PNG, JPG, or WEBP)' });\n      return;\n    }\n\n    // Valid image - show preview\n    const reader = new FileReader();\n    reader.onload = (e) => {\n      setFormData(prev => ({\n        ...prev,\n        campaignImage: file,\n        campaignImagePreview: e.target.result\n      }));\n      // Automatically move to step 2\n      setStep(2);\n    };\n    reader.readAsDataURL(file);\n  };\n\n  const handleRemoveImage = () => {\n    setFormData(prev => ({\n      ...prev,\n      campaignImage: null,\n      campaignImagePreview: ''\n    }));\n    if (imageInputRef.current) {\n      imageInputRef.current.value = '';\n    }\n    setStep(1);\n    setErrors({});\n  };\n\n  const validateStep2 = () => {\n    const newErrors = {};\n\n    if (!formData.title.trim()) {\n      newErrors.title = 'Title is required';\n    } else if (formData.title.length < 3) {\n      newErrors.title = 'Title must be at least 3 characters';\n    }\n\n    setErrors(newErrors);\n    return Object.keys(newErrors).length === 0;\n  };\n\n  const handlePublish = async () => {\n    // Check if user is authenticated\n    if (!user) {\n      setShowAuthModal(true);\n      return;\n    }\n\n    // Validate form\n    if (!validateStep2()) return;\n\n    setLoading(true);\n    try {\n      // Generate slug\n      const slug = generateSlug(formData.title);\n      const campaignId = slug; // Use slug as campaign ID\n\n      // Get auth token\n      const token = await user.getIdToken();\n\n      // Get upload URL from API\n      const { uploadUrl, path } = await getCampaignUploadUrl(campaignId, formData.campaignImage.size, formData.campaignImage.type, token);\n\n      // Upload image to Supabase\n      await fetch(uploadUrl, {\n        method: 'PUT',\n        body: formData.campaignImage,\n        headers: {\n          'Content-Type': formData.campaignImage.type\n        }\n      });\n\n      // Build image URL\n      const imageUrl = `${process.env.NEXT_PUBLIC_SUPABASE_URL}/storage/v1/object/public/uploads/${path}`;\n\n      // Create campaign in Firestore\n      const campaignData = {\n        type: 'background',\n        title: formData.title.trim(),\n        description: formData.description.trim(),\n        slug: slug,\n        storagePath: path,\n        imageUrl: imageUrl,\n        captionTemplate: formData.captionTemplate.trim()\n      };\n\n      const result = await createCampaign(campaignData, user.uid);\n\n      if (result.success) {\n        router.push(`/campaign/${slug}`);\n      } else {\n        throw new Error(result.error || 'Failed to create campaign');\n      }\n    } catch (error) {\n      console.error('Error creating campaign:', error);\n      setErrors({ general: 'Failed to create campaign. Please try again.' });\n      setLoading(false);\n    }\n  };\n\n  const handleAuthModalClose = () => {\n    setShowAuthModal(false);\n  };\n\n  const handleSignIn = () => {\n    // Redirect to sign in page\n    router.push('/signin?redirect=/create/background');\n  };\n\n  return (\n    <div className=\"min-h-screen bg-white\">\n      <div className=\"min-h-screen flex\">\n        {/* Main Content */}\n        <div className=\"flex-1 w-full flex flex-col justify-center py-8 px-4 sm:px-6 lg:px-16 xl:px-20 pt-20\">\n          <div className=\"mx-auto w-full max-w-4xl\">\n            {/* Header */}\n            <div className=\"text-center bg-yellow-400 px-6 py-6 rounded-t-xl\">\n              <h1 className=\"text-2xl sm:text-3xl font-bold text-emerald-700\">Create Background Campaign</h1>\n              <p className=\"text-base sm:text-lg text-gray-700 mt-2\">\n                Upload a background image for photos to sit on top\n              </p>\n            </div>\n\n            {/* Progress Indicator */}\n            <div className=\"bg-yellow-400 px-6 pb-4\">\n              <CampaignStepIndicator\n                currentStep={step}\n                totalSteps={2}\n                labels={['Upload Image', 'Campaign Details']}\n              />\n            </div>\n\n            {/* Content Card */}\n            <div className=\"bg-white rounded-b-xl border border-t-0 border-gray-200 px-6 py-8 shadow-sm\">\n              {errors.general && (\n                <div className=\"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm text-center\">\n                  {errors.general}\n                </div>\n              )}\n\n              {/* Step 1: Upload Image */}\n              {step === 1 && (\n                <div className=\"space-y-6\">\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                      Background Image *\n                    </label>\n                    <div className=\"space-y-3\">\n                      {/* Upload Area */}\n                      <div \n                        onClick={() => imageInputRef.current?.click()}\n                        className=\"w-full h-80 max-w-md mx-auto rounded-lg overflow-hidden border-2 border-dashed border-gray-300 hover:border-emerald-500 cursor-pointer transition-colors\"\n                      >\n                        <div className=\"w-full h-full bg-gray-50 flex flex-col items-center justify-center p-6\">\n                          <svg className=\"w-16 h-16 text-gray-400 mb-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12\" />\n                          </svg>\n                          <p className=\"text-gray-600 font-medium mb-1\">Click to upload background</p>\n                          <p className=\"text-gray-500 text-sm\">PNG, JPG, or WEBP</p>\n                          <p className=\"text-gray-400 text-xs mt-2\">Max 5MB  No transparency required</p>\n                        </div>\n                      </div>\n                      <input\n                        type=\"file\"\n                        ref={imageInputRef}\n                        onChange={(e) => handleImageSelect(e.target.files[0])}\n                        accept=\"image/png,image/jpeg,image/jpg,image/webp\"\n                        className=\"hidden\"\n                      />\n                      {errors.campaignImage && (\n                        <p className=\"text-red-600 text-sm text-center\">{errors.campaignImage}</p>\n                      )}\n                    </div>\n                  </div>\n\n                  {/* Info Box */}\n                  <div className=\"bg-emerald-50 border border-emerald-200 rounded-lg p-4\">\n                    <h3 className=\"font-semibold text-emerald-900 mb-2 flex items-center gap-2\">\n                      <svg className=\"w-5 h-5\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                        <path fillRule=\"evenodd\" d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z\" clipRule=\"evenodd\" />\n                      </svg>\n                      What is a background?\n                    </h3>\n                    <ul className=\"space-y-1 text-sm text-emerald-800\">\n                      <li className=\"flex items-start gap-2\">\n                        <span className=\"text-emerald-600 mt-1\"></span>\n                        <span>Solid image that appears behind visitor photos</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <span className=\"text-emerald-600 mt-1\"></span>\n                        <span>Visitor photo sits on top of the background</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <span className=\"text-emerald-600 mt-1\"></span>\n                        <span>Square images recommended but all sizes accepted (no cropping)</span>\n                      </li>\n                      <li className=\"flex items-start gap-2\">\n                        <span className=\"text-emerald-600 mt-1\"></span>\n                        <span>No transparency required</span>\n                      </li>\n                    </ul>\n                  </div>\n                </div>\n              )}\n\n              {/* Step 2: Fill Details */}\n              {step === 2 && (\n                <div className=\"space-y-6\">\n                  {/* Image Preview */}\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                      Background Preview\n                    </label>\n                    <div className=\"w-full h-80 max-w-md mx-auto rounded-lg overflow-hidden border-2 border-gray-200 bg-gray-50 flex items-center justify-center\">\n                      {formData.campaignImagePreview && (\n                        <img\n                          src={formData.campaignImagePreview}\n                          alt=\"Background preview\"\n                          className=\"max-w-full max-h-full object-contain\"\n                        />\n                      )}\n                    </div>\n                    <div className=\"flex justify-center mt-3\">\n                      <button\n                        type=\"button\"\n                        onClick={handleRemoveImage}\n                        className=\"btn-base btn-secondary px-3 py-1.5 text-sm\"\n                      >\n                        Change Image\n                      </button>\n                    </div>\n                  </div>\n\n                  {/* Title */}\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                      Campaign Title *\n                    </label>\n                    <input\n                      type=\"text\"\n                      value={formData.title}\n                      onChange={(e) => handleInputChange('title', e.target.value)}\n                      placeholder=\"e.g., Beautiful Nature Background\"\n                      className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all text-gray-900\"\n                    />\n                    {errors.title && (\n                      <p className=\"text-red-600 text-sm mt-1\">{errors.title}</p>\n                    )}\n                  </div>\n\n                  {/* Description */}\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                      Description (optional)\n                    </label>\n                    <textarea\n                      value={formData.description}\n                      onChange={(e) => handleInputChange('description', e.target.value)}\n                      placeholder=\"Describe your campaign...\"\n                      rows={3}\n                      className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all resize-none text-gray-900\"\n                    />\n                  </div>\n\n                  {/* Caption Template */}\n                  <div>\n                    <label className=\"block text-sm font-medium text-gray-800 mb-2\">\n                      Share Caption Template (optional)\n                    </label>\n                    <textarea\n                      value={formData.captionTemplate}\n                      onChange={(e) => handleInputChange('captionTemplate', e.target.value)}\n                      placeholder=\"e.g., Beautiful nature background for my photo! \"\n                      rows={2}\n                      className=\"w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent outline-none transition-all resize-none text-gray-900\"\n                    />\n                    <p className=\"text-gray-500 text-xs mt-1\">This text will be pre-filled when visitors share their photos</p>\n                  </div>\n\n                  {/* Action Buttons */}\n                  <div className=\"flex gap-3 pt-4\">\n                    <button\n                      type=\"button\"\n                      onClick={() => setStep(1)}\n                      className=\"btn-base btn-secondary flex-1 py-3\"\n                      disabled={loading}\n                    >\n                      Back\n                    </button>\n                    <button\n                      type=\"button\"\n                      onClick={handlePublish}\n                      className=\"btn-base btn-primary flex-1 py-3\"\n                      disabled={loading}\n                    >\n                      {loading ? 'Publishing...' : 'Publish Campaign'}\n                    </button>\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Auth Modal */}\n      {showAuthModal && (\n        <>\n          <div \n            className=\"fixed inset-0 bg-black/50 z-50\"\n            onClick={handleAuthModalClose}\n          />\n          <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4\">\n            <div \n              className=\"bg-white rounded-xl max-w-md w-full p-6 shadow-lg\"\n              onClick={(e) => e.stopPropagation()}\n            >\n              <h3 className=\"text-xl font-bold text-gray-900 mb-2\">Sign in to publish</h3>\n              <p className=\"text-gray-600 mb-6\">\n                You need to sign in to publish your campaign. Your work will be saved.\n              </p>\n              <div className=\"flex gap-3\">\n                <button\n                  onClick={handleAuthModalClose}\n                  className=\"btn-base btn-secondary flex-1\"\n                >\n                  Go Back\n                </button>\n                <button\n                  onClick={handleSignIn}\n                  className=\"btn-base btn-primary flex-1\"\n                >\n                  Sign In\n                </button>\n              </div>\n            </div>\n          </div>\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":15641,"size_tokens":null},"src/app/(chrome)/campaign/[slug]/adjust/page.js":{"content":"\"use client\";\n\nimport { useState, useRef, useEffect, useCallback } from 'react';\nimport { useParams, useRouter } from 'next/navigation';\nimport { useCampaignSession } from '../../../../../contexts/CampaignSessionContext';\nimport { requirePhotoUpload } from '../../../../../utils/campaignRouteGuards';\nimport { loadImage, composeImages } from '../../../../../utils/imageComposition';\nimport { getCampaignPreview } from '../../../../../utils/imageTransform';\nimport LoadingSpinner from '../../../../../components/LoadingSpinner';\nimport CampaignStepIndicator from '../../../../../components/CampaignStepIndicator';\nimport ErrorBoundary from '../../../../../components/ErrorBoundary';\n\nexport default function CampaignAdjustPage() {\n  return (\n    <ErrorBoundary>\n      <CampaignAdjustContent />\n    </ErrorBoundary>\n  );\n}\n\nfunction CampaignAdjustContent() {\n  const params = useParams();\n  const router = useRouter();\n  const slug = params.slug;\n  const campaignSession = useCampaignSession();\n\n  const [session, setSession] = useState(null);\n  const [campaign, setCampaign] = useState(null);\n  const [userPhoto, setUserPhoto] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [adjustments, setAdjustments] = useState({ scale: 1.0, x: 0, y: 0, rotation: 0 });\n  const [downloading, setDownloading] = useState(false);\n  const [error, setError] = useState('');\n  const [imagesReady, setImagesReady] = useState(false);\n  const [isInteracting, setIsInteracting] = useState(false);\n\n  const canvasRef = useRef(null);\n  const offscreenCanvasRef = useRef(null);\n  const userPhotoImgRef = useRef(null);\n  const campaignImgRef = useRef(null);\n  const rafRef = useRef(null);\n  const canvasInitializedRef = useRef(false);\n  \n  const pointersRef = useRef(new Map());\n  const isDraggingRef = useRef(false);\n  const dragStartRef = useRef({ x: 0, y: 0 });\n  const lastPinchDistanceRef = useRef(null);\n  const lastRotationAngleRef = useRef(null);\n  const isRotatingRef = useRef(false);\n  const rotationStartRef = useRef(0);\n\n  useEffect(() => {\n    const loadSession = async () => {\n      const currentSession = campaignSession.getSession(slug);\n      \n      if (!requirePhotoUpload(currentSession, router, slug)) {\n        return;\n      }\n      \n      setSession(currentSession);\n      setCampaign(currentSession.campaignData);\n      \n      if (currentSession.adjustments) {\n        setAdjustments(currentSession.adjustments);\n      }\n      \n      if (currentSession.userPhotoPreview) {\n        try {\n          const dataUrl = currentSession.userPhotoPreview;\n          const [header, base64Data] = dataUrl.split(',');\n          const mimeType = header.match(/:(.*?);/)?.[1] || 'image/jpeg';\n          const byteString = atob(base64Data);\n          const byteArray = new Uint8Array(byteString.length);\n          for (let i = 0; i < byteString.length; i++) {\n            byteArray[i] = byteString.charCodeAt(i);\n          }\n          const blob = new Blob([byteArray], { type: mimeType });\n          const file = new File([blob], currentSession.userPhoto?.name || 'photo.jpg', {\n            type: currentSession.userPhoto?.type || mimeType\n          });\n          setUserPhoto(file);\n        } catch (error) {\n          console.error('Error loading photo:', error);\n          setError('Failed to load photo. Please go back and upload again.');\n        }\n      }\n      \n      setLoading(false);\n    };\n    \n    loadSession();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [slug, router]);\n\n  const initializeCanvas = useCallback(async () => {\n    if (!campaign || !canvasRef.current || canvasInitializedRef.current) {\n      return;\n    }\n    \n    const campaignImageUrl = getCampaignPreview(campaign.imageUrl);\n    \n    try {\n      const img = await loadImage(campaignImageUrl);\n      campaignImgRef.current = img;\n      \n      const canvas = canvasRef.current;\n      canvas.width = img.width;\n      canvas.height = img.height;\n      \n      const offscreen = document.createElement('canvas');\n      offscreen.width = img.width;\n      offscreen.height = img.height;\n      offscreenCanvasRef.current = offscreen;\n      \n      canvasInitializedRef.current = true;\n      \n      if (userPhotoImgRef.current) {\n        setImagesReady(true);\n      }\n    } catch (error) {\n      console.error('Error initializing canvas:', error);\n    }\n  }, [campaign]);\n\n  useEffect(() => {\n    initializeCanvas();\n  }, [initializeCanvas]);\n\n  useEffect(() => {\n    if (!userPhoto) {\n      return;\n    }\n    \n    const loadUserImage = async () => {\n      try {\n        const img = await loadImage(userPhoto);\n        userPhotoImgRef.current = img;\n        \n        if (campaignImgRef.current && offscreenCanvasRef.current) {\n          setImagesReady(true);\n        }\n      } catch (error) {\n        console.error('Error loading user photo:', error);\n      }\n    };\n    \n    loadUserImage();\n  }, [userPhoto]);\n\n  const renderPreview = useCallback(() => {\n    if (!offscreenCanvasRef.current || !canvasRef.current || !userPhotoImgRef.current || !campaignImgRef.current) {\n      return;\n    }\n\n    const offscreen = offscreenCanvasRef.current;\n    const display = canvasRef.current;\n    const ctx = offscreen.getContext('2d', { alpha: true });\n    \n    if (!ctx) {\n      return;\n    }\n\n    ctx.clearRect(0, 0, offscreen.width, offscreen.height);\n\n    const { scale, x, y, rotation } = adjustments;\n    const userImg = userPhotoImgRef.current;\n    const campaignImg = campaignImgRef.current;\n    const campaignOpacity = isInteracting ? 0.5 : 1.0;\n\n    ctx.save();\n    const centerX = offscreen.width / 2;\n    const centerY = offscreen.height / 2;\n    \n    ctx.translate(centerX + x, centerY + y);\n    ctx.rotate((rotation * Math.PI) / 180);\n    \n    const scaledWidth = userImg.width * scale;\n    const scaledHeight = userImg.height * scale;\n    \n    if (campaign.type === 'frame') {\n      ctx.drawImage(userImg, -scaledWidth / 2, -scaledHeight / 2, scaledWidth, scaledHeight);\n      ctx.restore();\n      ctx.globalAlpha = campaignOpacity;\n      ctx.drawImage(campaignImg, 0, 0, offscreen.width, offscreen.height);\n      ctx.globalAlpha = 1.0;\n    } else {\n      ctx.restore();\n      ctx.globalAlpha = campaignOpacity;\n      ctx.drawImage(campaignImg, 0, 0, offscreen.width, offscreen.height);\n      ctx.globalAlpha = 1.0;\n      ctx.save();\n      ctx.translate(centerX + x, centerY + y);\n      ctx.rotate((rotation * Math.PI) / 180);\n      ctx.drawImage(userImg, -scaledWidth / 2, -scaledHeight / 2, scaledWidth, scaledHeight);\n      ctx.restore();\n    }\n\n    const displayCtx = display.getContext('2d', { alpha: true });\n    if (displayCtx) {\n      displayCtx.clearRect(0, 0, display.width, display.height);\n      displayCtx.drawImage(offscreen, 0, 0);\n    }\n  }, [adjustments, campaign, isInteracting]);\n\n  // Trigger initial render when images are ready\n  useEffect(() => {\n    if (imagesReady) {\n      renderPreview();\n    }\n  }, [imagesReady, renderPreview]);\n\n  useEffect(() => {\n    if (rafRef.current) {\n      cancelAnimationFrame(rafRef.current);\n    }\n\n    rafRef.current = requestAnimationFrame(() => {\n      renderPreview();\n    });\n\n    return () => {\n      if (rafRef.current) {\n        cancelAnimationFrame(rafRef.current);\n      }\n    };\n  }, [renderPreview]);\n\n  useEffect(() => {\n    if (!slug || !session) return;\n    campaignSession.setAdjustments(slug, adjustments);\n  }, [adjustments, slug, session, campaignSession]);\n\n  // Attach wheel listener with passive: false to allow preventDefault\n  useEffect(() => {\n    const canvas = canvasRef.current;\n    if (!canvas) return;\n\n    const handleWheel = (e) => {\n      if (!userPhoto) return;\n      e.preventDefault();\n      \n      const delta = e.deltaY > 0 ? -0.1 : 0.1;\n      setAdjustments(prev => ({\n        ...prev,\n        scale: Math.max(0.1, Math.min(10, prev.scale + delta))\n      }));\n    };\n\n    canvas.addEventListener('wheel', handleWheel, { passive: false });\n    return () => canvas.removeEventListener('wheel', handleWheel);\n  }, [userPhoto]);\n\n  const getPointerDistance = (p1, p2) => {\n    const dx = p2.clientX - p1.clientX;\n    const dy = p2.clientY - p1.clientY;\n    return Math.sqrt(dx * dx + dy * dy);\n  };\n\n  const getPointerAngle = (p1, p2) => {\n    const dx = p2.clientX - p1.clientX;\n    const dy = p2.clientY - p1.clientY;\n    return Math.atan2(dy, dx) * (180 / Math.PI);\n  };\n\n  const handlePointerDown = (e) => {\n    if (!userPhoto) return;\n    e.preventDefault();\n    \n    setIsInteracting(true);\n    \n    pointersRef.current.set(e.pointerId, {\n      clientX: e.clientX,\n      clientY: e.clientY,\n      button: e.button\n    });\n\n    if (pointersRef.current.size === 2) {\n      const pointers = Array.from(pointersRef.current.values());\n      lastPinchDistanceRef.current = getPointerDistance(pointers[0], pointers[1]);\n      lastRotationAngleRef.current = getPointerAngle(pointers[0], pointers[1]);\n      isDraggingRef.current = false;\n    } else if (pointersRef.current.size === 1) {\n      if (e.button === 2 || e.shiftKey) {\n        isRotatingRef.current = true;\n        rotationStartRef.current = e.clientX;\n      } else {\n        isDraggingRef.current = true;\n        dragStartRef.current = { x: e.clientX, y: e.clientY };\n      }\n    }\n  };\n\n  const handlePointerMove = (e) => {\n    e.preventDefault();\n    \n    if (!pointersRef.current.has(e.pointerId)) return;\n    \n    pointersRef.current.set(e.pointerId, {\n      clientX: e.clientX,\n      clientY: e.clientY,\n      button: e.button\n    });\n\n    if (pointersRef.current.size === 2) {\n      const pointers = Array.from(pointersRef.current.values());\n      const currentDistance = getPointerDistance(pointers[0], pointers[1]);\n      const currentAngle = getPointerAngle(pointers[0], pointers[1]);\n\n      if (lastPinchDistanceRef.current !== null) {\n        const scaleDelta = (currentDistance - lastPinchDistanceRef.current) * 0.01;\n        setAdjustments(prev => ({\n          ...prev,\n          scale: Math.max(0.1, Math.min(10, prev.scale + scaleDelta))\n        }));\n      }\n\n      if (lastRotationAngleRef.current !== null) {\n        const angleDelta = currentAngle - lastRotationAngleRef.current;\n        setAdjustments(prev => ({\n          ...prev,\n          rotation: ((prev.rotation || 0) + angleDelta) % 360\n        }));\n      }\n\n      lastPinchDistanceRef.current = currentDistance;\n      lastRotationAngleRef.current = currentAngle;\n      \n    } else if (pointersRef.current.size === 1) {\n      if (isRotatingRef.current) {\n        const deltaX = e.clientX - rotationStartRef.current;\n        const rotationDelta = deltaX * 0.5;\n        setAdjustments(prev => ({\n          ...prev,\n          rotation: ((prev.rotation || 0) + rotationDelta) % 360\n        }));\n        rotationStartRef.current = e.clientX;\n      } else if (isDraggingRef.current) {\n        const canvas = canvasRef.current;\n        if (!canvas) return;\n        \n        const rect = canvas.getBoundingClientRect();\n        const scaleX = canvas.width / rect.width;\n        const scaleY = canvas.height / rect.height;\n        \n        const deltaX = (e.clientX - dragStartRef.current.x) * scaleX;\n        const deltaY = (e.clientY - dragStartRef.current.y) * scaleY;\n        \n        setAdjustments(prev => ({ ...prev, x: prev.x + deltaX, y: prev.y + deltaY }));\n        dragStartRef.current = { x: e.clientX, y: e.clientY };\n      }\n    }\n  };\n\n  const handlePointerUp = (e) => {\n    pointersRef.current.delete(e.pointerId);\n    \n    if (pointersRef.current.size < 2) {\n      lastPinchDistanceRef.current = null;\n      lastRotationAngleRef.current = null;\n    }\n    \n    if (pointersRef.current.size === 0) {\n      isDraggingRef.current = false;\n      isRotatingRef.current = false;\n      setIsInteracting(false);\n    }\n  };\n\n  const handleZoomChange = (e) => {\n    const scale = parseFloat(e.target.value);\n    setAdjustments(prev => ({ ...prev, scale }));\n  };\n\n  const handleRotationChange = (e) => {\n    const rotation = parseInt(e.target.value);\n    setAdjustments(prev => ({ ...prev, rotation }));\n  };\n\n  const handleChangePhoto = () => {\n    router.push(`/campaign/${slug}`);\n  };\n\n  const handleDownload = async () => {\n    if (!userPhoto || !campaign) return;\n    \n    setDownloading(true);\n    setError('');\n    \n    try {\n      const { blob } = await composeImages(\n        userPhoto,\n        getCampaignPreview(campaign.imageUrl),\n        adjustments,\n        campaign.type\n      );\n      \n      const url = URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `${campaign.slug}-${Date.now()}.png`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      URL.revokeObjectURL(url);\n      \n      try {\n        await fetch('/api/campaigns/track-download', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ campaignId: campaign.id })\n        });\n      } catch (trackError) {\n        if (process.env.NODE_ENV === 'development') {\n          console.warn('Failed to track download:', trackError);\n        }\n      }\n      \n      campaignSession.markDownloaded(slug);\n      router.push(`/campaign/${slug}/result`);\n    } catch (error) {\n      console.error('Error downloading image:', error);\n      setError('Failed to download image. Please try again.');\n      setDownloading(false);\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-white flex items-center justify-center\">\n        <LoadingSpinner />\n      </div>\n    );\n  }\n\n  if (!session || !campaign || !userPhoto) {\n    return (\n      <div className=\"min-h-screen bg-white flex items-center justify-center\">\n        <LoadingSpinner />\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-white\">\n      <div className=\"min-h-screen flex\">\n        <div className=\"flex-1 w-full flex flex-col py-8 px-4 sm:px-6 lg:px-8 pt-20\">\n          <div className=\"mx-auto w-full max-w-5xl\">\n            \n            <div className=\"text-center mb-6 bg-yellow-400 px-6 py-5 rounded-t-xl\">\n              <CampaignStepIndicator currentStep={2} />\n              <h1 className=\"text-2xl sm:text-3xl font-bold text-gray-900\">Adjust Your Photo</h1>\n            </div>\n            \n            <div className=\"bg-white rounded-b-xl border border-t-0 border-gray-200 shadow-sm\">\n              \n              {error && (\n                <div className=\"mx-4 mt-4 p-4 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm text-center\">\n                  {error}\n                </div>\n              )}\n\n              <div className=\"grid grid-cols-1 lg:grid-cols-[minmax(0,1.1fr)_minmax(320px,0.9fr)] gap-6 p-4 sm:p-6\">\n                \n                <div className=\"space-y-3\">\n                  <h2 className=\"text-lg font-bold text-gray-900\">Preview</h2>\n                  \n                  <div className=\"relative bg-gray-100 rounded-lg border-2 border-gray-300\">\n                    <canvas\n                      ref={(el) => {\n                        canvasRef.current = el;\n                        if (el && campaign) {\n                          initializeCanvas();\n                        }\n                      }}\n                      className=\"w-full h-auto cursor-move\"\n                      style={{\n                        touchAction: 'none',\n                        userSelect: 'none',\n                        WebkitUserSelect: 'none',\n                        display: 'block',\n                        minHeight: '300px'\n                      }}\n                      onPointerDown={handlePointerDown}\n                      onPointerMove={handlePointerMove}\n                      onPointerUp={handlePointerUp}\n                      onPointerCancel={handlePointerUp}\n                      onPointerLeave={handlePointerUp}\n                      onContextMenu={(e) => e.preventDefault()}\n                    />\n                  </div>\n\n                </div>\n\n                <div className=\"space-y-5\">\n                  \n                  <div>\n                    <h2 className=\"text-lg font-bold text-gray-900 mb-3\">Transform</h2>\n                    \n                    <div className=\"space-y-4\">\n                      <div>\n                        <div className=\"flex items-center justify-between mb-2\">\n                          <label className=\"text-sm font-medium text-gray-700\">\n                            Zoom\n                          </label>\n                          <span className=\"text-sm text-gray-600\">{adjustments.scale.toFixed(1)}x</span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <button\n                            onClick={() => setAdjustments(prev => ({ ...prev, scale: Math.max(0.1, prev.scale - 0.1) }))}\n                            className=\"btn-base btn-neutral flex-shrink-0 w-8 h-8 rounded-lg\"\n                            aria-label=\"Zoom out\"\n                          >\n                            \n                          </button>\n                          <input\n                            type=\"range\"\n                            min=\"0.1\"\n                            max=\"10\"\n                            step=\"0.1\"\n                            value={adjustments.scale}\n                            onChange={handleZoomChange}\n                            className=\"flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-emerald-500\"\n                          />\n                          <button\n                            onClick={() => setAdjustments(prev => ({ ...prev, scale: Math.min(10, prev.scale + 0.1) }))}\n                            className=\"btn-base btn-neutral flex-shrink-0 w-8 h-8 rounded-lg\"\n                            aria-label=\"Zoom in\"\n                          >\n                            +\n                          </button>\n                        </div>\n                      </div>\n\n                      <div>\n                        <div className=\"flex items-center justify-between mb-2\">\n                          <label className=\"text-sm font-medium text-gray-700\">\n                            Rotation\n                          </label>\n                          <span className=\"text-sm text-gray-600\">{(adjustments.rotation || 0).toFixed(1)}</span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <button\n                            onClick={() => setAdjustments(prev => ({ ...prev, rotation: Math.max(-180, (prev.rotation || 0) - 0.1) }))}\n                            className=\"btn-base btn-neutral flex-shrink-0 w-8 h-8 rounded-lg\"\n                            aria-label=\"Rotate counter-clockwise\"\n                          >\n                            \n                          </button>\n                          <input\n                            type=\"range\"\n                            min=\"-180\"\n                            max=\"180\"\n                            step=\"0.1\"\n                            value={adjustments.rotation || 0}\n                            onChange={handleRotationChange}\n                            className=\"flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-emerald-500\"\n                          />\n                          <button\n                            onClick={() => setAdjustments(prev => ({ ...prev, rotation: Math.min(180, (prev.rotation || 0) + 0.1) }))}\n                            className=\"btn-base btn-neutral flex-shrink-0 w-8 h-8 rounded-lg\"\n                            aria-label=\"Rotate clockwise\"\n                          >\n                            +\n                          </button>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n\n                  <button\n                    onClick={handleChangePhoto}\n                    className=\"btn-base btn-neutral w-full py-2 text-sm\"\n                  >\n                    Change Photo\n                  </button>\n\n                  <div className=\"pt-3 border-t border-gray-200\">\n                    <button\n                      onClick={handleDownload}\n                      disabled={downloading}\n                      className={`btn-base w-full py-4 font-bold text-lg transition-colors ${\n                        downloading\n                          ? 'btn-primary opacity-70 cursor-wait'\n                          : 'btn-primary'\n                      }`}\n                    >\n                      {downloading ? 'Downloading...' : 'Download Image'}\n                    </button>\n                    \n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":20862,"size_tokens":null},"src/app/not-found.js":{"content":"export default function NotFound() {\n  return (\n    <div style={{\n      minHeight: '100vh',\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'center',\n      fontFamily: 'system-ui, -apple-system, Arial, sans-serif',\n      padding: '20px',\n      backgroundColor: 'white'\n    }}>\n      <div style={{ \n        textAlign: 'center',\n        maxWidth: '400px',\n        padding: '40px 20px'\n      }}>\n        <p style={{\n          fontSize: '72px',\n          color: '#047857',\n          margin: '0 0 20px 0',\n          fontWeight: 'bold',\n          lineHeight: '1'\n        }}>\n          404\n        </p>\n        <p style={{\n          fontSize: '18px',\n          color: '#000',\n          margin: '0 0 8px 0',\n          fontWeight: '500'\n        }}>\n          Page not found\n        </p>\n        <p style={{\n          fontSize: '14px',\n          color: '#000',\n          margin: '0 0 30px 0',\n          lineHeight: '1.4',\n          opacity: '0.8'\n        }}>\n          The page you're looking for doesn't exist.\n        </p>\n        <a \n          href=\"/\" \n          className=\"btn-base btn-secondary border-2 border-emerald-700 text-emerald-700 px-5 py-2 text-sm font-semibold rounded-full\"\n        >\n          Go to homepage\n        </a>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":1285,"size_tokens":null},"src/utils/slugGenerator.js":{"content":"/**\n * Generate URL-friendly slug from campaign title\n * \n * Algorithm (from CAMPAIGN_SYSTEM.md):\n * 1. Convert title to lowercase\n * 2. Replace spaces with hyphens\n * 3. Remove special characters\n * 4. Append random 4-character suffix (alphanumeric, base36)\n * 5. No uniqueness check needed (collision probability extremely low)\n * \n * @param {string} title - Campaign title\n * @returns {string} URL-friendly slug\n * \n * @example\n * generateSlug(\"Save Earth 2025\") // => \"save-earth-2025-k8m3\"\n * generateSlug(\"My Frame!\") // => \"my-frame-a7b2\"\n */\nexport function generateSlug(title) {\n  if (!title || typeof title !== 'string') {\n    throw new Error('Title is required and must be a string');\n  }\n  \n  // Step 1-3: Convert to lowercase, remove special chars, replace spaces\n  const baseSlug = title\n    .toLowerCase()\n    .trim()\n    .replace(/[^a-z0-9\\s-]/g, '')  // Remove special chars (keep letters, numbers, spaces, hyphens)\n    .replace(/\\s+/g, '-')           // Spaces to hyphens\n    .replace(/-+/g, '-')            // Multiple hyphens to single\n    .substring(0, 50);              // Max 50 chars for base slug\n  \n  // Handle edge case: empty slug after sanitization\n  if (!baseSlug) {\n    return `campaign-${generateRandomSuffix()}`;\n  }\n  \n  // Step 4: Generate 4-char random suffix (0-9, a-z)\n  const suffix = generateRandomSuffix();\n  \n  return `${baseSlug}-${suffix}`;\n}\n\n/**\n * Generate random 4-character alphanumeric suffix\n * Uses base36 (0-9, a-z) for URL-safe characters\n * \n * @returns {string} 4-character random suffix\n */\nfunction generateRandomSuffix() {\n  return Math.random().toString(36).substring(2, 6).padEnd(4, '0');\n}\n\n/**\n * Validate if a string is a valid slug format\n * \n * @param {string} slug - Slug to validate\n * @returns {boolean} True if valid slug format\n */\nexport function isValidSlug(slug) {\n  if (!slug || typeof slug !== 'string') {\n    return false;\n  }\n  \n  // Valid slug: lowercase letters, numbers, hyphens only\n  // Must end with 4-character suffix pattern\n  const slugPattern = /^[a-z0-9]+(-[a-z0-9]+)*-[a-z0-9]{4}$/;\n  return slugPattern.test(slug);\n}\n","path":null,"size_bytes":2108,"size_tokens":null},"src/components/ReportUserModal.js":{"content":"\"use client\";\n\nimport { useState } from 'react';\nimport { useAuth } from '../hooks/useAuth';\n\nexport default function ReportUserModal({ isOpen, onClose, reportedUserId, reportedUsername }) {\n  const { user } = useAuth();\n  const [reportReason, setReportReason] = useState('');\n  const [reportDetails, setReportDetails] = useState('');\n  const [reportSubmitting, setReportSubmitting] = useState(false);\n  const [reportSuccess, setReportSuccess] = useState(false);\n  const [error, setError] = useState('');\n\n  if (!isOpen) return null;\n\n  const handleReportSubmit = async (e) => {\n    e.preventDefault();\n    \n    if (!reportReason) {\n      setError('Please select a reason for reporting');\n      return;\n    }\n    \n    setReportSubmitting(true);\n    setError('');\n    \n    try {\n      const reportData = {\n        reportedUserId,\n        reportedUsername,\n        reportedBy: user?.uid || 'anonymous',\n        reason: reportReason,\n        details: reportDetails\n      };\n      \n      const response = await fetch('/api/reports/user', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(reportData),\n      });\n      \n      const result = await response.json();\n      \n      if (result.success) {\n        setReportSuccess(true);\n      } else {\n        setError(result.error || 'Failed to submit report');\n      }\n      \n      setReportSubmitting(false);\n    } catch (error) {\n      console.error('Error submitting user report:', error);\n      setError('Failed to submit report. Please try again.');\n      setReportSubmitting(false);\n    }\n  };\n\n  const handleClose = () => {\n    setReportReason('');\n    setReportDetails('');\n    setError('');\n    setReportSuccess(false);\n    onClose();\n  };\n\n  return (\n    <>\n      {/* Backdrop with blur */}\n      <div \n        className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 transition-opacity\"\n        onClick={handleClose}\n      />\n      \n      {/* Modal */}\n      <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none\">\n        <div \n          className=\"bg-white rounded-lg max-w-md w-full p-6 pointer-events-auto\"\n          onClick={(e) => e.stopPropagation()}\n        >\n          {reportSuccess ? (\n            // Success State\n            <div className=\"text-center py-4\">\n              <div className=\"mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4\">\n                <svg className=\"h-8 w-8 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                </svg>\n              </div>\n              <h3 className=\"text-xl font-bold text-gray-900 mb-2\">Report Submitted</h3>\n              <p className=\"text-gray-600 mb-6\">\n                Thank you for your report. We will review it shortly.\n              </p>\n              <button\n                onClick={handleClose}\n                className=\"btn-base btn-primary px-8 py-2 font-medium\"\n              >\n                OK\n              </button>\n            </div>\n          ) : (\n            // Report Form\n            <>\n              <h2 className=\"text-2xl font-bold text-gray-900 mb-4\">Report User</h2>\n              \n              {error && (\n                <div className=\"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm\">\n                  {error}\n                </div>\n              )}\n              \n              <form onSubmit={handleReportSubmit}>\n                <div className=\"mb-4\">\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Reason <span className=\"text-red-500\">*</span>\n                  </label>\n                  <select\n                    value={reportReason}\n                    onChange={(e) => setReportReason(e.target.value)}\n                    required\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all text-gray-900 bg-white\"\n                  >\n                    <option value=\"\" className=\"text-gray-400\">Select a reason</option>\n                    <option value=\"inappropriate_avatar\" className=\"text-gray-900\">Inappropriate Profile Picture</option>\n                    <option value=\"offensive_username\" className=\"text-gray-900\">Offensive Username</option>\n                    <option value=\"spam_bio\" className=\"text-gray-900\">Spam in Bio/Description</option>\n                    <option value=\"impersonation\" className=\"text-gray-900\">Impersonation</option>\n                    <option value=\"other\" className=\"text-gray-900\">Other</option>\n                  </select>\n                </div>\n                \n                <div className=\"mb-6\">\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Additional Details (Optional)\n                  </label>\n                  <textarea\n                    value={reportDetails}\n                    onChange={(e) => setReportDetails(e.target.value)}\n                    rows={3}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all resize-none text-gray-900 bg-white\"\n                    placeholder=\"Provide more context about your report...\"\n                  />\n                </div>\n                \n                <div className=\"flex gap-3\">\n                  <button\n                    type=\"button\"\n                    onClick={handleClose}\n                    className=\"btn-base btn-secondary flex-1 py-2 font-medium\"\n                    disabled={reportSubmitting}\n                  >\n                    Cancel\n                  </button>\n                  <button\n                    type=\"submit\"\n                    className=\"btn-base bg-red-500 hover:bg-red-600 text-white flex-1 py-2 font-medium disabled:opacity-50 disabled:cursor-not-allowed\"\n                    disabled={reportSubmitting || !reportReason}\n                  >\n                    {reportSubmitting ? 'Submitting...' : 'Submit Report'}\n                  </button>\n                </div>\n              </form>\n            </>\n          )}\n        </div>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":6429,"size_tokens":null},"src/app/api/reports/user/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\nimport { sendInAppNotification } from '@/utils/notifications/sendInAppNotification';\nimport { getNotificationTemplate } from '@/utils/notifications/notificationTemplates';\nimport { checkReportRateLimit } from '@/utils/reportRateLimit';\n\nexport async function POST(request) {\n  try {\n    const body = await request.json();\n    \n    const { reportedUserId, reportedUsername, reportedBy, reason } = body;\n    \n    // Validate required fields\n    if (!reportedUserId || !reason) {\n      return NextResponse.json(\n        { success: false, error: 'User ID and reason are required' },\n        { status: 400 }\n      );\n    }\n    \n    // Validate reason is one of the allowed values for profile reports\n    const validReasons = [\n      'inappropriate_avatar',\n      'offensive_username',\n      'spam_bio',\n      'impersonation',\n      'other'\n    ];\n    \n    if (!validReasons.includes(reason)) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid report reason' },\n        { status: 400 }\n      );\n    }\n    \n    // Check rate limit and duplicate reports (pass userId to prevent authenticated bypass)\n    const rateLimitCheck = await checkReportRateLimit(request, reportedUserId, 'user', reportedBy);\n    if (!rateLimitCheck.allowed) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: rateLimitCheck.message,\n          reason: rateLimitCheck.reason\n        },\n        { status: 429 }\n      );\n    }\n    \n    // Get Firestore instance\n    const db = adminFirestore();\n    \n    // Use Firestore transaction for atomic operations\n    const userRef = db.collection('users').doc(reportedUserId);\n    const summaryId = `user-${reportedUserId}`;\n    const summaryRef = db.collection('reportSummary').doc(summaryId);\n    \n    let shouldNotify = false;\n    let notificationData = null;\n    \n    await db.runTransaction(async (transaction) => {\n      // ALL READS MUST COME FIRST (Firestore requirement)\n      const userDoc = await transaction.get(userRef);\n      const summaryDoc = await transaction.get(summaryRef);\n      \n      if (!userDoc.exists) {\n        throw new Error('User not found');\n      }\n      \n      const userData = userDoc.data();\n      const currentReportsCount = userData.reportsCount || 0;\n      \n      // Update or create report summary with reason counts\n      const now = new Date();\n      \n      let newReportsCount;\n      let isResettingCounts = false;\n      \n      if (summaryDoc.exists) {\n        const currentSummary = summaryDoc.data();\n        \n        // If previously resolved/dismissed, reset BOTH counters to start fresh\n        if (currentSummary.status === 'resolved' || currentSummary.status === 'dismissed') {\n          newReportsCount = 1;\n          isResettingCounts = true;\n        } else {\n          // Still pending, increment counter\n          newReportsCount = currentReportsCount + 1;\n        }\n      } else {\n        // New summary, start at 1\n        newReportsCount = 1;\n      }\n      \n      // Update user moderation fields\n      const userUpdates = {\n        reportsCount: newReportsCount,\n        updatedAt: new Date(),\n      };\n      \n      // Initialize account status fields if they don't exist\n      if (!userData.accountStatus) {\n        userUpdates.accountStatus = 'active';\n      }\n      \n      // Auto-flag for review based on report count thresholds\n      // 1-9 reports: under-review (visible but flagged)\n      // 10+ reports: under-review-hidden (profile hidden)\n      if (newReportsCount >= 1 && newReportsCount <= 9 && userData.accountStatus === 'active') {\n        userUpdates.accountStatus = 'under-review';\n        \n        // Flag for notification after transaction\n        shouldNotify = true;\n        notificationData = {\n          userId: reportedUserId,\n          reason,\n          notificationType: 'under-review'\n        };\n      } else if (newReportsCount >= 10 && (userData.accountStatus === 'active' || userData.accountStatus === 'under-review')) {\n        userUpdates.accountStatus = 'under-review-hidden';\n        userUpdates.hiddenAt = new Date();\n        \n        // Flag for notification after transaction\n        shouldNotify = true;\n        notificationData = {\n          userId: reportedUserId,\n          reason,\n          notificationType: 'under-review-hidden'\n        };\n      }\n      \n      transaction.update(userRef, userUpdates);\n      \n      if (summaryDoc.exists) {\n        // Update existing summary\n        const currentSummary = summaryDoc.data();\n        const summaryUpdates = {\n          lastReportedAt: now,\n          updatedAt: now,\n        };\n        \n        // If previously resolved/dismissed, reset counter and status to start fresh\n        if (isResettingCounts) {\n          summaryUpdates.status = 'pending';\n          summaryUpdates.reportsCount = 1;\n          summaryUpdates.firstReportedAt = now;\n          summaryUpdates.reasonCounts = { [reason]: 1 };\n        } else {\n          // Still pending, increment counter and reason count\n          summaryUpdates.reportsCount = (currentSummary.reportsCount || 0) + 1;\n          \n          // Increment reason count\n          const currentReasonCounts = currentSummary.reasonCounts || {};\n          summaryUpdates.reasonCounts = {\n            ...currentReasonCounts,\n            [reason]: (currentReasonCounts[reason] || 0) + 1\n          };\n        }\n        \n        // Sync account status based on report count\n        if (newReportsCount >= 1 && newReportsCount <= 9 && userData.accountStatus === 'active') {\n          summaryUpdates.accountStatus = 'under-review';\n        } else if (newReportsCount >= 10 && (userData.accountStatus === 'active' || userData.accountStatus === 'under-review')) {\n          summaryUpdates.accountStatus = 'under-review-hidden';\n          summaryUpdates.hiddenAt = now;\n        }\n        \n        // Always refresh cached display data\n        summaryUpdates.displayName = userData.displayName || currentSummary.displayName;\n        summaryUpdates.username = userData.username || currentSummary.username;\n        summaryUpdates.profileImage = userData.profileImage || currentSummary.profileImage;\n        \n        transaction.update(summaryRef, summaryUpdates);\n      } else {\n        // Create new summary\n        transaction.set(summaryRef, {\n          targetId: reportedUserId,\n          targetType: 'user',\n          reportsCount: 1,\n          reasonCounts: { [reason]: 1 },\n          firstReportedAt: now,\n          lastReportedAt: now,\n          status: 'pending',\n          createdAt: now,\n          updatedAt: now,\n          // Display data for quick access\n          username: userData.username || '',\n          displayName: userData.displayName || '',\n          profileImage: userData.profileImage || '',\n          accountStatus: userData.accountStatus || 'active',\n        });\n      }\n    });\n    \n    // Send notification AFTER transaction completes\n    if (shouldNotify && notificationData) {\n      // Choose notification template based on status\n      const templateType = notificationData.notificationType === 'under-review' \n        ? 'profileUnderReview' \n        : 'profileUnderReview'; // Using same template for now\n      \n      const notification = getNotificationTemplate(templateType);\n      \n      await sendInAppNotification({\n        userId: notificationData.userId,\n        title: notification.title,\n        body: notification.body,\n        actionUrl: notification.actionUrl,\n        icon: notification.icon,\n        type: notification.type || 'profile-under-review',\n        metadata: {\n          reportedUserId: notificationData.userId,\n          reason: notificationData.reason,\n          notificationType: notificationData.notificationType\n        }\n      }).catch(err => console.error('Failed to send notification:', err));\n    }\n    \n    return NextResponse.json(\n      { success: true, message: 'Report submitted successfully' },\n      { status: 200 }\n    );\n    \n  } catch (error) {\n    console.error('Error creating user report:', error);\n    \n    return NextResponse.json(\n      { \n        success: false, \n        error: error.message || 'Failed to submit report. Please try again.' \n      },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":8304,"size_tokens":null},"src/utils/notifications/notificationTemplates.js":{"content":"export const notificationTemplates = {\n  campaignUnderReview: ({ campaignTitle }) => ({\n    title: ' Campaign Under Review',\n    body: `Your campaign \"${campaignTitle}\" has been flagged by users and is now under review. We'll notify you of the outcome.`,\n    actionUrl: '/profile',\n    icon: '/icon-192x192.png',\n    type: 'campaign-under-review',\n  }),\n\n  campaignRemoved: ({ campaignTitle, appealDeadline, removalReason }) => ({\n    title: ' Campaign Removed',\n    body: `Your campaign \"${campaignTitle}\" has been removed for: ${removalReason}. You can appeal this decision until ${appealDeadline}.`,\n    actionUrl: '/profile',\n    icon: '/icon-192x192.png',\n    type: 'campaign-removed',\n  }),\n\n  campaignRestored: ({ campaignTitle }) => ({\n    title: ' Campaign Restored',\n    body: `Good news! Your campaign \"${campaignTitle}\" has been reviewed and restored.`,\n    actionUrl: '/profile',\n    icon: '/icon-192x192.png',\n    type: 'campaign-restored',\n  }),\n\n  warningIssued: ({ reason }) => ({\n    title: ' Warning Issued',\n    body: `You've received a warning for: ${reason}. Please review our community guidelines.`,\n    actionUrl: '/profile',\n    icon: '/icon-192x192.png',\n    type: 'warning',\n  }),\n\n  profileUnderReview: () => ({\n    title: ' Profile Under Review',\n    body: 'Your profile has been flagged by users and is now under review. We\\'ll notify you of the outcome.',\n    actionUrl: '/profile',\n    icon: '/icon-192x192.png',\n    type: 'profile-under-review',\n  }),\n\n  accountBanned: ({ banReason, appealDeadline }) => ({\n    title: ' Account Banned',\n    body: `Your account has been banned for: ${banReason}. You can appeal until ${appealDeadline}.`,\n    actionUrl: '/profile',\n    icon: '/icon-192x192.png',\n    type: 'account-banned',\n  }),\n\n  profileRestored: () => ({\n    title: ' Profile Restored',\n    body: 'Good news! Your profile has been reviewed and restored.',\n    actionUrl: '/profile',\n    icon: '/icon-192x192.png',\n    type: 'profile-restored',\n  }),\n\n  appealDeadlineReminder: ({ daysLeft, type }) => ({\n    title: ' Appeal Deadline Reminder',\n    body: `You have ${daysLeft} days left to appeal your ${type} removal. Don't miss the deadline!`,\n    actionUrl: '/profile',\n    icon: '/icon-192x192.png',\n    type: 'appeal-deadline-reminder',\n  }),\n\n  appealSubmitted: () => ({\n    title: ' Appeal Submitted',\n    body: 'Your appeal has been submitted and is under review. You will be notified of the outcome.',\n    actionUrl: '/profile/notifications',\n    icon: '/icon-192x192.png',\n    type: 'appeal-submitted',\n  }),\n\n  appealApproved: ({ type }) => ({\n    title: ' Appeal Approved',\n    body: `Your appeal for ${type} removal has been approved and restored.`,\n    actionUrl: '/profile',\n    icon: '/icon-192x192.png',\n    type: 'appeal-approved',\n  }),\n\n  appealRejected: ({ type }) => ({\n    title: ' Appeal Rejected',\n    body: `Your appeal for ${type} removal has been reviewed and rejected.`,\n    actionUrl: '/profile',\n    icon: '/icon-192x192.png',\n    type: 'appeal-rejected',\n  }),\n\n  campaignPermanentlyRemoved: ({ campaignTitle }) => ({\n    title: ' Campaign Permanently Removed',\n    body: `Your campaign \"${campaignTitle}\" has been permanently removed. The 30-day appeal window has expired.`,\n    actionUrl: '/profile',\n    icon: '/icon-192x192.png',\n    type: 'campaign-permanently-removed',\n  }),\n\n  accountPermanentlyBanned: () => ({\n    title: ' Account Permanently Banned',\n    body: 'Your account has been permanently banned. The 30-day appeal window has expired.',\n    actionUrl: '/banned',\n    icon: '/icon-192x192.png',\n    type: 'account-permanently-banned',\n  }),\n};\n\nexport function getNotificationTemplate(type, params = {}) {\n  const template = notificationTemplates[type];\n  \n  if (!template) {\n    console.error(`Notification template not found: ${type}`);\n    return {\n      title: 'Notification',\n      body: 'You have a new notification',\n      actionUrl: '/',\n      icon: '/icon-192x192.png',\n    };\n  }\n\n  return typeof template === 'function' ? template(params) : template;\n}\n","path":null,"size_bytes":4102,"size_tokens":null},"src/utils/notifications/sendFCMNotification.js":{"content":"export async function sendFCMNotification({ userId, title, body, actionUrl, icon, data = {} }) {\n  try {\n    console.log('[FCM SEND] Preparing to send notification to userId:', userId);\n    console.log('[FCM SEND] Notification details:', { title, body, actionUrl });\n    \n    const isServer = typeof window === 'undefined';\n    const baseUrl = isServer \n      ? (process.env.NEXT_PUBLIC_SITE_URL || process.env.VERCEL_URL \n          ? `https://${process.env.VERCEL_URL}` \n          : 'http://localhost:3000')\n      : '';\n    \n    const apiUrl = `${baseUrl}/api/notifications/send`;\n    console.log('[FCM SEND] Using API URL:', apiUrl);\n    \n    const response = await fetch(apiUrl, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify({\n        userId,\n        title,\n        body,\n        actionUrl,\n        icon,\n        data\n      }),\n    });\n\n    const result = await response.json();\n    console.log('[FCM SEND] API response status:', response.status);\n    console.log('[FCM SEND] API response data:', result);\n\n    if (!response.ok) {\n      console.error('[FCM SEND] API returned error:', result.error);\n      throw new Error(result.error || 'Failed to send notification');\n    }\n\n    console.log('[FCM SEND]  Notification sent successfully');\n    return result;\n  } catch (error) {\n    console.error('[FCM SEND]  Error sending FCM notification:', error);\n    throw error;\n  }\n}\n\nexport async function sendBatchNotifications(notifications) {\n  const promises = notifications.map(notification => \n    sendFCMNotification(notification).catch(err => {\n      console.error('Failed to send notification:', err);\n      return { success: false, error: err.message };\n    })\n  );\n\n  return await Promise.allSettled(promises);\n}\n","path":null,"size_bytes":1800,"size_tokens":null},"src/app/api/notifications/send/route.js":{"content":"import { NextResponse } from 'next/server';\nimport adminApp, { adminFirestore } from '@/lib/firebaseAdmin';\nimport { getMessaging } from 'firebase-admin/messaging';\nimport { FieldValue } from 'firebase-admin/firestore';\n\nexport async function POST(request) {\n  try {\n    const body = await request.json();\n    const { userId, title, body: messageBody, actionUrl, icon, data } = body;\n\n    console.log('[SEND API] Received notification request for userId:', userId);\n    console.log('[SEND API] Notification:', { title, messageBody, actionUrl });\n\n    if (!userId || !title || !messageBody) {\n      console.error('[SEND API] Missing required fields');\n      return NextResponse.json(\n        { error: 'Missing required fields: userId, title, and body' },\n        { status: 400 }\n      );\n    }\n\n    const db = adminFirestore();\n    const messaging = getMessaging(adminApp);\n\n    console.log('[SEND API] Fetching FCM tokens for user...');\n    const tokensSnapshot = await db\n      .collection('users')\n      .doc(userId)\n      .collection('tokens')\n      .get();\n\n    if (tokensSnapshot.empty) {\n      console.log('[SEND API] No FCM tokens found for user:', userId);\n      return NextResponse.json({\n        success: false,\n        message: 'No FCM tokens found for this user'\n      });\n    }\n\n    const tokens = tokensSnapshot.docs.map(doc => doc.data().token);\n    console.log('[SEND API] Found', tokens.length, 'FCM token(s) for user');\n\n    const message = {\n      notification: {\n        title,\n        body: messageBody,\n        icon: icon || '/icon-192x192.png',\n      },\n      data: {\n        url: actionUrl || '/',\n        ...data\n      },\n      tokens\n    };\n\n    console.log('[SEND API] Sending notification via Firebase Admin SDK...');\n    const response = await messaging.sendEachForMulticast(message);\n    console.log('[SEND API] Firebase response - Success:', response.successCount, 'Failed:', response.failureCount);\n\n    // Permanent error codes that indicate the token should be removed\n    const PERMANENT_ERROR_CODES = [\n      'messaging/invalid-registration-token',\n      'messaging/registration-token-not-registered',\n      'messaging/invalid-argument',\n      'messaging/mismatched-credential',\n      'messaging/authentication-error',\n    ];\n\n    // Transient error codes that should NOT remove tokens (temporary failures)\n    const TRANSIENT_ERROR_CODES = [\n      'messaging/server-unavailable',\n      'messaging/internal-error',\n      'messaging/unavailable',\n      'messaging/quota-exceeded',\n      'messaging/third-party-auth-error',\n    ];\n\n    const tokensToRemove = [];\n    const tokensToUpdate = [];\n    const transientErrors = [];\n\n    response.responses.forEach((resp, idx) => {\n      const token = tokens[idx];\n      \n      if (resp.success) {\n        console.log(`[SEND API]  Successfully sent to token ${idx + 1}/${tokens.length}`);\n        \n        // Check if Firebase returned a canonical registration token (updated token)\n        if (resp.canonicalRegistrationToken && resp.canonicalRegistrationToken !== token) {\n          console.log(`[SEND API]  Token needs update - Old: ${token.substring(0, 20)}..., New: ${resp.canonicalRegistrationToken.substring(0, 20)}...`);\n          tokensToUpdate.push({\n            oldToken: token,\n            newToken: resp.canonicalRegistrationToken\n          });\n        }\n      } else {\n        const errorCode = resp.error?.code || 'unknown';\n        const errorMessage = resp.error?.message || 'Unknown error';\n        \n        console.error(`[SEND API]  Failed to send to token ${idx + 1}/${tokens.length}`);\n        console.error(`[SEND API] Error code: ${errorCode}`);\n        console.error(`[SEND API] Error message: ${errorMessage}`);\n        \n        // Only remove token if it's a permanent error\n        if (PERMANENT_ERROR_CODES.includes(errorCode)) {\n          console.log(`[SEND API]   Permanent error detected - Will remove token`);\n          tokensToRemove.push(token);\n        } else if (TRANSIENT_ERROR_CODES.includes(errorCode)) {\n          console.log(`[SEND API]   Transient error detected - Token will be retained for retry`);\n          transientErrors.push({\n            token: token.substring(0, 20) + '...',\n            errorCode,\n            errorMessage\n          });\n        } else {\n          // Unknown error - log but don't remove (safer approach)\n          console.warn(`[SEND API]   Unknown error code: ${errorCode} - Token will be retained`);\n          transientErrors.push({\n            token: token.substring(0, 20) + '...',\n            errorCode,\n            errorMessage,\n            isUnknown: true\n          });\n        }\n      }\n    });\n\n    // Update canonical tokens (deduplicate by newToken to avoid batch conflicts)\n    if (tokensToUpdate.length > 0) {\n      // Deduplicate by canonical token - multiple old tokens may map to same canonical\n      // Keep only one old token per canonical token to avoid duplicate writes in batch\n      const canonicalMap = new Map(); // newToken -> { oldTokens: [], newToken }\n      \n      tokensToUpdate.forEach(({ oldToken, newToken }) => {\n        if (!canonicalMap.has(newToken)) {\n          canonicalMap.set(newToken, { oldTokens: [], newToken });\n        }\n        canonicalMap.get(newToken).oldTokens.push(oldToken);\n      });\n      \n      console.log(`[SEND API]  Processing ${canonicalMap.size} unique canonical token(s) from ${tokensToUpdate.length} updates...`);\n      \n      // Fetch data from old tokens (pick first old token for each canonical)\n      const tokensToProcess = [];\n      for (const { oldTokens, newToken } of canonicalMap.values()) {\n        // Use the first old token's data for the canonical token\n        const primaryOldToken = oldTokens[0];\n        const oldTokenRef = db.collection('users').doc(userId).collection('tokens').doc(primaryOldToken);\n        const oldTokenDoc = await oldTokenRef.get();\n        \n        if (oldTokenDoc.exists) {\n          tokensToProcess.push({\n            oldTokens, // All old tokens to delete\n            newToken,\n            data: oldTokenDoc.data()\n          });\n        }\n      }\n      \n      // Now perform batch update (one write per canonical token)\n      if (tokensToProcess.length > 0) {\n        const updateBatch = db.batch();\n        \n        for (const { oldTokens, newToken, data } of tokensToProcess) {\n          // Delete all old tokens that map to this canonical\n          oldTokens.forEach(oldToken => {\n            const oldTokenRef = db.collection('users').doc(userId).collection('tokens').doc(oldToken);\n            updateBatch.delete(oldTokenRef);\n          });\n          \n          // Create/update canonical token (only written once per batch)\n          const newTokenRef = db.collection('users').doc(userId).collection('tokens').doc(newToken);\n          updateBatch.set(newTokenRef, {\n            ...data,\n            token: newToken,\n            lastUsed: FieldValue.serverTimestamp(),\n          }, { merge: true }); // Use merge to handle pre-existing canonical docs gracefully\n        }\n        \n        await updateBatch.commit();\n        console.log(`[SEND API]  ${tokensToProcess.length} canonical tokens updated successfully`);\n      }\n    }\n\n    // Remove permanently failed tokens\n    if (tokensToRemove.length > 0) {\n      console.log(`[SEND API]   Removing ${tokensToRemove.length} permanently invalid token(s)...`);\n      const deleteBatch = db.batch();\n      \n      tokensToRemove.forEach(token => {\n        const tokenRef = db.collection('users').doc(userId).collection('tokens').doc(token);\n        deleteBatch.delete(tokenRef);\n      });\n      \n      await deleteBatch.commit();\n      console.log(`[SEND API]  Permanently invalid tokens removed from database`);\n    }\n\n    // Log transient errors for monitoring (could be sent to error tracking service)\n    if (transientErrors.length > 0) {\n      console.warn(`[SEND API]   ${transientErrors.length} transient error(s) occurred (tokens retained):`, transientErrors);\n    }\n\n    // Save notification to Firestore history\n    console.log('[SEND API] Saving notification to history...');\n    try {\n      const notificationRef = db\n        .collection('users')\n        .doc(userId)\n        .collection('notifications')\n        .doc(); // Auto-generate ID\n      \n      await notificationRef.set({\n        type: data?.type || 'general',\n        title,\n        body: messageBody,\n        actionUrl: actionUrl || '/',\n        icon: icon || '/icon-192x192.png',\n        read: false,\n        createdAt: FieldValue.serverTimestamp(),\n        metadata: data || {},\n      });\n      \n      console.log('[SEND API] Notification saved to history with ID:', notificationRef.id);\n    } catch (historyError) {\n      console.error('[SEND API] Error saving notification to history:', historyError);\n      // Don't fail the request if history save fails\n    }\n\n    console.log('[SEND API]  Notification sending complete');\n    return NextResponse.json({\n      success: true,\n      successCount: response.successCount,\n      failureCount: response.failureCount,\n      tokensRemoved: tokensToRemove.length,\n      tokensUpdated: tokensToUpdate.length,\n      transientErrors: transientErrors.length,\n      message: `Sent ${response.successCount} notifications, ${response.failureCount} failed (${tokensToRemove.length} tokens removed, ${transientErrors.length} transient errors)`\n    });\n\n  } catch (error) {\n    console.error('Error sending FCM notification:', error);\n    return NextResponse.json(\n      { error: 'Failed to send notification', details: error.message },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":9644,"size_tokens":null},"src/components/notifications/NotificationProvider.js":{"content":"\"use client\";\n\nimport { useNotifications } from '@/hooks/useNotifications';\nimport NotificationToast from './NotificationToast';\n\nexport default function NotificationProvider({ children }) {\n  const { latestNotification, clearLatestNotification } = useNotifications();\n  \n  const handleClose = () => {\n    if (latestNotification) {\n      clearLatestNotification(latestNotification.id);\n    }\n  };\n  \n  return (\n    <>\n      {children}\n      \n      {latestNotification && (\n        <NotificationToast \n          notification={latestNotification}\n          onClose={handleClose}\n        />\n      )}\n    </>\n  );\n}\n","path":null,"size_bytes":612,"size_tokens":null},"src/app/(chrome)/profile/notifications/page.js":{"content":"\"use client\";\n\nimport { useState, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { useAuth } from '@/hooks/useAuth';\nimport { collection, query, orderBy, onSnapshot, where } from 'firebase/firestore';\nimport { db, auth } from '@/lib/firebase-optimized';\nimport Link from 'next/link';\n\n// Helper function to get Firebase ID token\nconst getAuthToken = async () => {\n  if (!auth?.currentUser) {\n    throw new Error('User not authenticated');\n  }\n  return await auth.currentUser.getIdToken();\n};\n\nexport default function NotificationsInboxPage() {\n  const router = useRouter();\n  const { user, loading: authLoading } = useAuth();\n  const [notifications, setNotifications] = useState([]);\n  const [loading, setLoading] = useState(true);\n  const [filter, setFilter] = useState('all'); // all, unread\n  \n  // Redirect if not authenticated\n  useEffect(() => {\n    if (!authLoading && !user) {\n      router.push('/signin');\n    }\n  }, [user, authLoading, router]);\n  \n  // Fetch notifications with real-time updates\n  useEffect(() => {\n    if (!user) return;\n    \n    const notificationsRef = collection(db, 'users', user.uid, 'notifications');\n    const q = query(notificationsRef, orderBy('createdAt', 'desc'));\n    \n    const unsubscribe = onSnapshot(q, (snapshot) => {\n      const notificationsList = snapshot.docs.map(doc => ({\n        id: doc.id,\n        ...doc.data(),\n        createdAt: doc.data().createdAt?.toDate(),\n      }));\n      \n      setNotifications(notificationsList);\n      setLoading(false);\n    }, (error) => {\n      console.error('Error fetching notifications:', error);\n      setLoading(false);\n    });\n    \n    return () => unsubscribe();\n  }, [user]);\n  \n  // Filter notifications\n  const filteredNotifications = notifications.filter(notification => {\n    if (filter === 'all') return true;\n    if (filter === 'unread') return !notification.read;\n    return true;\n  });\n  \n  const unreadCount = notifications.filter(n => !n.read).length;\n  \n  const handleNotificationClick = async (notification) => {\n    // Mark as read\n    if (!notification.read) {\n      try {\n        const token = await getAuthToken();\n        await fetch(`/api/notifications/${notification.id}`, {\n          method: 'PATCH',\n          headers: { \n            'Content-Type': 'application/json',\n            'Authorization': `Bearer ${token}`\n          },\n          body: JSON.stringify({ read: true }),\n        });\n      } catch (error) {\n        console.error('Error marking notification as read:', error);\n      }\n    }\n    \n    // Navigate to action URL\n    if (notification.actionUrl) {\n      router.push(notification.actionUrl);\n    }\n  };\n  \n  const getNotificationIcon = (type) => {\n    switch (type) {\n      case 'warning':\n        return (\n          <div className=\"flex-shrink-0 w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center\">\n            <svg className=\"w-5 h-5 text-yellow-600\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n              <path fillRule=\"evenodd\" d=\"M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z\" clipRule=\"evenodd\" />\n            </svg>\n          </div>\n        );\n      case 'campaign-removed':\n      case 'account-banned':\n        return (\n          <div className=\"flex-shrink-0 w-10 h-10 bg-red-100 rounded-full flex items-center justify-center\">\n            <svg className=\"w-5 h-5 text-red-600\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n              <path fillRule=\"evenodd\" d=\"M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z\" clipRule=\"evenodd\" />\n            </svg>\n          </div>\n        );\n      case 'campaign-restored':\n      case 'profile-restored':\n      case 'appeal-approved':\n        return (\n          <div className=\"flex-shrink-0 w-10 h-10 bg-green-100 rounded-full flex items-center justify-center\">\n            <svg className=\"w-5 h-5 text-green-600\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n              <path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z\" clipRule=\"evenodd\" />\n            </svg>\n          </div>\n        );\n      case 'campaign-under-review':\n      case 'profile-under-review':\n        return (\n          <div className=\"flex-shrink-0 w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center\">\n            <svg className=\"w-5 h-5 text-blue-600\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n              <path d=\"M10 12a2 2 0 100-4 2 2 0 000 4z\" />\n              <path fillRule=\"evenodd\" d=\"M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z\" clipRule=\"evenodd\" />\n            </svg>\n          </div>\n        );\n      default:\n        return (\n          <div className=\"flex-shrink-0 w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center\">\n            <svg className=\"w-5 h-5 text-gray-600\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n              <path d=\"M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z\" />\n            </svg>\n          </div>\n        );\n    }\n  };\n  \n  const formatTimestamp = (date) => {\n    if (!date) return '';\n    \n    const now = new Date();\n    const diffMs = now - date;\n    const diffMins = Math.floor(diffMs / 60000);\n    const diffHours = Math.floor(diffMs / 3600000);\n    const diffDays = Math.floor(diffMs / 86400000);\n    \n    if (diffMins < 1) return 'Just now';\n    if (diffMins < 60) return `${diffMins}m ago`;\n    if (diffHours < 24) return `${diffHours}h ago`;\n    if (diffDays < 7) return `${diffDays}d ago`;\n    \n    return date.toLocaleDateString();\n  };\n  \n  // Show loading state while auth is loading\n  if (authLoading) {\n    return (\n      <div className=\"min-h-screen bg-white flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-gray-600\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  // Don't render if user is not authenticated (redirect will handle this)\n  if (!user) {\n    return null;\n  }\n  \n  return (\n    <div className=\"min-h-screen bg-white\">\n      <div className=\"min-h-screen flex\">\n        {/* Main Content */}\n        <div className=\"flex-1 w-full flex flex-col py-8 px-4 sm:px-6 lg:px-16 xl:px-20 pt-20\">\n          <div className=\"mx-auto w-full max-w-4xl\">\n            {/* Header */}\n            <div className=\"mb-8 bg-yellow-400 px-6 py-6 rounded-t-xl\">\n              <div>\n                <h1 className=\"text-2xl sm:text-3xl font-bold text-emerald-700\">Notifications</h1>\n                <p className=\"text-base sm:text-lg text-gray-700 mt-2\">\n                  {unreadCount > 0 ? `${unreadCount} unread notification${unreadCount !== 1 ? 's' : ''}` : 'All caught up!'}\n                </p>\n              </div>\n            </div>\n            \n            {/* Filter Tabs */}\n            <div className=\"bg-white border-x border-gray-200 px-6 py-4 flex gap-2 overflow-x-auto\">\n              <button\n                onClick={() => setFilter('all')}\n                className={`px-4 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap ${\n                  filter === 'all' \n                    ? 'bg-emerald-600 text-white' \n                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                }`}\n              >\n                All\n              </button>\n              <button\n                onClick={() => setFilter('unread')}\n                className={`px-4 py-2 rounded-full text-sm font-medium transition-colors whitespace-nowrap ${\n                  filter === 'unread' \n                    ? 'bg-emerald-600 text-white' \n                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                }`}\n              >\n                Unread {unreadCount > 0 && `(${unreadCount})`}\n              </button>\n            </div>\n            \n            {/* Notifications List */}\n            <div className=\"bg-white rounded-b-xl border border-t-0 border-gray-200 shadow-sm\">\n              {loading ? (\n                <div className=\"p-8 text-center\">\n                  <div className=\"w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n                  <p className=\"text-gray-600\">Loading notifications...</p>\n                </div>\n              ) : filteredNotifications.length === 0 ? (\n                <div className=\"p-12 text-center\">\n                  <div className=\"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                    <svg className=\"w-8 h-8 text-gray-400\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9\" />\n                    </svg>\n                  </div>\n                  <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\n                    {filter === 'all' ? 'No notifications yet' : `No ${filter} notifications`}\n                  </h3>\n                  <p className=\"text-gray-500\">\n                    {filter === 'all' \n                      ? \"You'll receive notifications about moderation updates for your campaigns\" \n                      : `You don't have any ${filter} notifications`}\n                  </p>\n                </div>\n              ) : (\n                <div className=\"divide-y divide-gray-200\">\n                  {filteredNotifications.map((notification) => (\n                    <div\n                      key={notification.id}\n                      onClick={() => handleNotificationClick(notification)}\n                      className={`p-4 hover:bg-gray-50 cursor-pointer transition-colors ${\n                        !notification.read ? 'bg-blue-50 bg-opacity-30' : ''\n                      }`}\n                    >\n                      <div className=\"flex items-start gap-4\">\n                        {getNotificationIcon(notification.type)}\n                        \n                        <div className=\"flex-1 min-w-0\">\n                          <div className=\"flex items-start justify-between gap-4\">\n                            <div className=\"flex-1\">\n                              <p className={`text-sm ${!notification.read ? 'font-semibold text-gray-900' : 'font-medium text-gray-800'}`}>\n                                {notification.title}\n                              </p>\n                              <p className=\"text-sm text-gray-600 mt-1\">\n                                {notification.body}\n                              </p>\n                              <p className=\"text-xs text-gray-500 mt-2\">\n                                {formatTimestamp(notification.createdAt)}\n                              </p>\n                            </div>\n                            \n                            {!notification.read && (\n                              <div className=\"flex-shrink-0 w-2 h-2 bg-emerald-600 rounded-full mt-1\"></div>\n                            )}\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":11858,"size_tokens":null},"src/components/notifications/NotificationToast.js":{"content":"\"use client\";\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { useRouter } from 'next/navigation';\n\nexport default function NotificationToast({ notification, onClose }) {\n  const router = useRouter();\n  const [isExiting, setIsExiting] = useState(false);\n  \n  const handleClose = useCallback(() => {\n    setIsExiting(true);\n    setTimeout(() => {\n      onClose();\n    }, 300);\n  }, [onClose]);\n  \n  useEffect(() => {\n    const timer = setTimeout(() => {\n      handleClose();\n    }, 10000);\n    \n    return () => clearTimeout(timer);\n  }, [handleClose]);\n  \n  const handleClick = () => {\n    if (notification.actionUrl) {\n      router.push(notification.actionUrl);\n      handleClose();\n    }\n  };\n  \n  return (\n    <div \n      className={`fixed top-4 right-4 z-50 max-w-sm w-full bg-white dark:bg-gray-800 shadow-lg rounded-lg pointer-events-auto overflow-hidden transition-all duration-300 ${\n        isExiting ? 'opacity-0 translate-x-full' : 'opacity-100 translate-x-0'\n      }`}\n    >\n      <div className=\"p-4\">\n        <div className=\"flex items-start\">\n          <div className=\"flex-shrink-0\">\n            <div className=\"h-10 w-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center\">\n              <svg className=\"h-6 w-6 text-blue-600 dark:text-blue-400\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9\" />\n              </svg>\n            </div>\n          </div>\n          <div className=\"ml-3 flex-1\">\n            <p className=\"text-sm font-medium text-gray-900 dark:text-white\">\n              {notification.title}\n            </p>\n            <p className=\"mt-1 text-sm text-gray-500 dark:text-gray-400\">\n              {notification.body}\n            </p>\n            {notification.actionUrl && (\n              <button\n                onClick={handleClick}\n                className=\"mt-2 text-sm font-medium text-blue-600 dark:text-blue-400 hover:text-blue-500\"\n              >\n                View Details \n              </button>\n            )}\n          </div>\n          <div className=\"ml-4 flex-shrink-0 flex\">\n            <button\n              onClick={handleClose}\n              className=\"inline-flex text-gray-400 hover:text-gray-500 focus:outline-none\"\n            >\n              <span className=\"sr-only\">Close</span>\n              <svg className=\"h-5 w-5\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n                <path fillRule=\"evenodd\" d=\"M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z\" clipRule=\"evenodd\" />\n              </svg>\n            </button>\n          </div>\n        </div>\n      </div>\n      <div className=\"h-1 bg-blue-100 dark:bg-blue-900\">\n        <div className=\"h-full bg-blue-600 dark:bg-blue-400 animate-toast-progress\" />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":3176,"size_tokens":null},"src/app/banned/page.js":{"content":"\"use client\";\n\nimport { useEffect, useState } from 'react';\nimport { useRouter } from 'next/navigation';\nimport Link from 'next/link';\n\nexport default function BannedPage() {\n  const [banInfo, setBanInfo] = useState(null);\n  const router = useRouter();\n\n  useEffect(() => {\n    if (typeof window !== 'undefined') {\n      const storedBanInfo = sessionStorage.getItem('banInfo');\n      \n      if (storedBanInfo) {\n        try {\n          const info = JSON.parse(storedBanInfo);\n          setBanInfo(info);\n        } catch (error) {\n          console.error('Error parsing ban info:', error);\n        }\n      } else {\n        router.replace('/');\n      }\n    }\n  }, [router]);\n\n  if (!banInfo) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center bg-gray-50\">\n        <div className=\"animate-pulse\">\n          <div className=\"h-8 w-64 bg-gray-200 rounded mb-4\"></div>\n          <div className=\"h-4 w-96 bg-gray-200 rounded\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen flex items-center justify-center bg-gray-50 px-4\">\n      <div className=\"max-w-md w-full\">\n        <div className=\"bg-white shadow-lg rounded-lg p-8\">\n          <div className=\"flex justify-center mb-6\">\n            <div className=\"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center\">\n              <svg className=\"w-10 h-10 text-red-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n              </svg>\n            </div>\n          </div>\n\n          <h1 className=\"text-2xl font-bold text-gray-900 text-center mb-4\">\n            Account Suspended\n          </h1>\n\n          <div className=\"bg-red-50 border border-red-200 rounded-lg p-4 mb-6\">\n            <p className=\"text-sm text-red-800 font-medium mb-2\">Reason for suspension:</p>\n            <p className=\"text-sm text-red-700\">\n              {banInfo.reason || 'Your account has been suspended by an administrator.'}\n            </p>\n          </div>\n\n          {banInfo.bannedAt && (\n            <p className=\"text-sm text-gray-500 text-center mb-6\">\n              Suspended on: {new Date(banInfo.bannedAt).toLocaleDateString('en-US', {\n                year: 'numeric',\n                month: 'long',\n                day: 'numeric'\n              })}\n            </p>\n          )}\n\n          <div className=\"bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6\">\n            <p className=\"text-sm text-gray-700\">\n              If you believe this was a mistake, please contact our support team for assistance.\n            </p>\n          </div>\n\n          <div className=\"space-y-3\">\n            <Link \n              href=\"/\"\n              className=\"block w-full text-center py-3 px-4 bg-emerald-600 hover:bg-emerald-700 text-white font-medium rounded-lg transition-colors\"\n            >\n              Return to Home\n            </Link>\n            \n            <button\n              onClick={() => {\n                sessionStorage.removeItem('banInfo');\n                router.push('/');\n              }}\n              className=\"btn-base btn-neutral block w-full text-center py-3 px-4\"\n            >\n              Clear and Return\n            </button>\n          </div>\n\n          <p className=\"text-xs text-gray-500 text-center mt-6\">\n            Your account will remain suspended until reviewed by our moderation team.\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":3635,"size_tokens":null},"src/app/(chrome)/settings/page.js":{"content":"\"use client\";\n\nimport { useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { useAuth } from '@/hooks/useAuth';\nimport Link from 'next/link';\nimport SettingsSidebar from '@/components/SettingsSidebar';\n\nexport default function SettingsPage() {\n  const router = useRouter();\n  const { user, loading: authLoading } = useAuth();\n  \n  useEffect(() => {\n    if (!authLoading && !user) {\n      router.push('/signin');\n    }\n  }, [user, authLoading, router]);\n  \n  if (authLoading) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-gray-600\">Loading settings...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!user) {\n    return null;\n  }\n  \n  const settingsCards = [\n    {\n      title: 'Notifications',\n      description: 'Manage push notifications and notification preferences',\n      icon: (\n        <svg className=\"w-8 h-8\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9\" />\n        </svg>\n      ),\n      href: '/settings/notifications',\n      badge: null,\n      available: true,\n    },\n    {\n      title: 'Account & Security',\n      description: 'Manage your account settings, password, and security',\n      icon: (\n        <svg className=\"w-8 h-8\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z\" />\n        </svg>\n      ),\n      href: '#',\n      badge: 'Coming Soon',\n      available: false,\n    },\n    {\n      title: 'Privacy & Data',\n      description: 'Control your privacy settings and data preferences',\n      icon: (\n        <svg className=\"w-8 h-8\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z\" />\n        </svg>\n      ),\n      href: '#',\n      badge: 'Coming Soon',\n      available: false,\n    },\n  ];\n  \n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <div className=\"flex flex-col lg:flex-row\">\n        <SettingsSidebar />\n        \n        <div className=\"flex-1 w-full\">\n          <div className=\"max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-8\">\n            <div className=\"mb-8\">\n              <h1 className=\"text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900\">Settings</h1>\n              <p className=\"text-sm sm:text-base text-gray-600 mt-2\">\n                Manage your account settings and preferences\n              </p>\n            </div>\n            \n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6\">\n              {settingsCards.map((card) => (\n                card.available ? (\n                  <Link\n                    key={card.title}\n                    href={card.href}\n                    className=\"bg-white rounded-xl border border-gray-200 p-6 hover:shadow-lg hover:border-emerald-300 transition-all duration-200 group\"\n                  >\n                    <div className=\"flex items-start gap-4\">\n                      <div className=\"flex-shrink-0 text-emerald-600 group-hover:text-emerald-700 transition-colors\">\n                        {card.icon}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <h3 className=\"text-lg font-semibold text-gray-900 group-hover:text-emerald-700 transition-colors\">\n                          {card.title}\n                        </h3>\n                        <p className=\"text-sm text-gray-600 mt-1\">\n                          {card.description}\n                        </p>\n                        {card.badge && (\n                          <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-emerald-100 text-emerald-800 mt-2\">\n                            {card.badge}\n                          </span>\n                        )}\n                      </div>\n                      <div className=\"flex-shrink-0\">\n                        <svg className=\"w-5 h-5 text-gray-400 group-hover:text-emerald-600 transition-colors\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n                        </svg>\n                      </div>\n                    </div>\n                  </Link>\n                ) : (\n                  <div\n                    key={card.title}\n                    className=\"bg-white rounded-xl border border-gray-200 p-6 opacity-60 cursor-not-allowed\"\n                  >\n                    <div className=\"flex items-start gap-4\">\n                      <div className=\"flex-shrink-0 text-gray-400\">\n                        {card.icon}\n                      </div>\n                      <div className=\"flex-1 min-w-0\">\n                        <h3 className=\"text-lg font-semibold text-gray-700\">\n                          {card.title}\n                        </h3>\n                        <p className=\"text-sm text-gray-500 mt-1\">\n                          {card.description}\n                        </p>\n                        {card.badge && (\n                          <span className=\"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 mt-2\">\n                            {card.badge}\n                          </span>\n                        )}\n                      </div>\n                    </div>\n                  </div>\n                )\n              ))}\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6284,"size_tokens":null},"src/app/api/notifications/[notificationId]/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { adminFirestore, verifyIdToken } from '@/lib/firebaseAdmin';\nimport { headers } from 'next/headers';\n\n// PATCH: Mark notification as read/unread\nexport async function PATCH(request, { params }) {\n  try {\n    // Get and verify authorization token\n    const headersList = headers();\n    const authorization = headersList.get('authorization');\n    \n    if (!authorization || !authorization.startsWith('Bearer ')) {\n      return NextResponse.json(\n        { success: false, error: 'No authorization token provided' },\n        { status: 401 }\n      );\n    }\n\n    const token = authorization.replace('Bearer ', '');\n    const decodedToken = await verifyIdToken(token);\n    const userId = decodedToken.uid;\n    \n    const { notificationId } = params;\n    const body = await request.json();\n    const { read } = body;\n    \n    if (!notificationId) {\n      return NextResponse.json(\n        { success: false, error: 'Missing notificationId' },\n        { status: 400 }\n      );\n    }\n    \n    if (typeof read !== 'boolean') {\n      return NextResponse.json(\n        { success: false, error: 'Invalid read status. Must be boolean' },\n        { status: 400 }\n      );\n    }\n    \n    const db = adminFirestore();\n    const notificationRef = db\n      .collection('users')\n      .doc(userId)\n      .collection('notifications')\n      .doc(notificationId);\n    \n    // Check if notification exists\n    const notificationDoc = await notificationRef.get();\n    if (!notificationDoc.exists) {\n      return NextResponse.json(\n        { success: false, error: 'Notification not found' },\n        { status: 404 }\n      );\n    }\n    \n    await notificationRef.update({\n      read,\n      updatedAt: new Date().toISOString(),\n    });\n    \n    return NextResponse.json({\n      success: true,\n      message: `Notification marked as ${read ? 'read' : 'unread'}`,\n    });\n  } catch (error) {\n    console.error('Error updating notification:', error);\n    \n    if (error.message.includes('Invalid authentication token')) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid or expired token' },\n        { status: 401 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to update notification' },\n      { status: 500 }\n    );\n  }\n}\n\n// DELETE: Delete notification\nexport async function DELETE(request, { params }) {\n  try {\n    // Get and verify authorization token\n    const headersList = headers();\n    const authorization = headersList.get('authorization');\n    \n    if (!authorization || !authorization.startsWith('Bearer ')) {\n      return NextResponse.json(\n        { success: false, error: 'No authorization token provided' },\n        { status: 401 }\n      );\n    }\n\n    const token = authorization.replace('Bearer ', '');\n    const decodedToken = await verifyIdToken(token);\n    const userId = decodedToken.uid;\n    \n    const { notificationId } = params;\n    \n    if (!notificationId) {\n      return NextResponse.json(\n        { success: false, error: 'Missing notificationId' },\n        { status: 400 }\n      );\n    }\n    \n    const db = adminFirestore();\n    const notificationRef = db\n      .collection('users')\n      .doc(userId)\n      .collection('notifications')\n      .doc(notificationId);\n    \n    // Check if notification exists before deleting\n    const notificationDoc = await notificationRef.get();\n    if (!notificationDoc.exists) {\n      return NextResponse.json(\n        { success: false, error: 'Notification not found' },\n        { status: 404 }\n      );\n    }\n    \n    await notificationRef.delete();\n    \n    return NextResponse.json({\n      success: true,\n      message: 'Notification deleted successfully',\n    });\n  } catch (error) {\n    console.error('Error deleting notification:', error);\n    \n    if (error.message.includes('Invalid authentication token')) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid or expired token' },\n        { status: 401 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to delete notification' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":4145,"size_tokens":null},"src/components/notifications/NotificationBell.js":{"content":"\"use client\";\n\nimport { useState, useEffect } from 'react';\nimport { useAuth } from '@/hooks/useAuth';\nimport { collection, query, where, onSnapshot } from 'firebase/firestore';\nimport { db } from '@/lib/firebase-optimized';\nimport Link from 'next/link';\n\nexport default function NotificationBell() {\n  const { user } = useAuth();\n  const [unreadCount, setUnreadCount] = useState(0);\n\n  useEffect(() => {\n    if (!user) {\n      setUnreadCount(0);\n      return;\n    }\n\n    // Real-time listener for unread notifications\n    const notificationsRef = collection(db, 'users', user.uid, 'notifications');\n    const q = query(notificationsRef, where('read', '==', false));\n\n    const unsubscribe = onSnapshot(q, (snapshot) => {\n      setUnreadCount(snapshot.size);\n    }, (error) => {\n      console.error('Error fetching unread count:', error);\n    });\n\n    return () => unsubscribe();\n  }, [user]);\n\n  // Don't render if user is not authenticated\n  if (!user) {\n    return null;\n  }\n\n  return (\n    <Link\n      href=\"/profile/notifications\"\n      className=\"relative p-2 rounded-full hover:bg-yellow-500 hover:bg-opacity-30 transition-colors duration-200\"\n      aria-label={`Notifications ${unreadCount > 0 ? `(${unreadCount} unread)` : ''}`}\n    >\n      <svg\n        className=\"w-6 h-6 text-emerald-700\"\n        fill=\"none\"\n        stroke=\"currentColor\"\n        viewBox=\"0 0 24 24\"\n      >\n        <path\n          strokeLinecap=\"round\"\n          strokeLinejoin=\"round\"\n          strokeWidth={2}\n          d=\"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9\"\n        />\n      </svg>\n      \n      {unreadCount > 0 && (\n        <span className=\"absolute -top-1 -right-1 flex items-center justify-center min-w-[20px] h-5 px-1 text-xs font-bold text-white bg-red-500 rounded-full border-2 border-yellow-400\">\n          {unreadCount > 99 ? '99+' : unreadCount}\n        </span>\n      )}\n    </Link>\n  );\n}\n","path":null,"size_bytes":2036,"size_tokens":null},"src/components/SettingsSidebar.js":{"content":"\"use client\";\n\nimport Link from 'next/link';\nimport { usePathname } from 'next/navigation';\n\nexport default function SettingsSidebar() {\n  const pathname = usePathname();\n  \n  const navItems = [\n    {\n      name: 'Notifications',\n      href: '/settings/notifications',\n      icon: (\n        <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9\" />\n        </svg>\n      ),\n      active: true,\n    },\n    {\n      name: 'Account & Security',\n      href: '#',\n      icon: (\n        <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z\" />\n        </svg>\n      ),\n      active: false,\n      comingSoon: true,\n    },\n    {\n      name: 'Privacy & Data',\n      href: '#',\n      icon: (\n        <svg className=\"w-5 h-5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z\" />\n        </svg>\n      ),\n      active: false,\n      comingSoon: true,\n    },\n  ];\n\n  const isActive = (href) => {\n    if (href === '#') return false;\n    return pathname === href;\n  };\n\n  return (\n    <>\n      {/* Desktop Sidebar */}\n      <div className=\"hidden lg:block lg:w-64 lg:flex-shrink-0\">\n        <div className=\"h-full bg-white border-r border-gray-200\">\n          <nav className=\"px-4 py-6 space-y-1\">\n            {navItems.map((item) => {\n              const active = isActive(item.href);\n              const disabled = item.comingSoon;\n              \n              if (disabled) {\n                return (\n                  <div\n                    key={item.name}\n                    className=\"flex items-center justify-between px-4 py-3 text-sm font-medium text-gray-400 cursor-not-allowed opacity-60\"\n                  >\n                    <div className=\"flex items-center gap-3\">\n                      {item.icon}\n                      <span>{item.name}</span>\n                    </div>\n                    <span className=\"text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded\">\n                      Soon\n                    </span>\n                  </div>\n                );\n              }\n              \n              return (\n                <Link\n                  key={item.name}\n                  href={item.href}\n                  className={`flex items-center gap-3 px-4 py-3 text-sm font-medium rounded-lg transition-colors duration-200 ${\n                    active\n                      ? 'bg-emerald-50 text-emerald-700'\n                      : 'text-gray-700 hover:bg-gray-50 hover:text-gray-900'\n                  }`}\n                >\n                  {item.icon}\n                  <span>{item.name}</span>\n                </Link>\n              );\n            })}\n          </nav>\n        </div>\n      </div>\n\n      {/* Mobile Tabs - Improved responsive design */}\n      <div className=\"lg:hidden border-b border-gray-200 bg-white sticky top-0 z-20\">\n        <div className=\"overflow-x-auto scrollbar-hide\">\n          <nav className=\"flex gap-2 px-3 sm:px-4 py-3 min-w-max\" aria-label=\"Settings navigation\">\n            {navItems.map((item) => {\n              const active = isActive(item.href);\n              const disabled = item.comingSoon;\n              \n              if (disabled) {\n                return (\n                  <div\n                    key={item.name}\n                    className=\"flex items-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium text-gray-400 whitespace-nowrap cursor-not-allowed opacity-60 border border-gray-200 rounded-full\"\n                  >\n                    <span className=\"w-4 h-4 sm:w-5 sm:h-5\">\n                      {item.icon}\n                    </span>\n                    <span className=\"hidden xs:inline\">{item.name}</span>\n                    <span className=\"xs:hidden\">{item.name.split(' ')[0]}</span>\n                    <svg className=\"w-3 h-3 sm:w-4 sm:h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z\" />\n                    </svg>\n                  </div>\n                );\n              }\n              \n              return (\n                <Link\n                  key={item.name}\n                  href={item.href}\n                  className={`flex items-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-2 text-xs sm:text-sm font-medium whitespace-nowrap rounded-full transition-colors duration-200 ${\n                    active\n                      ? 'bg-emerald-600 text-white'\n                      : 'text-gray-700 hover:bg-gray-100 border border-gray-200'\n                  }`}\n                >\n                  <span className=\"w-4 h-4 sm:w-5 sm:h-5\">\n                    {item.icon}\n                  </span>\n                  <span className=\"hidden xs:inline\">{item.name}</span>\n                  <span className=\"xs:hidden\">{item.name.split(' ')[0]}</span>\n                </Link>\n              );\n            })}\n          </nav>\n        </div>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":5761,"size_tokens":null},"src/app/(chrome)/settings/notifications/page.js":{"content":"\"use client\";\n\nimport { useState, useEffect } from 'react';\nimport { useRouter } from 'next/navigation';\nimport { useAuth } from '@/hooks/useAuth';\nimport SettingsSidebar from '@/components/SettingsSidebar';\nimport Link from 'next/link';\n\nexport default function NotificationSettingsPage() {\n  const router = useRouter();\n  const { user, loading: authLoading } = useAuth();\n  \n  const [preferences, setPreferences] = useState({\n    warnings: true,\n    removals: true,\n    restorations: true,\n    profileReports: true,\n    adminActions: true,\n  });\n  \n  useEffect(() => {\n    const saved = localStorage.getItem('notification-preferences');\n    if (saved) {\n      try {\n        setPreferences(JSON.parse(saved));\n      } catch (error) {\n        console.error('Error loading notification preferences:', error);\n      }\n    }\n  }, []);\n  \n  const handlePreferenceChange = (key) => {\n    const newPreferences = {\n      ...preferences,\n      [key]: !preferences[key],\n    };\n    setPreferences(newPreferences);\n    localStorage.setItem('notification-preferences', JSON.stringify(newPreferences));\n  };\n  \n  useEffect(() => {\n    if (!authLoading && !user) {\n      router.push('/signin');\n    }\n  }, [user, authLoading, router]);\n  \n  if (authLoading) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-2 border-emerald-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-gray-600\">Loading...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (!user) {\n    return null;\n  }\n  \n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <div className=\"flex flex-col lg:flex-row\">\n        <SettingsSidebar />\n        \n        <div className=\"flex-1 w-full\">\n          <div className=\"max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-8\">\n            <div className=\"bg-yellow-400 px-4 sm:px-6 py-4 sm:py-6 rounded-t-xl\">\n              <h1 className=\"text-xl sm:text-2xl lg:text-3xl font-bold text-emerald-700\">Notification Settings</h1>\n              <p className=\"text-sm sm:text-base lg:text-lg text-gray-700 mt-1 sm:mt-2\">Manage your notification preferences</p>\n            </div>\n            \n            <div className=\"bg-white rounded-b-xl border border-t-0 border-gray-200 px-4 sm:px-6 py-6 sm:py-8 shadow-sm space-y-6 sm:space-y-8\">\n              \n              <div className=\"bg-blue-50 border border-blue-200 rounded-lg p-4\">\n                <div className=\"flex items-start gap-3\">\n                  <svg className=\"w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n                    <path fillRule=\"evenodd\" d=\"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z\" clipRule=\"evenodd\" />\n                  </svg>\n                  <div className=\"flex-1\">\n                    <h3 className=\"text-sm font-medium text-blue-900 mb-1\">In-App Notifications Only</h3>\n                    <p className=\"text-sm text-blue-700\">\n                      Notifications now appear inside the app - no browser permissions needed! Check the{' '}\n                      <Link href=\"/profile/notifications\" className=\"font-medium underline hover:text-blue-800\">\n                        notification inbox\n                      </Link>\n                      {' '}for all your updates.\n                    </p>\n                  </div>\n                </div>\n              </div>\n              \n              <div>\n                <h2 className=\"text-base sm:text-lg font-semibold text-gray-900 mb-3 sm:mb-4\">\n                  Notification Types\n                </h2>\n                \n                <p className=\"text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4\">\n                  Choose which types of notifications you want to receive\n                </p>\n                \n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center justify-between gap-4 p-3 sm:p-4 bg-gray-50 rounded-lg border border-gray-200\">\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-sm font-medium text-gray-900 mb-1\">\n                        Campaign Warnings\n                      </p>\n                      <p className=\"text-xs text-gray-500\">\n                        When your campaign is flagged and under review\n                      </p>\n                    </div>\n                    <button\n                      onClick={() => handlePreferenceChange('warnings')}\n                      className={`flex-shrink-0 relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 ${\n                        preferences.warnings ? 'bg-emerald-600' : 'bg-gray-300'\n                      }`}\n                      aria-label=\"Toggle campaign warnings\"\n                    >\n                      <span\n                        className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${\n                          preferences.warnings ? 'translate-x-6' : 'translate-x-1'\n                        }`}\n                      />\n                    </button>\n                  </div>\n                  \n                  <div className=\"flex items-center justify-between gap-4 p-3 sm:p-4 bg-gray-50 rounded-lg border border-gray-200\">\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-sm font-medium text-gray-900 mb-1\">\n                        Campaign Removals\n                      </p>\n                      <p className=\"text-xs text-gray-500\">\n                        When your campaign is removed for violating guidelines\n                      </p>\n                    </div>\n                    <button\n                      onClick={() => handlePreferenceChange('removals')}\n                      className={`flex-shrink-0 relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 ${\n                        preferences.removals ? 'bg-emerald-600' : 'bg-gray-300'\n                      }`}\n                      aria-label=\"Toggle campaign removals\"\n                    >\n                      <span\n                        className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${\n                          preferences.removals ? 'translate-x-6' : 'translate-x-1'\n                        }`}\n                      />\n                    </button>\n                  </div>\n                  \n                  <div className=\"flex items-center justify-between gap-4 p-3 sm:p-4 bg-gray-50 rounded-lg border border-gray-200\">\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-sm font-medium text-gray-900 mb-1\">\n                        Campaign Restorations\n                      </p>\n                      <p className=\"text-xs text-gray-500\">\n                        When your campaign is restored after review\n                      </p>\n                    </div>\n                    <button\n                      onClick={() => handlePreferenceChange('restorations')}\n                      className={`flex-shrink-0 relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 ${\n                        preferences.restorations ? 'bg-emerald-600' : 'bg-gray-300'\n                      }`}\n                      aria-label=\"Toggle campaign restorations\"\n                    >\n                      <span\n                        className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${\n                          preferences.restorations ? 'translate-x-6' : 'translate-x-1'\n                        }`}\n                      />\n                    </button>\n                  </div>\n                  \n                  <div className=\"flex items-center justify-between gap-4 p-3 sm:p-4 bg-gray-50 rounded-lg border border-gray-200\">\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-sm font-medium text-gray-900 mb-1\">\n                        Profile Reports\n                      </p>\n                      <p className=\"text-xs text-gray-500\">\n                        When someone reports your profile or content\n                      </p>\n                    </div>\n                    <button\n                      onClick={() => handlePreferenceChange('profileReports')}\n                      className={`flex-shrink-0 relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 ${\n                        preferences.profileReports ? 'bg-emerald-600' : 'bg-gray-300'\n                      }`}\n                      aria-label=\"Toggle profile reports\"\n                    >\n                      <span\n                        className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${\n                          preferences.profileReports ? 'translate-x-6' : 'translate-x-1'\n                        }`}\n                      />\n                    </button>\n                  </div>\n                  \n                  <div className=\"flex items-center justify-between gap-4 p-3 sm:p-4 bg-gray-50 rounded-lg border border-gray-200\">\n                    <div className=\"flex-1 min-w-0\">\n                      <p className=\"text-sm font-medium text-gray-900 mb-1\">\n                        Admin Actions\n                      </p>\n                      <p className=\"text-xs text-gray-500\">\n                        Important admin updates, warnings, and account actions\n                      </p>\n                    </div>\n                    <button\n                      onClick={() => handlePreferenceChange('adminActions')}\n                      className={`flex-shrink-0 relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-2 ${\n                        preferences.adminActions ? 'bg-emerald-600' : 'bg-gray-300'\n                      }`}\n                      aria-label=\"Toggle admin actions\"\n                    >\n                      <span\n                        className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${\n                          preferences.adminActions ? 'translate-x-6' : 'translate-x-1'\n                        }`}\n                      />\n                    </button>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10930,"size_tokens":null},"src/app/(chrome)/settings/layout.js":{"content":"export default function SettingsLayout({ children }) {\n  return <>{children}</>;\n}\n","path":null,"size_bytes":83,"size_tokens":null},"src/components/ShareModal.js":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { getCampaignPreview, getProfileAvatar } from \"../utils/imageTransform\";\nimport { useBodyScrollLock } from \"../hooks/useBodyScrollLock\";\n\nexport default function ShareModal({\n  isOpen,\n  onClose,\n  type = \"profile\", // \"profile\" or \"campaign\"\n  url,\n  title,\n  subtitle,\n  image,\n  // Legacy props for backward compatibility\n  profileUrl,\n  displayName,\n  username,\n  profileImage,\n}) {\n  const [copied, setCopied] = useState(false);\n\n  // Lock body scroll when modal is open\n  useBodyScrollLock(isOpen);\n\n  if (!isOpen) return null;\n\n  // Use new props or fall back to legacy props\n  const shareUrl = url || profileUrl;\n  const shareTitle = title || displayName;\n  const shareSubtitle = subtitle || (username ? `@${username}` : \"\");\n  const rawImage = image || profileImage;\n  const isProfile = type === \"profile\";\n  \n  // Apply ImageKit optimization based on type\n  const shareImage = rawImage \n    ? (isProfile ? getProfileAvatar(rawImage) : getCampaignPreview(rawImage))\n    : null;\n\n  const handleCopyLink = async () => {\n    try {\n      await navigator.clipboard.writeText(shareUrl);\n      setCopied(true);\n      setTimeout(() => setCopied(false), 2000);\n    } catch (error) {\n      console.error(\"Failed to copy link:\", error);\n    }\n  };\n\n  const handleShareFacebook = () => {\n    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}`;\n    window.open(facebookUrl, \"_blank\", \"width=600,height=400\");\n  };\n\n  const handleShareTwitter = () => {\n    const twitterText = isProfile \n      ? `Check out ${shareTitle}'s profile on Twibbonize!`\n      : `Check out this campaign: ${shareTitle} on Twibbonize!`;\n    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(twitterText)}&url=${encodeURIComponent(shareUrl)}`;\n    window.open(twitterUrl, \"_blank\", \"width=600,height=400\");\n  };\n\n  const handleShareEmail = () => {\n    const subject = isProfile \n      ? `Check out ${shareTitle}'s profile`\n      : `Check out this campaign: ${shareTitle}`;\n    const body = isProfile\n      ? `I thought you might be interested in ${shareTitle}'s profile on Twibbonize: ${shareUrl}`\n      : `I thought you might be interested in this campaign on Twibbonize: ${shareUrl}`;\n    window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;\n  };\n\n  return (\n    <>\n      {/* Backdrop */}\n      <div\n        className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 transition-opacity\"\n        onClick={onClose}\n      />\n\n      {/* Modal */}\n      <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none\">\n        <div\n          className=\"bg-white rounded-2xl max-w-md w-full p-6 pointer-events-auto shadow-2xl relative\"\n          onClick={(e) => e.stopPropagation()}\n        >\n          {/* Close Button */}\n          <button\n            onClick={onClose}\n            className=\"absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition-colors cursor-pointer\"\n          >\n            <svg\n              className=\"w-6 h-6\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              viewBox=\"0 0 24 24\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M6 18L18 6M6 6l12 12\"\n              />\n            </svg>\n          </button>\n\n          {/* Content Info */}\n          <div className=\"text-center mb-6\">\n            {shareImage ? (\n              <img\n                src={shareImage}\n                alt={shareTitle}\n                className={`mx-auto mb-3 border-4 border-gray-100 ${\n                  isProfile \n                    ? \"w-20 h-20 rounded-full object-cover\" \n                    : \"max-w-32 max-h-32 rounded-lg object-contain\"\n                }`}\n                loading=\"lazy\"\n              />\n            ) : (\n              <div className={`mx-auto mb-3 bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center border-4 border-gray-100 ${\n                isProfile \n                  ? \"w-20 h-20 rounded-full\" \n                  : \"w-32 h-32 rounded-lg\"\n              }`}>\n                <span className=\"text-white text-2xl font-bold\">\n                  {shareTitle?.charAt(0)?.toUpperCase() || \"?\"}\n                </span>\n              </div>\n            )}\n            <h3 className=\"text-xl font-bold text-gray-900\">{shareTitle}</h3>\n            {shareSubtitle && <p className=\"text-gray-500\">{shareSubtitle}</p>}\n          </div>\n\n          {/* Share to Social Media */}\n          <div className=\"mb-6\">\n            <h4 className=\"text-center text-gray-700 font-medium mb-4\">\n              Share to your social media\n            </h4>\n            <div className=\"flex justify-center gap-4\">\n              {/* Facebook */}\n              <button\n                onClick={handleShareFacebook}\n                className=\"btn-base btn-facebook w-14 h-14 rounded-full\"\n                aria-label=\"Share on Facebook\"\n              >\n                <svg\n                  className=\"w-7 h-7 text-white\"\n                  fill=\"currentColor\"\n                  viewBox=\"0 0 24 24\"\n                >\n                  <path d=\"M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z\" />\n                </svg>\n              </button>\n\n              {/* Twitter/X */}\n              <button\n                onClick={handleShareTwitter}\n                className=\"w-14 h-14 rounded-full bg-black hover:bg-gray-800 flex items-center justify-center transition-colors cursor-pointer\"\n                aria-label=\"Share on X\"\n              >\n                <svg\n                  className=\"w-6 h-6 text-white\"\n                  fill=\"currentColor\"\n                  viewBox=\"0 0 24 24\"\n                >\n                  <path d=\"M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z\" />\n                </svg>\n              </button>\n\n              {/* Email */}\n              <button\n                onClick={handleShareEmail}\n                className=\"w-14 h-14 rounded-full bg-gray-600 hover:bg-gray-700 flex items-center justify-center transition-colors cursor-pointer\"\n                aria-label=\"Share via Email\"\n              >\n                <svg\n                  className=\"w-7 h-7 text-white\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  viewBox=\"0 0 24 24\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    strokeWidth={2}\n                    d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\"\n                  />\n                </svg>\n              </button>\n            </div>\n          </div>\n\n          {/* Divider */}\n          <div className=\"relative mb-6\">\n            <div className=\"absolute inset-0 flex items-center\">\n              <div className=\"w-full border-t border-gray-200\"></div>\n            </div>\n            <div className=\"relative flex justify-center text-sm\">\n              <span className=\"px-4 bg-white text-gray-500\">or copy link</span>\n            </div>\n          </div>\n\n          {/* Copy Link */}\n          <div className=\"flex gap-2\">\n            <input\n              type=\"text\"\n              value={shareUrl}\n              readOnly\n              className=\"flex-1 min-w-0 px-3 py-2.5 border border-gray-300 rounded-lg bg-gray-50 text-gray-700 text-sm focus:outline-none truncate\"\n            />\n            <button\n              onClick={handleCopyLink}\n              className={`px-4 sm:px-6 py-2.5 rounded-lg font-medium text-sm whitespace-nowrap transition-all ${\n                copied\n                  ? \"bg-green-600 text-white\"\n                  : \"bg-emerald-600 hover:bg-emerald-700 text-white\"\n              } cursor-pointer`}\n            >\n              {copied ? \"Copied!\" : \"Copy\"}\n            </button>\n          </div>\n        </div>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":8436,"size_tokens":null},"src/components/ReportModal.js":{"content":"\"use client\";\n\nimport { useState } from 'react';\nimport { useAuth } from '../hooks/useAuth';\nimport { useBodyScrollLock } from '../hooks/useBodyScrollLock';\n\nexport default function ReportModal({ \n  isOpen, \n  onClose, \n  type = 'campaign',\n  campaignId, \n  campaignSlug,\n  reportedUserId,\n  reportedUsername\n}) {\n  const { user } = useAuth();\n  const [reportReason, setReportReason] = useState('');\n  const [reportSubmitting, setReportSubmitting] = useState(false);\n  const [reportSuccess, setReportSuccess] = useState(false);\n  const [error, setError] = useState('');\n\n  // Lock body scroll when modal is open\n  useBodyScrollLock(isOpen);\n\n  if (!isOpen) return null;\n\n  const campaignReasons = [\n    { value: 'inappropriate', label: 'Inappropriate Content' },\n    { value: 'spam', label: 'Spam' },\n    { value: 'copyright', label: 'Copyright Violation' },\n    { value: 'other', label: 'Other' }\n  ];\n\n  const userReasons = [\n    { value: 'inappropriate_avatar', label: 'Inappropriate Profile Picture' },\n    { value: 'offensive_username', label: 'Offensive Username' },\n    { value: 'spam_bio', label: 'Spam in Bio/Description' },\n    { value: 'impersonation', label: 'Impersonation' },\n    { value: 'other', label: 'Other' }\n  ];\n\n  const reasons = type === 'user' ? userReasons : campaignReasons;\n  const title = type === 'user' ? 'Report User' : 'Report Campaign';\n\n  const handleReportSubmit = async (e) => {\n    e.preventDefault();\n    \n    if (!reportReason) {\n      setError('Please select a reason for reporting');\n      return;\n    }\n    \n    setReportSubmitting(true);\n    setError('');\n    \n    try {\n      let reportData, endpoint;\n\n      if (type === 'user') {\n        reportData = {\n          reportedUserId,\n          reportedUsername,\n          reportedBy: user?.uid || 'anonymous',\n          reason: reportReason\n        };\n        endpoint = '/api/reports/user';\n      } else {\n        reportData = {\n          campaignId,\n          campaignSlug,\n          reportedBy: user?.uid || 'anonymous',\n          reason: reportReason\n        };\n        endpoint = '/api/reports/submit';\n      }\n      \n      const response = await fetch(endpoint, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(reportData),\n      });\n      \n      const result = await response.json();\n      \n      if (result.success) {\n        setReportSuccess(true);\n      } else {\n        setError(result.error || 'Failed to submit report');\n      }\n      \n      setReportSubmitting(false);\n    } catch (error) {\n      console.error(`Error submitting ${type} report:`, error);\n      setError('Failed to submit report. Please try again.');\n      setReportSubmitting(false);\n    }\n  };\n\n  const handleClose = () => {\n    setReportReason('');\n    setError('');\n    setReportSuccess(false);\n    onClose();\n  };\n\n  return (\n    <>\n      {/* Backdrop with blur */}\n      <div \n        className=\"fixed inset-0 bg-black/50 backdrop-blur-sm z-50 transition-opacity\"\n        onClick={handleClose}\n      />\n      \n      {/* Modal */}\n      <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 pointer-events-none\">\n        <div \n          className=\"bg-white rounded-lg max-w-md w-full p-6 pointer-events-auto\"\n          onClick={(e) => e.stopPropagation()}\n        >\n          {reportSuccess ? (\n            // Success State\n            <div className=\"text-center py-4\">\n              <div className=\"mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4\">\n                <svg className=\"h-8 w-8 text-green-600\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                  <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M5 13l4 4L19 7\" />\n                </svg>\n              </div>\n              <h3 className=\"text-xl font-bold text-gray-900 mb-2\">Report Submitted</h3>\n              <p className=\"text-gray-600 mb-6\">\n                Thank you for your report. We will review it shortly.\n              </p>\n              <button\n                onClick={handleClose}\n                className=\"btn-base btn-primary px-8 py-2 font-medium\"\n              >\n                OK\n              </button>\n            </div>\n          ) : (\n            // Report Form\n            <>\n              <h2 className=\"text-2xl font-bold text-gray-900 mb-4\">{title}</h2>\n              \n              {error && (\n                <div className=\"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-600 text-sm\">\n                  {error}\n                </div>\n              )}\n              \n              <form onSubmit={handleReportSubmit}>\n                <div className=\"mb-4\">\n                  <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                    Reason <span className=\"text-red-500\">*</span>\n                  </label>\n                  <select\n                    value={reportReason}\n                    onChange={(e) => setReportReason(e.target.value)}\n                    required\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none transition-all text-gray-900 bg-white\"\n                  >\n                    <option value=\"\" className=\"text-gray-400\">Select a reason</option>\n                    {reasons.map((reason) => (\n                      <option key={reason.value} value={reason.value} className=\"text-gray-900\">\n                        {reason.label}\n                      </option>\n                    ))}\n                  </select>\n                </div>\n                \n                <div className=\"flex gap-3 mt-6\">\n                  <button\n                    type=\"button\"\n                    onClick={handleClose}\n                    className=\"btn-base btn-secondary flex-1 py-2 font-medium\"\n                    disabled={reportSubmitting}\n                  >\n                    Cancel\n                  </button>\n                  <button\n                    type=\"submit\"\n                    className=\"btn-base bg-red-500 hover:bg-red-600 text-white flex-1 py-2 font-medium disabled:opacity-50 disabled:cursor-not-allowed\"\n                    disabled={reportSubmitting || !reportReason}\n                  >\n                    {reportSubmitting ? 'Submitting...' : 'Submit Report'}\n                  </button>\n                </div>\n              </form>\n            </>\n          )}\n        </div>\n      </div>\n    </>\n  );\n}\n","path":null,"size_bytes":6542,"size_tokens":null},"NOTIFICATION_SYSTEM_FIXES.md":{"content":"# FCM Notification System - Critical Fixes\n\n**Date:** October 13, 2025  \n**Status:**  COMPLETED & ARCHITECT REVIEWED\n\n## Problem Summary\n\nUsers were experiencing a critical bug where:\n1.  First notification was received successfully\n2.  Device token was automatically removed from database after first notification\n3.  No subsequent notifications could be received\n4.  Settings toggle appeared enabled but notifications didn't arrive (confusing UX)\n\n## Root Causes Identified\n\n### 1. **Indiscriminate Token Removal**\nThe send API was removing ALL failed tokens, including those with temporary/transient errors (network issues, rate limits, server unavailable).\n\n**Industry Standard:** Only remove tokens for **permanent failures** (invalid token, unregistered token), NOT temporary failures.\n\n### 2. **Missing Token Re-registration**\nThe `useFCM` hook retrieved existing tokens from cache but didn't re-register them with the server, so server-side deletions were never restored.\n\n### 3. **Canonical Token Update Issues**\nFirebase returns canonical (updated) tokens for better delivery, but the system wasn't handling these updates properly, leading to:\n- Race conditions in batch operations\n- Duplicate writes causing batch failures\n- Tokens remaining outdated\n\n## Solutions Implemented\n\n### 1. **Smart Token Cleanup** (`/api/notifications/send/route.js`)\n\n**Permanent Errors (REMOVE TOKEN):**\n- `messaging/invalid-registration-token`\n- `messaging/registration-token-not-registered`\n- `messaging/invalid-argument`\n- `messaging/mismatched-credential`\n- `messaging/authentication-error`\n\n**Transient Errors (RETAIN TOKEN):**\n- `messaging/server-unavailable`\n- `messaging/internal-error`\n- `messaging/unavailable`\n- `messaging/quota-exceeded`\n- `messaging/third-party-auth-error`\n\n**Unknown Errors:** Retained for safety (logged for monitoring)\n\n### 2. **Canonical Token Handling** (`/api/notifications/send/route.js`)\n\n**Fixed Implementation:**\n- Deduplicates by canonical (new) token, not old token\n- Groups all old tokens mapping to same canonical\n- Ensures each canonical token written only ONCE per batch\n- Uses `merge: true` for graceful handling of pre-existing tokens\n- Deletes ALL old tokens in same atomic operation\n\n**Prevents:**\n- Batch write conflicts (duplicate document writes)\n- Race conditions during token updates\n- Data loss during canonical upgrades\n\n### 3. **Token Re-registration** (`src/hooks/useFCM.js`)\n\n**New Behavior:**\n- When existing token is retrieved from cache, it's immediately re-registered with server\n- Updates `lastUsed` timestamp\n- Ensures server-side persistence even if token was deleted\n- Prevents desync between client and server token state\n\n### 4. **Enhanced Logging**\n\n**Added Comprehensive Logging:**\n-  Success confirmations with token counts\n-  Canonical token updates with before/after info\n-  Permanent token removals with reasons\n-  Transient errors (retained for retry)\n-  Detailed metrics in API responses\n\n## Expected Outcomes\n\n **Devices persist after first notification**  \n **Tokens survive transient network/server errors**  \n **Canonical token updates handled properly**  \n **Better error monitoring and debugging**  \n **Settings page accurately reflects device status**  \n **Toggle button state matches actual notification capability**\n\n## API Response Format (Updated)\n\n```json\n{\n  \"success\": true,\n  \"successCount\": 1,\n  \"failureCount\": 0,\n  \"tokensRemoved\": 0,\n  \"tokensUpdated\": 0,\n  \"transientErrors\": 0,\n  \"message\": \"Sent 1 notifications, 0 failed (0 tokens removed, 0 transient errors)\"\n}\n```\n\n## Testing Recommendations\n\n1. **Send multiple notifications to same user** - Verify device persists\n2. **Test during network issues** - Verify tokens retained for transient errors\n3. **Monitor canonical updates** - Check logs for token upgrade paths\n4. **Verify settings page** - Confirm device list stays accurate\n5. **Test toggle behavior** - Ensure UI state matches functionality\n\n## Future Enhancements (Suggested by Architect)\n\n1. **Regression Tests:** Add unit/integration tests for duplicate canonical responses\n2. **Backwards Compatibility:** Add fallback to document IDs if `token` field missing\n3. **Monitoring:** Track metrics around canonical upgrades under load\n4. **Retry Logic:** Implement automatic retry for transient errors\n\n## Architecture Review\n\n **Architect Approved** - All critical issues resolved:\n- No race conditions in canonical token handling\n- No duplicate writes in batch operations\n- Proper error classification and handling\n- Safe token lifecycle management\n\n---\n\n**Files Modified:**\n- `src/app/api/notifications/send/route.js` - Smart token cleanup & canonical handling\n- `src/hooks/useFCM.js` - Token re-registration on retrieval\n\n**Lines Changed:** ~150 lines across 2 files\n**Review Status:**  Architect Approved\n","path":null,"size_bytes":4874,"size_tokens":null},"src/hooks/useNotifications.js":{"content":"\"use client\";\n\nimport { useState, useEffect, useCallback, useRef } from 'react';\nimport { useAuth } from '@/hooks/useAuth';\nimport { collection, query, orderBy, onSnapshot, limit } from 'firebase/firestore';\nimport { db } from '@/lib/firebase-optimized';\n\n// Helper to get dismissed notifications from localStorage\nconst getDismissedNotifications = () => {\n  if (typeof window === 'undefined') return [];\n  try {\n    const dismissed = localStorage.getItem('dismissedNotifications');\n    return dismissed ? JSON.parse(dismissed) : [];\n  } catch {\n    return [];\n  }\n};\n\n// Helper to save dismissed notification to localStorage\nconst addDismissedNotification = (notificationId) => {\n  if (typeof window === 'undefined') return;\n  try {\n    const dismissed = getDismissedNotifications();\n    if (!dismissed.includes(notificationId)) {\n      dismissed.push(notificationId);\n      // Keep only last 100 dismissed notifications to prevent localStorage bloat\n      const recent = dismissed.slice(-100);\n      localStorage.setItem('dismissedNotifications', JSON.stringify(recent));\n    }\n  } catch (error) {\n    console.error('Error saving dismissed notification:', error);\n  }\n};\n\nexport function useNotifications() {\n  const { user } = useAuth();\n  const [notifications, setNotifications] = useState([]);\n  const [unreadCount, setUnreadCount] = useState(0);\n  const [latestNotification, setLatestNotification] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const lastNotificationIdRef = useRef(null);\n  const isInitialLoadRef = useRef(true);\n\n  useEffect(() => {\n    if (!user) {\n      setNotifications([]);\n      setUnreadCount(0);\n      setLoading(false);\n      lastNotificationIdRef.current = null;\n      isInitialLoadRef.current = true;\n      return;\n    }\n\n    const notificationsRef = collection(db, 'users', user.uid, 'notifications');\n    const q = query(notificationsRef, orderBy('createdAt', 'desc'), limit(50));\n\n    const unsubscribe = onSnapshot(q, (snapshot) => {\n      const notificationsList = snapshot.docs.map(doc => ({\n        id: doc.id,\n        ...doc.data(),\n        createdAt: doc.data().createdAt?.toDate(),\n      }));\n\n      setNotifications(notificationsList);\n      setUnreadCount(notificationsList.filter(n => !n.read).length);\n      \n      // Get dismissed notifications from localStorage\n      const dismissedIds = getDismissedNotifications();\n      \n      // Find the latest unread notification that hasn't been dismissed\n      const latestUnread = notificationsList.find(n => !n.read && !dismissedIds.includes(n.id));\n      \n      // On the very first load, just record the latest notification ID without showing toast\n      if (isInitialLoadRef.current) {\n        if (latestUnread) {\n          lastNotificationIdRef.current = latestUnread.id;\n        }\n        isInitialLoadRef.current = false;\n      } else if (latestUnread && latestUnread.id !== lastNotificationIdRef.current) {\n        // This is a truly NEW notification (arrived after initial load)\n        lastNotificationIdRef.current = latestUnread.id;\n        setLatestNotification(latestUnread);\n      }\n      \n      setLoading(false);\n    }, (error) => {\n      console.error('Error fetching notifications:', error);\n      setLoading(false);\n    });\n\n    return () => unsubscribe();\n  }, [user]);\n\n  const markAsRead = useCallback(async (notificationId) => {\n    if (!user) return;\n    \n    try {\n      const token = await user.getIdToken();\n      await fetch(`/api/notifications/${notificationId}`, {\n        method: 'PATCH',\n        headers: { \n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${token}`\n        },\n        body: JSON.stringify({ read: true }),\n      });\n    } catch (error) {\n      console.error('Error marking notification as read:', error);\n    }\n  }, [user]);\n\n  const deleteNotification = useCallback(async (notificationId) => {\n    if (!user) return;\n    \n    try {\n      const token = await user.getIdToken();\n      await fetch(`/api/notifications/${notificationId}`, {\n        method: 'DELETE',\n        headers: { \n          'Authorization': `Bearer ${token}`\n        },\n      });\n    } catch (error) {\n      console.error('Error deleting notification:', error);\n      throw error;\n    }\n  }, [user]);\n\n  const clearLatestNotification = useCallback((notificationId) => {\n    if (notificationId) {\n      // Mark this notification as dismissed so it won't show again on refresh\n      addDismissedNotification(notificationId);\n    }\n    setLatestNotification(null);\n  }, []);\n\n  return {\n    notifications,\n    unreadCount,\n    latestNotification,\n    loading,\n    markAsRead,\n    deleteNotification,\n    clearLatestNotification,\n  };\n}\n","path":null,"size_bytes":4700,"size_tokens":null},"src/utils/notifications/sendInAppNotification.js":{"content":"import \"server-only\";\nimport { adminFirestore } from \"@/lib/firebaseAdmin\";\nimport { FieldValue } from \"firebase-admin/firestore\";\n\n/**\n * Send in-app notification (Firestore only)\n * Saves notification to user's notifications subcollection\n */\nexport async function sendInAppNotification({\n  userId,\n  title,\n  body,\n  actionUrl,\n  icon,\n  type,\n  metadata = {},\n}) {\n  try {\n    if (process.env.NODE_ENV === 'development') {\n      console.log(\"[IN-APP NOTIFICATION] Sending to userId:\", userId);\n      console.log(\"[IN-APP NOTIFICATION] Details:\", {\n        title,\n        body,\n        actionUrl,\n        type,\n      });\n    }\n\n    if (!userId || !title || !body) {\n      throw new Error(\"Missing required fields: userId, title, and body\");\n    }\n\n    const db = adminFirestore();\n\n    const notificationRef = db\n      .collection(\"users\")\n      .doc(userId)\n      .collection(\"notifications\")\n      .doc();\n\n    const notificationData = {\n      title,\n      body,\n      actionUrl: actionUrl || \"/profile\",\n      icon: icon || \"/icon-192x192.png\",\n      type: type || \"general\",\n      read: false,\n      createdAt: FieldValue.serverTimestamp(),\n      metadata: metadata || {},\n    };\n\n    await notificationRef.set(notificationData);\n\n    if (process.env.NODE_ENV === 'development') {\n      console.log(\n        \"[IN-APP NOTIFICATION] Notification saved successfully:\",\n        notificationRef.id,\n      );\n    }\n\n    return {\n      success: true,\n      notificationId: notificationRef.id,\n      message: \"In-app notification sent successfully\",\n    };\n  } catch (error) {\n    console.error(\"[IN-APP NOTIFICATION] Error:\", error);\n    return {\n      success: false,\n      error: error.message,\n    };\n  }\n}\n","path":null,"size_bytes":1710,"size_tokens":null},"src/app/api/admin/reports/summary/[summaryId]/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\nimport { FieldValue } from 'firebase-admin/firestore';\nimport { sendInAppNotification } from '@/utils/notifications/sendInAppNotification';\nimport { getNotificationTemplate } from '@/utils/notifications/notificationTemplates';\nimport { logAdminAction } from '@/utils/logAdminAction';\nimport { validateCampaignTransition, validateAccountTransition } from '@/utils/admin/statusTransitionValidator';\n\nexport async function PATCH(request, { params }) {\n  try {\n    const adminUser = await requireAdmin(request);\n    \n    const { summaryId } = params;\n    const { status, action, reason } = await request.json();\n    \n    if (!summaryId || !status || !action) {\n      return NextResponse.json(\n        { success: false, error: 'Summary ID, status, and action are required' },\n        { status: 400 }\n      );\n    }\n    \n    // Validate reason is provided for warned and removed actions\n    if ((action === 'warned' || action === 'removed') && !reason) {\n      return NextResponse.json(\n        { success: false, error: 'Reason is required for warnings and removals' },\n        { status: 400 }\n      );\n    }\n    \n    const db = adminFirestore();\n    const summaryRef = db.collection('reportSummary').doc(summaryId);\n    \n    // Get the summary\n    const summaryDoc = await summaryRef.get();\n    \n    if (!summaryDoc.exists) {\n      return NextResponse.json(\n        { success: false, error: 'Summary not found' },\n        { status: 404 }\n      );\n    }\n    \n    const summaryData = summaryDoc.data();\n    const { targetId, targetType } = summaryData;\n    \n    // Validate targetType\n    if (targetType !== 'campaign' && targetType !== 'user') {\n      return NextResponse.json(\n        { success: false, error: `Invalid target type: ${targetType}. Must be 'campaign' or 'user'` },\n        { status: 400 }\n      );\n    }\n    \n    // Track if campaign/user was previously hidden (for notification logic)\n    let wasHidden = false;\n    let targetNotFound = false;\n    \n    // Use transaction to update everything atomically\n    await db.runTransaction(async (transaction) => {\n      const targetRef = targetType === 'campaign' \n        ? db.collection('campaigns').doc(targetId)\n        : db.collection('users').doc(targetId);\n      \n      const targetDoc = await transaction.get(targetRef);\n      \n      if (!targetDoc.exists) {\n        targetNotFound = true;\n        throw new Error(`TARGET_NOT_FOUND:${targetType}`);\n      }\n      \n      const targetData = targetDoc.data();\n      const now = new Date();\n      \n      // Get current status for validation\n      const currentStatus = targetType === 'campaign' \n        ? (targetData.moderationStatus || 'active')\n        : (targetData.accountStatus || 'active');\n      \n      // Determine new status based on action\n      let newStatus;\n      if (action === 'no-action') {\n        newStatus = 'active';\n      } else if (action === 'warned') {\n        newStatus = 'active';\n      } else if (action === 'removed') {\n        newStatus = targetType === 'campaign' ? 'removed-temporary' : 'banned-temporary';\n      }\n      \n      // Validate status transition\n      const validation = targetType === 'campaign'\n        ? validateCampaignTransition(currentStatus, newStatus)\n        : validateAccountTransition(currentStatus, newStatus);\n      \n      if (!validation.valid) {\n        throw new Error(validation.error);\n      }\n      \n      // Check if it was previously hidden (auto-hidden at 3+ reports for campaigns, 10+ for users)\n      // For campaigns: check moderationStatus === 'under-review-hidden'\n      // For users: check accountStatus === 'under-review-hidden'\n      if (targetType === 'campaign') {\n        wasHidden = targetData.moderationStatus === 'under-review-hidden' || targetData.moderationStatus === 'under-review';\n      } else {\n        wasHidden = targetData.accountStatus === 'under-review-hidden' || targetData.accountStatus === 'under-review';\n      }\n      \n      // Update the target based on action - ALWAYS reset reportsCount to 0\n      const targetUpdates = {\n        reportsCount: 0,\n        updatedAt: now,\n      };\n      \n      if (action === 'no-action') {\n        // Dismiss - restore to active and clear all moderation fields\n        if (targetType === 'campaign') {\n          targetUpdates.moderationStatus = 'active';\n        } else {\n          targetUpdates.accountStatus = 'active';\n        }\n        targetUpdates.hiddenAt = FieldValue.delete();\n        targetUpdates.bannedAt = FieldValue.delete();\n        targetUpdates.banReason = FieldValue.delete();\n        targetUpdates.appealDeadline = FieldValue.delete();\n      } else if (action === 'warned') {\n        // Warning issued - create warning record and restore to active\n        // Rationale: Warning is a \"slap on the wrist\" - content reviewed but not severe enough for removal\n        // If content deserves to be hidden, admin should use \"Remove/Ban\" instead\n        const warningRef = db.collection('warnings').doc();\n        transaction.set(warningRef, {\n          userId: targetType === 'campaign' ? targetData.creatorId : targetId,\n          targetType,\n          targetId,\n          reportId: summaryId,\n          reason: reason, // Use admin-selected reason\n          issuedBy: adminUser.uid,\n          issuedByEmail: adminUser.email,\n          issuedByName: adminUser.displayName || adminUser.username || adminUser.email,\n          issuedAt: now,\n          acknowledged: false,\n        });\n        \n        // Restore to active after warning (admin reviewed and decided it's not severe enough)\n        if (targetType === 'campaign') {\n          targetUpdates.moderationStatus = 'active';\n        } else {\n          targetUpdates.accountStatus = 'active';\n        }\n        targetUpdates.hiddenAt = FieldValue.delete();\n        targetUpdates.bannedAt = FieldValue.delete();\n        targetUpdates.banReason = FieldValue.delete();\n        targetUpdates.appealDeadline = FieldValue.delete();\n      } else if (action === 'removed') {\n        // Remove/Ban - use moderationStatus for campaigns, accountStatus for users\n        if (targetType === 'campaign') {\n          targetUpdates.moderationStatus = 'removed-temporary';\n          targetUpdates.appealCount = 0;\n        } else {\n          targetUpdates.accountStatus = 'banned-temporary';\n        }\n        targetUpdates.bannedAt = now;\n        targetUpdates.banReason = reason; // Use admin-selected reason\n        targetUpdates.appealDeadline = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000); // 30 days\n      }\n      \n      transaction.update(targetRef, targetUpdates);\n      \n      // Update summary - reset reportsCount and reasonCounts to 0\n      // Also update cached status and display fields to keep them fresh\n      const summaryUpdates = {\n        status: action === 'no-action' ? 'dismissed' : 'resolved',\n        reportsCount: 0,\n        reasonCounts: {},\n        updatedAt: now,\n      };\n      \n      // Sync cached status fields (moderationStatus for campaigns, accountStatus for users)\n      if (targetType === 'campaign') {\n        summaryUpdates.moderationStatus = targetUpdates.moderationStatus || targetData.moderationStatus;\n      } else {\n        summaryUpdates.accountStatus = targetUpdates.accountStatus || targetData.accountStatus;\n      }\n      \n      // Update cached display data\n      if (targetType === 'campaign') {\n        summaryUpdates.campaignTitle = targetData.title || summaryData.campaignTitle;\n        summaryUpdates.campaignImage = targetData.imageUrl || summaryData.campaignImage;\n      } else {\n        summaryUpdates.displayName = targetData.displayName || summaryData.displayName;\n        summaryUpdates.username = targetData.username || summaryData.username;\n        summaryUpdates.profileImage = targetData.profileImage || summaryData.profileImage;\n      }\n      \n      transaction.update(summaryRef, summaryUpdates);\n    });\n    \n    // Log admin action after transaction completes\n    const actionMap = {\n      'no-action': 'dismissed',\n      'warned': 'warned',\n      'removed': 'removed'\n    };\n    \n    await logAdminAction({\n      adminId: adminUser.uid,\n      adminEmail: adminUser.email,\n      adminName: adminUser.displayName || adminUser.username || adminUser.email,\n      action: actionMap[action] || action,\n      targetType,\n      targetId,\n      targetTitle: targetType === 'campaign' ? summaryData.campaignTitle : summaryData.displayName || summaryData.username,\n      reason: reason || null,\n      summaryId,\n      additionalData: {\n        previousStatus: targetType === 'campaign' ? summaryData.moderationStatus : summaryData.accountStatus,\n        reportsCount: summaryData.reportsCount || 0\n      }\n    });\n    \n    // Send notification after transaction completes\n    try {\n      const userId = targetType === 'campaign' ? summaryData.creatorId : targetId;\n      \n      if (action === 'no-action') {\n        // Only send \"restored\" notification if it was previously hidden (at 3+ reports)\n        // No notification needed if campaign was never auto-hidden\n        if (wasHidden) {\n          const notification = getNotificationTemplate(\n            targetType === 'campaign' ? 'campaignRestored' : 'profileRestored',\n            { campaignTitle: summaryData.campaignTitle }\n          );\n          \n          await sendInAppNotification({\n            userId,\n            title: notification.title,\n            body: notification.body,\n            actionUrl: notification.actionUrl,\n            icon: notification.icon,\n            type: notification.type,\n          });\n          \n          // Send unban email if user was previously banned\n          if (targetType === 'user' && (summaryData.accountStatus === 'banned-temporary' || summaryData.accountStatus === 'banned-permanent')) {\n            const { sendEmail } = await import('@/utils/notifications/sendEmail');\n            const { getEmailTemplate } = await import('@/utils/notifications/emailTemplates');\n            \n            // Get user email from database\n            const userDoc = await db.collection('users').doc(targetId).get();\n            const userData = userDoc.data();\n            \n            if (userData?.email) {\n              const emailTemplate = getEmailTemplate('accountUnbanned', {\n                userEmail: userData.email,\n                username: userData.displayName || userData.username || userData.email,\n              });\n              \n              await sendEmail({\n                to: userData.email,\n                subject: emailTemplate.subject,\n                html: emailTemplate.html,\n              });\n              \n              if (process.env.NODE_ENV === 'development') {\n                console.log('[REPORT UNBAN] Unban email sent to:', userData.email);\n              }\n            }\n          }\n        }\n      } else if (action === 'warned') {\n        const notification = getNotificationTemplate('warningIssued', { \n          reason: reason\n        });\n        \n        await sendInAppNotification({\n          userId,\n          title: notification.title,\n          body: notification.body,\n          actionUrl: notification.actionUrl,\n          icon: notification.icon,\n          type: notification.type,\n        });\n      } else if (action === 'removed') {\n        const appealDeadline = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);\n        const formattedDeadline = appealDeadline.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });\n        \n        if (targetType === 'user') {\n          // For BANNED USERS: Send EMAIL instead of in-app notification\n          // Banned users cannot access their account, so email is the only way to reach them\n          const { sendEmail } = await import('@/utils/notifications/sendEmail');\n          const { getEmailTemplate } = await import('@/utils/notifications/emailTemplates');\n          \n          // Get user email from database\n          const userDoc = await db.collection('users').doc(targetId).get();\n          const userData = userDoc.data();\n          \n          if (userData?.email) {\n            const emailTemplate = getEmailTemplate('accountBanned', {\n              userEmail: userData.email,\n              username: userData.displayName || userData.username || userData.email,\n              banReason: reason,\n              appealDeadline: formattedDeadline,\n              isPermanent: false, // From reports, it's always temporary ban\n            });\n            \n            await sendEmail({\n              to: userData.email,\n              subject: emailTemplate.subject,\n              html: emailTemplate.html,\n            });\n            \n            if (process.env.NODE_ENV === 'development') {\n              console.log('[REPORT BAN] Ban email sent to:', userData.email);\n            }\n          }\n        } else {\n          // For CAMPAIGN REMOVALS: Keep in-app notification (creator can still log in)\n          const notification = getNotificationTemplate('campaignRemoved', { \n            campaignTitle: summaryData.campaignTitle, \n            appealDeadline: formattedDeadline, \n            removalReason: reason \n          });\n          \n          await sendInAppNotification({\n            userId,\n            title: notification.title,\n            body: notification.body,\n            actionUrl: notification.actionUrl,\n            icon: notification.icon,\n            type: notification.type,\n          });\n        }\n      }\n    } catch (notifError) {\n      console.error('Failed to send notification:', notifError);\n    }\n    \n    return NextResponse.json({\n      success: true,\n      message: `Successfully ${action === 'no-action' ? 'dismissed' : action === 'warned' ? 'warned' : 'removed'} ${targetType}`,\n    });\n  } catch (error) {\n    console.error('Error updating grouped reports:', error);\n    \n    if (error.message.includes('Unauthorized') || error.message.includes('Admin access required')) {\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 403 }\n      );\n    }\n    \n    if (error.message.startsWith('TARGET_NOT_FOUND:')) {\n      const targetType = error.message.split(':')[1];\n      return NextResponse.json(\n        { success: false, error: `${targetType} not found - may have been deleted` },\n        { status: 404 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: error.message || 'Failed to update reports' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":14582,"size_tokens":null},"src/app/api/admin/reports/grouped/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\n\nexport async function GET(request) {\n  try {\n    await requireAdmin(request);\n    \n    const { searchParams } = new URL(request.url);\n    const targetType = searchParams.get('targetType') || 'all';\n    const status = searchParams.get('status') || 'pending';\n    const sortBy = searchParams.get('sortBy') || 'lastReportedAt';\n    const sortOrder = searchParams.get('sortOrder') || 'desc';\n    const limitParam = searchParams.get('limit') || '10';\n    const limitValue = parseInt(limitParam, 10);\n    \n    const db = adminFirestore();\n    let summariesQuery = db.collection('reportSummary');\n    \n    // Filter by target type (campaign, user, or all)\n    if (targetType !== 'all') {\n      summariesQuery = summariesQuery.where('targetType', '==', targetType);\n    }\n    \n    // Filter by status (pending, resolved, dismissed)\n    if (status !== 'all') {\n      summariesQuery = summariesQuery.where('status', '==', status);\n    }\n    \n    // Add sorting\n    summariesQuery = summariesQuery.orderBy(sortBy, sortOrder).limit(limitValue);\n    \n    const summariesSnapshot = await summariesQuery.get();\n    \n    // Step 1: Convert to plain objects and collect all IDs\n    const summariesData = summariesSnapshot.docs.map(doc => ({\n      id: doc.id,\n      ...doc.data()\n    }));\n    \n    // Step 2: Collect unique IDs for batch fetching\n    const campaignIds = new Set();\n    const userIds = new Set();\n    \n    summariesData.forEach(summary => {\n      if (summary.targetType === 'campaign' && summary.targetId) {\n        campaignIds.add(summary.targetId);\n        if (summary.creatorId) {\n          userIds.add(summary.creatorId);\n        }\n      } else if (summary.targetType === 'user' && summary.targetId) {\n        userIds.add(summary.targetId);\n      }\n    });\n    \n    // Step 3: Batch fetch all campaigns and users at once (reduces N+1 queries)\n    const campaignRefs = Array.from(campaignIds).map(id => db.collection('campaigns').doc(id));\n    const userRefs = Array.from(userIds).map(id => db.collection('users').doc(id));\n    \n    // Fetch all documents in parallel\n    const [campaignDocs, userDocs] = await Promise.all([\n      campaignRefs.length > 0 ? db.getAll(...campaignRefs) : Promise.resolve([]),\n      userRefs.length > 0 ? db.getAll(...userRefs) : Promise.resolve([])\n    ]);\n    \n    // Step 4: Build lookup maps for O(1) access\n    const campaignsMap = new Map();\n    campaignDocs.forEach(doc => {\n      if (doc.exists) {\n        campaignsMap.set(doc.id, doc.data());\n      }\n    });\n    \n    const usersMap = new Map();\n    userDocs.forEach(doc => {\n      if (doc.exists) {\n        usersMap.set(doc.id, doc.data());\n      }\n    });\n    \n    // Step 5: Populate summaries with fetched data\n    const summaries = summariesData.map(summaryData => {\n      // Fetch LIVE status from actual target document (campaign or user)\n      if (summaryData.targetId) {\n        if (summaryData.targetType === 'campaign') {\n          const targetData = campaignsMap.get(summaryData.targetId);\n          \n          if (targetData) {\n            summaryData.moderationStatus = targetData.moderationStatus || 'active';\n            summaryData.campaignTitle = targetData.title || summaryData.campaignTitle;\n            summaryData.campaignImage = targetData.imageUrl || summaryData.campaignImage;\n          } else {\n            summaryData.targetDeleted = true;\n            summaryData.moderationStatus = 'deleted';\n          }\n        } else {\n          const targetData = usersMap.get(summaryData.targetId);\n          \n          if (targetData) {\n            summaryData.accountStatus = targetData.accountStatus || 'active';\n            summaryData.displayName = targetData.displayName || summaryData.displayName;\n            summaryData.username = targetData.username || summaryData.username;\n            summaryData.profileImage = targetData.profileImage || summaryData.profileImage;\n          } else {\n            summaryData.targetDeleted = true;\n            summaryData.accountStatus = 'deleted';\n          }\n        }\n      }\n      \n      // Add creator info for campaign reports\n      if (summaryData.targetType === 'campaign' && summaryData.creatorId) {\n        const creatorData = usersMap.get(summaryData.creatorId);\n        \n        if (creatorData) {\n          summaryData.creator = {\n            uid: summaryData.creatorId,\n            displayName: creatorData.displayName,\n            username: creatorData.username,\n            profileImage: creatorData.profileImage,\n          };\n        } else {\n          summaryData.creator = {\n            uid: summaryData.creatorId,\n            displayName: '[Deleted User]',\n            username: null,\n            profileImage: null,\n          };\n        }\n      }\n      \n      // Convert Firestore timestamps to ISO strings\n      if (summaryData.firstReportedAt && summaryData.firstReportedAt.toDate) {\n        summaryData.firstReportedAt = summaryData.firstReportedAt.toDate().toISOString();\n      }\n      if (summaryData.lastReportedAt && summaryData.lastReportedAt.toDate) {\n        summaryData.lastReportedAt = summaryData.lastReportedAt.toDate().toISOString();\n      }\n      if (summaryData.createdAt && summaryData.createdAt.toDate) {\n        summaryData.createdAt = summaryData.createdAt.toDate().toISOString();\n      }\n      if (summaryData.updatedAt && summaryData.updatedAt.toDate) {\n        summaryData.updatedAt = summaryData.updatedAt.toDate().toISOString();\n      }\n      if (summaryData.resolvedAt && summaryData.resolvedAt.toDate) {\n        summaryData.resolvedAt = summaryData.resolvedAt.toDate().toISOString();\n      }\n      \n      return summaryData;\n    });\n    \n    return NextResponse.json({\n      success: true,\n      data: summaries,\n      count: summaries.length,\n    });\n  } catch (error) {\n    console.error('Error fetching grouped reports:', error);\n    \n    if (error.message.includes('Unauthorized') || error.message.includes('Admin access required')) {\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 403 }\n      );\n    }\n    \n    // Handle Firestore index errors (FAILED_PRECONDITION)\n    if (error.code === 9 || error.message.includes('index') || error.message.includes('FAILED_PRECONDITION')) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Firestore indexes are still building. Please wait a few minutes and try again. If the issue persists, check Firebase Console for index status.',\n          indexError: true\n        },\n        { status: 503 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to fetch grouped reports' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":6837,"size_tokens":null},"src/components/admin/GroupedReportsTable.js":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport {\n  formatReportReason,\n  getReportStatusColor,\n  formatTimestamp,\n  getModerationStatusColor,\n} from \"@/utils/admin/adminHelpers\";\n\nexport default function GroupedReportsTable({\n  summaries,\n  loading,\n  onSelectSummary,\n  onRefresh,\n}) {\n  const [expandedId, setExpandedId] = useState(null);\n\n  const toggleExpand = (summaryId) => {\n    setExpandedId(expandedId === summaryId ? null : summaryId);\n  };\n\n  const getReasonPercentage = (count, total) => {\n    if (total === 0) return 0;\n    return Math.round((count / total) * 100);\n  };\n\n  if (loading) {\n    return (\n      <div className=\"bg-white rounded-lg shadow\">\n        <div className=\"p-8 text-center\">\n          <div className=\"inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600\"></div>\n          <p className=\"mt-2 text-gray-600\">Loading reports...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (summaries.length === 0) {\n    return (\n      <div className=\"bg-white rounded-lg shadow\">\n        <div className=\"p-8 text-center\">\n          <svg\n            className=\"mx-auto h-12 w-12 text-gray-400\"\n            fill=\"none\"\n            stroke=\"currentColor\"\n            viewBox=\"0 0 24 24\"\n          >\n            <path\n              strokeLinecap=\"round\"\n              strokeLinejoin=\"round\"\n              strokeWidth={2}\n              d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"\n            />\n          </svg>\n          <h3 className=\"mt-2 text-sm font-medium text-gray-900\">\n            No reports found\n          </h3>\n          <p className=\"mt-1 text-sm text-gray-500\">\n            No reports match your current filters.\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"bg-white rounded-lg shadow overflow-hidden\">\n      <div className=\"overflow-x-auto\">\n        <table className=\"min-w-full divide-y divide-gray-200\">\n          <thead className=\"bg-gray-50\">\n            <tr>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Reported Item\n              </th>\n              <th className=\"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Reports\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Status\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Last Reported\n              </th>\n              <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Actions\n              </th>\n            </tr>\n          </thead>\n          <tbody className=\"bg-white divide-y divide-gray-200\">\n            {summaries.map((summary) => (\n              <>\n                <tr key={summary.id} className=\"hover:bg-gray-50\">\n                  <td className=\"px-6 py-4 whitespace-nowrap\">\n                    <div className=\"flex items-center\">\n                      <div className=\"h-12 w-12 flex-shrink-0\">\n                        {summary.targetType === \"user\" ? (\n                          summary.profileImage ? (\n                            <img\n                              className=\"h-12 w-12 rounded-full object-cover\"\n                              src={summary.profileImage}\n                              alt={summary.displayName || \"User\"}\n                              loading=\"lazy\"\n                            />\n                          ) : (\n                            <div className=\"h-12 w-12 rounded-full bg-emerald-500 flex items-center justify-center\">\n                              <span className=\"text-white text-lg font-medium\">\n                                {summary.displayName\n                                  ?.charAt(0)\n                                  ?.toUpperCase() || \"U\"}\n                              </span>\n                            </div>\n                          )\n                        ) : summary.campaignImage ? (\n                          <img\n                            className=\"h-12 w-12 rounded object-cover\"\n                            src={summary.campaignImage}\n                            alt={summary.campaignTitle || \"Campaign\"}\n                            loading=\"lazy\"\n                          />\n                        ) : (\n                          <div className=\"h-12 w-12 rounded bg-gray-200 flex items-center justify-center\">\n                            <svg\n                              className=\"h-6 w-6 text-gray-400\"\n                              fill=\"none\"\n                              stroke=\"currentColor\"\n                              viewBox=\"0 0 24 24\"\n                            >\n                              <path\n                                strokeLinecap=\"round\"\n                                strokeLinejoin=\"round\"\n                                strokeWidth={2}\n                                d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\"\n                              />\n                            </svg>\n                          </div>\n                        )}\n                      </div>\n                      <div className=\"ml-4\">\n                        {summary.targetType === \"user\" ? (\n                          <>\n                            <div className=\"text-sm font-medium text-gray-900\">\n                              {summary.displayName || \"Unknown User\"}\n                            </div>\n                            <div className=\"text-sm text-gray-500\">\n                              @{summary.username || \"unknown\"}\n                            </div>\n                          </>\n                        ) : (\n                          <>\n                            <div className=\"text-sm font-medium text-gray-900\">\n                              {summary.campaignTitle || \"Unknown Campaign\"}\n                            </div>\n                            <div className=\"text-sm text-gray-500\">\n                              by {summary.creator?.displayName || \"Unknown\"}\n                            </div>\n                          </>\n                        )}\n                      </div>\n                    </div>\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap\">\n                    <div className=\"flex items-center justify-center\">\n                      <span className=\"text-2xl font-bold text-red-600\">\n                        {summary.reportsCount || 0}\n                      </span>\n                    </div>\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap\">\n                    <span\n                      className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getModerationStatusColor(summary.targetType === 'user' ? summary.accountStatus : summary.moderationStatus)}`}\n                    >\n                      {summary.targetType === 'user' ? (summary.accountStatus || \"active\") : (summary.moderationStatus || \"active\")}\n                    </span>\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-500\">\n                    {formatTimestamp(summary.lastReportedAt, true)}\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-sm font-medium\">\n                    <div className=\"flex items-center gap-2\">\n                      <button\n                        onClick={() => toggleExpand(summary.id)}\n                        className=\"px-3 py-1.5 text-sm font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors cursor-pointer\"\n                      >\n                        {expandedId === summary.id\n                          ? \"Hide Breakdown\"\n                          : \"View Breakdown\"}\n                      </button>\n                      <button\n                        onClick={() => onSelectSummary(summary)}\n                        className=\"px-3 py-1.5 text-sm font-medium text-emerald-700 bg-emerald-50 hover:bg-emerald-100 rounded-lg transition-colors cursor-pointer\"\n                      >\n                        Take Action\n                      </button>\n                    </div>\n                  </td>\n                </tr>\n\n                {expandedId === summary.id && (\n                  <tr>\n                    <td colSpan=\"5\" className=\"px-6 py-4 bg-gray-50\">\n                      <div className=\"space-y-3\">\n                        <h4 className=\"font-semibold text-gray-900\">\n                          Report Breakdown\n                        </h4>\n\n                        {summary.reasonCounts &&\n                        Object.keys(summary.reasonCounts).length > 0 ? (\n                          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\n                            {Object.entries(summary.reasonCounts)\n                              .sort(([, a], [, b]) => b - a)\n                              .map(([reason, count]) => {\n                                const percentage = getReasonPercentage(\n                                  count,\n                                  summary.reportsCount,\n                                );\n                                return (\n                                  <div\n                                    key={reason}\n                                    className=\"bg-white p-3 rounded border border-gray-200\"\n                                  >\n                                    <div className=\"flex justify-between items-center mb-1\">\n                                      <span className=\"text-sm font-medium text-gray-900\">\n                                        {formatReportReason(reason)}\n                                      </span>\n                                      <span className=\"text-sm font-bold text-gray-700\">\n                                        {count} ({percentage}%)\n                                      </span>\n                                    </div>\n                                    <div className=\"w-full bg-gray-200 rounded-full h-2\">\n                                      <div\n                                        className=\"bg-red-500 h-2 rounded-full transition-all\"\n                                        style={{ width: `${percentage}%` }}\n                                      />\n                                    </div>\n                                  </div>\n                                );\n                              })}\n                          </div>\n                        ) : (\n                          <p className=\"text-sm text-gray-500\">\n                            No reason breakdown available\n                          </p>\n                        )}\n\n                        <div className=\"text-xs text-gray-500 mt-3 pt-3 border-t border-gray-200\">\n                          <div>\n                            First Report:{\" \"}\n                            {formatTimestamp(summary.firstReportedAt, true)}\n                          </div>\n                          <div>\n                            Latest Report:{\" \"}\n                            {formatTimestamp(summary.lastReportedAt, true)}\n                          </div>\n                        </div>\n                      </div>\n                    </td>\n                  </tr>\n                )}\n              </>\n            ))}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":11781,"size_tokens":null},"src/app/api/admin/reports/details/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\n\nexport async function GET(request) {\n  try {\n    await requireAdmin(request);\n    \n    const { searchParams } = new URL(request.url);\n    const targetId = searchParams.get('targetId');\n    const targetType = searchParams.get('targetType');\n    \n    if (!targetId || !targetType) {\n      return NextResponse.json(\n        { success: false, error: 'Target ID and type are required' },\n        { status: 400 }\n      );\n    }\n    \n    const db = adminFirestore();\n    let reportsQuery = db.collection('reports');\n    \n    // Filter by target type and ID\n    if (targetType === 'campaign') {\n      reportsQuery = reportsQuery.where('campaignId', '==', targetId);\n    } else if (targetType === 'user') {\n      reportsQuery = reportsQuery.where('reportedUserId', '==', targetId);\n    }\n    \n    // Order by creation date (newest first)\n    reportsQuery = reportsQuery.orderBy('createdAt', 'desc');\n    \n    const reportsSnapshot = await reportsQuery.get();\n    \n    const reports = [];\n    \n    for (const doc of reportsSnapshot.docs) {\n      const reportData = { id: doc.id, ...doc.data() };\n      \n      // Add reporter info if not anonymous\n      if (reportData.reportedBy && reportData.reportedBy !== 'anonymous') {\n        const reporterDoc = await db.collection('users').doc(reportData.reportedBy).get();\n        if (reporterDoc.exists) {\n          const reporterData = reporterDoc.data();\n          reportData.reporter = {\n            uid: reporterDoc.id,\n            displayName: reporterData.displayName,\n            username: reporterData.username,\n          };\n        }\n      }\n      \n      // Convert Firestore timestamps to ISO strings\n      if (reportData.createdAt && reportData.createdAt.toDate) {\n        reportData.createdAt = reportData.createdAt.toDate().toISOString();\n      }\n      if (reportData.reviewedAt && reportData.reviewedAt.toDate) {\n        reportData.reviewedAt = reportData.reviewedAt.toDate().toISOString();\n      }\n      \n      reports.push(reportData);\n    }\n    \n    return NextResponse.json({\n      success: true,\n      data: reports,\n      count: reports.length,\n    });\n  } catch (error) {\n    console.error('Error fetching report details:', error);\n    \n    if (error.message.includes('Unauthorized') || error.message.includes('Admin access required')) {\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 403 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to fetch report details' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":2703,"size_tokens":null},"REPORT_SYSTEM.md":{"content":"# Twibbonize Reporting System\n\n**Last Updated:** October 31, 2025\n\n## Overview\nThe Twibbonize reporting system allows users to report inappropriate campaigns or user profiles. The system is designed to be efficient, reducing database operations by 95% through an optimized aggregation approach. This document explains how the system works in simple, non-technical terms.\n\n---\n\n## How Users Report Content\n\n### Reporting a Campaign\n1. **User clicks \"Report\" button** on a campaign page\n2. **Selects a reason** from dropdown (required):\n   - **Inappropriate Content** (API value: `inappropriate`)\n   - **Spam** (API value: `spam`)\n   - **Copyright Violation** (API value: `copyright`)\n   - **Other** (API value: `other`)\n3. **Submits the report** (no text field needed - just reason selection)\n\n**API Endpoint:** `POST /api/reports/submit`  \n**Required Fields:** `campaignId` (string), `reason` (one of the API values above)  \n**Optional Fields:** `reportedBy` (user ID or 'anonymous'), `campaignSlug` (string)\n\n### Reporting a User Profile\n1. **User clicks \"Report\" button** on a user's profile page\n2. **Selects a reason** from dropdown (required):\n   - **Inappropriate Profile Picture** (API value: `inappropriate_avatar`)\n   - **Offensive Username** (API value: `offensive_username`)\n   - **Spam in Bio/Description** (API value: `spam_bio`)\n   - **Impersonation** (API value: `impersonation`)\n   - **Other** (API value: `other`)\n3. **Submits the report**\n\n**API Endpoint:** `POST /api/reports/user`  \n**Required Fields:** `reportedUserId` (string), `reason` (one of the API values above)  \n**Optional Fields:** `reportedBy` (user ID or 'anonymous'), `reportedUsername` (string)\n\n**Rate Limiting:**\n- Maximum 5 reports per hour from the same IP address\n- Cannot report the same target twice from the same IP address\n- Returns error message if limit exceeded: \"You have submitted too many reports. Please try again later.\"\n- IP addresses are hashed for privacy before storage\n\n---\n\n## What Happens After a Report is Submitted\n\n### For Campaigns:\n1. **Report is counted** - The campaign's report count increases by 1\n2. **Reason is tracked** - The specific reason (spam, inappropriate, etc.) is recorded in the report summary\n3. **Two synchronized counters updated:**\n   - Campaign document: `reportsCount` field increments\n   - Report Summary document: `reasonCounts` object increments the specific reason count\n   - **Both counters always stay synchronized** - they increment together and reset together\n4. **Auto-flag based on report count:**\n   - **1-2 reports**: Status changes to `under-review` (flagged for review but still visible to public)\n     - **Creator receives notification**: \" Campaign Under Review - Your campaign has been flagged by users\"\n   - **3+ reports**: Status changes to `under-review-hidden` (hidden from public)\n     - Hidden timestamp recorded\n     - **Creator receives notification**: \" Campaign Hidden - Your campaign has been auto-hidden due to multiple reports\"\n5. **No reports** - Campaign stays in `active` status, fully visible\n\n### For User Profiles:\n1. **Report is counted** - The user's report count increases by 1\n2. **Reason is tracked** - The specific reason is recorded\n3. **Two synchronized counters updated:**\n   - User document: `reportsCount` field increments\n   - Report Summary document: `reasonCounts` object increments the specific reason count\n   - **Both counters always stay synchronized** - they increment together and reset together\n4. **Auto-flag based on report count:**\n   - **1-9 reports**: Account status changes to `under-review` (flagged for review but profile still visible)\n     - **User receives notification**: \" Profile Under Review - Your profile has been flagged by users\"\n   - **10+ reports**: Account status changes to `under-review-hidden` (profile hidden from public)\n     - Hidden timestamp recorded\n     - **User receives notification**: \" Profile Hidden - Your profile has been auto-hidden due to multiple reports\"\n5. **No reports** - User stays in `active` status, profile fully visible\n\n**Counter Synchronization (Fixed October 22, 2025):**\n- When a new report comes in AFTER admin has reviewed previous reports (status was 'resolved' or 'dismissed'), the system:\n  - Resets BOTH the Report Summary counter AND the campaign/user counter to 1 (starting fresh)\n  - Both counters increment together as new reports arrive\n  - Both counters reset to 0 together when admin takes action (dismiss/warn/remove)\n  - No temporary mismatches - counters are always synchronized\n\n---\n\n## Report Aggregation System\n\n### How It Works:\nInstead of storing each individual report as a separate document, the system groups all reports for the same campaign/user into a single **Report Summary** document. This dramatically reduces database operations.\n\n**What's Stored in Report Summary:**\n- **targetId** - ID of reported campaign or user\n- **targetType** - Either \"campaign\" or \"user\"\n- **Total report count** (e.g., 15 reports)\n- **Reason breakdown with counts** (e.g., `{ spam: 8, inappropriate: 5, copyright: 2 }`)\n- **Status** - `pending`, `resolved`, or `dismissed`\n- **Timestamps** - `firstReportedAt`, `lastReportedAt`, `createdAt`, `updatedAt`\n- **Cached display info** - Campaign title/image or user's name/profile picture for quick display\n\n**Why This Matters:**\n- Saves 95% of database operations\n- Faster for admins to review\n- Cheaper to run at scale\n- No need to fetch hundreds of individual reports\n- Admin sees percentage breakdown instantly (e.g., \"53% spam, 33% inappropriate, 13% copyright\")\n\n**Performance Comparison:**\n\nBefore optimization (individual reports):\n- Report submission: 3 writes per report\n- Admin dismiss (100 reports): 102 reads + 103 writes\n\nAfter optimization (aggregated summaries):\n- Report submission: 2 writes per report (33% reduction)\n- Admin dismiss (any number): 2 reads + 3 writes (98% reduction)\n\n---\n\n## Admin Dashboard (/admin/reports)\n\n### How Admins Access Reports\n\nAdmins visit `/admin/reports` and see a control panel with filters:\n\n#### Filter Options:\n\n1. **Report Type**\n   - **All Types** - Shows both campaigns and users\n   - **Campaign** - Shows only reported campaigns\n   - **User** - Shows only reported user profiles\n\n2. **Status**\n   - **All** - Shows all reports regardless of status\n   - **Pending** - Reports that haven't been reviewed yet (default)\n   - **Resolved** - Reports where admin took action (warned/removed)\n   - **Dismissed** - Reports where admin found no issue\n\n3. **Sort By**\n   - **Most Recent** (lastReportedAt) - Shows newest reports first\n   - **Top Reported** (reportsCount) - Shows items with most reports first (default)\n   - **Oldest Pending** (firstReportedAt) - Shows oldest unresolved reports first\n\n4. **Number of Reports**\n   - Choose how many to load (1-100, default: 10)\n\n5. **Load Button**\n   - Click to fetch reports with selected filters\n   - Does NOT auto-load on page open (admin must click \"Load\")\n\n**Performance Note:**\nWhen loading reports, the system fetches live status from each campaign/user document to ensure displayed information is current. This means if you load 100 reports, the system makes 100-300 database reads to show accurate data. This could be optimized with batch fetching or short-term caching.\n\n---\n\n## Report Table Display\n\nEach row in the table shows:\n\n### Campaign Reports:\n- **Campaign thumbnail** (small preview image)\n- **Campaign title** (clickable)\n- **Creator name** and profile picture\n- **Total report count** (big red number badge)\n- **Current moderation status** badge (active, hidden, removed-temporary, etc.)\n- **Last reported date/time**\n- **Action buttons:**\n  - \"View Breakdown\" - Expands to show reason distribution\n  - \"Take Action\" - Opens detailed panel with admin actions\n\n### User Reports:\n- **Profile picture** (or initials if no picture)\n- **User's display name** (clickable)\n- **Username** (@username)\n- **Total report count** (big red number badge)\n- **Current account status** badge (active, hidden, banned-temporary, etc.)\n- **Last reported date/time**\n- **Action buttons:**\n  - \"View Breakdown\" - Expands to show reason distribution\n  - \"Take Action\" - Opens detailed panel with admin actions\n\n---\n\n## Viewing Report Details\n\n### View Breakdown Button\nWhen clicked, the row expands to show:\n- **Reason distribution** (visual breakdown)\n- Each reason with:\n  - Count (e.g., \"Spam: 8\")\n  - Percentage (e.g., \"53%\")\n  - Visual progress bar showing proportion\n- **First report date** - When first report was received\n- **Latest report date** - When most recent report was received\n\n**Example:**\n```\nReport Breakdown\n\nSpam: 8 (53%)          [] \nInappropriate: 5 (33%) []\nCopyright: 2 (13%)     []\n\nFirst Report: Jan 15, 2025 2:30 PM\nLatest Report: Jan 18, 2025 9:45 AM\n```\n\n### Take Action Button\nOpens a **detailed side panel** showing:\n\n#### For Campaigns:\n- Campaign image (full size preview)\n- Campaign title and type (Frame/Background)\n- Current moderation status with color-coded badge\n- Creator information (name, profile picture, username)\n- Total reports count with reason breakdown\n- Campaign slug (URL identifier)\n- Timestamps (created, first reported, last reported)\n\n#### For Users:\n- Profile picture (full size)\n- Display name and username\n- Current account status with color-coded badge\n- Current moderation status\n- Total reports count with reason breakdown\n- Link to view full profile page\n- Timestamps (account created, first reported, last reported)\n\n---\n\n## Admin Actions\n\nWhen admin clicks \"Take Action\" in the side panel, they see **3 action buttons** with multi-step confirmation to prevent accidents:\n\n### Safety Features (October 22, 2025)\n\nAll dangerous admin actions now require **typing \"CONFIRM\"** to proceed:\n-  **Ban User** - Requires typing \"CONFIRM\"\n-  **Remove Campaign** - Requires typing \"CONFIRM\"  \n-  **Warn User/Creator** - Requires typing \"CONFIRM\"\n-  **Dismiss Report** - Simple click confirmation (restoring content is low-risk)\n-  **Unban User** - Simple click confirmation (restoring access is low-risk)\n\n**How it works:**\n1. Admin fills in required information (reason, ban type, etc.)\n2. Clicks \"Continue\" to proceed\n3. A confirmation modal appears requiring them to type \"CONFIRM\" (exact match, case-sensitive)\n4. The confirm button is disabled until \"CONFIRM\" is typed correctly\n5. Clicking \"Cancel\" or outside the modal safely cancels the action\n\n**Why this matters:**\n- Prevents accidental clicks on destructive actions\n- Gives admins a moment to reconsider\n- Reduces stress and mistakes\n- Only adds 2-3 seconds to legitimate actions\n\n---\n\n### 1. Dismiss Report (Secondary Button - Gray)\n\n**Step 1: Click \"Dismiss Report\"**\n- Shows simple confirmation modal (no typing required)\n\n**Step 2: Confirm Dismissal**\n- Admin confirms they want to dismiss (one click)\n\n**What it does:**\n- Marks report summary status as \"dismissed\"\n- Resets ALL report counts to 0:\n  - Campaign/User `reportsCount`  0\n  - Report Summary `reportsCount`  0\n  - Report Summary `reasonCounts`  {} (empty)\n- Restores content to \"active\" status:\n  - Campaigns: `moderationStatus`  \"active\"\n  - Users: `accountStatus`  \"active\"\n- Removes hidden timestamps\n- Removes ban-related fields\n\n**Notification sent?**\n-  **YES** - If campaign/user was auto-hidden (at 3+ reports for campaigns, 10+ for users)\n  - **Campaign**: \" Campaign Restored - Good news! Your campaign has been reviewed and restored\"\n  - **User**: \" Profile Restored - Good news! Your profile has been reviewed and restored\"\n-  **NO** - If content was never hidden (below threshold)\n\n**Use when:** Reports are false/spam, or content doesn't violate rules\n\n---\n\n### 2. Warn User/Creator (Warning Button - Yellow)\n\n**Step 1: Click \"Warn User\" or \"Warn Creator\"**\n- Shows reason selection modal with dropdown\n- Admin MUST select a reason:\n  - Inappropriate content\n  - Spam\n  - Harassment\n  - Misinformation\n  - Copyright violation\n  - Other\n\n**Step 2: Click \"Continue\"**\n- \"Continue\" button disabled until reason selected\n- Proceeds to typed confirmation\n\n**Step 3: Type \"CONFIRM\" to Proceed**\n- Confirmation modal appears showing the warning details\n- Admin must type \"CONFIRM\" (case-sensitive, exact match)\n- Confirm button stays disabled until correctly typed\n- Can click \"Go Back\" to edit the reason\n\n**What it does:**\n- Creates warning record in `warnings` collection with:\n  - Selected reason from admin\n  - User ID who received warning\n  - Target type (campaign or user)\n  - Target ID\n  - Admin ID, email, and name (from authenticated admin)\n  - Timestamp\n  - Acknowledged status (false)\n- **Restores content to active status** (this is intentional - warning is not removal):\n  - Campaigns: `moderationStatus`  \"active\"  \n  - Users: `accountStatus`  \"active\"\n- Resets all report counts to 0\n- Removes hidden timestamps\n- Removes ban-related fields\n\n**Rationale for restoration:**\nWarning is a \"slap on the wrist\" - admin reviewed and decided content is not severe enough for removal. If content deserves to stay hidden, admin should use \"Ban User/Remove Campaign\" instead. Users should be able to see their content after being warned.\n\n**Notification sent:**  **ALWAYS**\n- **Message**: \" Warning Issued - You've received a warning for: [admin-selected reason]. Please review our community guidelines.\"\n- The notification includes the specific reason the admin selected from the dropdown\n\n**Use when:** Content is borderline/minor issue - you want to warn the creator but allow content to remain visible\n\n**Note:** Warning does NOT auto-ban users. Admin must manually decide actions based on warning history. Future enhancement needed: Admin warning history view (currently deferred).\n\n---\n\n### 3. Ban User / Remove Campaign (Danger Button - Red)\n\n**Step 1: Click \"Ban User\" or \"Remove Campaign\"**\n- Shows reason selection modal with dropdown\n- Admin MUST select a reason:\n  - Inappropriate content\n  - Spam\n  - Harassment\n  - Misinformation\n  - Copyright violation\n  - Other\n\n**Step 2: Click \"Continue\"**\n- \"Continue\" button disabled until reason selected\n- Proceeds to typed confirmation\n\n**Step 3: Type \"CONFIRM\" to Proceed**\n- Confirmation modal appears showing:\n  - Selected reason\n  - Ban type (temporary vs permanent, if banning user)\n  - Appeal deadline (if applicable)\n  - Clear warning about consequences\n- Admin must type \"CONFIRM\" (case-sensitive, exact match)\n- Confirm button stays disabled until correctly typed\n- Can click \"Go Back\" to edit inputs\n\n**What it does:**\n\n**For Campaigns:**\n- Sets `moderationStatus` to `removed-temporary`\n- Content stays hidden from public\n- Sets 30-day appeal deadline (calculated: current date + 30 days)\n- Stores admin-selected reason in `banReason` field\n- Stores `bannedAt` timestamp\n- Sets `appealCount` to 0\n- Resets `reportsCount` to 0\n- **After 30 days:**  Auto-upgrades to permanent status via Vercel Cron Job (runs daily at 2:00 AM)\n- **Second removal:** Admin can manually set to `removed-permanent` (no recovery)\n\n**For Users:**\n- Sets `accountStatus` to `banned-temporary`\n- Profile hidden from public\n- Hides all their campaigns from public\n- Sets 30-day appeal deadline\n- Stores admin-selected reason in `banReason` field\n- Stores `bannedAt` timestamp\n- Resets `reportsCount` to 0\n- **After 30 days:**  Auto-upgrades to permanent ban via Vercel Cron Job (runs daily at 2:00 AM), sends email notification\n\n**Notification sent:**  **ALWAYS**\n- **Campaign**: \" Campaign Removed - Your campaign has been removed for: [reason]. You can appeal this decision until [date].\"\n- **User**: \" Account Banned - Your account has been banned for: [reason]. You can appeal until [date].\"\n- Notifications now include both:\n  - The specific reason admin selected from dropdown\n  - The exact appeal deadline date (formatted as \"February 20, 2025\")\n\n**Use when:** Content clearly violates rules and needs removal\n\n---\n\n## Appeal System\n\n### How Appeals Work\n\nWhen a campaign is removed or a user is banned temporarily, they have **30 days** to appeal the decision. Here's the complete flow:\n\n#### For Users to Submit an Appeal:\n\n1. **User receives notification**\n   - Campaign removed: \" Campaign Removed - Your campaign has been removed for: [reason]. You can appeal this decision until [date].\"\n   - Account banned: \" Account Banned - Your account has been banned for: [reason]. You can appeal until [date].\"\n   - Notification includes exact appeal deadline (e.g., \"February 20, 2025\")\n\n2. **User visits appeals page** (`/profile/appeals`)\n   - Shows all removed campaigns and banned accounts eligible for appeal\n   - Displays appeal deadline for each item\n   - Only shows items with active appeal window (within 30 days)\n   - One appeal allowed per item\n\n3. **User selects item and submits appeal**\n   - Writes appeal reason (minimum 20 characters required)\n   - Explains why they believe the removal/ban was unfair\n   - Submits appeal for admin review\n   - Receives confirmation: \" Appeal Submitted - Your appeal has been submitted and is under review. You will be notified of the outcome.\"\n\n4. **Appeal is tracked**\n   - Appeal status set to `pending`\n   - `appealCount` increments on the campaign (tracks multiple appeals if previous ones were rejected)\n   - Appeal stored in `appeals` collection with: userId, type, targetId, reason, status, submittedAt\n\n#### For Admins to Review Appeals:\n\n5. **Admin visits appeals dashboard** (`/admin/appeals`)\n   - Filter by:\n     - **Status**: All, Pending, Approved, Rejected\n     - **Type**: All, Campaign, Account\n     - **Limit**: 10, 25, 50, 100\n   - Table shows:\n     - User info (profile picture, username, display name)\n     - Appeal type (Campaign or Account)\n     - Target details (campaign title/image or account info)\n     - Original removal/ban reason\n     - User's appeal reason\n     - Submission date\n\n6. **Admin reviews and decides**\n   - Click \"Approve\" or \"Reject\" button\n   - Modal appears with:\n     - Full appeal details\n     - Option to add admin notes (optional)\n     - Warning about consequences\n     - Type \"CONFIRM\" requirement (prevents accidental clicks)\n\n7. **Admin approves appeal**\n   - **For campaigns:**\n     - `moderationStatus`  `active` (campaign restored)\n     - Clears all removal-related fields (`bannedAt`, `banReason`, `appealDeadline`)\n     - Notification sent: \" Appeal Approved - Your appeal for campaign '[title]' has been approved and your campaign has been restored.\"\n   - **For accounts:**\n     - `accountStatus`  `active` (account restored)\n     - Clears ban-related fields\n     - Notification sent: \" Appeal Approved - Your appeal has been approved and your account has been restored. Welcome back!\"\n   - Appeal status  `approved`\n   - Admin action logged for audit trail\n\n8. **Admin rejects appeal**\n   - **For campaigns:**\n     - `moderationStatus`  `removed-permanent` (no more appeals allowed)\n     - Clears `appealDeadline` (permanent removal)\n     - Notification sent: \" Appeal Rejected - Your appeal for campaign '[title]' has been reviewed and rejected. The removal is now permanent.\"\n   - **For accounts:**\n     - `accountStatus`  `banned-permanent` (permanent ban)\n     - Clears `appealDeadline`\n     - Notification sent: \" Appeal Rejected - Your appeal has been reviewed and rejected. Your account ban is now permanent.\"\n   - Appeal status  `rejected`\n   - Admin action logged\n\n### Appeal System Rules:\n\n-  **30-day window** - Appeals must be submitted within 30 days of removal/ban\n-  **One appeal per item** - Users cannot submit multiple pending appeals for the same campaign/account\n-  **Minimum 20 characters** - Appeal reason must be at least 20 characters long\n-  **Real-time notifications** - Users notified immediately when appeal is approved/rejected\n-  **Admin confirmation** - All approve/reject actions require typing \"CONFIRM\" to prevent accidents\n-  **Audit trail** - All appeals and admin decisions are logged\n\n### Appeal Deadline Expiration:\n\n** FULLY IMPLEMENTED (October 26, 2025):**\n\n**Automatic Cleanup (Vercel Cron Job):**\n- **Runs daily at 2:00 AM UTC** via `/api/cron/cleanup-expired-appeals`\n- Automatic upgrade to permanent status after deadline passes\n- Campaigns: `removed-temporary`  `removed-permanent`\n- Users: `banned-temporary`  `banned-permanent`\n- **Sends in-app notification** for permanently removed campaigns (users can still log in)\n- **Sends email notification** for permanent bans (users cannot log in to see in-app)\n- All actions logged to `adminLogs` collection for audit trail\n\n**Appeal Deadline Reminders (Vercel Cron Job):**\n- **Runs daily at 10:00 AM UTC** via `/api/cron/send-appeal-reminders`\n- Sends reminders at 7, 3, and 1 day(s) before deadline expires\n- **Notification delivery varies by type:**\n  - **Campaign removals:** BOTH in-app + email reminders sent (creators can still log in)\n  - **Account bans:** Email reminders ONLY (banned users cannot log in to see in-app)\n- Includes countdown timer, removal reason, and direct appeal link\n- Prevents users from missing their appeal window\n\n**Vercel Cron Job Configuration:**\n- Secured with `CRON_SECRET` environment variable\n- Free tier limit: 2 cron jobs (both slots used)\n- Monitored via Vercel function logs and admin logs dashboard\n\n---\n\n## Status Meanings\n\n### Report Summary Statuses:\n- **pending** - Waiting for admin review (new reports)\n- **resolved** - Admin took action (warned or removed/banned)\n- **dismissed** - Admin found no issue and cleared the reports\n\n**Status Transitions:**\n- When new report comes in on previously `resolved`/`dismissed` target  Status resets to `pending`\n- When admin takes action  Status changes to `resolved` (for warn/remove) or `dismissed` (for dismiss)\n\n### Moderation Statuses (For Campaigns):\n- **active** - Visible to public, no issues\n- **under-review** - 1-2 reports received, still visible but flagged for admin review\n- **under-review-hidden** - Hidden due to 3+ reports, awaiting admin review\n- **removed-temporary** - Campaign removed by admin, 30-day appeal window\n- **removed-permanent** - Campaign permanently deleted (second offense or severe violation)\n- **deleted** - Campaign deleted by creator (only appears in reportSummary for tracking)\n\n### Account Statuses (For Users):\n- **active** - Profile visible, account accessible, no issues\n- **under-review** - 1-9 reports received, profile still visible but flagged for admin review\n- **under-review-hidden** - Profile hidden due to 10+ reports, awaiting admin review\n- **banned-temporary** - User banned by admin, 30-day appeal window, cannot login\n- **banned-permanent** - User permanently banned (severe violations), all data deleted\n\n**Clear Distinction:**\n- **Campaigns** use `moderationStatus` - Controls content visibility and moderation state\n- **Users** use `accountStatus` - Controls account access and ban state\n- This prevents field conflicts and ensures consistent enforcement\n\n---\n\n## Automatic Behavior\n\n### When New Reports Come In After Admin Action:\n\n1. **If admin previously dismissed or resolved:**\n   - Report summary status resets to `pending`\n   - **Counter behavior (synchronized):**\n     - **Both Report Summary AND Campaign/User counters reset to 1** (starting fresh to track \"new wave\" of reports)\n     - Counters stay synchronized and increment together as new reports arrive\n     - Fixed October 22, 2025 - no more temporary mismatches\n   - All reason counts in summary reset to track new pattern\n   - New reports trigger auto-hide thresholds again\n\n2. **Auto-hide triggers again:**\n   - Campaign: Hidden at 3rd report (if status is `active`)\n   - User: Hidden at 10th report (if status is `active`)\n   - Notification sent again to creator/user\n   - **Note:** Only triggers if current status is `active` - intentional design to require manual admin review for previously-reviewed content\n\n### Report Summary Retention:\n- **Report summaries are kept forever** (not deleted after admin action)\n- Status changes to `dismissed` or `resolved` but document remains\n- This allows tracking:\n  - Repeat offenders\n  - Historical patterns\n  - Audit trail for moderation decisions\n  - Analysis of which violations are most common\n\n**Important:** Reason counts are reset to empty `{}` when admin takes action. Historical reason data is lost. See CODE_INCONSISTENCIES.md #10 for improvement suggestion to preserve this data.\n\n### Campaign Deletion by Creator:\nWhen a campaign creator deletes their own campaign:\n\n1. **Campaign document deleted:**\n   - Removed from Firestore `campaigns` collection\n   - Associated image deleted from Supabase storage\n   - Creator's `campaignsCount` decreased by 1\n\n2. **Report Summary updated (NOT deleted):**\n   - Status changed to `dismissed`\n   - `reportsCount` reset to 0\n   - `reasonCounts` reset to empty object `{}`\n   - `moderationStatus` set to `deleted`\n   - `deletionNote` added: \"Campaign deleted by creator\"\n   - **Summary kept for audit trail**\n\n3. **Admin dashboard behavior:**\n   - Deleted campaign reports don't appear in pending queue (status is `dismissed`)\n   - If admin filters by \"all\" or \"dismissed\" status, they may see historical data\n   - Report summaries show `targetDeleted: true` flag when target no longer exists\n   - Prevents admins from wasting time on non-existent content\n\n4. **Notifications:**\n   - No notification sent to creator (they initiated the deletion)\n   - API returns count of auto-dismissed reports in response\n\n**API Endpoint:** `DELETE /api/campaigns/[campaignId]`\n**Authorization:** Only campaign owner (creatorId match required)\n**UI Location:** Profile page > Campaign menu (3-dot button) > \"Delete Campaign\"\n**Confirmation:** Required before deletion proceeds\n\n---\n\n## Notification System\n\nThe system uses **hybrid notifications** - combining in-app and email notifications based on user accessibility:\n\n### Notification Types by Delivery Method:\n\n** EMAIL NOTIFICATIONS** (for banned users who cannot access their account):\n- **User bans**  \" Your Account Has Been Suspended\"\n  - Sent via MailerSend to user's email address\n  - Includes ban reason and appeal deadline\n  - Works for both temporary and permanent bans\n  - **Why email:** Banned users are immediately signed out and cannot access in-app notifications\n\n- **User unbans**  \" Your Account Has Been Restored\"\n  - Sent via MailerSend to user's email address\n  - Notifies user their account is restored\n  - **Why email:** Previously, unbanned users had no notification at all - they discovered it by accident\n\n** IN-APP NOTIFICATIONS** (Firestore-based, no browser permissions needed):\n- **Campaign reaches 3 reports**  \" Campaign Under Review\"\n- **User profile reaches 10 reports**  \" Profile Under Review\"\n- **Admin dismisses reports**  \" Campaign/Profile Restored\"\n- **Admin issues warning**  \" Warning Issued\"\n- **Campaign removals**  \" Campaign Removed\" (user can still log in)\n\n### When Notifications Are Sent:\n\n1. **Campaign reaches 3 reports**  In-app notification\n   - Triggered automatically when 3rd report submitted\n   - Only if current status is `active`\n\n2. **User profile reaches 10 reports**  In-app notification\n   - Triggered automatically when 10th report submitted\n   - Only if current status is `active`\n\n3. **Admin dismisses reports**  In-app notification\n   - Only sent if content was previously hidden (at threshold)\n   - Not sent if content was never auto-hidden\n\n4. **Admin issues warning**  In-app notification\n   - Always sent\n   - Includes admin-selected reason\n\n5. **Admin removes campaign**  In-app notification\n   - Sent to creator (who can still access their account)\n   - Includes admin-selected reason and appeal deadline\n   - **Note:** Promises appeal system that doesn't exist yet\n\n6. **Admin bans user**  EMAIL notification \n   - Sent to user's email address (bypasses account lockout)\n   - Includes ban reason and appeal deadline\n   - **Critical:** User cannot access account, so email is the only way to reach them\n\n7. **Admin unbans user**  EMAIL notification \n   - Sent to user's email address\n   - Notifies account restoration\n   - **Important:** Builds trust by informing users of positive moderation decisions\n\n8. **Appeal deadline reminders**  PLANNED (not implemented)\n   - Requires cron job\n   - Would notify 7 days, 3 days, and 1 day before deadline\n\n### In-App Notification Delivery:\n- Saved to Firestore: `users/{userId}/notifications/{notificationId}`\n- Real-time listeners update UI instantly via `useNotifications` hook\n- Shows in notification bell icon in header (with unread count badge)\n- Toast popup appears for new notifications (auto-dismisses after 5 seconds)\n- Full inbox available at `/profile/notifications` with:\n  - Read/unread status toggle\n  - Filter by notification type\n  - Delete individual notifications\n  - Mark all as read\n  - Action buttons (e.g., \"View Campaign\", \"Appeal Removal\")\n\n### Email Notification Delivery:\n- Sent via MailerSend API (`src/utils/notifications/sendEmail.js`)\n- Professional HTML templates (`src/utils/notifications/emailTemplates.js`)\n- Includes ban reason, appeal deadline, and action buttons\n- Free tier: 12,000 emails/month with trial domain\n- Custom domain supported for production\n\n### In-App Notification Structure:\n```javascript\n{\n  id: \"auto-generated-id\",\n  type: \"warning\" | \"campaign_removed\" | \"campaign_under_review\" | etc.,\n  title: \"Notification Title\",\n  body: \"Notification message with details\",\n  actionUrl: \"/profile\" or specific page,\n  icon: \"/icon-192x192.png\",\n  read: false,\n  createdAt: timestamp,\n  metadata: { campaignId, reason, etc. } // Optional additional data\n}\n```\n\n### Email Template Structure:\n```javascript\n{\n  subject: \" Your Account Has Been Suspended\",\n  html: \"<professional HTML email with inline CSS>\",\n  // Includes: ban reason, appeal deadline, action buttons, support contact\n}\n```\n\n---\n\n## Performance Optimizations\n\n### Before Optimization (Individual Reports System):\n- **Report submission**: 3 Firestore writes per report\n  - 1 write to create individual report document\n  - 1 write to update campaign/user reportsCount\n  - 1 write to update creator/user notification\n- **Admin dismiss (100 reports)**: 102 reads + 103 writes\n  - 1 read to fetch campaign/user\n  - 100 reads to fetch all individual reports\n  - 1 write to update campaign/user\n  - 100 writes to update each report status\n  - 1 write for notification\n  - 1 write to update admin action log\n\n### After Optimization (Current Aggregated System):\n- **Report submission**: 2 Firestore writes (33% reduction)\n  - 1 write to update campaign/user reportsCount\n  - 1 write to update/create reportSummary with reason counts\n  - (Notification is optional, not always sent)\n- **Admin dismiss (any number of reports)**: 2 reads + 3 writes (98% reduction)\n  - 1 read to fetch reportSummary\n  - 1 read to fetch campaign/user\n  - 1 write to update campaign/user status\n  - 1 write to update reportSummary status\n  - 1 write to create warning (if warning action)\n  - (Notification write happens after transaction)\n\n### How It's Achieved:\n- Use aggregated `reportSummary` collection instead of individual report documents\n- Store reason counts as objects: `{spam: 8, inappropriate: 5, copyright: 2}`\n- No need to fetch/update hundreds of individual reports\n- Single atomic transaction handles everything\n- Instant admin actions with no query overhead\n\n### Trade-offs:\n- **Pro:** 95% reduction in database operations\n- **Pro:** Faster admin actions (instant instead of seconds)\n- **Pro:** Significant cost savings on Firestore usage\n- **Pro:** Better admin UX with instant reason distribution visibility\n- **Pro:** Batch fetching eliminates N+1 query problem when loading reports\n- **Con:** Can't see individual report details (who reported, when each report came in)\n- **Con:** Reason count history lost when admin takes action\n\n---\n\n## Key Design Principles\n\n1. **Efficiency First** - Minimize database operations for scalability at viral scale\n\n2. **Transparency** - Clear reason breakdowns help admins make informed decisions quickly\n\n3. **User Communication** - Hybrid notification system ensures users are always informed:\n   - **In-app notifications** for accessible accounts (warnings, campaign removals, auto-hides)\n   - **Email notifications** for inaccessible accounts (bans, unbans)\n   - **Critical:** Banned users receive email since they cannot access their account\n\n4. **Audit Trail** - Keep report summaries forever for pattern detection and repeat offender tracking\n\n5. **Fairness** - Appeal windows give users a chance to contest decisions (though not yet implemented)\n\n6. **Automation** - Auto-hide at thresholds reduces admin workload for clear-cut cases\n\n7. **Clear Status Separation** - Campaigns use `moderationStatus`, Users use `accountStatus` to prevent conflicts\n\n8. **Atomic Transactions** - All status updates happen atomically to prevent race conditions and inconsistencies\n\n9. **Rate Limiting** - Prevent report spam and abuse through IP-based limits\n\n10. **Privacy** - IP addresses are hashed (SHA-256) before storage for user privacy\n\n---\n\n## Common Admin Workflows\n\n### Scenario 1: False Reports (Spam Reports)\n1. Admin sets filters: Status = \"Pending\", Sort = \"Top Reported\"\n2. Clicks \"Load\" to fetch reports\n3. Clicks \"Take Action\" on campaign with high report count\n4. Reviews campaign image and details - looks fine, no violations\n5. Clicks \"Dismiss Report\"\n6. Confirms dismissal in modal\n7. System:\n   - Resets all report counts to 0\n   - Restores campaign to `active` status\n   - If campaign was hidden  Creator gets \" Campaign Restored\" notification\n   - If campaign wasn't hidden  No notification sent\n8. Panel closes, reports table refreshes\n\n### Scenario 2: Clear Violation\n1. Admin reviews reports (loaded with filters)\n2. Clicks \"Take Action\" on reported campaign\n3. Reviews campaign - clearly inappropriate content (violates rules)\n4. Clicks \"Remove Campaign\" (red danger button)\n5. Reason selection modal appears\n6. Selects reason: \"Inappropriate content\"\n7. Clicks \"Continue\"\n8. Confirms removal in second confirmation modal\n9. System:\n   - Sets `moderationStatus` to `removed-temporary`\n   - Sets 30-day appeal deadline\n   - Stores ban reason \"Inappropriate content\"\n   - Resets report counts to 0\n   - Creator receives \" Campaign Removed\" notification with reason and appeal deadline\n10. Panel closes, reports table refreshes\n\n### Scenario 3: Minor Issue / Warning\n1. Admin reviews reported content\n2. Content is borderline but not severe enough for removal\n   - Example: Slightly misleading caption but not harmful\n3. Clicks \"Warn Creator\"\n4. Reason selection modal appears\n5. Selects reason: \"Misinformation\"\n6. Clicks \"Continue\"\n7. Confirms warning\n8. System:\n   - Creates warning record with reason \"Misinformation\"\n   - **Restores campaign to `active` status** (unhides if was auto-hidden)\n   - Resets report counts to 0\n   - User receives \" Warning Issued\" notification with specific reason\n9. User can see their content again, but warning is tracked for future reference\n10. If user gets more warnings, admin can see pattern (future enhancement needed)\n\n---\n\n## Known Limitations & Future Enhancements\n\n### Current Limitations:\n\n1. **Report Count Synchronization Edge Cases**\n   - Campaign/user reportsCount can temporarily differ from reportSummary reportsCount\n   - Happens when new reports come after previous dismissal/resolution\n   - Counters sync again when admin takes action\n   - Not a critical issue - counters always match before and after admin actions\n\n2. **Reason Count History Lost**\n   - When admin takes action, all reason count data is erased\n   - Can't see historical patterns of violations across multiple report cycles\n   - This is a trade-off for the 95% reduction in database operations\n   - Could be improved by archiving reason counts before resetting\n\n### Planned Enhancements:\n\n1. **Reason Count History** (Priority: LOW)\n   - Archive reason counts when admin takes action\n   - Allow pattern analysis and trend detection\n   - View historical violation patterns for repeat offenders\n\n---\n\n## Summary\n\nThe Twibbonize reporting system is designed to:\n-  Make reporting easy for users (just select a reason from dropdown)\n-  Auto-hide problematic content quickly (3 reports for campaigns, 10 for users)\n-  Give admins powerful filtering and sorting tools\n-  Show clear reason breakdowns for informed decisions\n-  Communicate actions transparently via in-app and email notifications\n-  Maintain audit trails for repeat offenders\n-  Optimize performance for viral-scale campaigns (95% reduction in database operations)\n-  Provide fair appeal windows (full appeal system implemented with user submission, admin review, and automated reminders)\n-  Track admin actions with comprehensive audit logging (admin ID, email, name, action, reason, timestamps)\n-  Enforce status transition validation (prevents reversing permanent bans/removals)\n-  Prevent report spam through rate limiting\n-  Protect user privacy (hashed IP addresses)\n\nThis system balances automation with human oversight, ensuring bad content is addressed quickly while giving creators/users appropriate notifications and appeal rights.\n\n**Note:** This document reflects the actual implementation as of October 31, 2025. The appeal system, admin audit logging, appeal deadline reminders, and status transition validation are all fully implemented and functional.\n\n---\n\n## Status Transition System - Complete Technical Analysis\n\n**Last Updated:** October 25, 2025\n\nThis section documents how campaign and user statuses change throughout the moderation lifecycle, where transitions are triggered, validation rules, and identified gaps in the current implementation.\n\n---\n\n### Campaign Status System (moderationStatus)\n\nCampaigns use the `moderationStatus` field to track content visibility and moderation state.\n\n#### Available Statuses:\n\n1. **`active`** - Campaign is visible to public, no moderation issues\n2. **`under-review`** - 1-2 reports received, still visible but flagged for review\n3. **`under-review-hidden`** - Campaign auto-hidden at 3+ reports, awaiting admin review\n4. **`removed-temporary`** - Admin removed campaign with 30-day appeal window\n5. **`removed-permanent`** - Campaign permanently removed, no recovery possible\n\n**Note:** The status `under-review` serves as an intermediate flagging state before auto-hiding content from the public.\n\n---\n\n### User Status System (accountStatus + moderationStatus)\n\nUsers have TWO separate status fields that serve different purposes:\n\n#### 1. `accountStatus` - Controls account access and bans:\n- **`active`** - User can log in, account fully functional\n- **`under-review`** - 1-9 reports received, profile still visible (user can still log in)\n- **`under-review-hidden`** - Profile hidden at 10+ reports (user can still log in)\n- **`banned-temporary`** - User cannot log in, 30-day appeal window\n- **`banned-permanent`** - User cannot log in, permanent ban, data scheduled for deletion\n\n#### 2. `moderationStatus` - Controls profile visibility (separate from campaigns):\n- **`active`** - Profile visible to public\n- **`under-review`** - Profile flagged for review but still visible\n- **`under-review-hidden`** - Profile hidden from public (user can still log in and appeal)\n\n**Important Distinction:**\n- `accountStatus` = whether user can ACCESS their account\n- `moderationStatus` = whether profile is VISIBLE to public\n- These can be different (e.g., profile hidden but user can still log in to appeal)\n\n---\n\n### Status Transition Map\n\n#### Campaign Status Transitions:\n\n```\nAUTOMATIC TRANSITIONS (triggered by reports):\nactive  under-review-hidden (at 3rd report)\n\nADMIN ACTIONS (via /api/admin/reports/summary/[summaryId]):\nunder-review-hidden  active (dismiss reports)\nunder-review-hidden  removed-temporary (remove campaign)\nactive  removed-temporary (remove campaign without being hidden first)\nactive  active (warn creator - resets to active if was hidden)\nunder-review-hidden  active (warn creator - always restores to active)\n\nADMIN DIRECT ACTIONS (via /api/admin/campaigns/[campaignId]):\nANY_STATUS  active (restore campaign)\nANY_STATUS  under-review-hidden (manual hide)\nANY_STATUS  removed-temporary (temporary removal)\nANY_STATUS  removed-permanent (permanent removal)\n\nAPPEAL SYSTEM (via /api/admin/appeals/[appealId]):\nremoved-temporary  active (appeal approved)\nremoved-temporary  removed-permanent (appeal rejected)\n\nCREATOR ACTIONS:\nANY_NON_REMOVED_STATUS  deleted (creator deletes their campaign)\n```\n\n#### User Status Transitions:\n\n```\nAUTOMATIC TRANSITIONS (triggered by reports):\naccountStatus: active  under-review-hidden (at 10th report)\n\nADMIN REPORT ACTIONS (via /api/admin/reports/summary/[summaryId]):\naccountStatus: under-review-hidden  active (dismiss reports)\naccountStatus: under-review-hidden  banned-temporary (ban user)\naccountStatus: active  banned-temporary (ban directly)\naccountStatus: active  active (warn user - resets to active if hidden)\naccountStatus: under-review-hidden  active (warn user)\n\nADMIN DIRECT BAN (via /api/admin/users/[userId]/ban):\naccountStatus: ANY  active (unban)\naccountStatus: ANY  banned-temporary (temporary ban)\naccountStatus: ANY  banned-permanent (permanent ban)\n\nAPPEAL SYSTEM (via /api/admin/appeals/[appealId]):\naccountStatus: banned-temporary  active (appeal approved)\naccountStatus: banned-temporary  banned-permanent (appeal rejected)\n```\n\n---\n\n### Where Transitions Happen\n\n#### 1. Auto-Hide on Reports\n**File:** `/src/app/api/reports/submit/route.js` and `/src/app/api/reports/user/route.js`\n\n**Trigger:** Report submission increments counter\n\n**Campaign Logic:**\n```javascript\nif (newReportsCount >= 3 && campaignData.moderationStatus === 'active') {\n  campaignUpdates.moderationStatus = 'under-review-hidden';\n  campaignUpdates.hiddenAt = now;\n  // Send notification to creator\n}\n```\n\n**User Logic:**\n```javascript\nif (newReportsCount >= 10 && userData.accountStatus === 'active') {\n  userUpdates.accountStatus = 'under-review-hidden';\n  userUpdates.hiddenAt = now;\n  // Send notification to user\n}\n```\n\n**Validation:**  Only triggers if current status is `active` (prevents re-hiding reviewed content)\n\n---\n\n#### 2. Admin Report Actions (Dismiss/Warn/Remove)\n**File:** `/src/app/api/admin/reports/summary/[summaryId]/route.js`\n\n**Actions:**\n\n**A. Dismiss Report (`action: 'no-action'`):**\n- Campaigns: `moderationStatus  'active'`\n- Users: `accountStatus  'active'`\n- Clears: `hiddenAt`, `bannedAt`, `banReason`, `appealDeadline`\n- Resets: `reportsCount  0`\n\n**B. Warn (`action: 'warned'`):**\n- Creates warning record in `warnings` collection\n- Campaigns: `moderationStatus  'active'` (always restores)\n- Users: `accountStatus  'active'` (always restores)\n- Clears all moderation fields (same as dismiss)\n- Rationale: Warning means \"reviewed but not severe enough for removal\"\n\n**C. Remove/Ban (`action: 'removed'`):**\n- Campaigns: `moderationStatus  'removed-temporary'`\n- Users: `accountStatus  'banned-temporary'`\n- Sets: `bannedAt`, `banReason`, `appealDeadline` (30 days)\n- Resets: `reportsCount  0`\n\n**Validation:**  Status transition validation implemented via `statusTransitionValidator.js`\n- Prevents reversing permanent removals (removed-permanent  active is blocked)\n- Prevents reversing permanent bans (banned-permanent  active is blocked)\n- Enforces valid state machine transitions\n- Returns clear error messages for invalid transitions\n\n---\n\n#### 3. Admin Direct Campaign Moderation\n**File:** `/src/app/api/admin/campaigns/[campaignId]/route.js`\n\n**Allowed Statuses:** `['active', 'under-review-hidden', 'removed-temporary', 'removed-permanent']`\n\n**Behavior:**\n- Admin can set campaign to ANY valid status directly\n- Sets appeal deadline for `removed-temporary`\n- Clears appeal fields for `removed-permanent`\n- Clears moderation fields when setting to `active`\n\n**Validation:**  Status transition validation enforced - `removed-permanent`  `active` is blocked\n\n---\n\n#### 4. Admin Direct User Ban\n**File:** `/src/app/api/admin/users/[userId]/ban/route.js`\n\n**Allowed Statuses:** `['active', 'banned-temporary', 'banned-permanent']`\n\n**Behavior:**\n- Admin can set user to ANY valid status directly\n- Sets appeal deadline for `banned-temporary`\n- Clears appeal fields for `banned-permanent`\n- Sends email notification for bans/unbans\n\n**Validation:**  Status transition validation enforced - `banned-permanent`  `active` is blocked\n\n---\n\n#### 5. Appeal Approval/Rejection\n**File:** `/src/app/api/admin/appeals/[appealId]/route.js`\n\n**Appeal Approval:**\n- Campaigns: `removed-temporary  active`\n- Users: `banned-temporary  active`\n- Clears all moderation/ban fields\n- Resets `reportsCount  0`\n\n**Appeal Rejection:**\n- Campaigns: `removed-temporary  removed-permanent`\n- Users: `banned-temporary  banned-permanent`\n- Clears `appealDeadline` (no more appeals)\n\n**Validation:**  Checks appeal status is `pending` before processing\n**Validation:**  Uses status transition validator to ensure valid state changes during approval/rejection\n\n---\n\n### Implemented Validation System\n\n####  Status Transition Validation (IMPLEMENTED)\n\n**File:** `/src/utils/admin/statusTransitionValidator.js`\n\n**Features:**\n- Prevents reversing permanent removals (`removed-permanent`  any other status is blocked)\n- Prevents reversing permanent bans (`banned-permanent`  any other status is blocked)\n- Enforces valid state machine transitions for campaigns and users\n- Returns clear error messages for invalid transitions\n- Used in all admin endpoints that modify status\n\n**Campaign Transitions (Enforced):**\n```javascript\n{\n  'active': ['under-review', 'under-review-hidden', 'removed-temporary', 'removed-permanent'],\n  'under-review': ['active', 'under-review-hidden', 'removed-temporary', 'removed-permanent'],\n  'under-review-hidden': ['active', 'under-review', 'removed-temporary', 'removed-permanent'],\n  'removed-temporary': ['active', 'removed-permanent'], // Can be restored via appeal\n  'removed-permanent': [], // NO transitions out - truly permanent\n}\n```\n\n**User Transitions (Enforced):**\n```javascript\n{\n  'active': ['under-review', 'under-review-hidden', 'banned-temporary', 'banned-permanent'],\n  'under-review': ['active', 'under-review-hidden', 'banned-temporary', 'banned-permanent'],\n  'under-review-hidden': ['active', 'under-review', 'banned-temporary', 'banned-permanent'],\n  'banned-temporary': ['active', 'banned-permanent'], // Can be restored via appeal\n  'banned-permanent': [], // NO transitions out - truly permanent\n}\n```\n\n**Impact:** \"Permanent\" truly means permanent - admins cannot accidentally (or intentionally) restore permanently removed/banned content\n\n---\n\n####  Admin Action Audit Logging (IMPLEMENTED)\n\n**File:** `/src/utils/logAdminAction.js`\n\n**What's Logged:**\n- Admin ID, email, and display name (from authenticated session)\n- Action type (dismissed, warned, removed, banned, etc.)\n- Target type and ID (campaign or user)\n- Target title/name for easy reference\n- Admin-selected reason (for warnings, bans, removals)\n- Additional metadata (previous status, reports count, etc.)\n- Timestamp (server-side)\n- System actions from cron jobs (labeled with adminId: 'system')\n\n**Where Used:**\n- All report summary actions (`/api/admin/reports/summary/[summaryId]`)\n- All campaign moderation actions (`/api/admin/campaigns/[campaignId]`)\n- All user ban actions (`/api/admin/users/[userId]/ban`)\n- All appeal decisions (`/api/admin/appeals/[appealId]`)\n- Cron job automated actions (appeal deadline expiry, etc.)\n\n**Admin Logs Dashboard:** `/admin/logs` - View, filter, and search all admin actions\n\n**Impact:** Full audit trail for accountability, debugging, and pattern analysis\n\n---\n\n####  Appeal Deadline Reminders (IMPLEMENTED)\n\n**Cron Job:** `/api/cron/send-appeal-reminders`\n- **Schedule:** Daily at 10:00 AM UTC\n- **Reminders:** 7 days, 3 days, and 1 day before deadline\n- **Campaign removals:** In-app notifications (creators can log in)\n- **Account bans:** Email notifications (banned users cannot log in)\n- **Secured:** Requires `CRON_SECRET` environment variable\n- **Monitored:** All actions logged to admin logs\n\n**Impact:** Users don't miss their appeal window, improving fairness\n\n---\n\n#### Minor Edge Cases (Not Critical)\n\n#### 1. **Auto-Hide Status Check**\n\n**Current Logic:**\n```javascript\nif (newReportsCount >= 3 && campaignData.moderationStatus === 'active')\n```\n\n**Edge Case:** Reports on `removed-temporary` campaigns increment counter but don't trigger auto-hide.\n\n**Impact:** Minimal - removed campaigns are already hidden from public and shouldn't receive new reports\n\n#### 2. **\"under-review\" Status Usage**\n\n**Status:** Listed in validation constants but not actively used in report flow\n\n**Current Implementation:** Reports go from `active`  `under-review` (1-2 reports)  `under-review-hidden` (3+ reports)\n\n**Impact:** None - status is valid and could be used in future for intermediate flagging\n\n---\n\n### Enforced Status Transition Rules\n\nThe system enforces these transition rules via `/src/utils/admin/statusTransitionValidator.js`:\n\n#### Campaign Transitions (ENFORCED):\n\n```javascript\nconst VALID_CAMPAIGN_TRANSITIONS = {\n  'active': ['under-review', 'under-review-hidden', 'removed-temporary', 'removed-permanent'],\n  'under-review': ['active', 'under-review-hidden', 'removed-temporary', 'removed-permanent'],\n  'under-review-hidden': ['active', 'under-review', 'removed-temporary', 'removed-permanent'],\n  'removed-temporary': ['active', 'removed-permanent'], // Only via appeal or admin decision\n  'removed-permanent': [], // NO transitions out - truly permanent\n};\n```\n\n#### User Transitions (ENFORCED):\n\n```javascript\nconst VALID_ACCOUNT_TRANSITIONS = {\n  'active': ['under-review', 'under-review-hidden', 'banned-temporary', 'banned-permanent'],\n  'under-review': ['active', 'under-review-hidden', 'banned-temporary', 'banned-permanent'],\n  'under-review-hidden': ['active', 'under-review', 'banned-temporary', 'banned-permanent'],\n  'banned-temporary': ['active', 'banned-permanent'], // Only via appeal or admin decision\n  'banned-permanent': [], // NO transitions out - truly permanent\n};\n```\n\n**Where Enforced:**\n- `/api/admin/campaigns/[campaignId]/route.js` - Campaign moderation actions\n- `/api/admin/users/[userId]/ban/route.js` - User ban/unban actions\n- `/api/admin/reports/summary/[summaryId]/route.js` - Report actions (warn/remove/dismiss)\n- `/api/admin/appeals/[appealId]/route.js` - Appeal approval/rejection\n\n**Error Handling:**\n- Invalid transitions return clear error messages\n- Example: \"Cannot restore permanently removed campaigns. Permanent removals are final and cannot be reversed.\"\n- HTTP 400 status code returned to client\n\n---\n\n### Business Rule Summary\n\nBased on actual code implementation, the moderation system follows these rules:\n\n **Implemented and Enforced:**\n1. Auto-hide only triggers on `active` status (prevents re-hiding reviewed content)\n2. Warnings always restore to `active` (warning is not removal)\n3. Appeals check for `pending` status before processing\n4. Report counts reset to 0 on all admin actions\n5. Temporary statuses set 30-day appeal deadlines\n6. **Status transition validation prevents reversing permanent bans/removals**\n7. **Admin actions are logged with full audit trail (admin ID, name, email, reason)**\n8. **Appeal deadline reminders sent at 7, 3, and 1 day before expiry**\n9. **Expired appeal deadlines auto-upgrade to permanent via cron job**\n\n **Working as Designed:**\n1. Users can have `accountStatus = 'banned-temporary'` while `moderationStatus = 'active'` (profile visible but cannot log in)\n2. Reports can increment on `removed-temporary` content (edge case - removed content hidden from public anyway)\n3. \"under-review\" status exists for intermediate flagging (1-2 reports for campaigns, 1-9 for users)\n\n---\n\n**End of Status Transition Analysis**\n","path":null,"size_bytes":52444,"size_tokens":null},"src/app/api/campaigns/[campaignId]/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { verifyIdToken } from '@/lib/firebaseAdmin';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\nimport { supabaseAdmin } from '@/lib/supabase-admin';\nimport { FieldValue } from 'firebase-admin/firestore';\n\nexport async function DELETE(request, { params }) {\n  try {\n    const authorization = request.headers.get('authorization');\n    \n    if (!authorization || !authorization.startsWith('Bearer ')) {\n      return NextResponse.json(\n        { success: false, error: 'No authorization token provided' },\n        { status: 401 }\n      );\n    }\n\n    const token = authorization.replace('Bearer ', '');\n    \n    let decodedToken;\n    try {\n      decodedToken = await verifyIdToken(token);\n    } catch (error) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid or expired token' },\n        { status: 401 }\n      );\n    }\n\n    const userId = decodedToken.uid;\n    const { campaignId } = params;\n\n    if (!campaignId) {\n      return NextResponse.json(\n        { success: false, error: 'Campaign ID is required' },\n        { status: 400 }\n      );\n    }\n\n    const db = adminFirestore();\n    const campaignRef = db.collection('campaigns').doc(campaignId);\n    const campaignDoc = await campaignRef.get();\n\n    if (!campaignDoc.exists) {\n      return NextResponse.json(\n        { success: false, error: 'Campaign not found' },\n        { status: 404 }\n      );\n    }\n\n    const campaignData = campaignDoc.data();\n\n    if (campaignData.creatorId !== userId) {\n      return NextResponse.json(\n        { success: false, error: 'You are not authorized to delete this campaign' },\n        { status: 403 }\n      );\n    }\n\n    try {\n      if (campaignData.storagePath || campaignData.imageUrl) {\n        let imagePath = campaignData.storagePath;\n        \n        if (!imagePath && campaignData.imageUrl) {\n          if (campaignData.imageUrl.includes('/storage/v1/object/public/uploads/')) {\n            imagePath = campaignData.imageUrl.split('/storage/v1/object/public/uploads/')[1];\n          } else {\n            if (process.env.NODE_ENV === 'development') {\n              console.warn('Could not parse storage path from imageUrl:', campaignData.imageUrl);\n            }\n          }\n        }\n        \n        if (imagePath) {\n          const { error: storageError } = await supabaseAdmin.storage\n            .from('uploads')\n            .remove([imagePath]);\n          \n          if (storageError) {\n            console.error('Supabase storage deletion error for path:', imagePath, storageError);\n          } else {\n            if (process.env.NODE_ENV === 'development') {\n              console.log('Successfully deleted storage file:', imagePath);\n            }\n          }\n        }\n      }\n    } catch (storageError) {\n      console.error('Error deleting campaign image from storage:', storageError);\n    }\n\n    const summaryId = `campaign-${campaignId}`;\n    const summaryRef = db.collection('reportSummary').doc(summaryId);\n\n    let reportsDismissed = 0;\n\n    await db.runTransaction(async (transaction) => {\n      const summaryDoc = await transaction.get(summaryRef);\n      \n      transaction.delete(campaignRef);\n\n      if (summaryDoc.exists) {\n        const summaryData = summaryDoc.data();\n        reportsDismissed = summaryData.reportsCount || 0;\n        \n        transaction.update(summaryRef, {\n          status: 'dismissed',\n          reportsCount: 0,\n          reasonCounts: {},\n          moderationStatus: 'deleted',\n          updatedAt: new Date(),\n          deletionNote: 'Campaign deleted by creator',\n        });\n      }\n\n      const userRef = db.collection('users').doc(userId);\n      transaction.update(userRef, {\n        campaignsCount: FieldValue.increment(-1),\n        updatedAt: new Date(),\n      });\n    });\n\n    if (reportsDismissed > 0) {\n      if (process.env.NODE_ENV === 'development') {\n        console.log(`Auto-dismissed ${reportsDismissed} reports for deleted campaign ${campaignId}`);\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: 'Campaign deleted successfully',\n      data: {\n        campaignId,\n        title: campaignData.title,\n        reportsDismissed,\n      },\n    });\n  } catch (error) {\n    console.error('Error deleting campaign:', error);\n    \n    return NextResponse.json(\n      { success: false, error: error.message || 'Failed to delete campaign' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":4440,"size_tokens":null},"src/utils/reportRateLimit.js":{"content":"import { adminFirestore } from '@/lib/firebaseAdmin';\nimport crypto from 'crypto';\n\nfunction hashIP(ip) {\n  return crypto.createHash('sha256').update(ip).digest('hex');\n}\n\nfunction getClientIP(request) {\n  const forwarded = request.headers.get('x-forwarded-for');\n  const realIP = request.headers.get('x-real-ip');\n  \n  if (forwarded) {\n    return forwarded.split(',')[0].trim();\n  }\n  \n  if (realIP) {\n    return realIP.trim();\n  }\n  \n  return 'unknown';\n}\n\nexport async function checkReportRateLimit(request, targetId, targetType, userId = null) {\n  const db = adminFirestore();\n  const clientIP = getClientIP(request);\n  \n  if (clientIP === 'unknown') {\n    return {\n      allowed: true,\n      reason: null\n    };\n  }\n  \n  const ipHash = hashIP(clientIP);\n  const rateLimitRef = db.collection('reportRateLimits').doc(ipHash);\n  \n  const now = Date.now();\n  const oneHourAgo = now - (60 * 60 * 1000);\n  const oneDayAgo = now - (24 * 60 * 60 * 1000);\n  \n  try {\n    const result = await db.runTransaction(async (transaction) => {\n      const doc = await transaction.get(rateLimitRef);\n      \n      let reports = [];\n      \n      if (doc.exists) {\n        const data = doc.data();\n        reports = data.reports || [];\n        \n        // Self-cleaning: If ALL reports are older than 24 hours, delete the entire document\n        const allReportsExpired = reports.every(report => report.timestamp < oneDayAgo);\n        if (allReportsExpired) {\n          transaction.delete(rateLimitRef);\n          return {\n            allowed: true,\n            reason: null\n          };\n        }\n        \n        // Filter out reports older than 24 hours (keep recent ones)\n        reports = reports.filter(report => report.timestamp > oneDayAgo);\n      }\n      \n      const reportsInLastHour = reports.filter(r => r.timestamp > oneHourAgo);\n      \n      // Check IP-based rate limit (5 reports per hour)\n      if (reportsInLastHour.length >= 5) {\n        return {\n          allowed: false,\n          reason: 'rate_limit_exceeded',\n          message: 'You have submitted too many reports. Please try again later.'\n        };\n      }\n      \n      // Check IP-based duplicate\n      const duplicateReportByIP = reports.find(\n        r => r.targetId === targetId && r.targetType === targetType\n      );\n      \n      if (duplicateReportByIP) {\n        return {\n          allowed: false,\n          reason: 'duplicate_report',\n          message: 'You have already reported this content.'\n        };\n      }\n      \n      // ISSUE #9 FIX: Check user-based duplicate for authenticated users\n      // Prevents bypass by changing networks\n      if (userId && userId !== 'anonymous') {\n        const duplicateReportByUser = reports.find(\n          r => r.targetId === targetId && r.targetType === targetType && r.userId === userId\n        );\n        \n        if (duplicateReportByUser) {\n          return {\n            allowed: false,\n            reason: 'duplicate_report',\n            message: 'You have already reported this content.'\n          };\n        }\n      }\n      \n      // Add new report with userId tracking\n      reports.push({\n        targetId,\n        targetType,\n        timestamp: now,\n        userId: userId || null // Track userId for authenticated users\n      });\n      \n      // Save updated reports with self-cleaning (no TTL needed)\n      transaction.set(rateLimitRef, {\n        reports,\n        lastUpdated: new Date(),\n        ipHash\n      }, { merge: true });\n      \n      return {\n        allowed: true,\n        reason: null\n      };\n    });\n    \n    return result;\n    \n  } catch (error) {\n    console.error('Rate limit check error:', error);\n    \n    return {\n      allowed: true,\n      reason: null\n    };\n  }\n}\n","path":null,"size_bytes":3715,"size_tokens":null},"src/components/admin/AdminLogsTable.js":{"content":"\"use client\";\n\nimport { formatDistanceToNow } from 'date-fns';\n\nexport default function AdminLogsTable({ logs, loading }) {\n  if (loading) {\n    return (\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <div className=\"flex items-center justify-center h-64\">\n          <div className=\"text-center\">\n            <svg className=\"animate-spin h-10 w-10 mx-auto text-emerald-600 mb-4\" fill=\"none\" viewBox=\"0 0 24 24\">\n              <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n              <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n            </svg>\n            <p className=\"text-gray-600\">Loading admin logs...</p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  if (logs.length === 0) {\n    return (\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <div className=\"text-center py-12\">\n          <svg className=\"mx-auto h-12 w-12 text-gray-400\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n            <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\" />\n          </svg>\n          <h3 className=\"mt-2 text-sm font-medium text-gray-900\">No admin logs found</h3>\n          <p className=\"mt-1 text-sm text-gray-500\">\n            Click \"Load Logs\" to fetch admin action history.\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  const getActionBadge = (action) => {\n    const badges = {\n      dismissed: 'bg-gray-100 text-gray-800',\n      warned: 'bg-yellow-100 text-yellow-800',\n      removed: 'bg-red-100 text-red-800',\n    };\n    return badges[action] || 'bg-gray-100 text-gray-800';\n  };\n\n  const getTargetTypeBadge = (targetType) => {\n    const badges = {\n      campaign: 'bg-blue-100 text-blue-800',\n      user: 'bg-purple-100 text-purple-800',\n    };\n    return badges[targetType] || 'bg-gray-100 text-gray-800';\n  };\n\n  return (\n    <div className=\"bg-white rounded-lg shadow overflow-hidden\">\n      <div className=\"overflow-x-auto\">\n        <table className=\"min-w-full divide-y divide-gray-200\">\n          <thead className=\"bg-gray-50\">\n            <tr>\n              <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Timestamp\n              </th>\n              <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Admin\n              </th>\n              <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Action\n              </th>\n              <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Target\n              </th>\n              <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Reason\n              </th>\n              <th scope=\"col\" className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                Reports Count\n              </th>\n            </tr>\n          </thead>\n          <tbody className=\"bg-white divide-y divide-gray-200\">\n            {logs.map((log) => (\n              <tr key={log.id} className=\"hover:bg-gray-50\">\n                <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-900\">\n                  <div className=\"flex flex-col\">\n                    <span className=\"font-medium\">\n                      {formatDistanceToNow(new Date(log.timestamp), { addSuffix: true })}\n                    </span>\n                    <span className=\"text-xs text-gray-500\">\n                      {new Date(log.timestamp).toLocaleString()}\n                    </span>\n                  </div>\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-900\">\n                  <div className=\"flex flex-col\">\n                    <span className=\"font-medium\">{log.adminName}</span>\n                    <span className=\"text-xs text-gray-500\">{log.adminEmail}</span>\n                  </div>\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap\">\n                  <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getActionBadge(log.action)}`}>\n                    {log.action.charAt(0).toUpperCase() + log.action.slice(1)}\n                  </span>\n                </td>\n                <td className=\"px-6 py-4 text-sm text-gray-900\">\n                  <div className=\"flex flex-col\">\n                    <div className=\"flex items-center gap-2\">\n                      <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getTargetTypeBadge(log.targetType)}`}>\n                        {log.targetType.charAt(0).toUpperCase() + log.targetType.slice(1)}\n                      </span>\n                      <span className=\"font-medium truncate max-w-xs\" title={log.targetTitle}>\n                        {log.targetTitle}\n                      </span>\n                    </div>\n                    <span className=\"text-xs text-gray-500 font-mono mt-1\">ID: {log.targetId.substring(0, 12)}...</span>\n                  </div>\n                </td>\n                <td className=\"px-6 py-4 text-sm text-gray-900 max-w-xs\">\n                  <span className=\"line-clamp-2\" title={log.reason}>\n                    {log.reason || 'N/A'}\n                  </span>\n                </td>\n                <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-900\">\n                  <div className=\"flex flex-col\">\n                    <span className=\"font-semibold text-emerald-600\">\n                      {log.additionalData?.reportsCount || 0}\n                    </span>\n                    {log.additionalData?.previousStatus && (\n                      <span className=\"text-xs text-gray-500\">\n                        From: {log.additionalData.previousStatus}\n                      </span>\n                    )}\n                  </div>\n                </td>\n              </tr>\n            ))}\n          </tbody>\n        </table>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":6428,"size_tokens":null},"src/app/(chrome)/admin/logs/page.js":{"content":"\"use client\";\n\nimport { useState } from \"react\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport AdminLogsTable from \"@/components/admin/AdminLogsTable\";\nimport ErrorBoundary from \"@/components/ErrorBoundary\";\n\nexport default function AdminLogsPage() {\n  return (\n    <ErrorBoundary>\n      <AdminLogsContent />\n    </ErrorBoundary>\n  );\n}\n\nfunction AdminLogsContent() {\n  const { user } = useAuth();\n  const [logs, setLogs] = useState([]);\n  const [admins, setAdmins] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [loadingMore, setLoadingMore] = useState(false);\n  const [hasMore, setHasMore] = useState(true);\n  const [error, setError] = useState(null);\n  const [filters, setFilters] = useState({\n    action: 'all',\n    targetType: 'all',\n    adminId: 'all',\n    limit: 10,\n  });\n\n  const fetchAdminLogs = async (isLoadMore = false) => {\n    if (!user) return;\n\n    if (isLoadMore) {\n      setLoadingMore(true);\n    } else {\n      setLoading(true);\n    }\n    setError(null);\n    \n    try {\n      const token = await user.getIdToken();\n      \n      const params = new URLSearchParams();\n      if (filters.action !== 'all') params.append('action', filters.action);\n      if (filters.targetType !== 'all') params.append('targetType', filters.targetType);\n      if (filters.adminId !== 'all') params.append('adminId', filters.adminId);\n      params.append('limit', filters.limit.toString());\n      \n      const response = await fetch(`/api/admin/logs?${params.toString()}`, {\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        if (data.indexError) {\n          setError({\n            type: 'index',\n            message: data.error\n          });\n        } else {\n          setError({\n            type: 'general',\n            message: data.error || 'Failed to fetch admin logs'\n          });\n        }\n        return;\n      }\n\n      const newLogs = data.data || [];\n      setLogs(newLogs);\n      setAdmins(data.admins || []);\n      setHasMore(newLogs.length === filters.limit);\n    } catch (error) {\n      console.error('Error fetching admin logs:', error);\n      setError({\n        type: 'general',\n        message: 'An unexpected error occurred'\n      });\n    } finally {\n      setLoading(false);\n      setLoadingMore(false);\n    }\n  };\n\n  const handleLoadMore = () => {\n    setFilters(prev => ({ ...prev, limit: prev.limit + 10 }));\n    setTimeout(() => fetchAdminLogs(true), 0);\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <h2 className=\"text-lg font-semibold text-gray-900 mb-4\">Load Admin Action Logs</h2>\n        <div className=\"grid grid-cols-1 md:grid-cols-5 gap-4\">\n          <div>\n            <label htmlFor=\"action-filter\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Action Type\n            </label>\n            <select\n              id=\"action-filter\"\n              value={filters.action}\n              onChange={(e) => setFilters({ ...filters, action: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n            >\n              <option value=\"all\" className=\"text-gray-900\">All Actions</option>\n              <option value=\"dismissed\" className=\"text-gray-900\">Dismissed</option>\n              <option value=\"warned\" className=\"text-gray-900\">Warned</option>\n              <option value=\"removed\" className=\"text-gray-900\">Removed/Banned</option>\n            </select>\n          </div>\n\n          <div>\n            <label htmlFor=\"type-filter\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Target Type\n            </label>\n            <select\n              id=\"type-filter\"\n              value={filters.targetType}\n              onChange={(e) => setFilters({ ...filters, targetType: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n            >\n              <option value=\"all\" className=\"text-gray-900\">All Types</option>\n              <option value=\"campaign\" className=\"text-gray-900\">Campaigns</option>\n              <option value=\"user\" className=\"text-gray-900\">Users</option>\n            </select>\n          </div>\n\n          <div>\n            <label htmlFor=\"admin-filter\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Admin\n            </label>\n            <select\n              id=\"admin-filter\"\n              value={filters.adminId}\n              onChange={(e) => setFilters({ ...filters, adminId: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n            >\n              <option value=\"all\" className=\"text-gray-900\">All Admins</option>\n              {admins.map((admin) => (\n                <option key={admin.uid} value={admin.uid} className=\"text-gray-900\">\n                  {admin.displayName}\n                </option>\n              ))}\n            </select>\n          </div>\n\n          <div>\n            <label htmlFor=\"limit-input\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Number of Logs\n            </label>\n            <input\n              id=\"limit-input\"\n              type=\"number\"\n              min=\"1\"\n              max=\"200\"\n              value={filters.limit}\n              onChange={(e) => setFilters({ ...filters, limit: parseInt(e.target.value) || 50 })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n              placeholder=\"50\"\n            />\n          </div>\n\n          <div className=\"flex items-end\">\n            <button\n              onClick={fetchAdminLogs}\n              disabled={loading || !user}\n              className=\"w-full px-6 py-2 bg-emerald-600 text-white font-medium rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors\"\n            >\n              {loading ? (\n                <span className=\"flex items-center justify-center\">\n                  <svg className=\"animate-spin -ml-1 mr-2 h-4 w-4 text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                  </svg>\n                  Loading...\n                </span>\n              ) : (\n                'Load Logs'\n              )}\n            </button>\n          </div>\n        </div>\n        {logs.length > 0 && (\n          <div className=\"mt-4 text-sm text-gray-600\">\n            Showing <span className=\"font-semibold\">{logs.length}</span> log{logs.length !== 1 ? 's' : ''}\n          </div>\n        )}\n      </div>\n\n      {error && (\n        <div className={`rounded-lg p-4 ${error.type === 'index' ? 'bg-yellow-50 border border-yellow-200' : 'bg-red-50 border border-red-200'}`}>\n          <div className=\"flex\">\n            <div className=\"flex-shrink-0\">\n              <svg className={`h-5 w-5 ${error.type === 'index' ? 'text-yellow-400' : 'text-red-400'}`} fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\" />\n              </svg>\n            </div>\n            <div className=\"ml-3\">\n              <h3 className={`text-sm font-medium ${error.type === 'index' ? 'text-yellow-800' : 'text-red-800'}`}>\n                {error.type === 'index' ? 'Database Indexes Building' : 'Error Loading Logs'}\n              </h3>\n              <p className={`mt-2 text-sm ${error.type === 'index' ? 'text-yellow-700' : 'text-red-700'}`}>\n                {error.message}\n              </p>\n            </div>\n          </div>\n        </div>\n      )}\n\n      <AdminLogsTable\n        logs={logs}\n        loading={loading}\n      />\n\n      {logs.length > 0 && hasMore && !loading && (\n        <div className=\"bg-white rounded-lg shadow p-6 text-center\">\n          <button\n            onClick={handleLoadMore}\n            disabled={loadingMore}\n            className=\"px-8 py-3 bg-emerald-600 text-white font-medium rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors\"\n          >\n            {loadingMore ? (\n              <span className=\"flex items-center justify-center\">\n                <svg className=\"animate-spin -ml-1 mr-2 h-4 w-4 text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                  <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                </svg>\n                Loading More...\n              </span>\n            ) : (\n              'Load More (10 items)'\n            )}\n          </button>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":9660,"size_tokens":null},"src/utils/logAdminAction.js":{"content":"import { adminFirestore } from '@/lib/firebaseAdmin';\n\nexport async function logAdminAction({\n  adminId,\n  adminEmail,\n  adminName,\n  action,\n  targetType,\n  targetId,\n  targetTitle,\n  reason,\n  summaryId,\n  additionalData = {}\n}) {\n  try {\n    const db = adminFirestore();\n    const logRef = db.collection('adminLogs').doc();\n    \n    const logData = {\n      adminId,\n      adminEmail,\n      adminName: adminName || adminEmail || 'Unknown Admin',\n      action,\n      targetType,\n      targetId,\n      targetTitle: targetTitle || 'Unknown',\n      reason: reason || null,\n      summaryId: summaryId || null,\n      timestamp: new Date(),\n      ...additionalData\n    };\n    \n    await logRef.set(logData);\n    \n    return { success: true, logId: logRef.id };\n  } catch (error) {\n    console.error('Failed to log admin action:', error);\n    return { success: false, error: error.message };\n  }\n}\n","path":null,"size_bytes":892,"size_tokens":null},"src/app/api/admin/logs/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\n\nexport async function GET(request) {\n  try {\n    await requireAdmin(request);\n    \n    const { searchParams } = new URL(request.url);\n    const action = searchParams.get('action') || 'all';\n    const targetType = searchParams.get('targetType') || 'all';\n    const adminId = searchParams.get('adminId') || 'all';\n    const limitParam = searchParams.get('limit') || '50';\n    const limitValue = parseInt(limitParam, 10);\n    \n    const db = adminFirestore();\n    let logsQuery = db.collection('adminLogs');\n    \n    // Filter by action (dismissed, warned, removed, or all)\n    if (action !== 'all') {\n      logsQuery = logsQuery.where('action', '==', action);\n    }\n    \n    // Filter by target type (campaign, user, or all)\n    if (targetType !== 'all') {\n      logsQuery = logsQuery.where('targetType', '==', targetType);\n    }\n    \n    // Filter by admin ID\n    if (adminId !== 'all') {\n      logsQuery = logsQuery.where('adminId', '==', adminId);\n    }\n    \n    // Order by timestamp (newest first) and limit\n    logsQuery = logsQuery.orderBy('timestamp', 'desc').limit(limitValue);\n    \n    const logsSnapshot = await logsQuery.get();\n    \n    const logs = logsSnapshot.docs.map(doc => {\n      const data = doc.data();\n      \n      // Convert Firestore timestamp to ISO string\n      if (data.timestamp && data.timestamp.toDate) {\n        data.timestamp = data.timestamp.toDate().toISOString();\n      }\n      \n      return {\n        id: doc.id,\n        ...data\n      };\n    });\n    \n    // Get unique admins for filter dropdown\n    const adminsSnapshot = await db.collection('users')\n      .where('role', '==', 'admin')\n      .get();\n    \n    const admins = adminsSnapshot.docs.map(doc => ({\n      uid: doc.id,\n      email: doc.data().email,\n      displayName: doc.data().displayName || doc.data().username || doc.data().email,\n    }));\n    \n    return NextResponse.json({\n      success: true,\n      data: logs,\n      count: logs.length,\n      admins: admins,\n    });\n  } catch (error) {\n    console.error('Error fetching admin logs:', error);\n    \n    if (error.message.includes('Unauthorized') || error.message.includes('Admin access required')) {\n      return NextResponse.json(\n        { success: false, error: error.message },\n        { status: 403 }\n      );\n    }\n    \n    // Handle Firestore index errors (FAILED_PRECONDITION)\n    if (error.code === 9 || error.message.includes('index') || error.message.includes('FAILED_PRECONDITION')) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Firestore indexes are still building. Please wait a few minutes and try again. If the issue persists, check Firebase Console for index status.',\n          indexError: true\n        },\n        { status: 503 }\n      );\n    }\n    \n    return NextResponse.json(\n      { success: false, error: 'Failed to fetch admin logs' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":3046,"size_tokens":null},"src/utils/notifications/sendEmail.js":{"content":"import { MailerSend, EmailParams, Sender, Recipient } from \"mailersend\";\nimport { validateMailersendKey } from \"../validateEnv\";\n\n// Validate at build time ONLY for production builds\n// This catches invalid keys before deployment while allowing development builds to proceed\nif (process.env.NODE_ENV === 'production') {\n  validateMailersendKey(process.env.MAILERSEND_API_KEY);\n}\n\nconst mailerSend = new MailerSend({\n  apiKey: process.env.MAILERSEND_API_KEY || \"\",\n});\n\n/**\n * Send an email using MailerSend API\n * @param {Object} params - Email parameters\n * @param {string} params.to - Recipient email address\n * @param {string} params.subject - Email subject line\n * @param {string} params.html - HTML email content\n * @param {string} [params.from] - Sender email address (defaults to MailerSend trial domain)\n * @returns {Promise<Object>} - Result object with success status\n */\nexport async function sendEmail({\n  to,\n  subject,\n  html,\n  from = \"noreply@test-nrw7gymxx6jg2k8e.mlsender.net\", // MailerSend trial domain\n}) {\n  try {\n    if (process.env.NODE_ENV === 'development') {\n      console.log(\"[EMAIL] Sending to:\", to);\n      console.log(\"[EMAIL] Subject:\", subject);\n    }\n\n    if (!to || !subject || !html) {\n      throw new Error(\"Missing required fields: to, subject, and html\");\n    }\n\n    if (!process.env.MAILERSEND_API_KEY) {\n      throw new Error(\"MAILERSEND_API_KEY environment variable is not set\");\n    }\n\n    const sentFrom = new Sender(from, \"Twibbonize\");\n    const recipients = [new Recipient(to, to)];\n\n    const emailParams = new EmailParams()\n      .setFrom(sentFrom)\n      .setTo(recipients)\n      .setSubject(subject)\n      .setHtml(html);\n\n    const result = await mailerSend.email.send(emailParams);\n\n    if (process.env.NODE_ENV === 'development') {\n      console.log(\"[EMAIL] Sent successfully:\", result.body?.messageId || \"sent\");\n    }\n\n    return {\n      success: true,\n      emailId: result.body?.messageId || \"sent\",\n      message: \"Email sent successfully\",\n    };\n  } catch (error) {\n    console.error(\"[EMAIL] Error:\", error);\n    return {\n      success: false,\n      error: error.message,\n    };\n  }\n}\n","path":null,"size_bytes":2148,"size_tokens":null},"src/utils/notifications/emailTemplates.js":{"content":"/**\n * Email templates for user notifications\n * Returns { subject, html } for each template type\n */\nexport const getEmailTemplate = (templateName, params = {}) => {\n  const templates = {\n    accountBanned: ({\n      userEmail,\n      username,\n      banReason,\n      appealDeadline,\n      isPermanent,\n    }) => ({\n      subject: \" Your Account Has Been Suspended\",\n      html: `\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset=\"UTF-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n          <style>\n            body { \n              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; \n              line-height: 1.6; \n              color: #333; \n              margin: 0; \n              padding: 0;\n              background-color: #f5f5f5;\n            }\n            .container { \n              max-width: 600px; \n              margin: 20px auto; \n              background-color: #ffffff;\n              border-radius: 8px;\n              overflow: hidden;\n              box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n            }\n            .header { \n              background: #dc2626; \n              color: white; \n              padding: 30px 20px; \n              text-align: center; \n            }\n            .header h1 {\n              margin: 0;\n              font-size: 24px;\n            }\n            .content { \n              padding: 30px; \n            }\n            .warning-box { \n              background: #fef2f2; \n              border-left: 4px solid #dc2626; \n              padding: 15px; \n              margin: 20px 0;\n              border-radius: 4px;\n            }\n            .warning-box strong {\n              display: block;\n              margin-bottom: 8px;\n              color: #dc2626;\n            }\n            .footer { \n              text-align: center; \n              padding: 20px; \n              color: #666; \n              font-size: 14px;\n              background-color: #f9fafb;\n              border-top: 1px solid #e5e7eb;\n            }\n            .button { \n              background: #2563eb; \n              color: white !important; \n              padding: 12px 24px; \n              text-decoration: none; \n              border-radius: 6px; \n              display: inline-block;\n              margin: 20px 0;\n            }\n            .button:hover {\n              background: #1d4ed8;\n            }\n            p {\n              margin: 0 0 16px 0;\n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"container\">\n            <div class=\"header\">\n              <h1> Account Suspended</h1>\n            </div>\n            <div class=\"content\">\n              <p>Hello ${username || userEmail},</p>\n              \n              <p>Your Twibbonize account has been ${isPermanent ? \"permanently\" : \"temporarily\"} suspended by our moderation team.</p>\n              \n              <div class=\"warning-box\">\n                <strong>Reason for suspension:</strong>\n                <p style=\"margin: 0;\">${banReason}</p>\n              </div>\n              \n              ${\n                !isPermanent\n                  ? `\n                <p><strong>Appeal Deadline:</strong> ${appealDeadline}</p>\n                <p>You have the right to appeal this decision within 30 days. If you believe this suspension was made in error, you can submit an appeal before the deadline.</p>\n                <p style=\"text-align: center; margin: 30px 0;\">\n                  <a href=\"${process.env.NEXT_PUBLIC_BASE_URL}/profile/appeal\" class=\"button\">Submit an Appeal</a>\n                </p>\n              `\n                  : `\n                <p>This is a permanent suspension. Your account will not be restored.</p>\n              `\n              }\n              \n              <p>If you have any questions, please contact our support team at support@twibbonize.com</p>\n            </div>\n            <div class=\"footer\">\n              <p><strong>Twibbonize Moderation Team</strong></p>\n              <p>This is an automated email. Please do not reply directly.</p>\n            </div>\n          </div>\n        </body>\n        </html>\n      `,\n    }),\n\n    appealReminder: ({\n      userEmail,\n      username,\n      daysLeft,\n      itemType,\n      itemName,\n      removalReason,\n    }) => ({\n      subject: ` Appeal Deadline Reminder - ${daysLeft} Day${daysLeft > 1 ? \"s\" : \"\"} Left`,\n      html: `\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset=\"UTF-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n          <style>\n            body { \n              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; \n              line-height: 1.6; \n              color: #333; \n              margin: 0; \n              padding: 0;\n              background-color: #f5f5f5;\n            }\n            .container { \n              max-width: 600px; \n              margin: 20px auto; \n              background-color: #ffffff;\n              border-radius: 8px;\n              overflow: hidden;\n              box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n            }\n            .header { \n              background: #f59e0b; \n              color: white; \n              padding: 30px 20px; \n              text-align: center; \n            }\n            .header h1 {\n              margin: 0;\n              font-size: 24px;\n            }\n            .content { \n              padding: 30px; \n            }\n            .warning-box { \n              background: #fef3c7; \n              border-left: 4px solid #f59e0b; \n              padding: 15px; \n              margin: 20px 0;\n              border-radius: 4px;\n            }\n            .warning-box strong {\n              display: block;\n              margin-bottom: 8px;\n              color: #d97706;\n            }\n            .countdown {\n              text-align: center;\n              background: #fef3c7;\n              padding: 20px;\n              margin: 20px 0;\n              border-radius: 8px;\n              border: 2px solid #f59e0b;\n            }\n            .countdown .days {\n              font-size: 48px;\n              font-weight: bold;\n              color: #d97706;\n              display: block;\n            }\n            .countdown .label {\n              font-size: 18px;\n              color: #92400e;\n              text-transform: uppercase;\n              letter-spacing: 1px;\n            }\n            .footer { \n              text-align: center; \n              padding: 20px; \n              color: #666; \n              font-size: 14px;\n              background-color: #f9fafb;\n              border-top: 1px solid #e5e7eb;\n            }\n            .button { \n              background: #2563eb; \n              color: white !important; \n              padding: 12px 24px; \n              text-decoration: none; \n              border-radius: 6px; \n              display: inline-block;\n              margin: 20px 0;\n              font-weight: 600;\n            }\n            .button:hover {\n              background: #1d4ed8;\n            }\n            p {\n              margin: 0 0 16px 0;\n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"container\">\n            <div class=\"header\">\n              <h1> Appeal Deadline Reminder</h1>\n            </div>\n            <div class=\"content\">\n              <p>Hello ${username || userEmail},</p>\n              \n              <div class=\"countdown\">\n                <span class=\"days\">${daysLeft}</span>\n                <span class=\"label\">Day${daysLeft > 1 ? \"s\" : \"\"} Remaining</span>\n              </div>\n              \n              <p>This is a reminder that you have <strong>${daysLeft} day${daysLeft > 1 ? \"s\" : \"\"} left</strong> to appeal the ${itemType} for <strong>${itemName}</strong>.</p>\n              \n              <div class=\"warning-box\">\n                <strong>Original Removal Reason:</strong>\n                <p style=\"margin: 0;\">${removalReason}</p>\n              </div>\n              \n              <p>If you believe this ${itemType} was made in error or have additional context to provide, you can submit an appeal before the deadline expires.</p>\n              \n              <p><strong>Important:</strong> After the deadline passes, the ${itemType} will become permanent and cannot be reversed.</p>\n              \n              <p style=\"text-align: center; margin: 30px 0;\">\n                <a href=\"${process.env.NEXT_PUBLIC_BASE_URL}/profile/appeals\" class=\"button\">Submit Appeal Now</a>\n              </p>\n              \n              <p>If you have any questions, contact us at support@twibbonize.com</p>\n            </div>\n            <div class=\"footer\">\n              <p><strong>Twibbonize Moderation Team</strong></p>\n              <p>This is an automated reminder. Please do not reply directly.</p>\n            </div>\n          </div>\n        </body>\n        </html>\n      `,\n    }),\n\n    accountUnbanned: ({ userEmail, username }) => ({\n      subject: \" Your Account Has Been Restored\",\n      html: `\n        <!DOCTYPE html>\n        <html>\n        <head>\n          <meta charset=\"UTF-8\">\n          <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n          <style>\n            body { \n              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; \n              line-height: 1.6; \n              color: #333; \n              margin: 0; \n              padding: 0;\n              background-color: #f5f5f5;\n            }\n            .container { \n              max-width: 600px; \n              margin: 20px auto; \n              background-color: #ffffff;\n              border-radius: 8px;\n              overflow: hidden;\n              box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n            }\n            .header { \n              background: #16a34a; \n              color: white; \n              padding: 30px 20px; \n              text-align: center; \n            }\n            .header h1 {\n              margin: 0;\n              font-size: 24px;\n            }\n            .content { \n              padding: 30px; \n            }\n            .success-box { \n              background: #f0fdf4; \n              border-left: 4px solid #16a34a; \n              padding: 15px; \n              margin: 20px 0;\n              border-radius: 4px;\n            }\n            .success-box strong {\n              display: block;\n              margin-bottom: 8px;\n              color: #16a34a;\n            }\n            .footer { \n              text-align: center; \n              padding: 20px; \n              color: #666; \n              font-size: 14px;\n              background-color: #f9fafb;\n              border-top: 1px solid #e5e7eb;\n            }\n            .button { \n              background: #2563eb; \n              color: white !important; \n              padding: 12px 24px; \n              text-decoration: none; \n              border-radius: 6px; \n              display: inline-block;\n              margin: 20px 0;\n            }\n            .button:hover {\n              background: #1d4ed8;\n            }\n            p {\n              margin: 0 0 16px 0;\n            }\n          </style>\n        </head>\n        <body>\n          <div class=\"container\">\n            <div class=\"header\">\n              <h1> Account Restored</h1>\n            </div>\n            <div class=\"content\">\n              <p>Hello ${username || userEmail},</p>\n              \n              <div class=\"success-box\">\n                <strong>Good news!</strong>\n                <p style=\"margin: 0;\">Your Twibbonize account has been reviewed and restored by our moderation team.</p>\n              </div>\n              \n              <p>You can now log in and access your account normally. We appreciate your patience during the review process.</p>\n              \n              <p style=\"text-align: center; margin: 30px 0;\">\n                <a href=\"${process.env.NEXT_PUBLIC_BASE_URL}/signin\" class=\"button\">Sign In Now</a>\n              </p>\n              \n              <p>Please remember to follow our community guidelines to avoid future issues. If you have any questions, contact us at support@twibbonize.com</p>\n            </div>\n            <div class=\"footer\">\n              <p><strong>Twibbonize Moderation Team</strong></p>\n              <p>This is an automated email. Please do not reply directly.</p>\n            </div>\n          </div>\n        </body>\n        </html>\n      `,\n    }),\n  };\n\n  const template = templates[templateName];\n  if (!template) {\n    throw new Error(`Email template \"${templateName}\" not found`);\n  }\n\n  return typeof template === \"function\" ? template(params) : template;\n};\n","path":null,"size_bytes":12723,"size_tokens":null},"EMAIL_SETUP_INSTRUCTIONS.md":{"content":"# Email Notification Setup Instructions\n\n## What Was Implemented\n\nThe email notification system has been implemented to replace in-app notifications for banned users (since they cannot access their accounts). This fixes Critical Issue #1 in CODE_INCONSISTENCIES.md.\n\n### Changes Made:\n\n1. **New Files Created:**\n   - `src/utils/notifications/sendEmail.js` - Email sending utility using MailerSend API\n   - `src/utils/notifications/emailTemplates.js` - HTML email templates for ban/unban notifications\n\n2. **Updated Endpoints:**\n   - `src/app/api/admin/users/[userId]/ban/route.js` - Now sends email for ban/unban actions\n   - `src/app/api/admin/reports/summary/[summaryId]/route.js` - Now sends email for user bans (via reports)\n\n3. **Email Sending Logic:**\n   - **User Bans:** Send EMAIL instead of in-app notification (users can't access their account)\n   - **User Unbans:** Send EMAIL notification (previously not sent at all)\n   - **Campaign Removals:** Keep in-app notification (creators can still log in)\n   - **Warnings:** Keep in-app notification only (not changed)\n\n---\n\n## Steps to Enable Email Notifications\n\n### Step 1: Get MailerSend API Key\n\n1. Go to **https://mailersend.com** and sign up for a free account\n2. Free tier includes: **12,000 emails/month** + trial domain (no custom domain verification needed!)\n3. Navigate to **API Tokens** section in the dashboard\n4. Click **Create Token**\n5. Copy the API key\n\n**Pricing Note:** \n- Free: 12,000 emails/month with trial domain\n- Paid: $25/month for 50,000 emails with custom domain\n\n---\n\n### Step 2: Add Environment Variable to Vercel\n\nGo to your Vercel project settings and add:\n\n| Variable Name | Value | Example |\n|---------------|-------|---------|\n| `MAILERSEND_API_KEY` | Your MailerSend API key | `mlsn.abc123...` |\n| `NEXT_PUBLIC_BASE_URL` | Your app's public URL | `https://replit-twibbon.vercel.app` |\n\n**How to add in Vercel:**\n1. Go to your project in Vercel dashboard\n2. Click **Settings**  **Environment Variables**\n3. Add both variables above\n4. Set them for: **Production**, **Preview**, and **Development** environments\n5. Click **Save**\n\n---\n\n### Step 3: Redeploy on Vercel\n\nAfter adding the environment variables:\n\n1. Go to **Deployments** tab in Vercel\n2. Click **Redeploy** on your latest deployment\n3. Or simply push a new commit to trigger automatic deployment\n\n---\n\n## Using MailerSend Trial Domain\n\nThe free tier includes a **trial domain** (`trial.mailersend.net`) that works immediately without DNS verification!\n\n**Default sender:** `noreply@trial.mailersend.net`\n\n**To switch to your own domain later:**\n1. Purchase a custom domain (e.g., `twibbonize.com`)\n2. Verify it in MailerSend dashboard\n3. Update the `from` parameter in `src/utils/notifications/sendEmail.js`\n\n---\n\n## Testing the Email System\n\n### Test Ban Email:\n1. Create a test user account in your app\n2. As admin, ban the user from `/admin/users`\n3. Check the user's email inbox for the ban notification\n\n### Test Unban Email:\n1. Unban a previously banned user\n2. Check their email for the restoration notification\n\n### Check Logs:\n- Vercel Functions logs will show: `[EMAIL] Sent successfully: <email_id>`\n- If email fails, you'll see: `[EMAIL] Error: <error_message>`\n\n---\n\n## Email Template Preview\n\n### Ban Email:\n- **Subject:**  Your Account Has Been Suspended\n- **Content:** \n  - Explains suspension (temporary or permanent)\n  - Shows ban reason\n  - Shows appeal deadline (if temporary)\n  - \"Submit an Appeal\" button\n  - Support contact info\n\n### Unban Email:\n- **Subject:**  Your Account Has Been Restored\n- **Content:**\n  - Notifies account restoration\n  - \"Sign In Now\" button\n  - Reminder to follow guidelines\n  - Support contact info\n\n---\n\n## Troubleshooting\n\n### Email Not Sending?\n\n**Check Environment Variables:**\n```bash\n# In Vercel dashboard, verify:\n- MAILERSEND_API_KEY is set correctly\n- NEXT_PUBLIC_BASE_URL is set correctly\n```\n\n**Check MailerSend Dashboard:**\n- Go to https://mailersend.com/activity\n- See delivery status of sent emails\n- Check for any errors or bounces\n\n**Check Vercel Function Logs:**\n- Go to Vercel  Deployments  Functions\n- Look for `[EMAIL]` log entries\n- Check for errors\n\n---\n\n## Switching to Custom Domain (Optional)\n\nWhen you purchase your own domain:\n\n1. **Verify in MailerSend:**\n   - Add domain in MailerSend dashboard\n   - Add DNS records to your domain registrar\n   - Wait for verification\n\n2. **Update Code:**\n   - In `src/utils/notifications/sendEmail.js`, change:\n   ```javascript\n   from = \"noreply@yourdomain.com\"\n   ```\n\n3. **Redeploy** your app\n\n---\n\n## Switching Back to Resend (If Needed)\n\nIf you purchase a custom domain and want to use Resend:\n\n1. Install Resend: `npm install resend`\n2. Update `src/utils/notifications/sendEmail.js` to use Resend API\n3. Change `MAILERSEND_API_KEY` to `RESEND_API_KEY` in Vercel\n4. Redeploy\n\n---\n\n## Cost Estimation\n\n**MailerSend Pricing:**\n- Free: 12,000 emails/month\n- Paid: $25/month for 50,000 emails (~$0.0005 per email)\n\n**Example Scenarios:**\n- 100 bans/unbans per day: Free tier is sufficient (3,000/month)\n- 400 bans/unbans per day: Still free tier (12,000/month)\n- 50,000 bans/unbans per month: Need paid plan ($25/month)\n\n---\n\n**Implementation completed!** \n\nEmail notifications are ready to use once you add `MAILERSEND_API_KEY` to Vercel and redeploy.\n","path":null,"size_bytes":5336,"size_tokens":null},"src/app/api/admin/appeals/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminDb } from '@/lib/firebaseAdmin';\n\nexport async function GET(request) {\n  try {\n    const adminCheck = await requireAdmin(request);\n    if (adminCheck.error) {\n      return NextResponse.json({ success: false, error: adminCheck.error }, { status: adminCheck.status });\n    }\n\n    const { searchParams } = new URL(request.url);\n    const status = searchParams.get('status') || 'pending';\n    const type = searchParams.get('type') || 'all';\n    const limitParam = parseInt(searchParams.get('limit')) || 50;\n\n    let appealsQuery = adminDb.collection('appeals');\n\n    if (status !== 'all') {\n      appealsQuery = appealsQuery.where('status', '==', status);\n    }\n\n    if (type !== 'all') {\n      appealsQuery = appealsQuery.where('type', '==', type);\n    }\n\n    appealsQuery = appealsQuery.orderBy('submittedAt', 'desc').limit(limitParam);\n\n    const appealsSnapshot = await appealsQuery.get();\n    const appeals = [];\n\n    for (const doc of appealsSnapshot.docs) {\n      const appealData = { id: doc.id, ...doc.data() };\n\n      const userRef = adminDb.collection('users').doc(appealData.userId);\n      const userDoc = await userRef.get();\n\n      if (userDoc.exists()) {\n        const userData = userDoc.data();\n        appealData.userInfo = {\n          username: userData.username || 'Unknown',\n          displayName: userData.displayName || userData.username || 'Unknown User',\n          profileImage: userData.profileImage || null,\n          email: userData.email || null,\n        };\n      }\n\n      if (appealData.type === 'campaign') {\n        const campaignRef = adminDb.collection('campaigns').doc(appealData.targetId);\n        const campaignDoc = await campaignRef.get();\n\n        if (campaignDoc.exists()) {\n          const campaignData = campaignDoc.data();\n          appealData.targetInfo = {\n            title: campaignData.title,\n            slug: campaignData.slug,\n            imageUrl: campaignData.imageUrl,\n            moderationStatus: campaignData.moderationStatus,\n            removalReason: campaignData.removalReason,\n          };\n        } else {\n          appealData.targetInfo = {\n            title: '[Deleted Campaign]',\n            deleted: true,\n          };\n        }\n      } else {\n        const targetUserRef = adminDb.collection('users').doc(appealData.targetId);\n        const targetUserDoc = await targetUserRef.get();\n\n        if (targetUserDoc.exists()) {\n          const targetUserData = targetUserDoc.data();\n          appealData.targetInfo = {\n            username: targetUserData.username,\n            displayName: targetUserData.displayName || targetUserData.username,\n            profileImage: targetUserData.profileImage,\n            accountStatus: targetUserData.accountStatus,\n            banReason: targetUserData.banReason,\n          };\n        } else {\n          appealData.targetInfo = {\n            username: '[Deleted User]',\n            deleted: true,\n          };\n        }\n      }\n\n      appeals.push(appealData);\n    }\n\n    return NextResponse.json({ success: true, appeals });\n  } catch (error) {\n    console.error('Error fetching appeals:', error);\n    return NextResponse.json(\n      { success: false, error: 'Failed to fetch appeals' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":3339,"size_tokens":null},"src/app/(chrome)/profile/appeals/page.js":{"content":"'use client';\n\nimport { useState, useEffect, useCallback } from 'react';\nimport { useAuth } from '@/hooks/useAuth';\nimport { useRouter } from 'next/navigation';\nimport Image from 'next/image';\nimport AuthGate from '@/components/AuthGate';\nimport ErrorBoundary from '@/components/ErrorBoundary';\n\nexport default function AppealsPage() {\n  return (\n    <AuthGate>\n      <ErrorBoundary>\n        <AppealsContent />\n      </ErrorBoundary>\n    </AuthGate>\n  );\n}\n\nfunction AppealsContent() {\n  const { user } = useAuth();\n  const router = useRouter();\n  const [loading, setLoading] = useState(true);\n  const [submitting, setSubmitting] = useState(false);\n  const [removedItems, setRemovedItems] = useState([]);\n  const [selectedItem, setSelectedItem] = useState(null);\n  const [appealReason, setAppealReason] = useState('');\n  const [error, setError] = useState('');\n  const [success, setSuccess] = useState('');\n\n  const fetchRemovedItems = useCallback(async () => {\n    if (!user) return;\n    \n    try {\n      setLoading(true);\n      const token = await user.getIdToken();\n\n      const response = await fetch('/api/appeals/eligible', {\n        headers: { Authorization: `Bearer ${token}` },\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to fetch eligible items');\n      }\n\n      const data = await response.json();\n      setRemovedItems(data.items || []);\n    } catch (err) {\n      console.error('Error fetching removed items:', err);\n      setError('Failed to load eligible items for appeal');\n    } finally {\n      setLoading(false);\n    }\n  }, [user]);\n\n  useEffect(() => {\n    fetchRemovedItems();\n  }, [fetchRemovedItems]);\n\n  const handleSubmitAppeal = async (e) => {\n    e.preventDefault();\n    \n    if (!selectedItem) {\n      setError('Please select an item to appeal');\n      return;\n    }\n\n    if (appealReason.trim().length < 20) {\n      setError('Appeal reason must be at least 20 characters');\n      return;\n    }\n\n    try {\n      setSubmitting(true);\n      setError('');\n      \n      const token = await user.getIdToken();\n\n      const response = await fetch('/api/appeals/submit', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${token}`,\n        },\n        body: JSON.stringify({\n          type: selectedItem.type,\n          targetId: selectedItem.id,\n          reason: appealReason.trim(),\n        }),\n      });\n\n      const data = await response.json();\n\n      if (!response.ok) {\n        throw new Error(data.error || 'Failed to submit appeal');\n      }\n\n      setSuccess('Appeal submitted successfully! You will be notified of the outcome.');\n      setAppealReason('');\n      setSelectedItem(null);\n      \n      setTimeout(() => {\n        router.push('/profile/notifications');\n      }, 2000);\n    } catch (err) {\n      console.error('Error submitting appeal:', err);\n      setError(err.message || 'Failed to submit appeal');\n    } finally {\n      setSubmitting(false);\n    }\n  };\n\n  const isDeadlinePassed = (deadline) => {\n    const deadlineDate = deadline?.toDate\n      ? deadline.toDate()\n      : new Date(deadline);\n    return new Date() > deadlineDate;\n  };\n\n  const formatDeadline = (deadline) => {\n    const deadlineDate = deadline?.toDate\n      ? deadline.toDate()\n      : new Date(deadline);\n    return deadlineDate.toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric',\n    });\n  };\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 py-8\">\n        <div className=\"max-w-4xl mx-auto px-4\">\n          <div className=\"text-center\">\n            <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto\"></div>\n            <p className=\"mt-4 text-gray-600\">Loading...</p>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 py-8\">\n      <div className=\"max-w-4xl mx-auto px-4\">\n        <div className=\"mb-8\">\n          <h1 className=\"text-3xl font-bold text-gray-900\">Submit an Appeal</h1>\n          <p className=\"mt-2 text-gray-600\">\n            If your content was removed or your account was banned, you can submit an appeal within the deadline.\n          </p>\n        </div>\n\n        {removedItems.length === 0 ? (\n          <div className=\"bg-white rounded-lg shadow p-8 text-center\">\n            <div className=\"text-gray-400 text-5xl mb-4\"></div>\n            <h2 className=\"text-xl font-semibold text-gray-900 mb-2\">\n              No Items Eligible for Appeal\n            </h2>\n            <p className=\"text-gray-600\">\n              You don't have any removed content or banned accounts that are eligible for appeal.\n            </p>\n          </div>\n        ) : (\n          <div className=\"space-y-6\">\n            {error && (\n              <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n                <p className=\"text-red-800\">{error}</p>\n              </div>\n            )}\n\n            {success && (\n              <div className=\"bg-green-50 border border-green-200 rounded-lg p-4\">\n                <p className=\"text-green-800\">{success}</p>\n              </div>\n            )}\n\n            <div className=\"bg-white rounded-lg shadow p-6\">\n              <h2 className=\"text-lg font-semibold text-gray-900 mb-4\">\n                Select Item to Appeal\n              </h2>\n              <div className=\"space-y-3\">\n                {removedItems.map((item) => {\n                  const deadlinePassed = isDeadlinePassed(item.appealDeadline);\n                  \n                  return (\n                    <div\n                      key={`${item.type}-${item.id}`}\n                      className={`border rounded-lg p-4 cursor-pointer transition-colors ${\n                        selectedItem?.id === item.id\n                          ? 'border-blue-500 bg-blue-50'\n                          : deadlinePassed\n                          ? 'border-gray-200 bg-gray-50 opacity-60'\n                          : 'border-gray-200 hover:border-blue-300'\n                      }`}\n                      onClick={() => !deadlinePassed && setSelectedItem(item)}\n                    >\n                      <div className=\"flex items-start gap-4\">\n                        {item.type === 'campaign' && item.imageUrl && (\n                          <Image\n                            src={item.imageUrl}\n                            alt={item.title}\n                            width={64}\n                            height={64}\n                            className=\"w-16 h-16 object-cover rounded\"\n                            unoptimized\n                          />\n                        )}\n                        <div className=\"flex-1\">\n                          <h3 className=\"font-semibold text-gray-900\">\n                            {item.title}\n                          </h3>\n                          <p className=\"text-sm text-gray-600 mt-1\">\n                            <span className=\"font-medium\">Type:</span>{' '}\n                            {item.type === 'campaign' ? 'Campaign' : 'Account'}\n                          </p>\n                          <p className=\"text-sm text-gray-600\">\n                            <span className=\"font-medium\">Reason:</span>{' '}\n                            {item.removalReason || item.banReason || 'Not specified'}\n                          </p>\n                          <p className=\"text-sm text-gray-600\">\n                            <span className=\"font-medium\">Deadline:</span>{' '}\n                            {formatDeadline(item.appealDeadline)}\n                            {deadlinePassed && (\n                              <span className=\"text-red-600 ml-2\">(Expired)</span>\n                            )}\n                          </p>\n                          {item.appealCount > 0 && (\n                            <p className=\"text-sm text-orange-600 mt-1\">\n                               You have already submitted {item.appealCount} appeal(s) for this item\n                            </p>\n                          )}\n                        </div>\n                      </div>\n                    </div>\n                  );\n                })}\n              </div>\n            </div>\n\n            {selectedItem && !isDeadlinePassed(selectedItem.appealDeadline) && (\n              <form onSubmit={handleSubmitAppeal} className=\"bg-white rounded-lg shadow p-6\">\n                <h2 className=\"text-lg font-semibold text-gray-900 mb-4\">\n                  Appeal Reason\n                </h2>\n                <p className=\"text-sm text-gray-600 mb-4\">\n                  Explain why you believe this {selectedItem.type} should be restored. Be clear and respectful.\n                  Minimum 20 characters required.\n                </p>\n                <textarea\n                  value={appealReason}\n                  onChange={(e) => setAppealReason(e.target.value)}\n                  placeholder=\"Enter your appeal reason here...\"\n                  rows={6}\n                  className=\"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none\"\n                  required\n                  minLength={20}\n                />\n                <div className=\"mt-2 text-sm text-gray-500\">\n                  {appealReason.length} / 20 characters minimum\n                </div>\n                <div className=\"mt-6 flex gap-3\">\n                  <button\n                    type=\"submit\"\n                    disabled={submitting || appealReason.trim().length < 20}\n                    className=\"btn-base btn-info flex-1 px-6 py-3\"\n                  >\n                    {submitting ? 'Submitting...' : 'Submit Appeal'}\n                  </button>\n                  <button\n                    type=\"button\"\n                    onClick={() => {\n                      setSelectedItem(null);\n                      setAppealReason('');\n                      setError('');\n                    }}\n                    className=\"px-6 py-3 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 transition-colors\"\n                  >\n                    Cancel\n                  </button>\n                </div>\n              </form>\n            )}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":10367,"size_tokens":null},"src/app/api/appeals/submit/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { adminAuth, adminDb } from '@/lib/firebaseAdmin';\nimport { FieldValue } from 'firebase-admin/firestore';\nimport { sendInAppNotification } from '@/utils/notifications/sendInAppNotification';\n\nexport async function POST(request) {\n  try {\n    const authHeader = request.headers.get('Authorization');\n    if (!authHeader?.startsWith('Bearer ')) {\n      return NextResponse.json({ success: false, error: 'Unauthorized' }, { status: 401 });\n    }\n\n    const token = authHeader.split('Bearer ')[1];\n    const decodedToken = await adminAuth.verifyIdToken(token);\n    const userId = decodedToken.uid;\n\n    const body = await request.json();\n    const { type, targetId, reason } = body;\n\n    if (!type || !targetId || !reason) {\n      return NextResponse.json(\n        { success: false, error: 'Missing required fields: type, targetId, reason' },\n        { status: 400 }\n      );\n    }\n\n    if (!['campaign', 'account'].includes(type)) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid appeal type. Must be \"campaign\" or \"account\"' },\n        { status: 400 }\n      );\n    }\n\n    if (reason.trim().length < 20) {\n      return NextResponse.json(\n        { success: false, error: 'Appeal reason must be at least 20 characters' },\n        { status: 400 }\n      );\n    }\n\n    let targetDoc;\n    let appealDeadline;\n\n    if (type === 'campaign') {\n      const campaignRef = adminDb.collection('campaigns').doc(targetId);\n      targetDoc = await campaignRef.get();\n\n      if (!targetDoc.exists) {\n        return NextResponse.json({ success: false, error: 'Campaign not found' }, { status: 404 });\n      }\n\n      const campaignData = targetDoc.data();\n\n      if (campaignData.creatorId !== userId) {\n        return NextResponse.json(\n          { success: false, error: 'You can only appeal your own campaigns' },\n          { status: 403 }\n        );\n      }\n\n      if (campaignData.moderationStatus !== 'removed-temporary') {\n        return NextResponse.json(\n          { success: false, error: 'This campaign is not eligible for appeal' },\n          { status: 400 }\n        );\n      }\n\n      appealDeadline = campaignData.appealDeadline;\n    } else {\n      const userRef = adminDb.collection('users').doc(userId);\n      targetDoc = await userRef.get();\n\n      if (!targetDoc.exists) {\n        return NextResponse.json({ success: false, error: 'User not found' }, { status: 404 });\n      }\n\n      const userData = targetDoc.data();\n\n      if (userData.accountStatus !== 'banned-temporary') {\n        return NextResponse.json(\n          { success: false, error: 'Your account is not eligible for appeal' },\n          { status: 400 }\n        );\n      }\n\n      appealDeadline = userData.appealDeadline;\n    }\n\n    if (!appealDeadline) {\n      return NextResponse.json(\n        { success: false, error: 'No appeal deadline found for this item' },\n        { status: 400 }\n      );\n    }\n\n    const now = new Date();\n    const deadline = appealDeadline.toDate ? appealDeadline.toDate() : new Date(appealDeadline);\n\n    if (now > deadline) {\n      return NextResponse.json(\n        { success: false, error: 'Appeal deadline has passed' },\n        { status: 400 }\n      );\n    }\n\n    const existingAppealsQuery = await adminDb\n      .collection('appeals')\n      .where('userId', '==', userId)\n      .where('targetId', '==', targetId)\n      .where('type', '==', type)\n      .where('status', '==', 'pending')\n      .get();\n\n    if (!existingAppealsQuery.empty) {\n      return NextResponse.json(\n        { success: false, error: 'You have already submitted an appeal for this item' },\n        { status: 400 }\n      );\n    }\n\n    const appealData = {\n      userId,\n      type,\n      targetId,\n      reason: reason.trim(),\n      status: 'pending',\n      submittedAt: new Date(),\n      createdAt: new Date(),\n    };\n\n    const appealRef = await adminDb.collection('appeals').add(appealData);\n\n    if (type === 'campaign') {\n      await adminDb\n        .collection('campaigns')\n        .doc(targetId)\n        .update({\n          appealCount: FieldValue.increment(1),\n        });\n    }\n\n    await sendInAppNotification(userId, {\n      type: 'appealSubmitted',\n      title: ' Appeal Submitted',\n      message: `Your appeal for ${type} removal has been submitted and is under review.`,\n      actionUrl: '/profile/notifications',\n      actionLabel: 'View Notifications',\n    });\n\n    return NextResponse.json({\n      success: true,\n      appealId: appealRef.id,\n      message: 'Appeal submitted successfully',\n    });\n  } catch (error) {\n    console.error('Error submitting appeal:', error);\n    return NextResponse.json(\n      { success: false, error: 'Failed to submit appeal' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":4762,"size_tokens":null},"src/utils/admin/statusTransitionValidator.js":{"content":"/**\n * Status Transition Validator\n * \n * Validates state transitions for campaigns and users to enforce business rules.\n * Prevents invalid transitions like restoring permanently removed/banned content.\n * \n * Updated: October 25, 2025\n * - Added support for 'under-review' as intermediate status\n * - Enforces permanent status restrictions (no transitions out)\n */\n\n/**\n * Valid transitions for campaign moderation statuses\n * \n * Status meanings:\n * - active: Campaign visible to public\n * - under-review: 1-2 reports received, still visible but flagged\n * - under-review-hidden: 3+ reports received, hidden from public\n * - removed-temporary: Admin removed, 30-day appeal window\n * - removed-permanent: Permanent removal, no recovery\n */\nconst VALID_CAMPAIGN_TRANSITIONS = {\n  'active': ['under-review', 'under-review-hidden', 'removed-temporary', 'removed-permanent'],\n  'under-review': ['active', 'under-review-hidden', 'removed-temporary', 'removed-permanent'],\n  'under-review-hidden': ['active', 'under-review', 'removed-temporary', 'removed-permanent'],\n  'removed-temporary': ['active', 'removed-permanent'],\n  'removed-permanent': [], // NO transitions out - truly permanent\n};\n\n/**\n * Valid transitions for user account statuses\n * \n * Status meanings:\n * - active: User can log in, account fully functional\n * - under-review: 1-9 reports received, profile still visible\n * - under-review-hidden: 10+ reports received, profile hidden\n * - banned-temporary: Cannot log in, 30-day appeal window\n * - banned-permanent: Permanent ban, no recovery\n */\nconst VALID_ACCOUNT_TRANSITIONS = {\n  'active': ['under-review', 'under-review-hidden', 'banned-temporary', 'banned-permanent'],\n  'under-review': ['active', 'under-review-hidden', 'banned-temporary', 'banned-permanent'],\n  'under-review-hidden': ['active', 'under-review', 'banned-temporary', 'banned-permanent'],\n  'banned-temporary': ['active', 'banned-permanent'],\n  'banned-permanent': [], // NO transitions out - truly permanent\n};\n\n/**\n * Validates a campaign moderation status transition\n * \n * @param {string} currentStatus - Current moderation status\n * @param {string} newStatus - Desired new status\n * @returns {Object} { valid: boolean, error?: string }\n * \n * @example\n * validateCampaignTransition('active', 'under-review')\n * // Returns: { valid: true }\n * \n * @example\n * validateCampaignTransition('removed-permanent', 'active')\n * // Returns: { valid: false, error: '...' }\n */\nexport function validateCampaignTransition(currentStatus, newStatus) {\n  // If status isn't changing, always allow\n  if (currentStatus === newStatus) {\n    return { valid: true };\n  }\n\n  // Check if current status exists in transition map\n  if (!VALID_CAMPAIGN_TRANSITIONS.hasOwnProperty(currentStatus)) {\n    return { \n      valid: false, \n      error: `Invalid current campaign status: ${currentStatus}` \n    };\n  }\n\n  // Check if transition is allowed\n  if (!VALID_CAMPAIGN_TRANSITIONS[currentStatus].includes(newStatus)) {\n    // Special error message for permanent status\n    if (currentStatus === 'removed-permanent') {\n      return {\n        valid: false,\n        error: 'Cannot restore permanently removed campaigns. Permanent removals are final and cannot be reversed.'\n      };\n    }\n\n    return { \n      valid: false, \n      error: `Invalid transition: Cannot change campaign status from '${currentStatus}' to '${newStatus}'.` \n    };\n  }\n\n  return { valid: true };\n}\n\n/**\n * Validates a user account status transition\n * \n * @param {string} currentStatus - Current account status\n * @param {string} newStatus - Desired new status\n * @returns {Object} { valid: boolean, error?: string }\n * \n * @example\n * validateAccountTransition('active', 'under-review')\n * // Returns: { valid: true }\n * \n * @example\n * validateAccountTransition('banned-permanent', 'active')\n * // Returns: { valid: false, error: '...' }\n */\nexport function validateAccountTransition(currentStatus, newStatus) {\n  // If status isn't changing, always allow\n  if (currentStatus === newStatus) {\n    return { valid: true };\n  }\n\n  // Check if current status exists in transition map\n  if (!VALID_ACCOUNT_TRANSITIONS.hasOwnProperty(currentStatus)) {\n    return { \n      valid: false, \n      error: `Invalid current account status: ${currentStatus}` \n    };\n  }\n\n  // Check if transition is allowed\n  if (!VALID_ACCOUNT_TRANSITIONS[currentStatus].includes(newStatus)) {\n    // Special error message for permanent status\n    if (currentStatus === 'banned-permanent') {\n      return {\n        valid: false,\n        error: 'Cannot unban permanently banned users. Permanent bans are final and cannot be reversed.'\n      };\n    }\n\n    return { \n      valid: false, \n      error: `Invalid transition: Cannot change account status from '${currentStatus}' to '${newStatus}'.` \n    };\n  }\n\n  return { valid: true };\n}\n\n/**\n * Gets list of valid next statuses for a campaign\n * \n * @param {string} currentStatus - Current moderation status\n * @returns {string[]} Array of valid next statuses\n */\nexport function getValidCampaignStatuses(currentStatus) {\n  return VALID_CAMPAIGN_TRANSITIONS[currentStatus] || [];\n}\n\n/**\n * Gets list of valid next statuses for a user account\n * \n * @param {string} currentStatus - Current account status\n * @returns {string[]} Array of valid next statuses\n */\nexport function getValidAccountStatuses(currentStatus) {\n  return VALID_ACCOUNT_TRANSITIONS[currentStatus] || [];\n}\n","path":null,"size_bytes":5433,"size_tokens":null},"src/app/api/admin/appeals/[appealId]/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminDb } from '@/lib/firebaseAdmin';\nimport { sendInAppNotification } from '@/utils/notifications/sendInAppNotification';\nimport { logAdminAction } from '@/utils/logAdminAction';\nimport { validateCampaignTransition, validateAccountTransition } from '@/utils/admin/statusTransitionValidator';\n\nexport async function PATCH(request, { params }) {\n  try {\n    const adminCheck = await requireAdmin(request);\n    if (adminCheck.error) {\n      return NextResponse.json({ success: false, error: adminCheck.error }, { status: adminCheck.status });\n    }\n\n    const { appealId } = params;\n    const body = await request.json();\n    const { action, adminNotes } = body;\n\n    if (!['approve', 'reject'].includes(action)) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid action. Must be \"approve\" or \"reject\"' },\n        { status: 400 }\n      );\n    }\n\n    const appealRef = adminDb.collection('appeals').doc(appealId);\n    const appealDoc = await appealRef.get();\n\n    if (!appealDoc.exists()) {\n      return NextResponse.json({ success: false, error: 'Appeal not found' }, { status: 404 });\n    }\n\n    const appealData = appealDoc.data();\n\n    if (appealData.status !== 'pending') {\n      return NextResponse.json(\n        { success: false, error: 'This appeal has already been reviewed' },\n        { status: 400 }\n      );\n    }\n\n    const adminUid = adminCheck.user.uid;\n    const adminEmail = adminCheck.user.email || 'admin';\n    \n    // Get admin user data for complete audit trail\n    const adminUserDoc = await adminDb.collection('users').doc(adminUid).get();\n    const adminUserData = adminUserDoc.exists ? adminUserDoc.data() : null;\n    const adminName = adminUserData?.displayName || adminUserData?.username || adminEmail;\n    \n    const now = new Date();\n\n    if (action === 'approve') {\n      if (appealData.type === 'campaign') {\n        const campaignRef = adminDb.collection('campaigns').doc(appealData.targetId);\n        const campaignDoc = await campaignRef.get();\n\n        if (campaignDoc.exists()) {\n          const campaignData = campaignDoc.data();\n          const currentStatus = campaignData.moderationStatus || 'active';\n          \n          // Validate transition to active\n          const validation = validateCampaignTransition(currentStatus, 'active');\n          if (!validation.valid) {\n            return NextResponse.json(\n              { success: false, error: validation.error },\n              { status: 400 }\n            );\n          }\n          \n          await campaignRef.update({\n            moderationStatus: 'active',\n            removedAt: null,\n            removalReason: null,\n            appealDeadline: null,\n            reportsCount: 0,\n            hiddenAt: null,\n            updatedAt: now,\n          });\n\n\n          await sendInAppNotification(appealData.userId, {\n            type: 'appealApproved',\n            title: ' Appeal Approved',\n            message: `Your appeal for campaign \"${campaignData.title}\" has been approved and your campaign has been restored.`,\n            actionUrl: `/campaign/${campaignData.slug}`,\n            actionLabel: 'View Campaign',\n          });\n\n          await logAdminAction({\n            adminId: adminUid,\n            adminEmail: adminEmail,\n            adminName: adminName,\n            action: 'appeal_approved',\n            targetType: 'campaign',\n            targetId: appealData.targetId,\n            reason: `Approved appeal: ${appealData.reason.substring(0, 100)}`,\n            notes: adminNotes || 'Appeal approved',\n          });\n        }\n      } else {\n        const userRef = adminDb.collection('users').doc(appealData.targetId);\n        const userDoc = await userRef.get();\n\n        if (userDoc.exists()) {\n          const userData = userDoc.data();\n          const currentStatus = userData.accountStatus || 'active';\n          \n          // Validate transition to active\n          const validation = validateAccountTransition(currentStatus, 'active');\n          if (!validation.valid) {\n            return NextResponse.json(\n              { success: false, error: validation.error },\n              { status: 400 }\n            );\n          }\n          \n          await userRef.update({\n            accountStatus: 'active',\n            bannedAt: null,\n            banReason: null,\n            appealDeadline: null,\n            reportsCount: 0,\n            hiddenAt: null,\n            updatedAt: now,\n          });\n\n\n          await sendInAppNotification(appealData.userId, {\n            type: 'appealApproved',\n            title: ' Appeal Approved',\n            message: 'Your appeal has been approved and your account has been restored. Welcome back!',\n            actionUrl: '/profile',\n            actionLabel: 'View Profile',\n          });\n\n          await logAdminAction({\n            adminId: adminUid,\n            adminEmail: adminEmail,\n            adminName: adminName,\n            action: 'appeal_approved',\n            targetType: 'user',\n            targetId: appealData.targetId,\n            reason: `Approved appeal: ${appealData.reason.substring(0, 100)}`,\n            notes: adminNotes || 'Appeal approved',\n          });\n        }\n      }\n    } else {\n      if (appealData.type === 'campaign') {\n        const campaignRef = adminDb.collection('campaigns').doc(appealData.targetId);\n        const campaignDoc = await campaignRef.get();\n\n        if (campaignDoc.exists()) {\n          const campaignData = campaignDoc.data();\n          const currentStatus = campaignData.moderationStatus || 'active';\n          \n          // Validate transition to removed-permanent\n          const validation = validateCampaignTransition(currentStatus, 'removed-permanent');\n          if (!validation.valid) {\n            return NextResponse.json(\n              { success: false, error: validation.error },\n              { status: 400 }\n            );\n          }\n          \n          await campaignRef.update({\n            moderationStatus: 'removed-permanent',\n            appealDeadline: null,\n            updatedAt: now,\n          });\n\n\n          await sendInAppNotification(appealData.userId, {\n            type: 'appealRejected',\n            title: ' Appeal Rejected',\n            message: `Your appeal for campaign \"${campaignData.title}\" has been reviewed and rejected. The removal is now permanent.`,\n            actionUrl: '/profile',\n            actionLabel: 'View Profile',\n          });\n\n          await logAdminAction({\n            adminId: adminUid,\n            adminEmail: adminEmail,\n            adminName: adminName,\n            action: 'appeal_rejected',\n            targetType: 'campaign',\n            targetId: appealData.targetId,\n            reason: `Rejected appeal: ${appealData.reason.substring(0, 100)}`,\n            notes: adminNotes || 'Appeal rejected',\n          });\n        }\n      } else {\n        const userRef = adminDb.collection('users').doc(appealData.targetId);\n        const userDoc = await userRef.get();\n\n        if (userDoc.exists()) {\n          const userData = userDoc.data();\n          const currentStatus = userData.accountStatus || 'active';\n          \n          // Validate transition to banned-permanent\n          const validation = validateAccountTransition(currentStatus, 'banned-permanent');\n          if (!validation.valid) {\n            return NextResponse.json(\n              { success: false, error: validation.error },\n              { status: 400 }\n            );\n          }\n          \n          await userRef.update({\n            accountStatus: 'banned-permanent',\n            appealDeadline: null,\n            updatedAt: now,\n          });\n\n          await sendInAppNotification(appealData.userId, {\n            type: 'appealRejected',\n            title: ' Appeal Rejected',\n            message: 'Your appeal has been reviewed and rejected. Your account ban is now permanent.',\n            actionUrl: '/profile',\n            actionLabel: 'View Profile',\n          });\n\n          await logAdminAction({\n            adminId: adminUid,\n            adminEmail: adminEmail,\n            adminName: adminName,\n            action: 'appeal_rejected',\n            targetType: 'user',\n            targetId: appealData.targetId,\n            reason: `Rejected appeal: ${appealData.reason.substring(0, 100)}`,\n            notes: adminNotes || 'Appeal rejected',\n          });\n        }\n      }\n    }\n\n    await appealRef.update({\n      status: action === 'approve' ? 'approved' : 'rejected',\n      reviewedAt: now,\n      reviewedBy: adminUid,\n      adminNotes: adminNotes || null,\n    });\n\n    return NextResponse.json({\n      success: true,\n      message: `Appeal ${action}d successfully`,\n    });\n  } catch (error) {\n    console.error('Error processing appeal:', error);\n    return NextResponse.json(\n      { error: 'Failed to process appeal', details: error.message },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":8992,"size_tokens":null},"src/app/(chrome)/admin/appeals/page.js":{"content":"'use client';\n\nimport { useState } from 'react';\nimport Image from 'next/image';\nimport { useAuth } from '@/hooks/useAuth';\nimport { formatTimestamp } from '@/utils/admin/adminHelpers';\nimport ErrorBoundary from '@/components/ErrorBoundary';\n\nexport default function AdminAppealsPage() {\n  return (\n    <ErrorBoundary>\n      <AdminAppealsContent />\n    </ErrorBoundary>\n  );\n}\n\nfunction AdminAppealsContent() {\n  const { user } = useAuth();\n  const [appeals, setAppeals] = useState([]);\n  const [loading, setLoading] = useState(false);\n  const [loadingMore, setLoadingMore] = useState(false);\n  const [hasMore, setHasMore] = useState(true);\n  const [processing, setProcessing] = useState(null);\n  const [filters, setFilters] = useState({\n    status: 'pending',\n    type: 'all',\n    limit: 10,\n  });\n  const [selectedAppeal, setSelectedAppeal] = useState(null);\n  const [showActionModal, setShowActionModal] = useState(false);\n  const [actionType, setActionType] = useState(null);\n  const [adminNotes, setAdminNotes] = useState('');\n  const [confirmText, setConfirmText] = useState('');\n  const [error, setError] = useState('');\n\n  const fetchAppeals = async (isLoadMore = false) => {\n    if (!user) return;\n\n    try {\n      if (isLoadMore) {\n        setLoadingMore(true);\n      } else {\n        setLoading(true);\n      }\n      setError('');\n      \n      const token = await user.getIdToken();\n      const params = new URLSearchParams(filters);\n\n      const response = await fetch(`/api/admin/appeals?${params}`, {\n        headers: { Authorization: `Bearer ${token}` },\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to fetch appeals');\n      }\n\n      const data = await response.json();\n      const newAppeals = data.appeals || [];\n      setAppeals(newAppeals);\n      setHasMore(newAppeals.length === filters.limit);\n    } catch (err) {\n      console.error('Error fetching appeals:', err);\n      setError('Failed to load appeals');\n    } finally {\n      setLoading(false);\n      setLoadingMore(false);\n    }\n  };\n\n  const handleLoadMore = () => {\n    setFilters(prev => ({ ...prev, limit: prev.limit + 10 }));\n    setTimeout(() => fetchAppeals(true), 0);\n  };\n\n  const handleAction = async () => {\n    if (!selectedAppeal || !actionType) return;\n\n    if (confirmText !== 'CONFIRM') {\n      setError('Please type CONFIRM to proceed');\n      return;\n    }\n\n    try {\n      setProcessing(selectedAppeal.id);\n      setError('');\n\n      const token = await user.getIdToken();\n\n      const response = await fetch(`/api/admin/appeals/${selectedAppeal.id}`, {\n        method: 'PATCH',\n        headers: {\n          'Content-Type': 'application/json',\n          Authorization: `Bearer ${token}`,\n        },\n        body: JSON.stringify({\n          action: actionType,\n          adminNotes,\n        }),\n      });\n\n      if (!response.ok) {\n        const data = await response.json();\n        throw new Error(data.error || 'Failed to process appeal');\n      }\n\n      setShowActionModal(false);\n      setSelectedAppeal(null);\n      setActionType(null);\n      setAdminNotes('');\n      setConfirmText('');\n      \n      fetchAppeals();\n    } catch (err) {\n      console.error('Error processing appeal:', err);\n      setError(err.message || 'Failed to process appeal');\n    } finally {\n      setProcessing(null);\n    }\n  };\n\n  const openActionModal = (appeal, action) => {\n    setSelectedAppeal(appeal);\n    setActionType(action);\n    setShowActionModal(true);\n    setError('');\n    setConfirmText('');\n    setAdminNotes('');\n  };\n\n  const getStatusBadge = (status) => {\n    const styles = {\n      pending: 'bg-yellow-100 text-yellow-800',\n      approved: 'bg-green-100 text-green-800',\n      rejected: 'bg-red-100 text-red-800',\n    };\n\n    return (\n      <span className={`px-2 py-1 rounded-full text-xs font-semibold ${styles[status] || 'bg-gray-100 text-gray-800'}`}>\n        {status.charAt(0).toUpperCase() + status.slice(1)}\n      </span>\n    );\n  };\n\n  const getTypeBadge = (type) => {\n    const styles = {\n      campaign: 'bg-blue-100 text-blue-800',\n      account: 'bg-purple-100 text-purple-800',\n    };\n\n    return (\n      <span className={`px-2 py-1 rounded-full text-xs font-semibold ${styles[type] || 'bg-gray-100 text-gray-800'}`}>\n        {type.charAt(0).toUpperCase() + type.slice(1)}\n      </span>\n    );\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"bg-white rounded-lg shadow p-6\">\n        <h2 className=\"text-lg font-semibold text-gray-900 mb-4\">Load Appeals</h2>\n        <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n          <div>\n            <label htmlFor=\"status-filter\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Status\n            </label>\n            <select\n              id=\"status-filter\"\n              value={filters.status}\n              onChange={(e) => setFilters({ ...filters, status: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n            >\n              <option value=\"all\" className=\"text-gray-900\">All</option>\n              <option value=\"pending\" className=\"text-gray-900\">Pending</option>\n              <option value=\"approved\" className=\"text-gray-900\">Approved</option>\n              <option value=\"rejected\" className=\"text-gray-900\">Rejected</option>\n            </select>\n          </div>\n\n          <div>\n            <label htmlFor=\"type-filter\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Type\n            </label>\n            <select\n              id=\"type-filter\"\n              value={filters.type}\n              onChange={(e) => setFilters({ ...filters, type: e.target.value })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n            >\n              <option value=\"all\" className=\"text-gray-900\">All</option>\n              <option value=\"campaign\" className=\"text-gray-900\">Campaign</option>\n              <option value=\"account\" className=\"text-gray-900\">Account</option>\n            </select>\n          </div>\n\n          <div>\n            <label htmlFor=\"limit-input\" className=\"block text-sm font-medium text-gray-700 mb-2\">\n              Number of Appeals\n            </label>\n            <input\n              id=\"limit-input\"\n              type=\"number\"\n              min=\"1\"\n              max=\"100\"\n              value={filters.limit}\n              onChange={(e) => setFilters({ ...filters, limit: parseInt(e.target.value) || 10 })}\n              className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-emerald-500 text-gray-900 bg-white\"\n              placeholder=\"10\"\n            />\n          </div>\n\n          <div className=\"flex items-end\">\n            <button\n              onClick={fetchAppeals}\n              disabled={loading || !user}\n              className=\"w-full px-6 py-2 bg-emerald-600 text-white font-medium rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors\"\n            >\n              {loading ? (\n                <span className=\"flex items-center justify-center\">\n                  <svg className=\"animate-spin -ml-1 mr-2 h-4 w-4 text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                  </svg>\n                  Loading...\n                </span>\n              ) : (\n                'Load Appeals'\n              )}\n            </button>\n          </div>\n        </div>\n        {appeals.length > 0 && (\n          <div className=\"mt-4 text-sm text-gray-600\">\n            Showing <span className=\"font-semibold\">{appeals.length}</span> appeal{appeals.length !== 1 ? 's' : ''}\n          </div>\n        )}\n      </div>\n\n      {error && (\n        <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\n          <p className=\"text-red-800\">{error}</p>\n        </div>\n      )}\n\n      <div className=\"bg-white rounded-lg shadow overflow-hidden\">\n        {appeals.length === 0 ? (\n          <div className=\"p-8 text-center\">\n            <svg\n              className=\"mx-auto h-12 w-12 text-gray-400\"\n              fill=\"none\"\n              stroke=\"currentColor\"\n              viewBox=\"0 0 24 24\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"\n              />\n            </svg>\n            <h3 className=\"mt-2 text-sm font-medium text-gray-900\">No appeals found</h3>\n            <p className=\"mt-1 text-sm text-gray-500\">No appeals match your current filters.</p>\n          </div>\n        ) : (\n          <div className=\"overflow-x-auto\">\n            <table className=\"w-full\">\n              <thead className=\"bg-gray-50 border-b border-gray-200\">\n                <tr>\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">User</th>\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Type</th>\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Target</th>\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Reason</th>\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Status</th>\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Submitted</th>\n                  <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">Actions</th>\n                </tr>\n              </thead>\n              <tbody className=\"divide-y divide-gray-200\">\n                {appeals.map((appeal) => (\n                  <tr key={appeal.id} className=\"hover:bg-gray-50\">\n                    <td className=\"px-6 py-4\">\n                      <div className=\"flex items-center\">\n                        {appeal.userInfo?.profileImage ? (\n                          <div className=\"relative w-10 h-10 rounded-full mr-3 overflow-hidden\">\n                            <Image\n                              src={appeal.userInfo.profileImage}\n                              alt={appeal.userInfo.username}\n                              fill\n                              className=\"object-cover\"\n                              unoptimized\n                            />\n                          </div>\n                        ) : (\n                          <div className=\"w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center mr-3 text-sm font-semibold\">\n                            {appeal.userInfo?.username?.charAt(0) || 'U'}\n                          </div>\n                        )}\n                        <div>\n                          <div className=\"font-medium text-gray-900\">{appeal.userInfo?.displayName || 'Unknown'}</div>\n                          <div className=\"text-sm text-gray-500\">@{appeal.userInfo?.username || 'unknown'}</div>\n                        </div>\n                      </div>\n                    </td>\n                    <td className=\"px-6 py-4\">{getTypeBadge(appeal.type)}</td>\n                    <td className=\"px-6 py-4\">\n                      {appeal.type === 'campaign' ? (\n                        <div className=\"flex items-center\">\n                          {appeal.targetInfo?.imageUrl && (\n                            <div className=\"relative w-12 h-12 rounded mr-3 overflow-hidden flex-shrink-0\">\n                              <Image\n                                src={appeal.targetInfo.imageUrl}\n                                alt={appeal.targetInfo.title}\n                                fill\n                                className=\"object-cover\"\n                                unoptimized\n                              />\n                            </div>\n                          )}\n                          <div>\n                            <div className=\"font-medium\">{appeal.targetInfo?.title || '[Deleted]'}</div>\n                            {appeal.targetInfo?.removalReason && (\n                              <div className=\"text-xs text-gray-500\">Reason: {appeal.targetInfo.removalReason}</div>\n                            )}\n                          </div>\n                        </div>\n                      ) : (\n                        <div>\n                          <div className=\"font-medium\">Account: @{appeal.targetInfo?.username || '[Deleted]'}</div>\n                          {appeal.targetInfo?.banReason && (\n                            <div className=\"text-xs text-gray-500\">Reason: {appeal.targetInfo.banReason}</div>\n                          )}\n                        </div>\n                      )}\n                    </td>\n                    <td className=\"px-6 py-4\">\n                      <div className=\"text-sm text-gray-900 max-w-xs truncate\" title={appeal.reason}>\n                        {appeal.reason}\n                      </div>\n                    </td>\n                    <td className=\"px-6 py-4\">{getStatusBadge(appeal.status)}</td>\n                    <td className=\"px-6 py-4 text-sm text-gray-600\">\n                      {formatTimestamp(appeal.submittedAt)}\n                    </td>\n                    <td className=\"px-6 py-4\">\n                      {appeal.status === 'pending' ? (\n                        <div className=\"flex gap-2\">\n                          <button\n                            onClick={() => openActionModal(appeal, 'approve')}\n                            disabled={processing === appeal.id}\n                            className=\"px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700 disabled:bg-gray-300 transition-colors\"\n                          >\n                            Approve\n                          </button>\n                          <button\n                            onClick={() => openActionModal(appeal, 'reject')}\n                            disabled={processing === appeal.id}\n                            className=\"px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700 disabled:bg-gray-300 transition-colors\"\n                          >\n                            Reject\n                          </button>\n                        </div>\n                      ) : (\n                        <span className=\"text-sm text-gray-500\">\n                          {appeal.status === 'approved' ? 'Approved' : 'Rejected'}\n                          {appeal.reviewedAt && ` on ${formatTimestamp(appeal.reviewedAt)}`}\n                        </span>\n                      )}\n                    </td>\n                  </tr>\n                ))}\n              </tbody>\n            </table>\n          </div>\n        )}\n      </div>\n\n      {appeals.length > 0 && hasMore && !loading && (\n        <div className=\"bg-white rounded-lg shadow p-6 text-center\">\n          <button\n            onClick={handleLoadMore}\n            disabled={loadingMore}\n            className=\"px-8 py-3 bg-emerald-600 text-white font-medium rounded-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors\"\n          >\n            {loadingMore ? (\n              <span className=\"flex items-center justify-center\">\n                <svg className=\"animate-spin -ml-1 mr-2 h-4 w-4 text-white\" fill=\"none\" viewBox=\"0 0 24 24\">\n                  <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"4\"></circle>\n                  <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z\"></path>\n                </svg>\n                Loading More...\n              </span>\n            ) : (\n              'Load More (10 items)'\n            )}\n          </button>\n        </div>\n      )}\n\n      {showActionModal && selectedAppeal && (\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\n          <div className=\"bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\n            <div className=\"p-6\">\n              <h2 className=\"text-xl font-bold text-gray-900 mb-4\">\n                {actionType === 'approve' ? 'Approve' : 'Reject'} Appeal\n              </h2>\n\n              <div className=\"bg-gray-50 rounded-lg p-4 mb-4\">\n                <div className=\"mb-2\">\n                  <span className=\"font-medium\">User:</span> @{selectedAppeal.userInfo?.username}\n                </div>\n                <div className=\"mb-2\">\n                  <span className=\"font-medium\">Type:</span> {selectedAppeal.type}\n                </div>\n                <div className=\"mb-2\">\n                  <span className=\"font-medium\">Appeal Reason:</span>\n                  <p className=\"mt-1 text-sm text-gray-700 whitespace-pre-wrap\">{selectedAppeal.reason}</p>\n                </div>\n              </div>\n\n              <div className=\"mb-4\">\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  Admin Notes (Optional)\n                </label>\n                <textarea\n                  value={adminNotes}\n                  onChange={(e) => setAdminNotes(e.target.value)}\n                  placeholder=\"Add any notes about this decision...\"\n                  rows={3}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500\"\n                />\n              </div>\n\n              <div className=\"bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4\">\n                <p className=\"text-sm text-yellow-800 mb-2\">\n                  <strong>Warning:</strong> This action will:\n                </p>\n                <ul className=\"text-sm text-yellow-800 list-disc list-inside space-y-1\">\n                  {actionType === 'approve' ? (\n                    <>\n                      <li>Restore the {selectedAppeal.type} to active status</li>\n                      <li>Clear all removal/ban data</li>\n                      <li>Send approval notification to the user</li>\n                    </>\n                  ) : (\n                    <>\n                      <li>Set the {selectedAppeal.type} to permanent removal/ban</li>\n                      <li>Prevent any future appeals</li>\n                      <li>Send rejection notification to the user</li>\n                    </>\n                  )}\n                </ul>\n              </div>\n\n              <div className=\"mb-4\">\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  Type <span className=\"font-mono bg-gray-200 px-2 py-1 rounded\">CONFIRM</span> to proceed:\n                </label>\n                <input\n                  type=\"text\"\n                  value={confirmText}\n                  onChange={(e) => setConfirmText(e.target.value)}\n                  placeholder=\"Type CONFIRM\"\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500\"\n                />\n              </div>\n\n              {error && (\n                <div className=\"bg-red-50 border border-red-200 rounded-lg p-3 mb-4\">\n                  <p className=\"text-sm text-red-800\">{error}</p>\n                </div>\n              )}\n\n              <div className=\"flex gap-3\">\n                <button\n                  onClick={handleAction}\n                  disabled={confirmText !== 'CONFIRM' || processing}\n                  className={`flex-1 px-4 py-2 rounded-lg font-semibold transition-colors ${\n                    actionType === 'approve'\n                      ? 'bg-green-600 hover:bg-green-700 text-white'\n                      : 'bg-red-600 hover:bg-red-700 text-white'\n                  } disabled:bg-gray-300 disabled:cursor-not-allowed`}\n                >\n                  {processing ? 'Processing...' : `Confirm ${actionType === 'approve' ? 'Approval' : 'Rejection'}`}\n                </button>\n                <button\n                  onClick={() => {\n                    setShowActionModal(false);\n                    setSelectedAppeal(null);\n                    setActionType(null);\n                    setAdminNotes('');\n                    setConfirmText('');\n                    setError('');\n                  }}\n                  disabled={processing}\n                  className=\"px-4 py-2 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 transition-colors disabled:opacity-50\"\n                >\n                  Cancel\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":21410,"size_tokens":null},"src/app/api/appeals/eligible/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { adminAuth, adminDb } from '@/lib/firebaseAdmin';\n\nexport async function GET(request) {\n  try {\n    const authHeader = request.headers.get('Authorization');\n    if (!authHeader?.startsWith('Bearer ')) {\n      return NextResponse.json({ success: false, error: 'Unauthorized' }, { status: 401 });\n    }\n\n    const token = authHeader.split('Bearer ')[1];\n    const decodedToken = await adminAuth.verifyIdToken(token);\n    const userId = decodedToken.uid;\n\n    const items = [];\n\n    const campaignsSnapshot = await adminDb\n      .collection('campaigns')\n      .where('creatorId', '==', userId)\n      .where('moderationStatus', '==', 'removed-temporary')\n      .get();\n\n    campaignsSnapshot.forEach((doc) => {\n      const data = doc.data();\n      if (data.appealDeadline) {\n        items.push({\n          type: 'campaign',\n          id: doc.id,\n          title: data.title,\n          imageUrl: data.imageUrl,\n          removalReason: data.removalReason,\n          appealDeadline: data.appealDeadline,\n          appealCount: data.appealCount || 0,\n        });\n      }\n    });\n\n    const userDoc = await adminDb.collection('users').doc(userId).get();\n    if (userDoc.exists()) {\n      const userData = userDoc.data();\n      if (\n        userData.accountStatus === 'banned-temporary' &&\n        userData.appealDeadline\n      ) {\n        items.push({\n          type: 'account',\n          id: userId,\n          title: 'Your Account',\n          banReason: userData.banReason,\n          appealDeadline: userData.appealDeadline,\n        });\n      }\n    }\n\n    return NextResponse.json({ success: true, items });\n  } catch (error) {\n    console.error('Error fetching eligible items:', error);\n    return NextResponse.json(\n      { success: false, error: 'Failed to fetch eligible items' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":1865,"size_tokens":null},"src/app/api/cron/send-appeal-reminders/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { adminDb } from '@/lib/firebaseAdmin';\nimport { sendEmail } from '@/utils/notifications/sendEmail';\nimport { getEmailTemplate } from '@/utils/notifications/emailTemplates';\nimport { sendInAppNotification } from '@/utils/notifications/sendInAppNotification';\n\nexport const dynamic = 'force-dynamic';\nexport const maxDuration = 60;\n\nexport async function GET(request) {\n  try {\n    const authHeader = request.headers.get('authorization');\n    \n    if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {\n      return NextResponse.json(\n        { success: false, error: 'Unauthorized' },\n        { status: 401 }\n      );\n    }\n\n    const now = new Date();\n    const remindersProcessed = {\n      campaigns: { day7: 0, day3: 0, day1: 0 },\n      users: { day7: 0, day3: 0, day1: 0 },\n    };\n    const errors = [];\n\n    const reminderDays = [7, 3, 1];\n\n    for (const daysLeft of reminderDays) {\n      const targetDate = new Date();\n      targetDate.setDate(targetDate.getDate() + daysLeft);\n      targetDate.setHours(0, 0, 0, 0);\n      \n      const nextDay = new Date(targetDate);\n      nextDay.setDate(nextDay.getDate() + 1);\n\n      const campaignsSnapshot = await adminDb\n        .collection('campaigns')\n        .where('moderationStatus', '==', 'removed-temporary')\n        .where('appealDeadline', '>=', targetDate)\n        .where('appealDeadline', '<', nextDay)\n        .get();\n\n      for (const doc of campaignsSnapshot.docs) {\n        try {\n          const campaign = doc.data();\n          \n          // Validate campaign fields\n          const campaignTitle = campaign.title || 'Your campaign';\n          const removalReason = campaign.removalReason || 'Community guidelines violation';\n          \n          const creatorDoc = await adminDb.collection('users').doc(campaign.creatorId).get();\n          const creator = creatorDoc.data();\n\n          if (creator) {\n            // For campaign removals: Send ONLY in-app notification (creator can log in)\n            // No email needed - they can see the notification when they log in\n            await sendInAppNotification(campaign.creatorId, {\n              type: 'appealDeadlineReminder',\n              title: ' Appeal Deadline Reminder',\n              message: `You have ${daysLeft} day${daysLeft > 1 ? 's' : ''} left to appeal the removal of your campaign \"${campaignTitle}\". Don't miss the deadline!`,\n              actionUrl: '/profile/appeals',\n              actionLabel: 'Submit Appeal',\n            });\n\n            remindersProcessed.campaigns[`day${daysLeft}`]++;\n          }\n        } catch (error) {\n          console.error(`Error sending reminder for campaign ${doc.id}:`, error);\n          errors.push({ campaignId: doc.id, error: error.message });\n        }\n      }\n\n      const usersSnapshot = await adminDb\n        .collection('users')\n        .where('accountStatus', '==', 'banned-temporary')\n        .where('appealDeadline', '>=', targetDate)\n        .where('appealDeadline', '<', nextDay)\n        .get();\n\n      for (const doc of usersSnapshot.docs) {\n        try {\n          const user = doc.data();\n\n          if (user.email) {\n            const emailTemplate = getEmailTemplate('appealReminder', {\n              userEmail: user.email,\n              username: user.username || user.displayName || 'User',\n              daysLeft,\n              itemType: 'account ban',\n              itemName: 'your account',\n              removalReason: user.banReason || 'Community guidelines violation',\n            });\n\n            await sendEmail({\n              to: user.email,\n              subject: emailTemplate.subject,\n              html: emailTemplate.html,\n            });\n\n            remindersProcessed.users[`day${daysLeft}`]++;\n          }\n        } catch (error) {\n          console.error(`Error sending reminder for user ${doc.id}:`, error);\n          errors.push({ userId: doc.id, error: error.message });\n        }\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      remindersProcessed,\n      errors: errors.length > 0 ? errors : undefined,\n      executedAt: now.toISOString(),\n    });\n  } catch (error) {\n    console.error('Cron job error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error', details: error.message },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":4337,"size_tokens":null},"src/app/api/cron/cleanup-expired-appeals/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { adminDb } from '@/lib/firebaseAdmin';\nimport { FieldValue } from 'firebase-admin/firestore';\nimport { logAdminAction } from '@/utils/logAdminAction';\nimport { sendInAppNotification } from '@/utils/notifications/sendInAppNotification';\nimport { sendEmail } from '@/utils/notifications/sendEmail';\nimport { getEmailTemplate } from '@/utils/notifications/emailTemplates';\n\nexport const dynamic = 'force-dynamic';\nexport const maxDuration = 60;\n\nexport async function GET(request) {\n  try {\n    const authHeader = request.headers.get('authorization');\n    \n    if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {\n      return NextResponse.json(\n        { success: false, error: 'Unauthorized' },\n        { status: 401 }\n      );\n    }\n\n    const now = new Date();\n    let campaignsProcessed = 0;\n    let usersProcessed = 0;\n    const errors = [];\n\n    const campaignsSnapshot = await adminDb\n      .collection('campaigns')\n      .where('moderationStatus', '==', 'removed-temporary')\n      .get();\n\n    for (const doc of campaignsSnapshot.docs) {\n      try {\n        const campaign = doc.data();\n        \n        // Validate campaign fields\n        const campaignTitle = campaign.title || `Campaign ${doc.id}`;\n        \n        // Safely handle appealDeadline conversion\n        if (campaign.appealDeadline) {\n          let deadline;\n          try {\n            deadline = campaign.appealDeadline.toDate \n              ? campaign.appealDeadline.toDate() \n              : new Date(campaign.appealDeadline);\n          } catch (conversionError) {\n            console.error(`Invalid appealDeadline format for campaign ${doc.id}:`, conversionError);\n            errors.push({ campaignId: doc.id, error: 'Invalid appealDeadline format' });\n            continue;\n          }\n          \n          if (deadline < now) {\n            await doc.ref.update({\n              moderationStatus: 'removed-permanent',\n              appealDeadline: FieldValue.delete(),\n              appealCount: FieldValue.delete(),\n              updatedAt: FieldValue.serverTimestamp(),\n            });\n\n            await sendInAppNotification(campaign.creatorId, {\n              type: 'campaignPermanentlyRemoved',\n              title: ' Campaign Permanently Removed',\n              message: `Your campaign \"${campaignTitle}\" has been permanently removed. The 30-day appeal window has expired.`,\n              actionUrl: '/profile',\n              actionLabel: 'View Profile',\n            });\n\n            await logAdminAction({\n              adminId: 'system',\n              adminEmail: 'system@twibbonize.com',\n              action: 'auto_permanent_removal',\n              targetType: 'campaign',\n              targetId: doc.id,\n              targetTitle: campaignTitle,\n              reason: 'Appeal deadline expired - auto-upgraded to permanent removal',\n            });\n\n            campaignsProcessed++;\n          }\n        }\n      } catch (error) {\n        console.error(`Error processing campaign ${doc.id}:`, error);\n        errors.push({ campaignId: doc.id, error: error.message });\n      }\n    }\n\n    const usersSnapshot = await adminDb\n      .collection('users')\n      .where('accountStatus', '==', 'banned-temporary')\n      .get();\n\n    for (const doc of usersSnapshot.docs) {\n      try {\n        const user = doc.data();\n        \n        // Validate user fields\n        const username = user.username || user.displayName || `User ${doc.id}`;\n        const banReason = user.banReason || 'Community guidelines violation';\n        \n        // Safely handle appealDeadline conversion\n        if (user.appealDeadline) {\n          let deadline;\n          try {\n            deadline = user.appealDeadline.toDate \n              ? user.appealDeadline.toDate() \n              : new Date(user.appealDeadline);\n          } catch (conversionError) {\n            console.error(`Invalid appealDeadline format for user ${doc.id}:`, conversionError);\n            errors.push({ userId: doc.id, error: 'Invalid appealDeadline format' });\n            continue;\n          }\n          \n          if (deadline < now) {\n            await doc.ref.update({\n              accountStatus: 'banned-permanent',\n              appealDeadline: FieldValue.delete(),\n              updatedAt: FieldValue.serverTimestamp(),\n            });\n\n            if (user.email) {\n              const emailTemplate = getEmailTemplate('accountBanned', {\n                userEmail: user.email,\n                username: username,\n                banReason: banReason,\n                isPermanent: true,\n              });\n\n              await sendEmail({\n                to: user.email,\n                subject: emailTemplate.subject,\n                html: emailTemplate.html,\n              });\n            }\n\n            await logAdminAction({\n              adminId: 'system',\n              adminEmail: 'system@twibbonize.com',\n              action: 'auto_permanent_ban',\n              targetType: 'user',\n              targetId: doc.id,\n              targetTitle: username,\n              reason: 'Appeal deadline expired - auto-upgraded to permanent ban',\n            });\n\n            usersProcessed++;\n          }\n        }\n      } catch (error) {\n        console.error(`Error processing user ${doc.id}:`, error);\n        errors.push({ userId: doc.id, error: error.message });\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      processed: {\n        campaigns: campaignsProcessed,\n        users: usersProcessed,\n      },\n      errors: errors.length > 0 ? errors : undefined,\n      executedAt: now.toISOString(),\n    });\n  } catch (error) {\n    console.error('Cron job error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error', details: error.message },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":5827,"size_tokens":null},"VERCEL_CRON_SETUP.md":{"content":"# Vercel Cron Jobs Setup Guide\n\nThis document explains how to set up two automated cron jobs for the Twibbonize moderation system on Vercel.\n\n---\n\n## Overview of Cron Jobs\n\nYour project uses **2 Vercel Cron Jobs** (maximum on free tier):\n\n### 1. Cleanup Expired Appeals (Critical)\n- **Path:** `/api/cron/cleanup-expired-appeals`\n- **Schedule:** Daily at 2:00 AM (`0 2 * * *`)\n- **Purpose:** Automatically upgrades expired temporary removals/bans to permanent status\n- **Actions:**\n  - Finds campaigns with `removed-temporary` status and expired `appealDeadline`\n  - Finds users with `banned-temporary` status and expired `appealDeadline`\n  - Upgrades to `removed-permanent` or `banned-permanent`\n  - Sends in-app notification for campaigns (users can still log in)\n  - Sends email notification for permanent bans (users cannot log in)\n  - Logs all actions to adminLogs collection\n\n### 2. Send Appeal Deadline Reminders (Important)\n- **Path:** `/api/cron/send-appeal-reminders`\n- **Schedule:** Daily at 10:00 AM (`0 10 * * *`)\n- **Purpose:** Sends reminders to users about upcoming appeal deadlines\n- **Actions:**\n  - Checks for appeals expiring in 7, 3, and 1 days\n  - Sends both in-app notifications and email reminders\n  - Includes countdown timer and direct appeal link\n  - Helps users avoid missing their appeal window\n\n---\n\n## Setup Instructions\n\nFollow these steps to configure both cron jobs on Vercel.\n\n### Step 1: Generate a CRON_SECRET\n\nGenerate a random secret string to secure your cron endpoints:\n\n```bash\n# On Linux/Mac\nopenssl rand -base64 32\n\n# Or use an online generator\n# Visit: https://www.random.org/strings/\n```\n\nCopy the generated string (keep it secret and secure).\n\n---\n\n### Step 2: Add Environment Variables on Vercel\n\n1. Go to your Vercel project dashboard: `https://vercel.com/your-username/your-project`\n2. Navigate to **Settings**  **Environment Variables**\n3. Add the following variable:\n\n   | Name | Value | Environment |\n   |------|-------|-------------|\n   | `CRON_SECRET` | (Your generated secret) | Production |\n\n4. Click **Save**\n\n**Important:** You should also have these email-related variables already set:\n- `MAILERSEND_API_KEY` (for sending emails)\n- `NEXT_PUBLIC_BASE_URL` (for email links)\n\n---\n\n### Step 3: Deploy to Vercel\n\n**Important:** Vercel Cron Jobs only work in production, NOT in local development.\n\n1. Commit and push your code to GitHub (or your Git provider):\n   ```bash\n   git add .\n   git commit -m \"Add Vercel cron jobs for moderation automation\"\n   git push origin main\n   ```\n\n2. Vercel will automatically deploy your changes\n\n3. Wait for deployment to complete (usually 1-2 minutes)\n\n---\n\n### Step 4: Verify Cron Jobs are Configured\n\nAfter deployment completes:\n\n1. Go to your Vercel project dashboard\n2. Navigate to **Settings**  **Cron Jobs**\n3. You should see **2 active cron jobs**:\n\n   | Path | Schedule | Description |\n   |------|----------|-------------|\n   | `/api/cron/cleanup-expired-appeals` | `0 2 * * *` | Runs daily at 2:00 AM |\n   | `/api/cron/send-appeal-reminders` | `0 10 * * *` | Runs daily at 10:00 AM |\n\n4. Both should show **Status: Active** with a green indicator\n\n**Screenshot Location:** Settings  Cron Jobs (sidebar)\n\n---\n\n## Testing the Cron Jobs\n\n### Manual Testing (Optional)\n\nYou can manually trigger each endpoint to verify they work:\n\n#### Test Cleanup Job\n```bash\ncurl -X GET https://your-domain.vercel.app/api/cron/cleanup-expired-appeals \\\n  -H \"Authorization: Bearer YOUR_CRON_SECRET\"\n```\n\n**Expected Response:**\n```json\n{\n  \"success\": true,\n  \"processed\": {\n    \"campaigns\": 0,\n    \"users\": 0\n  },\n  \"executedAt\": \"2025-10-26T02:00:00.000Z\"\n}\n```\n\n#### Test Reminder Job\n```bash\ncurl -X GET https://your-domain.vercel.app/api/cron/send-appeal-reminders \\\n  -H \"Authorization: Bearer YOUR_CRON_SECRET\"\n```\n\n**Expected Response:**\n```json\n{\n  \"success\": true,\n  \"remindersProcessed\": {\n    \"campaigns\": { \"day7\": 0, \"day3\": 0, \"day1\": 0 },\n    \"users\": { \"day7\": 0, \"day3\": 0, \"day1\": 0 }\n  },\n  \"executedAt\": \"2025-10-26T10:00:00.000Z\"\n}\n```\n\n**Replace:**\n- `your-domain.vercel.app` with your actual Vercel domain\n- `YOUR_CRON_SECRET` with the secret from your environment variables\n\n---\n\n## Monitoring Cron Job Execution\n\n### Method 1: Via Vercel Function Logs\n\n1. Go to your Vercel project dashboard\n2. Navigate to **Deployments**  Select your **production** deployment\n3. Click **Functions** tab\n4. Look for the cron job endpoints:\n   - `/api/cron/cleanup-expired-appeals`\n   - `/api/cron/send-appeal-reminders`\n5. View execution logs, timing, and any errors\n\n**Logs show:**\n- Execution timestamp\n- Response status (200 = success)\n- Duration (should be under 10 seconds for each)\n- Any console output or errors\n\n### Method 2: Via Admin Logs (In Your App)\n\n1. Login to your app as admin\n2. Go to `/admin/logs`\n3. Filter by admin: **system**\n4. Look for these action types:\n   - `auto_permanent_removal` (cleanup job - campaigns)\n   - `auto_permanent_ban` (cleanup job - users)\n\n**Note:** Reminder emails don't create admin logs (they're user notifications, not moderation actions).\n\n### Method 3: Check User Email Inbox\n\nIf you have test accounts with temporary removals/bans:\n- Reminders will be sent 7, 3, and 1 days before deadline\n- Check the test user's email inbox for reminder emails\n- Subject: \" Appeal Deadline Reminder - X Days Left\"\n\n---\n\n## Troubleshooting\n\n### Problem: Cron Jobs Not Visible in Vercel\n\n**Check:**\n1. Did you deploy to production? (Push to main branch)\n2. Is `vercel.json` in the root of your repository?\n3. Did the deployment complete successfully?\n\n**Solution:**\n- Verify `vercel.json` exists and has correct syntax\n- Redeploy: `git commit --allow-empty -m \"Trigger redeploy\" && git push`\n\n---\n\n### Problem: Unauthorized Error (401)\n\n**Error Message:** `{ \"error\": \"Unauthorized\" }`\n\n**Cause:** `CRON_SECRET` mismatch or missing\n\n**Solution:**\n1. Verify `CRON_SECRET` is set in Vercel environment variables\n2. Make sure you're using the correct secret in your test request\n3. Redeploy after adding/changing environment variables\n\n---\n\n### Problem: No Records Processed\n\n**Response:** `\"campaigns\": 0, \"users\": 0` or all reminder counts are 0\n\n**This is NORMAL if:**\n- No campaigns/users have expired deadlines (cleanup job)\n- No appeals are expiring in 7/3/1 days (reminder job)\n- All temporary removals/bans are still active\n\n**To verify it's working:**\n1. Check Vercel function logs - should show `200 OK`\n2. Response should have `\"success\": true`\n3. Create a test scenario with an expiring appeal\n\n---\n\n### Problem: Emails Not Sending\n\n**Check:**\n1. Is `MAILERSEND_API_KEY` set in Vercel environment variables?\n2. Is your MailerSend account active and within sending limits?\n3. Check Vercel function logs for email errors\n4. Verify `NEXT_PUBLIC_BASE_URL` is correct\n\n**Solution:**\n- Test email sending with MailerSend dashboard\n- Check spam folder for test emails\n- Review MailerSend sending logs\n\n---\n\n### Problem: Cron Job Runs at Wrong Time\n\n**On Free (Hobby) Plan:**\n- Timing is NOT precise\n- `0 2 * * *` might run anytime between 2:00-2:59 AM\n- `0 10 * * *` might run anytime between 10:00-10:59 AM\n\n**This is expected behavior on the free tier.**\n\n**Solution:**\n- Upgrade to Vercel Pro for precise timing\n- Or accept the 1-hour window (doesn't affect functionality)\n\n---\n\n## Cron Schedule Format Explained\n\nThe schedule uses cron syntax:\n\n```\n* * * * *\n    \n     Day of week (0-7, 0 and 7 are Sunday)\n    Month (1-12)\n   Day of month (1-31)\n  Hour (0-23, UTC timezone)\n Minute (0-59)\n```\n\n### Current Schedules:\n\n| Cron Job | Schedule | Meaning |\n|----------|----------|---------|\n| Cleanup | `0 2 * * *` | Every day at 2:00 AM UTC |\n| Reminders | `0 10 * * *` | Every day at 10:00 AM UTC |\n\n**Note:** Times are in UTC. Convert to your local timezone if needed.\n\n### To Change Schedules:\n\n1. Edit `vercel.json`\n2. Modify the `schedule` field\n3. Commit and push to deploy\n\n**Examples:**\n- `0 0 * * *` = Midnight UTC\n- `0 12 * * *` = Noon UTC\n- `0 */6 * * *` = Every 6 hours (Pro plan only)\n\n---\n\n## Vercel Plan Limits\n\n### Hobby (Free) Plan\n- **Cron Jobs:** 2 per account (you're using both)\n- **Schedule:** Once per day maximum\n- **Timing:** Approximate (59 minutes)\n- **Function Duration:** 10 seconds max (both jobs run under 5s)\n- **Function Executions:** Unlimited\n\n### Pro Plan ($20/month)\n- **Cron Jobs:** 40 per account\n- **Schedule:** Unlimited (can run every minute)\n- **Timing:** Precise to the minute\n- **Function Duration:** 60 seconds max\n- **Better monitoring and logs**\n\n**Current setup uses 2 of your 2 free cron jobs.** If you need more automation, consider upgrading.\n\n---\n\n## Security Best Practices\n\n### Protecting Your Cron Endpoints\n\n1. **Never commit `CRON_SECRET` to Git**\n   - Keep it only in Vercel environment variables\n   - Use different secrets for production/preview if needed\n\n2. **Rotate the secret periodically**\n   - Generate a new secret every 3-6 months\n   - Update in Vercel environment variables\n   - Redeploy to activate\n\n3. **Monitor for unauthorized access**\n   - Check Vercel function logs for 401 errors\n   - Investigate unexpected execution patterns\n\n4. **Use strong secrets**\n   - Minimum 32 characters\n   - Mix of letters, numbers, and symbols\n   - Use `openssl rand -base64 32` for generation\n\n---\n\n## Email Templates\n\n### Appeal Reminder Email\n- **Subject:** \" Appeal Deadline Reminder - X Days Left\"\n- **Style:** Orange/amber theme with countdown\n- **Content:**\n  - Days remaining (large number)\n  - Original removal reason\n  - Appeal submission link\n  - Warning about permanent status\n\n### Permanent Ban Email\n- **Subject:** \" Your Account Has Been Suspended\"\n- **Style:** Red theme\n- **Content:**\n  - Permanent ban notice\n  - Original ban reason\n  - No appeal option (expired)\n  - Support contact info\n\n---\n\n## Files Related to Cron Jobs\n\n### Configuration:\n- `vercel.json` - Cron job definitions and schedules\n\n### Endpoints:\n- `src/app/api/cron/cleanup-expired-appeals/route.js` - Cleanup logic\n- `src/app/api/cron/send-appeal-reminders/route.js` - Reminder logic\n\n### Email & Notifications:\n- `src/utils/notifications/emailTemplates.js` - Email HTML templates\n- `src/utils/notifications/sendEmail.js` - MailerSend integration\n- `src/utils/notifications/sendInAppNotification.js` - In-app notifications\n- `src/utils/notifications/notificationTemplates.js` - In-app templates\n\n### Utilities:\n- `src/utils/logAdminAction.js` - Admin action logging\n- `.env.example` - Documents required environment variables\n\n---\n\n## Need Help?\n\n### Documentation:\n- [Vercel Cron Jobs Documentation](https://vercel.com/docs/cron-jobs)\n- [Cron Schedule Examples](https://crontab.guru/)\n- [MailerSend Documentation](https://developers.mailersend.com/)\n\n### Support:\n- [Vercel Support](https://vercel.com/support)\n- [MailerSend Support](https://www.mailersend.com/help)\n\n### In-App Monitoring:\n- Admin logs: `/admin/logs`\n- Filter by admin: `system`\n\n---\n\n**Last Updated:** October 26, 2025  \n**Cron Jobs Active:** 2 of 2 (Free tier limit reached)\n","path":null,"size_bytes":11178,"size_tokens":null},"src/utils/validateEnv.js":{"content":"/**\n * Environment Variable Validation Utilities\n *\n * Provides format validation for various environment variables to catch\n * configuration issues early rather than at runtime.\n */\n\n/**\n * Validate MailerSend API Key format\n * @param {string} key - The API key to validate\n * @throws {Error} If the key format is invalid\n */\nexport function validateMailersendKey(key) {\n  const isProduction = process.env.NODE_ENV === \"production\";\n\n  if (!key) {\n    if (isProduction) {\n      throw new Error(\"[PRODUCTION] MAILERSEND_API_KEY is required\");\n    }\n    return false;\n  }\n\n  // MailerSend API keys start with 'mlsn.'\n  if (!key.startsWith(\"mlsn.\")) {\n    const error =\n      'MAILERSEND_API_KEY must start with \"mlsn.\" - this appears to be an invalid MailerSend API key';\n\n    if (isProduction) {\n      throw new Error(`[PRODUCTION] ${error}`);\n    }\n\n    if (process.env.NODE_ENV === \"development\") {\n      console.warn(`[DEV WARNING] ${error}`);\n    }\n    return false;\n  }\n\n  // Basic length check (MailerSend keys are typically 60+ characters)\n  if (key.length < 40) {\n    const error = `MAILERSEND_API_KEY appears too short (${key.length} chars). Valid keys are typically 60+ characters`;\n\n    if (isProduction) {\n      throw new Error(`[PRODUCTION] ${error}`);\n    }\n\n    if (process.env.NODE_ENV === \"development\") {\n      console.warn(`[DEV WARNING] ${error}`);\n    }\n    return false;\n  }\n\n  return true;\n}\n\n/**\n * Validate Supabase URL format\n * @param {string} url - The Supabase URL to validate\n * @throws {Error} If the URL format is invalid\n */\nexport function validateSupabaseUrl(url) {\n  const isProduction = process.env.NODE_ENV === \"production\";\n\n  if (!url) {\n    if (isProduction) {\n      throw new Error(\"[PRODUCTION] NEXT_PUBLIC_SUPABASE_URL is required\");\n    }\n    return false;\n  }\n\n  try {\n    const parsedUrl = new URL(url);\n\n    // Supabase URLs should include 'supabase.co' in the hostname\n    if (!parsedUrl.hostname.includes(\"supabase.co\")) {\n      throw new Error(\"URL must be a valid Supabase URL (*.supabase.co)\");\n    }\n\n    // Should use HTTPS\n    if (parsedUrl.protocol !== \"https:\") {\n      const error = \"Supabase URL must use HTTPS protocol\";\n\n      if (isProduction) {\n        throw new Error(`[PRODUCTION] ${error}`);\n      }\n\n      if (process.env.NODE_ENV === \"development\") {\n        console.warn(`[DEV WARNING] ${error}`);\n      }\n      return false;\n    }\n\n    return true;\n  } catch (error) {\n    const errorMsg = `Invalid NEXT_PUBLIC_SUPABASE_URL format: ${error.message}`;\n\n    if (isProduction) {\n      throw new Error(`[PRODUCTION] ${errorMsg}`);\n    }\n\n    if (process.env.NODE_ENV === \"development\") {\n      console.warn(`[DEV WARNING] ${errorMsg}`);\n    }\n    return false;\n  }\n}\n\n/**\n * Validate Firebase Service Account Key format\n * @param {string} keyJson - The JSON string of the service account key\n * @throws {Error} If the key format is invalid\n */\nexport function validateFirebaseServiceKey(keyJson) {\n  const isProduction = process.env.NODE_ENV === \"production\";\n\n  if (!keyJson) {\n    if (isProduction) {\n      throw new Error(\"[PRODUCTION] FIREBASE_SERVICE_ACCOUNT_KEY is required\");\n    }\n    return false;\n  }\n\n  try {\n    const key = JSON.parse(keyJson);\n\n    // Check required fields for Firebase service account\n    const requiredFields = [\n      \"type\",\n      \"project_id\",\n      \"private_key\",\n      \"client_email\",\n    ];\n    const missingFields = requiredFields.filter((field) => !key[field]);\n\n    if (missingFields.length > 0) {\n      throw new Error(`Missing required fields: ${missingFields.join(\", \")}`);\n    }\n\n    // Validate type\n    if (key.type !== \"service_account\") {\n      throw new Error('Service account key type must be \"service_account\"');\n    }\n\n    // Validate private key format\n    if (!key.private_key.includes(\"BEGIN PRIVATE KEY\")) {\n      throw new Error(\"Invalid private_key format - must be a valid PEM key\");\n    }\n\n    // Validate client email format\n    if (\n      !key.client_email.includes(\"@\") ||\n      !key.client_email.includes(\".iam.gserviceaccount.com\")\n    ) {\n      throw new Error(\n        \"Invalid client_email format - must be a valid service account email\",\n      );\n    }\n\n    return true;\n  } catch (error) {\n    const errorMsg = `Invalid FIREBASE_SERVICE_ACCOUNT_KEY format: ${error.message}`;\n\n    if (isProduction) {\n      throw new Error(`[PRODUCTION] ${errorMsg}`);\n    }\n\n    if (process.env.NODE_ENV === \"development\") {\n      console.warn(`[DEV WARNING] ${errorMsg}`);\n    }\n    return false;\n  }\n}\n\n/**\n * Validate ImageKit URL endpoint format\n * @param {string} url - The ImageKit URL endpoint to validate\n * @throws {Error} If the URL format is invalid\n */\nexport function validateImageKitUrl(url) {\n  const isProduction = process.env.NODE_ENV === \"production\";\n\n  if (!url) {\n    if (isProduction) {\n      throw new Error(\n        \"[PRODUCTION] NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT is required\",\n      );\n    }\n    return false;\n  }\n\n  try {\n    const parsedUrl = new URL(url);\n\n    // ImageKit URLs should include 'imagekit.io' in the hostname\n    if (!parsedUrl.hostname.includes(\"imagekit.io\")) {\n      throw new Error(\"URL must be a valid ImageKit URL (*.imagekit.io)\");\n    }\n\n    // Should use HTTPS\n    if (parsedUrl.protocol !== \"https:\") {\n      const error = \"ImageKit URL must use HTTPS protocol\";\n\n      if (isProduction) {\n        throw new Error(`[PRODUCTION] ${error}`);\n      }\n\n      if (process.env.NODE_ENV === \"development\") {\n        console.warn(`[DEV WARNING] ${error}`);\n      }\n      return false;\n    }\n\n    return true;\n  } catch (error) {\n    const errorMsg = `Invalid NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT format: ${error.message}`;\n\n    if (isProduction) {\n      throw new Error(`[PRODUCTION] ${errorMsg}`);\n    }\n\n    if (process.env.NODE_ENV === \"development\") {\n      console.warn(`[DEV WARNING] ${errorMsg}`);\n    }\n    return false;\n  }\n}\n\n/**\n * Validate CRON_SECRET format\n * @param {string} secret - The cron secret to validate\n * @throws {Error} If the secret format is invalid\n */\nexport function validateCronSecret(secret) {\n  const isProduction = process.env.NODE_ENV === \"production\";\n\n  if (!secret) {\n    if (isProduction) {\n      throw new Error(\"[PRODUCTION] CRON_SECRET is required\");\n    }\n    return false;\n  }\n\n  // CRON_SECRET should be at least 32 characters for security\n  if (secret.length < 32) {\n    const error = `CRON_SECRET is too short (${secret.length} chars). Should be at least 32 characters for security`;\n\n    if (isProduction) {\n      throw new Error(`[PRODUCTION] ${error}`);\n    }\n\n    if (process.env.NODE_ENV === \"development\") {\n      console.warn(`[DEV WARNING] ${error}`);\n    }\n    return false;\n  }\n\n  return true;\n}\n","path":null,"size_bytes":6717,"size_tokens":null},"src/app/api/admin/migrate/storage-path/route.js":{"content":"import { NextResponse } from 'next/server';\nimport { requireAdmin } from '@/middleware/adminAuth';\nimport { adminFirestore } from '@/lib/firebaseAdmin';\n\nexport async function GET(request) {\n  try {\n    await requireAdmin(request);\n    \n    const db = adminFirestore();\n    const campaignsRef = db.collection('campaigns');\n    const snapshot = await campaignsRef.get();\n    \n    const stats = {\n      total: snapshot.size,\n      withStoragePath: 0,\n      needsMigration: 0,\n      noImageUrl: 0\n    };\n    \n    for (const doc of snapshot.docs) {\n      const data = doc.data();\n      \n      if (data.storagePath) {\n        stats.withStoragePath++;\n      } else if (data.imageUrl) {\n        stats.needsMigration++;\n      } else {\n        stats.noImageUrl++;\n      }\n    }\n    \n    return NextResponse.json({\n      success: true,\n      message: 'Migration preview',\n      stats,\n      note: 'Use POST to run the migration'\n    });\n  } catch (error) {\n    console.error('Migration preview error:', error);\n    \n    return NextResponse.json(\n      { success: false, error: error.message || 'Failed to get migration preview' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function POST(request) {\n  try {\n    await requireAdmin(request);\n    \n    const db = adminFirestore();\n    const campaignsRef = db.collection('campaigns');\n    const snapshot = await campaignsRef.get();\n    \n    const results = {\n      total: snapshot.size,\n      migrated: 0,\n      skipped: 0,\n      failed: 0,\n      errors: []\n    };\n    \n    const batch = db.batch();\n    let batchCount = 0;\n    const BATCH_SIZE = 500;\n    \n    for (const doc of snapshot.docs) {\n      const data = doc.data();\n      \n      if (data.storagePath) {\n        results.skipped++;\n        continue;\n      }\n      \n      if (!data.imageUrl) {\n        results.skipped++;\n        continue;\n      }\n      \n      try {\n        let storagePath = null;\n        \n        if (data.imageUrl.includes('/storage/v1/object/public/uploads/')) {\n          storagePath = data.imageUrl.split('/storage/v1/object/public/uploads/')[1];\n        }\n        \n        if (storagePath) {\n          batch.update(doc.ref, { storagePath });\n          batchCount++;\n          results.migrated++;\n          \n          if (batchCount >= BATCH_SIZE) {\n            await batch.commit();\n            batchCount = 0;\n          }\n        } else {\n          results.failed++;\n          results.errors.push({\n            campaignId: doc.id,\n            imageUrl: data.imageUrl,\n            reason: 'Could not parse storage path from imageUrl'\n          });\n        }\n      } catch (error) {\n        results.failed++;\n        results.errors.push({\n          campaignId: doc.id,\n          error: error.message\n        });\n      }\n    }\n    \n    if (batchCount > 0) {\n      await batch.commit();\n    }\n    \n    return NextResponse.json({\n      success: true,\n      message: 'Migration completed',\n      results\n    });\n  } catch (error) {\n    console.error('Migration error:', error);\n    \n    return NextResponse.json(\n      { success: false, error: error.message || 'Migration failed' },\n      { status: 500 }\n    );\n  }\n}\n","path":null,"size_bytes":3136,"size_tokens":null},"BUTTON_STYLE_GUIDE.md":{"content":"# Button Style Guide\n\nThis document defines the standardized button styling system for Twibbonize. **All buttons must use the `btn-base` class plus a variant class** for consistent appearance and behavior across the platform.\n\n## Core Principle\n\n```jsx\n//  CORRECT - Use btn-base + btn-{variant}\n<button className=\"btn-base btn-primary py-3 px-6\">\n  Submit\n</button>\n\n//  WRONG - Don't use inline Tailwind classes\n<button className=\"bg-emerald-600 hover:bg-emerald-700 text-white py-3 px-6 rounded-lg\">\n  Submit\n</button>\n```\n\n## Available Button Variants\n\n### 1. Primary Button (`btn-primary`)\n**Use for:** Main actions, submit buttons, primary CTAs\n```jsx\n<button className=\"btn-base btn-primary py-3 px-6\">\n  Create Campaign\n</button>\n```\n- **Colors:** Emerald gradient (emerald-600 to emerald-700)\n- **Hover:** Darkens to emerald-700/emerald-800\n- **When to use:** Primary user actions, form submissions, main CTAs\n\n---\n\n### 2. Secondary Button (`btn-secondary`)\n**Use for:** Alternative actions, cancel buttons, secondary CTAs\n```jsx\n<button className=\"btn-base btn-secondary py-3 px-6\">\n  Cancel\n</button>\n```\n- **Colors:** White background with gray border\n- **Hover:** Light gray background (gray-50)\n- **When to use:** Secondary actions, alternative options, cancel operations\n\n---\n\n### 3. Danger Button (`btn-danger`)\n**Use for:** Destructive actions, delete buttons, permanent actions\n```jsx\n<button className=\"btn-base btn-danger py-3 px-6\">\n  Delete Campaign\n</button>\n```\n- **Colors:** Red (red-600)\n- **Hover:** Darker red (red-700)\n- **When to use:** Delete, ban, reject, or other destructive actions\n\n---\n\n### 4. Warning Button (`btn-warning`)\n**Use for:** Warning actions, caution buttons\n```jsx\n<button className=\"btn-base btn-warning py-3 px-6\">\n  Pending Review\n</button>\n```\n- **Colors:** Yellow (yellow-500)\n- **Hover:** Darker yellow (yellow-600)\n- **When to use:** Warning states, caution actions, pending states\n\n---\n\n### 5. Info Button (`btn-info`)\n**Use for:** Informational actions, refresh, reload, help\n```jsx\n<button className=\"btn-base btn-info py-3 px-6\">\n  Refresh Page\n</button>\n```\n- **Colors:** Blue (blue-500)\n- **Hover:** Darker blue (blue-600)\n- **When to use:** Refresh, reload, retry, informational actions\n\n---\n\n### 6. Neutral Button (`btn-neutral`)\n**Use for:** Utility actions, change, reset, minor actions\n```jsx\n<button className=\"btn-base btn-neutral py-3 px-6\">\n  Change Photo\n</button>\n```\n- **Colors:** Light gray (gray-200)\n- **Hover:** Medium gray (gray-300)\n- **When to use:** Utility functions, change photo, reset, zoom controls\n\n---\n\n### 7. Google/Social Button (`btn-google`)\n**Use for:** Google sign-in, social authentication\n```jsx\n<button className=\"btn-base btn-google py-3 px-6\">\n  Sign in with Google\n</button>\n```\n- **Colors:** White with border and shadow\n- **Hover:** Yellow tint (yellow-50)\n- **When to use:** Google authentication, social login\n\n---\n\n### 8. Link Button (`btn-link`)\n**Use for:** Text-only buttons, inline links\n```jsx\n<button className=\"btn-link\">\n  Learn More\n</button>\n```\n- **Colors:** Emerald text (emerald-600)\n- **Hover:** Darker emerald with underline\n- **When to use:** Text-only actions, inline links, subtle navigation\n\n---\n\n### 9. Social Media Share Buttons\n\n#### Twitter Button (`btn-twitter`)\n```jsx\n<button className=\"btn-base btn-twitter py-3 px-6\">\n  Share on Twitter\n</button>\n```\n- **Colors:** Twitter blue (blue-400)\n- **Hover:** Darker blue (blue-500)\n\n#### Facebook Button (`btn-facebook`)\n```jsx\n<button className=\"btn-base btn-facebook py-3 px-6\">\n  Share on Facebook\n</button>\n```\n- **Colors:** Facebook blue (blue-600)\n- **Hover:** Darker blue (blue-700)\n\n#### WhatsApp Button (`btn-whatsapp`)\n```jsx\n<button className=\"btn-base btn-whatsapp py-3 px-6\">\n  Share on WhatsApp\n</button>\n```\n- **Colors:** WhatsApp green (green-500)\n- **Hover:** Darker green (green-600)\n\n---\n\n## Button Features\n\n### Automatic Hover Effect\nAll buttons using `btn-base` get a **1.03x scale on hover** for visual feedback.\n\n### Focus States\nAll variants include accessible focus rings that match their color scheme.\n\n### Disabled State\n```jsx\n<button className=\"btn-base btn-primary py-3 px-6\" disabled>\n  Loading...\n</button>\n```\n- Automatically reduces opacity to 50%\n- Removes cursor pointer\n- Disables hover effects\n\n---\n\n## Common Patterns\n\n### Full Width Button\n```jsx\n<button className=\"btn-base btn-primary w-full py-3\">\n  Continue\n</button>\n```\n\n### Small Button\n```jsx\n<button className=\"btn-base btn-secondary py-2 px-4 text-sm\">\n  Edit\n</button>\n```\n\n### Icon Button\n```jsx\n<button className=\"btn-base btn-info w-10 h-10 rounded-full\">\n  <Icon />\n</button>\n```\n\n### Button Group\n```jsx\n<div className=\"flex gap-2\">\n  <button className=\"btn-base btn-secondary flex-1 py-3\">Cancel</button>\n  <button className=\"btn-base btn-primary flex-1 py-3\">Submit</button>\n</div>\n```\n\n---\n\n## Migration Checklist\n\nWhen updating old buttons:\n1.  Add `btn-base` class\n2.  Add appropriate `btn-{variant}` class\n3.  Remove all inline `bg-*`, `hover:*`, `transition-*` classes\n4.  Keep sizing classes (`py-*`, `px-*`, `w-*`, `h-*`)\n5.  Keep layout classes (`flex`, `block`, `inline-flex`)\n6.  Keep text classes (`text-sm`, etc.) only if needed for exceptions\n\n---\n\n## Design Benefits\n\n **Consistency:** All buttons look and behave the same way  \n **Maintainability:** Update one CSS class to change all buttons  \n **Accessibility:** Built-in focus states and ARIA support  \n **Performance:** Shared CSS classes reduce bundle size  \n **Developer Experience:** Clear naming makes code more readable  \n\n---\n\n## Questions?\n\nIf you need a new button variant or have questions about which variant to use, refer to this guide or check `src/app/globals.css` for implementation details.\n\n**Last Updated:** October 28, 2025\n","path":null,"size_bytes":5836,"size_tokens":null},"src/components/Pagination.js":{"content":"\"use client\";\n\nexport default function Pagination({ \n  currentPage, \n  totalPages, \n  onPageChange,\n  className = \"\"\n}) {\n  if (totalPages <= 1) {\n    return null;\n  }\n\n  const getPageNumbers = () => {\n    const pages = [];\n    const maxVisiblePages = 5;\n    \n    if (totalPages <= maxVisiblePages) {\n      for (let i = 1; i <= totalPages; i++) {\n        pages.push(i);\n      }\n    } else {\n      pages.push(1);\n      \n      if (currentPage > 3) {\n        pages.push('...');\n      }\n      \n      const start = Math.max(2, currentPage - 1);\n      const end = Math.min(totalPages - 1, currentPage + 1);\n      \n      for (let i = start; i <= end; i++) {\n        if (!pages.includes(i)) {\n          pages.push(i);\n        }\n      }\n      \n      if (currentPage < totalPages - 2) {\n        pages.push('...');\n      }\n      \n      if (!pages.includes(totalPages)) {\n        pages.push(totalPages);\n      }\n    }\n    \n    return pages;\n  };\n\n  const pageNumbers = getPageNumbers();\n\n  return (\n    <div className={`flex items-center justify-center gap-2 mt-8 ${className}`}>\n      <button\n        onClick={() => onPageChange(currentPage - 1)}\n        disabled={currentPage === 1}\n        className=\"btn-base btn-secondary px-3 py-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed\"\n        aria-label=\"Previous page\"\n      >\n        <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M15 19l-7-7 7-7\" />\n        </svg>\n      </button>\n\n      {pageNumbers.map((page, index) => (\n        page === '...' ? (\n          <span key={`ellipsis-${index}`} className=\"px-2 py-2 text-gray-500\">\n            ...\n          </span>\n        ) : (\n          <button\n            key={page}\n            onClick={() => onPageChange(page)}\n            className={`btn-base px-4 py-2 text-sm font-medium min-w-[40px] ${\n              currentPage === page\n                ? 'btn-primary'\n                : 'btn-secondary'\n            }`}\n            aria-label={`Page ${page}`}\n            aria-current={currentPage === page ? 'page' : undefined}\n          >\n            {page}\n          </button>\n        )\n      ))}\n\n      <button\n        onClick={() => onPageChange(currentPage + 1)}\n        disabled={currentPage === totalPages}\n        className=\"btn-base btn-secondary px-3 py-2 text-sm disabled:opacity-50 disabled:cursor-not-allowed\"\n        aria-label=\"Next page\"\n      >\n        <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n          <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n        </svg>\n      </button>\n    </div>\n  );\n}\n","path":null,"size_bytes":2702,"size_tokens":null},"project_deep_analysis.md":{"content":"# Project Deep Analysis: Twibbonize Clone\n\n**Analysis Date:** December 10, 2025  \n**Analyst:** Replit Agent (Deep Codebase Review)  \n**Project:** `twibbonize-app` - User-Generated Content Platform\n\n---\n\n## 1. Executive Summary\n\n### Project Purpose\nTwibbonize is a **User-Generated Content (UGC) Platform** for creating and sharing campaign frames and backgrounds. Users can:\n- Upload \"frames\" (transparent overlays) or \"backgrounds\" (solid images)\n- Other users overlay their photos on these campaigns\n- Download and share the composed images\n\n### Current State: **Late Beta / MVP Complete**\n\nThe application is a solid **Minimum Viable Product** with:\n- Fully functional campaign creation and usage workflows\n- Comprehensive admin moderation dashboard\n- In-app notification system with Firestore real-time listeners\n- Appeal system for content moderation\n- Automated cron jobs for cleanup and reminders\n\n---\n\n## 2. Technology Stack Analysis\n\n### Verified Tech Stack (from package.json and actual code)\n\n| Layer | Technology | Version | Notes |\n|-------|------------|---------|-------|\n| Framework | Next.js | 15.5.7 | App Router architecture |\n| UI Library | React | 19.1.0 | Latest React version |\n| Styling | Tailwind CSS | 4.x | PostCSS integration |\n| Auth | Firebase Auth | 12.2.1 | Client-side authentication |\n| Database | Firestore | (Firebase SDK) | NoSQL document database |\n| Admin SDK | firebase-admin | 13.5.0 | Server-side operations |\n| Storage | Supabase | 2.57.4 | Image storage with signed URLs |\n| Email | MailerSend | 2.6.0 | Ban/unban notifications |\n| Validation | Zod | 4.1.8 | Schema validation |\n| Dates | date-fns | 4.1.0 | Date manipulation |\n\n### Missing from package.json (mentioned in docs but not installed)\n- **ImageKit.io** - Mentioned as CDN in docs, but no SDK installed. Uses URL-based transformations.\n\n---\n\n## 3. Architecture Deep Dive\n\n### File Structure Analysis\n\n```\nsrc/\n app/                    # Next.js App Router\n    (chrome)/          # Main layout group (Header/Footer)\n       admin/         # Admin dashboard (6 pages)\n       campaign/[slug]/ # 3-page visitor flow\n       campaigns/     # Public gallery\n       create/        # Campaign creation\n       creators/      # Leaderboard\n       profile/       # User profile + appeals\n       u/[username]/  # Public profiles\n    api/               # Server-side API routes\n       admin/         # Protected admin APIs\n       appeals/       # Appeal submission\n       campaigns/     # Download tracking\n       cron/          # Vercel cron jobs (2)\n       notifications/ # Notification management\n       reports/       # Report submission\n       storage/       # Supabase operations\n    [auth pages]       # signin, signup, etc.\n components/            # 30+ React components\n contexts/              # CampaignSessionContext\n hooks/                 # 5 custom hooks\n lib/                   # Firebase/Supabase SDKs\n middleware/            # adminAuth.js\n utils/                 # Utility functions\n```\n\n### Routing Architecture\n\n**Public Routes (No Auth Required):**\n- `/campaigns` - Browse all campaigns\n- `/campaign/[slug]` - View and use campaign\n- `/creators` - Top creators leaderboard\n- `/u/[username]` - Public user profiles\n- `/terms`, `/privacy` - Legal pages\n\n**Auth Required Routes:**\n- `/create` - Campaign creation\n- `/profile` - User's own profile\n- `/profile/edit` - Edit profile\n- `/profile/notifications` - Notification inbox\n- `/profile/appeals` - Submit appeals\n\n**Admin Routes (Admin Role Required):**\n- `/admin` - Analytics dashboard\n- `/admin/reports` - Report moderation\n- `/admin/campaigns` - Campaign moderation\n- `/admin/users` - User management\n- `/admin/appeals` - Appeal review\n- `/admin/logs` - Admin action logs\n\n---\n\n## 4. Code Quality Assessment\n\n### Strengths\n\n1. **Security Implementation - Excellent**\n   - Firestore rules are comprehensive and well-structured\n   - Uses `request.resource.data.diff().affectedKeys()` for precise field control\n   - Signed URLs for all storage operations (no public write access)\n   - Triple-layer admin protection (Frontend + Middleware + API)\n\n2. **Database Structure - Well Designed**\n   - Atomic username reservation using `usernames` collection\n   - Optimized report aggregation with `reportSummary` (95% reduction in operations)\n   - Transaction-based operations for data consistency\n\n3. **Documentation - Above Average**\n   - Multiple comprehensive markdown files (CAMPAIGN_SYSTEM.md, REPORT_SYSTEM.md, etc.)\n   - Inline code comments explaining complex logic\n   - Button style guide for UI consistency\n\n4. **Error Handling - Good**\n   - `firebaseErrorHandler.js` for consistent error messages\n   - Try-catch blocks with fallback returns\n   - Development-only logging to avoid noise in production\n\n---\n\n## 5. Documentation vs Code Discrepancies\n\n### Accurate Claims in Docs\n\n| Claim | Status | Evidence |\n|-------|--------|----------|\n| Next.js 15.5.7 |  Verified | package.json line 17 |\n| React 19.1.0 |  Verified | package.json line 19 |\n| Tailwind CSS 4 |  Verified | package.json devDependencies |\n| Firebase Auth + Firestore |  Verified | firebase-optimized.js |\n| Supabase Storage |  Verified | supabase.js + API routes |\n| MailerSend for email |  Verified | package.json line 17 |\n| 2 Vercel Cron Jobs |  Verified | vercel.json |\n| Button style guide system |  Verified | BUTTON_STYLE_GUIDE.md + globals.css |\n| Firestore rules with field protection |  Verified | firestore.rules |\n| In-app notifications via Firestore |  Verified | NotificationProvider.js, useNotifications.js |\n\n### Inaccurate/Outdated Claims\n\n| Claim | Status | Reality |\n|-------|--------|---------|\n| \"ImageKit.io CDN installed\" |  PARTIAL | No SDK - uses URL transformations only |\n\n### Things Docs Say Are \"Planned\" (Confirmed Not Implemented)\n\n- `/settings` hub (account, privacy, preferences pages)\n- Advanced analytics (time-series, geographic distribution)\n- Infinite scroll pagination\n- Multi-language support (i18n)\n\n---\n\n## 6. Security Review\n\n### Excellent Practices\n\n1. **Firestore Rules** (firestore.rules)\n   - Username atomicity via `usernames` collection\n   - Counter manipulation protection (only +1 increments allowed)\n   - Role protection (users cannot change their own role)\n   - Edit window enforcement (7 days AND <10 supporters)\n   - Field-level update restrictions using `affectedKeys()`\n\n2. **Storage Security** (src/lib/supabase.js)\n   - All uploads require server-generated signed URLs\n   - No direct client access to Supabase credentials\n   - API routes handle all storage operations\n\n3. **Admin Protection** (src/middleware/adminAuth.js)\n   - `requireAdmin()` checks role in Firestore\n   - Admin routes protected at multiple layers\n   - All admin actions logged to `adminLogs` collection\n\n4. **Rate Limiting** (src/utils/reportRateLimit.js)\n   - 5 reports per hour per IP\n   - IP addresses hashed with SHA-256\n   - Duplicate prevention\n\n### Potential Concerns\n\n1. **No CSRF Token Validation** - Relies on Firebase Auth tokens only\n\n---\n\n## 7. Performance Considerations\n\n### Current Optimizations\n\n1. **Report Aggregation** - 95% reduction in Firestore reads for admin actions\n2. **Counter-based tracking** - No per-download documents bloating campaigns\n3. **ImageKit URL transformations** - WebP conversion, resizing without server load\n4. **Standalone output** - Optimized for serverless deployment\n\n### Recommendations\n\n1. **Implement virtual scrolling** - For large campaign lists\n2. **Add React.memo** - To prevent unnecessary re-renders\n\n---\n\n## 8. Feature Completeness Matrix\n\n| Feature | Status | Notes |\n|---------|--------|-------|\n| Campaign Creation (Frame/Background) |  Complete | Two-step flow |\n| 3-Page Visitor Flow |  Complete | Upload  Adjust  Result |\n| Session Persistence |  Complete | 24h expiry in sessionStorage |\n| Route Guards |  Complete | Enforces flow order |\n| Public Gallery |  Complete | With numbered pagination |\n| Filters (Type, Time, Sort) |  Complete | FilterModal component |\n| Top Creators Leaderboard |  Complete | By total supports |\n| User Profiles |  Complete | Public + private views |\n| Profile Editing |  Complete | Avatar, banner, bio, username |\n| Admin Dashboard |  Complete | 6 pages with full functionality |\n| Report System |  Complete | Aggregated with reason counts |\n| Appeal System |  Complete | 30-day window, admin review |\n| In-App Notifications |  Complete | Firestore real-time |\n| Email Notifications |  Complete | Bans/unbans via MailerSend |\n| Cron Jobs |  Complete | 2 daily jobs (cleanup, reminders) |\n| Settings Hub |  Not Started | Planned for future |\n| Search |  Not Implemented | No text search capability |\n| Pagination |  Complete | Numbered pages on /campaigns and /u/[username] |\n\n---\n\n## 9. Cron Jobs Analysis\n\n**Verified from vercel.json:**\n\n| Job | Schedule | Path | Purpose |\n|-----|----------|------|---------|\n| Cleanup Expired Appeals | 2:00 AM UTC daily | `/api/cron/cleanup-expired-appeals` | Upgrade temp removals/bans to permanent |\n| Send Appeal Reminders | 10:00 AM UTC daily | `/api/cron/send-appeal-reminders` | Remind at 7, 3, 1 days before deadline |\n\nBoth jobs are secured with `CRON_SECRET` environment variable.\n\n---\n\n## 10. Environment Variables Required\n\n**Based on code analysis:**\n\n### Firebase (Client-side)\n- `NEXT_PUBLIC_FIREBASE_API_KEY`\n- `NEXT_PUBLIC_FIREBASE_PROJECT_ID`\n- `NEXT_PUBLIC_FIREBASE_APP_ID`\n- `NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID`\n\n### Firebase Admin (Server-side)\n- `FIREBASE_PROJECT_ID`\n- `FIREBASE_CLIENT_EMAIL`\n- `FIREBASE_PRIVATE_KEY`\n\n### Supabase\n- `SUPABASE_URL`\n- `SUPABASE_SERVICE_ROLE_KEY`\n\n### MailerSend\n- `MAILERSEND_API_KEY`\n\n### Cron Security\n- `CRON_SECRET`\n\n### Optional\n- `ALLOWED_ORIGINS` - Comma-separated list of allowed origins\n- `REPLIT_DEV_DOMAIN` - For development\n\n---\n\n## 11. Conclusion\n\nThis is a **well-architected MVP** with strong security practices and comprehensive admin tooling. The codebase follows Next.js 15 App Router conventions properly and has above-average documentation.\n\n**Key Strengths:**\n- Excellent Firestore security rules\n- Comprehensive admin moderation system\n- Optimized report aggregation (95% reduction)\n- Clean separation of concerns\n\n**Critical Gaps:**\n- No text search (discovery limitation)\n\n**Overall Assessment:** Ready for production use with pagination now implemented.\n\n---\n\n*End of Deep Analysis*\n","path":null,"size_bytes":10767,"size_tokens":null},"PROJECT_DEEP_ANALYSIS.md":{"content":"# Project Deep Assessment: Twibbonize Clone\n\n**Date:** December 09, 2025  \n**Auditor:** Antigravity (Principal Software Architect)  \n**Target:** `replit-twibbon-main` Codebase\n\n---\n\n## 1. Executive Summary\n\n### **Project Purpose**\n\nThe project is a **User-Generated Content (UGC) Platform** for creating and sharing campaign frames and backgrounds (similar to Twibbonize). It allows users to upload \"frames\" (overlays) or \"backgrounds\", and other users to overlay their profile photos on them. It includes a robust administration system for content moderation, indicating a strong focus on community safety and compliance.\n\n### **Current State: Late Beta / MVP Candidate**\n\nThe application is past the \"Prototype\" phase and is a solid **MVP (Minimum Viable Product)**.\n\n- **Core Flows:** Campaign creation, usage, and sharing are fully implemented.\n- **Admin System:** surprisingly mature, with advanced features like batch-moderation, audit logs, and analytics.\n- **Gaps:** User settings pages are missing or incomplete.\n\n### **Key Strengths**\n\n- **Security First:** Database rules (`firestore.rules`) and Storage access patterns (Signed URLs) are professionally secured.\n- **Admin Tooling:** The admin dashboard is exceptionally detailed, featuring optimization for batch reviewing reports.\n- **UX focus:** The \"3-page flow\" for campaign usage (Upload -> Adjust -> Result) is well-structured and user-friendly.\n\n---\n\n## 2. Technical Stack & Architecture\n\n### **Tech Stack**\n\n- **Framework:** Next.js 15.5.7 (App Router)\n- **Language:** JavaScript (ES6+)\n- **Styling:** Tailwind CSS 4\n- **Database:** Firebase Firestore (NoSQL)\n- **Auth:** Firebase Authentication\n- **Storage:** Supabase Storage (accessed via secured API/Signed URLs)\n- **Image Processing:** ImageKit.io (CDN & Transformations) + HTML5 Canvas (Client-side)\n- **Email:** MailerSend\n\n### **Project Structure**\n\nThe project follows a standard and clean Next.js App Router structure:\n\n- `src/app/(chrome)/...`: Groups routes that share the main layout (Header/Footer).\n- `src/app/api/...`: Server-server API routes, well-separated by domain (`admin`, `campaigns`, `reports`).\n- `src/lib/...`: Core singleton initializers for Firebase and Supabase.\n- `src/components/...`: Component library. CampaignGallery has been refactored into smaller components (CampaignCard, CampaignCardMenu).\n\n### **Data Flow**\n\n1.  **Read:** Client -> Firebase SDK (Firestore) -> UI (Direct read for real-time responsiveness).\n2.  **Write (User):** Client -> API Routes (for sensitive ops) OR Firestore Direct (for standard CRUD allowed by rules).\n3.  **Write (Admin):** Client -> API Routes (`/api/admin/...`) -> Firebase Admin SDK. **Good Pattern:** Admin writes are server-side only, bypassing client rules.\n\n---\n\n## 3. Code Quality Audit\n\n**Overall Score:** 8.5/10\n\n### **Maintainability**\n\n- **Readable:** Code is well-commented and uses clear variable names.\n- **Modular:** Utilities are well separated in `src/utils`. Logic for \"Campaign Session\" is isolated in a Context (`CampaignSessionContext.js`).\n- **Documentation:** The existence of `CODEBASE_STRUCTURE.md` and `CAMPAIGN_SYSTEM.md` is a huge plus for maintainability.\n\n### **Anti-Patterns & Issues**\n\n1.  ~~**Scalability Bottleneck (Critical):**~~  RESOLVED\n    - **File:** `src/lib/firestore.js` -> `getAllCampaigns`\n    - **Fix Applied:** Pagination implemented with numbered pages on `/campaigns` and `/u/[username]` pages.\n2.  ~~**Heavy Components:**~~  RESOLVED\n    - **File:** `src/components/CampaignGallery.js` (now 225 lines)\n    - **Fix Applied:** Extracted into `CampaignCard.js` and `CampaignCardMenu.js`.\n3.  **Redundant Initialization:**\n    - **File:** `src/lib/firebase-optimized.js`\n    - **Issue:** The `useFirebaseOptimized` hook triggers an initialization check on every mount. While safe due to the implementation, it's unnecessary overhead for a singleton pattern.\n\n---\n\n## 4. Security & Performance Review\n\n### **Security: Excellent**\n\n- **Database Rules:** The `firestore.rules` file is a masterclass in Firestore security. It uses `request.resource.data.diff().affectedKeys()` to tightly control _exact_ fields users can edit.\n- **Storage:** No public write access. All uploads require a server-generated Signed URL (`/api/storage/upload-url`).\n- **Admin Access:** Triple-layer protection:\n  1.  Frontend Redirect (`AdminLayout`).\n  2.  Middleware Matcher (`middleware.js` checks origins, though auth logic is mostly in API/Layout).\n  3.  **API Enforcement:** `requireAdmin` middleware explicitly checks the user's role in Firestore before executing any admin action.\n\n### **Performance Bottlenecks**\n\n- **Public Feed N+1 Query:**\n  - In `getAllCampaigns`, the code fetches campaigns and then performs a `Promise.all` to fetch the creator profile for _every_ campaign.\n  - **Mitigation:** The code does batch these requests (good), but as traffic scales, denormalizing basic creator info (name/avatar) onto the `campaign` document would save thousands of reads.\n\n---\n\n## 5. Feature Analysis\n\n### Implemented Features\n\n-  **Campaign Creation:** Full 3-step flow (Upload, Adjust, Preview).\n-  **Campaign Discovery:** Filter by Type, Country, Date, Popularity.\n-  **User Profiles:** Public profiles, stats, and \"My Campaigns\".\n-  **Admin Dashboard:** Reports, Bans, Analytics, Logs.\n-  **Notifications:** In-app real-time notifications (Firestore listeners).\n-  **Appeals System:** Full user-facing UI (`/profile/appeals`) for submitting appeals on banned content.\n\n### Unfinished / Missing Features\n\n-  **Account Settings:** While profile editing (`/profile/edit`) exists, there is no dedicated `/settings` page for account-level management (Email/Password reset from logged-in state, Delete Account, Privacy controls).\n\n---\n\n## 6. The \"Next Steps\" Roadmap\n\n### **Immediate Fixes (High Priority)**\n\n1.  **Add `Account Settings` Page:**\n    - Create `/settings` to handle non-public account data (Password change, Delete Account).\n\n### **Short-term Improvements**\n\n1.  ~~**Refactor `CampaignGallery`:**~~  COMPLETED - Extracted into CampaignCard.js and CampaignCardMenu.js.\n2.  **Denormalize Creator Data:** Store `creatorName` and `creatorAvatar` directly on the `campaign` document. This removes the need for the secondary \"Fetch Creators\" query, cutting database reads by 50% on the feed.\n\n### **Long-term Vision**\n\n1.  **Search Infrastructure:** Firestore is poor at text search. Integrate **Algolia** or **Typesense** for true full-text search of campaigns.\n2.  **CDN Optimization:** Currently using ImageKit. Ensure all user-uploaded content is automatically optimized/cached at the edge to reduce bandwidth costs.\n\n---\n\n_End of Audit Report_\n","path":null,"size_bytes":6707,"size_tokens":null},"src/components/CampaignCardMenu.js":{"content":"\"use client\";\n\nimport { useState } from 'react';\n\nexport default function CampaignCardMenu({\n  campaign,\n  isOwnProfile = false,\n  showReportOption = false,\n  onShare,\n  onReport,\n  onDelete\n}) {\n  const [isOpen, setIsOpen] = useState(false);\n\n  const handleShare = (e) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (onShare) onShare(campaign);\n    setIsOpen(false);\n  };\n\n  const handleReport = (e) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (onReport) onReport(campaign);\n    setIsOpen(false);\n  };\n\n  const handleDelete = (e) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (onDelete) onDelete(campaign);\n    setIsOpen(false);\n  };\n\n  return (\n    <div className=\"absolute top-2 right-2 z-10 opacity-0 group-hover:opacity-100 transition-opacity duration-200\">\n      <button\n        onClick={(e) => {\n          e.preventDefault();\n          e.stopPropagation();\n          setIsOpen(!isOpen);\n        }}\n        className=\"p-1.5 rounded-full bg-white/90 hover:bg-white transition-colors cursor-pointer shadow-sm backdrop-blur-sm\"\n        aria-label=\"Campaign options\"\n      >\n        <svg\n          className=\"w-5 h-5 text-gray-600\"\n          fill=\"currentColor\"\n          viewBox=\"0 0 20 20\"\n        >\n          <path d=\"M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z\" />\n        </svg>\n      </button>\n\n      {isOpen && (\n        <>\n          <div\n            className=\"fixed inset-0 z-10\"\n            onClick={(e) => {\n              e.preventDefault();\n              e.stopPropagation();\n              setIsOpen(false);\n            }}\n          />\n\n          <div className=\"absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-20\">\n            <button\n              onClick={handleShare}\n              className=\"w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors duration-150 flex items-center gap-2 cursor-pointer\"\n            >\n              <svg\n                className=\"w-4 h-4\"\n                fill=\"none\"\n                stroke=\"currentColor\"\n                viewBox=\"0 0 24 24\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  strokeWidth={2}\n                  d=\"M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z\"\n                />\n              </svg>\n              Share Campaign\n            </button>\n            \n            {isOwnProfile && (\n              <button\n                onClick={handleDelete}\n                className=\"w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors duration-150 flex items-center gap-2 cursor-pointer\"\n              >\n                <svg\n                  className=\"w-4 h-4\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  viewBox=\"0 0 24 24\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    strokeWidth={2}\n                    d=\"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16\"\n                  />\n                </svg>\n                Delete Campaign\n              </button>\n            )}\n            \n            {showReportOption && (\n              <button\n                onClick={handleReport}\n                className=\"w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors duration-150 flex items-center gap-2 cursor-pointer\"\n              >\n                <svg\n                  className=\"w-4 h-4\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  viewBox=\"0 0 24 24\"\n                >\n                  <path\n                    strokeLinecap=\"round\"\n                    strokeLinejoin=\"round\"\n                    strokeWidth={2}\n                    d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\"\n                  />\n                </svg>\n                Report Campaign\n              </button>\n            )}\n          </div>\n        </>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":4472,"size_tokens":null},"src/components/CampaignCard.js":{"content":"\"use client\";\n\nimport { useState } from 'react';\nimport Link from 'next/link';\nimport Image from 'next/image';\nimport { getCampaignPreview, getProfileAvatar } from '../utils/imageTransform';\nimport { abbreviateNumber } from '../utils/validation';\nimport CampaignCardMenu from './CampaignCardMenu';\n\nexport default function CampaignCard({\n  campaign,\n  isOwnProfile = false,\n  showReportOption = false,\n  showCreatorInfo = false,\n  onShare,\n  onReport,\n  onDelete\n}) {\n  const [imageLoading, setImageLoading] = useState(true);\n\n  return (\n    <div className=\"group bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden flex flex-col relative\">\n      <Link href={`/campaign/${campaign.slug}`} className=\"contents\">\n        <div className=\"relative aspect-square bg-gray-100 overflow-hidden\">\n          {campaign.imageUrl ? (\n            <>\n              <Image\n                src={getCampaignPreview(campaign.imageUrl)}\n                alt={campaign.title}\n                fill\n                className={`object-cover transition-all duration-300 ${\n                  imageLoading ? 'opacity-0' : 'opacity-100 group-hover:scale-105'\n                }`}\n                onLoadingComplete={() => setImageLoading(false)}\n                onError={() => setImageLoading(false)}\n                sizes=\"(max-width: 640px) 100vw, (max-width: 1024px) 50vw, (max-width: 1280px) 33vw, 25vw\"\n                unoptimized\n              />\n              {imageLoading && (\n                <div className=\"absolute inset-0 bg-gray-200 animate-pulse\" />\n              )}\n            </>\n          ) : (\n            <div className=\"absolute inset-0 bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center\">\n              <svg\n                className=\"h-12 w-12 text-gray-400\"\n                fill=\"none\"\n                viewBox=\"0 0 24 24\"\n                stroke=\"currentColor\"\n              >\n                <path\n                  strokeLinecap=\"round\"\n                  strokeLinejoin=\"round\"\n                  strokeWidth={2}\n                  d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\"\n                />\n              </svg>\n            </div>\n          )}\n          \n          {campaign.type && (\n            <div className=\"absolute top-2 left-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none\">\n              <span className=\"inline-block px-2 py-1 text-xs font-semibold bg-white/90 text-gray-800 rounded-md shadow-sm backdrop-blur-sm\">\n                {campaign.type === 'frame' ? 'Frame' : 'Background'}\n              </span>\n            </div>\n          )}\n        </div>\n\n        <div className=\"p-4 flex-grow\">\n          <h3 className=\"text-gray-900 font-semibold text-base truncate mb-2\">\n            {campaign.title}\n          </h3>\n          \n          {showCreatorInfo && (campaign.creator?.username || campaign.creatorUsername) && (\n            <Link\n              href={`/u/${campaign.creator?.username || campaign.creatorUsername}`}\n              onClick={(e) => e.stopPropagation()}\n              className=\"flex items-center gap-2 mb-2 hover:bg-gray-50 -mx-1 px-1 py-1 rounded-md transition-colors duration-150\"\n            >\n              <div className=\"w-6 h-6 rounded-full bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center flex-shrink-0\">\n                {(campaign.creator?.profileImage || campaign.creatorAvatar) ? (\n                  <img\n                    src={getProfileAvatar(campaign.creator?.profileImage || campaign.creatorAvatar)}\n                    alt={campaign.creator?.displayName || campaign.creatorName || 'Creator'}\n                    className=\"w-full h-full rounded-full object-cover\"\n                    loading=\"lazy\"\n                  />\n                ) : (\n                  <span className=\"text-white text-xs font-bold\">\n                    {(campaign.creator?.displayName || campaign.creatorName)?.charAt(0)?.toUpperCase() || 'U'}\n                  </span>\n                )}\n              </div>\n              <span className=\"text-sm text-gray-600 truncate hover:text-emerald-600 transition-colors duration-150\">\n                {campaign.creator?.displayName || campaign.creatorName || 'Anonymous'}\n              </span>\n            </Link>\n          )}\n          \n          <div className=\"flex items-center gap-2 text-gray-600 text-sm\">\n            <svg\n              className=\"h-4 w-4 text-emerald-600\"\n              fill=\"none\"\n              viewBox=\"0 0 24 24\"\n              stroke=\"currentColor\"\n            >\n              <path\n                strokeLinecap=\"round\"\n                strokeLinejoin=\"round\"\n                strokeWidth={2}\n                d=\"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z\"\n              />\n            </svg>\n            <span>{abbreviateNumber(campaign.supportersCount || 0)} {campaign.supportersCount === 1 ? 'support' : 'supports'}</span>\n          </div>\n        </div>\n      </Link>\n\n      <CampaignCardMenu\n        campaign={campaign}\n        isOwnProfile={isOwnProfile}\n        showReportOption={showReportOption}\n        onShare={onShare}\n        onReport={onReport}\n        onDelete={onDelete}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":5436,"size_tokens":null},"src/components/FeaturedCreators.js":{"content":"\"use client\";\n\nimport { useState, useEffect } from 'react';\nimport Link from 'next/link';\nimport { getTopCreators } from '../lib/firestore';\nimport { getProfileAvatar } from '../utils/imageTransform';\n\nexport default function FeaturedCreators() {\n  const [creators, setCreators] = useState([]);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    const loadCreators = async () => {\n      try {\n        const result = await getTopCreators({ limit: 3 });\n        setCreators(result);\n      } catch (error) {\n        console.error('Error loading featured creators:', error);\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    loadCreators();\n  }, []);\n\n  if (loading) {\n    return (\n      <section className=\"py-12 sm:py-16 bg-gray-50\">\n        <div className=\"mx-auto w-full max-w-6xl px-4 sm:px-6\">\n          <div className=\"flex items-center justify-between mb-8\">\n            <h2 className=\"text-2xl sm:text-3xl font-bold text-gray-900\">\n              Top Creators\n            </h2>\n            <Link\n              href=\"/creators\"\n              className=\"flex items-center gap-1 text-emerald-600 hover:text-emerald-700 font-medium transition-colors\"\n            >\n              View All\n              <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n              </svg>\n            </Link>\n          </div>\n          <div className=\"bg-white rounded-xl border border-gray-200 overflow-hidden\">\n            <div className=\"bg-gradient-to-r from-emerald-500 to-emerald-600 px-4 sm:px-6 py-4\">\n              <div className=\"grid grid-cols-12 gap-3 sm:gap-4 text-emerald-50 font-semibold text-sm\">\n                <div className=\"col-span-2 sm:col-span-1\">Rank</div>\n                <div className=\"col-span-6 sm:col-span-8\">Creator</div>\n                <div className=\"col-span-4 sm:col-span-3 text-center\">Supports</div>\n              </div>\n            </div>\n            <div className=\"divide-y divide-gray-200\">\n              {[...Array(3)].map((_, i) => (\n                <div key={i} className=\"px-4 sm:px-6 py-4 animate-pulse\">\n                  <div className=\"grid grid-cols-12 gap-3 sm:gap-4 items-center\">\n                    <div className=\"col-span-2 sm:col-span-1\">\n                      <div className=\"w-7 h-7 rounded-full bg-gray-200\" />\n                    </div>\n                    <div className=\"col-span-6 sm:col-span-8 flex items-center gap-2\">\n                      <div className=\"w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-gray-200\" />\n                      <div className=\"flex-1\">\n                        <div className=\"h-4 bg-gray-200 rounded w-24 mb-1\" />\n                        <div className=\"h-3 bg-gray-200 rounded w-16\" />\n                      </div>\n                    </div>\n                    <div className=\"col-span-4 sm:col-span-3 flex justify-center\">\n                      <div className=\"h-5 bg-gray-200 rounded w-12\" />\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </div>\n        </div>\n      </section>\n    );\n  }\n\n  if (!creators || creators.length === 0) {\n    return null;\n  }\n\n  return (\n    <section className=\"py-12 sm:py-16 bg-gray-50\">\n      <div className=\"mx-auto w-full max-w-6xl px-4 sm:px-6\">\n        <div className=\"flex items-center justify-between mb-8\">\n          <h2 className=\"text-2xl sm:text-3xl font-bold text-gray-900\">\n            Top Creators\n          </h2>\n          <Link\n            href=\"/creators\"\n            className=\"flex items-center gap-1 text-emerald-600 hover:text-emerald-700 font-medium transition-colors\"\n          >\n            View All\n            <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n            </svg>\n          </Link>\n        </div>\n\n        <div className=\"bg-white rounded-xl border border-gray-200 overflow-hidden\">\n          <div className=\"bg-gradient-to-r from-emerald-500 to-emerald-600 px-4 sm:px-6 py-4\">\n            <div className=\"grid grid-cols-12 gap-3 sm:gap-4 text-emerald-50 font-semibold text-sm\">\n              <div className=\"col-span-2 sm:col-span-1\">Rank</div>\n              <div className=\"col-span-6 sm:col-span-8\">Creator</div>\n              <div className=\"col-span-4 sm:col-span-3 text-center\">Supports</div>\n            </div>\n          </div>\n\n          <div className=\"divide-y divide-gray-200\">\n            {creators.map((creator, index) => (\n              <Link\n                key={creator.id}\n                href={`/u/${creator.username}`}\n                className=\"block px-4 sm:px-6 py-4 hover:bg-gray-50 transition-colors duration-150\"\n              >\n                <div className=\"grid grid-cols-12 gap-3 sm:gap-4 items-center\">\n                  <div className=\"col-span-2 sm:col-span-1\">\n                    <div className={`flex items-center justify-center w-7 h-7 rounded-full font-bold text-xs ${\n                      index === 0 ? 'bg-yellow-100 text-yellow-700' :\n                      index === 1 ? 'bg-gray-100 text-gray-700' :\n                      'bg-orange-100 text-orange-700'\n                    }`}>\n                      {index + 1}\n                    </div>\n                  </div>\n\n                  <div className=\"col-span-6 sm:col-span-8 flex items-center gap-2 min-w-0\">\n                    <div className=\"w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center flex-shrink-0\">\n                      {creator.profileImage ? (\n                        <img\n                          src={getProfileAvatar(creator.profileImage)}\n                          alt={creator.displayName}\n                          className=\"w-full h-full rounded-full object-cover\"\n                        />\n                      ) : (\n                        <span className=\"text-white text-base font-bold\">\n                          {creator.displayName?.charAt(0)?.toUpperCase() || 'U'}\n                        </span>\n                      )}\n                    </div>\n                    \n                    <div className=\"min-w-0 flex-1\">\n                      <h3 className=\"font-semibold text-gray-900 truncate\">\n                        {creator.displayName}\n                      </h3>\n                      <p className=\"text-sm text-emerald-600 truncate\">\n                        @{creator.username}\n                      </p>\n                    </div>\n                  </div>\n\n                  <div className=\"col-span-4 sm:col-span-3 text-center\">\n                    <div className=\"font-bold text-emerald-600 text-lg\">\n                      {creator.totalSupports || 0}\n                    </div>\n                  </div>\n                </div>\n              </Link>\n            ))}\n          </div>\n        </div>\n      </div>\n    </section>\n  );\n}\n","path":null,"size_bytes":7069,"size_tokens":null},"src/components/FeaturedCampaigns.js":{"content":"\"use client\";\n\nimport { useState, useEffect } from 'react';\nimport Link from 'next/link';\nimport Image from 'next/image';\nimport { getAllCampaigns } from '../lib/firestore';\nimport { getCampaignPreview, getProfileAvatar } from '../utils/imageTransform';\nimport { abbreviateNumber } from '../utils/validation';\n\nexport default function FeaturedCampaigns() {\n  const [campaigns, setCampaigns] = useState([]);\n  const [loading, setLoading] = useState(true);\n\n  useEffect(() => {\n    const loadCampaigns = async () => {\n      try {\n        const result = await getAllCampaigns({\n          sortBy: 'supportersCount',\n          pageSize: 4,\n          page: 1\n        });\n        setCampaigns(result.campaigns);\n      } catch (error) {\n        console.error('Error loading featured campaigns:', error);\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    loadCampaigns();\n  }, []);\n\n  if (loading) {\n    return (\n      <section className=\"py-12 sm:py-16 bg-white\">\n        <div className=\"mx-auto w-full max-w-6xl px-4 sm:px-6\">\n          <div className=\"flex items-center justify-between mb-8\">\n            <h2 className=\"text-2xl sm:text-3xl font-bold text-gray-900\">\n              Top Campaigns\n            </h2>\n            <Link\n              href=\"/campaigns\"\n              className=\"flex items-center gap-1 text-emerald-600 hover:text-emerald-700 font-medium transition-colors\"\n            >\n              View All\n              <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n                <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n              </svg>\n            </Link>\n          </div>\n          <div className=\"flex gap-4 overflow-x-auto lg:overflow-x-visible scrollbar-hide pb-2\">\n            {[...Array(4)].map((_, i) => (\n              <div key={i} className=\"flex-shrink-0 w-48 sm:w-52 lg:flex-1 lg:w-auto\">\n                <div className=\"aspect-square bg-gray-200 rounded-lg animate-pulse\" />\n                <div className=\"mt-3 h-4 bg-gray-200 rounded w-3/4 animate-pulse\" />\n                <div className=\"mt-2 h-3 bg-gray-200 rounded w-1/2 animate-pulse\" />\n              </div>\n            ))}\n          </div>\n        </div>\n      </section>\n    );\n  }\n\n  if (!campaigns || campaigns.length === 0) {\n    return null;\n  }\n\n  return (\n    <section className=\"py-12 sm:py-16 bg-white\">\n      <div className=\"mx-auto w-full max-w-6xl px-4 sm:px-6\">\n        <div className=\"flex items-center justify-between mb-8\">\n          <h2 className=\"text-2xl sm:text-3xl font-bold text-gray-900\">\n            Top Campaigns\n          </h2>\n          <Link\n            href=\"/campaigns\"\n            className=\"flex items-center gap-1 text-emerald-600 hover:text-emerald-700 font-medium transition-colors\"\n          >\n            View All\n            <svg className=\"w-4 h-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n              <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 5l7 7-7 7\" />\n            </svg>\n          </Link>\n        </div>\n\n        <div className=\"flex gap-4 overflow-x-auto lg:overflow-x-visible scrollbar-hide pb-2\">\n          {campaigns.map((campaign) => (\n            <Link\n              key={campaign.id}\n              href={`/campaign/${campaign.slug}`}\n              className=\"flex-shrink-0 w-48 sm:w-52 lg:flex-1 lg:w-auto group\"\n            >\n              <div className=\"bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden\">\n                <div className=\"relative aspect-square bg-gray-100 overflow-hidden\">\n                  {campaign.imageUrl ? (\n                    <Image\n                      src={getCampaignPreview(campaign.imageUrl)}\n                      alt={campaign.title}\n                      fill\n                      className=\"object-cover group-hover:scale-105 transition-transform duration-300\"\n                      sizes=\"(max-width: 640px) 192px, (max-width: 1024px) 208px, 25vw\"\n                      unoptimized\n                    />\n                  ) : (\n                    <div className=\"absolute inset-0 bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center\">\n                      <svg\n                        className=\"h-12 w-12 text-gray-400\"\n                        fill=\"none\"\n                        viewBox=\"0 0 24 24\"\n                        stroke=\"currentColor\"\n                      >\n                        <path\n                          strokeLinecap=\"round\"\n                          strokeLinejoin=\"round\"\n                          strokeWidth={2}\n                          d=\"M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z\"\n                        />\n                      </svg>\n                    </div>\n                  )}\n                  {campaign.type && (\n                    <div className=\"absolute top-2 left-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none\">\n                      <span className=\"inline-block px-2 py-1 text-xs font-semibold bg-white/90 text-gray-800 rounded-md shadow-sm backdrop-blur-sm\">\n                        {campaign.type === 'frame' ? 'Frame' : 'Background'}\n                      </span>\n                    </div>\n                  )}\n                </div>\n\n                <div className=\"p-4\">\n                  <h3 className=\"text-gray-900 font-semibold text-base truncate mb-2\">\n                    {campaign.title}\n                  </h3>\n                  \n                  {(campaign.creator?.username || campaign.creatorUsername) && (\n                    <div className=\"flex items-center gap-2 mb-2\">\n                      <div className=\"w-6 h-6 rounded-full bg-gradient-to-br from-emerald-400 to-emerald-600 flex items-center justify-center flex-shrink-0\">\n                        {(campaign.creator?.profileImage || campaign.creatorAvatar) ? (\n                          <img\n                            src={getProfileAvatar(campaign.creator?.profileImage || campaign.creatorAvatar)}\n                            alt={campaign.creator?.displayName || campaign.creatorName || 'Creator'}\n                            className=\"w-full h-full rounded-full object-cover\"\n                            loading=\"lazy\"\n                          />\n                        ) : (\n                          <span className=\"text-white text-xs font-bold\">\n                            {(campaign.creator?.displayName || campaign.creatorName)?.charAt(0)?.toUpperCase() || 'U'}\n                          </span>\n                        )}\n                      </div>\n                      <span className=\"text-sm text-gray-600 truncate\">\n                        {campaign.creator?.displayName || campaign.creatorName || 'Anonymous'}\n                      </span>\n                    </div>\n                  )}\n                  \n                  <div className=\"flex items-center gap-2 text-gray-600 text-sm\">\n                    <svg\n                      className=\"h-4 w-4 text-emerald-600\"\n                      fill=\"none\"\n                      viewBox=\"0 0 24 24\"\n                      stroke=\"currentColor\"\n                    >\n                      <path\n                        strokeLinecap=\"round\"\n                        strokeLinejoin=\"round\"\n                        strokeWidth={2}\n                        d=\"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z\"\n                      />\n                    </svg>\n                    <span>{abbreviateNumber(campaign.supportersCount || 0)} {campaign.supportersCount === 1 ? 'support' : 'supports'}</span>\n                  </div>\n                </div>\n              </div>\n            </Link>\n          ))}\n        </div>\n      </div>\n    </section>\n  );\n}\n","path":null,"size_bytes":7966,"size_tokens":null},"SETTINGS_HUB_IMPLEMENTATION.md":{"content":"# Settings Hub Implementation Plan\n\n**Created:** December 13, 2025  \n**Status:** Ready for Implementation  \n**Estimated Time:** 1-2 weeks  \n**Priority:** Phase 1\n\n---\n\n## 1. Executive Summary\n\nThis document provides a detailed implementation plan for the Settings Hub feature. The Settings Hub will be a centralized location for users to manage their account security, privacy controls, and preferences - separate from profile editing (`/profile/edit`).\n\n### What This Includes\n- `/settings` - Main hub with sidebar navigation (redirects to `/settings/account`)\n- `/settings/account` - Account & Security management\n- `/settings/privacy` - Privacy & Data controls\n- `/settings/preferences` - User preferences (theme, language, etc.)\n\n### What This Does NOT Include\n- Notification preferences (notifications are mandatory for moderation)\n- Profile editing (stays at `/profile/edit`)\n\n---\n\n## 2. Architecture Overview\n\n### 2.1 Route Structure\n\n```\nsrc/app/(chrome)/settings/\n layout.js           # Settings layout with sidebar (similar to admin layout)\n page.js             # Redirects to /settings/account\n account/\n    page.js         # Account & Security settings\n privacy/\n    page.js         # Privacy & Data settings\n preferences/\n     page.js         # User preferences\n```\n\n### 2.2 Component Structure\n\n```\nsrc/components/settings/\n SettingsSidebar.js  # Sidebar navigation (similar to AdminSidebar)\n SettingsHeader.js   # Header with breadcrumbs\n SettingsCard.js     # Reusable settings section card\n SettingsToggle.js   # Toggle switch component\n SettingsInput.js    # Input field with validation\n SettingsSection.js  # Section wrapper with title/description\n```\n\n### 2.3 API Routes\n\n```\nsrc/app/api/settings/\n account/\n    password/route.js       # Change password\n    email/route.js          # Update email\n    sessions/route.js       # Manage active sessions\n    delete/route.js         # Delete account\n privacy/\n    visibility/route.js     # Profile visibility settings\n    export/route.js         # Export user data (GDPR)\n    indexing/route.js       # Search engine indexing\n preferences/\n     route.js                # Save user preferences\n```\n\n---\n\n## 3. Database Schema Updates\n\n### 3.1 User Document Extensions (Firestore: `users/{userId}`)\n\n```javascript\n{\n  // Existing fields...\n  \n  // NEW: Privacy Settings\n  privacySettings: {\n    profileVisibility: \"public\" | \"private\",  // Default: \"public\"\n    showInCreatorLeaderboard: true,           // Default: true\n    allowSearchEngineIndexing: true,          // Default: true\n    showSupportCount: true,                   // Default: true\n  },\n  \n  // NEW: User Preferences\n  preferences: {\n    theme: \"light\" | \"dark\" | \"system\",       // Default: \"system\"\n    language: \"en\",                           // Default: \"en\"\n    timezone: \"auto\",                         // Default: \"auto\"\n  },\n  \n  // NEW: Security tracking\n  security: {\n    lastPasswordChange: timestamp,\n    twoFactorEnabled: false,                  // Future enhancement\n    activeSessions: [],                       // Future enhancement\n  },\n  \n  // Existing fields remain unchanged\n}\n```\n\n### 3.2 Sessions Collection (Future - for session management)\n\n```javascript\n// Firestore: `users/{userId}/sessions/{sessionId}`\n{\n  deviceInfo: string,       // Browser/device info\n  ipAddress: string,        // Hashed IP\n  location: string,         // Approximate location\n  createdAt: timestamp,\n  lastActiveAt: timestamp,\n  isCurrent: boolean,\n}\n```\n\n---\n\n## 4. Detailed Implementation Plan\n\n### 4.1 Phase 1A: Settings Layout & Navigation (2-3 days)\n\n#### Task 1: Create Settings Layout\n**File:** `src/app/(chrome)/settings/layout.js`\n\n```javascript\n\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { useRouter } from \"next/navigation\";\nimport { useAuth } from \"@/hooks/useAuth\";\nimport { useUserProfile } from \"@/components/UserProfileProvider\";\nimport SettingsSidebar from \"@/components/settings/SettingsSidebar\";\nimport PageLoader from \"@/components/PageLoader\";\n\nexport default function SettingsLayout({ children }) {\n  const router = useRouter();\n  const { user, loading: authLoading } = useAuth();\n  const { userProfile, loading: profileLoading } = useUserProfile();\n  \n  useEffect(() => {\n    if (!authLoading && !user) {\n      router.replace(\"/signin\");\n    }\n  }, [user, authLoading, router]);\n  \n  if (authLoading || profileLoading) {\n    return <PageLoader message=\"Loading settings...\" />;\n  }\n  \n  if (!user) {\n    return <PageLoader message=\"Redirecting to sign in...\" />;\n  }\n  \n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-20\">\n        <div className=\"flex flex-col lg:flex-row gap-8\">\n          <SettingsSidebar user={{ ...user, ...userProfile }} />\n          <main className=\"flex-1 min-w-0\">\n            {children}\n          </main>\n        </div>\n      </div>\n    </div>\n  );\n}\n```\n\n#### Task 2: Create Settings Sidebar\n**File:** `src/components/settings/SettingsSidebar.js`\n\n**Design Pattern:** Follow `AdminSidebar.js` structure but with:\n- Light theme (not dark like admin)\n- Vertical layout for desktop, horizontal tabs for mobile\n- Active state with emerald color\n- Icons from existing SVG patterns\n\n**Navigation Items:**\n```javascript\nconst navItems = [\n  {\n    name: \"Account & Security\",\n    href: \"/settings/account\",\n    icon: LockIcon,\n    description: \"Password, email, sessions\"\n  },\n  {\n    name: \"Privacy & Data\",\n    href: \"/settings/privacy\",\n    icon: ShieldIcon,\n    description: \"Visibility, data export\"\n  },\n  {\n    name: \"Preferences\",\n    href: \"/settings/preferences\",\n    icon: CogIcon,\n    description: \"Theme, language\"\n  },\n];\n```\n\n#### Task 3: Create Settings Page (Redirect)\n**File:** `src/app/(chrome)/settings/page.js`\n\n```javascript\nimport { redirect } from 'next/navigation';\n\nexport default function SettingsPage() {\n  redirect('/settings/account');\n}\n\nexport const metadata = {\n  title: \"Settings - Twibbonize\",\n  description: \"Manage your account settings\",\n};\n```\n\n---\n\n### 4.2 Phase 1B: Account & Security Page (3-4 days)\n\n#### Task 4: Create Account Settings Page\n**File:** `src/app/(chrome)/settings/account/page.js`\n\n**Sections:**\n1. **Email Management**\n   - Display current email (read-only with edit button)\n   - Email change flow with verification\n\n2. **Password Management**\n   - Current password verification\n   - New password with strength indicator\n   - Confirm password\n\n3. **Active Sessions** (Phase 2 - placeholder for now)\n   - List of active sessions with device info\n   - \"Sign out all devices\" button\n\n4. **Account Deletion**\n   - Danger zone section\n   - Confirmation modal with typed confirmation (\"DELETE\")\n   - 30-day grace period before permanent deletion\n\n**UI Pattern:** Follow `/profile/edit/page.js` structure:\n- Yellow header with title\n- White content card with sections\n- Form validation with error messages\n- Success/error toasts\n\n#### Task 5: Create Password Change API\n**File:** `src/app/api/settings/account/password/route.js`\n\n```javascript\nimport { NextResponse } from 'next/server';\nimport { adminAuth } from '@/lib/firebaseAdmin';\nimport { verifyIdToken } from '@/middleware/adminAuth';\n\nexport async function POST(request) {\n  // 1. Verify user is authenticated\n  // 2. Verify current password\n  // 3. Validate new password strength\n  // 4. Update password via Firebase Admin SDK\n  // 5. Invalidate other sessions (optional)\n  // 6. Return success/error\n}\n```\n\n#### Task 6: Create Account Deletion API\n**File:** `src/app/api/settings/account/delete/route.js`\n\n**Deletion Process:**\n1. Verify user identity\n2. Mark account for deletion (30-day grace period)\n3. Send confirmation email\n4. Schedule cleanup cron job\n\n---\n\n### 4.3 Phase 1C: Privacy & Data Page (2-3 days)\n\n#### Task 7: Create Privacy Settings Page\n**File:** `src/app/(chrome)/settings/privacy/page.js`\n\n**Sections:**\n1. **Profile Visibility**\n   - Toggle: Public / Private profile\n   - Toggle: Show in creator leaderboard\n   - Toggle: Show support count\n\n2. **Search Engine Indexing**\n   - Toggle: Allow search engines to index profile\n\n3. **Data Export (GDPR)**\n   - Button: \"Request Data Export\"\n   - Generates JSON/ZIP with all user data\n   - Includes: profile, campaigns, notifications\n\n4. **Connected Apps** (Future)\n   - Placeholder for OAuth connections\n\n#### Task 8: Create Privacy APIs\n**File:** `src/app/api/settings/privacy/visibility/route.js`\n\n```javascript\nexport async function PATCH(request) {\n  // 1. Verify authentication\n  // 2. Validate settings\n  // 3. Update user document\n  // 4. Return updated settings\n}\n```\n\n**File:** `src/app/api/settings/privacy/export/route.js`\n\n```javascript\nexport async function POST(request) {\n  // 1. Verify authentication\n  // 2. Gather all user data (profile, campaigns, notifications)\n  // 3. Generate JSON export\n  // 4. Return download link or initiate download\n}\n```\n\n---\n\n### 4.4 Phase 1D: Preferences Page (1-2 days)\n\n#### Task 9: Create Preferences Page\n**File:** `src/app/(chrome)/settings/preferences/page.js`\n\n**Sections:**\n1. **Appearance**\n   - Theme selector: Light / Dark / System\n\n2. **Language** (Placeholder for i18n)\n   - Dropdown: English (more languages future)\n\n3. **Time Zone**\n   - Auto-detect or manual selection\n\n**Note:** Theme implementation requires:\n- CSS variables in `globals.css`\n- Theme context provider\n- localStorage persistence\n\n#### Task 10: Create Preferences API\n**File:** `src/app/api/settings/preferences/route.js`\n\n```javascript\nexport async function PATCH(request) {\n  // 1. Verify authentication\n  // 2. Validate preferences\n  // 3. Update user document\n  // 4. Return updated preferences\n}\n```\n\n---\n\n## 5. Reusable Components\n\n### 5.1 SettingsCard Component\n**File:** `src/components/settings/SettingsCard.js`\n\n```javascript\nexport default function SettingsCard({ title, description, children, danger = false }) {\n  return (\n    <div className={`bg-white rounded-xl border ${danger ? 'border-red-200' : 'border-gray-200'} shadow-sm overflow-hidden`}>\n      <div className={`px-6 py-4 border-b ${danger ? 'bg-red-50 border-red-200' : 'bg-gray-50 border-gray-200'}`}>\n        <h3 className={`text-lg font-semibold ${danger ? 'text-red-700' : 'text-gray-900'}`}>{title}</h3>\n        {description && <p className=\"text-sm text-gray-500 mt-1\">{description}</p>}\n      </div>\n      <div className=\"px-6 py-4\">\n        {children}\n      </div>\n    </div>\n  );\n}\n```\n\n### 5.2 SettingsToggle Component\n**File:** `src/components/settings/SettingsToggle.js`\n\n```javascript\nexport default function SettingsToggle({ label, description, checked, onChange, disabled = false }) {\n  return (\n    <div className=\"flex items-center justify-between py-4 border-b border-gray-100 last:border-0\">\n      <div className=\"flex-1 pr-4\">\n        <p className=\"text-sm font-medium text-gray-900\">{label}</p>\n        {description && <p className=\"text-sm text-gray-500 mt-1\">{description}</p>}\n      </div>\n      <button\n        type=\"button\"\n        role=\"switch\"\n        aria-checked={checked}\n        onClick={() => !disabled && onChange(!checked)}\n        disabled={disabled}\n        className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${\n          checked ? 'bg-emerald-600' : 'bg-gray-200'\n        } ${disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}\n      >\n        <span className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${\n          checked ? 'translate-x-6' : 'translate-x-1'\n        }`} />\n      </button>\n    </div>\n  );\n}\n```\n\n---\n\n## 6. Security Considerations\n\n### 6.1 Authentication Requirements\n- All settings pages require authentication\n- Password changes require current password verification\n- Account deletion requires typed confirmation + password\n- Email changes require re-authentication\n\n### 6.2 Rate Limiting\n- Password change: 3 attempts per hour\n- Email change: 1 per 24 hours\n- Data export: 1 per 24 hours\n- Account deletion: 1 pending request at a time\n\n### 6.3 Audit Logging\nLog all sensitive actions to `users/{userId}/activityLog`:\n- Password changes\n- Email changes\n- Privacy setting changes\n- Data exports\n- Account deletion requests\n\n---\n\n## 7. UI/UX Consistency\n\n### 7.1 Follow Existing Patterns\n- **Header Style:** Yellow background with emerald text (like `/profile/edit`)\n- **Card Style:** White with gray border, rounded-xl\n- **Button Style:** Use `btn-base` + variant classes from `BUTTON_STYLE_GUIDE.md`\n- **Form Validation:** Red border + error message below field\n- **Loading States:** Emerald spinner with message\n- **Success Feedback:** Green toast notification\n- **Danger Zone:** Red border, red header background\n\n### 7.2 Responsive Design\n- **Desktop:** Sidebar on left, content on right\n- **Tablet:** Sidebar collapses to icons\n- **Mobile:** Horizontal tabs at top, content below\n\n### 7.3 Accessibility\n- All toggles have proper `role=\"switch\"` and `aria-checked`\n- Form fields have associated labels\n- Keyboard navigation support\n- Focus indicators on all interactive elements\n\n---\n\n## 8. Implementation Order\n\n### Week 1: Foundation\n1.  Create settings layout structure\n2.  Create SettingsSidebar component\n3.  Create reusable components (Card, Toggle, Input)\n4.  Create Account page skeleton\n5.  Implement password change functionality\n\n### Week 2: Core Features\n6.  Implement email change functionality\n7.  Create Privacy settings page\n8.  Implement visibility toggles\n9.  Implement data export\n10.  Create Preferences page\n11.  Add account deletion (with confirmation)\n\n### Future Enhancements (Post-Launch)\n- Two-factor authentication (2FA)\n- Session management (view/revoke sessions)\n- Theme implementation (dark mode)\n- Multi-language support (i18n)\n- Connected apps/OAuth management\n\n---\n\n## 9. Testing Checklist\n\n### Functional Tests\n- [ ] Settings layout loads correctly\n- [ ] Sidebar navigation works on all screen sizes\n- [ ] Password change with correct current password\n- [ ] Password change rejected with wrong current password\n- [ ] Email change triggers verification\n- [ ] Privacy toggles save correctly\n- [ ] Data export generates valid JSON\n- [ ] Account deletion shows proper confirmation\n- [ ] Preferences persist after page reload\n\n### Security Tests\n- [ ] Unauthenticated users redirected to signin\n- [ ] Rate limiting works on sensitive endpoints\n- [ ] Password validation enforces minimum requirements\n- [ ] Activity logging captures all actions\n\n### UI/UX Tests\n- [ ] Mobile responsive layout\n- [ ] Loading states display correctly\n- [ ] Error messages are clear and helpful\n- [ ] Success feedback shows after actions\n- [ ] Keyboard navigation works\n\n---\n\n## 10. Files to Create/Modify\n\n### New Files\n```\nsrc/app/(chrome)/settings/\n layout.js\n page.js\n account/page.js\n privacy/page.js\n preferences/page.js\n\nsrc/components/settings/\n SettingsSidebar.js\n SettingsCard.js\n SettingsToggle.js\n SettingsSection.js\n\nsrc/app/api/settings/\n account/\n    password/route.js\n    email/route.js\n    delete/route.js\n privacy/\n    visibility/route.js\n    export/route.js\n preferences/route.js\n```\n\n### Modified Files\n```\nsrc/lib/firestore.js         # Add settings update functions\nsrc/components/Header.js      # Add Settings link to user menu\nTASKS.md                      # Update Phase 1 status\nreplit.md                     # Update with settings architecture\nCODEBASE_STRUCTURE.md         # Add settings files documentation\n```\n\n---\n\n## 11. Dependencies\n\n### No New Packages Required\nAll functionality can be built with existing dependencies:\n- Firebase Admin SDK (password management)\n- Next.js API routes (backend)\n- Tailwind CSS (styling)\n- Existing component patterns\n\n---\n\n## 12. Success Criteria\n\nPhase 1 is complete when:\n1. Users can access `/settings` and see the settings hub\n2. Users can change their password\n3. Users can control profile visibility\n4. Users can export their data\n5. Users can access preferences (theme placeholder)\n6. Account deletion flow works with proper confirmation\n7. All pages are responsive and accessible\n8. Documentation is updated\n\n---\n\n**End of Implementation Plan**\n","path":null,"size_bytes":16581,"size_tokens":null}},"version":2}